var CIFTools,$NGL_shaderTextHash={};$NGL_shaderTextHash["SphereImpostor.frag"]=["#define STANDARD","#define IMPOSTOR","","uniform vec3 diffuse;","uniform vec3 emissive;","uniform float roughness;","uniform float metalness;","uniform float opacity;","uniform float nearClip;","uniform mat4 projectionMatrix;","uniform float ortho;","","varying float vRadius;","varying float vRadiusSq;","varying vec3 vPoint;","varying vec3 vPointViewPosition;","","#ifdef PICKING","    uniform float objectId;","    varying vec3 vPickingColor;","#else","    #include common","    #include color_pars_fragment","    #include fog_pars_fragment","    #include bsdfs","    #include lights_pars_begin","    #include lights_physical_pars_fragment","#endif","","bool flag2 = false;","bool interior = false;","vec3 cameraPos;","vec3 cameraNormal;","","// Calculate depth based on the given camera position.","float calcDepth( in vec3 cameraPos ){","    vec2 clipZW = cameraPos.z * projectionMatrix[2].zw + projectionMatrix[3].zw;","    return 0.5 + 0.5 * clipZW.x / clipZW.y;","}","","float calcClip( vec3 cameraPos ){","    return dot( vec4( cameraPos, 1.0 ), vec4( 0.0, 0.0, 1.0, nearClip - 0.5 ) );","}","","bool Impostor( out vec3 cameraPos, out vec3 cameraNormal ){","","    vec3 cameraSpherePos = -vPointViewPosition;","    cameraSpherePos.z += vRadius;","","    vec3 rayOrigin = mix( vec3( 0.0, 0.0, 0.0 ), vPoint, ortho );","    vec3 rayDirection = mix( normalize( vPoint ), vec3( 0.0, 0.0, 1.0 ), ortho );","    vec3 cameraSphereDir = mix( cameraSpherePos, rayOrigin - cameraSpherePos, ortho );","","    float B = dot( rayDirection, cameraSphereDir );","    float det = B * B + vRadiusSq - dot( cameraSphereDir, cameraSphereDir );","","    if( det < 0.0 ){","        discard;","        return false;","    }","        float sqrtDet = sqrt( det );","        float posT = mix( B + sqrtDet, B + sqrtDet, ortho );","        float negT = mix( B - sqrtDet, sqrtDet - B, ortho );","","        cameraPos = rayDirection * negT + rayOrigin;","","        #ifdef NEAR_CLIP","if( calcDepth( cameraPos ) <= 0.0 ){","    cameraPos = rayDirection * posT + rayOrigin;","    interior = true;","    return false;","}else if( calcClip( cameraPos ) > 0.0 ){","    cameraPos = rayDirection * posT + rayOrigin;","    interior = true;","    flag2 = true;","    return false;","}else{","    cameraNormal = normalize( cameraPos - cameraSpherePos );","}","        #else","if( calcDepth( cameraPos ) <= 0.0 ){","    cameraPos = rayDirection * posT + rayOrigin;","    interior = true;","    return false;","}else{","    cameraNormal = normalize( cameraPos - cameraSpherePos );","}","        #endif","","        cameraNormal = normalize( cameraPos - cameraSpherePos );","        cameraNormal *= float(!interior) * 2.0 - 1.0;","         return !interior;","","}","","void main(void){","","    bool flag = Impostor( cameraPos, cameraNormal );","","    #ifdef NEAR_CLIP","        if( calcClip( cameraPos ) > 0.0 )","            discard;","    #endif","","    // FIXME not compatible with custom clipping plane","    //Set the depth based on the new cameraPos.","    gl_FragDepthEXT = calcDepth( cameraPos );","    if( !flag ){","","        // clamp to near clipping plane and add a tiny value to","        // make spheres with a greater radius occlude smaller ones","        #ifdef NEAR_CLIP","if( flag2 ){","    gl_FragDepthEXT = max( 0.0, calcDepth( vec3( - ( nearClip - 0.5 ) ) ) + ( 0.0000001 / vRadius ) );","}else if( gl_FragDepthEXT >= 0.0 ){","    gl_FragDepthEXT = 0.0 + ( 0.0000001 / vRadius );","}","        #else","if( gl_FragDepthEXT >= 0.0 ){","    gl_FragDepthEXT = 0.0 + ( 0.0000001 / vRadius );","}","        #endif","","    }","","    // bugfix (mac only?)","    if (gl_FragDepthEXT < 0.0)","        discard;","    if (gl_FragDepthEXT > 1.0)","        discard;","","    #ifdef PICKING","","        gl_FragColor = vec4( vPickingColor, objectId );","","    #else","","        vec3 vNormal = cameraNormal;","        vec3 vViewPosition = -cameraPos;","","        vec4 diffuseColor = vec4( diffuse, opacity );","        ReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );","        vec3 totalEmissiveLight = emissive;","","        #include color_fragment","        #include roughnessmap_fragment","        #include metalnessmap_fragment","","        // don't use include normal_fragment","        vec3 normal = normalize( vNormal );","","        #include lights_physical_fragment","        //include lights_template","        #include lights_fragment_begin","        #include lights_fragment_end","","        vec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + reflectedLight.directSpecular + reflectedLight.indirectSpecular + totalEmissiveLight;","","        gl_FragColor = vec4( outgoingLight, diffuseColor.a );","        //gl_FragColor = vec4( reflectedLight.directSpecular, diffuseColor.a );","","        #include premultiplied_alpha_fragment","        #include tonemapping_fragment","        #include encodings_fragment","        //include fog_fragment","        #ifdef USE_FOG","            #ifdef USE_LOGDEPTHBUF_EXT","                float depth = gl_FragDepthEXT / gl_FragCoord.w;","            #else","                float depth = gl_FragCoord.z / gl_FragCoord.w;","            #endif","            #ifdef FOG_EXP2","                float fogFactor = whiteCompliment( exp2( - fogDensity * fogDensity * depth * depth * LOG2 ) );","            #else","                float fogFactor = smoothstep( fogNear, fogFar, depth );","            #endif","            gl_FragColor.rgb = mix( gl_FragColor.rgb, fogColor, fogFactor );","        #endif","","    #endif","","}"].join("\n"),$NGL_shaderTextHash["SphereImpostor.vert"]=["uniform mat4 projectionMatrixInverse;","uniform float nearClip;","","varying float vRadius;","varying float vRadiusSq;","varying vec3 vPoint;","varying vec3 vPointViewPosition;","varying float fogDepth;","varying float fogNear;","varying float fogFar;","","attribute vec2 mapping;","//attribute vec3 position;","attribute float radius;","","#ifdef PICKING","    #include unpack_clr","    attribute float primitiveId;","    varying vec3 vPickingColor;","#else","    #include color_pars_vertex","#endif","","//include matrix_scale","float matrixScale( in mat4 m ){","    vec4 r = m[ 0 ];","    return sqrt( r[ 0 ] * r[ 0 ] + r[ 1 ] * r[ 1 ] + r[ 2 ] * r[ 2 ] );","}","","const mat4 D = mat4(","    1.0, 0.0, 0.0, 0.0,","    0.0, 1.0, 0.0, 0.0,","    0.0, 0.0, 1.0, 0.0,","    0.0, 0.0, 0.0, -1.0",");","","mat4 transposeTmp( in mat4 inMatrix ) {","    vec4 i0 = inMatrix[0];","    vec4 i1 = inMatrix[1];","    vec4 i2 = inMatrix[2];","    vec4 i3 = inMatrix[3];","","    mat4 outMatrix = mat4(","        vec4(i0.x, i1.x, i2.x, i3.x),","        vec4(i0.y, i1.y, i2.y, i3.y),","        vec4(i0.z, i1.z, i2.z, i3.z),","        vec4(i0.w, i1.w, i2.w, i3.w)","    );","    return outMatrix;","}","","//------------------------------------------------------------------------------","// Compute point size and center using the technique described in:","// 'GPU-Based Ray-Casting of Quadratic Surfaces'","// by Christian Sigg, Tim Weyrich, Mario Botsch, Markus Gross.","//","// Code based on","/*=========================================================================",""," Program:   Visualization Toolkit"," Module:    Quadrics_fs.glsl and Quadrics_vs.glsl",""," Copyright (c) Ken Martin, Will Schroeder, Bill Lorensen"," All rights reserved."," See Copyright.txt or http://www.kitware.com/Copyright.htm for details.",""," This software is distributed WITHOUT ANY WARRANTY; without even"," the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR"," PURPOSE.  See the above copyright notice for more information.",""," =========================================================================*/","","// .NAME Quadrics_fs.glsl and Quadrics_vs.glsl","// .SECTION Thanks","// <verbatim>","//","//  This file is part of the PointSprites plugin developed and contributed by","//","//  Copyright (c) CSCS - Swiss National Supercomputing Centre","//                EDF - Electricite de France","//","//  John Biddiscombe, Ugo Varetto (CSCS)","//  Stephane Ploix (EDF)","//","// </verbatim>","//","// Contributions by Alexander Rose","// - ported to WebGL","// - adapted to work with quads","void ComputePointSizeAndPositionInClipCoordSphere(){","","    vec2 xbc;","    vec2 ybc;","","    mat4 T = mat4(","        radius, 0.0, 0.0, 0.0,","        0.0, radius, 0.0, 0.0,","        0.0, 0.0, radius, 0.0,","        position.x, position.y, position.z, 1.0","    );","","    mat4 R = transposeTmp( projectionMatrix * modelViewMatrix * T );","    float A = dot( R[ 3 ], D * R[ 3 ] );","    float B = -2.0 * dot( R[ 0 ], D * R[ 3 ] );","    float C = dot( R[ 0 ], D * R[ 0 ] );","    xbc[ 0 ] = ( -B - sqrt( B * B - 4.0 * A * C ) ) / ( 2.0 * A );","    xbc[ 1 ] = ( -B + sqrt( B * B - 4.0 * A * C ) ) / ( 2.0 * A );","    float sx = abs( xbc[ 0 ] - xbc[ 1 ] ) * 0.5;","","    A = dot( R[ 3 ], D * R[ 3 ] );","    B = -2.0 * dot( R[ 1 ], D * R[ 3 ] );","    C = dot( R[ 1 ], D * R[ 1 ] );","    ybc[ 0 ] = ( -B - sqrt( B * B - 4.0 * A * C ) ) / ( 2.0 * A );","    ybc[ 1 ] = ( -B + sqrt( B * B - 4.0 * A * C ) ) / ( 2.0 * A );","    float sy = abs( ybc[ 0 ] - ybc[ 1 ]  ) * 0.5;","","    gl_Position.xy = vec2( 0.5 * ( xbc.x + xbc.y ), 0.5 * ( ybc.x + ybc.y ) );","    gl_Position.xy -= mapping * vec2( sx, sy );","    gl_Position.xy *= gl_Position.w;","","}","","void main(void){","","    #ifdef PICKING","        vPickingColor = unpackColor( primitiveId );","    #else","        #include color_vertex","    #endif","","    vRadius = radius * matrixScale( modelViewMatrix );","","    vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );","    // avoid clipping, added again in fragment shader","    mvPosition.z -= vRadius;","","    gl_Position = projectionMatrix * vec4( mvPosition.xyz, 1.0 );","    ComputePointSizeAndPositionInClipCoordSphere();","","","    vRadiusSq = vRadius * vRadius;","    vec4 vPoint4 = projectionMatrixInverse * gl_Position;","    vPoint = vPoint4.xyz / vPoint4.w;","    vPointViewPosition = -mvPosition.xyz / mvPosition.w;","","}"].join("\n"),$NGL_shaderTextHash["CylinderImpostor.frag"]=["#define STANDARD","#define IMPOSTOR","","// Open-Source PyMOL is Copyright (C) Schrodinger, LLC.","//","//  All Rights Reserved","//","//  Permission to use, copy, modify, distribute, and distribute modified","//  versions of this software and its built-in documentation for any","//  purpose and without fee is hereby granted, provided that the above","//  copyright notice appears in all copies and that both the copyright","//  notice and this permission notice appear in supporting documentation,","//  and that the name of Schrodinger, LLC not be used in advertising or","//  publicity pertaining to distribution of the software without specific,","//  written prior permission.","//","//  SCHRODINGER, LLC DISCLAIMS ALL WARRANTIES WITH REGARD TO THIS SOFTWARE,","//  INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS. IN","//  NO EVENT SHALL SCHRODINGER, LLC BE LIABLE FOR ANY SPECIAL, INDIRECT OR","//  CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS","//  OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE","//  OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE","//  USE OR PERFORMANCE OF THIS SOFTWARE.","","// Contributions by Alexander Rose","// - ported to WebGL","// - dual color","// - pk color","// - custom clipping","// - three.js lighting","","uniform vec3 diffuse;","uniform vec3 emissive;","uniform float roughness;","uniform float metalness;","uniform float opacity;","uniform float nearClip;","uniform mat4 projectionMatrix;","uniform float ortho;","","varying vec3 axis;","varying vec4 base_radius;","varying vec4 end_b;","varying vec3 U;","varying vec3 V;","varying vec4 w;","","#ifdef PICKING","    uniform float objectId;","    varying vec3 vPickingColor;","#else","    varying vec3 vColor1;","    varying vec3 vColor2;","    #include common","    #include fog_pars_fragment","    #include bsdfs","    #include lights_pars_begin","    #include lights_physical_pars_fragment","#endif","","bool interior = false;","","float distSq3( vec3 v3a, vec3 v3b ){","    return (","        ( v3a.x - v3b.x ) * ( v3a.x - v3b.x ) +","        ( v3a.y - v3b.y ) * ( v3a.y - v3b.y ) +","        ( v3a.z - v3b.z ) * ( v3a.z - v3b.z )","    );","}","","// Calculate depth based on the given camera position.","float calcDepth( in vec3 cameraPos ){","    vec2 clipZW = cameraPos.z * projectionMatrix[2].zw + projectionMatrix[3].zw;","    return 0.5 + 0.5 * clipZW.x / clipZW.y;","}","","float calcClip( vec3 cameraPos ){","    return dot( vec4( cameraPos, 1.0 ), vec4( 0.0, 0.0, 1.0, nearClip - 0.5 ) );","}","","void main(){","","    vec3 point = w.xyz / w.w;","","    // unpacking","    vec3 base = base_radius.xyz;","    float vRadius = base_radius.w;","    vec3 end = end_b.xyz;","    float b = end_b.w;","","    vec3 end_cyl = end;","    vec3 surface_point = point;","","    vec3 ray_target = surface_point;","    vec3 ray_origin = vec3(0.0);","    vec3 ray_direction = mix(normalize(ray_origin - ray_target), vec3(0.0, 0.0, 1.0), ortho);","    mat3 basis = mat3( U, V, axis );","","    vec3 diff = ray_target - 0.5 * (base + end_cyl);","    vec3 P = diff * basis;","","    // angle (cos) between cylinder cylinder_axis and ray direction","    float dz = dot( axis, ray_direction );","","    float radius2 = vRadius*vRadius;","","    // calculate distance to the cylinder from ray origin","    vec3 D = vec3(dot(U, ray_direction),","                dot(V, ray_direction),","                dz);","    float a0 = P.x*P.x + P.y*P.y - radius2;","    float a1 = P.x*D.x + P.y*D.y;","    float a2 = D.x*D.x + D.y*D.y;","","    // calculate a dicriminant of the above quadratic equation","    float d = a1*a1 - a0*a2;","    if (d < 0.0)","        // outside of the cylinder","        discard;","","    float dist = (-a1 + sqrt(d)) / a2;","","    // point of intersection on cylinder surface","    vec3 new_point = ray_target + dist * ray_direction;","","    vec3 tmp_point = new_point - base;","    vec3 _normal = normalize( tmp_point - axis * dot(tmp_point, axis) );","","    ray_origin = mix( ray_origin, surface_point, ortho );","","    // test caps","    float front_cap_test = dot( tmp_point, axis );","    float end_cap_test = dot((new_point - end_cyl), axis);","","    // to calculate caps, simply check the angle between","    // the point of intersection - cylinder end vector","    // and a cap plane normal (which is the cylinder cylinder_axis)","    // if the angle < 0, the point is outside of cylinder","    // test front cap","","    #ifndef CAP","        vec3 new_point2 = ray_target + ( (-a1 - sqrt(d)) / a2 ) * ray_direction;","        vec3 tmp_point2 = new_point2 - base;","    #endif","","    // flat","    if (front_cap_test < 0.0)","    {","        // ray-plane intersection","        float dNV = dot(-axis, ray_direction);","        if (dNV < 0.0)","            discard;","        float near = dot(-axis, (base)) / dNV;","        vec3 front_point = ray_direction * near + ray_origin;","        // within the cap radius?","        if (dot(front_point - base, front_point-base) > radius2)","            discard;","","        #ifdef CAP","            new_point = front_point;","            _normal = axis;","        #else","            new_point = ray_target + ( (-a1 - sqrt(d)) / a2 ) * ray_direction;","            dNV = dot(-axis, ray_direction);","            near = dot(axis, end_cyl) / dNV;","            new_point2 = ray_direction * near + ray_origin;","            if (dot(new_point2 - end_cyl, new_point2-base) < radius2)","                discard;","            interior = true;","        #endif","    }","","    // test end cap","","","    // flat","    if( end_cap_test > 0.0 )","    {","        // ray-plane intersection","        float dNV = dot(axis, ray_direction);","        if (dNV < 0.0)","            discard;","        float near = dot(axis, end_cyl) / dNV;","        vec3 end_point = ray_direction * near + ray_origin;","        // within the cap radius?","        if( dot(end_point - end_cyl, end_point-base) > radius2 )","            discard;","","        #ifdef CAP","            new_point = end_point;","            _normal = axis;","        #else","            new_point = ray_target + ( (-a1 - sqrt(d)) / a2 ) * ray_direction;","            dNV = dot(-axis, ray_direction);","            near = dot(-axis, (base)) / dNV;","            new_point2 = ray_direction * near + ray_origin;","            if (dot(new_point2 - base, new_point2-base) < radius2)","                discard;","            interior = true;","        #endif","    }","","    gl_FragDepthEXT = calcDepth( new_point );","","    #ifdef NEAR_CLIP","        if( calcClip( new_point ) > 0.0 ){","            dist = (-a1 - sqrt(d)) / a2;","            new_point = ray_target + dist * ray_direction;","            if( calcClip( new_point ) > 0.0 )","                discard;","            interior = true;","            gl_FragDepthEXT = calcDepth( new_point );","            if( gl_FragDepthEXT >= 0.0 ){","                gl_FragDepthEXT = max( 0.0, calcDepth( vec3( - ( nearClip - 0.5 ) ) ) + ( 0.0000001 / vRadius ) );","            }","        }else if( gl_FragDepthEXT <= 0.0 ){","            dist = (-a1 - sqrt(d)) / a2;","            new_point = ray_target + dist * ray_direction;","            interior = true;","            gl_FragDepthEXT = calcDepth( new_point );","            if( gl_FragDepthEXT >= 0.0 ){","                gl_FragDepthEXT = 0.0 + ( 0.0000001 / vRadius );","            }","        }","    #else","        if( gl_FragDepthEXT <= 0.0 ){","            dist = (-a1 - sqrt(d)) / a2;","            new_point = ray_target + dist * ray_direction;","            interior = true;","            gl_FragDepthEXT = calcDepth( new_point );","            if( gl_FragDepthEXT >= 0.0 ){","                gl_FragDepthEXT = 0.0 + ( 0.0000001 / vRadius );","            }","        }","    #endif","","    // this is a workaround necessary for Mac","    // otherwise the modified fragment won't clip properly","    if (gl_FragDepthEXT < 0.0)","        discard;","    if (gl_FragDepthEXT > 1.0)","        discard;","","    #ifdef PICKING","","        gl_FragColor = vec4( vPickingColor, objectId );","","    #else","","        vec3 vViewPosition = -new_point;","        vec3 vNormal = _normal;","        vec3 vColor;","","        if( distSq3( new_point, end_cyl ) < distSq3( new_point, base ) ){","            if( b < 0.0 ){","                vColor = vColor1;","            }else{","                vColor = vColor2;","            }","        }else{","            if( b > 0.0 ){","                vColor = vColor1;","            }else{","                vColor = vColor2;","            }","        }","","        vec4 diffuseColor = vec4( diffuse, opacity );","        ReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );","        vec3 totalEmissiveLight = emissive;","","        #include color_fragment","     //ifdef USE_COLOR","     //diffuseColor.r *= vColor[0];","     //diffuseColor.g *= vColor[1];","     //diffuseColor.b *= vColor[2];","     //endif","        #include roughnessmap_fragment","        #include metalnessmap_fragment","","        // don't use include normal_fragment","        vec3 normal = normalize( vNormal );","","        #include lights_physical_fragment","        //include lights_template","        #include lights_fragment_begin","        #include lights_fragment_end","","        vec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + reflectedLight.directSpecular + reflectedLight.indirectSpecular + totalEmissiveLight;","","        gl_FragColor = vec4( outgoingLight, diffuseColor.a );","        //gl_FragColor = vec4( reflectedLight.directSpecular, diffuseColor.a );","","        #include premultiplied_alpha_fragment","        #include tonemapping_fragment","        #include encodings_fragment","        //include fog_fragment","        #ifdef USE_FOG","            #ifdef USE_LOGDEPTHBUF_EXT","                float depth = gl_FragDepthEXT / gl_FragCoord.w;","            #else","                float depth = gl_FragCoord.z / gl_FragCoord.w;","            #endif","            #ifdef FOG_EXP2","                float fogFactor = whiteCompliment( exp2( - fogDensity * fogDensity * depth * depth * LOG2 ) );","            #else","                float fogFactor = smoothstep( fogNear, fogFar, depth );","            #endif","            gl_FragColor.rgb = mix( gl_FragColor.rgb, fogColor, fogFactor );","        #endif","","    #endif","","}"].join("\n"),$NGL_shaderTextHash["CylinderImpostor.vert"]=["// Open-Source PyMOL is Copyright (C) Schrodinger, LLC.","//","//  All Rights Reserved","//","//  Permission to use, copy, modify, distribute, and distribute modified","//  versions of this software and its built-in documentation for any","//  purpose and without fee is hereby granted, provided that the above","//  copyright notice appears in all copies and that both the copyright","//  notice and this permission notice appear in supporting documentation,","//  and that the name of Schrodinger, LLC not be used in advertising or","//  publicity pertaining to distribution of the software without specific,","//  written prior permission.","//","//  SCHRODINGER, LLC DISCLAIMS ALL WARRANTIES WITH REGARD TO THIS SOFTWARE,","//  INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS. IN","//  NO EVENT SHALL SCHRODINGER, LLC BE LIABLE FOR ANY SPECIAL, INDIRECT OR","//  CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS","//  OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE","//  OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE","//  USE OR PERFORMANCE OF THIS SOFTWARE.","","// Contributions by Alexander Rose","// - ported to WebGL","// - dual color","// - pk color","// - shift","","attribute vec3 mapping;","attribute vec3 position1;","attribute vec3 position2;","attribute float radius;","","varying vec3 axis;","varying vec4 base_radius;","varying vec4 end_b;","varying vec3 U;","varying vec3 V;","varying vec4 w;","varying float fogDepth;","varying float fogNear;","varying float fogFar;","","#ifdef PICKING","    #include unpack_clr","    attribute float primitiveId;","    varying vec3 vPickingColor;","#else","    //attribute vec3 color;","    attribute vec3 color2;","    varying vec3 vColor1;","    varying vec3 vColor2;","#endif","","uniform mat4 modelViewMatrixInverse;","uniform float ortho;","","//include matrix_scale","float matrixScale( in mat4 m ){","    vec4 r = m[ 0 ];","    return sqrt( r[ 0 ] * r[ 0 ] + r[ 1 ] * r[ 1 ] + r[ 2 ] * r[ 2 ] );","}","","void main(){","","    #ifdef PICKING","        vPickingColor = unpackColor( primitiveId );","    #else","        vColor1 = color;","        vColor2 = color2;","    #endif","","    // vRadius = radius;","    base_radius.w = radius * matrixScale( modelViewMatrix );","","    //vec3 center = position;","    vec3 center = ( position2 + position1 ) / 2.0;","    vec3 dir = normalize( position2 - position1 );","    float ext = length( position2 - position1 ) / 2.0;","","    // using cameraPosition fails on some machines, not sure why","    // vec3 cam_dir = normalize( cameraPosition - mix( center, vec3( 0.0 ), ortho ) );","    vec3 cam_dir;","    if( ortho == 0.0 ){","        cam_dir = ( modelViewMatrixInverse * vec4( 0, 0, 0, 1 ) ).xyz - center;","    }else{","        cam_dir = ( modelViewMatrixInverse * vec4( 0, 0, 1, 0 ) ).xyz;","    }","    cam_dir = normalize( cam_dir );","","    vec3 ldir;","","    float b = dot( cam_dir, dir );","    end_b.w = b;","    // direction vector looks away, so flip","    if( b < 0.0 )","        ldir = -ext * dir;","    // direction vector already looks in my direction","    else","        ldir = ext * dir;","","    vec3 left = normalize( cross( cam_dir, ldir ) );","    left = radius * left;","    vec3 up = radius * normalize( cross( left, ldir ) );","","    // transform to modelview coordinates","    axis = normalize( normalMatrix * ldir );","    U = normalize( normalMatrix * up );","    V = normalize( normalMatrix * left );","","    vec4 base4 = modelViewMatrix * vec4( center - ldir, 1.0 );","    base_radius.xyz = base4.xyz / base4.w;","","    vec4 top_position = modelViewMatrix * vec4( center + ldir, 1.0 );","    vec4 end4 = top_position;","    end_b.xyz = end4.xyz / end4.w;","","    w = modelViewMatrix * vec4(","        center + mapping.x*ldir + mapping.y*left + mapping.z*up, 1.0","    );","","    gl_Position = projectionMatrix * w;","","    // avoid clipping (1.0 seems to induce flickering with some drivers)","    gl_Position.z = 0.99;","","}"].join("\n"),$NGL_shaderTextHash["SphereInstancing.frag"]=$NGL_shaderTextHash["SphereImpostor.frag"],$NGL_shaderTextHash["SphereInstancing.vert"]=["uniform mat4 projectionMatrixInverse;","uniform float nearClip;","","varying float vRadius;","varying float vRadiusSq;","varying vec3 vPoint;","varying vec3 vPointViewPosition;","varying float fogDepth;","varying float fogNear;","varying float fogFar;","","attribute vec2 mapping;","//attribute vec3 position;","attribute float radius;","attribute vec4 matrix1;","attribute vec4 matrix2;","attribute vec4 matrix3;","attribute vec4 matrix4;","","#ifdef PICKING","    #include unpack_clr","    attribute float primitiveId;","    varying vec3 vPickingColor;","#else","    #include color_pars_vertex","#endif","","//include matrix_scale","float matrixScale( in mat4 m ){","    vec4 r = m[ 0 ];","    return sqrt( r[ 0 ] * r[ 0 ] + r[ 1 ] * r[ 1 ] + r[ 2 ] * r[ 2 ] );","}","","const mat4 D = mat4(","    1.0, 0.0, 0.0, 0.0,","    0.0, 1.0, 0.0, 0.0,","    0.0, 0.0, 1.0, 0.0,","    0.0, 0.0, 0.0, -1.0",");","","mat4 transposeTmp( in mat4 inMatrix ) {","    vec4 i0 = inMatrix[0];","    vec4 i1 = inMatrix[1];","    vec4 i2 = inMatrix[2];","    vec4 i3 = inMatrix[3];","","    mat4 outMatrix = mat4(","        vec4(i0.x, i1.x, i2.x, i3.x),","        vec4(i0.y, i1.y, i2.y, i3.y),","        vec4(i0.z, i1.z, i2.z, i3.z),","        vec4(i0.w, i1.w, i2.w, i3.w)","    );","    return outMatrix;","}","","//------------------------------------------------------------------------------","// Compute point size and center using the technique described in:","// 'GPU-Based Ray-Casting of Quadratic Surfaces'","// by Christian Sigg, Tim Weyrich, Mario Botsch, Markus Gross.","//","// Code based on","/*=========================================================================",""," Program:   Visualization Toolkit"," Module:    Quadrics_fs.glsl and Quadrics_vs.glsl",""," Copyright (c) Ken Martin, Will Schroeder, Bill Lorensen"," All rights reserved."," See Copyright.txt or http://www.kitware.com/Copyright.htm for details.",""," This software is distributed WITHOUT ANY WARRANTY; without even"," the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR"," PURPOSE.  See the above copyright notice for more information.",""," =========================================================================*/","","// .NAME Quadrics_fs.glsl and Quadrics_vs.glsl","// .SECTION Thanks","// <verbatim>","//","//  This file is part of the PointSprites plugin developed and contributed by","//","//  Copyright (c) CSCS - Swiss National Supercomputing Centre","//                EDF - Electricite de France","//","//  John Biddiscombe, Ugo Varetto (CSCS)","//  Stephane Ploix (EDF)","//","// </verbatim>","//","// Contributions by Alexander Rose","// - ported to WebGL","// - adapted to work with quads","void ComputePointSizeAndPositionInClipCoordSphere(vec4 updatePosition){","","    vec2 xbc;","    vec2 ybc;","","    mat4 T = mat4(","        radius, 0.0, 0.0, 0.0,","        0.0, radius, 0.0, 0.0,","        0.0, 0.0, radius, 0.0,","        updatePosition.x, updatePosition.y, updatePosition.z, 1.0","    );","","    mat4 R = transposeTmp( projectionMatrix * modelViewMatrix * T );","    float A = dot( R[ 3 ], D * R[ 3 ] );","    float B = -2.0 * dot( R[ 0 ], D * R[ 3 ] );","    float C = dot( R[ 0 ], D * R[ 0 ] );","    xbc[ 0 ] = ( -B - sqrt( B * B - 4.0 * A * C ) ) / ( 2.0 * A );","    xbc[ 1 ] = ( -B + sqrt( B * B - 4.0 * A * C ) ) / ( 2.0 * A );","    float sx = abs( xbc[ 0 ] - xbc[ 1 ] ) * 0.5;","","    A = dot( R[ 3 ], D * R[ 3 ] );","    B = -2.0 * dot( R[ 1 ], D * R[ 3 ] );","    C = dot( R[ 1 ], D * R[ 1 ] );","    ybc[ 0 ] = ( -B - sqrt( B * B - 4.0 * A * C ) ) / ( 2.0 * A );","    ybc[ 1 ] = ( -B + sqrt( B * B - 4.0 * A * C ) ) / ( 2.0 * A );","    float sy = abs( ybc[ 0 ] - ybc[ 1 ]  ) * 0.5;","","    gl_Position.xy = vec2( 0.5 * ( xbc.x + xbc.y ), 0.5 * ( ybc.x + ybc.y ) );","    gl_Position.xy -= mapping * vec2( sx, sy );","    gl_Position.xy *= gl_Position.w;","","}","","  mat4 computeMat(vec4 v1, vec4 v2, vec4 v3, vec4 v4) {","    return mat4(","      v1.x, v1.y, v1.z, v1.w,","      v2.x, v2.y, v2.z, v2.w,","      v3.x, v3.y, v3.z, v3.w,","      v4.x, v4.y, v4.z, v4.w","    );","  }","","void main(void){","","    #ifdef PICKING","        vPickingColor = unpackColor( primitiveId );","    #else","        #include color_vertex","    #endif","","    vRadius = radius * matrixScale( modelViewMatrix );","","    mat4 matrix = computeMat(matrix1, matrix2, matrix3, matrix4);","    vec4 updatePosition = matrix * vec4(position, 1.0);","","//    vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );","    vec4 mvPosition = modelViewMatrix * vec4( updatePosition.xyz, 1.0 );","    // avoid clipping, added again in fragment shader","    mvPosition.z -= vRadius;","","//    gl_Position = projectionMatrix * vec4( mvPosition.xyz, 1.0 );","    gl_Position = projectionMatrix * vec4( mvPosition.xyz, 1.0 );","    ComputePointSizeAndPositionInClipCoordSphere(updatePosition);","","","    vRadiusSq = vRadius * vRadius;","    vec4 vPoint4 = projectionMatrixInverse * gl_Position;","    vPoint = vPoint4.xyz / vPoint4.w;","    vPointViewPosition = -mvPosition.xyz / mvPosition.w;","","}"].join("\n"),$NGL_shaderTextHash["CylinderInstancing.frag"]=$NGL_shaderTextHash["CylinderImpostor.frag"],$NGL_shaderTextHash["CylinderInstancing.vert"]=["// Open-Source PyMOL is Copyright (C) Schrodinger, LLC.","//","//  All Rights Reserved","//","//  Permission to use, copy, modify, distribute, and distribute modified","//  versions of this software and its built-in documentation for any","//  purpose and without fee is hereby granted, provided that the above","//  copyright notice appears in all copies and that both the copyright","//  notice and this permission notice appear in supporting documentation,","//  and that the name of Schrodinger, LLC not be used in advertising or","//  publicity pertaining to distribution of the software without specific,","//  written prior permission.","//","//  SCHRODINGER, LLC DISCLAIMS ALL WARRANTIES WITH REGARD TO THIS SOFTWARE,","//  INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS. IN","//  NO EVENT SHALL SCHRODINGER, LLC BE LIABLE FOR ANY SPECIAL, INDIRECT OR","//  CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS","//  OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE","//  OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE","//  USE OR PERFORMANCE OF THIS SOFTWARE.","","// Contributions by Alexander Rose","// - ported to WebGL","// - dual color","// - pk color","// - shift","","attribute vec3 mapping;","attribute vec3 position1;","attribute vec3 position2;","attribute float radius;","attribute vec4 matrix1;","attribute vec4 matrix2;","attribute vec4 matrix3;","attribute vec4 matrix4;","","varying vec3 axis;","varying vec4 base_radius;","varying vec4 end_b;","varying vec3 U;","varying vec3 V;","varying vec4 w;","varying float fogDepth;","varying float fogNear;","varying float fogFar;","","#ifdef PICKING","    #include unpack_clr","    attribute float primitiveId;","    varying vec3 vPickingColor;","#else","    //attribute vec3 color;","    attribute vec3 color2;","    varying vec3 vColor1;","    varying vec3 vColor2;","#endif","","uniform mat4 modelViewMatrixInverse;","uniform float ortho;","","//include matrix_scale","float matrixScale( in mat4 m ){","    vec4 r = m[ 0 ];","    return sqrt( r[ 0 ] * r[ 0 ] + r[ 1 ] * r[ 1 ] + r[ 2 ] * r[ 2 ] );","}","","  mat4 computeMat(vec4 v1, vec4 v2, vec4 v3, vec4 v4) {","    return mat4(","      v1.x, v1.y, v1.z, v1.w,","      v2.x, v2.y, v2.z, v2.w,","      v3.x, v3.y, v3.z, v3.w,","      v4.x, v4.y, v4.z, v4.w","    );","  }","","void main(){","","    #ifdef PICKING","        vPickingColor = unpackColor( primitiveId );","    #else","        vColor1 = color;","        vColor2 = color2;","    #endif","","    // vRadius = radius;","    base_radius.w = radius * matrixScale( modelViewMatrix );","","    //vec3 center = ( position2 + position1 ) / 2.0;","","    mat4 matrix = computeMat(matrix1, matrix2, matrix3, matrix4);","    vec4 updatePosition1 = matrix * vec4(position1, 1.0);","    vec4 updatePosition2 = matrix * vec4(position2, 1.0);","    vec3 center = ( updatePosition2.xyz + updatePosition1.xyz ) / 2.0;","","    //vec3 dir = normalize( position2 - position1 );","    vec3 dir = normalize( updatePosition2.xyz - updatePosition1.xyz );","    float ext = length( position2 - position1 ) / 2.0;","","    // using cameraPosition fails on some machines, not sure why","    // vec3 cam_dir = normalize( cameraPosition - mix( center, vec3( 0.0 ), ortho ) );","    vec3 cam_dir;","    if( ortho == 0.0 ){","        cam_dir = ( modelViewMatrixInverse * vec4( 0, 0, 0, 1 ) ).xyz - center;","    }else{","        cam_dir = ( modelViewMatrixInverse * vec4( 0, 0, 1, 0 ) ).xyz;","    }","    cam_dir = normalize( cam_dir );","","    vec3 ldir;","","    float b = dot( cam_dir, dir );","    end_b.w = b;","    // direction vector looks away, so flip","    if( b < 0.0 )","        ldir = -ext * dir;","    // direction vector already looks in my direction","    else","        ldir = ext * dir;","","    vec3 left = normalize( cross( cam_dir, ldir ) );","    left = radius * left;","    vec3 up = radius * normalize( cross( left, ldir ) );","","    // transform to modelview coordinates","    axis = normalize( normalMatrix * ldir );","    U = normalize( normalMatrix * up );","    V = normalize( normalMatrix * left );","","    vec4 base4 = modelViewMatrix * vec4( center - ldir, 1.0 );","    base_radius.xyz = base4.xyz / base4.w;","","    vec4 top_position = modelViewMatrix * vec4( center + ldir, 1.0 );","    vec4 end4 = top_position;","    end_b.xyz = end4.xyz / end4.w;","","    w = modelViewMatrix * vec4(","        center + mapping.x*ldir + mapping.y*left + mapping.z*up, 1.0","    );","","    gl_Position = projectionMatrix * w;","","    // avoid clipping (1.0 seems to induce flickering with some drivers)","    gl_Position.z = 0.99;","","}"].join("\n"),$NGL_shaderTextHash["Instancing.frag"]=["#define STANDARD","uniform vec3 diffuse;","uniform vec3 emissive;","uniform float roughness;","uniform float metalness;","uniform float opacity;","uniform float nearClip;","uniform float clipRadius;","uniform mat4 projectionMatrix;","uniform float ortho;","varying float bCylinder;","","#if defined( NEAR_CLIP ) || defined( RADIUS_CLIP ) || ( !defined( PICKING ) && !defined( NOLIGHT ) )","    varying vec3 vViewPosition;","#endif","","#if defined( RADIUS_CLIP )","    varying vec3 vClipCenter;","#endif","","#if defined( PICKING )","    uniform float objectId;","    varying vec3 vPickingColor;","#elif defined( NOLIGHT )","    varying vec3 vColor;","#else","    #ifndef FLAT_SHADED","        varying vec3 vNormal;","    #endif","    #include common","    #include color_pars_fragment","    #include fog_pars_fragment","    #include bsdfs","    #include lights_pars_begin","    #include lights_physical_pars_fragment","#endif","","void main(){","    #include nearclip_fragment","    #include radiusclip_fragment","","    #if defined( PICKING )","","        gl_FragColor = vec4( vPickingColor, objectId );","","    #elif defined( NOLIGHT )","","        gl_FragColor = vec4( vColor, opacity );","","    #else","","        vec4 diffuseColor = vec4( diffuse, opacity );","        ReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );","        vec3 totalEmissiveLight = emissive;","","        #include color_fragment","        #include roughnessmap_fragment","        #include metalnessmap_fragment","        #include normal_flip","        #include normal_fragment_begin","","        //include dull_interior_fragment","","        #include lights_physical_fragment","        //include lights_template","        #include lights_fragment_begin","        #include lights_fragment_end","","        vec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + reflectedLight.directSpecular + reflectedLight.indirectSpecular + totalEmissiveLight;","","        #include interior_fragment","","        gl_FragColor = vec4( outgoingLight, diffuseColor.a );","","        #include premultiplied_alpha_fragment","        #include tonemapping_fragment","        #include encodings_fragment","        #include fog_fragment","","        #include opaque_back_fragment","","    #endif","","}"].join("\n"),$NGL_shaderTextHash["Instancing.vert"]=["#define STANDARD","","uniform mat4 projectionMatrixInverse;","uniform float nearClip;","uniform vec3 clipCenter;","attribute vec4 matrix1;","attribute vec4 matrix2;","attribute vec4 matrix3;","attribute vec4 matrix4;","attribute float cylinder;","varying float bCylinder;","","#if defined( NEAR_CLIP ) || defined( RADIUS_CLIP ) || ( !defined( PICKING ) && !defined( NOLIGHT ) )","    varying vec3 vViewPosition;","#endif","","#if defined( RADIUS_CLIP )","    varying vec3 vClipCenter;","#endif","","#if defined( PICKING )","    #include unpack_color","    attribute float primitiveId;","    varying vec3 vPickingColor;","#elif defined( NOLIGHT )","    varying vec3 vColor;","#else","    #include color_pars_vertex","    #ifndef FLAT_SHADED","        varying vec3 vNormal;","    #endif","#endif","","#include common","","  mat4 computeMat(vec4 v1, vec4 v2, vec4 v3, vec4 v4) {","    return mat4(","      v1.x, v1.y, v1.z, v1.w,","      v2.x, v2.y, v2.z, v2.w,","      v3.x, v3.y, v3.z, v3.w,","      v4.x, v4.y, v4.z, v4.w","    );","  }","","void main(){","    bCylinder = cylinder;","","    mat4 matrix = computeMat(matrix1, matrix2, matrix3, matrix4);","    vec4 updatePosition = matrix * vec4(position, 1.0);","","    #if defined( PICKING )","        vPickingColor = unpackColor( primitiveId );","    #elif defined( NOLIGHT )","        vColor = color;","    #else","        #include color_vertex","        //include beginnormal_vertex","        //vec3 objectNormal = vec3( normal );","        vec3 objectNormal = vec3(matrix * vec4(normal,0.0));","        #include defaultnormal_vertex","        // Normal computed with derivatives when FLAT_SHADED","        #ifndef FLAT_SHADED","            vNormal = normalize( transformedNormal );","        #endif","    #endif","","    //include begin_vertex","    vec3 transformed = updatePosition.xyz;","    //include project_vertex","    vec4 mvPosition = modelViewMatrix * vec4( transformed, 1.0 );","    gl_Position = projectionMatrix * mvPosition;","","    #if defined( NEAR_CLIP ) || defined( RADIUS_CLIP ) || ( !defined( PICKING ) && !defined( NOLIGHT ) )","        vViewPosition = -mvPosition.xyz;","    #endif","","    #if defined( RADIUS_CLIP )","        vClipCenter = -( modelViewMatrix * vec4( clipCenter, 1.0 ) ).xyz;","    #endif","","    #include nearclip_vertex","","}"].join("\n"),function(e){var t,r,n,i;e.VERSION={number:"1.1.7",date:"Oct 30 2018"},function(e){function t(e,t,r){(t|=0)<=0&&(t=1);var n=t*r,i=e(n);return{elementSize:r,chunkSize:n,creator:e,current:i,parts:[i],currentIndex:0,elementCount:0}}e.is=function(e){return e.creator&&e.chunkSize},e.add4=function(e,t,r,n,i){return e.currentIndex>=e.chunkSize&&(e.currentIndex=0,e.current=e.creator(e.chunkSize),e.parts[e.parts.length]=e.current),e.current[e.currentIndex++]=t,e.current[e.currentIndex++]=r,e.current[e.currentIndex++]=n,e.current[e.currentIndex++]=i,e.elementCount++},e.add3=function(e,t,r,n){return e.currentIndex>=e.chunkSize&&(e.currentIndex=0,e.current=e.creator(e.chunkSize),e.parts[e.parts.length]=e.current),e.current[e.currentIndex++]=t,e.current[e.currentIndex++]=r,e.current[e.currentIndex++]=n,e.elementCount++},e.add2=function(e,t,r){return e.currentIndex>=e.chunkSize&&(e.currentIndex=0,e.current=e.creator(e.chunkSize),e.parts[e.parts.length]=e.current),e.current[e.currentIndex++]=t,e.current[e.currentIndex++]=r,e.elementCount++},e.add=function(e,t){return e.currentIndex>=e.chunkSize&&(e.currentIndex=0,e.current=e.creator(e.chunkSize),e.parts[e.parts.length]=e.current),e.current[e.currentIndex++]=t,e.elementCount++},e.compact=function(e){var t,r=e.creator(e.elementSize*e.elementCount),n=(e.parts.length-1)*e.chunkSize,i=0;if(e.parts.length>1)if(e.parts[0].buffer)for(var o=0;o<e.parts.length-1;o++)r.set(e.parts[o],e.chunkSize*o);else for(o=0;o<e.parts.length-1;o++){i=e.chunkSize*o,t=e.parts[o];for(var a=0;a<e.chunkSize;a++)r[i+a]=t[a]}if(e.current.buffer&&e.currentIndex>=e.chunkSize)r.set(e.current,e.chunkSize*(e.parts.length-1));else for(o=0;o<e.currentIndex;o++)r[n+o]=e.current[o];return r},e.forVertex3D=function(e){return void 0===e&&(e=262144),t(function(e){return new Float32Array(e)},e,3)},e.forIndexBuffer=function(e){return void 0===e&&(e=262144),t(function(e){return new Uint32Array(e)},e,3)},e.forTokenIndices=function(e){return void 0===e&&(e=131072),t(function(e){return new Int32Array(e)},e,2)},e.forIndices=function(e){return void 0===e&&(e=131072),t(function(e){return new Int32Array(e)},e,1)},e.forInt32=function(e){return void 0===e&&(e=131072),t(function(e){return new Int32Array(e)},e,1)},e.forFloat32=function(e){return void 0===e&&(e=131072),t(function(e){return new Float32Array(e)},e,1)},e.forArray=function(e){return void 0===e&&(e=131072),t(function(e){return[]},e,1)},e.create=t}((t=e.Utils||(e.Utils={})).ChunkedArray||(t.ChunkedArray={})),function(e){"use strict";function t(e,t,r){var n=0,i=1;for(45===e.charCodeAt(t)&&(i=-1,t++);t<r;t++){var o=e.charCodeAt(t)-48;if(o>9||o<0)return i*n|0;n=10*n+o|0}return i*n}function r(e,r,n,i){return 43===r.charCodeAt(n)&&n++,e*Math.pow(10,t(r,n,i))}function n(e,t,n){var i=1,o=0,a=0,c=1;for(45===e.charCodeAt(t)&&(i=-1,++t);t<n;){var s=e.charCodeAt(t)-48;if(!(s>=0&&s<10)){if(-2===s){for(++t;t<n;){if(!((s=e.charCodeAt(t)-48)>=0&&s<10))return 53===s||21===s?r(i*(o+a/c),e,t+1,n):i*(o+a/c);a=10*a+s,c*=10,++t}return i*(o+a/c)}if(53===s||21===s)return r(i*o,e,t+1,n);break}o=10*o+s,++t}return i*o}e.parseIntSkipTrailingWhitespace=function(e,r,n){for(;r<n&&32===e.charCodeAt(r);)r++;return t(e,r,n)},e.parseInt=t,e.parseFloatSkipTrailingWhitespace=function(e,t,r){for(;t<r&&32===e.charCodeAt(t);)t++;return n(e,t,r)},e.parseFloat=n}((r=e.Utils||(e.Utils={})).FastNumberParsers||(r.FastNumberParsers={})),n=e.Utils||(e.Utils={}),i=[],function(){for(var e="",t=0;t<512;t++)i[t]=e,e+=" "}(),function(e){function t(e,t){void 0!==t&&null!==t&&(e.chunkOffset===e.chunkCapacity&&(e.data[e.data.length]=e.chunkData.join(""),e.chunkOffset=0),e.chunkData[e.chunkOffset++]=t)}e.create=function(e){return void 0===e&&(e=512),{chunkData:[],chunkOffset:0,chunkCapacity:e,data:[]}},e.asString=function(e){return e.data.length?(e.chunkOffset>0&&(e.data[e.data.length]=e.chunkData.splice(0,e.chunkOffset).join("")),e.data.join("")):e.chunkData.length===e.chunkOffset?e.chunkData.join(""):e.chunkData.splice(0,e.chunkOffset).join("")},e.writeTo=function(e,t){var r;(r=e).chunkOffset>0&&(r.chunkData.length===r.chunkOffset?r.data[r.data.length]=r.chunkData.join(""):r.data[r.data.length]=r.chunkData.splice(0,r.chunkOffset).join(""),r.chunkOffset=0);for(var n=0,i=e.data;n<i.length;n++){var o=i[n];t.writeString(o)}},e.newline=function(e){t(e,"\n")},e.whitespace=function(e,r){t(e,i[r])},e.write=t,e.writeSafe=function(e,t){e.chunkOffset===e.chunkCapacity&&(e.data[e.data.length]=e.chunkData.join(""),e.chunkOffset=0),e.chunkData[e.chunkOffset++]=t},e.writePadLeft=function(e,r,n){void 0!==r&&null!==r||t(e,i[n]);var o=n-r.length;o>0&&t(e,i[o]),t(e,r)},e.writePadRight=function(e,r,n){void 0!==r&&null!==r||t(e,i[n]);var o=n-r.length;t(e,r),o>0&&t(e,i[o])},e.writeInteger=function(e,r){t(e,""+r)},e.writeIntegerPadLeft=function(e,r,n){var o=""+r,a=n-o.length;a>0&&t(e,i[a]),t(e,o)},e.writeIntegerPadRight=function(e,r,n){var o=""+r,a=n-o.length;t(e,o),a>0&&t(e,i[a])},e.writeFloat=function(e,r,n){t(e,""+Math.round(n*r)/n)},e.writeFloatPadLeft=function(e,r,n,o){var a=""+Math.round(n*r)/n,c=o-a.length;c>0&&t(e,i[c]),t(e,a)},e.writeFloatPadRight=function(e,r,n,o){var a=""+Math.round(n*r)/n,c=o-a.length;t(e,a),c>0&&t(e,i[c])}}(n.StringWriter||(n.StringWriter={}));var o=function(){function e(){this.isDefined=!1}return e.prototype.getString=function(e){return null},e.prototype.getInteger=function(e){return 0},e.prototype.getFloat=function(e){return 0},e.prototype.getValuePresence=function(e){return 1},e.prototype.areValuesEqual=function(e,t){return!0},e.prototype.stringEquals=function(e,t){return null===t},e}();e.UndefinedColumn=new o,function(e){e.getMatrix=function(e,t,r,n,i){for(var o=[],a=1;a<=r;a++){for(var c=[],s=1;s<=n;s++)c[s-1]=e.getColumn(t+"["+a+"]["+s+"]").getFloat(i);o[a-1]=c}return o},e.getVector=function(e,t,r,n,i){for(var o=[],a=1;a<=r;a++)o[a-1]=e.getColumn(t+"["+a+"]").getFloat(i);return o}}(e.Category||(e.Category={})),function(e){e.error=function(e,t){return void 0===t&&(t=-1),new a(e,t)},e.success=function(e,t){return void 0===t&&(t=[]),new f(e,t)}}(e.ParserResult||(e.ParserResult={}));var a=function(){function e(e,t){this.message=e,this.line=t,this.isError=!0}return e.prototype.toString=function(){return this.line>=0?"[Line "+this.line+"] "+this.message:this.message},e}();e.ParserError=a;var c,s,u,d,f=function(){return function(e,t){this.result=e,this.warnings=t,this.isError=!1}}();e.ParserSuccess=f,function(t){"use strict";var r;!function(e){e.create=function(){return Object.create(null)},e.get=function(e,t){if(t.length>6)return t;var r=e[t];return void 0!==r?r:(e[t]=t,t)}}(r||(r={}));var n=function(){function e(e){this.dataBlocks=[],this.data=e}return e.prototype.toJSON=function(){return this.dataBlocks.map(function(e){return e.toJSON()})},e}();t.File=n;var i=function(){function e(e,t){this.header=t,this.data=e,this.categoryList=[],this.additionalData={},this.categoryMap=new Map}return Object.defineProperty(e.prototype,"categories",{get:function(){return this.categoryList},enumerable:!0,configurable:!0}),e.prototype.getCategory=function(e){return this.categoryMap.get(e)},e.prototype.addCategory=function(e){this.categoryList[this.categoryList.length]=e,this.categoryMap.set(e.name,e)},e.prototype.toJSON=function(){return{id:this.header,categories:this.categoryList.map(function(e){return e.toJSON()}),additionalData:this.additionalData}},e}();t.DataBlock=i;var o=function(){function t(e,t,r,n,i,o,a){this.name=t,this.tokens=o,this.data=e,this.startIndex=r,this.endIndex=n,this.columnCount=i.length,this.rowCount=a/i.length|0,this.columnIndices=new Map,this.columnNameList=[];for(var c=0;c<i.length;c++){var s=i[c].substr(t.length+1);this.columnIndices.set(s,c),this.columnNameList.push(s)}}return Object.defineProperty(t.prototype,"columnNames",{get:function(){return this.columnNameList},enumerable:!0,configurable:!0}),t.prototype.getColumn=function(t){var r=this.columnIndices.get(t);return void 0!==r?new s(this,this.data,t,r):e.UndefinedColumn},t.prototype.toJSON=function(){for(var e=[],t=this.data,n=this.tokens,i=this.columnNameList,o=r.create(),a=0;a<this.rowCount;a++){for(var c={},s=0;s<this.columnCount;s++){var u=2*(a*this.columnCount+s);c[i[s]]=r.get(o,t.substring(n[u],n[u+1]))}e[a]=c}return{name:this.name,columns:i,rows:e}},t}();t.Category=o;var a=e.Utils.FastNumberParsers.parseInt,c=e.Utils.FastNumberParsers.parseFloat,s=function(){function e(e,t,n,i){this.data=t,this.name=n,this.index=i,this.stringPool=r.create(),this.isDefined=!0,this.tokens=e.tokens,this.columnCount=e.columnCount}return e.prototype.getString=function(e){var t=2*(e*this.columnCount+this.index),n=r.get(this.stringPool,this.data.substring(this.tokens[t],this.tokens[t+1]));return"."===n||"?"===n?null:n},e.prototype.getInteger=function(e){var t=2*(e*this.columnCount+this.index);return a(this.data,this.tokens[t],this.tokens[t+1])},e.prototype.getFloat=function(e){var t=2*(e*this.columnCount+this.index);return c(this.data,this.tokens[t],this.tokens[t+1])},e.prototype.stringEquals=function(e,t){var r=2*(e*this.columnCount+this.index),n=this.tokens[r],i=t.length;if(i!==this.tokens[r+1]-n)return!1;for(var o=0;o<i;o++)if(this.data.charCodeAt(o+n)!==t.charCodeAt(o))return!1;return!0},e.prototype.areValuesEqual=function(e,t){var r=2*(e*this.columnCount+this.index),n=2*(t*this.columnCount+this.index),i=this.tokens[r],o=this.tokens[n],a=this.tokens[r+1]-i;if(a!==this.tokens[n+1]-o)return!1;for(var c=0;c<a;c++)if(this.data.charCodeAt(c+i)!==this.data.charCodeAt(c+o))return!1;return!0},e.prototype.getValuePresence=function(e){var t=e*this.columnCount+this.index,r=this.tokens[2*t];if(this.tokens[2*t+1]-r!=1)return 0;var n=this.data.charCodeAt(r);return 46===n?1:63===n?2:0},e}();t.Column=s}(e.Text||(e.Text={})),function(t){"use strict";var r;function n(e){for(;e.position<e.length;)switch(e.data.charCodeAt(e.position)){case 9:case 10:case 13:case 32:return void(e.currentTokenEnd=e.position);default:++e.position}e.currentTokenEnd=e.position}function i(e,t,r){var n,i=r-t,o=e.currentTokenStart-t,a=e.currentTokenEnd-e.currentTokenStart;if(a<i)return!1;for(n=t;n<r;++n)if(e.data.charCodeAt(n)!==e.data.charCodeAt(n+o))return!1;return i===a||46===e.data.charCodeAt(n+o)}function o(e){var t;for(t=e.currentTokenStart;t<e.currentTokenEnd;++t)if(46===e.data.charCodeAt(t))return t;return t}function a(e,t){return e.data.substring(e.currentTokenStart,t)}function c(e){return e.data.substring(e.currentTokenStart,e.currentTokenEnd)}function s(e){var t=function(e){for(var t=10;e.position<e.length;){var r=e.data.charCodeAt(e.position);switch(r){case 9:case 32:t=r,++e.position;break;case 10:13!==t&&++e.currentLineNumber,t=r,++e.position;break;case 13:t=r,++e.position,++e.currentLineNumber;break;default:return t}}return t}(e);if(e.position>=e.length)e.currentTokenType=6;else{e.currentTokenStart=e.position,e.currentTokenEnd=e.position,e.isEscaped=!1;var r,i,o,a,c=e.data.charCodeAt(e.position);switch(c){case 35:!function(e){for(;e.position<e.length;){var t=e.data.charCodeAt(e.position);if(10===t||13===t)return;++e.position}}(e),e.currentTokenType=5;break;case 34:case 39:!function(e,t){var r,n;for(++e.position;e.position<e.length;)if((n=e.data.charCodeAt(e.position))===t)switch(r=e.data.charCodeAt(e.position+1)){case 9:case 10:case 13:case 32:return e.currentTokenStart++,e.currentTokenEnd=e.position,e.isEscaped=!0,void++e.position;default:if(void 0===r)return e.currentTokenStart++,e.currentTokenEnd=e.position,e.isEscaped=!0,void++e.position;++e.position}else{if(10===n||13===n)return void(e.currentTokenEnd=e.position);++e.position}e.currentTokenEnd=e.position}(e,c),e.currentTokenType=3;break;case 59:10===t||13===t?function(e){for(var t,r=59,n=e.position+1;n<e.length;){if(59===(t=e.data.charCodeAt(n))&&(10===r||13===r)){for(e.position=n+1,e.currentTokenStart++,n--,t=e.data.charCodeAt(n);10===t||13===t;)n--,t=e.data.charCodeAt(n);return e.currentTokenEnd=n+1,void(e.isEscaped=!0)}13===t?e.currentLineNumber++:10===t&&13!==r&&e.currentLineNumber++,r=t,++n}e.position=n}(e):n(e),e.currentTokenType=3;break;default:n(e),e.isEscaped?e.currentTokenType=3:95===e.data.charCodeAt(e.currentTokenStart)?e.currentTokenType=4:e.currentTokenEnd-e.currentTokenStart>=5&&95===e.data.charCodeAt(e.currentTokenStart+4)?68!==(a=(o=e).data.charCodeAt(o.currentTokenStart))&&100!==a||65!==(a=o.data.charCodeAt(o.currentTokenStart+1))&&97!==a||84!==(a=o.data.charCodeAt(o.currentTokenStart+2))&&116!==a||65!==(a=o.data.charCodeAt(o.currentTokenStart+3))&&97!==a?83!==(i=(r=e).data.charCodeAt(r.currentTokenStart))&&115!==i||65!==(i=r.data.charCodeAt(r.currentTokenStart+1))&&97!==i||86!==(i=r.data.charCodeAt(r.currentTokenStart+2))&&118!==i||69!==(i=r.data.charCodeAt(r.currentTokenStart+3))&&101!==i?!function(e){if(e.currentTokenEnd-e.currentTokenStart!=5)return!1;var t=e.data.charCodeAt(e.currentTokenStart);return!(76!==t&&108!==t||79!==(t=e.data.charCodeAt(e.currentTokenStart+1))&&111!==t||79!==(t=e.data.charCodeAt(e.currentTokenStart+2))&&111!==t||80!==(t=e.data.charCodeAt(e.currentTokenStart+3))&&112!==t)}(e)?e.currentTokenType=3:e.currentTokenType=2:e.currentTokenType=1:e.currentTokenType=0:e.currentTokenType=3}}}function u(e){for(s(e);5===e.currentTokenType;)s(e)}function d(e,n){for(var s,d=e.currentTokenStart,f=o(e),l=a(e,f),v=[],g=r.create(512),p=0,h=!0;h;){if(4!==e.currentTokenType||!i(e,d,f)){h=!1;break}if(s=c(e),u(e),3!==e.currentTokenType)return{hasError:!0,errorLine:e.currentLineNumber,errorMessage:"Expected value."};v[v.length]=s,r.addToken(g,e.currentTokenStart,e.currentTokenEnd),p++,u(e)}return n.addCategory(new t.Category(n.data,l,d,e.currentTokenStart,v,g.tokens,p)),{hasError:!1,errorLine:0,errorMessage:""}}function f(e,n){var i=e.currentTokenStart,s=e.currentLineNumber;u(e);for(var d=a(e,o(e)),f=[],l=r.create("_atom_site"===d?n.data.length/1.85|0:1024),v=0;4===e.currentTokenType;)f[f.length]=c(e),u(e);for(;3===e.currentTokenType;)r.addToken(l,e.currentTokenStart,e.currentTokenEnd),v++,u(e);return v%f.length!=0?{hasError:!0,errorLine:e.currentLineNumber,errorMessage:"The number of values for loop starting at line "+s+" is not a multiple of the number of columns."}:(n.addCategory(new t.Category(n.data,d,i,e.currentTokenStart,f,l.tokens,v)),{hasError:!1,errorLine:0,errorMessage:""})}function l(t,r){return e.ParserResult.error(r,t)}function v(r){var n,i,o,a,c,s={data:a=r,length:a.length,position:0,currentTokenStart:0,currentTokenEnd:0,currentTokenType:6,currentLineNumber:1,isEscaped:!1},v=new t.File(r),g=new t.DataBlock(r,"default"),p=new t.DataBlock(r,"empty"),h=!1;for(u(s);6!==s.currentTokenType;){var m=s.currentTokenType;if(0===m){if(h)return l(s.currentLineNumber,"Unexpected data block inside a save frame.");g.categories.length>0&&v.dataBlocks.push(g),g=new t.DataBlock(r,r.substring(s.currentTokenStart+5,s.currentTokenEnd)),u(s)}else if(1===m){if(0===(i=r.substring(s.currentTokenStart+5,s.currentTokenEnd)).length)p.categories.length>0&&((o=g.additionalData.saveFrames)||(o=[],g.additionalData.saveFrames=o),o[o.length]=p),h=!1;else{if(h)return l(s.currentLineNumber,"Save frames cannot be nested.");h=!0,p=new t.DataBlock(r,i)}u(s)}else if(2===m){if((n=f(s,h?p:g)).hasError)return l(n.errorLine,n.errorMessage)}else{if(4!==m)return l(s.currentLineNumber,"Unexpected token. Expected data_, loop_, or data name.");if((n=d(s,h?p:g)).hasError)return l(n.errorLine,n.errorMessage)}}return h?l(s.currentLineNumber,"Unfinished save frame (`"+p.header+"`)."):(g.categories.length>0&&v.dataBlocks.push(g),c=v,e.ParserResult.success(c))}!function(e){e.addToken=function(e,t,r){var n,i;e.count>=e.tokensLenMinus2&&(n=e,(i=new Int32Array(1.61*n.tokens.length|0)).set(n.tokens),n.tokens=i,n.tokensLenMinus2=i.length-2|0),e.tokens[e.count++]=t,e.tokens[e.count++]=r},e.create=function(e){return{tokensLenMinus2:e-2|0,count:0,tokens:new Int32Array(e)}}}(r||(r={})),t.parse=function(e){return v(e)}}(e.Text||(e.Text={})),function(t){"use strict";var r=e.Utils.StringWriter,n=function(){function e(){this.writer=r.create(),this.encoded=!1,this.dataBlockCreated=!1}return e.prototype.startDataBlock=function(e){this.dataBlockCreated=!0,r.write(this.writer,"data_"+(e||"").replace(/[ \n\t]/g,"").toUpperCase()+"\n#\n")},e.prototype.writeCategory=function(e,t){if(this.encoded)throw new Error("The writer contents have already been encoded, no more writing.");if(!this.dataBlockCreated)throw new Error("No data block created.");var n=(t&&t.length?t.map(function(t){return e(t)}):[e(void 0)]).filter(function(e){return e&&e.count>0});if(n.length){var d=n.reduce(function(e,t){return e+(void 0===t.count?1:t.count)},0);d&&(1===d?function(e,t){for(var n=e.desc.fields,o=e.data,d=n.reduce(function(e,t){return Math.max(e,t.name.length)},0)+e.desc.name.length+5,f=0,l=n;f<l.length;f++){var v=l[f];r.writePadRight(t,e.desc.name+"."+v.name,d);var g=v.presence,p=g?g(o,0):0;if(0!==p)1===p?a(t):c(t);else{var h=v.string(o,0);i(h)?(u(t,h),r.newline(t)):s(t,h)}r.newline(t)}r.write(t,"#\n")}(n[0],this.writer):function(e,t){o(t,"loop_");for(var n=e[0],d=n.desc.fields,f=0,l=d;f<l.length;f++){var v=l[f];o(t,n.desc.name+"."+v.name)}for(var g=0,p=e;g<p.length;g++)for(var h=p[g],m=h.data,y=h.count,w=0;w<y;w++){for(var C=0,b=d;C<b.length;C++){var v=b[C],_=v.presence,x=_?_(m,w):0;if(0!==x)1===x?a(t):c(t);else{var S=v.string(m,w);i(S)?(u(t,S),r.newline(t)):s(t,S)}}r.newline(t)}r.write(t,"#\n")}(n,this.writer))}},e.prototype.encode=function(){this.encoded=!0},e.prototype.flush=function(e){r.writeTo(this.writer,e)},e}();function i(e){return!!e&&e.indexOf("\n")>=0}function o(e,t){r.write(e,t),r.newline(e)}function a(e){r.writeSafe(e,". ")}function c(e){r.writeSafe(e,"? ")}function s(e,t){if(t){for(var n=!1,i="'",o="' ",a=!1,c=!1,s=!1,u=0,d=t.length-1;u<d;u++){switch(t.charCodeAt(u)){case 9:a=!0;break;case 10:return r.writeSafe(e,"\n;"+t),void r.writeSafe(e,"\n; ");case 32:a=!0;break;case 34:if(c)return r.writeSafe(e,"\n;"+t),void r.writeSafe(e,"\n; ");s=!0,n=!0,i="'",o="' ";break;case 39:if(s)return r.writeSafe(e,"\n;"+t),void r.writeSafe(e,"\n; ");n=!0,c=!0,i='"',o='" '}}var f=t.charCodeAt(0);n||35!==f&&36!==f&&59!==f&&91!==f&&93!==f&&!a||(i="'",o="' ",n=!0),n?r.writeSafe(e,i+t+o):(r.write(e,t),r.writeSafe(e," "))}else r.writeSafe(e,". ")}function u(e,t){r.writeSafe(e,"\n;"+t),r.writeSafe(e,"\n; ")}t.Writer=n}(e.Text||(e.Text={})),function(e){function t(e,t){for(var r={},n=0;n<t;n++)r[o(e)]=o(e);return r}function r(e,t){for(var r=new Uint8Array(t),n=e.offset,i=0;i<t;i++)r[i]=e.buffer[i+n];return e.offset+=t,r}function n(t,r){var n=e.utf8Read(t.buffer,t.offset,r);return t.offset+=r,n}function i(e,t){for(var r=new Array(t),n=0;n<t;n++)r[n]=o(e);return r}function o(e){var o,a,c=e.buffer[e.offset];if(0==(128&c))return e.offset++,c;if(128==(240&c))return a=15&c,e.offset++,t(e,a);if(144==(240&c))return a=15&c,e.offset++,i(e,a);if(160==(224&c))return a=31&c,e.offset++,n(e,a);if(224==(224&c))return o=e.dataView.getInt8(e.offset),e.offset++,o;switch(c){case 192:return e.offset++,null;case 194:return e.offset++,!1;case 195:return e.offset++,!0;case 196:return a=e.dataView.getUint8(e.offset+1),e.offset+=2,r(e,a);case 197:return a=e.dataView.getUint16(e.offset+1),e.offset+=3,r(e,a);case 198:return a=e.dataView.getUint32(e.offset+1),e.offset+=5,r(e,a);case 202:return o=e.dataView.getFloat32(e.offset+1),e.offset+=5,o;case 203:return o=e.dataView.getFloat64(e.offset+1),e.offset+=9,o;case 204:return o=e.buffer[e.offset+1],e.offset+=2,o;case 205:return o=e.dataView.getUint16(e.offset+1),e.offset+=3,o;case 206:return o=e.dataView.getUint32(e.offset+1),e.offset+=5,o;case 208:return o=e.dataView.getInt8(e.offset+1),e.offset+=2,o;case 209:return o=e.dataView.getInt16(e.offset+1),e.offset+=3,o;case 210:return o=e.dataView.getInt32(e.offset+1),e.offset+=5,o;case 217:return a=e.dataView.getUint8(e.offset+1),e.offset+=2,n(e,a);case 218:return a=e.dataView.getUint16(e.offset+1),e.offset+=3,n(e,a);case 219:return a=e.dataView.getUint32(e.offset+1),e.offset+=5,n(e,a);case 220:return a=e.dataView.getUint16(e.offset+1),e.offset+=3,i(e,a);case 221:return a=e.dataView.getUint32(e.offset+1),e.offset+=5,i(e,a);case 222:return a=e.dataView.getUint16(e.offset+1),e.offset+=3,t(e,a);case 223:return a=e.dataView.getUint32(e.offset+1),e.offset+=5,t(e,a)}throw new Error("Unknown type 0x"+c.toString(16))}e.decode=function(e){return o({buffer:e,offset:0,dataView:new DataView(e.buffer)})}}((c=e.Binary||(e.Binary={})).MessagePack||(c.MessagePack={})),u=e.Binary||(e.Binary={}),(s=u.MessagePack||(u.MessagePack={})).encode=function(e){var t=new ArrayBuffer(function e(t){var r=typeof t;if("string"===r){var n=s.utf8ByteCount(t);if(n<32)return 1+n;if(n<256)return 2+n;if(n<65536)return 3+n;if(n<4294967296)return 5+n}if(t instanceof Uint8Array){var i=t.byteLength;if(i<256)return 2+i;if(i<65536)return 3+i;if(i<4294967296)return 5+i}if("number"===r){if(Math.floor(t)!==t)return 9;if(t>=0){if(t<128)return 1;if(t<256)return 2;if(t<65536)return 3;if(t<4294967296)return 5;throw new Error("Number too big 0x"+t.toString(16))}if(t>=-32)return 1;if(t>=-128)return 2;if(t>=-32768)return 3;if(t>=-2147483648)return 5;throw new Error("Number too small -0x"+t.toString(16).substr(1))}if("boolean"===r||null===t||void 0===t)return 1;if("object"===r){var o,a=0;if(Array.isArray(t)){o=t.length;for(var c=0;c<o;c++)a+=e(t[c])}else{var u=Object.keys(t);o=u.length;for(var c=0;c<o;c++){var d=u[c];a+=e(d)+e(t[d])}}if(o<16)return 1+a;if(o<65536)return 3+a;if(o<4294967296)return 5+a;throw new Error("Array or object too long 0x"+o.toString(16))}throw new Error("Unknown type "+r)}(e)),r=new DataView(t),n=new Uint8Array(t);return function e(t,r,n,i){var o=typeof t;if("string"===o){var a=s.utf8ByteCount(t);if(a<32)return r.setUint8(i,160|a),s.utf8Write(n,i+1,t),1+a;if(a<256)return r.setUint8(i,217),r.setUint8(i+1,a),s.utf8Write(n,i+2,t),2+a;if(a<65536)return r.setUint8(i,218),r.setUint16(i+1,a),s.utf8Write(n,i+3,t),3+a;if(a<4294967296)return r.setUint8(i,219),r.setUint32(i+1,a),s.utf8Write(n,i+5,t),5+a}if(t instanceof Uint8Array){var c=t.byteLength,u=new Uint8Array(r.buffer);if(c<256)return r.setUint8(i,196),r.setUint8(i+1,c),u.set(t,i+2),2+c;if(c<65536)return r.setUint8(i,197),r.setUint16(i+1,c),u.set(t,i+3),3+c;if(c<4294967296)return r.setUint8(i,198),r.setUint32(i+1,c),u.set(t,i+5),5+c}if("number"===o){if(!isFinite(t))throw new Error("Number not finite: "+t);if(Math.floor(t)!==t)return r.setUint8(i,203),r.setFloat64(i+1,t),9;if(t>=0){if(t<128)return r.setUint8(i,t),1;if(t<256)return r.setUint8(i,204),r.setUint8(i+1,t),2;if(t<65536)return r.setUint8(i,205),r.setUint16(i+1,t),3;if(t<4294967296)return r.setUint8(i,206),r.setUint32(i+1,t),5;throw new Error("Number too big 0x"+t.toString(16))}if(t>=-32)return r.setInt8(i,t),1;if(t>=-128)return r.setUint8(i,208),r.setInt8(i+1,t),2;if(t>=-32768)return r.setUint8(i,209),r.setInt16(i+1,t),3;if(t>=-2147483648)return r.setUint8(i,210),r.setInt32(i+1,t),5;throw new Error("Number too small -0x"+(-t).toString(16).substr(1))}if(null===t||void 0===t)return r.setUint8(i,192),1;if("boolean"===o)return r.setUint8(i,t?195:194),1;if("object"===o){var d,f=0,l=Array.isArray(t),v=void 0;if(l?d=t.length:(v=Object.keys(t),d=v.length),d<16?(r.setUint8(i,d|(l?144:128)),f=1):d<65536?(r.setUint8(i,l?220:222),r.setUint16(i+1,d),f=3):d<4294967296&&(r.setUint8(i,l?221:223),r.setUint32(i+1,d),f=5),l)for(var g=0;g<d;g++)f+=e(t[g],r,n,i+f);else for(var p=0,h=v;p<h.length;p++){var m=h[p];f+=e(m,r,n,i+f),f+=e(t[m],r,n,i+f)}return f}throw new Error("Unknown type "+o)}(e,r,n,0),n},function(e){e.utf8Write=function(e,t,r){e.byteLength;for(var n=0,i=r.length;n<i;n++){var o=r.charCodeAt(n);if(o<128)e[t++]=o>>>0&127|0;else if(o<2048)e[t++]=o>>>6&31|192,e[t++]=o>>>0&63|128;else if(o<65536)e[t++]=o>>>12&15|224,e[t++]=o>>>6&63|128,e[t++]=o>>>0&63|128;else{if(!(o<1114112))throw new Error("bad codepoint "+o);e[t++]=o>>>18&7|240,e[t++]=o>>>12&63|128,e[t++]=o>>>6&63|128,e[t++]=o>>>0&63|128}}};var t=function(){for(var e=[],t=0;t<1024;t++)e[t]=String.fromCharCode(t);return e}();function r(e){throw new Error(e)}e.utf8Read=function(e,n,i){for(var o=t,a=void 0,c=[],s=0,u=n,d=n+i;u<d;u++){var f=e[u];0==(128&f)?c[s++]=o[f]:192==(224&f)?c[s++]=o[(15&f)<<6|63&e[++u]]:224==(240&f)?c[s++]=String.fromCharCode((15&f)<<12|(63&e[++u])<<6|(63&e[++u])<<0):240==(248&f)?c[s++]=String.fromCharCode((7&f)<<18|(63&e[++u])<<12|(63&e[++u])<<6|(63&e[++u])<<0):r("Invalid byte "+f.toString(16)),512===s&&((a=a||[])[a.length]=c.join(""),s=0)}return a?(s>0&&(a[a.length]=c.slice(0,s).join("")),a.join("")):c.slice(0,s).join("")},e.utf8ByteCount=function(e){for(var t=0,n=0,i=e.length;n<i;n++){var o=e.charCodeAt(n);o<128?t+=1:o<2048?t+=2:o<65536?t+=3:o<1114112?t+=4:r("bad codepoint "+o)}return t}}((d=e.Binary||(e.Binary={})).MessagePack||(d.MessagePack={})),function(e){"use strict";function t(e){for(var t=e.data,n=e.encoding.length-1;n>=0;n--)t=r.decodeStep(t,e.encoding[n]);return t}var r;e.decode=t,function(e){function n(e,t){switch(e){case 1:return new Int8Array(t);case 2:return new Int16Array(t);case 3:return new Int32Array(t);case 4:return new Uint8Array(t);case 5:return new Uint16Array(t);case 6:return new Uint32Array(t);default:throw new Error("Unsupported integer data type.")}}function i(e,t){switch(e){case 32:return new Float32Array(t);case 33:return new Float64Array(t);default:throw new Error("Unsupported floating data type.")}}(r||(r={})).decodeStep=function(e,r){switch(r.kind){case"ByteArray":switch(r.type){case 4:return e;case 1:return c=e,new Int8Array(c.buffer,c.byteOffset);case 2:return u(e,2,Int16Array);case 5:return u(e,2,Uint16Array);case 3:return u(e,4,Int32Array);case 6:return u(e,4,Uint32Array);case 32:return u(e,4,Float32Array);case 33:return u(e,8,Float64Array);default:throw new Error("Unsupported ByteArray type.")}case"FixedPoint":return function(e,t){for(var r=e.length,n=i(t.srcType,r),o=1/t.factor,a=0;a<r;a++)n[a]=o*e[a];return n}(e,r);case"IntervalQuantization":return function(e,t){for(var r=e.length,n=i(t.srcType,r),o=(t.max-t.min)/(t.numSteps-1),a=t.min,c=0;c<r;c++)n[c]=a+o*e[c];return n}(e,r);case"RunLength":return function(e,t){for(var r=n(t.srcType,t.srcSize),i=0,o=0,a=e.length;o<a;o+=2)for(var c=e[o],s=e[o+1],u=0;u<s;++u)r[i++]=c;return r}(e,r);case"Delta":return function(e,t){var r=e.length,i=n(t.srcType,r);if(!r)return i;i[0]=e[0]+(0|t.origin);for(var o=1;o<r;++o)i[o]=e[o]+i[o-1];return i}(e,r);case"IntegerPacking":return o=e,(a=r).isUnsigned?function(e,t){for(var r=1===t.byteCount?255:65535,n=e.length,i=new Int32Array(t.srcSize),o=0,a=0;o<n;){for(var c=0,s=e[o];s===r;)c+=s,s=e[++o];c+=s,i[a]=c,o++,a++}return i}(o,a):function(e,t){for(var r=1===t.byteCount?127:32767,n=-r-1,i=e.length,o=new Int32Array(t.srcSize),a=0,c=0;a<i;){for(var s=0,u=e[a];u===r||u===n;)s+=u,u=e[++a];s+=u,o[c]=s,a++,c++}return o}(o,a);case"StringArray":return function(e,r){for(var n=r.stringData,i=t({encoding:r.offsetEncoding,data:r.offsets}),o=t({encoding:r.dataEncoding,data:e}),a=Object.create(null),c=new Array(o.length),s=0,u=0,d=o;u<d.length;u++){var f=d[u];if(f<0)c[s++]=null;else{var l=a[f];void 0===l&&(l=n.substring(i[f],i[f+1]),a[f]=l),c[s++]=l}}return c}(e,r)}var o,a,c};var o,a,c,s=(o=new ArrayBuffer(2),a=new Uint8Array(o),c=new Uint16Array(o),a[0]=170,a[1]=187,48042===c[0]);function u(e,t,r){return new r(s?e.buffer:function(e,t){for(var r=new ArrayBuffer(e.length),n=new Uint8Array(r),i=0,o=e.length;i<o;i+=t)for(var a=0;a<t;a++)n[i+t-a-1]=e[i+a];return r}(e,t))}}()}(e.Binary||(e.Binary={})),function(t){"use strict";var r=function(){function e(e){this.dataBlocks=e.dataBlocks.map(function(e){return new n(e)})}return e.prototype.toJSON=function(){return this.dataBlocks.map(function(e){return e.toJSON()})},e}();t.File=r;var n=function(){function e(e){this.additionalData={},this.header=e.header,this.categoryList=e.categories.map(function(e){return new i(e)}),this.categoryMap=new Map;for(var t=0,r=this.categoryList;t<r.length;t++){var n=r[t];this.categoryMap.set(n.name,n)}}return Object.defineProperty(e.prototype,"categories",{get:function(){return this.categoryList},enumerable:!0,configurable:!0}),e.prototype.getCategory=function(e){return this.categoryMap.get(e)},e.prototype.toJSON=function(){return{id:this.header,categories:this.categoryList.map(function(e){return e.toJSON()}),additionalData:this.additionalData}},e}();t.DataBlock=n;var i=function(){function r(e){this.name=e.name,this.columnCount=e.columns.length,this.rowCount=e.rowCount,this.columnNameList=[],this.encodedColumns=new Map;for(var t=0,r=e.columns;t<r.length;t++){var n=r[t];this.encodedColumns.set(n.name,n),this.columnNameList.push(n.name)}}return Object.defineProperty(r.prototype,"columnNames",{get:function(){return this.columnNameList},enumerable:!0,configurable:!0}),r.prototype.getColumn=function(r){var n=this.encodedColumns.get(r);return n?function(r){if(!r.data.data)return e.UndefinedColumn;var n=t.decode(r.data),i=void 0;r.mask&&(i=t.decode(r.mask));if(n.buffer&&n.byteLength&&n.BYTES_PER_ELEMENT)return i?new s(n,i):new c(n);return i?new d(n,i):new u(n)}(n):e.UndefinedColumn},r.prototype.toJSON=function(){for(var e=this,t=[],r=this.columnNameList.map(function(t){return{name:t,column:e.getColumn(t)}}),n=0;n<this.rowCount;n++){for(var i={},o=0,a=r;o<a.length;o++){var c=a[o],s=c.column.getValuePresence(n);i[c.name]=0===s?c.column.getString(n):1===s?".":"?"}t[n]=i}return{name:this.name,columns:this.columnNames,rows:t}},r}();t.Category=i;var o=e.Utils.FastNumberParsers.parseInt,a=e.Utils.FastNumberParsers.parseFloat,c=function(){function e(e){this.data=e,this.isDefined=!0}return e.prototype.getString=function(e){return""+this.data[e]},e.prototype.getInteger=function(e){return 0|this.data[e]},e.prototype.getFloat=function(e){return 1*this.data[e]},e.prototype.stringEquals=function(e,t){return this.data[e]===a(t,0,t.length)},e.prototype.areValuesEqual=function(e,t){return this.data[e]===this.data[t]},e.prototype.getValuePresence=function(e){return 0},e}(),s=function(){function e(e,t){this.data=e,this.mask=t,this.isDefined=!0}return e.prototype.getString=function(e){return 0===this.mask[e]?""+this.data[e]:null},e.prototype.getInteger=function(e){return 0===this.mask[e]?this.data[e]:0},e.prototype.getFloat=function(e){return 0===this.mask[e]?this.data[e]:0},e.prototype.stringEquals=function(e,t){return 0===this.mask[e]?this.data[e]===a(t,0,t.length):null===t||void 0===t},e.prototype.areValuesEqual=function(e,t){return this.data[e]===this.data[t]},e.prototype.getValuePresence=function(e){return this.mask[e]},e}(),u=function(){function e(e){this.data=e,this.isDefined=!0}return e.prototype.getString=function(e){return this.data[e]},e.prototype.getInteger=function(e){var t=this.data[e];return o(t,0,t.length)},e.prototype.getFloat=function(e){var t=this.data[e];return a(t,0,t.length)},e.prototype.stringEquals=function(e,t){return this.data[e]===t},e.prototype.areValuesEqual=function(e,t){return this.data[e]===this.data[t]},e.prototype.getValuePresence=function(e){return 0},e}(),d=function(){function e(e,t){this.data=e,this.mask=t,this.isDefined=!0}return e.prototype.getString=function(e){return 0===this.mask[e]?this.data[e]:null},e.prototype.getInteger=function(e){if(0!==this.mask[e])return 0;var t=this.data[e];return o(t||"",0,(t||"").length)},e.prototype.getFloat=function(e){if(0!==this.mask[e])return 0;var t=this.data[e];return a(t||"",0,(t||"").length)},e.prototype.stringEquals=function(e,t){return this.data[e]===t},e.prototype.areValuesEqual=function(e,t){return this.data[e]===this.data[t]},e.prototype.getValuePresence=function(e){return this.mask[e]},e}()}(e.Binary||(e.Binary={})),function(t){"use strict";var r=function(){function e(e){this.providers=e}return e.prototype.and=function(t){return new e(this.providers.concat([t]))},e.prototype.encode=function(e){for(var t=[],r=0,n=this.providers;r<n.length;r++){var i=(0,n[r])(e);if(!i.encodings.length)throw new Error("Encodings must be non-empty.");e=i.data;for(var o=0,a=i.encodings;o<a.length;o++){var c=a[o];t.push(c)}}if(!(e instanceof Uint8Array))throw new Error("The encoding must result in a Uint8Array. Fix your encoding chain.");return{encoding:t,data:e}},e}();t.Encoder=r,function(r){var n,i;r.by=function(e){return new r([e])};var o=((n={})[2]=function(e,t,r){e.setInt16(2*t,r,!0)},n[5]=function(e,t,r){e.setUint16(2*t,r,!0)},n[3]=function(e,t,r){e.setInt32(4*t,r,!0)},n[6]=function(e,t,r){e.setUint32(4*t,r,!0)},n[32]=function(e,t,r){e.setFloat32(4*t,r,!0)},n[33]=function(e,t,r){e.setFloat64(8*t,r,!0)},n),a=((i={})[2]=2,i[5]=2,i[3]=4,i[6]=4,i[32]=4,i[33]=8,i);function c(e){var r,n=t.Encoding.getDataType(e);if(1===n)return r=e,{encodings:[{kind:"ByteArray",type:1}],data:new Uint8Array(r.buffer,r.byteOffset)};if(4===n)return{encodings:[{kind:"ByteArray",type:4}],data:e};for(var i=new Uint8Array(e.length*a[n]),c=o[n],s=new DataView(i.buffer),u=0,d=e.length;u<d;u++)c(s,u,e[u]);return{encodings:[{kind:"ByteArray",type:n}],data:i}}function s(e){var r=t.Encoding.getDataType(e);if(void 0===r&&(e=new Int32Array(e),r=3),!e.length)return{encodings:[{kind:"RunLength",srcType:r,srcSize:0}],data:new Int32Array(0)};for(var n=2,i=1,o=e.length;i<o;i++)e[i-1]!==e[i]&&(n+=2);var a=new Int32Array(n),c=0,s=1;for(i=1,o=e.length;i<o;i++)e[i-1]!==e[i]?(a[c]=e[i-1],a[c+1]=s,s=1,c+=2):++s;return a[c]=e[e.length-1],a[c+1]=s,{encodings:[{kind:"RunLength",srcType:r,srcSize:e.length}],data:a}}function u(e){if(!t.Encoding.isSignedIntegerDataType(e))throw new Error("Only signed integer types can be encoded using delta encoding.");var r=t.Encoding.getDataType(e);if(void 0===r&&(e=new Int32Array(e),r=3),!e.length)return{encodings:[{kind:"Delta",origin:0,srcType:r}],data:new e.constructor(0)};var n=new e.constructor(e.length),i=e[0];n[0]=e[0];for(var o=1,a=e.length;o<a;o++)n[o]=e[o]-e[o-1];return n[0]=0,{encodings:[{kind:"Delta",origin:i,srcType:r}],data:n}}function d(e,t){for(var r=-t-1,n=0,i=0,o=e.length;i<o;i++){var a=e[i];0===a?n+=1:a>0?(n+=Math.ceil(a/t),a%t==0&&(n+=1)):(n+=Math.ceil(a/r),a%r==0&&(n+=1))}return n}function f(e){if(!(e instanceof Int32Array))throw new Error("Integer packing can only be applied to Int32 data.");var t,r,n,i,o=(r=function(e){for(var t=0,r=e.length;t<r;t++)if(e[t]<0)return!0;return!1}(t=e),n=d(t,r?127:255),i=d(t,r?32767:65535),4*t.length<2*i?{isSigned:r,size:t.length,bytesPerElement:4}:2*i<n?{isSigned:r,size:i,bytesPerElement:2}:{isSigned:r,size:n,bytesPerElement:1});return 4===o.bytesPerElement?c(e):function(e,t){for(var r=t.isSigned?1===t.bytesPerElement?127:32767:1===t.bytesPerElement?255:65535,n=-r-1,i=e.length,o=t.isSigned?1===t.bytesPerElement?new Int8Array(t.size):new Int16Array(t.size):1===t.bytesPerElement?new Uint8Array(t.size):new Uint16Array(t.size),a=0,s=0;s<i;s++){var u=e[s];if(u>=0)for(;u>=r;)o[a]=r,++a,u-=r;else for(;u<=n;)o[a]=n,++a,u-=n;o[a]=u,++a}var d=c(o);return{encodings:[{kind:"IntegerPacking",byteCount:t.bytesPerElement,isUnsigned:!t.isSigned,srcSize:i},d.encodings[0]],data:d.data}}(e,o)}r.byteArray=c,r.fixedPoint=function(e){return function(r){return function(e,r){for(var n=t.Encoding.getDataType(e),i=new Int32Array(e.length),o=0,a=e.length;o<a;o++)i[o]=Math.round(e[o]*r);return{encodings:[{kind:"FixedPoint",factor:r,srcType:n}],data:i}}(r,e)}},r.intervalQuantizaiton=function(e,r,n,i){return void 0===i&&(i=Int32Array),function(o){return function(e,r,n,i,o){var a=t.Encoding.getDataType(e);if(!e.length)return{encodings:[{kind:"IntervalQuantization",min:r,max:n,numSteps:i,srcType:a}],data:new Int32Array(0)};if(n<r){var c=r;r=n,n=c}for(var s=(n-r)/(i-1),u=new o(e.length),d=0,f=e.length;d<f;d++){var l=e[d];u[d]=l<=r?0:l>=n?i:0|Math.round((l-r)/s)}return{encodings:[{kind:"IntervalQuantization",min:r,max:n,numSteps:i,srcType:a}],data:u}}(o,e,r,n,i)}},r.runLength=s,r.delta=u,r.integerPacking=f,r.stringArray=function(t){var n=Object.create(null),i=[],o=0,a=e.Utils.ChunkedArray.create(function(e){return new Int32Array(e)},1024,1),c=new Int32Array(t.length);e.Utils.ChunkedArray.add(a,0);for(var d=0,l=0,v=t;l<v.length;l++){var g=v[l];if(null!==g&&void 0!==g){var p=n[g];void 0===p&&(o+=g.length,i[p=i.length]=g,n[g]=p,e.Utils.ChunkedArray.add(a,o)),c[d++]=p}else c[d++]=-1}var h=r.by(u).and(f).encode(e.Utils.ChunkedArray.compact(a)),m=r.by(u).and(s).and(f).encode(c);return{encodings:[{kind:"StringArray",dataEncoding:m.encoding,stringData:i.join(""),offsetEncoding:h.encoding,offsets:h.data}],data:m.data}}}(r=t.Encoder||(t.Encoder={}))}(e.Binary||(e.Binary={})),function(e){"use strict";e.VERSION="0.3.0",function(e){e.getDataType=function(e){var t;if(e instanceof Int8Array)t=1;else if(e instanceof Int16Array)t=2;else if(e instanceof Int32Array)t=3;else if(e instanceof Uint8Array)t=4;else if(e instanceof Uint16Array)t=5;else if(e instanceof Uint32Array)t=6;else if(e instanceof Float32Array)t=32;else{if(!(e instanceof Float64Array))throw new Error("Unsupported integer data type.");t=33}return t},e.isSignedIntegerDataType=function(e){return e instanceof Int8Array||e instanceof Int16Array||e instanceof Int32Array}}(e.Encoding||(e.Encoding={}))}(e.Binary||(e.Binary={})),function(t){"use strict";t.parse=function(r){var n=[0,3];try{var i=new Uint8Array(r),o=t.MessagePack.decode(i);if(!function(e,t){for(var r=0;r<2;r++)if(e[r]>t[r])return!1;return!0}(n,o.version.match(/(\d)\.(\d)\.\d/).slice(1)))return e.ParserResult.error("Unsupported format version. Current "+o.version+", required "+n.join(".")+".");var a=new t.File(o);return e.ParserResult.success(a)}catch(t){return e.ParserResult.error(""+t)}}}(e.Binary||(e.Binary={})),function(e){"use strict";function t(t,r,n){var i,o=!1;t.typedArray?i=new t.typedArray(n):(o=!0,i=new Array(n));for(var a=new Uint8Array(n),c=t.presence,s=t.number?t.number:t.string,u=!0,d=0,f=0,l=r;f<l.length;f++)for(var v=l[f],g=v.data,p=0,h=v.count;p<h;p++){var m=c?c(g,p):0;0!==m?(a[d]=m,o&&(i[d]=null),u=!1):(a[d]=0,i[d]=s(g,p)),d++}var y=(t.encoder?t.encoder:e.Encoder.by(e.Encoder.stringArray)).encode(i),w=void 0;if(!u){var C=e.Encoder.by(e.Encoder.runLength).and(e.Encoder.byteArray).encode(a);w=C.data.length<a.length?C:e.Encoder.by(e.Encoder.byteArray).encode(a)}return{name:t.name,data:y,mask:w}}var r=function(){function r(t){this.dataBlocks=[],this.data={encoder:t,version:e.VERSION,dataBlocks:this.dataBlocks}}return r.prototype.startDataBlock=function(e){this.dataBlocks.push({header:(e||"").replace(/[ \n\t]/g,"").toUpperCase(),categories:[]})},r.prototype.writeCategory=function(e,r){if(!this.data)throw new Error("The writer contents have already been encoded, no more writing.");if(!this.dataBlocks.length)throw new Error("No data block created.");var n=(r&&r.length?r.map(function(t){return e(t)}):[e(void 0)]).filter(function(e){return e&&e.count>0});if(n.length){var i=n.reduce(function(e,t){return e+t.count},0);if(i){for(var o=n[0],a={name:o.desc.name,columns:[],rowCount:i},c=n.map(function(e){return{data:e.data,count:e.count}}),s=0,u=o.desc.fields;s<u.length;s++){var d=u[s];a.columns.push(t(d,c,i))}this.dataBlocks[this.dataBlocks.length-1].categories.push(a)}}},r.prototype.encode=function(){this.encodedData=e.MessagePack.encode(this.data),this.data=null,this.dataBlocks=null},r.prototype.flush=function(e){e.writeBinary(this.encodedData)},r}();e.Writer=r}(e.Binary||(e.Binary={}))}(CIFTools||(CIFTools={})),function(e,t,r){var n,i="__instance__",o="firstChild",a=setTimeout;function c(e){return void 0!==e}function s(e){return"object"==typeof e}function u(e){return Object.keys(e).length}function d(e,t,r){return e<t?t:e>r?r:e}function f(e,t){return parseInt(e,t||10)}function l(e){return Math.round(e)}function v(e){var t,r,n,i,o,a,c,s,u=+e[0],d=+e[1],f=+e[2];switch(a=f*(1-d),c=f*(1-(o=6*u-(i=Math.floor(6*u)))*d),s=f*(1-(1-o)*d),i=i||0,c=c||0,s=s||0,i%6){case 0:t=f,r=s,n=a;break;case 1:t=c,r=f,n=a;break;case 2:t=a,r=f,n=s;break;case 3:t=a,r=c,n=f;break;case 4:t=s,r=a,n=f;break;case 5:t=f,r=a,n=c}return[l(255*t),l(255*r),l(255*n)]}function g(e){return h(v(e))}function p(e){var t,r=+e[0],n=+e[1],i=+e[2],o=Math.max(r,n,i),a=Math.min(r,n,i),c=o-a,s=0===o?0:c/o,u=o/255;switch(o){case a:t=0;break;case r:t=n-i+c*(n<i?6:0),t/=6*c;break;case n:t=i-r+2*c,t/=6*c;break;case i:t=r-n+4*c,t/=6*c}return[t,s,u]}function h(e){var t=+e[2]|+e[1]<<8|+e[0]<<16;return(t="000000"+t.toString(16)).slice(-6)}function m(e){return p(y(e))}function y(e){return 3===e.length&&(e=e.replace(/./g,"$&$&")),[f(e[0]+e[1],16),f(e[2]+e[3],16),f(e[4]+e[5],16)]}function w(e){return[+e[0]/360,+e[1]/100,+e[2]/100]}function C(e){return[l(360*+e[0]),l(100*+e[1]),l(100*+e[2])]}function b(e){if(s(e))return e;var t=/\s*rgb\s*\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*\)\s*$/i.exec(e),r=/\s*hsv\s*\(\s*(\d+)\s*,\s*(\d+)%\s*,\s*(\d+)%\s*\)\s*$/i.exec(e);return"#"===e[0]&&e.match(/^#([\da-f]{3}|[\da-f]{6})$/i)?m(e.slice(1)):r?w([+r[1],+r[2],+r[3]]):t?p([+t[1],+t[2],+t[3]]):[0,1,1]}(n=e.CP=function(r,n,f){var l=t.body,p=t.documentElement,h=this,m=e.CP,y=!1,w={},C=t.createElement("div"),b="touchstart mousedown",_="touchmove mousemove",x="touchend mouseup",S="orientationchange resize";if(!(h instanceof m))return new m(r,n);function I(e,t,r){for(var n=0,i=(e=e.split(/\s+/)).length;n<i;++n)t.addEventListener(e[n],r,!1)}function A(e,t,r){for(var n=0,i=(e=e.split(/\s+/)).length;n<i;++n)t.removeEventListener(e[n],r)}function T(e,t){var r="touches",n="clientX",i="clientY",o=t[r]?t[r][0][n]:t[n],a=t[r]?t[r][0][i]:t[i],c=k(e);return{x:o-c.l,y:a-c.t}}function k(t){var r,n,i;return t===e?(r=e.pageXOffset||p.scrollLeft,n=e.pageYOffset||p.scrollTop):(r=(i=t.getBoundingClientRect()).left,n=i.top),{l:r,t:n}}function E(e,t){for(;(e=e.parentElement)&&e!==t;);return e}function P(e){e&&e.preventDefault()}function N(t){return t===e?{w:e.innerWidth,h:e.innerHeight}:{w:t.offsetWidth,h:t.offsetHeight}}function R(e){return y||!!c(e)&&e}function L(e){y=e}function D(e,t,r){if(!c(w[e]))return h;if(c(r))c(w[e][r])&&w[e][r].apply(h,t);else for(var n in w[e])w[e][n].apply(h,t);return h}m[i][r.id||r.name||u(m[i])]=h,c(n)&&!0!==n||(n=b),L(m.parse(r.getAttribute("data-color")||r.value||[0,1,1])),C.className="color-picker",C.innerHTML='<div class="color-picker-control"><span class="color-picker-h"><i></i></span><span class="color-picker-sv"><i></i></span></div>';var O,U=C[o].children,F=R([0,1,1]),M=U[0],z=U[1],B=M[o],V=z[o],G=0,H=0,j=0,W=0,q=0,X=0,K=0,Y=0,$=g(F);function Q(e,t){e&&"h"!==e||D("change:h",t),e&&"sv"!==e||D("change:sv",t),D("change",t)}function J(){return C.parentNode}function Z(i,o){i||((f||o||l).appendChild(C),h.visible=!0),K=N(C).w,Y=N(C).h;var a=N(z),c=N(V),s=N(M).h,u=a.w,p=a.h,m=N(B).h,y=c.w,w=c.h;if(i){function k(e){var t=e.target,n=t===r||E(t,r)===r;n?Z():h.exit(),D(n?"enter":"exit",[h])}C.style.left=C.style.top="-9999px",!1!==n&&I(n,r,k),h.create=function(){return Z(1),D("create",[h]),h},h.destroy=function(){return!1!==n&&A(n,r,k),h.exit(),L(!1),D("destroy",[h]),h}}else ee();function U(e){v(F);var t=v([F[0],1,1]);z.style.backgroundColor="rgb("+t.join(",")+")",L(F),P(e)}function q(e){var t,r,n,i,o,a;j&&(r=d(T(M,t=e).y,0,s),F[0]=(s-r)/s,B.style.top=r-m/2+"px",U(t),$=g(F),G||(D("drag:h",[$,h]),D("drag",[$,h]),Q("h",[$,h]))),W&&(i=T(z,n=e),o=d(i.x,0,u),a=d(i.y,0,p),F[1]=1-(u-o)/u,F[2]=(p-a)/p,V.style.right=u-o-y/2+"px",V.style.top=a-w/2+"px",U(n),$=g(F),H||(D("drag:sv",[$,h]),D("drag",[$,h]),Q("sv",[$,h]))),G=0,H=0}function X(e){var t=e.target,i=j?"h":"sv",o=[g(F),h],a=t===r||E(t,r)===r,c=t===C||E(t,C)===C;a||c?c&&(D("stop:"+i,o),D("stop",o),Q(i,o)):J()&&!1!==n&&(h.exit(),D("exit",[h]),Q(0,o)),j=0,W=0}function te(e){G=1,j=1,q(e),P(e),D("start:h",[$,h]),D("start",[$,h]),Q("h",[$,h])}function re(e){H=1,W=1,q(e),P(e),D("start:sv",[$,h]),D("start",[$,h]),Q("sv",[$,h])}O=function(){F=R(F),U(),B.style.top=s-m/2-s*+F[0]+"px",V.style.right=u-y/2-u*+F[1]+"px",V.style.top=p-w/2-p*+F[2]+"px"},h.exit=function(r){return J()&&(J().removeChild(C),h.visible=!1),A(b,M,te),A(b,z,re),A(_,t,q),A(x,t,X),A(S,e,ee),h},O(),i||(I(b,M,te),I(b,z,re),I(_,t,q),I(x,t,X),I(S,e,ee))}function ee(){return h.fit()}return Z(1),a(function(){var e=[g(F),h];D("create",e),Q(0,e)},0),h.fit=function(t){var n=N(e),i=N(p),o=n.w-i.w,a=n.h-p.clientHeight,u=k(e),f=k(r);if(q=f.l+u.l,X=f.t+u.t+N(r).h,s(t))c(t[0])&&(q=t[0]),c(t[1])&&(X=t[1]);else{var l=u.l,v=u.t,g=u.l+n.w-K-o,m=u.t+n.h-Y-a;q=d(q,l,g)>>0,X=d(X,v,m)>>0}return C.style.left=q+"px",C.style.top=X+"px",D("fit",[h]),h},h.set=function(e){return c(e)?("string"==typeof e&&(e=m.parse(e)),L(e),O(),h):R()},h.get=function(e){return R(e)},h.target=r,h.picker=C,h.visible=!1,h.on=function(e,t,r){return c(e)?c(t)?(c(w[e])||(w[e]={}),c(r)||(r=u(w[e])),w[e][r]=t,h):w[e]:w},h.off=function(e,t){return c(e)?c(t)?(delete w[e][t],h):(w[e]={},h):(w={},h)},h.fire=D,h.hooks=w,h.enter=function(e){return Z(0,e)},h}).version="1.3.9",n[i]={},n.each=function(e,t){return a(function(){var t,r=n[i];for(t in r)e(r[t],t,r)},0===t?0:t||1),n},n.parse=b,n._HSV2RGB=v,n._HSV2HEX=g,n._RGB2HSV=p,n._HEX2HSV=m,n._HEX2RGB=function(e){return[+(t=y(e))[0]/255,+t[1]/255,+t[2]/255];var t},n.HSV2RGB=function(e){return v(w(e))},n.HSV2HEX=function(e){return g(w(e))},n.RGB2HSV=function(e){return C(p(e))},n.RGB2HEX=h,n.HEX2HSV=function(e){return C(m(e))},n.HEX2RGB=y}(window,document);var saveAs=function(e){"use strict";if(!(void 0===e||"undefined"!=typeof navigator&&/MSIE [1-9]\./.test(navigator.userAgent))){var t=function(){return e.URL||e.webkitURL||e},r=e.document.createElementNS("http://www.w3.org/1999/xhtml","a"),n="download"in r,i=/constructor/i.test(e.HTMLElement)||e.safari,o=/CriOS\/[\d]+/.test(navigator.userAgent),a=e.setImmediate||e.setTimeout,c=function(e){a(function(){throw e},0)},s=function(e){setTimeout(function(){"string"==typeof e?t().revokeObjectURL(e):e.remove()},4e4)},u=function(e){return/^\s*(?:text\/\S*|application\/xml|\S*\/\S*\+xml)\s*;.*charset\s*=\s*utf-8/i.test(e.type)?new Blob([String.fromCharCode(65279),e],{type:e.type}):e},d=function(d,f,l){l||(d=u(d));var v,g=this,p="application/octet-stream"===(d?d.type:void 0),h=function(){!function(e,t,r){for(var n=(t=[].concat(t)).length;n--;){var i=e["on"+t[n]];if("function"==typeof i)try{i.call(e,r||e)}catch(e){c(e)}}}(g,"writestart progress write writeend".split(" "))};if(g.readyState=g.INIT,n)return v||(v=t().createObjectURL(d)),void a(function(){var e,t;r.href=v,r.download=f,e=r,t=new MouseEvent("click"),e.dispatchEvent(t),h(),s(v),g.readyState=g.DONE},0);!function(){if((o||p&&i)&&e.FileReader){var r=new FileReader;return r.onloadend=function(){var t=o?r.result:r.result.replace(/^data:[^;]*;/,"data:attachment/file;");e.open(t,"_blank")||(e.location.href=t),t=void 0,g.readyState=g.DONE,h()},r.readAsDataURL(d),void(g.readyState=g.INIT)}v||(v=t().createObjectURL(d)),p?e.location.href=v:e.open(v,"_blank")||(e.location.href=v);g.readyState=g.DONE,h(),s(v)}()},f=d.prototype;return"undefined"!=typeof navigator&&navigator.msSaveOrOpenBlob?function(e,t,r){return t=t||e.name||"download",r||(e=u(e)),navigator.msSaveOrOpenBlob(e,t)}:(f.abort=function(){},f.readyState=f.INIT=0,f.WRITING=1,f.DONE=2,f.error=f.onwritestart=f.onprogress=f.onwrite=f.onabort=f.onerror=f.onwriteend=null,function(e,t,r){return new d(e,t||e.name||"download",r)})}}("undefined"!=typeof self&&self||"undefined"!=typeof window&&window||this);!function(e){"use strict";var t=e.HTMLCanvasElement&&e.HTMLCanvasElement.prototype,r=e.Blob&&function(){try{return Boolean(new Blob)}catch(e){return!1}}(),n=r&&e.Uint8Array&&function(){try{return 100===new Blob([new Uint8Array(100)]).size}catch(e){return!1}}(),i=e.BlobBuilder||e.WebKitBlobBuilder||e.MozBlobBuilder||e.MSBlobBuilder,o=/^data:((.*?)(;charset=.*?)?)(;base64)?,/,a=(r||i)&&e.atob&&e.ArrayBuffer&&e.Uint8Array&&function(e){var t,a,c,s,u,d,f,l,v;if(!(t=e.match(o)))throw new Error("invalid data URI");for(a=t[2]?t[1]:"text/plain"+(t[3]||";charset=US-ASCII"),c=!!t[4],s=e.slice(t[0].length),u=c?atob(s):decodeURIComponent(s),d=new ArrayBuffer(u.length),f=new Uint8Array(d),l=0;l<u.length;l+=1)f[l]=u.charCodeAt(l);return r?new Blob([n?f:d],{type:a}):((v=new i).append(d),v.getBlob(a))};e.HTMLCanvasElement&&!t.toBlob&&(t.mozGetAsFile?t.toBlob=function(e,r,n){var i=this;setTimeout(function(){n&&t.toDataURL&&a?e(a(i.toDataURL(r,n))):e(i.mozGetAsFile("blob",r))})}:t.toDataURL&&a&&(t.toBlob=function(e,t,r){var n=this;setTimeout(function(){e(a(n.toDataURL(t,r)))})})),"function"==typeof define&&define.amd?define(function(){return a}):"object"==typeof module&&module.exports?module.exports=a:e.dataURLtoBlob=a}(window);
var icn3d=function(e){"use strict";
/**
	 * @license
	 * Copyright 2010-2025 Three.js Authors
	 * SPDX-License-Identifier: MIT
	 */const t="177",i=0,s=1,n=2,r=100,a=101,o=102,l=200,d=201,c=202,h=203,p=204,u=205,m=206,f=207,g=208,b=209,C=210,v=211,_=212,y=213,S=214,w=0,x=1,A=2,M=3,T=4,E=5,R=6,k=7,O=301,I=302,P=306,D=1e3,L=1001,F=1002,N=1003,U=1004,H=1005,B=1006,z=1007,q=1008,j=1009,G=1010,V=1011,W=1012,X=1013,Y=1014,K=1015,Z=1016,J=1017,Q=1018,ee=1020,te=35902,ie=1023,se=1026,ne=1027,re=1029,ae=1031,oe=1033,le=33776,de=33777,ce=33778,he=33779,pe=35840,ue=35841,me=35842,fe=35843,ge=36196,be=37492,Ce=37496,ve=37808,_e=37809,ye=37810,Se=37811,we=37812,xe=37813,Ae=37814,Me=37815,Te=37816,Ee=37817,Re=37818,ke=37819,Oe=37820,Ie=37821,Pe=36492,De=36494,Le=36495,Fe=36284,Ne=36285,Ue=36286,He="",Be="srgb",ze="srgb-linear",qe="linear",je="srgb",Ge=7680,$e=512,Ve=513,We=514,Xe=515,Ye=516,Ke=517,Ze=518,Je=519,Qe=35044,et="300 es",tt=2e3,it=2001;class st{addEventListener(e,t){void 0===this._listeners&&(this._listeners={});const i=this._listeners;void 0===i[e]&&(i[e]=[]),-1===i[e].indexOf(t)&&i[e].push(t)}hasEventListener(e,t){const i=this._listeners;return void 0!==i&&(void 0!==i[e]&&-1!==i[e].indexOf(t))}removeEventListener(e,t){const i=this._listeners;if(void 0===i)return;const s=i[e];if(void 0!==s){const e=s.indexOf(t);-1!==e&&s.splice(e,1)}}dispatchEvent(e){const t=this._listeners;if(void 0===t)return;const i=t[e.type];if(void 0!==i){e.target=this;const t=i.slice(0);for(let i=0,s=t.length;i<s;i++)t[i].call(this,e);e.target=null}}}const nt=["00","01","02","03","04","05","06","07","08","09","0a","0b","0c","0d","0e","0f","10","11","12","13","14","15","16","17","18","19","1a","1b","1c","1d","1e","1f","20","21","22","23","24","25","26","27","28","29","2a","2b","2c","2d","2e","2f","30","31","32","33","34","35","36","37","38","39","3a","3b","3c","3d","3e","3f","40","41","42","43","44","45","46","47","48","49","4a","4b","4c","4d","4e","4f","50","51","52","53","54","55","56","57","58","59","5a","5b","5c","5d","5e","5f","60","61","62","63","64","65","66","67","68","69","6a","6b","6c","6d","6e","6f","70","71","72","73","74","75","76","77","78","79","7a","7b","7c","7d","7e","7f","80","81","82","83","84","85","86","87","88","89","8a","8b","8c","8d","8e","8f","90","91","92","93","94","95","96","97","98","99","9a","9b","9c","9d","9e","9f","a0","a1","a2","a3","a4","a5","a6","a7","a8","a9","aa","ab","ac","ad","ae","af","b0","b1","b2","b3","b4","b5","b6","b7","b8","b9","ba","bb","bc","bd","be","bf","c0","c1","c2","c3","c4","c5","c6","c7","c8","c9","ca","cb","cc","cd","ce","cf","d0","d1","d2","d3","d4","d5","d6","d7","d8","d9","da","db","dc","dd","de","df","e0","e1","e2","e3","e4","e5","e6","e7","e8","e9","ea","eb","ec","ed","ee","ef","f0","f1","f2","f3","f4","f5","f6","f7","f8","f9","fa","fb","fc","fd","fe","ff"],rt=Math.PI/180,at=180/Math.PI;function ot(){const e=4294967295*Math.random()|0,t=4294967295*Math.random()|0,i=4294967295*Math.random()|0,s=4294967295*Math.random()|0;return(nt[255&e]+nt[e>>8&255]+nt[e>>16&255]+nt[e>>24&255]+"-"+nt[255&t]+nt[t>>8&255]+"-"+nt[t>>16&15|64]+nt[t>>24&255]+"-"+nt[63&i|128]+nt[i>>8&255]+"-"+nt[i>>16&255]+nt[i>>24&255]+nt[255&s]+nt[s>>8&255]+nt[s>>16&255]+nt[s>>24&255]).toLowerCase()}function lt(e,t,i){return Math.max(t,Math.min(i,e))}function dt(e,t,i){return(1-i)*e+i*t}function ct(e,t){switch(t.constructor){case Float32Array:return e;case Uint32Array:return e/4294967295;case Uint16Array:return e/65535;case Uint8Array:return e/255;case Int32Array:return Math.max(e/2147483647,-1);case Int16Array:return Math.max(e/32767,-1);case Int8Array:return Math.max(e/127,-1);default:throw new Error("Invalid component type.")}}function ht(e,t){switch(t.constructor){case Float32Array:return e;case Uint32Array:return Math.round(4294967295*e);case Uint16Array:return Math.round(65535*e);case Uint8Array:return Math.round(255*e);case Int32Array:return Math.round(2147483647*e);case Int16Array:return Math.round(32767*e);case Int8Array:return Math.round(127*e);default:throw new Error("Invalid component type.")}}class pt{constructor(e=0,t=0){pt.prototype.isVector2=!0,this.x=e,this.y=t}get width(){return this.x}set width(e){this.x=e}get height(){return this.y}set height(e){this.y=e}set(e,t){return this.x=e,this.y=t,this}setScalar(e){return this.x=e,this.y=e,this}setX(e){return this.x=e,this}setY(e){return this.y=e,this}setComponent(e,t){switch(e){case 0:this.x=t;break;case 1:this.y=t;break;default:throw new Error("index is out of range: "+e)}return this}getComponent(e){switch(e){case 0:return this.x;case 1:return this.y;default:throw new Error("index is out of range: "+e)}}clone(){return new this.constructor(this.x,this.y)}copy(e){return this.x=e.x,this.y=e.y,this}add(e){return this.x+=e.x,this.y+=e.y,this}addScalar(e){return this.x+=e,this.y+=e,this}addVectors(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this}addScaledVector(e,t){return this.x+=e.x*t,this.y+=e.y*t,this}sub(e){return this.x-=e.x,this.y-=e.y,this}subScalar(e){return this.x-=e,this.y-=e,this}subVectors(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this}multiply(e){return this.x*=e.x,this.y*=e.y,this}multiplyScalar(e){return this.x*=e,this.y*=e,this}divide(e){return this.x/=e.x,this.y/=e.y,this}divideScalar(e){return this.multiplyScalar(1/e)}applyMatrix3(e){const t=this.x,i=this.y,s=e.elements;return this.x=s[0]*t+s[3]*i+s[6],this.y=s[1]*t+s[4]*i+s[7],this}min(e){return this.x=Math.min(this.x,e.x),this.y=Math.min(this.y,e.y),this}max(e){return this.x=Math.max(this.x,e.x),this.y=Math.max(this.y,e.y),this}clamp(e,t){return this.x=lt(this.x,e.x,t.x),this.y=lt(this.y,e.y,t.y),this}clampScalar(e,t){return this.x=lt(this.x,e,t),this.y=lt(this.y,e,t),this}clampLength(e,t){const i=this.length();return this.divideScalar(i||1).multiplyScalar(lt(i,e,t))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}roundToZero(){return this.x=Math.trunc(this.x),this.y=Math.trunc(this.y),this}negate(){return this.x=-this.x,this.y=-this.y,this}dot(e){return this.x*e.x+this.y*e.y}cross(e){return this.x*e.y-this.y*e.x}lengthSq(){return this.x*this.x+this.y*this.y}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)}normalize(){return this.divideScalar(this.length()||1)}angle(){return Math.atan2(-this.y,-this.x)+Math.PI}angleTo(e){const t=Math.sqrt(this.lengthSq()*e.lengthSq());if(0===t)return Math.PI/2;const i=this.dot(e)/t;return Math.acos(lt(i,-1,1))}distanceTo(e){return Math.sqrt(this.distanceToSquared(e))}distanceToSquared(e){const t=this.x-e.x,i=this.y-e.y;return t*t+i*i}manhattanDistanceTo(e){return Math.abs(this.x-e.x)+Math.abs(this.y-e.y)}setLength(e){return this.normalize().multiplyScalar(e)}lerp(e,t){return this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t,this}lerpVectors(e,t,i){return this.x=e.x+(t.x-e.x)*i,this.y=e.y+(t.y-e.y)*i,this}equals(e){return e.x===this.x&&e.y===this.y}fromArray(e,t=0){return this.x=e[t],this.y=e[t+1],this}toArray(e=[],t=0){return e[t]=this.x,e[t+1]=this.y,e}fromBufferAttribute(e,t){return this.x=e.getX(t),this.y=e.getY(t),this}rotateAround(e,t){const i=Math.cos(t),s=Math.sin(t),n=this.x-e.x,r=this.y-e.y;return this.x=n*i-r*s+e.x,this.y=n*s+r*i+e.y,this}random(){return this.x=Math.random(),this.y=Math.random(),this}*[Symbol.iterator](){yield this.x,yield this.y}}class ut{constructor(e=0,t=0,i=0,s=1){this.isQuaternion=!0,this._x=e,this._y=t,this._z=i,this._w=s}static slerpFlat(e,t,i,s,n,r,a){let o=i[s+0],l=i[s+1],d=i[s+2],c=i[s+3];const h=n[r+0],p=n[r+1],u=n[r+2],m=n[r+3];if(0===a)return e[t+0]=o,e[t+1]=l,e[t+2]=d,void(e[t+3]=c);if(1===a)return e[t+0]=h,e[t+1]=p,e[t+2]=u,void(e[t+3]=m);if(c!==m||o!==h||l!==p||d!==u){let e=1-a;const t=o*h+l*p+d*u+c*m,i=t>=0?1:-1,s=1-t*t;if(s>Number.EPSILON){const n=Math.sqrt(s),r=Math.atan2(n,t*i);e=Math.sin(e*r)/n,a=Math.sin(a*r)/n}const n=a*i;if(o=o*e+h*n,l=l*e+p*n,d=d*e+u*n,c=c*e+m*n,e===1-a){const e=1/Math.sqrt(o*o+l*l+d*d+c*c);o*=e,l*=e,d*=e,c*=e}}e[t]=o,e[t+1]=l,e[t+2]=d,e[t+3]=c}static multiplyQuaternionsFlat(e,t,i,s,n,r){const a=i[s],o=i[s+1],l=i[s+2],d=i[s+3],c=n[r],h=n[r+1],p=n[r+2],u=n[r+3];return e[t]=a*u+d*c+o*p-l*h,e[t+1]=o*u+d*h+l*c-a*p,e[t+2]=l*u+d*p+a*h-o*c,e[t+3]=d*u-a*c-o*h-l*p,e}get x(){return this._x}set x(e){this._x=e,this._onChangeCallback()}get y(){return this._y}set y(e){this._y=e,this._onChangeCallback()}get z(){return this._z}set z(e){this._z=e,this._onChangeCallback()}get w(){return this._w}set w(e){this._w=e,this._onChangeCallback()}set(e,t,i,s){return this._x=e,this._y=t,this._z=i,this._w=s,this._onChangeCallback(),this}clone(){return new this.constructor(this._x,this._y,this._z,this._w)}copy(e){return this._x=e.x,this._y=e.y,this._z=e.z,this._w=e.w,this._onChangeCallback(),this}setFromEuler(e,t=!0){const i=e._x,s=e._y,n=e._z,r=e._order,a=Math.cos,o=Math.sin,l=a(i/2),d=a(s/2),c=a(n/2),h=o(i/2),p=o(s/2),u=o(n/2);switch(r){case"XYZ":this._x=h*d*c+l*p*u,this._y=l*p*c-h*d*u,this._z=l*d*u+h*p*c,this._w=l*d*c-h*p*u;break;case"YXZ":this._x=h*d*c+l*p*u,this._y=l*p*c-h*d*u,this._z=l*d*u-h*p*c,this._w=l*d*c+h*p*u;break;case"ZXY":this._x=h*d*c-l*p*u,this._y=l*p*c+h*d*u,this._z=l*d*u+h*p*c,this._w=l*d*c-h*p*u;break;case"ZYX":this._x=h*d*c-l*p*u,this._y=l*p*c+h*d*u,this._z=l*d*u-h*p*c,this._w=l*d*c+h*p*u;break;case"YZX":this._x=h*d*c+l*p*u,this._y=l*p*c+h*d*u,this._z=l*d*u-h*p*c,this._w=l*d*c-h*p*u;break;case"XZY":this._x=h*d*c-l*p*u,this._y=l*p*c-h*d*u,this._z=l*d*u+h*p*c,this._w=l*d*c+h*p*u;break;default:console.warn("THREE.Quaternion: .setFromEuler() encountered an unknown order: "+r)}return!0===t&&this._onChangeCallback(),this}setFromAxisAngle(e,t){const i=t/2,s=Math.sin(i);return this._x=e.x*s,this._y=e.y*s,this._z=e.z*s,this._w=Math.cos(i),this._onChangeCallback(),this}setFromRotationMatrix(e){const t=e.elements,i=t[0],s=t[4],n=t[8],r=t[1],a=t[5],o=t[9],l=t[2],d=t[6],c=t[10],h=i+a+c;if(h>0){const e=.5/Math.sqrt(h+1);this._w=.25/e,this._x=(d-o)*e,this._y=(n-l)*e,this._z=(r-s)*e}else if(i>a&&i>c){const e=2*Math.sqrt(1+i-a-c);this._w=(d-o)/e,this._x=.25*e,this._y=(s+r)/e,this._z=(n+l)/e}else if(a>c){const e=2*Math.sqrt(1+a-i-c);this._w=(n-l)/e,this._x=(s+r)/e,this._y=.25*e,this._z=(o+d)/e}else{const e=2*Math.sqrt(1+c-i-a);this._w=(r-s)/e,this._x=(n+l)/e,this._y=(o+d)/e,this._z=.25*e}return this._onChangeCallback(),this}setFromUnitVectors(e,t){let i=e.dot(t)+1;return i<Number.EPSILON?(i=0,Math.abs(e.x)>Math.abs(e.z)?(this._x=-e.y,this._y=e.x,this._z=0,this._w=i):(this._x=0,this._y=-e.z,this._z=e.y,this._w=i)):(this._x=e.y*t.z-e.z*t.y,this._y=e.z*t.x-e.x*t.z,this._z=e.x*t.y-e.y*t.x,this._w=i),this.normalize()}angleTo(e){return 2*Math.acos(Math.abs(lt(this.dot(e),-1,1)))}rotateTowards(e,t){const i=this.angleTo(e);if(0===i)return this;const s=Math.min(1,t/i);return this.slerp(e,s),this}identity(){return this.set(0,0,0,1)}invert(){return this.conjugate()}conjugate(){return this._x*=-1,this._y*=-1,this._z*=-1,this._onChangeCallback(),this}dot(e){return this._x*e._x+this._y*e._y+this._z*e._z+this._w*e._w}lengthSq(){return this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w}length(){return Math.sqrt(this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w)}normalize(){let e=this.length();return 0===e?(this._x=0,this._y=0,this._z=0,this._w=1):(e=1/e,this._x=this._x*e,this._y=this._y*e,this._z=this._z*e,this._w=this._w*e),this._onChangeCallback(),this}multiply(e){return this.multiplyQuaternions(this,e)}premultiply(e){return this.multiplyQuaternions(e,this)}multiplyQuaternions(e,t){const i=e._x,s=e._y,n=e._z,r=e._w,a=t._x,o=t._y,l=t._z,d=t._w;return this._x=i*d+r*a+s*l-n*o,this._y=s*d+r*o+n*a-i*l,this._z=n*d+r*l+i*o-s*a,this._w=r*d-i*a-s*o-n*l,this._onChangeCallback(),this}slerp(e,t){if(0===t)return this;if(1===t)return this.copy(e);const i=this._x,s=this._y,n=this._z,r=this._w;let a=r*e._w+i*e._x+s*e._y+n*e._z;if(a<0?(this._w=-e._w,this._x=-e._x,this._y=-e._y,this._z=-e._z,a=-a):this.copy(e),a>=1)return this._w=r,this._x=i,this._y=s,this._z=n,this;const o=1-a*a;if(o<=Number.EPSILON){const e=1-t;return this._w=e*r+t*this._w,this._x=e*i+t*this._x,this._y=e*s+t*this._y,this._z=e*n+t*this._z,this.normalize(),this}const l=Math.sqrt(o),d=Math.atan2(l,a),c=Math.sin((1-t)*d)/l,h=Math.sin(t*d)/l;return this._w=r*c+this._w*h,this._x=i*c+this._x*h,this._y=s*c+this._y*h,this._z=n*c+this._z*h,this._onChangeCallback(),this}slerpQuaternions(e,t,i){return this.copy(e).slerp(t,i)}random(){const e=2*Math.PI*Math.random(),t=2*Math.PI*Math.random(),i=Math.random(),s=Math.sqrt(1-i),n=Math.sqrt(i);return this.set(s*Math.sin(e),s*Math.cos(e),n*Math.sin(t),n*Math.cos(t))}equals(e){return e._x===this._x&&e._y===this._y&&e._z===this._z&&e._w===this._w}fromArray(e,t=0){return this._x=e[t],this._y=e[t+1],this._z=e[t+2],this._w=e[t+3],this._onChangeCallback(),this}toArray(e=[],t=0){return e[t]=this._x,e[t+1]=this._y,e[t+2]=this._z,e[t+3]=this._w,e}fromBufferAttribute(e,t){return this._x=e.getX(t),this._y=e.getY(t),this._z=e.getZ(t),this._w=e.getW(t),this._onChangeCallback(),this}toJSON(){return this.toArray()}_onChange(e){return this._onChangeCallback=e,this}_onChangeCallback(){}*[Symbol.iterator](){yield this._x,yield this._y,yield this._z,yield this._w}}class mt{constructor(e=0,t=0,i=0){mt.prototype.isVector3=!0,this.x=e,this.y=t,this.z=i}set(e,t,i){return void 0===i&&(i=this.z),this.x=e,this.y=t,this.z=i,this}setScalar(e){return this.x=e,this.y=e,this.z=e,this}setX(e){return this.x=e,this}setY(e){return this.y=e,this}setZ(e){return this.z=e,this}setComponent(e,t){switch(e){case 0:this.x=t;break;case 1:this.y=t;break;case 2:this.z=t;break;default:throw new Error("index is out of range: "+e)}return this}getComponent(e){switch(e){case 0:return this.x;case 1:return this.y;case 2:return this.z;default:throw new Error("index is out of range: "+e)}}clone(){return new this.constructor(this.x,this.y,this.z)}copy(e){return this.x=e.x,this.y=e.y,this.z=e.z,this}add(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this}addScalar(e){return this.x+=e,this.y+=e,this.z+=e,this}addVectors(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this.z=e.z+t.z,this}addScaledVector(e,t){return this.x+=e.x*t,this.y+=e.y*t,this.z+=e.z*t,this}sub(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this}subScalar(e){return this.x-=e,this.y-=e,this.z-=e,this}subVectors(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this.z=e.z-t.z,this}multiply(e){return this.x*=e.x,this.y*=e.y,this.z*=e.z,this}multiplyScalar(e){return this.x*=e,this.y*=e,this.z*=e,this}multiplyVectors(e,t){return this.x=e.x*t.x,this.y=e.y*t.y,this.z=e.z*t.z,this}applyEuler(e){return this.applyQuaternion(gt.setFromEuler(e))}applyAxisAngle(e,t){return this.applyQuaternion(gt.setFromAxisAngle(e,t))}applyMatrix3(e){const t=this.x,i=this.y,s=this.z,n=e.elements;return this.x=n[0]*t+n[3]*i+n[6]*s,this.y=n[1]*t+n[4]*i+n[7]*s,this.z=n[2]*t+n[5]*i+n[8]*s,this}applyNormalMatrix(e){return this.applyMatrix3(e).normalize()}applyMatrix4(e){const t=this.x,i=this.y,s=this.z,n=e.elements,r=1/(n[3]*t+n[7]*i+n[11]*s+n[15]);return this.x=(n[0]*t+n[4]*i+n[8]*s+n[12])*r,this.y=(n[1]*t+n[5]*i+n[9]*s+n[13])*r,this.z=(n[2]*t+n[6]*i+n[10]*s+n[14])*r,this}applyQuaternion(e){const t=this.x,i=this.y,s=this.z,n=e.x,r=e.y,a=e.z,o=e.w,l=2*(r*s-a*i),d=2*(a*t-n*s),c=2*(n*i-r*t);return this.x=t+o*l+r*c-a*d,this.y=i+o*d+a*l-n*c,this.z=s+o*c+n*d-r*l,this}project(e){return this.applyMatrix4(e.matrixWorldInverse).applyMatrix4(e.projectionMatrix)}unproject(e){return this.applyMatrix4(e.projectionMatrixInverse).applyMatrix4(e.matrixWorld)}transformDirection(e){const t=this.x,i=this.y,s=this.z,n=e.elements;return this.x=n[0]*t+n[4]*i+n[8]*s,this.y=n[1]*t+n[5]*i+n[9]*s,this.z=n[2]*t+n[6]*i+n[10]*s,this.normalize()}divide(e){return this.x/=e.x,this.y/=e.y,this.z/=e.z,this}divideScalar(e){return this.multiplyScalar(1/e)}min(e){return this.x=Math.min(this.x,e.x),this.y=Math.min(this.y,e.y),this.z=Math.min(this.z,e.z),this}max(e){return this.x=Math.max(this.x,e.x),this.y=Math.max(this.y,e.y),this.z=Math.max(this.z,e.z),this}clamp(e,t){return this.x=lt(this.x,e.x,t.x),this.y=lt(this.y,e.y,t.y),this.z=lt(this.z,e.z,t.z),this}clampScalar(e,t){return this.x=lt(this.x,e,t),this.y=lt(this.y,e,t),this.z=lt(this.z,e,t),this}clampLength(e,t){const i=this.length();return this.divideScalar(i||1).multiplyScalar(lt(i,e,t))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this}roundToZero(){return this.x=Math.trunc(this.x),this.y=Math.trunc(this.y),this.z=Math.trunc(this.z),this}negate(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this}dot(e){return this.x*e.x+this.y*e.y+this.z*e.z}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)}normalize(){return this.divideScalar(this.length()||1)}setLength(e){return this.normalize().multiplyScalar(e)}lerp(e,t){return this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t,this.z+=(e.z-this.z)*t,this}lerpVectors(e,t,i){return this.x=e.x+(t.x-e.x)*i,this.y=e.y+(t.y-e.y)*i,this.z=e.z+(t.z-e.z)*i,this}cross(e){return this.crossVectors(this,e)}crossVectors(e,t){const i=e.x,s=e.y,n=e.z,r=t.x,a=t.y,o=t.z;return this.x=s*o-n*a,this.y=n*r-i*o,this.z=i*a-s*r,this}projectOnVector(e){const t=e.lengthSq();if(0===t)return this.set(0,0,0);const i=e.dot(this)/t;return this.copy(e).multiplyScalar(i)}projectOnPlane(e){return ft.copy(this).projectOnVector(e),this.sub(ft)}reflect(e){return this.sub(ft.copy(e).multiplyScalar(2*this.dot(e)))}angleTo(e){const t=Math.sqrt(this.lengthSq()*e.lengthSq());if(0===t)return Math.PI/2;const i=this.dot(e)/t;return Math.acos(lt(i,-1,1))}distanceTo(e){return Math.sqrt(this.distanceToSquared(e))}distanceToSquared(e){const t=this.x-e.x,i=this.y-e.y,s=this.z-e.z;return t*t+i*i+s*s}manhattanDistanceTo(e){return Math.abs(this.x-e.x)+Math.abs(this.y-e.y)+Math.abs(this.z-e.z)}setFromSpherical(e){return this.setFromSphericalCoords(e.radius,e.phi,e.theta)}setFromSphericalCoords(e,t,i){const s=Math.sin(t)*e;return this.x=s*Math.sin(i),this.y=Math.cos(t)*e,this.z=s*Math.cos(i),this}setFromCylindrical(e){return this.setFromCylindricalCoords(e.radius,e.theta,e.y)}setFromCylindricalCoords(e,t,i){return this.x=e*Math.sin(t),this.y=i,this.z=e*Math.cos(t),this}setFromMatrixPosition(e){const t=e.elements;return this.x=t[12],this.y=t[13],this.z=t[14],this}setFromMatrixScale(e){const t=this.setFromMatrixColumn(e,0).length(),i=this.setFromMatrixColumn(e,1).length(),s=this.setFromMatrixColumn(e,2).length();return this.x=t,this.y=i,this.z=s,this}setFromMatrixColumn(e,t){return this.fromArray(e.elements,4*t)}setFromMatrix3Column(e,t){return this.fromArray(e.elements,3*t)}setFromEuler(e){return this.x=e._x,this.y=e._y,this.z=e._z,this}setFromColor(e){return this.x=e.r,this.y=e.g,this.z=e.b,this}equals(e){return e.x===this.x&&e.y===this.y&&e.z===this.z}fromArray(e,t=0){return this.x=e[t],this.y=e[t+1],this.z=e[t+2],this}toArray(e=[],t=0){return e[t]=this.x,e[t+1]=this.y,e[t+2]=this.z,e}fromBufferAttribute(e,t){return this.x=e.getX(t),this.y=e.getY(t),this.z=e.getZ(t),this}random(){return this.x=Math.random(),this.y=Math.random(),this.z=Math.random(),this}randomDirection(){const e=Math.random()*Math.PI*2,t=2*Math.random()-1,i=Math.sqrt(1-t*t);return this.x=i*Math.cos(e),this.y=t,this.z=i*Math.sin(e),this}*[Symbol.iterator](){yield this.x,yield this.y,yield this.z}}const ft=new mt,gt=new ut;class bt{constructor(e,t,i,s,n,r,a,o,l){bt.prototype.isMatrix3=!0,this.elements=[1,0,0,0,1,0,0,0,1],void 0!==e&&this.set(e,t,i,s,n,r,a,o,l)}set(e,t,i,s,n,r,a,o,l){const d=this.elements;return d[0]=e,d[1]=s,d[2]=a,d[3]=t,d[4]=n,d[5]=o,d[6]=i,d[7]=r,d[8]=l,this}identity(){return this.set(1,0,0,0,1,0,0,0,1),this}copy(e){const t=this.elements,i=e.elements;return t[0]=i[0],t[1]=i[1],t[2]=i[2],t[3]=i[3],t[4]=i[4],t[5]=i[5],t[6]=i[6],t[7]=i[7],t[8]=i[8],this}extractBasis(e,t,i){return e.setFromMatrix3Column(this,0),t.setFromMatrix3Column(this,1),i.setFromMatrix3Column(this,2),this}setFromMatrix4(e){const t=e.elements;return this.set(t[0],t[4],t[8],t[1],t[5],t[9],t[2],t[6],t[10]),this}multiply(e){return this.multiplyMatrices(this,e)}premultiply(e){return this.multiplyMatrices(e,this)}multiplyMatrices(e,t){const i=e.elements,s=t.elements,n=this.elements,r=i[0],a=i[3],o=i[6],l=i[1],d=i[4],c=i[7],h=i[2],p=i[5],u=i[8],m=s[0],f=s[3],g=s[6],b=s[1],C=s[4],v=s[7],_=s[2],y=s[5],S=s[8];return n[0]=r*m+a*b+o*_,n[3]=r*f+a*C+o*y,n[6]=r*g+a*v+o*S,n[1]=l*m+d*b+c*_,n[4]=l*f+d*C+c*y,n[7]=l*g+d*v+c*S,n[2]=h*m+p*b+u*_,n[5]=h*f+p*C+u*y,n[8]=h*g+p*v+u*S,this}multiplyScalar(e){const t=this.elements;return t[0]*=e,t[3]*=e,t[6]*=e,t[1]*=e,t[4]*=e,t[7]*=e,t[2]*=e,t[5]*=e,t[8]*=e,this}determinant(){const e=this.elements,t=e[0],i=e[1],s=e[2],n=e[3],r=e[4],a=e[5],o=e[6],l=e[7],d=e[8];return t*r*d-t*a*l-i*n*d+i*a*o+s*n*l-s*r*o}invert(){const e=this.elements,t=e[0],i=e[1],s=e[2],n=e[3],r=e[4],a=e[5],o=e[6],l=e[7],d=e[8],c=d*r-a*l,h=a*o-d*n,p=l*n-r*o,u=t*c+i*h+s*p;if(0===u)return this.set(0,0,0,0,0,0,0,0,0);const m=1/u;return e[0]=c*m,e[1]=(s*l-d*i)*m,e[2]=(a*i-s*r)*m,e[3]=h*m,e[4]=(d*t-s*o)*m,e[5]=(s*n-a*t)*m,e[6]=p*m,e[7]=(i*o-l*t)*m,e[8]=(r*t-i*n)*m,this}transpose(){let e;const t=this.elements;return e=t[1],t[1]=t[3],t[3]=e,e=t[2],t[2]=t[6],t[6]=e,e=t[5],t[5]=t[7],t[7]=e,this}getNormalMatrix(e){return this.setFromMatrix4(e).invert().transpose()}transposeIntoArray(e){const t=this.elements;return e[0]=t[0],e[1]=t[3],e[2]=t[6],e[3]=t[1],e[4]=t[4],e[5]=t[7],e[6]=t[2],e[7]=t[5],e[8]=t[8],this}setUvTransform(e,t,i,s,n,r,a){const o=Math.cos(n),l=Math.sin(n);return this.set(i*o,i*l,-i*(o*r+l*a)+r+e,-s*l,s*o,-s*(-l*r+o*a)+a+t,0,0,1),this}scale(e,t){return this.premultiply(Ct.makeScale(e,t)),this}rotate(e){return this.premultiply(Ct.makeRotation(-e)),this}translate(e,t){return this.premultiply(Ct.makeTranslation(e,t)),this}makeTranslation(e,t){return e.isVector2?this.set(1,0,e.x,0,1,e.y,0,0,1):this.set(1,0,e,0,1,t,0,0,1),this}makeRotation(e){const t=Math.cos(e),i=Math.sin(e);return this.set(t,-i,0,i,t,0,0,0,1),this}makeScale(e,t){return this.set(e,0,0,0,t,0,0,0,1),this}equals(e){const t=this.elements,i=e.elements;for(let e=0;e<9;e++)if(t[e]!==i[e])return!1;return!0}fromArray(e,t=0){for(let i=0;i<9;i++)this.elements[i]=e[i+t];return this}toArray(e=[],t=0){const i=this.elements;return e[t]=i[0],e[t+1]=i[1],e[t+2]=i[2],e[t+3]=i[3],e[t+4]=i[4],e[t+5]=i[5],e[t+6]=i[6],e[t+7]=i[7],e[t+8]=i[8],e}clone(){return(new this.constructor).fromArray(this.elements)}}const Ct=new bt;function vt(e){for(let t=e.length-1;t>=0;--t)if(e[t]>=65535)return!0;return!1}function _t(e){return document.createElementNS("http://www.w3.org/1999/xhtml",e)}function yt(){const e=_t("canvas");return e.style.display="block",e}const St={};function wt(e){e in St||(St[e]=!0,console.warn(e))}const xt=(new bt).set(.4123908,.3575843,.1804808,.212639,.7151687,.0721923,.0193308,.1191948,.9505322),At=(new bt).set(3.2409699,-1.5373832,-.4986108,-.9692436,1.8759675,.0415551,.0556301,-.203977,1.0569715);function Mt(){const e={enabled:!0,workingColorSpace:ze,spaces:{},convert:function(e,t,i){return!1!==this.enabled&&t!==i&&t&&i?(this.spaces[t].transfer===je&&(e.r=Et(e.r),e.g=Et(e.g),e.b=Et(e.b)),this.spaces[t].primaries!==this.spaces[i].primaries&&(e.applyMatrix3(this.spaces[t].toXYZ),e.applyMatrix3(this.spaces[i].fromXYZ)),this.spaces[i].transfer===je&&(e.r=Rt(e.r),e.g=Rt(e.g),e.b=Rt(e.b)),e):e},workingToColorSpace:function(e,t){return this.convert(e,this.workingColorSpace,t)},colorSpaceToWorking:function(e,t){return this.convert(e,t,this.workingColorSpace)},getPrimaries:function(e){return this.spaces[e].primaries},getTransfer:function(e){return e===He?qe:this.spaces[e].transfer},getLuminanceCoefficients:function(e,t=this.workingColorSpace){return e.fromArray(this.spaces[t].luminanceCoefficients)},define:function(e){Object.assign(this.spaces,e)},_getMatrix:function(e,t,i){return e.copy(this.spaces[t].toXYZ).multiply(this.spaces[i].fromXYZ)},_getDrawingBufferColorSpace:function(e){return this.spaces[e].outputColorSpaceConfig.drawingBufferColorSpace},_getUnpackColorSpace:function(e=this.workingColorSpace){return this.spaces[e].workingColorSpaceConfig.unpackColorSpace},fromWorkingColorSpace:function(t,i){return wt("THREE.ColorManagement: .fromWorkingColorSpace() has been renamed to .workingToColorSpace()."),e.workingToColorSpace(t,i)},toWorkingColorSpace:function(t,i){return wt("THREE.ColorManagement: .toWorkingColorSpace() has been renamed to .colorSpaceToWorking()."),e.colorSpaceToWorking(t,i)}},t=[.64,.33,.3,.6,.15,.06],i=[.2126,.7152,.0722],s=[.3127,.329];return e.define({[ze]:{primaries:t,whitePoint:s,transfer:qe,toXYZ:xt,fromXYZ:At,luminanceCoefficients:i,workingColorSpaceConfig:{unpackColorSpace:Be},outputColorSpaceConfig:{drawingBufferColorSpace:Be}},[Be]:{primaries:t,whitePoint:s,transfer:je,toXYZ:xt,fromXYZ:At,luminanceCoefficients:i,outputColorSpaceConfig:{drawingBufferColorSpace:Be}}}),e}const Tt=Mt();function Et(e){return e<.04045?.0773993808*e:Math.pow(.9478672986*e+.0521327014,2.4)}function Rt(e){return e<.0031308?12.92*e:1.055*Math.pow(e,.41666)-.055}let kt;class Ot{static getDataURL(e,t="image/png"){if(/^data:/i.test(e.src))return e.src;if("undefined"==typeof HTMLCanvasElement)return e.src;let i;if(e instanceof HTMLCanvasElement)i=e;else{void 0===kt&&(kt=_t("canvas")),kt.width=e.width,kt.height=e.height;const t=kt.getContext("2d");e instanceof ImageData?t.putImageData(e,0,0):t.drawImage(e,0,0,e.width,e.height),i=kt}return i.toDataURL(t)}static sRGBToLinear(e){if("undefined"!=typeof HTMLImageElement&&e instanceof HTMLImageElement||"undefined"!=typeof HTMLCanvasElement&&e instanceof HTMLCanvasElement||"undefined"!=typeof ImageBitmap&&e instanceof ImageBitmap){const t=_t("canvas");t.width=e.width,t.height=e.height;const i=t.getContext("2d");i.drawImage(e,0,0,e.width,e.height);const s=i.getImageData(0,0,e.width,e.height),n=s.data;for(let e=0;e<n.length;e++)n[e]=255*Et(n[e]/255);return i.putImageData(s,0,0),t}if(e.data){const t=e.data.slice(0);for(let e=0;e<t.length;e++)t instanceof Uint8Array||t instanceof Uint8ClampedArray?t[e]=Math.floor(255*Et(t[e]/255)):t[e]=Et(t[e]);return{data:t,width:e.width,height:e.height}}return console.warn("THREE.ImageUtils.sRGBToLinear(): Unsupported image type. No color space conversion applied."),e}}let It=0;class Pt{constructor(e=null){this.isSource=!0,Object.defineProperty(this,"id",{value:It++}),this.uuid=ot(),this.data=e,this.dataReady=!0,this.version=0}getSize(e){const t=this.data;return t instanceof HTMLVideoElement?e.set(t.videoWidth,t.videoHeight):null!==t?e.set(t.width,t.height,t.depth||0):e.set(0,0,0),e}set needsUpdate(e){!0===e&&this.version++}toJSON(e){const t=void 0===e||"string"==typeof e;if(!t&&void 0!==e.images[this.uuid])return e.images[this.uuid];const i={uuid:this.uuid,url:""},s=this.data;if(null!==s){let e;if(Array.isArray(s)){e=[];for(let t=0,i=s.length;t<i;t++)s[t].isDataTexture?e.push(Dt(s[t].image)):e.push(Dt(s[t]))}else e=Dt(s);i.url=e}return t||(e.images[this.uuid]=i),i}}function Dt(e){return"undefined"!=typeof HTMLImageElement&&e instanceof HTMLImageElement||"undefined"!=typeof HTMLCanvasElement&&e instanceof HTMLCanvasElement||"undefined"!=typeof ImageBitmap&&e instanceof ImageBitmap?Ot.getDataURL(e):e.data?{data:Array.from(e.data),width:e.width,height:e.height,type:e.data.constructor.name}:(console.warn("THREE.Texture: Unable to serialize Texture."),{})}let Lt=0;const Ft=new mt;class Nt extends st{constructor(e=Nt.DEFAULT_IMAGE,t=Nt.DEFAULT_MAPPING,i=1001,s=1001,n=1006,r=1008,a=1023,o=1009,l=Nt.DEFAULT_ANISOTROPY,d=""){super(),this.isTexture=!0,Object.defineProperty(this,"id",{value:Lt++}),this.uuid=ot(),this.name="",this.source=new Pt(e),this.mipmaps=[],this.mapping=t,this.channel=0,this.wrapS=i,this.wrapT=s,this.magFilter=n,this.minFilter=r,this.anisotropy=l,this.format=a,this.internalFormat=null,this.type=o,this.offset=new pt(0,0),this.repeat=new pt(1,1),this.center=new pt(0,0),this.rotation=0,this.matrixAutoUpdate=!0,this.matrix=new bt,this.generateMipmaps=!0,this.premultiplyAlpha=!1,this.flipY=!0,this.unpackAlignment=4,this.colorSpace=d,this.userData={},this.updateRanges=[],this.version=0,this.onUpdate=null,this.renderTarget=null,this.isRenderTargetTexture=!1,this.isArrayTexture=!!(e&&e.depth&&e.depth>1),this.pmremVersion=0}get width(){return this.source.getSize(Ft).x}get height(){return this.source.getSize(Ft).y}get depth(){return this.source.getSize(Ft).z}get image(){return this.source.data}set image(e=null){this.source.data=e}updateMatrix(){this.matrix.setUvTransform(this.offset.x,this.offset.y,this.repeat.x,this.repeat.y,this.rotation,this.center.x,this.center.y)}addUpdateRange(e,t){this.updateRanges.push({start:e,count:t})}clearUpdateRanges(){this.updateRanges.length=0}clone(){return(new this.constructor).copy(this)}copy(e){return this.name=e.name,this.source=e.source,this.mipmaps=e.mipmaps.slice(0),this.mapping=e.mapping,this.channel=e.channel,this.wrapS=e.wrapS,this.wrapT=e.wrapT,this.magFilter=e.magFilter,this.minFilter=e.minFilter,this.anisotropy=e.anisotropy,this.format=e.format,this.internalFormat=e.internalFormat,this.type=e.type,this.offset.copy(e.offset),this.repeat.copy(e.repeat),this.center.copy(e.center),this.rotation=e.rotation,this.matrixAutoUpdate=e.matrixAutoUpdate,this.matrix.copy(e.matrix),this.generateMipmaps=e.generateMipmaps,this.premultiplyAlpha=e.premultiplyAlpha,this.flipY=e.flipY,this.unpackAlignment=e.unpackAlignment,this.colorSpace=e.colorSpace,this.renderTarget=e.renderTarget,this.isRenderTargetTexture=e.isRenderTargetTexture,this.isArrayTexture=e.isArrayTexture,this.userData=JSON.parse(JSON.stringify(e.userData)),this.needsUpdate=!0,this}setValues(e){for(const t in e){const i=e[t];if(void 0===i){console.warn(`THREE.Texture.setValues(): parameter '${t}' has value of undefined.`);continue}const s=this[t];void 0!==s?s&&i&&s.isVector2&&i.isVector2||s&&i&&s.isVector3&&i.isVector3||s&&i&&s.isMatrix3&&i.isMatrix3?s.copy(i):this[t]=i:console.warn(`THREE.Texture.setValues(): property '${t}' does not exist.`)}}toJSON(e){const t=void 0===e||"string"==typeof e;if(!t&&void 0!==e.textures[this.uuid])return e.textures[this.uuid];const i={metadata:{version:4.7,type:"Texture",generator:"Texture.toJSON"},uuid:this.uuid,name:this.name,image:this.source.toJSON(e).uuid,mapping:this.mapping,channel:this.channel,repeat:[this.repeat.x,this.repeat.y],offset:[this.offset.x,this.offset.y],center:[this.center.x,this.center.y],rotation:this.rotation,wrap:[this.wrapS,this.wrapT],format:this.format,internalFormat:this.internalFormat,type:this.type,colorSpace:this.colorSpace,minFilter:this.minFilter,magFilter:this.magFilter,anisotropy:this.anisotropy,flipY:this.flipY,generateMipmaps:this.generateMipmaps,premultiplyAlpha:this.premultiplyAlpha,unpackAlignment:this.unpackAlignment};return Object.keys(this.userData).length>0&&(i.userData=this.userData),t||(e.textures[this.uuid]=i),i}dispose(){this.dispatchEvent({type:"dispose"})}transformUv(e){if(300!==this.mapping)return e;if(e.applyMatrix3(this.matrix),e.x<0||e.x>1)switch(this.wrapS){case D:e.x=e.x-Math.floor(e.x);break;case L:e.x=e.x<0?0:1;break;case F:1===Math.abs(Math.floor(e.x)%2)?e.x=Math.ceil(e.x)-e.x:e.x=e.x-Math.floor(e.x)}if(e.y<0||e.y>1)switch(this.wrapT){case D:e.y=e.y-Math.floor(e.y);break;case L:e.y=e.y<0?0:1;break;case F:1===Math.abs(Math.floor(e.y)%2)?e.y=Math.ceil(e.y)-e.y:e.y=e.y-Math.floor(e.y)}return this.flipY&&(e.y=1-e.y),e}set needsUpdate(e){!0===e&&(this.version++,this.source.needsUpdate=!0)}set needsPMREMUpdate(e){!0===e&&this.pmremVersion++}}Nt.DEFAULT_IMAGE=null,Nt.DEFAULT_MAPPING=300,Nt.DEFAULT_ANISOTROPY=1;class Ut{constructor(e=0,t=0,i=0,s=1){Ut.prototype.isVector4=!0,this.x=e,this.y=t,this.z=i,this.w=s}get width(){return this.z}set width(e){this.z=e}get height(){return this.w}set height(e){this.w=e}set(e,t,i,s){return this.x=e,this.y=t,this.z=i,this.w=s,this}setScalar(e){return this.x=e,this.y=e,this.z=e,this.w=e,this}setX(e){return this.x=e,this}setY(e){return this.y=e,this}setZ(e){return this.z=e,this}setW(e){return this.w=e,this}setComponent(e,t){switch(e){case 0:this.x=t;break;case 1:this.y=t;break;case 2:this.z=t;break;case 3:this.w=t;break;default:throw new Error("index is out of range: "+e)}return this}getComponent(e){switch(e){case 0:return this.x;case 1:return this.y;case 2:return this.z;case 3:return this.w;default:throw new Error("index is out of range: "+e)}}clone(){return new this.constructor(this.x,this.y,this.z,this.w)}copy(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=void 0!==e.w?e.w:1,this}add(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this.w+=e.w,this}addScalar(e){return this.x+=e,this.y+=e,this.z+=e,this.w+=e,this}addVectors(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this.z=e.z+t.z,this.w=e.w+t.w,this}addScaledVector(e,t){return this.x+=e.x*t,this.y+=e.y*t,this.z+=e.z*t,this.w+=e.w*t,this}sub(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this.w-=e.w,this}subScalar(e){return this.x-=e,this.y-=e,this.z-=e,this.w-=e,this}subVectors(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this.z=e.z-t.z,this.w=e.w-t.w,this}multiply(e){return this.x*=e.x,this.y*=e.y,this.z*=e.z,this.w*=e.w,this}multiplyScalar(e){return this.x*=e,this.y*=e,this.z*=e,this.w*=e,this}applyMatrix4(e){const t=this.x,i=this.y,s=this.z,n=this.w,r=e.elements;return this.x=r[0]*t+r[4]*i+r[8]*s+r[12]*n,this.y=r[1]*t+r[5]*i+r[9]*s+r[13]*n,this.z=r[2]*t+r[6]*i+r[10]*s+r[14]*n,this.w=r[3]*t+r[7]*i+r[11]*s+r[15]*n,this}divide(e){return this.x/=e.x,this.y/=e.y,this.z/=e.z,this.w/=e.w,this}divideScalar(e){return this.multiplyScalar(1/e)}setAxisAngleFromQuaternion(e){this.w=2*Math.acos(e.w);const t=Math.sqrt(1-e.w*e.w);return t<1e-4?(this.x=1,this.y=0,this.z=0):(this.x=e.x/t,this.y=e.y/t,this.z=e.z/t),this}setAxisAngleFromRotationMatrix(e){let t,i,s,n;const r=.01,a=.1,o=e.elements,l=o[0],d=o[4],c=o[8],h=o[1],p=o[5],u=o[9],m=o[2],f=o[6],g=o[10];if(Math.abs(d-h)<r&&Math.abs(c-m)<r&&Math.abs(u-f)<r){if(Math.abs(d+h)<a&&Math.abs(c+m)<a&&Math.abs(u+f)<a&&Math.abs(l+p+g-3)<a)return this.set(1,0,0,0),this;t=Math.PI;const e=(l+1)/2,o=(p+1)/2,b=(g+1)/2,C=(d+h)/4,v=(c+m)/4,_=(u+f)/4;return e>o&&e>b?e<r?(i=0,s=.707106781,n=.707106781):(i=Math.sqrt(e),s=C/i,n=v/i):o>b?o<r?(i=.707106781,s=0,n=.707106781):(s=Math.sqrt(o),i=C/s,n=_/s):b<r?(i=.707106781,s=.707106781,n=0):(n=Math.sqrt(b),i=v/n,s=_/n),this.set(i,s,n,t),this}let b=Math.sqrt((f-u)*(f-u)+(c-m)*(c-m)+(h-d)*(h-d));return Math.abs(b)<.001&&(b=1),this.x=(f-u)/b,this.y=(c-m)/b,this.z=(h-d)/b,this.w=Math.acos((l+p+g-1)/2),this}setFromMatrixPosition(e){const t=e.elements;return this.x=t[12],this.y=t[13],this.z=t[14],this.w=t[15],this}min(e){return this.x=Math.min(this.x,e.x),this.y=Math.min(this.y,e.y),this.z=Math.min(this.z,e.z),this.w=Math.min(this.w,e.w),this}max(e){return this.x=Math.max(this.x,e.x),this.y=Math.max(this.y,e.y),this.z=Math.max(this.z,e.z),this.w=Math.max(this.w,e.w),this}clamp(e,t){return this.x=lt(this.x,e.x,t.x),this.y=lt(this.y,e.y,t.y),this.z=lt(this.z,e.z,t.z),this.w=lt(this.w,e.w,t.w),this}clampScalar(e,t){return this.x=lt(this.x,e,t),this.y=lt(this.y,e,t),this.z=lt(this.z,e,t),this.w=lt(this.w,e,t),this}clampLength(e,t){const i=this.length();return this.divideScalar(i||1).multiplyScalar(lt(i,e,t))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this.w=Math.floor(this.w),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this.w=Math.ceil(this.w),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this.w=Math.round(this.w),this}roundToZero(){return this.x=Math.trunc(this.x),this.y=Math.trunc(this.y),this.z=Math.trunc(this.z),this.w=Math.trunc(this.w),this}negate(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this.w=-this.w,this}dot(e){return this.x*e.x+this.y*e.y+this.z*e.z+this.w*e.w}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)+Math.abs(this.w)}normalize(){return this.divideScalar(this.length()||1)}setLength(e){return this.normalize().multiplyScalar(e)}lerp(e,t){return this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t,this.z+=(e.z-this.z)*t,this.w+=(e.w-this.w)*t,this}lerpVectors(e,t,i){return this.x=e.x+(t.x-e.x)*i,this.y=e.y+(t.y-e.y)*i,this.z=e.z+(t.z-e.z)*i,this.w=e.w+(t.w-e.w)*i,this}equals(e){return e.x===this.x&&e.y===this.y&&e.z===this.z&&e.w===this.w}fromArray(e,t=0){return this.x=e[t],this.y=e[t+1],this.z=e[t+2],this.w=e[t+3],this}toArray(e=[],t=0){return e[t]=this.x,e[t+1]=this.y,e[t+2]=this.z,e[t+3]=this.w,e}fromBufferAttribute(e,t){return this.x=e.getX(t),this.y=e.getY(t),this.z=e.getZ(t),this.w=e.getW(t),this}random(){return this.x=Math.random(),this.y=Math.random(),this.z=Math.random(),this.w=Math.random(),this}*[Symbol.iterator](){yield this.x,yield this.y,yield this.z,yield this.w}}class Ht extends st{constructor(e=1,t=1,i={}){super(),i=Object.assign({generateMipmaps:!1,internalFormat:null,minFilter:B,depthBuffer:!0,stencilBuffer:!1,resolveDepthBuffer:!0,resolveStencilBuffer:!0,depthTexture:null,samples:0,count:1,depth:1,multiview:!1},i),this.isRenderTarget=!0,this.width=e,this.height=t,this.depth=i.depth,this.scissor=new Ut(0,0,e,t),this.scissorTest=!1,this.viewport=new Ut(0,0,e,t);const s={width:e,height:t,depth:i.depth},n=new Nt(s);this.textures=[];const r=i.count;for(let e=0;e<r;e++)this.textures[e]=n.clone(),this.textures[e].isRenderTargetTexture=!0,this.textures[e].renderTarget=this;this._setTextureOptions(i),this.depthBuffer=i.depthBuffer,this.stencilBuffer=i.stencilBuffer,this.resolveDepthBuffer=i.resolveDepthBuffer,this.resolveStencilBuffer=i.resolveStencilBuffer,this._depthTexture=null,this.depthTexture=i.depthTexture,this.samples=i.samples,this.multiview=i.multiview}_setTextureOptions(e={}){const t={minFilter:B,generateMipmaps:!1,flipY:!1,internalFormat:null};void 0!==e.mapping&&(t.mapping=e.mapping),void 0!==e.wrapS&&(t.wrapS=e.wrapS),void 0!==e.wrapT&&(t.wrapT=e.wrapT),void 0!==e.wrapR&&(t.wrapR=e.wrapR),void 0!==e.magFilter&&(t.magFilter=e.magFilter),void 0!==e.minFilter&&(t.minFilter=e.minFilter),void 0!==e.format&&(t.format=e.format),void 0!==e.type&&(t.type=e.type),void 0!==e.anisotropy&&(t.anisotropy=e.anisotropy),void 0!==e.colorSpace&&(t.colorSpace=e.colorSpace),void 0!==e.flipY&&(t.flipY=e.flipY),void 0!==e.generateMipmaps&&(t.generateMipmaps=e.generateMipmaps),void 0!==e.internalFormat&&(t.internalFormat=e.internalFormat);for(let e=0;e<this.textures.length;e++){this.textures[e].setValues(t)}}get texture(){return this.textures[0]}set texture(e){this.textures[0]=e}set depthTexture(e){null!==this._depthTexture&&(this._depthTexture.renderTarget=null),null!==e&&(e.renderTarget=this),this._depthTexture=e}get depthTexture(){return this._depthTexture}setSize(e,t,i=1){if(this.width!==e||this.height!==t||this.depth!==i){this.width=e,this.height=t,this.depth=i;for(let s=0,n=this.textures.length;s<n;s++)this.textures[s].image.width=e,this.textures[s].image.height=t,this.textures[s].image.depth=i,this.textures[s].isArrayTexture=this.textures[s].image.depth>1;this.dispose()}this.viewport.set(0,0,e,t),this.scissor.set(0,0,e,t)}clone(){return(new this.constructor).copy(this)}copy(e){this.width=e.width,this.height=e.height,this.depth=e.depth,this.scissor.copy(e.scissor),this.scissorTest=e.scissorTest,this.viewport.copy(e.viewport),this.textures.length=0;for(let t=0,i=e.textures.length;t<i;t++){this.textures[t]=e.textures[t].clone(),this.textures[t].isRenderTargetTexture=!0,this.textures[t].renderTarget=this;const i=Object.assign({},e.textures[t].image);this.textures[t].source=new Pt(i)}return this.depthBuffer=e.depthBuffer,this.stencilBuffer=e.stencilBuffer,this.resolveDepthBuffer=e.resolveDepthBuffer,this.resolveStencilBuffer=e.resolveStencilBuffer,null!==e.depthTexture&&(this.depthTexture=e.depthTexture.clone()),this.samples=e.samples,this}dispose(){this.dispatchEvent({type:"dispose"})}}class Bt extends Ht{constructor(e=1,t=1,i={}){super(e,t,i),this.isWebGLRenderTarget=!0}}class zt extends Nt{constructor(e=null,t=1,i=1,s=1){super(null),this.isDataArrayTexture=!0,this.image={data:e,width:t,height:i,depth:s},this.magFilter=N,this.minFilter=N,this.wrapR=L,this.generateMipmaps=!1,this.flipY=!1,this.unpackAlignment=1,this.layerUpdates=new Set}addLayerUpdate(e){this.layerUpdates.add(e)}clearLayerUpdates(){this.layerUpdates.clear()}}class qt extends Nt{constructor(e=null,t=1,i=1,s=1){super(null),this.isData3DTexture=!0,this.image={data:e,width:t,height:i,depth:s},this.magFilter=N,this.minFilter=N,this.wrapR=L,this.generateMipmaps=!1,this.flipY=!1,this.unpackAlignment=1}}class jt{constructor(e=new mt(1/0,1/0,1/0),t=new mt(-1/0,-1/0,-1/0)){this.isBox3=!0,this.min=e,this.max=t}set(e,t){return this.min.copy(e),this.max.copy(t),this}setFromArray(e){this.makeEmpty();for(let t=0,i=e.length;t<i;t+=3)this.expandByPoint($t.fromArray(e,t));return this}setFromBufferAttribute(e){this.makeEmpty();for(let t=0,i=e.count;t<i;t++)this.expandByPoint($t.fromBufferAttribute(e,t));return this}setFromPoints(e){this.makeEmpty();for(let t=0,i=e.length;t<i;t++)this.expandByPoint(e[t]);return this}setFromCenterAndSize(e,t){const i=$t.copy(t).multiplyScalar(.5);return this.min.copy(e).sub(i),this.max.copy(e).add(i),this}setFromObject(e,t=!1){return this.makeEmpty(),this.expandByObject(e,t)}clone(){return(new this.constructor).copy(this)}copy(e){return this.min.copy(e.min),this.max.copy(e.max),this}makeEmpty(){return this.min.x=this.min.y=this.min.z=1/0,this.max.x=this.max.y=this.max.z=-1/0,this}isEmpty(){return this.max.x<this.min.x||this.max.y<this.min.y||this.max.z<this.min.z}getCenter(e){return this.isEmpty()?e.set(0,0,0):e.addVectors(this.min,this.max).multiplyScalar(.5)}getSize(e){return this.isEmpty()?e.set(0,0,0):e.subVectors(this.max,this.min)}expandByPoint(e){return this.min.min(e),this.max.max(e),this}expandByVector(e){return this.min.sub(e),this.max.add(e),this}expandByScalar(e){return this.min.addScalar(-e),this.max.addScalar(e),this}expandByObject(e,t=!1){e.updateWorldMatrix(!1,!1);const i=e.geometry;if(void 0!==i){const s=i.getAttribute("position");if(!0===t&&void 0!==s&&!0!==e.isInstancedMesh)for(let t=0,i=s.count;t<i;t++)!0===e.isMesh?e.getVertexPosition(t,$t):$t.fromBufferAttribute(s,t),$t.applyMatrix4(e.matrixWorld),this.expandByPoint($t);else void 0!==e.boundingBox?(null===e.boundingBox&&e.computeBoundingBox(),Vt.copy(e.boundingBox)):(null===i.boundingBox&&i.computeBoundingBox(),Vt.copy(i.boundingBox)),Vt.applyMatrix4(e.matrixWorld),this.union(Vt)}const s=e.children;for(let e=0,i=s.length;e<i;e++)this.expandByObject(s[e],t);return this}containsPoint(e){return e.x>=this.min.x&&e.x<=this.max.x&&e.y>=this.min.y&&e.y<=this.max.y&&e.z>=this.min.z&&e.z<=this.max.z}containsBox(e){return this.min.x<=e.min.x&&e.max.x<=this.max.x&&this.min.y<=e.min.y&&e.max.y<=this.max.y&&this.min.z<=e.min.z&&e.max.z<=this.max.z}getParameter(e,t){return t.set((e.x-this.min.x)/(this.max.x-this.min.x),(e.y-this.min.y)/(this.max.y-this.min.y),(e.z-this.min.z)/(this.max.z-this.min.z))}intersectsBox(e){return e.max.x>=this.min.x&&e.min.x<=this.max.x&&e.max.y>=this.min.y&&e.min.y<=this.max.y&&e.max.z>=this.min.z&&e.min.z<=this.max.z}intersectsSphere(e){return this.clampPoint(e.center,$t),$t.distanceToSquared(e.center)<=e.radius*e.radius}intersectsPlane(e){let t,i;return e.normal.x>0?(t=e.normal.x*this.min.x,i=e.normal.x*this.max.x):(t=e.normal.x*this.max.x,i=e.normal.x*this.min.x),e.normal.y>0?(t+=e.normal.y*this.min.y,i+=e.normal.y*this.max.y):(t+=e.normal.y*this.max.y,i+=e.normal.y*this.min.y),e.normal.z>0?(t+=e.normal.z*this.min.z,i+=e.normal.z*this.max.z):(t+=e.normal.z*this.max.z,i+=e.normal.z*this.min.z),t<=-e.constant&&i>=-e.constant}intersectsTriangle(e){if(this.isEmpty())return!1;this.getCenter(Qt),ei.subVectors(this.max,Qt),Wt.subVectors(e.a,Qt),Xt.subVectors(e.b,Qt),Yt.subVectors(e.c,Qt),Kt.subVectors(Xt,Wt),Zt.subVectors(Yt,Xt),Jt.subVectors(Wt,Yt);let t=[0,-Kt.z,Kt.y,0,-Zt.z,Zt.y,0,-Jt.z,Jt.y,Kt.z,0,-Kt.x,Zt.z,0,-Zt.x,Jt.z,0,-Jt.x,-Kt.y,Kt.x,0,-Zt.y,Zt.x,0,-Jt.y,Jt.x,0];return!!si(t,Wt,Xt,Yt,ei)&&(t=[1,0,0,0,1,0,0,0,1],!!si(t,Wt,Xt,Yt,ei)&&(ti.crossVectors(Kt,Zt),t=[ti.x,ti.y,ti.z],si(t,Wt,Xt,Yt,ei)))}clampPoint(e,t){return t.copy(e).clamp(this.min,this.max)}distanceToPoint(e){return this.clampPoint(e,$t).distanceTo(e)}getBoundingSphere(e){return this.isEmpty()?e.makeEmpty():(this.getCenter(e.center),e.radius=.5*this.getSize($t).length()),e}intersect(e){return this.min.max(e.min),this.max.min(e.max),this.isEmpty()&&this.makeEmpty(),this}union(e){return this.min.min(e.min),this.max.max(e.max),this}applyMatrix4(e){return this.isEmpty()||(Gt[0].set(this.min.x,this.min.y,this.min.z).applyMatrix4(e),Gt[1].set(this.min.x,this.min.y,this.max.z).applyMatrix4(e),Gt[2].set(this.min.x,this.max.y,this.min.z).applyMatrix4(e),Gt[3].set(this.min.x,this.max.y,this.max.z).applyMatrix4(e),Gt[4].set(this.max.x,this.min.y,this.min.z).applyMatrix4(e),Gt[5].set(this.max.x,this.min.y,this.max.z).applyMatrix4(e),Gt[6].set(this.max.x,this.max.y,this.min.z).applyMatrix4(e),Gt[7].set(this.max.x,this.max.y,this.max.z).applyMatrix4(e),this.setFromPoints(Gt)),this}translate(e){return this.min.add(e),this.max.add(e),this}equals(e){return e.min.equals(this.min)&&e.max.equals(this.max)}toJSON(){return{min:this.min.toArray(),max:this.max.toArray()}}fromJSON(e){return this.min.fromArray(e.min),this.max.fromArray(e.max),this}}const Gt=[new mt,new mt,new mt,new mt,new mt,new mt,new mt,new mt],$t=new mt,Vt=new jt,Wt=new mt,Xt=new mt,Yt=new mt,Kt=new mt,Zt=new mt,Jt=new mt,Qt=new mt,ei=new mt,ti=new mt,ii=new mt;function si(e,t,i,s,n){for(let r=0,a=e.length-3;r<=a;r+=3){ii.fromArray(e,r);const a=n.x*Math.abs(ii.x)+n.y*Math.abs(ii.y)+n.z*Math.abs(ii.z),o=t.dot(ii),l=i.dot(ii),d=s.dot(ii);if(Math.max(-Math.max(o,l,d),Math.min(o,l,d))>a)return!1}return!0}const ni=new jt,ri=new mt,ai=new mt;class oi{constructor(e=new mt,t=-1){this.isSphere=!0,this.center=e,this.radius=t}set(e,t){return this.center.copy(e),this.radius=t,this}setFromPoints(e,t){const i=this.center;void 0!==t?i.copy(t):ni.setFromPoints(e).getCenter(i);let s=0;for(let t=0,n=e.length;t<n;t++)s=Math.max(s,i.distanceToSquared(e[t]));return this.radius=Math.sqrt(s),this}copy(e){return this.center.copy(e.center),this.radius=e.radius,this}isEmpty(){return this.radius<0}makeEmpty(){return this.center.set(0,0,0),this.radius=-1,this}containsPoint(e){return e.distanceToSquared(this.center)<=this.radius*this.radius}distanceToPoint(e){return e.distanceTo(this.center)-this.radius}intersectsSphere(e){const t=this.radius+e.radius;return e.center.distanceToSquared(this.center)<=t*t}intersectsBox(e){return e.intersectsSphere(this)}intersectsPlane(e){return Math.abs(e.distanceToPoint(this.center))<=this.radius}clampPoint(e,t){const i=this.center.distanceToSquared(e);return t.copy(e),i>this.radius*this.radius&&(t.sub(this.center).normalize(),t.multiplyScalar(this.radius).add(this.center)),t}getBoundingBox(e){return this.isEmpty()?(e.makeEmpty(),e):(e.set(this.center,this.center),e.expandByScalar(this.radius),e)}applyMatrix4(e){return this.center.applyMatrix4(e),this.radius=this.radius*e.getMaxScaleOnAxis(),this}translate(e){return this.center.add(e),this}expandByPoint(e){if(this.isEmpty())return this.center.copy(e),this.radius=0,this;ri.subVectors(e,this.center);const t=ri.lengthSq();if(t>this.radius*this.radius){const e=Math.sqrt(t),i=.5*(e-this.radius);this.center.addScaledVector(ri,i/e),this.radius+=i}return this}union(e){return e.isEmpty()?this:this.isEmpty()?(this.copy(e),this):(!0===this.center.equals(e.center)?this.radius=Math.max(this.radius,e.radius):(ai.subVectors(e.center,this.center).setLength(e.radius),this.expandByPoint(ri.copy(e.center).add(ai)),this.expandByPoint(ri.copy(e.center).sub(ai))),this)}equals(e){return e.center.equals(this.center)&&e.radius===this.radius}clone(){return(new this.constructor).copy(this)}toJSON(){return{radius:this.radius,center:this.center.toArray()}}fromJSON(e){return this.radius=e.radius,this.center.fromArray(e.center),this}}const li=new mt,di=new mt,ci=new mt,hi=new mt,pi=new mt,ui=new mt,mi=new mt;class fi{constructor(e=new mt,t=new mt(0,0,-1)){this.origin=e,this.direction=t}set(e,t){return this.origin.copy(e),this.direction.copy(t),this}copy(e){return this.origin.copy(e.origin),this.direction.copy(e.direction),this}at(e,t){return t.copy(this.origin).addScaledVector(this.direction,e)}lookAt(e){return this.direction.copy(e).sub(this.origin).normalize(),this}recast(e){return this.origin.copy(this.at(e,li)),this}closestPointToPoint(e,t){t.subVectors(e,this.origin);const i=t.dot(this.direction);return i<0?t.copy(this.origin):t.copy(this.origin).addScaledVector(this.direction,i)}distanceToPoint(e){return Math.sqrt(this.distanceSqToPoint(e))}distanceSqToPoint(e){const t=li.subVectors(e,this.origin).dot(this.direction);return t<0?this.origin.distanceToSquared(e):(li.copy(this.origin).addScaledVector(this.direction,t),li.distanceToSquared(e))}distanceSqToSegment(e,t,i,s){di.copy(e).add(t).multiplyScalar(.5),ci.copy(t).sub(e).normalize(),hi.copy(this.origin).sub(di);const n=.5*e.distanceTo(t),r=-this.direction.dot(ci),a=hi.dot(this.direction),o=-hi.dot(ci),l=hi.lengthSq(),d=Math.abs(1-r*r);let c,h,p,u;if(d>0)if(c=r*o-a,h=r*a-o,u=n*d,c>=0)if(h>=-u)if(h<=u){const e=1/d;c*=e,h*=e,p=c*(c+r*h+2*a)+h*(r*c+h+2*o)+l}else h=n,c=Math.max(0,-(r*h+a)),p=-c*c+h*(h+2*o)+l;else h=-n,c=Math.max(0,-(r*h+a)),p=-c*c+h*(h+2*o)+l;else h<=-u?(c=Math.max(0,-(-r*n+a)),h=c>0?-n:Math.min(Math.max(-n,-o),n),p=-c*c+h*(h+2*o)+l):h<=u?(c=0,h=Math.min(Math.max(-n,-o),n),p=h*(h+2*o)+l):(c=Math.max(0,-(r*n+a)),h=c>0?n:Math.min(Math.max(-n,-o),n),p=-c*c+h*(h+2*o)+l);else h=r>0?-n:n,c=Math.max(0,-(r*h+a)),p=-c*c+h*(h+2*o)+l;return i&&i.copy(this.origin).addScaledVector(this.direction,c),s&&s.copy(di).addScaledVector(ci,h),p}intersectSphere(e,t){li.subVectors(e.center,this.origin);const i=li.dot(this.direction),s=li.dot(li)-i*i,n=e.radius*e.radius;if(s>n)return null;const r=Math.sqrt(n-s),a=i-r,o=i+r;return o<0?null:a<0?this.at(o,t):this.at(a,t)}intersectsSphere(e){return!(e.radius<0)&&this.distanceSqToPoint(e.center)<=e.radius*e.radius}distanceToPlane(e){const t=e.normal.dot(this.direction);if(0===t)return 0===e.distanceToPoint(this.origin)?0:null;const i=-(this.origin.dot(e.normal)+e.constant)/t;return i>=0?i:null}intersectPlane(e,t){const i=this.distanceToPlane(e);return null===i?null:this.at(i,t)}intersectsPlane(e){const t=e.distanceToPoint(this.origin);if(0===t)return!0;return e.normal.dot(this.direction)*t<0}intersectBox(e,t){let i,s,n,r,a,o;const l=1/this.direction.x,d=1/this.direction.y,c=1/this.direction.z,h=this.origin;return l>=0?(i=(e.min.x-h.x)*l,s=(e.max.x-h.x)*l):(i=(e.max.x-h.x)*l,s=(e.min.x-h.x)*l),d>=0?(n=(e.min.y-h.y)*d,r=(e.max.y-h.y)*d):(n=(e.max.y-h.y)*d,r=(e.min.y-h.y)*d),i>r||n>s?null:((n>i||isNaN(i))&&(i=n),(r<s||isNaN(s))&&(s=r),c>=0?(a=(e.min.z-h.z)*c,o=(e.max.z-h.z)*c):(a=(e.max.z-h.z)*c,o=(e.min.z-h.z)*c),i>o||a>s?null:((a>i||i!=i)&&(i=a),(o<s||s!=s)&&(s=o),s<0?null:this.at(i>=0?i:s,t)))}intersectsBox(e){return null!==this.intersectBox(e,li)}intersectTriangle(e,t,i,s,n){pi.subVectors(t,e),ui.subVectors(i,e),mi.crossVectors(pi,ui);let r,a=this.direction.dot(mi);if(a>0){if(s)return null;r=1}else{if(!(a<0))return null;r=-1,a=-a}hi.subVectors(this.origin,e);const o=r*this.direction.dot(ui.crossVectors(hi,ui));if(o<0)return null;const l=r*this.direction.dot(pi.cross(hi));if(l<0)return null;if(o+l>a)return null;const d=-r*hi.dot(mi);return d<0?null:this.at(d/a,n)}applyMatrix4(e){return this.origin.applyMatrix4(e),this.direction.transformDirection(e),this}equals(e){return e.origin.equals(this.origin)&&e.direction.equals(this.direction)}clone(){return(new this.constructor).copy(this)}}class gi{constructor(e,t,i,s,n,r,a,o,l,d,c,h,p,u,m,f){gi.prototype.isMatrix4=!0,this.elements=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],void 0!==e&&this.set(e,t,i,s,n,r,a,o,l,d,c,h,p,u,m,f)}set(e,t,i,s,n,r,a,o,l,d,c,h,p,u,m,f){const g=this.elements;return g[0]=e,g[4]=t,g[8]=i,g[12]=s,g[1]=n,g[5]=r,g[9]=a,g[13]=o,g[2]=l,g[6]=d,g[10]=c,g[14]=h,g[3]=p,g[7]=u,g[11]=m,g[15]=f,this}identity(){return this.set(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),this}clone(){return(new gi).fromArray(this.elements)}copy(e){const t=this.elements,i=e.elements;return t[0]=i[0],t[1]=i[1],t[2]=i[2],t[3]=i[3],t[4]=i[4],t[5]=i[5],t[6]=i[6],t[7]=i[7],t[8]=i[8],t[9]=i[9],t[10]=i[10],t[11]=i[11],t[12]=i[12],t[13]=i[13],t[14]=i[14],t[15]=i[15],this}copyPosition(e){const t=this.elements,i=e.elements;return t[12]=i[12],t[13]=i[13],t[14]=i[14],this}setFromMatrix3(e){const t=e.elements;return this.set(t[0],t[3],t[6],0,t[1],t[4],t[7],0,t[2],t[5],t[8],0,0,0,0,1),this}extractBasis(e,t,i){return e.setFromMatrixColumn(this,0),t.setFromMatrixColumn(this,1),i.setFromMatrixColumn(this,2),this}makeBasis(e,t,i){return this.set(e.x,t.x,i.x,0,e.y,t.y,i.y,0,e.z,t.z,i.z,0,0,0,0,1),this}extractRotation(e){const t=this.elements,i=e.elements,s=1/bi.setFromMatrixColumn(e,0).length(),n=1/bi.setFromMatrixColumn(e,1).length(),r=1/bi.setFromMatrixColumn(e,2).length();return t[0]=i[0]*s,t[1]=i[1]*s,t[2]=i[2]*s,t[3]=0,t[4]=i[4]*n,t[5]=i[5]*n,t[6]=i[6]*n,t[7]=0,t[8]=i[8]*r,t[9]=i[9]*r,t[10]=i[10]*r,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,this}makeRotationFromEuler(e){const t=this.elements,i=e.x,s=e.y,n=e.z,r=Math.cos(i),a=Math.sin(i),o=Math.cos(s),l=Math.sin(s),d=Math.cos(n),c=Math.sin(n);if("XYZ"===e.order){const e=r*d,i=r*c,s=a*d,n=a*c;t[0]=o*d,t[4]=-o*c,t[8]=l,t[1]=i+s*l,t[5]=e-n*l,t[9]=-a*o,t[2]=n-e*l,t[6]=s+i*l,t[10]=r*o}else if("YXZ"===e.order){const e=o*d,i=o*c,s=l*d,n=l*c;t[0]=e+n*a,t[4]=s*a-i,t[8]=r*l,t[1]=r*c,t[5]=r*d,t[9]=-a,t[2]=i*a-s,t[6]=n+e*a,t[10]=r*o}else if("ZXY"===e.order){const e=o*d,i=o*c,s=l*d,n=l*c;t[0]=e-n*a,t[4]=-r*c,t[8]=s+i*a,t[1]=i+s*a,t[5]=r*d,t[9]=n-e*a,t[2]=-r*l,t[6]=a,t[10]=r*o}else if("ZYX"===e.order){const e=r*d,i=r*c,s=a*d,n=a*c;t[0]=o*d,t[4]=s*l-i,t[8]=e*l+n,t[1]=o*c,t[5]=n*l+e,t[9]=i*l-s,t[2]=-l,t[6]=a*o,t[10]=r*o}else if("YZX"===e.order){const e=r*o,i=r*l,s=a*o,n=a*l;t[0]=o*d,t[4]=n-e*c,t[8]=s*c+i,t[1]=c,t[5]=r*d,t[9]=-a*d,t[2]=-l*d,t[6]=i*c+s,t[10]=e-n*c}else if("XZY"===e.order){const e=r*o,i=r*l,s=a*o,n=a*l;t[0]=o*d,t[4]=-c,t[8]=l*d,t[1]=e*c+n,t[5]=r*d,t[9]=i*c-s,t[2]=s*c-i,t[6]=a*d,t[10]=n*c+e}return t[3]=0,t[7]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,this}makeRotationFromQuaternion(e){return this.compose(vi,e,_i)}lookAt(e,t,i){const s=this.elements;return wi.subVectors(e,t),0===wi.lengthSq()&&(wi.z=1),wi.normalize(),yi.crossVectors(i,wi),0===yi.lengthSq()&&(1===Math.abs(i.z)?wi.x+=1e-4:wi.z+=1e-4,wi.normalize(),yi.crossVectors(i,wi)),yi.normalize(),Si.crossVectors(wi,yi),s[0]=yi.x,s[4]=Si.x,s[8]=wi.x,s[1]=yi.y,s[5]=Si.y,s[9]=wi.y,s[2]=yi.z,s[6]=Si.z,s[10]=wi.z,this}multiply(e){return this.multiplyMatrices(this,e)}premultiply(e){return this.multiplyMatrices(e,this)}multiplyMatrices(e,t){const i=e.elements,s=t.elements,n=this.elements,r=i[0],a=i[4],o=i[8],l=i[12],d=i[1],c=i[5],h=i[9],p=i[13],u=i[2],m=i[6],f=i[10],g=i[14],b=i[3],C=i[7],v=i[11],_=i[15],y=s[0],S=s[4],w=s[8],x=s[12],A=s[1],M=s[5],T=s[9],E=s[13],R=s[2],k=s[6],O=s[10],I=s[14],P=s[3],D=s[7],L=s[11],F=s[15];return n[0]=r*y+a*A+o*R+l*P,n[4]=r*S+a*M+o*k+l*D,n[8]=r*w+a*T+o*O+l*L,n[12]=r*x+a*E+o*I+l*F,n[1]=d*y+c*A+h*R+p*P,n[5]=d*S+c*M+h*k+p*D,n[9]=d*w+c*T+h*O+p*L,n[13]=d*x+c*E+h*I+p*F,n[2]=u*y+m*A+f*R+g*P,n[6]=u*S+m*M+f*k+g*D,n[10]=u*w+m*T+f*O+g*L,n[14]=u*x+m*E+f*I+g*F,n[3]=b*y+C*A+v*R+_*P,n[7]=b*S+C*M+v*k+_*D,n[11]=b*w+C*T+v*O+_*L,n[15]=b*x+C*E+v*I+_*F,this}multiplyScalar(e){const t=this.elements;return t[0]*=e,t[4]*=e,t[8]*=e,t[12]*=e,t[1]*=e,t[5]*=e,t[9]*=e,t[13]*=e,t[2]*=e,t[6]*=e,t[10]*=e,t[14]*=e,t[3]*=e,t[7]*=e,t[11]*=e,t[15]*=e,this}determinant(){const e=this.elements,t=e[0],i=e[4],s=e[8],n=e[12],r=e[1],a=e[5],o=e[9],l=e[13],d=e[2],c=e[6],h=e[10],p=e[14];return e[3]*(+n*o*c-s*l*c-n*a*h+i*l*h+s*a*p-i*o*p)+e[7]*(+t*o*p-t*l*h+n*r*h-s*r*p+s*l*d-n*o*d)+e[11]*(+t*l*c-t*a*p-n*r*c+i*r*p+n*a*d-i*l*d)+e[15]*(-s*a*d-t*o*c+t*a*h+s*r*c-i*r*h+i*o*d)}transpose(){const e=this.elements;let t;return t=e[1],e[1]=e[4],e[4]=t,t=e[2],e[2]=e[8],e[8]=t,t=e[6],e[6]=e[9],e[9]=t,t=e[3],e[3]=e[12],e[12]=t,t=e[7],e[7]=e[13],e[13]=t,t=e[11],e[11]=e[14],e[14]=t,this}setPosition(e,t,i){const s=this.elements;return e.isVector3?(s[12]=e.x,s[13]=e.y,s[14]=e.z):(s[12]=e,s[13]=t,s[14]=i),this}invert(){const e=this.elements,t=e[0],i=e[1],s=e[2],n=e[3],r=e[4],a=e[5],o=e[6],l=e[7],d=e[8],c=e[9],h=e[10],p=e[11],u=e[12],m=e[13],f=e[14],g=e[15],b=c*f*l-m*h*l+m*o*p-a*f*p-c*o*g+a*h*g,C=u*h*l-d*f*l-u*o*p+r*f*p+d*o*g-r*h*g,v=d*m*l-u*c*l+u*a*p-r*m*p-d*a*g+r*c*g,_=u*c*o-d*m*o-u*a*h+r*m*h+d*a*f-r*c*f,y=t*b+i*C+s*v+n*_;if(0===y)return this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0);const S=1/y;return e[0]=b*S,e[1]=(m*h*n-c*f*n-m*s*p+i*f*p+c*s*g-i*h*g)*S,e[2]=(a*f*n-m*o*n+m*s*l-i*f*l-a*s*g+i*o*g)*S,e[3]=(c*o*n-a*h*n-c*s*l+i*h*l+a*s*p-i*o*p)*S,e[4]=C*S,e[5]=(d*f*n-u*h*n+u*s*p-t*f*p-d*s*g+t*h*g)*S,e[6]=(u*o*n-r*f*n-u*s*l+t*f*l+r*s*g-t*o*g)*S,e[7]=(r*h*n-d*o*n+d*s*l-t*h*l-r*s*p+t*o*p)*S,e[8]=v*S,e[9]=(u*c*n-d*m*n-u*i*p+t*m*p+d*i*g-t*c*g)*S,e[10]=(r*m*n-u*a*n+u*i*l-t*m*l-r*i*g+t*a*g)*S,e[11]=(d*a*n-r*c*n-d*i*l+t*c*l+r*i*p-t*a*p)*S,e[12]=_*S,e[13]=(d*m*s-u*c*s+u*i*h-t*m*h-d*i*f+t*c*f)*S,e[14]=(u*a*s-r*m*s-u*i*o+t*m*o+r*i*f-t*a*f)*S,e[15]=(r*c*s-d*a*s+d*i*o-t*c*o-r*i*h+t*a*h)*S,this}scale(e){const t=this.elements,i=e.x,s=e.y,n=e.z;return t[0]*=i,t[4]*=s,t[8]*=n,t[1]*=i,t[5]*=s,t[9]*=n,t[2]*=i,t[6]*=s,t[10]*=n,t[3]*=i,t[7]*=s,t[11]*=n,this}getMaxScaleOnAxis(){const e=this.elements,t=e[0]*e[0]+e[1]*e[1]+e[2]*e[2],i=e[4]*e[4]+e[5]*e[5]+e[6]*e[6],s=e[8]*e[8]+e[9]*e[9]+e[10]*e[10];return Math.sqrt(Math.max(t,i,s))}makeTranslation(e,t,i){return e.isVector3?this.set(1,0,0,e.x,0,1,0,e.y,0,0,1,e.z,0,0,0,1):this.set(1,0,0,e,0,1,0,t,0,0,1,i,0,0,0,1),this}makeRotationX(e){const t=Math.cos(e),i=Math.sin(e);return this.set(1,0,0,0,0,t,-i,0,0,i,t,0,0,0,0,1),this}makeRotationY(e){const t=Math.cos(e),i=Math.sin(e);return this.set(t,0,i,0,0,1,0,0,-i,0,t,0,0,0,0,1),this}makeRotationZ(e){const t=Math.cos(e),i=Math.sin(e);return this.set(t,-i,0,0,i,t,0,0,0,0,1,0,0,0,0,1),this}makeRotationAxis(e,t){const i=Math.cos(t),s=Math.sin(t),n=1-i,r=e.x,a=e.y,o=e.z,l=n*r,d=n*a;return this.set(l*r+i,l*a-s*o,l*o+s*a,0,l*a+s*o,d*a+i,d*o-s*r,0,l*o-s*a,d*o+s*r,n*o*o+i,0,0,0,0,1),this}makeScale(e,t,i){return this.set(e,0,0,0,0,t,0,0,0,0,i,0,0,0,0,1),this}makeShear(e,t,i,s,n,r){return this.set(1,i,n,0,e,1,r,0,t,s,1,0,0,0,0,1),this}compose(e,t,i){const s=this.elements,n=t._x,r=t._y,a=t._z,o=t._w,l=n+n,d=r+r,c=a+a,h=n*l,p=n*d,u=n*c,m=r*d,f=r*c,g=a*c,b=o*l,C=o*d,v=o*c,_=i.x,y=i.y,S=i.z;return s[0]=(1-(m+g))*_,s[1]=(p+v)*_,s[2]=(u-C)*_,s[3]=0,s[4]=(p-v)*y,s[5]=(1-(h+g))*y,s[6]=(f+b)*y,s[7]=0,s[8]=(u+C)*S,s[9]=(f-b)*S,s[10]=(1-(h+m))*S,s[11]=0,s[12]=e.x,s[13]=e.y,s[14]=e.z,s[15]=1,this}decompose(e,t,i){const s=this.elements;let n=bi.set(s[0],s[1],s[2]).length();const r=bi.set(s[4],s[5],s[6]).length(),a=bi.set(s[8],s[9],s[10]).length();this.determinant()<0&&(n=-n),e.x=s[12],e.y=s[13],e.z=s[14],Ci.copy(this);const o=1/n,l=1/r,d=1/a;return Ci.elements[0]*=o,Ci.elements[1]*=o,Ci.elements[2]*=o,Ci.elements[4]*=l,Ci.elements[5]*=l,Ci.elements[6]*=l,Ci.elements[8]*=d,Ci.elements[9]*=d,Ci.elements[10]*=d,t.setFromRotationMatrix(Ci),i.x=n,i.y=r,i.z=a,this}makePerspective(e,t,i,s,n,r,a=2e3){const o=this.elements,l=2*n/(t-e),d=2*n/(i-s),c=(t+e)/(t-e),h=(i+s)/(i-s);let p,u;if(a===tt)p=-(r+n)/(r-n),u=-2*r*n/(r-n);else{if(a!==it)throw new Error("THREE.Matrix4.makePerspective(): Invalid coordinate system: "+a);p=-r/(r-n),u=-r*n/(r-n)}return o[0]=l,o[4]=0,o[8]=c,o[12]=0,o[1]=0,o[5]=d,o[9]=h,o[13]=0,o[2]=0,o[6]=0,o[10]=p,o[14]=u,o[3]=0,o[7]=0,o[11]=-1,o[15]=0,this}makeOrthographic(e,t,i,s,n,r,a=2e3){const o=this.elements,l=1/(t-e),d=1/(i-s),c=1/(r-n),h=(t+e)*l,p=(i+s)*d;let u,m;if(a===tt)u=(r+n)*c,m=-2*c;else{if(a!==it)throw new Error("THREE.Matrix4.makeOrthographic(): Invalid coordinate system: "+a);u=n*c,m=-1*c}return o[0]=2*l,o[4]=0,o[8]=0,o[12]=-h,o[1]=0,o[5]=2*d,o[9]=0,o[13]=-p,o[2]=0,o[6]=0,o[10]=m,o[14]=-u,o[3]=0,o[7]=0,o[11]=0,o[15]=1,this}equals(e){const t=this.elements,i=e.elements;for(let e=0;e<16;e++)if(t[e]!==i[e])return!1;return!0}fromArray(e,t=0){for(let i=0;i<16;i++)this.elements[i]=e[i+t];return this}toArray(e=[],t=0){const i=this.elements;return e[t]=i[0],e[t+1]=i[1],e[t+2]=i[2],e[t+3]=i[3],e[t+4]=i[4],e[t+5]=i[5],e[t+6]=i[6],e[t+7]=i[7],e[t+8]=i[8],e[t+9]=i[9],e[t+10]=i[10],e[t+11]=i[11],e[t+12]=i[12],e[t+13]=i[13],e[t+14]=i[14],e[t+15]=i[15],e}}const bi=new mt,Ci=new gi,vi=new mt(0,0,0),_i=new mt(1,1,1),yi=new mt,Si=new mt,wi=new mt,xi=new gi,Ai=new ut;class Mi{constructor(e=0,t=0,i=0,s=Mi.DEFAULT_ORDER){this.isEuler=!0,this._x=e,this._y=t,this._z=i,this._order=s}get x(){return this._x}set x(e){this._x=e,this._onChangeCallback()}get y(){return this._y}set y(e){this._y=e,this._onChangeCallback()}get z(){return this._z}set z(e){this._z=e,this._onChangeCallback()}get order(){return this._order}set order(e){this._order=e,this._onChangeCallback()}set(e,t,i,s=this._order){return this._x=e,this._y=t,this._z=i,this._order=s,this._onChangeCallback(),this}clone(){return new this.constructor(this._x,this._y,this._z,this._order)}copy(e){return this._x=e._x,this._y=e._y,this._z=e._z,this._order=e._order,this._onChangeCallback(),this}setFromRotationMatrix(e,t=this._order,i=!0){const s=e.elements,n=s[0],r=s[4],a=s[8],o=s[1],l=s[5],d=s[9],c=s[2],h=s[6],p=s[10];switch(t){case"XYZ":this._y=Math.asin(lt(a,-1,1)),Math.abs(a)<.9999999?(this._x=Math.atan2(-d,p),this._z=Math.atan2(-r,n)):(this._x=Math.atan2(h,l),this._z=0);break;case"YXZ":this._x=Math.asin(-lt(d,-1,1)),Math.abs(d)<.9999999?(this._y=Math.atan2(a,p),this._z=Math.atan2(o,l)):(this._y=Math.atan2(-c,n),this._z=0);break;case"ZXY":this._x=Math.asin(lt(h,-1,1)),Math.abs(h)<.9999999?(this._y=Math.atan2(-c,p),this._z=Math.atan2(-r,l)):(this._y=0,this._z=Math.atan2(o,n));break;case"ZYX":this._y=Math.asin(-lt(c,-1,1)),Math.abs(c)<.9999999?(this._x=Math.atan2(h,p),this._z=Math.atan2(o,n)):(this._x=0,this._z=Math.atan2(-r,l));break;case"YZX":this._z=Math.asin(lt(o,-1,1)),Math.abs(o)<.9999999?(this._x=Math.atan2(-d,l),this._y=Math.atan2(-c,n)):(this._x=0,this._y=Math.atan2(a,p));break;case"XZY":this._z=Math.asin(-lt(r,-1,1)),Math.abs(r)<.9999999?(this._x=Math.atan2(h,l),this._y=Math.atan2(a,n)):(this._x=Math.atan2(-d,p),this._y=0);break;default:console.warn("THREE.Euler: .setFromRotationMatrix() encountered an unknown order: "+t)}return this._order=t,!0===i&&this._onChangeCallback(),this}setFromQuaternion(e,t,i){return xi.makeRotationFromQuaternion(e),this.setFromRotationMatrix(xi,t,i)}setFromVector3(e,t=this._order){return this.set(e.x,e.y,e.z,t)}reorder(e){return Ai.setFromEuler(this),this.setFromQuaternion(Ai,e)}equals(e){return e._x===this._x&&e._y===this._y&&e._z===this._z&&e._order===this._order}fromArray(e){return this._x=e[0],this._y=e[1],this._z=e[2],void 0!==e[3]&&(this._order=e[3]),this._onChangeCallback(),this}toArray(e=[],t=0){return e[t]=this._x,e[t+1]=this._y,e[t+2]=this._z,e[t+3]=this._order,e}_onChange(e){return this._onChangeCallback=e,this}_onChangeCallback(){}*[Symbol.iterator](){yield this._x,yield this._y,yield this._z,yield this._order}}Mi.DEFAULT_ORDER="XYZ";class Ti{constructor(){this.mask=1}set(e){this.mask=1<<e>>>0}enable(e){this.mask|=1<<e}enableAll(){this.mask=-1}toggle(e){this.mask^=1<<e}disable(e){this.mask&=~(1<<e)}disableAll(){this.mask=0}test(e){return 0!==(this.mask&e.mask)}isEnabled(e){return!!(this.mask&1<<e)}}let Ei=0;const Ri=new mt,ki=new ut,Oi=new gi,Ii=new mt,Pi=new mt,Di=new mt,Li=new ut,Fi=new mt(1,0,0),Ni=new mt(0,1,0),Ui=new mt(0,0,1),Hi={type:"added"},Bi={type:"removed"},zi={type:"childadded",child:null},qi={type:"childremoved",child:null};class ji extends st{constructor(){super(),this.isObject3D=!0,Object.defineProperty(this,"id",{value:Ei++}),this.uuid=ot(),this.name="",this.type="Object3D",this.parent=null,this.children=[],this.up=ji.DEFAULT_UP.clone();const e=new mt,t=new Mi,i=new ut,s=new mt(1,1,1);t._onChange((function(){i.setFromEuler(t,!1)})),i._onChange((function(){t.setFromQuaternion(i,void 0,!1)})),Object.defineProperties(this,{position:{configurable:!0,enumerable:!0,value:e},rotation:{configurable:!0,enumerable:!0,value:t},quaternion:{configurable:!0,enumerable:!0,value:i},scale:{configurable:!0,enumerable:!0,value:s},modelViewMatrix:{value:new gi},normalMatrix:{value:new bt}}),this.matrix=new gi,this.matrixWorld=new gi,this.matrixAutoUpdate=ji.DEFAULT_MATRIX_AUTO_UPDATE,this.matrixWorldAutoUpdate=ji.DEFAULT_MATRIX_WORLD_AUTO_UPDATE,this.matrixWorldNeedsUpdate=!1,this.layers=new Ti,this.visible=!0,this.castShadow=!1,this.receiveShadow=!1,this.frustumCulled=!0,this.renderOrder=0,this.animations=[],this.customDepthMaterial=void 0,this.customDistanceMaterial=void 0,this.userData={}}onBeforeShadow(){}onAfterShadow(){}onBeforeRender(){}onAfterRender(){}applyMatrix4(e){this.matrixAutoUpdate&&this.updateMatrix(),this.matrix.premultiply(e),this.matrix.decompose(this.position,this.quaternion,this.scale)}applyQuaternion(e){return this.quaternion.premultiply(e),this}setRotationFromAxisAngle(e,t){this.quaternion.setFromAxisAngle(e,t)}setRotationFromEuler(e){this.quaternion.setFromEuler(e,!0)}setRotationFromMatrix(e){this.quaternion.setFromRotationMatrix(e)}setRotationFromQuaternion(e){this.quaternion.copy(e)}rotateOnAxis(e,t){return ki.setFromAxisAngle(e,t),this.quaternion.multiply(ki),this}rotateOnWorldAxis(e,t){return ki.setFromAxisAngle(e,t),this.quaternion.premultiply(ki),this}rotateX(e){return this.rotateOnAxis(Fi,e)}rotateY(e){return this.rotateOnAxis(Ni,e)}rotateZ(e){return this.rotateOnAxis(Ui,e)}translateOnAxis(e,t){return Ri.copy(e).applyQuaternion(this.quaternion),this.position.add(Ri.multiplyScalar(t)),this}translateX(e){return this.translateOnAxis(Fi,e)}translateY(e){return this.translateOnAxis(Ni,e)}translateZ(e){return this.translateOnAxis(Ui,e)}localToWorld(e){return this.updateWorldMatrix(!0,!1),e.applyMatrix4(this.matrixWorld)}worldToLocal(e){return this.updateWorldMatrix(!0,!1),e.applyMatrix4(Oi.copy(this.matrixWorld).invert())}lookAt(e,t,i){e.isVector3?Ii.copy(e):Ii.set(e,t,i);const s=this.parent;this.updateWorldMatrix(!0,!1),Pi.setFromMatrixPosition(this.matrixWorld),this.isCamera||this.isLight?Oi.lookAt(Pi,Ii,this.up):Oi.lookAt(Ii,Pi,this.up),this.quaternion.setFromRotationMatrix(Oi),s&&(Oi.extractRotation(s.matrixWorld),ki.setFromRotationMatrix(Oi),this.quaternion.premultiply(ki.invert()))}add(e){if(arguments.length>1){for(let e=0;e<arguments.length;e++)this.add(arguments[e]);return this}return e===this?(console.error("THREE.Object3D.add: object can't be added as a child of itself.",e),this):(e&&e.isObject3D?(e.removeFromParent(),e.parent=this,this.children.push(e),e.dispatchEvent(Hi),zi.child=e,this.dispatchEvent(zi),zi.child=null):console.error("THREE.Object3D.add: object not an instance of THREE.Object3D.",e),this)}remove(e){if(arguments.length>1){for(let e=0;e<arguments.length;e++)this.remove(arguments[e]);return this}const t=this.children.indexOf(e);return-1!==t&&(e.parent=null,this.children.splice(t,1),e.dispatchEvent(Bi),qi.child=e,this.dispatchEvent(qi),qi.child=null),this}removeFromParent(){const e=this.parent;return null!==e&&e.remove(this),this}clear(){return this.remove(...this.children)}attach(e){return this.updateWorldMatrix(!0,!1),Oi.copy(this.matrixWorld).invert(),null!==e.parent&&(e.parent.updateWorldMatrix(!0,!1),Oi.multiply(e.parent.matrixWorld)),e.applyMatrix4(Oi),e.removeFromParent(),e.parent=this,this.children.push(e),e.updateWorldMatrix(!1,!0),e.dispatchEvent(Hi),zi.child=e,this.dispatchEvent(zi),zi.child=null,this}getObjectById(e){return this.getObjectByProperty("id",e)}getObjectByName(e){return this.getObjectByProperty("name",e)}getObjectByProperty(e,t){if(this[e]===t)return this;for(let i=0,s=this.children.length;i<s;i++){const s=this.children[i].getObjectByProperty(e,t);if(void 0!==s)return s}}getObjectsByProperty(e,t,i=[]){this[e]===t&&i.push(this);const s=this.children;for(let n=0,r=s.length;n<r;n++)s[n].getObjectsByProperty(e,t,i);return i}getWorldPosition(e){return this.updateWorldMatrix(!0,!1),e.setFromMatrixPosition(this.matrixWorld)}getWorldQuaternion(e){return this.updateWorldMatrix(!0,!1),this.matrixWorld.decompose(Pi,e,Di),e}getWorldScale(e){return this.updateWorldMatrix(!0,!1),this.matrixWorld.decompose(Pi,Li,e),e}getWorldDirection(e){this.updateWorldMatrix(!0,!1);const t=this.matrixWorld.elements;return e.set(t[8],t[9],t[10]).normalize()}raycast(){}traverse(e){e(this);const t=this.children;for(let i=0,s=t.length;i<s;i++)t[i].traverse(e)}traverseVisible(e){if(!1===this.visible)return;e(this);const t=this.children;for(let i=0,s=t.length;i<s;i++)t[i].traverseVisible(e)}traverseAncestors(e){const t=this.parent;null!==t&&(e(t),t.traverseAncestors(e))}updateMatrix(){this.matrix.compose(this.position,this.quaternion,this.scale),this.matrixWorldNeedsUpdate=!0}updateMatrixWorld(e){this.matrixAutoUpdate&&this.updateMatrix(),(this.matrixWorldNeedsUpdate||e)&&(!0===this.matrixWorldAutoUpdate&&(null===this.parent?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix)),this.matrixWorldNeedsUpdate=!1,e=!0);const t=this.children;for(let i=0,s=t.length;i<s;i++){t[i].updateMatrixWorld(e)}}updateWorldMatrix(e,t){const i=this.parent;if(!0===e&&null!==i&&i.updateWorldMatrix(!0,!1),this.matrixAutoUpdate&&this.updateMatrix(),!0===this.matrixWorldAutoUpdate&&(null===this.parent?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix)),!0===t){const e=this.children;for(let t=0,i=e.length;t<i;t++){e[t].updateWorldMatrix(!1,!0)}}}toJSON(e){const t=void 0===e||"string"==typeof e,i={};t&&(e={geometries:{},materials:{},textures:{},images:{},shapes:{},skeletons:{},animations:{},nodes:{}},i.metadata={version:4.7,type:"Object",generator:"Object3D.toJSON"});const s={};function n(t,i){return void 0===t[i.uuid]&&(t[i.uuid]=i.toJSON(e)),i.uuid}if(s.uuid=this.uuid,s.type=this.type,""!==this.name&&(s.name=this.name),!0===this.castShadow&&(s.castShadow=!0),!0===this.receiveShadow&&(s.receiveShadow=!0),!1===this.visible&&(s.visible=!1),!1===this.frustumCulled&&(s.frustumCulled=!1),0!==this.renderOrder&&(s.renderOrder=this.renderOrder),Object.keys(this.userData).length>0&&(s.userData=this.userData),s.layers=this.layers.mask,s.matrix=this.matrix.toArray(),s.up=this.up.toArray(),!1===this.matrixAutoUpdate&&(s.matrixAutoUpdate=!1),this.isInstancedMesh&&(s.type="InstancedMesh",s.count=this.count,s.instanceMatrix=this.instanceMatrix.toJSON(),null!==this.instanceColor&&(s.instanceColor=this.instanceColor.toJSON())),this.isBatchedMesh&&(s.type="BatchedMesh",s.perObjectFrustumCulled=this.perObjectFrustumCulled,s.sortObjects=this.sortObjects,s.drawRanges=this._drawRanges,s.reservedRanges=this._reservedRanges,s.geometryInfo=this._geometryInfo.map((e=>({...e,boundingBox:e.boundingBox?e.boundingBox.toJSON():void 0,boundingSphere:e.boundingSphere?e.boundingSphere.toJSON():void 0}))),s.instanceInfo=this._instanceInfo.map((e=>({...e}))),s.availableInstanceIds=this._availableInstanceIds.slice(),s.availableGeometryIds=this._availableGeometryIds.slice(),s.nextIndexStart=this._nextIndexStart,s.nextVertexStart=this._nextVertexStart,s.geometryCount=this._geometryCount,s.maxInstanceCount=this._maxInstanceCount,s.maxVertexCount=this._maxVertexCount,s.maxIndexCount=this._maxIndexCount,s.geometryInitialized=this._geometryInitialized,s.matricesTexture=this._matricesTexture.toJSON(e),s.indirectTexture=this._indirectTexture.toJSON(e),null!==this._colorsTexture&&(s.colorsTexture=this._colorsTexture.toJSON(e)),null!==this.boundingSphere&&(s.boundingSphere=this.boundingSphere.toJSON()),null!==this.boundingBox&&(s.boundingBox=this.boundingBox.toJSON())),this.isScene)this.background&&(this.background.isColor?s.background=this.background.toJSON():this.background.isTexture&&(s.background=this.background.toJSON(e).uuid)),this.environment&&this.environment.isTexture&&!0!==this.environment.isRenderTargetTexture&&(s.environment=this.environment.toJSON(e).uuid);else if(this.isMesh||this.isLine||this.isPoints){s.geometry=n(e.geometries,this.geometry);const t=this.geometry.parameters;if(void 0!==t&&void 0!==t.shapes){const i=t.shapes;if(Array.isArray(i))for(let t=0,s=i.length;t<s;t++){const s=i[t];n(e.shapes,s)}else n(e.shapes,i)}}if(this.isSkinnedMesh&&(s.bindMode=this.bindMode,s.bindMatrix=this.bindMatrix.toArray(),void 0!==this.skeleton&&(n(e.skeletons,this.skeleton),s.skeleton=this.skeleton.uuid)),void 0!==this.material)if(Array.isArray(this.material)){const t=[];for(let i=0,s=this.material.length;i<s;i++)t.push(n(e.materials,this.material[i]));s.material=t}else s.material=n(e.materials,this.material);if(this.children.length>0){s.children=[];for(let t=0;t<this.children.length;t++)s.children.push(this.children[t].toJSON(e).object)}if(this.animations.length>0){s.animations=[];for(let t=0;t<this.animations.length;t++){const i=this.animations[t];s.animations.push(n(e.animations,i))}}if(t){const t=r(e.geometries),s=r(e.materials),n=r(e.textures),a=r(e.images),o=r(e.shapes),l=r(e.skeletons),d=r(e.animations),c=r(e.nodes);t.length>0&&(i.geometries=t),s.length>0&&(i.materials=s),n.length>0&&(i.textures=n),a.length>0&&(i.images=a),o.length>0&&(i.shapes=o),l.length>0&&(i.skeletons=l),d.length>0&&(i.animations=d),c.length>0&&(i.nodes=c)}return i.object=s,i;function r(e){const t=[];for(const i in e){const s=e[i];delete s.metadata,t.push(s)}return t}}clone(e){return(new this.constructor).copy(this,e)}copy(e,t=!0){if(this.name=e.name,this.up.copy(e.up),this.position.copy(e.position),this.rotation.order=e.rotation.order,this.quaternion.copy(e.quaternion),this.scale.copy(e.scale),this.matrix.copy(e.matrix),this.matrixWorld.copy(e.matrixWorld),this.matrixAutoUpdate=e.matrixAutoUpdate,this.matrixWorldAutoUpdate=e.matrixWorldAutoUpdate,this.matrixWorldNeedsUpdate=e.matrixWorldNeedsUpdate,this.layers.mask=e.layers.mask,this.visible=e.visible,this.castShadow=e.castShadow,this.receiveShadow=e.receiveShadow,this.frustumCulled=e.frustumCulled,this.renderOrder=e.renderOrder,this.animations=e.animations.slice(),this.userData=JSON.parse(JSON.stringify(e.userData)),!0===t)for(let t=0;t<e.children.length;t++){const i=e.children[t];this.add(i.clone())}return this}}ji.DEFAULT_UP=new mt(0,1,0),ji.DEFAULT_MATRIX_AUTO_UPDATE=!0,ji.DEFAULT_MATRIX_WORLD_AUTO_UPDATE=!0;const Gi=new mt,$i=new mt,Vi=new mt,Wi=new mt,Xi=new mt,Yi=new mt,Ki=new mt,Zi=new mt,Ji=new mt,Qi=new mt,es=new Ut,ts=new Ut,is=new Ut;class ss{constructor(e=new mt,t=new mt,i=new mt){this.a=e,this.b=t,this.c=i}static getNormal(e,t,i,s){s.subVectors(i,t),Gi.subVectors(e,t),s.cross(Gi);const n=s.lengthSq();return n>0?s.multiplyScalar(1/Math.sqrt(n)):s.set(0,0,0)}static getBarycoord(e,t,i,s,n){Gi.subVectors(s,t),$i.subVectors(i,t),Vi.subVectors(e,t);const r=Gi.dot(Gi),a=Gi.dot($i),o=Gi.dot(Vi),l=$i.dot($i),d=$i.dot(Vi),c=r*l-a*a;if(0===c)return n.set(0,0,0),null;const h=1/c,p=(l*o-a*d)*h,u=(r*d-a*o)*h;return n.set(1-p-u,u,p)}static containsPoint(e,t,i,s){return null!==this.getBarycoord(e,t,i,s,Wi)&&(Wi.x>=0&&Wi.y>=0&&Wi.x+Wi.y<=1)}static getInterpolation(e,t,i,s,n,r,a,o){return null===this.getBarycoord(e,t,i,s,Wi)?(o.x=0,o.y=0,"z"in o&&(o.z=0),"w"in o&&(o.w=0),null):(o.setScalar(0),o.addScaledVector(n,Wi.x),o.addScaledVector(r,Wi.y),o.addScaledVector(a,Wi.z),o)}static getInterpolatedAttribute(e,t,i,s,n,r){return es.setScalar(0),ts.setScalar(0),is.setScalar(0),es.fromBufferAttribute(e,t),ts.fromBufferAttribute(e,i),is.fromBufferAttribute(e,s),r.setScalar(0),r.addScaledVector(es,n.x),r.addScaledVector(ts,n.y),r.addScaledVector(is,n.z),r}static isFrontFacing(e,t,i,s){return Gi.subVectors(i,t),$i.subVectors(e,t),Gi.cross($i).dot(s)<0}set(e,t,i){return this.a.copy(e),this.b.copy(t),this.c.copy(i),this}setFromPointsAndIndices(e,t,i,s){return this.a.copy(e[t]),this.b.copy(e[i]),this.c.copy(e[s]),this}setFromAttributeAndIndices(e,t,i,s){return this.a.fromBufferAttribute(e,t),this.b.fromBufferAttribute(e,i),this.c.fromBufferAttribute(e,s),this}clone(){return(new this.constructor).copy(this)}copy(e){return this.a.copy(e.a),this.b.copy(e.b),this.c.copy(e.c),this}getArea(){return Gi.subVectors(this.c,this.b),$i.subVectors(this.a,this.b),.5*Gi.cross($i).length()}getMidpoint(e){return e.addVectors(this.a,this.b).add(this.c).multiplyScalar(1/3)}getNormal(e){return ss.getNormal(this.a,this.b,this.c,e)}getPlane(e){return e.setFromCoplanarPoints(this.a,this.b,this.c)}getBarycoord(e,t){return ss.getBarycoord(e,this.a,this.b,this.c,t)}getInterpolation(e,t,i,s,n){return ss.getInterpolation(e,this.a,this.b,this.c,t,i,s,n)}containsPoint(e){return ss.containsPoint(e,this.a,this.b,this.c)}isFrontFacing(e){return ss.isFrontFacing(this.a,this.b,this.c,e)}intersectsBox(e){return e.intersectsTriangle(this)}closestPointToPoint(e,t){const i=this.a,s=this.b,n=this.c;let r,a;Xi.subVectors(s,i),Yi.subVectors(n,i),Zi.subVectors(e,i);const o=Xi.dot(Zi),l=Yi.dot(Zi);if(o<=0&&l<=0)return t.copy(i);Ji.subVectors(e,s);const d=Xi.dot(Ji),c=Yi.dot(Ji);if(d>=0&&c<=d)return t.copy(s);const h=o*c-d*l;if(h<=0&&o>=0&&d<=0)return r=o/(o-d),t.copy(i).addScaledVector(Xi,r);Qi.subVectors(e,n);const p=Xi.dot(Qi),u=Yi.dot(Qi);if(u>=0&&p<=u)return t.copy(n);const m=p*l-o*u;if(m<=0&&l>=0&&u<=0)return a=l/(l-u),t.copy(i).addScaledVector(Yi,a);const f=d*u-p*c;if(f<=0&&c-d>=0&&p-u>=0)return Ki.subVectors(n,s),a=(c-d)/(c-d+(p-u)),t.copy(s).addScaledVector(Ki,a);const g=1/(f+m+h);return r=m*g,a=h*g,t.copy(i).addScaledVector(Xi,r).addScaledVector(Yi,a)}equals(e){return e.a.equals(this.a)&&e.b.equals(this.b)&&e.c.equals(this.c)}}const ns={aliceblue:15792383,antiquewhite:16444375,aqua:65535,aquamarine:8388564,azure:15794175,beige:16119260,bisque:16770244,black:0,blanchedalmond:16772045,blue:255,blueviolet:9055202,brown:10824234,burlywood:14596231,cadetblue:6266528,chartreuse:8388352,chocolate:13789470,coral:16744272,cornflowerblue:6591981,cornsilk:16775388,crimson:14423100,cyan:65535,darkblue:139,darkcyan:35723,darkgoldenrod:12092939,darkgray:11119017,darkgreen:25600,darkgrey:11119017,darkkhaki:12433259,darkmagenta:9109643,darkolivegreen:5597999,darkorange:16747520,darkorchid:10040012,darkred:9109504,darksalmon:15308410,darkseagreen:9419919,darkslateblue:4734347,darkslategray:3100495,darkslategrey:3100495,darkturquoise:52945,darkviolet:9699539,deeppink:16716947,deepskyblue:49151,dimgray:6908265,dimgrey:6908265,dodgerblue:2003199,firebrick:11674146,floralwhite:16775920,forestgreen:2263842,fuchsia:16711935,gainsboro:14474460,ghostwhite:16316671,gold:16766720,goldenrod:14329120,gray:8421504,green:32768,greenyellow:11403055,grey:8421504,honeydew:15794160,hotpink:16738740,indianred:13458524,indigo:4915330,ivory:16777200,khaki:15787660,lavender:15132410,lavenderblush:16773365,lawngreen:8190976,lemonchiffon:16775885,lightblue:11393254,lightcoral:15761536,lightcyan:14745599,lightgoldenrodyellow:16448210,lightgray:13882323,lightgreen:9498256,lightgrey:13882323,lightpink:16758465,lightsalmon:16752762,lightseagreen:2142890,lightskyblue:8900346,lightslategray:7833753,lightslategrey:7833753,lightsteelblue:11584734,lightyellow:16777184,lime:65280,limegreen:3329330,linen:16445670,magenta:16711935,maroon:8388608,mediumaquamarine:6737322,mediumblue:205,mediumorchid:12211667,mediumpurple:9662683,mediumseagreen:3978097,mediumslateblue:8087790,mediumspringgreen:64154,mediumturquoise:4772300,mediumvioletred:13047173,midnightblue:1644912,mintcream:16121850,mistyrose:16770273,moccasin:16770229,navajowhite:16768685,navy:128,oldlace:16643558,olive:8421376,olivedrab:7048739,orange:16753920,orangered:16729344,orchid:14315734,palegoldenrod:15657130,palegreen:10025880,paleturquoise:11529966,palevioletred:14381203,papayawhip:16773077,peachpuff:16767673,peru:13468991,pink:16761035,plum:14524637,powderblue:11591910,purple:8388736,rebeccapurple:6697881,red:16711680,rosybrown:12357519,royalblue:4286945,saddlebrown:9127187,salmon:16416882,sandybrown:16032864,seagreen:3050327,seashell:16774638,sienna:10506797,silver:12632256,skyblue:8900331,slateblue:6970061,slategray:7372944,slategrey:7372944,snow:16775930,springgreen:65407,steelblue:4620980,tan:13808780,teal:32896,thistle:14204888,tomato:16737095,turquoise:4251856,violet:15631086,wheat:16113331,white:16777215,whitesmoke:16119285,yellow:16776960,yellowgreen:10145074},rs={h:0,s:0,l:0},as={h:0,s:0,l:0};function os(e,t,i){return i<0&&(i+=1),i>1&&(i-=1),i<1/6?e+6*(t-e)*i:i<.5?t:i<2/3?e+6*(t-e)*(2/3-i):e}class ls{constructor(e,t,i){return this.isColor=!0,this.r=1,this.g=1,this.b=1,this.set(e,t,i)}set(e,t,i){if(void 0===t&&void 0===i){const t=e;t&&t.isColor?this.copy(t):"number"==typeof t?this.setHex(t):"string"==typeof t&&this.setStyle(t)}else this.setRGB(e,t,i);return this}setScalar(e){return this.r=e,this.g=e,this.b=e,this}setHex(e,t=Be){return e=Math.floor(e),this.r=(e>>16&255)/255,this.g=(e>>8&255)/255,this.b=(255&e)/255,Tt.colorSpaceToWorking(this,t),this}setRGB(e,t,i,s=Tt.workingColorSpace){return this.r=e,this.g=t,this.b=i,Tt.colorSpaceToWorking(this,s),this}setHSL(e,t,i,s=Tt.workingColorSpace){var n;if(e=(e%(n=1)+n)%n,t=lt(t,0,1),i=lt(i,0,1),0===t)this.r=this.g=this.b=i;else{const s=i<=.5?i*(1+t):i+t-i*t,n=2*i-s;this.r=os(n,s,e+1/3),this.g=os(n,s,e),this.b=os(n,s,e-1/3)}return Tt.colorSpaceToWorking(this,s),this}setStyle(e,t=Be){function i(t){void 0!==t&&parseFloat(t)<1&&console.warn("THREE.Color: Alpha component of "+e+" will be ignored.")}let s;if(s=/^(\w+)\(([^\)]*)\)/.exec(e)){let n;const r=s[1],a=s[2];switch(r){case"rgb":case"rgba":if(n=/^\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*(?:,\s*(\d*\.?\d+)\s*)?$/.exec(a))return i(n[4]),this.setRGB(Math.min(255,parseInt(n[1],10))/255,Math.min(255,parseInt(n[2],10))/255,Math.min(255,parseInt(n[3],10))/255,t);if(n=/^\s*(\d+)\%\s*,\s*(\d+)\%\s*,\s*(\d+)\%\s*(?:,\s*(\d*\.?\d+)\s*)?$/.exec(a))return i(n[4]),this.setRGB(Math.min(100,parseInt(n[1],10))/100,Math.min(100,parseInt(n[2],10))/100,Math.min(100,parseInt(n[3],10))/100,t);break;case"hsl":case"hsla":if(n=/^\s*(\d*\.?\d+)\s*,\s*(\d*\.?\d+)\%\s*,\s*(\d*\.?\d+)\%\s*(?:,\s*(\d*\.?\d+)\s*)?$/.exec(a))return i(n[4]),this.setHSL(parseFloat(n[1])/360,parseFloat(n[2])/100,parseFloat(n[3])/100,t);break;default:console.warn("THREE.Color: Unknown color model "+e)}}else if(s=/^\#([A-Fa-f\d]+)$/.exec(e)){const i=s[1],n=i.length;if(3===n)return this.setRGB(parseInt(i.charAt(0),16)/15,parseInt(i.charAt(1),16)/15,parseInt(i.charAt(2),16)/15,t);if(6===n)return this.setHex(parseInt(i,16),t);console.warn("THREE.Color: Invalid hex color "+e)}else if(e&&e.length>0)return this.setColorName(e,t);return this}setColorName(e,t=Be){const i=ns[e.toLowerCase()];return void 0!==i?this.setHex(i,t):console.warn("THREE.Color: Unknown color "+e),this}clone(){return new this.constructor(this.r,this.g,this.b)}copy(e){return this.r=e.r,this.g=e.g,this.b=e.b,this}copySRGBToLinear(e){return this.r=Et(e.r),this.g=Et(e.g),this.b=Et(e.b),this}copyLinearToSRGB(e){return this.r=Rt(e.r),this.g=Rt(e.g),this.b=Rt(e.b),this}convertSRGBToLinear(){return this.copySRGBToLinear(this),this}convertLinearToSRGB(){return this.copyLinearToSRGB(this),this}getHex(e=Be){return Tt.workingToColorSpace(ds.copy(this),e),65536*Math.round(lt(255*ds.r,0,255))+256*Math.round(lt(255*ds.g,0,255))+Math.round(lt(255*ds.b,0,255))}getHexString(e=Be){return("000000"+this.getHex(e).toString(16)).slice(-6)}getHSL(e,t=Tt.workingColorSpace){Tt.workingToColorSpace(ds.copy(this),t);const i=ds.r,s=ds.g,n=ds.b,r=Math.max(i,s,n),a=Math.min(i,s,n);let o,l;const d=(a+r)/2;if(a===r)o=0,l=0;else{const e=r-a;switch(l=d<=.5?e/(r+a):e/(2-r-a),r){case i:o=(s-n)/e+(s<n?6:0);break;case s:o=(n-i)/e+2;break;case n:o=(i-s)/e+4}o/=6}return e.h=o,e.s=l,e.l=d,e}getRGB(e,t=Tt.workingColorSpace){return Tt.workingToColorSpace(ds.copy(this),t),e.r=ds.r,e.g=ds.g,e.b=ds.b,e}getStyle(e=Be){Tt.workingToColorSpace(ds.copy(this),e);const t=ds.r,i=ds.g,s=ds.b;return e!==Be?`color(${e} ${t.toFixed(3)} ${i.toFixed(3)} ${s.toFixed(3)})`:`rgb(${Math.round(255*t)},${Math.round(255*i)},${Math.round(255*s)})`}offsetHSL(e,t,i){return this.getHSL(rs),this.setHSL(rs.h+e,rs.s+t,rs.l+i)}add(e){return this.r+=e.r,this.g+=e.g,this.b+=e.b,this}addColors(e,t){return this.r=e.r+t.r,this.g=e.g+t.g,this.b=e.b+t.b,this}addScalar(e){return this.r+=e,this.g+=e,this.b+=e,this}sub(e){return this.r=Math.max(0,this.r-e.r),this.g=Math.max(0,this.g-e.g),this.b=Math.max(0,this.b-e.b),this}multiply(e){return this.r*=e.r,this.g*=e.g,this.b*=e.b,this}multiplyScalar(e){return this.r*=e,this.g*=e,this.b*=e,this}lerp(e,t){return this.r+=(e.r-this.r)*t,this.g+=(e.g-this.g)*t,this.b+=(e.b-this.b)*t,this}lerpColors(e,t,i){return this.r=e.r+(t.r-e.r)*i,this.g=e.g+(t.g-e.g)*i,this.b=e.b+(t.b-e.b)*i,this}lerpHSL(e,t){this.getHSL(rs),e.getHSL(as);const i=dt(rs.h,as.h,t),s=dt(rs.s,as.s,t),n=dt(rs.l,as.l,t);return this.setHSL(i,s,n),this}setFromVector3(e){return this.r=e.x,this.g=e.y,this.b=e.z,this}applyMatrix3(e){const t=this.r,i=this.g,s=this.b,n=e.elements;return this.r=n[0]*t+n[3]*i+n[6]*s,this.g=n[1]*t+n[4]*i+n[7]*s,this.b=n[2]*t+n[5]*i+n[8]*s,this}equals(e){return e.r===this.r&&e.g===this.g&&e.b===this.b}fromArray(e,t=0){return this.r=e[t],this.g=e[t+1],this.b=e[t+2],this}toArray(e=[],t=0){return e[t]=this.r,e[t+1]=this.g,e[t+2]=this.b,e}fromBufferAttribute(e,t){return this.r=e.getX(t),this.g=e.getY(t),this.b=e.getZ(t),this}toJSON(){return this.getHex()}*[Symbol.iterator](){yield this.r,yield this.g,yield this.b}}const ds=new ls;ls.NAMES=ns;let cs=0;class hs extends st{constructor(){super(),this.isMaterial=!0,Object.defineProperty(this,"id",{value:cs++}),this.uuid=ot(),this.name="",this.type="Material",this.blending=1,this.side=0,this.vertexColors=!1,this.opacity=1,this.transparent=!1,this.alphaHash=!1,this.blendSrc=204,this.blendDst=205,this.blendEquation=r,this.blendSrcAlpha=null,this.blendDstAlpha=null,this.blendEquationAlpha=null,this.blendColor=new ls(0,0,0),this.blendAlpha=0,this.depthFunc=3,this.depthTest=!0,this.depthWrite=!0,this.stencilWriteMask=255,this.stencilFunc=519,this.stencilRef=0,this.stencilFuncMask=255,this.stencilFail=Ge,this.stencilZFail=Ge,this.stencilZPass=Ge,this.stencilWrite=!1,this.clippingPlanes=null,this.clipIntersection=!1,this.clipShadows=!1,this.shadowSide=null,this.colorWrite=!0,this.precision=null,this.polygonOffset=!1,this.polygonOffsetFactor=0,this.polygonOffsetUnits=0,this.dithering=!1,this.alphaToCoverage=!1,this.premultipliedAlpha=!1,this.forceSinglePass=!1,this.allowOverride=!0,this.visible=!0,this.toneMapped=!0,this.userData={},this.version=0,this._alphaTest=0}get alphaTest(){return this._alphaTest}set alphaTest(e){this._alphaTest>0!=e>0&&this.version++,this._alphaTest=e}onBeforeRender(){}onBeforeCompile(){}customProgramCacheKey(){return this.onBeforeCompile.toString()}setValues(e){if(void 0!==e)for(const t in e){const i=e[t];if(void 0===i){console.warn(`THREE.Material: parameter '${t}' has value of undefined.`);continue}const s=this[t];void 0!==s?s&&s.isColor?s.set(i):s&&s.isVector3&&i&&i.isVector3?s.copy(i):this[t]=i:console.warn(`THREE.Material: '${t}' is not a property of THREE.${this.type}.`)}}toJSON(e){const t=void 0===e||"string"==typeof e;t&&(e={textures:{},images:{}});const i={metadata:{version:4.7,type:"Material",generator:"Material.toJSON"}};function s(e){const t=[];for(const i in e){const s=e[i];delete s.metadata,t.push(s)}return t}if(i.uuid=this.uuid,i.type=this.type,""!==this.name&&(i.name=this.name),this.color&&this.color.isColor&&(i.color=this.color.getHex()),void 0!==this.roughness&&(i.roughness=this.roughness),void 0!==this.metalness&&(i.metalness=this.metalness),void 0!==this.sheen&&(i.sheen=this.sheen),this.sheenColor&&this.sheenColor.isColor&&(i.sheenColor=this.sheenColor.getHex()),void 0!==this.sheenRoughness&&(i.sheenRoughness=this.sheenRoughness),this.emissive&&this.emissive.isColor&&(i.emissive=this.emissive.getHex()),void 0!==this.emissiveIntensity&&1!==this.emissiveIntensity&&(i.emissiveIntensity=this.emissiveIntensity),this.specular&&this.specular.isColor&&(i.specular=this.specular.getHex()),void 0!==this.specularIntensity&&(i.specularIntensity=this.specularIntensity),this.specularColor&&this.specularColor.isColor&&(i.specularColor=this.specularColor.getHex()),void 0!==this.shininess&&(i.shininess=this.shininess),void 0!==this.clearcoat&&(i.clearcoat=this.clearcoat),void 0!==this.clearcoatRoughness&&(i.clearcoatRoughness=this.clearcoatRoughness),this.clearcoatMap&&this.clearcoatMap.isTexture&&(i.clearcoatMap=this.clearcoatMap.toJSON(e).uuid),this.clearcoatRoughnessMap&&this.clearcoatRoughnessMap.isTexture&&(i.clearcoatRoughnessMap=this.clearcoatRoughnessMap.toJSON(e).uuid),this.clearcoatNormalMap&&this.clearcoatNormalMap.isTexture&&(i.clearcoatNormalMap=this.clearcoatNormalMap.toJSON(e).uuid,i.clearcoatNormalScale=this.clearcoatNormalScale.toArray()),void 0!==this.dispersion&&(i.dispersion=this.dispersion),void 0!==this.iridescence&&(i.iridescence=this.iridescence),void 0!==this.iridescenceIOR&&(i.iridescenceIOR=this.iridescenceIOR),void 0!==this.iridescenceThicknessRange&&(i.iridescenceThicknessRange=this.iridescenceThicknessRange),this.iridescenceMap&&this.iridescenceMap.isTexture&&(i.iridescenceMap=this.iridescenceMap.toJSON(e).uuid),this.iridescenceThicknessMap&&this.iridescenceThicknessMap.isTexture&&(i.iridescenceThicknessMap=this.iridescenceThicknessMap.toJSON(e).uuid),void 0!==this.anisotropy&&(i.anisotropy=this.anisotropy),void 0!==this.anisotropyRotation&&(i.anisotropyRotation=this.anisotropyRotation),this.anisotropyMap&&this.anisotropyMap.isTexture&&(i.anisotropyMap=this.anisotropyMap.toJSON(e).uuid),this.map&&this.map.isTexture&&(i.map=this.map.toJSON(e).uuid),this.matcap&&this.matcap.isTexture&&(i.matcap=this.matcap.toJSON(e).uuid),this.alphaMap&&this.alphaMap.isTexture&&(i.alphaMap=this.alphaMap.toJSON(e).uuid),this.lightMap&&this.lightMap.isTexture&&(i.lightMap=this.lightMap.toJSON(e).uuid,i.lightMapIntensity=this.lightMapIntensity),this.aoMap&&this.aoMap.isTexture&&(i.aoMap=this.aoMap.toJSON(e).uuid,i.aoMapIntensity=this.aoMapIntensity),this.bumpMap&&this.bumpMap.isTexture&&(i.bumpMap=this.bumpMap.toJSON(e).uuid,i.bumpScale=this.bumpScale),this.normalMap&&this.normalMap.isTexture&&(i.normalMap=this.normalMap.toJSON(e).uuid,i.normalMapType=this.normalMapType,i.normalScale=this.normalScale.toArray()),this.displacementMap&&this.displacementMap.isTexture&&(i.displacementMap=this.displacementMap.toJSON(e).uuid,i.displacementScale=this.displacementScale,i.displacementBias=this.displacementBias),this.roughnessMap&&this.roughnessMap.isTexture&&(i.roughnessMap=this.roughnessMap.toJSON(e).uuid),this.metalnessMap&&this.metalnessMap.isTexture&&(i.metalnessMap=this.metalnessMap.toJSON(e).uuid),this.emissiveMap&&this.emissiveMap.isTexture&&(i.emissiveMap=this.emissiveMap.toJSON(e).uuid),this.specularMap&&this.specularMap.isTexture&&(i.specularMap=this.specularMap.toJSON(e).uuid),this.specularIntensityMap&&this.specularIntensityMap.isTexture&&(i.specularIntensityMap=this.specularIntensityMap.toJSON(e).uuid),this.specularColorMap&&this.specularColorMap.isTexture&&(i.specularColorMap=this.specularColorMap.toJSON(e).uuid),this.envMap&&this.envMap.isTexture&&(i.envMap=this.envMap.toJSON(e).uuid,void 0!==this.combine&&(i.combine=this.combine)),void 0!==this.envMapRotation&&(i.envMapRotation=this.envMapRotation.toArray()),void 0!==this.envMapIntensity&&(i.envMapIntensity=this.envMapIntensity),void 0!==this.reflectivity&&(i.reflectivity=this.reflectivity),void 0!==this.refractionRatio&&(i.refractionRatio=this.refractionRatio),this.gradientMap&&this.gradientMap.isTexture&&(i.gradientMap=this.gradientMap.toJSON(e).uuid),void 0!==this.transmission&&(i.transmission=this.transmission),this.transmissionMap&&this.transmissionMap.isTexture&&(i.transmissionMap=this.transmissionMap.toJSON(e).uuid),void 0!==this.thickness&&(i.thickness=this.thickness),this.thicknessMap&&this.thicknessMap.isTexture&&(i.thicknessMap=this.thicknessMap.toJSON(e).uuid),void 0!==this.attenuationDistance&&this.attenuationDistance!==1/0&&(i.attenuationDistance=this.attenuationDistance),void 0!==this.attenuationColor&&(i.attenuationColor=this.attenuationColor.getHex()),void 0!==this.size&&(i.size=this.size),null!==this.shadowSide&&(i.shadowSide=this.shadowSide),void 0!==this.sizeAttenuation&&(i.sizeAttenuation=this.sizeAttenuation),1!==this.blending&&(i.blending=this.blending),0!==this.side&&(i.side=this.side),!0===this.vertexColors&&(i.vertexColors=!0),this.opacity<1&&(i.opacity=this.opacity),!0===this.transparent&&(i.transparent=!0),204!==this.blendSrc&&(i.blendSrc=this.blendSrc),205!==this.blendDst&&(i.blendDst=this.blendDst),this.blendEquation!==r&&(i.blendEquation=this.blendEquation),null!==this.blendSrcAlpha&&(i.blendSrcAlpha=this.blendSrcAlpha),null!==this.blendDstAlpha&&(i.blendDstAlpha=this.blendDstAlpha),null!==this.blendEquationAlpha&&(i.blendEquationAlpha=this.blendEquationAlpha),this.blendColor&&this.blendColor.isColor&&(i.blendColor=this.blendColor.getHex()),0!==this.blendAlpha&&(i.blendAlpha=this.blendAlpha),3!==this.depthFunc&&(i.depthFunc=this.depthFunc),!1===this.depthTest&&(i.depthTest=this.depthTest),!1===this.depthWrite&&(i.depthWrite=this.depthWrite),!1===this.colorWrite&&(i.colorWrite=this.colorWrite),255!==this.stencilWriteMask&&(i.stencilWriteMask=this.stencilWriteMask),519!==this.stencilFunc&&(i.stencilFunc=this.stencilFunc),0!==this.stencilRef&&(i.stencilRef=this.stencilRef),255!==this.stencilFuncMask&&(i.stencilFuncMask=this.stencilFuncMask),this.stencilFail!==Ge&&(i.stencilFail=this.stencilFail),this.stencilZFail!==Ge&&(i.stencilZFail=this.stencilZFail),this.stencilZPass!==Ge&&(i.stencilZPass=this.stencilZPass),!0===this.stencilWrite&&(i.stencilWrite=this.stencilWrite),void 0!==this.rotation&&0!==this.rotation&&(i.rotation=this.rotation),!0===this.polygonOffset&&(i.polygonOffset=!0),0!==this.polygonOffsetFactor&&(i.polygonOffsetFactor=this.polygonOffsetFactor),0!==this.polygonOffsetUnits&&(i.polygonOffsetUnits=this.polygonOffsetUnits),void 0!==this.linewidth&&1!==this.linewidth&&(i.linewidth=this.linewidth),void 0!==this.dashSize&&(i.dashSize=this.dashSize),void 0!==this.gapSize&&(i.gapSize=this.gapSize),void 0!==this.scale&&(i.scale=this.scale),!0===this.dithering&&(i.dithering=!0),this.alphaTest>0&&(i.alphaTest=this.alphaTest),!0===this.alphaHash&&(i.alphaHash=!0),!0===this.alphaToCoverage&&(i.alphaToCoverage=!0),!0===this.premultipliedAlpha&&(i.premultipliedAlpha=!0),!0===this.forceSinglePass&&(i.forceSinglePass=!0),!0===this.wireframe&&(i.wireframe=!0),this.wireframeLinewidth>1&&(i.wireframeLinewidth=this.wireframeLinewidth),"round"!==this.wireframeLinecap&&(i.wireframeLinecap=this.wireframeLinecap),"round"!==this.wireframeLinejoin&&(i.wireframeLinejoin=this.wireframeLinejoin),!0===this.flatShading&&(i.flatShading=!0),!1===this.visible&&(i.visible=!1),!1===this.toneMapped&&(i.toneMapped=!1),!1===this.fog&&(i.fog=!1),Object.keys(this.userData).length>0&&(i.userData=this.userData),t){const t=s(e.textures),n=s(e.images);t.length>0&&(i.textures=t),n.length>0&&(i.images=n)}return i}clone(){return(new this.constructor).copy(this)}copy(e){this.name=e.name,this.blending=e.blending,this.side=e.side,this.vertexColors=e.vertexColors,this.opacity=e.opacity,this.transparent=e.transparent,this.blendSrc=e.blendSrc,this.blendDst=e.blendDst,this.blendEquation=e.blendEquation,this.blendSrcAlpha=e.blendSrcAlpha,this.blendDstAlpha=e.blendDstAlpha,this.blendEquationAlpha=e.blendEquationAlpha,this.blendColor.copy(e.blendColor),this.blendAlpha=e.blendAlpha,this.depthFunc=e.depthFunc,this.depthTest=e.depthTest,this.depthWrite=e.depthWrite,this.stencilWriteMask=e.stencilWriteMask,this.stencilFunc=e.stencilFunc,this.stencilRef=e.stencilRef,this.stencilFuncMask=e.stencilFuncMask,this.stencilFail=e.stencilFail,this.stencilZFail=e.stencilZFail,this.stencilZPass=e.stencilZPass,this.stencilWrite=e.stencilWrite;const t=e.clippingPlanes;let i=null;if(null!==t){const e=t.length;i=new Array(e);for(let s=0;s!==e;++s)i[s]=t[s].clone()}return this.clippingPlanes=i,this.clipIntersection=e.clipIntersection,this.clipShadows=e.clipShadows,this.shadowSide=e.shadowSide,this.colorWrite=e.colorWrite,this.precision=e.precision,this.polygonOffset=e.polygonOffset,this.polygonOffsetFactor=e.polygonOffsetFactor,this.polygonOffsetUnits=e.polygonOffsetUnits,this.dithering=e.dithering,this.alphaTest=e.alphaTest,this.alphaHash=e.alphaHash,this.alphaToCoverage=e.alphaToCoverage,this.premultipliedAlpha=e.premultipliedAlpha,this.forceSinglePass=e.forceSinglePass,this.visible=e.visible,this.toneMapped=e.toneMapped,this.userData=JSON.parse(JSON.stringify(e.userData)),this}dispose(){this.dispatchEvent({type:"dispose"})}set needsUpdate(e){!0===e&&this.version++}}class ps extends hs{constructor(e){super(),this.isMeshBasicMaterial=!0,this.type="MeshBasicMaterial",this.color=new ls(16777215),this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.specularMap=null,this.alphaMap=null,this.envMap=null,this.envMapRotation=new Mi,this.combine=0,this.reflectivity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.fog=!0,this.setValues(e)}copy(e){return super.copy(e),this.color.copy(e.color),this.map=e.map,this.lightMap=e.lightMap,this.lightMapIntensity=e.lightMapIntensity,this.aoMap=e.aoMap,this.aoMapIntensity=e.aoMapIntensity,this.specularMap=e.specularMap,this.alphaMap=e.alphaMap,this.envMap=e.envMap,this.envMapRotation.copy(e.envMapRotation),this.combine=e.combine,this.reflectivity=e.reflectivity,this.refractionRatio=e.refractionRatio,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.wireframeLinecap=e.wireframeLinecap,this.wireframeLinejoin=e.wireframeLinejoin,this.fog=e.fog,this}}const us=new mt,ms=new pt;let fs=0;class gs{constructor(e,t,i=!1){if(Array.isArray(e))throw new TypeError("THREE.BufferAttribute: array should be a Typed Array.");this.isBufferAttribute=!0,Object.defineProperty(this,"id",{value:fs++}),this.name="",this.array=e,this.itemSize=t,this.count=void 0!==e?e.length/t:0,this.normalized=i,this.usage=Qe,this.updateRanges=[],this.gpuType=K,this.version=0}onUploadCallback(){}set needsUpdate(e){!0===e&&this.version++}setUsage(e){return this.usage=e,this}addUpdateRange(e,t){this.updateRanges.push({start:e,count:t})}clearUpdateRanges(){this.updateRanges.length=0}copy(e){return this.name=e.name,this.array=new e.array.constructor(e.array),this.itemSize=e.itemSize,this.count=e.count,this.normalized=e.normalized,this.usage=e.usage,this.gpuType=e.gpuType,this}copyAt(e,t,i){e*=this.itemSize,i*=t.itemSize;for(let s=0,n=this.itemSize;s<n;s++)this.array[e+s]=t.array[i+s];return this}copyArray(e){return this.array.set(e),this}applyMatrix3(e){if(2===this.itemSize)for(let t=0,i=this.count;t<i;t++)ms.fromBufferAttribute(this,t),ms.applyMatrix3(e),this.setXY(t,ms.x,ms.y);else if(3===this.itemSize)for(let t=0,i=this.count;t<i;t++)us.fromBufferAttribute(this,t),us.applyMatrix3(e),this.setXYZ(t,us.x,us.y,us.z);return this}applyMatrix4(e){for(let t=0,i=this.count;t<i;t++)us.fromBufferAttribute(this,t),us.applyMatrix4(e),this.setXYZ(t,us.x,us.y,us.z);return this}applyNormalMatrix(e){for(let t=0,i=this.count;t<i;t++)us.fromBufferAttribute(this,t),us.applyNormalMatrix(e),this.setXYZ(t,us.x,us.y,us.z);return this}transformDirection(e){for(let t=0,i=this.count;t<i;t++)us.fromBufferAttribute(this,t),us.transformDirection(e),this.setXYZ(t,us.x,us.y,us.z);return this}set(e,t=0){return this.array.set(e,t),this}getComponent(e,t){let i=this.array[e*this.itemSize+t];return this.normalized&&(i=ct(i,this.array)),i}setComponent(e,t,i){return this.normalized&&(i=ht(i,this.array)),this.array[e*this.itemSize+t]=i,this}getX(e){let t=this.array[e*this.itemSize];return this.normalized&&(t=ct(t,this.array)),t}setX(e,t){return this.normalized&&(t=ht(t,this.array)),this.array[e*this.itemSize]=t,this}getY(e){let t=this.array[e*this.itemSize+1];return this.normalized&&(t=ct(t,this.array)),t}setY(e,t){return this.normalized&&(t=ht(t,this.array)),this.array[e*this.itemSize+1]=t,this}getZ(e){let t=this.array[e*this.itemSize+2];return this.normalized&&(t=ct(t,this.array)),t}setZ(e,t){return this.normalized&&(t=ht(t,this.array)),this.array[e*this.itemSize+2]=t,this}getW(e){let t=this.array[e*this.itemSize+3];return this.normalized&&(t=ct(t,this.array)),t}setW(e,t){return this.normalized&&(t=ht(t,this.array)),this.array[e*this.itemSize+3]=t,this}setXY(e,t,i){return e*=this.itemSize,this.normalized&&(t=ht(t,this.array),i=ht(i,this.array)),this.array[e+0]=t,this.array[e+1]=i,this}setXYZ(e,t,i,s){return e*=this.itemSize,this.normalized&&(t=ht(t,this.array),i=ht(i,this.array),s=ht(s,this.array)),this.array[e+0]=t,this.array[e+1]=i,this.array[e+2]=s,this}setXYZW(e,t,i,s,n){return e*=this.itemSize,this.normalized&&(t=ht(t,this.array),i=ht(i,this.array),s=ht(s,this.array),n=ht(n,this.array)),this.array[e+0]=t,this.array[e+1]=i,this.array[e+2]=s,this.array[e+3]=n,this}onUpload(e){return this.onUploadCallback=e,this}clone(){return new this.constructor(this.array,this.itemSize).copy(this)}toJSON(){const e={itemSize:this.itemSize,type:this.array.constructor.name,array:Array.from(this.array),normalized:this.normalized};return""!==this.name&&(e.name=this.name),this.usage!==Qe&&(e.usage=this.usage),e}}class bs extends gs{constructor(e,t,i){super(new Uint16Array(e),t,i)}}class Cs extends gs{constructor(e,t,i){super(new Uint32Array(e),t,i)}}class vs extends gs{constructor(e,t,i){super(new Float32Array(e),t,i)}}let _s=0;const ys=new gi,Ss=new ji,ws=new mt,xs=new jt,As=new jt,Ms=new mt;class Ts extends st{constructor(){super(),this.isBufferGeometry=!0,Object.defineProperty(this,"id",{value:_s++}),this.uuid=ot(),this.name="",this.type="BufferGeometry",this.index=null,this.indirect=null,this.attributes={},this.morphAttributes={},this.morphTargetsRelative=!1,this.groups=[],this.boundingBox=null,this.boundingSphere=null,this.drawRange={start:0,count:1/0},this.userData={}}getIndex(){return this.index}setIndex(e){return Array.isArray(e)?this.index=new(vt(e)?Cs:bs)(e,1):this.index=e,this}setIndirect(e){return this.indirect=e,this}getIndirect(){return this.indirect}getAttribute(e){return this.attributes[e]}setAttribute(e,t){return this.attributes[e]=t,this}deleteAttribute(e){return delete this.attributes[e],this}hasAttribute(e){return void 0!==this.attributes[e]}addGroup(e,t,i=0){this.groups.push({start:e,count:t,materialIndex:i})}clearGroups(){this.groups=[]}setDrawRange(e,t){this.drawRange.start=e,this.drawRange.count=t}applyMatrix4(e){const t=this.attributes.position;void 0!==t&&(t.applyMatrix4(e),t.needsUpdate=!0);const i=this.attributes.normal;if(void 0!==i){const t=(new bt).getNormalMatrix(e);i.applyNormalMatrix(t),i.needsUpdate=!0}const s=this.attributes.tangent;return void 0!==s&&(s.transformDirection(e),s.needsUpdate=!0),null!==this.boundingBox&&this.computeBoundingBox(),null!==this.boundingSphere&&this.computeBoundingSphere(),this}applyQuaternion(e){return ys.makeRotationFromQuaternion(e),this.applyMatrix4(ys),this}rotateX(e){return ys.makeRotationX(e),this.applyMatrix4(ys),this}rotateY(e){return ys.makeRotationY(e),this.applyMatrix4(ys),this}rotateZ(e){return ys.makeRotationZ(e),this.applyMatrix4(ys),this}translate(e,t,i){return ys.makeTranslation(e,t,i),this.applyMatrix4(ys),this}scale(e,t,i){return ys.makeScale(e,t,i),this.applyMatrix4(ys),this}lookAt(e){return Ss.lookAt(e),Ss.updateMatrix(),this.applyMatrix4(Ss.matrix),this}center(){return this.computeBoundingBox(),this.boundingBox.getCenter(ws).negate(),this.translate(ws.x,ws.y,ws.z),this}setFromPoints(e){const t=this.getAttribute("position");if(void 0===t){const t=[];for(let i=0,s=e.length;i<s;i++){const s=e[i];t.push(s.x,s.y,s.z||0)}this.setAttribute("position",new vs(t,3))}else{const i=Math.min(e.length,t.count);for(let s=0;s<i;s++){const i=e[s];t.setXYZ(s,i.x,i.y,i.z||0)}e.length>t.count&&console.warn("THREE.BufferGeometry: Buffer size too small for points data. Use .dispose() and create a new geometry."),t.needsUpdate=!0}return this}computeBoundingBox(){null===this.boundingBox&&(this.boundingBox=new jt);const e=this.attributes.position,t=this.morphAttributes.position;if(e&&e.isGLBufferAttribute)return console.error("THREE.BufferGeometry.computeBoundingBox(): GLBufferAttribute requires a manual bounding box.",this),void this.boundingBox.set(new mt(-1/0,-1/0,-1/0),new mt(1/0,1/0,1/0));if(void 0!==e){if(this.boundingBox.setFromBufferAttribute(e),t)for(let e=0,i=t.length;e<i;e++){const i=t[e];xs.setFromBufferAttribute(i),this.morphTargetsRelative?(Ms.addVectors(this.boundingBox.min,xs.min),this.boundingBox.expandByPoint(Ms),Ms.addVectors(this.boundingBox.max,xs.max),this.boundingBox.expandByPoint(Ms)):(this.boundingBox.expandByPoint(xs.min),this.boundingBox.expandByPoint(xs.max))}}else this.boundingBox.makeEmpty();(isNaN(this.boundingBox.min.x)||isNaN(this.boundingBox.min.y)||isNaN(this.boundingBox.min.z))&&console.error('THREE.BufferGeometry.computeBoundingBox(): Computed min/max have NaN values. The "position" attribute is likely to have NaN values.',this)}computeBoundingSphere(){null===this.boundingSphere&&(this.boundingSphere=new oi);const e=this.attributes.position,t=this.morphAttributes.position;if(e&&e.isGLBufferAttribute)return console.error("THREE.BufferGeometry.computeBoundingSphere(): GLBufferAttribute requires a manual bounding sphere.",this),void this.boundingSphere.set(new mt,1/0);if(e){const i=this.boundingSphere.center;if(xs.setFromBufferAttribute(e),t)for(let e=0,i=t.length;e<i;e++){const i=t[e];As.setFromBufferAttribute(i),this.morphTargetsRelative?(Ms.addVectors(xs.min,As.min),xs.expandByPoint(Ms),Ms.addVectors(xs.max,As.max),xs.expandByPoint(Ms)):(xs.expandByPoint(As.min),xs.expandByPoint(As.max))}xs.getCenter(i);let s=0;for(let t=0,n=e.count;t<n;t++)Ms.fromBufferAttribute(e,t),s=Math.max(s,i.distanceToSquared(Ms));if(t)for(let n=0,r=t.length;n<r;n++){const r=t[n],a=this.morphTargetsRelative;for(let t=0,n=r.count;t<n;t++)Ms.fromBufferAttribute(r,t),a&&(ws.fromBufferAttribute(e,t),Ms.add(ws)),s=Math.max(s,i.distanceToSquared(Ms))}this.boundingSphere.radius=Math.sqrt(s),isNaN(this.boundingSphere.radius)&&console.error('THREE.BufferGeometry.computeBoundingSphere(): Computed radius is NaN. The "position" attribute is likely to have NaN values.',this)}}computeTangents(){const e=this.index,t=this.attributes;if(null===e||void 0===t.position||void 0===t.normal||void 0===t.uv)return void console.error("THREE.BufferGeometry: .computeTangents() failed. Missing required attributes (index, position, normal or uv)");const i=t.position,s=t.normal,n=t.uv;!1===this.hasAttribute("tangent")&&this.setAttribute("tangent",new gs(new Float32Array(4*i.count),4));const r=this.getAttribute("tangent"),a=[],o=[];for(let e=0;e<i.count;e++)a[e]=new mt,o[e]=new mt;const l=new mt,d=new mt,c=new mt,h=new pt,p=new pt,u=new pt,m=new mt,f=new mt;function g(e,t,s){l.fromBufferAttribute(i,e),d.fromBufferAttribute(i,t),c.fromBufferAttribute(i,s),h.fromBufferAttribute(n,e),p.fromBufferAttribute(n,t),u.fromBufferAttribute(n,s),d.sub(l),c.sub(l),p.sub(h),u.sub(h);const r=1/(p.x*u.y-u.x*p.y);isFinite(r)&&(m.copy(d).multiplyScalar(u.y).addScaledVector(c,-p.y).multiplyScalar(r),f.copy(c).multiplyScalar(p.x).addScaledVector(d,-u.x).multiplyScalar(r),a[e].add(m),a[t].add(m),a[s].add(m),o[e].add(f),o[t].add(f),o[s].add(f))}let b=this.groups;0===b.length&&(b=[{start:0,count:e.count}]);for(let t=0,i=b.length;t<i;++t){const i=b[t],s=i.start;for(let t=s,n=s+i.count;t<n;t+=3)g(e.getX(t+0),e.getX(t+1),e.getX(t+2))}const C=new mt,v=new mt,_=new mt,y=new mt;function S(e){_.fromBufferAttribute(s,e),y.copy(_);const t=a[e];C.copy(t),C.sub(_.multiplyScalar(_.dot(t))).normalize(),v.crossVectors(y,t);const i=v.dot(o[e])<0?-1:1;r.setXYZW(e,C.x,C.y,C.z,i)}for(let t=0,i=b.length;t<i;++t){const i=b[t],s=i.start;for(let t=s,n=s+i.count;t<n;t+=3)S(e.getX(t+0)),S(e.getX(t+1)),S(e.getX(t+2))}}computeVertexNormals(){const e=this.index,t=this.getAttribute("position");if(void 0!==t){let i=this.getAttribute("normal");if(void 0===i)i=new gs(new Float32Array(3*t.count),3),this.setAttribute("normal",i);else for(let e=0,t=i.count;e<t;e++)i.setXYZ(e,0,0,0);const s=new mt,n=new mt,r=new mt,a=new mt,o=new mt,l=new mt,d=new mt,c=new mt;if(e)for(let h=0,p=e.count;h<p;h+=3){const p=e.getX(h+0),u=e.getX(h+1),m=e.getX(h+2);s.fromBufferAttribute(t,p),n.fromBufferAttribute(t,u),r.fromBufferAttribute(t,m),d.subVectors(r,n),c.subVectors(s,n),d.cross(c),a.fromBufferAttribute(i,p),o.fromBufferAttribute(i,u),l.fromBufferAttribute(i,m),a.add(d),o.add(d),l.add(d),i.setXYZ(p,a.x,a.y,a.z),i.setXYZ(u,o.x,o.y,o.z),i.setXYZ(m,l.x,l.y,l.z)}else for(let e=0,a=t.count;e<a;e+=3)s.fromBufferAttribute(t,e+0),n.fromBufferAttribute(t,e+1),r.fromBufferAttribute(t,e+2),d.subVectors(r,n),c.subVectors(s,n),d.cross(c),i.setXYZ(e+0,d.x,d.y,d.z),i.setXYZ(e+1,d.x,d.y,d.z),i.setXYZ(e+2,d.x,d.y,d.z);this.normalizeNormals(),i.needsUpdate=!0}}normalizeNormals(){const e=this.attributes.normal;for(let t=0,i=e.count;t<i;t++)Ms.fromBufferAttribute(e,t),Ms.normalize(),e.setXYZ(t,Ms.x,Ms.y,Ms.z)}toNonIndexed(){function e(e,t){const i=e.array,s=e.itemSize,n=e.normalized,r=new i.constructor(t.length*s);let a=0,o=0;for(let n=0,l=t.length;n<l;n++){a=e.isInterleavedBufferAttribute?t[n]*e.data.stride+e.offset:t[n]*s;for(let e=0;e<s;e++)r[o++]=i[a++]}return new gs(r,s,n)}if(null===this.index)return console.warn("THREE.BufferGeometry.toNonIndexed(): BufferGeometry is already non-indexed."),this;const t=new Ts,i=this.index.array,s=this.attributes;for(const n in s){const r=e(s[n],i);t.setAttribute(n,r)}const n=this.morphAttributes;for(const s in n){const r=[],a=n[s];for(let t=0,s=a.length;t<s;t++){const s=e(a[t],i);r.push(s)}t.morphAttributes[s]=r}t.morphTargetsRelative=this.morphTargetsRelative;const r=this.groups;for(let e=0,i=r.length;e<i;e++){const i=r[e];t.addGroup(i.start,i.count,i.materialIndex)}return t}toJSON(){const e={metadata:{version:4.7,type:"BufferGeometry",generator:"BufferGeometry.toJSON"}};if(e.uuid=this.uuid,e.type=this.type,""!==this.name&&(e.name=this.name),Object.keys(this.userData).length>0&&(e.userData=this.userData),void 0!==this.parameters){const t=this.parameters;for(const i in t)void 0!==t[i]&&(e[i]=t[i]);return e}e.data={attributes:{}};const t=this.index;null!==t&&(e.data.index={type:t.array.constructor.name,array:Array.prototype.slice.call(t.array)});const i=this.attributes;for(const t in i){const s=i[t];e.data.attributes[t]=s.toJSON(e.data)}const s={};let n=!1;for(const t in this.morphAttributes){const i=this.morphAttributes[t],r=[];for(let t=0,s=i.length;t<s;t++){const s=i[t];r.push(s.toJSON(e.data))}r.length>0&&(s[t]=r,n=!0)}n&&(e.data.morphAttributes=s,e.data.morphTargetsRelative=this.morphTargetsRelative);const r=this.groups;r.length>0&&(e.data.groups=JSON.parse(JSON.stringify(r)));const a=this.boundingSphere;return null!==a&&(e.data.boundingSphere=a.toJSON()),e}clone(){return(new this.constructor).copy(this)}copy(e){this.index=null,this.attributes={},this.morphAttributes={},this.groups=[],this.boundingBox=null,this.boundingSphere=null;const t={};this.name=e.name;const i=e.index;null!==i&&this.setIndex(i.clone());const s=e.attributes;for(const e in s){const i=s[e];this.setAttribute(e,i.clone(t))}const n=e.morphAttributes;for(const e in n){const i=[],s=n[e];for(let e=0,n=s.length;e<n;e++)i.push(s[e].clone(t));this.morphAttributes[e]=i}this.morphTargetsRelative=e.morphTargetsRelative;const r=e.groups;for(let e=0,t=r.length;e<t;e++){const t=r[e];this.addGroup(t.start,t.count,t.materialIndex)}const a=e.boundingBox;null!==a&&(this.boundingBox=a.clone());const o=e.boundingSphere;return null!==o&&(this.boundingSphere=o.clone()),this.drawRange.start=e.drawRange.start,this.drawRange.count=e.drawRange.count,this.userData=e.userData,this}dispose(){this.dispatchEvent({type:"dispose"})}}const Es=new gi,Rs=new fi,ks=new oi,Os=new mt,Is=new mt,Ps=new mt,Ds=new mt,Ls=new mt,Fs=new mt,Ns=new mt,Us=new mt;class Hs extends ji{constructor(e=new Ts,t=new ps){super(),this.isMesh=!0,this.type="Mesh",this.geometry=e,this.material=t,this.morphTargetDictionary=void 0,this.morphTargetInfluences=void 0,this.count=1,this.updateMorphTargets()}copy(e,t){return super.copy(e,t),void 0!==e.morphTargetInfluences&&(this.morphTargetInfluences=e.morphTargetInfluences.slice()),void 0!==e.morphTargetDictionary&&(this.morphTargetDictionary=Object.assign({},e.morphTargetDictionary)),this.material=Array.isArray(e.material)?e.material.slice():e.material,this.geometry=e.geometry,this}updateMorphTargets(){const e=this.geometry.morphAttributes,t=Object.keys(e);if(t.length>0){const i=e[t[0]];if(void 0!==i){this.morphTargetInfluences=[],this.morphTargetDictionary={};for(let e=0,t=i.length;e<t;e++){const t=i[e].name||String(e);this.morphTargetInfluences.push(0),this.morphTargetDictionary[t]=e}}}}getVertexPosition(e,t){const i=this.geometry,s=i.attributes.position,n=i.morphAttributes.position,r=i.morphTargetsRelative;t.fromBufferAttribute(s,e);const a=this.morphTargetInfluences;if(n&&a){Fs.set(0,0,0);for(let i=0,s=n.length;i<s;i++){const s=a[i],o=n[i];0!==s&&(Ls.fromBufferAttribute(o,e),r?Fs.addScaledVector(Ls,s):Fs.addScaledVector(Ls.sub(t),s))}t.add(Fs)}return t}raycast(e,t){const i=this.geometry,s=this.material,n=this.matrixWorld;if(void 0!==s){if(null===i.boundingSphere&&i.computeBoundingSphere(),ks.copy(i.boundingSphere),ks.applyMatrix4(n),Rs.copy(e.ray).recast(e.near),!1===ks.containsPoint(Rs.origin)){if(null===Rs.intersectSphere(ks,Os))return;if(Rs.origin.distanceToSquared(Os)>(e.far-e.near)**2)return}Es.copy(n).invert(),Rs.copy(e.ray).applyMatrix4(Es),null!==i.boundingBox&&!1===Rs.intersectsBox(i.boundingBox)||this._computeIntersections(e,t,Rs)}}_computeIntersections(e,t,i){let s;const n=this.geometry,r=this.material,a=n.index,o=n.attributes.position,l=n.attributes.uv,d=n.attributes.uv1,c=n.attributes.normal,h=n.groups,p=n.drawRange;if(null!==a)if(Array.isArray(r))for(let n=0,o=h.length;n<o;n++){const o=h[n],u=r[o.materialIndex];for(let n=Math.max(o.start,p.start),r=Math.min(a.count,Math.min(o.start+o.count,p.start+p.count));n<r;n+=3){s=Bs(this,u,e,i,l,d,c,a.getX(n),a.getX(n+1),a.getX(n+2)),s&&(s.faceIndex=Math.floor(n/3),s.face.materialIndex=o.materialIndex,t.push(s))}}else{for(let n=Math.max(0,p.start),o=Math.min(a.count,p.start+p.count);n<o;n+=3){s=Bs(this,r,e,i,l,d,c,a.getX(n),a.getX(n+1),a.getX(n+2)),s&&(s.faceIndex=Math.floor(n/3),t.push(s))}}else if(void 0!==o)if(Array.isArray(r))for(let n=0,a=h.length;n<a;n++){const a=h[n],u=r[a.materialIndex];for(let n=Math.max(a.start,p.start),r=Math.min(o.count,Math.min(a.start+a.count,p.start+p.count));n<r;n+=3){s=Bs(this,u,e,i,l,d,c,n,n+1,n+2),s&&(s.faceIndex=Math.floor(n/3),s.face.materialIndex=a.materialIndex,t.push(s))}}else{for(let n=Math.max(0,p.start),a=Math.min(o.count,p.start+p.count);n<a;n+=3){s=Bs(this,r,e,i,l,d,c,n,n+1,n+2),s&&(s.faceIndex=Math.floor(n/3),t.push(s))}}}}function Bs(e,t,i,s,n,r,a,o,l,d){e.getVertexPosition(o,Is),e.getVertexPosition(l,Ps),e.getVertexPosition(d,Ds);const c=function(e,t,i,s,n,r,a,o){let l;if(l=1===t.side?s.intersectTriangle(a,r,n,!0,o):s.intersectTriangle(n,r,a,0===t.side,o),null===l)return null;Us.copy(o),Us.applyMatrix4(e.matrixWorld);const d=i.ray.origin.distanceTo(Us);return d<i.near||d>i.far?null:{distance:d,point:Us.clone(),object:e}}(e,t,i,s,Is,Ps,Ds,Ns);if(c){const e=new mt;ss.getBarycoord(Ns,Is,Ps,Ds,e),n&&(c.uv=ss.getInterpolatedAttribute(n,o,l,d,e,new pt)),r&&(c.uv1=ss.getInterpolatedAttribute(r,o,l,d,e,new pt)),a&&(c.normal=ss.getInterpolatedAttribute(a,o,l,d,e,new mt),c.normal.dot(s.direction)>0&&c.normal.multiplyScalar(-1));const t={a:o,b:l,c:d,normal:new mt,materialIndex:0};ss.getNormal(Is,Ps,Ds,t.normal),c.face=t,c.barycoord=e}return c}class zs extends Ts{constructor(e=1,t=1,i=1,s=1,n=1,r=1){super(),this.type="BoxGeometry",this.parameters={width:e,height:t,depth:i,widthSegments:s,heightSegments:n,depthSegments:r};const a=this;s=Math.floor(s),n=Math.floor(n),r=Math.floor(r);const o=[],l=[],d=[],c=[];let h=0,p=0;function u(e,t,i,s,n,r,u,m,f,g,b){const C=r/f,v=u/g,_=r/2,y=u/2,S=m/2,w=f+1,x=g+1;let A=0,M=0;const T=new mt;for(let r=0;r<x;r++){const a=r*v-y;for(let o=0;o<w;o++){const h=o*C-_;T[e]=h*s,T[t]=a*n,T[i]=S,l.push(T.x,T.y,T.z),T[e]=0,T[t]=0,T[i]=m>0?1:-1,d.push(T.x,T.y,T.z),c.push(o/f),c.push(1-r/g),A+=1}}for(let e=0;e<g;e++)for(let t=0;t<f;t++){const i=h+t+w*e,s=h+t+w*(e+1),n=h+(t+1)+w*(e+1),r=h+(t+1)+w*e;o.push(i,s,r),o.push(s,n,r),M+=6}a.addGroup(p,M,b),p+=M,h+=A}u("z","y","x",-1,-1,i,t,e,r,n,0),u("z","y","x",1,-1,i,t,-e,r,n,1),u("x","z","y",1,1,e,i,t,s,r,2),u("x","z","y",1,-1,e,i,-t,s,r,3),u("x","y","z",1,-1,e,t,i,s,n,4),u("x","y","z",-1,-1,e,t,-i,s,n,5),this.setIndex(o),this.setAttribute("position",new vs(l,3)),this.setAttribute("normal",new vs(d,3)),this.setAttribute("uv",new vs(c,2))}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}static fromJSON(e){return new zs(e.width,e.height,e.depth,e.widthSegments,e.heightSegments,e.depthSegments)}}function qs(e){const t={};for(const i in e){t[i]={};for(const s in e[i]){const n=e[i][s];n&&(n.isColor||n.isMatrix3||n.isMatrix4||n.isVector2||n.isVector3||n.isVector4||n.isTexture||n.isQuaternion)?n.isRenderTargetTexture?(console.warn("UniformsUtils: Textures of render targets cannot be cloned via cloneUniforms() or mergeUniforms()."),t[i][s]=null):t[i][s]=n.clone():Array.isArray(n)?t[i][s]=n.slice():t[i][s]=n}}return t}function js(e){const t={};for(let i=0;i<e.length;i++){const s=qs(e[i]);for(const e in s)t[e]=s[e]}return t}function Gs(e){const t=e.getRenderTarget();return null===t?e.outputColorSpace:!0===t.isXRRenderTarget?t.texture.colorSpace:Tt.workingColorSpace}const $s={clone:qs,merge:js};class Vs extends hs{constructor(e){super(),this.isShaderMaterial=!0,this.type="ShaderMaterial",this.defines={},this.uniforms={},this.uniformsGroups=[],this.vertexShader="void main() {\n\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n}",this.fragmentShader="void main() {\n\tgl_FragColor = vec4( 1.0, 0.0, 0.0, 1.0 );\n}",this.linewidth=1,this.wireframe=!1,this.wireframeLinewidth=1,this.fog=!1,this.lights=!1,this.clipping=!1,this.forceSinglePass=!0,this.extensions={clipCullDistance:!1,multiDraw:!1},this.defaultAttributeValues={color:[1,1,1],uv:[0,0],uv1:[0,0]},this.index0AttributeName=void 0,this.uniformsNeedUpdate=!1,this.glslVersion=null,void 0!==e&&this.setValues(e)}copy(e){return super.copy(e),this.fragmentShader=e.fragmentShader,this.vertexShader=e.vertexShader,this.uniforms=qs(e.uniforms),this.uniformsGroups=function(e){const t=[];for(let i=0;i<e.length;i++)t.push(e[i].clone());return t}(e.uniformsGroups),this.defines=Object.assign({},e.defines),this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.fog=e.fog,this.lights=e.lights,this.clipping=e.clipping,this.extensions=Object.assign({},e.extensions),this.glslVersion=e.glslVersion,this}toJSON(e){const t=super.toJSON(e);t.glslVersion=this.glslVersion,t.uniforms={};for(const i in this.uniforms){const s=this.uniforms[i].value;s&&s.isTexture?t.uniforms[i]={type:"t",value:s.toJSON(e).uuid}:s&&s.isColor?t.uniforms[i]={type:"c",value:s.getHex()}:s&&s.isVector2?t.uniforms[i]={type:"v2",value:s.toArray()}:s&&s.isVector3?t.uniforms[i]={type:"v3",value:s.toArray()}:s&&s.isVector4?t.uniforms[i]={type:"v4",value:s.toArray()}:s&&s.isMatrix3?t.uniforms[i]={type:"m3",value:s.toArray()}:s&&s.isMatrix4?t.uniforms[i]={type:"m4",value:s.toArray()}:t.uniforms[i]={value:s}}Object.keys(this.defines).length>0&&(t.defines=this.defines),t.vertexShader=this.vertexShader,t.fragmentShader=this.fragmentShader,t.lights=this.lights,t.clipping=this.clipping;const i={};for(const e in this.extensions)!0===this.extensions[e]&&(i[e]=!0);return Object.keys(i).length>0&&(t.extensions=i),t}}class Ws extends ji{constructor(){super(),this.isCamera=!0,this.type="Camera",this.matrixWorldInverse=new gi,this.projectionMatrix=new gi,this.projectionMatrixInverse=new gi,this.coordinateSystem=tt}copy(e,t){return super.copy(e,t),this.matrixWorldInverse.copy(e.matrixWorldInverse),this.projectionMatrix.copy(e.projectionMatrix),this.projectionMatrixInverse.copy(e.projectionMatrixInverse),this.coordinateSystem=e.coordinateSystem,this}getWorldDirection(e){return super.getWorldDirection(e).negate()}updateMatrixWorld(e){super.updateMatrixWorld(e),this.matrixWorldInverse.copy(this.matrixWorld).invert()}updateWorldMatrix(e,t){super.updateWorldMatrix(e,t),this.matrixWorldInverse.copy(this.matrixWorld).invert()}clone(){return(new this.constructor).copy(this)}}const Xs=new mt,Ys=new pt,Ks=new pt;class Zs extends Ws{constructor(e=50,t=1,i=.1,s=2e3){super(),this.isPerspectiveCamera=!0,this.type="PerspectiveCamera",this.fov=e,this.zoom=1,this.near=i,this.far=s,this.focus=10,this.aspect=t,this.view=null,this.filmGauge=35,this.filmOffset=0,this.updateProjectionMatrix()}copy(e,t){return super.copy(e,t),this.fov=e.fov,this.zoom=e.zoom,this.near=e.near,this.far=e.far,this.focus=e.focus,this.aspect=e.aspect,this.view=null===e.view?null:Object.assign({},e.view),this.filmGauge=e.filmGauge,this.filmOffset=e.filmOffset,this}setFocalLength(e){const t=.5*this.getFilmHeight()/e;this.fov=2*at*Math.atan(t),this.updateProjectionMatrix()}getFocalLength(){const e=Math.tan(.5*rt*this.fov);return.5*this.getFilmHeight()/e}getEffectiveFOV(){return 2*at*Math.atan(Math.tan(.5*rt*this.fov)/this.zoom)}getFilmWidth(){return this.filmGauge*Math.min(this.aspect,1)}getFilmHeight(){return this.filmGauge/Math.max(this.aspect,1)}getViewBounds(e,t,i){Xs.set(-1,-1,.5).applyMatrix4(this.projectionMatrixInverse),t.set(Xs.x,Xs.y).multiplyScalar(-e/Xs.z),Xs.set(1,1,.5).applyMatrix4(this.projectionMatrixInverse),i.set(Xs.x,Xs.y).multiplyScalar(-e/Xs.z)}getViewSize(e,t){return this.getViewBounds(e,Ys,Ks),t.subVectors(Ks,Ys)}setViewOffset(e,t,i,s,n,r){this.aspect=e/t,null===this.view&&(this.view={enabled:!0,fullWidth:1,fullHeight:1,offsetX:0,offsetY:0,width:1,height:1}),this.view.enabled=!0,this.view.fullWidth=e,this.view.fullHeight=t,this.view.offsetX=i,this.view.offsetY=s,this.view.width=n,this.view.height=r,this.updateProjectionMatrix()}clearViewOffset(){null!==this.view&&(this.view.enabled=!1),this.updateProjectionMatrix()}updateProjectionMatrix(){const e=this.near;let t=e*Math.tan(.5*rt*this.fov)/this.zoom,i=2*t,s=this.aspect*i,n=-.5*s;const r=this.view;if(null!==this.view&&this.view.enabled){const e=r.fullWidth,a=r.fullHeight;n+=r.offsetX*s/e,t-=r.offsetY*i/a,s*=r.width/e,i*=r.height/a}const a=this.filmOffset;0!==a&&(n+=e*a/this.getFilmWidth()),this.projectionMatrix.makePerspective(n,n+s,t,t-i,e,this.far,this.coordinateSystem),this.projectionMatrixInverse.copy(this.projectionMatrix).invert()}toJSON(e){const t=super.toJSON(e);return t.object.fov=this.fov,t.object.zoom=this.zoom,t.object.near=this.near,t.object.far=this.far,t.object.focus=this.focus,t.object.aspect=this.aspect,null!==this.view&&(t.object.view=Object.assign({},this.view)),t.object.filmGauge=this.filmGauge,t.object.filmOffset=this.filmOffset,t}}const Js=-90;class Qs extends ji{constructor(e,t,i){super(),this.type="CubeCamera",this.renderTarget=i,this.coordinateSystem=null,this.activeMipmapLevel=0;const s=new Zs(Js,1,e,t);s.layers=this.layers,this.add(s);const n=new Zs(Js,1,e,t);n.layers=this.layers,this.add(n);const r=new Zs(Js,1,e,t);r.layers=this.layers,this.add(r);const a=new Zs(Js,1,e,t);a.layers=this.layers,this.add(a);const o=new Zs(Js,1,e,t);o.layers=this.layers,this.add(o);const l=new Zs(Js,1,e,t);l.layers=this.layers,this.add(l)}updateCoordinateSystem(){const e=this.coordinateSystem,t=this.children.concat(),[i,s,n,r,a,o]=t;for(const e of t)this.remove(e);if(e===tt)i.up.set(0,1,0),i.lookAt(1,0,0),s.up.set(0,1,0),s.lookAt(-1,0,0),n.up.set(0,0,-1),n.lookAt(0,1,0),r.up.set(0,0,1),r.lookAt(0,-1,0),a.up.set(0,1,0),a.lookAt(0,0,1),o.up.set(0,1,0),o.lookAt(0,0,-1);else{if(e!==it)throw new Error("THREE.CubeCamera.updateCoordinateSystem(): Invalid coordinate system: "+e);i.up.set(0,-1,0),i.lookAt(-1,0,0),s.up.set(0,-1,0),s.lookAt(1,0,0),n.up.set(0,0,1),n.lookAt(0,1,0),r.up.set(0,0,-1),r.lookAt(0,-1,0),a.up.set(0,-1,0),a.lookAt(0,0,1),o.up.set(0,-1,0),o.lookAt(0,0,-1)}for(const e of t)this.add(e),e.updateMatrixWorld()}update(e,t){null===this.parent&&this.updateMatrixWorld();const{renderTarget:i,activeMipmapLevel:s}=this;this.coordinateSystem!==e.coordinateSystem&&(this.coordinateSystem=e.coordinateSystem,this.updateCoordinateSystem());const[n,r,a,o,l,d]=this.children,c=e.getRenderTarget(),h=e.getActiveCubeFace(),p=e.getActiveMipmapLevel(),u=e.xr.enabled;e.xr.enabled=!1;const m=i.texture.generateMipmaps;i.texture.generateMipmaps=!1,e.setRenderTarget(i,0,s),e.render(t,n),e.setRenderTarget(i,1,s),e.render(t,r),e.setRenderTarget(i,2,s),e.render(t,a),e.setRenderTarget(i,3,s),e.render(t,o),e.setRenderTarget(i,4,s),e.render(t,l),i.texture.generateMipmaps=m,e.setRenderTarget(i,5,s),e.render(t,d),e.setRenderTarget(c,h,p),e.xr.enabled=u,i.texture.needsPMREMUpdate=!0}}class en extends Nt{constructor(e=[],t=301,i,s,n,r,a,o,l,d){super(e,t,i,s,n,r,a,o,l,d),this.isCubeTexture=!0,this.flipY=!1}get images(){return this.image}set images(e){this.image=e}}class tn extends Bt{constructor(e=1,t={}){super(e,e,t),this.isWebGLCubeRenderTarget=!0;const i={width:e,height:e,depth:1},s=[i,i,i,i,i,i];this.texture=new en(s),this._setTextureOptions(t),this.texture.isRenderTargetTexture=!0}fromEquirectangularTexture(e,t){this.texture.type=t.type,this.texture.colorSpace=t.colorSpace,this.texture.generateMipmaps=t.generateMipmaps,this.texture.minFilter=t.minFilter,this.texture.magFilter=t.magFilter;const i={uniforms:{tEquirect:{value:null}},vertexShader:"\n\n\t\t\t\tvarying vec3 vWorldDirection;\n\n\t\t\t\tvec3 transformDirection( in vec3 dir, in mat4 matrix ) {\n\n\t\t\t\t\treturn normalize( ( matrix * vec4( dir, 0.0 ) ).xyz );\n\n\t\t\t\t}\n\n\t\t\t\tvoid main() {\n\n\t\t\t\t\tvWorldDirection = transformDirection( position, modelMatrix );\n\n\t\t\t\t\t#include <begin_vertex>\n\t\t\t\t\t#include <project_vertex>\n\n\t\t\t\t}\n\t\t\t",fragmentShader:"\n\n\t\t\t\tuniform sampler2D tEquirect;\n\n\t\t\t\tvarying vec3 vWorldDirection;\n\n\t\t\t\t#include <common>\n\n\t\t\t\tvoid main() {\n\n\t\t\t\t\tvec3 direction = normalize( vWorldDirection );\n\n\t\t\t\t\tvec2 sampleUV = equirectUv( direction );\n\n\t\t\t\t\tgl_FragColor = texture2D( tEquirect, sampleUV );\n\n\t\t\t\t}\n\t\t\t"},s=new zs(5,5,5),n=new Vs({name:"CubemapFromEquirect",uniforms:qs(i.uniforms),vertexShader:i.vertexShader,fragmentShader:i.fragmentShader,side:1,blending:0});n.uniforms.tEquirect.value=t;const r=new Hs(s,n),a=t.minFilter;t.minFilter===q&&(t.minFilter=B);return new Qs(1,10,this).update(e,r),t.minFilter=a,r.geometry.dispose(),r.material.dispose(),this}clear(e,t=!0,i=!0,s=!0){const n=e.getRenderTarget();for(let n=0;n<6;n++)e.setRenderTarget(this,n),e.clear(t,i,s);e.setRenderTarget(n)}}class sn extends ji{constructor(){super(),this.isGroup=!0,this.type="Group"}}const nn={type:"move"};class rn{constructor(){this._targetRay=null,this._grip=null,this._hand=null}getHandSpace(){return null===this._hand&&(this._hand=new sn,this._hand.matrixAutoUpdate=!1,this._hand.visible=!1,this._hand.joints={},this._hand.inputState={pinching:!1}),this._hand}getTargetRaySpace(){return null===this._targetRay&&(this._targetRay=new sn,this._targetRay.matrixAutoUpdate=!1,this._targetRay.visible=!1,this._targetRay.hasLinearVelocity=!1,this._targetRay.linearVelocity=new mt,this._targetRay.hasAngularVelocity=!1,this._targetRay.angularVelocity=new mt),this._targetRay}getGripSpace(){return null===this._grip&&(this._grip=new sn,this._grip.matrixAutoUpdate=!1,this._grip.visible=!1,this._grip.hasLinearVelocity=!1,this._grip.linearVelocity=new mt,this._grip.hasAngularVelocity=!1,this._grip.angularVelocity=new mt),this._grip}dispatchEvent(e){return null!==this._targetRay&&this._targetRay.dispatchEvent(e),null!==this._grip&&this._grip.dispatchEvent(e),null!==this._hand&&this._hand.dispatchEvent(e),this}connect(e){if(e&&e.hand){const t=this._hand;if(t)for(const i of e.hand.values())this._getHandJoint(t,i)}return this.dispatchEvent({type:"connected",data:e}),this}disconnect(e){return this.dispatchEvent({type:"disconnected",data:e}),null!==this._targetRay&&(this._targetRay.visible=!1),null!==this._grip&&(this._grip.visible=!1),null!==this._hand&&(this._hand.visible=!1),this}update(e,t,i){let s=null,n=null,r=null;const a=this._targetRay,o=this._grip,l=this._hand;if(e&&"visible-blurred"!==t.session.visibilityState){if(l&&e.hand){r=!0;for(const s of e.hand.values()){const e=t.getJointPose(s,i),n=this._getHandJoint(l,s);null!==e&&(n.matrix.fromArray(e.transform.matrix),n.matrix.decompose(n.position,n.rotation,n.scale),n.matrixWorldNeedsUpdate=!0,n.jointRadius=e.radius),n.visible=null!==e}const s=l.joints["index-finger-tip"],n=l.joints["thumb-tip"],a=s.position.distanceTo(n.position),o=.02,d=.005;l.inputState.pinching&&a>o+d?(l.inputState.pinching=!1,this.dispatchEvent({type:"pinchend",handedness:e.handedness,target:this})):!l.inputState.pinching&&a<=o-d&&(l.inputState.pinching=!0,this.dispatchEvent({type:"pinchstart",handedness:e.handedness,target:this}))}else null!==o&&e.gripSpace&&(n=t.getPose(e.gripSpace,i),null!==n&&(o.matrix.fromArray(n.transform.matrix),o.matrix.decompose(o.position,o.rotation,o.scale),o.matrixWorldNeedsUpdate=!0,n.linearVelocity?(o.hasLinearVelocity=!0,o.linearVelocity.copy(n.linearVelocity)):o.hasLinearVelocity=!1,n.angularVelocity?(o.hasAngularVelocity=!0,o.angularVelocity.copy(n.angularVelocity)):o.hasAngularVelocity=!1));null!==a&&(s=t.getPose(e.targetRaySpace,i),null===s&&null!==n&&(s=n),null!==s&&(a.matrix.fromArray(s.transform.matrix),a.matrix.decompose(a.position,a.rotation,a.scale),a.matrixWorldNeedsUpdate=!0,s.linearVelocity?(a.hasLinearVelocity=!0,a.linearVelocity.copy(s.linearVelocity)):a.hasLinearVelocity=!1,s.angularVelocity?(a.hasAngularVelocity=!0,a.angularVelocity.copy(s.angularVelocity)):a.hasAngularVelocity=!1,this.dispatchEvent(nn)))}return null!==a&&(a.visible=null!==s),null!==o&&(o.visible=null!==n),null!==l&&(l.visible=null!==r),this}_getHandJoint(e,t){if(void 0===e.joints[t.jointName]){const i=new sn;i.matrixAutoUpdate=!1,i.visible=!1,e.joints[t.jointName]=i,e.add(i)}return e.joints[t.jointName]}}class an{constructor(e,t=1,i=1e3){this.isFog=!0,this.name="",this.color=new ls(e),this.near=t,this.far=i}clone(){return new an(this.color,this.near,this.far)}toJSON(){return{type:"Fog",name:this.name,color:this.color.getHex(),near:this.near,far:this.far}}}class on extends ji{constructor(){super(),this.isScene=!0,this.type="Scene",this.background=null,this.environment=null,this.fog=null,this.backgroundBlurriness=0,this.backgroundIntensity=1,this.backgroundRotation=new Mi,this.environmentIntensity=1,this.environmentRotation=new Mi,this.overrideMaterial=null,"undefined"!=typeof __THREE_DEVTOOLS__&&__THREE_DEVTOOLS__.dispatchEvent(new CustomEvent("observe",{detail:this}))}copy(e,t){return super.copy(e,t),null!==e.background&&(this.background=e.background.clone()),null!==e.environment&&(this.environment=e.environment.clone()),null!==e.fog&&(this.fog=e.fog.clone()),this.backgroundBlurriness=e.backgroundBlurriness,this.backgroundIntensity=e.backgroundIntensity,this.backgroundRotation.copy(e.backgroundRotation),this.environmentIntensity=e.environmentIntensity,this.environmentRotation.copy(e.environmentRotation),null!==e.overrideMaterial&&(this.overrideMaterial=e.overrideMaterial.clone()),this.matrixAutoUpdate=e.matrixAutoUpdate,this}toJSON(e){const t=super.toJSON(e);return null!==this.fog&&(t.object.fog=this.fog.toJSON()),this.backgroundBlurriness>0&&(t.object.backgroundBlurriness=this.backgroundBlurriness),1!==this.backgroundIntensity&&(t.object.backgroundIntensity=this.backgroundIntensity),t.object.backgroundRotation=this.backgroundRotation.toArray(),1!==this.environmentIntensity&&(t.object.environmentIntensity=this.environmentIntensity),t.object.environmentRotation=this.environmentRotation.toArray(),t}}class ln{constructor(e,t){this.isInterleavedBuffer=!0,this.array=e,this.stride=t,this.count=void 0!==e?e.length/t:0,this.usage=Qe,this.updateRanges=[],this.version=0,this.uuid=ot()}onUploadCallback(){}set needsUpdate(e){!0===e&&this.version++}setUsage(e){return this.usage=e,this}addUpdateRange(e,t){this.updateRanges.push({start:e,count:t})}clearUpdateRanges(){this.updateRanges.length=0}copy(e){return this.array=new e.array.constructor(e.array),this.count=e.count,this.stride=e.stride,this.usage=e.usage,this}copyAt(e,t,i){e*=this.stride,i*=t.stride;for(let s=0,n=this.stride;s<n;s++)this.array[e+s]=t.array[i+s];return this}set(e,t=0){return this.array.set(e,t),this}clone(e){void 0===e.arrayBuffers&&(e.arrayBuffers={}),void 0===this.array.buffer._uuid&&(this.array.buffer._uuid=ot()),void 0===e.arrayBuffers[this.array.buffer._uuid]&&(e.arrayBuffers[this.array.buffer._uuid]=this.array.slice(0).buffer);const t=new this.array.constructor(e.arrayBuffers[this.array.buffer._uuid]),i=new this.constructor(t,this.stride);return i.setUsage(this.usage),i}onUpload(e){return this.onUploadCallback=e,this}toJSON(e){return void 0===e.arrayBuffers&&(e.arrayBuffers={}),void 0===this.array.buffer._uuid&&(this.array.buffer._uuid=ot()),void 0===e.arrayBuffers[this.array.buffer._uuid]&&(e.arrayBuffers[this.array.buffer._uuid]=Array.from(new Uint32Array(this.array.buffer))),{uuid:this.uuid,buffer:this.array.buffer._uuid,type:this.array.constructor.name,stride:this.stride}}}const dn=new mt;class cn{constructor(e,t,i,s=!1){this.isInterleavedBufferAttribute=!0,this.name="",this.data=e,this.itemSize=t,this.offset=i,this.normalized=s}get count(){return this.data.count}get array(){return this.data.array}set needsUpdate(e){this.data.needsUpdate=e}applyMatrix4(e){for(let t=0,i=this.data.count;t<i;t++)dn.fromBufferAttribute(this,t),dn.applyMatrix4(e),this.setXYZ(t,dn.x,dn.y,dn.z);return this}applyNormalMatrix(e){for(let t=0,i=this.count;t<i;t++)dn.fromBufferAttribute(this,t),dn.applyNormalMatrix(e),this.setXYZ(t,dn.x,dn.y,dn.z);return this}transformDirection(e){for(let t=0,i=this.count;t<i;t++)dn.fromBufferAttribute(this,t),dn.transformDirection(e),this.setXYZ(t,dn.x,dn.y,dn.z);return this}getComponent(e,t){let i=this.array[e*this.data.stride+this.offset+t];return this.normalized&&(i=ct(i,this.array)),i}setComponent(e,t,i){return this.normalized&&(i=ht(i,this.array)),this.data.array[e*this.data.stride+this.offset+t]=i,this}setX(e,t){return this.normalized&&(t=ht(t,this.array)),this.data.array[e*this.data.stride+this.offset]=t,this}setY(e,t){return this.normalized&&(t=ht(t,this.array)),this.data.array[e*this.data.stride+this.offset+1]=t,this}setZ(e,t){return this.normalized&&(t=ht(t,this.array)),this.data.array[e*this.data.stride+this.offset+2]=t,this}setW(e,t){return this.normalized&&(t=ht(t,this.array)),this.data.array[e*this.data.stride+this.offset+3]=t,this}getX(e){let t=this.data.array[e*this.data.stride+this.offset];return this.normalized&&(t=ct(t,this.array)),t}getY(e){let t=this.data.array[e*this.data.stride+this.offset+1];return this.normalized&&(t=ct(t,this.array)),t}getZ(e){let t=this.data.array[e*this.data.stride+this.offset+2];return this.normalized&&(t=ct(t,this.array)),t}getW(e){let t=this.data.array[e*this.data.stride+this.offset+3];return this.normalized&&(t=ct(t,this.array)),t}setXY(e,t,i){return e=e*this.data.stride+this.offset,this.normalized&&(t=ht(t,this.array),i=ht(i,this.array)),this.data.array[e+0]=t,this.data.array[e+1]=i,this}setXYZ(e,t,i,s){return e=e*this.data.stride+this.offset,this.normalized&&(t=ht(t,this.array),i=ht(i,this.array),s=ht(s,this.array)),this.data.array[e+0]=t,this.data.array[e+1]=i,this.data.array[e+2]=s,this}setXYZW(e,t,i,s,n){return e=e*this.data.stride+this.offset,this.normalized&&(t=ht(t,this.array),i=ht(i,this.array),s=ht(s,this.array),n=ht(n,this.array)),this.data.array[e+0]=t,this.data.array[e+1]=i,this.data.array[e+2]=s,this.data.array[e+3]=n,this}clone(e){if(void 0===e){console.log("THREE.InterleavedBufferAttribute.clone(): Cloning an interleaved buffer attribute will de-interleave buffer data.");const e=[];for(let t=0;t<this.count;t++){const i=t*this.data.stride+this.offset;for(let t=0;t<this.itemSize;t++)e.push(this.data.array[i+t])}return new gs(new this.array.constructor(e),this.itemSize,this.normalized)}return void 0===e.interleavedBuffers&&(e.interleavedBuffers={}),void 0===e.interleavedBuffers[this.data.uuid]&&(e.interleavedBuffers[this.data.uuid]=this.data.clone(e)),new cn(e.interleavedBuffers[this.data.uuid],this.itemSize,this.offset,this.normalized)}toJSON(e){if(void 0===e){console.log("THREE.InterleavedBufferAttribute.toJSON(): Serializing an interleaved buffer attribute will de-interleave buffer data.");const e=[];for(let t=0;t<this.count;t++){const i=t*this.data.stride+this.offset;for(let t=0;t<this.itemSize;t++)e.push(this.data.array[i+t])}return{itemSize:this.itemSize,type:this.array.constructor.name,array:e,normalized:this.normalized}}return void 0===e.interleavedBuffers&&(e.interleavedBuffers={}),void 0===e.interleavedBuffers[this.data.uuid]&&(e.interleavedBuffers[this.data.uuid]=this.data.toJSON(e)),{isInterleavedBufferAttribute:!0,itemSize:this.itemSize,data:this.data.uuid,offset:this.offset,normalized:this.normalized}}}class hn extends hs{constructor(e){super(),this.isSpriteMaterial=!0,this.type="SpriteMaterial",this.color=new ls(16777215),this.map=null,this.alphaMap=null,this.rotation=0,this.sizeAttenuation=!0,this.transparent=!0,this.fog=!0,this.setValues(e)}copy(e){return super.copy(e),this.color.copy(e.color),this.map=e.map,this.alphaMap=e.alphaMap,this.rotation=e.rotation,this.sizeAttenuation=e.sizeAttenuation,this.fog=e.fog,this}}let pn;const un=new mt,mn=new mt,fn=new mt,gn=new pt,bn=new pt,Cn=new gi,vn=new mt,_n=new mt,yn=new mt,Sn=new pt,wn=new pt,xn=new pt;class An extends ji{constructor(e=new hn){if(super(),this.isSprite=!0,this.type="Sprite",void 0===pn){pn=new Ts;const e=new Float32Array([-.5,-.5,0,0,0,.5,-.5,0,1,0,.5,.5,0,1,1,-.5,.5,0,0,1]),t=new ln(e,5);pn.setIndex([0,1,2,0,2,3]),pn.setAttribute("position",new cn(t,3,0,!1)),pn.setAttribute("uv",new cn(t,2,3,!1))}this.geometry=pn,this.material=e,this.center=new pt(.5,.5),this.count=1}raycast(e,t){null===e.camera&&console.error('THREE.Sprite: "Raycaster.camera" needs to be set in order to raycast against sprites.'),mn.setFromMatrixScale(this.matrixWorld),Cn.copy(e.camera.matrixWorld),this.modelViewMatrix.multiplyMatrices(e.camera.matrixWorldInverse,this.matrixWorld),fn.setFromMatrixPosition(this.modelViewMatrix),e.camera.isPerspectiveCamera&&!1===this.material.sizeAttenuation&&mn.multiplyScalar(-fn.z);const i=this.material.rotation;let s,n;0!==i&&(n=Math.cos(i),s=Math.sin(i));const r=this.center;Mn(vn.set(-.5,-.5,0),fn,r,mn,s,n),Mn(_n.set(.5,-.5,0),fn,r,mn,s,n),Mn(yn.set(.5,.5,0),fn,r,mn,s,n),Sn.set(0,0),wn.set(1,0),xn.set(1,1);let a=e.ray.intersectTriangle(vn,_n,yn,!1,un);if(null===a&&(Mn(_n.set(-.5,.5,0),fn,r,mn,s,n),wn.set(0,1),a=e.ray.intersectTriangle(vn,yn,_n,!1,un),null===a))return;const o=e.ray.origin.distanceTo(un);o<e.near||o>e.far||t.push({distance:o,point:un.clone(),uv:ss.getInterpolation(un,vn,_n,yn,Sn,wn,xn,new pt),face:null,object:this})}copy(e,t){return super.copy(e,t),void 0!==e.center&&this.center.copy(e.center),this.material=e.material,this}}function Mn(e,t,i,s,n,r){gn.subVectors(e,i).addScalar(.5).multiply(s),void 0!==n?(bn.x=r*gn.x-n*gn.y,bn.y=n*gn.x+r*gn.y):bn.copy(gn),e.copy(t),e.x+=bn.x,e.y+=bn.y,e.applyMatrix4(Cn)}class Tn extends gs{constructor(e,t,i,s=1){super(e,t,i),this.isInstancedBufferAttribute=!0,this.meshPerAttribute=s}copy(e){return super.copy(e),this.meshPerAttribute=e.meshPerAttribute,this}toJSON(){const e=super.toJSON();return e.meshPerAttribute=this.meshPerAttribute,e.isInstancedBufferAttribute=!0,e}}const En=new mt,Rn=new mt,kn=new bt;class On{constructor(e=new mt(1,0,0),t=0){this.isPlane=!0,this.normal=e,this.constant=t}set(e,t){return this.normal.copy(e),this.constant=t,this}setComponents(e,t,i,s){return this.normal.set(e,t,i),this.constant=s,this}setFromNormalAndCoplanarPoint(e,t){return this.normal.copy(e),this.constant=-t.dot(this.normal),this}setFromCoplanarPoints(e,t,i){const s=En.subVectors(i,t).cross(Rn.subVectors(e,t)).normalize();return this.setFromNormalAndCoplanarPoint(s,e),this}copy(e){return this.normal.copy(e.normal),this.constant=e.constant,this}normalize(){const e=1/this.normal.length();return this.normal.multiplyScalar(e),this.constant*=e,this}negate(){return this.constant*=-1,this.normal.negate(),this}distanceToPoint(e){return this.normal.dot(e)+this.constant}distanceToSphere(e){return this.distanceToPoint(e.center)-e.radius}projectPoint(e,t){return t.copy(e).addScaledVector(this.normal,-this.distanceToPoint(e))}intersectLine(e,t){const i=e.delta(En),s=this.normal.dot(i);if(0===s)return 0===this.distanceToPoint(e.start)?t.copy(e.start):null;const n=-(e.start.dot(this.normal)+this.constant)/s;return n<0||n>1?null:t.copy(e.start).addScaledVector(i,n)}intersectsLine(e){const t=this.distanceToPoint(e.start),i=this.distanceToPoint(e.end);return t<0&&i>0||i<0&&t>0}intersectsBox(e){return e.intersectsPlane(this)}intersectsSphere(e){return e.intersectsPlane(this)}coplanarPoint(e){return e.copy(this.normal).multiplyScalar(-this.constant)}applyMatrix4(e,t){const i=t||kn.getNormalMatrix(e),s=this.coplanarPoint(En).applyMatrix4(e),n=this.normal.applyMatrix3(i).normalize();return this.constant=-s.dot(n),this}translate(e){return this.constant-=e.dot(this.normal),this}equals(e){return e.normal.equals(this.normal)&&e.constant===this.constant}clone(){return(new this.constructor).copy(this)}}const In=new oi,Pn=new mt;class Dn{constructor(e=new On,t=new On,i=new On,s=new On,n=new On,r=new On){this.planes=[e,t,i,s,n,r]}set(e,t,i,s,n,r){const a=this.planes;return a[0].copy(e),a[1].copy(t),a[2].copy(i),a[3].copy(s),a[4].copy(n),a[5].copy(r),this}copy(e){const t=this.planes;for(let i=0;i<6;i++)t[i].copy(e.planes[i]);return this}setFromProjectionMatrix(e,t=2e3){const i=this.planes,s=e.elements,n=s[0],r=s[1],a=s[2],o=s[3],l=s[4],d=s[5],c=s[6],h=s[7],p=s[8],u=s[9],m=s[10],f=s[11],g=s[12],b=s[13],C=s[14],v=s[15];if(i[0].setComponents(o-n,h-l,f-p,v-g).normalize(),i[1].setComponents(o+n,h+l,f+p,v+g).normalize(),i[2].setComponents(o+r,h+d,f+u,v+b).normalize(),i[3].setComponents(o-r,h-d,f-u,v-b).normalize(),i[4].setComponents(o-a,h-c,f-m,v-C).normalize(),t===tt)i[5].setComponents(o+a,h+c,f+m,v+C).normalize();else{if(t!==it)throw new Error("THREE.Frustum.setFromProjectionMatrix(): Invalid coordinate system: "+t);i[5].setComponents(a,c,m,C).normalize()}return this}intersectsObject(e){if(void 0!==e.boundingSphere)null===e.boundingSphere&&e.computeBoundingSphere(),In.copy(e.boundingSphere).applyMatrix4(e.matrixWorld);else{const t=e.geometry;null===t.boundingSphere&&t.computeBoundingSphere(),In.copy(t.boundingSphere).applyMatrix4(e.matrixWorld)}return this.intersectsSphere(In)}intersectsSprite(e){return In.center.set(0,0,0),In.radius=.7071067811865476,In.applyMatrix4(e.matrixWorld),this.intersectsSphere(In)}intersectsSphere(e){const t=this.planes,i=e.center,s=-e.radius;for(let e=0;e<6;e++){if(t[e].distanceToPoint(i)<s)return!1}return!0}intersectsBox(e){const t=this.planes;for(let i=0;i<6;i++){const s=t[i];if(Pn.x=s.normal.x>0?e.max.x:e.min.x,Pn.y=s.normal.y>0?e.max.y:e.min.y,Pn.z=s.normal.z>0?e.max.z:e.min.z,s.distanceToPoint(Pn)<0)return!1}return!0}containsPoint(e){const t=this.planes;for(let i=0;i<6;i++)if(t[i].distanceToPoint(e)<0)return!1;return!0}clone(){return(new this.constructor).copy(this)}}class Ln extends hs{constructor(e){super(),this.isLineBasicMaterial=!0,this.type="LineBasicMaterial",this.color=new ls(16777215),this.map=null,this.linewidth=1,this.linecap="round",this.linejoin="round",this.fog=!0,this.setValues(e)}copy(e){return super.copy(e),this.color.copy(e.color),this.map=e.map,this.linewidth=e.linewidth,this.linecap=e.linecap,this.linejoin=e.linejoin,this.fog=e.fog,this}}const Fn=new mt,Nn=new mt,Un=new gi,Hn=new fi,Bn=new oi,zn=new mt,qn=new mt;class jn extends ji{constructor(e=new Ts,t=new Ln){super(),this.isLine=!0,this.type="Line",this.geometry=e,this.material=t,this.morphTargetDictionary=void 0,this.morphTargetInfluences=void 0,this.updateMorphTargets()}copy(e,t){return super.copy(e,t),this.material=Array.isArray(e.material)?e.material.slice():e.material,this.geometry=e.geometry,this}computeLineDistances(){const e=this.geometry;if(null===e.index){const t=e.attributes.position,i=[0];for(let e=1,s=t.count;e<s;e++)Fn.fromBufferAttribute(t,e-1),Nn.fromBufferAttribute(t,e),i[e]=i[e-1],i[e]+=Fn.distanceTo(Nn);e.setAttribute("lineDistance",new vs(i,1))}else console.warn("THREE.Line.computeLineDistances(): Computation only possible with non-indexed BufferGeometry.");return this}raycast(e,t){const i=this.geometry,s=this.matrixWorld,n=e.params.Line.threshold,r=i.drawRange;if(null===i.boundingSphere&&i.computeBoundingSphere(),Bn.copy(i.boundingSphere),Bn.applyMatrix4(s),Bn.radius+=n,!1===e.ray.intersectsSphere(Bn))return;Un.copy(s).invert(),Hn.copy(e.ray).applyMatrix4(Un);const a=n/((this.scale.x+this.scale.y+this.scale.z)/3),o=a*a,l=this.isLineSegments?2:1,d=i.index,c=i.attributes.position;if(null!==d){const i=Math.max(0,r.start),s=Math.min(d.count,r.start+r.count);for(let n=i,r=s-1;n<r;n+=l){const i=d.getX(n),s=d.getX(n+1),r=Gn(this,e,Hn,o,i,s,n);r&&t.push(r)}if(this.isLineLoop){const n=d.getX(s-1),r=d.getX(i),a=Gn(this,e,Hn,o,n,r,s-1);a&&t.push(a)}}else{const i=Math.max(0,r.start),s=Math.min(c.count,r.start+r.count);for(let n=i,r=s-1;n<r;n+=l){const i=Gn(this,e,Hn,o,n,n+1,n);i&&t.push(i)}if(this.isLineLoop){const n=Gn(this,e,Hn,o,s-1,i,s-1);n&&t.push(n)}}}updateMorphTargets(){const e=this.geometry.morphAttributes,t=Object.keys(e);if(t.length>0){const i=e[t[0]];if(void 0!==i){this.morphTargetInfluences=[],this.morphTargetDictionary={};for(let e=0,t=i.length;e<t;e++){const t=i[e].name||String(e);this.morphTargetInfluences.push(0),this.morphTargetDictionary[t]=e}}}}}function Gn(e,t,i,s,n,r,a){const o=e.geometry.attributes.position;Fn.fromBufferAttribute(o,n),Nn.fromBufferAttribute(o,r);if(i.distanceSqToSegment(Fn,Nn,zn,qn)>s)return;zn.applyMatrix4(e.matrixWorld);const l=t.ray.origin.distanceTo(zn);return l<t.near||l>t.far?void 0:{distance:l,point:qn.clone().applyMatrix4(e.matrixWorld),index:a,face:null,faceIndex:null,barycoord:null,object:e}}const $n=new mt,Vn=new mt;class Wn extends jn{constructor(e,t){super(e,t),this.isLineSegments=!0,this.type="LineSegments"}computeLineDistances(){const e=this.geometry;if(null===e.index){const t=e.attributes.position,i=[];for(let e=0,s=t.count;e<s;e+=2)$n.fromBufferAttribute(t,e),Vn.fromBufferAttribute(t,e+1),i[e]=0===e?0:i[e-1],i[e+1]=i[e]+$n.distanceTo(Vn);e.setAttribute("lineDistance",new vs(i,1))}else console.warn("THREE.LineSegments.computeLineDistances(): Computation only possible with non-indexed BufferGeometry.");return this}}class Xn extends Nt{constructor(e,t,i,s,n,r,a,o,l){super(e,t,i,s,n,r,a,o,l),this.isCanvasTexture=!0,this.needsUpdate=!0}}class Yn extends Nt{constructor(e,t,i=1014,s,n,r,a=1003,o=1003,l,d=1026,c=1){if(d!==se&&d!==ne)throw new Error("DepthTexture format must be either THREE.DepthFormat or THREE.DepthStencilFormat");super({width:e,height:t,depth:c},s,n,r,a,o,d,i,l),this.isDepthTexture=!0,this.flipY=!1,this.generateMipmaps=!1,this.compareFunction=null}copy(e){return super.copy(e),this.source=new Pt(Object.assign({},e.image)),this.compareFunction=e.compareFunction,this}toJSON(e){const t=super.toJSON(e);return null!==this.compareFunction&&(t.compareFunction=this.compareFunction),t}}class Kn extends Ts{constructor(e=1,t=1,i=1,s=32,n=1,r=!1,a=0,o=2*Math.PI){super(),this.type="CylinderGeometry",this.parameters={radiusTop:e,radiusBottom:t,height:i,radialSegments:s,heightSegments:n,openEnded:r,thetaStart:a,thetaLength:o};const l=this;s=Math.floor(s),n=Math.floor(n);const d=[],c=[],h=[],p=[];let u=0;const m=[],f=i/2;let g=0;function b(i){const n=u,r=new pt,m=new mt;let b=0;const C=!0===i?e:t,v=!0===i?1:-1;for(let e=1;e<=s;e++)c.push(0,f*v,0),h.push(0,v,0),p.push(.5,.5),u++;const _=u;for(let e=0;e<=s;e++){const t=e/s*o+a,i=Math.cos(t),n=Math.sin(t);m.x=C*n,m.y=f*v,m.z=C*i,c.push(m.x,m.y,m.z),h.push(0,v,0),r.x=.5*i+.5,r.y=.5*n*v+.5,p.push(r.x,r.y),u++}for(let e=0;e<s;e++){const t=n+e,s=_+e;!0===i?d.push(s,s+1,t):d.push(s+1,s,t),b+=3}l.addGroup(g,b,!0===i?1:2),g+=b}!function(){const r=new mt,b=new mt;let C=0;const v=(t-e)/i;for(let l=0;l<=n;l++){const d=[],g=l/n,C=g*(t-e)+e;for(let e=0;e<=s;e++){const t=e/s,n=t*o+a,l=Math.sin(n),m=Math.cos(n);b.x=C*l,b.y=-g*i+f,b.z=C*m,c.push(b.x,b.y,b.z),r.set(l,v,m).normalize(),h.push(r.x,r.y,r.z),p.push(t,1-g),d.push(u++)}m.push(d)}for(let i=0;i<s;i++)for(let s=0;s<n;s++){const r=m[s][i],a=m[s+1][i],o=m[s+1][i+1],l=m[s][i+1];(e>0||0!==s)&&(d.push(r,a,l),C+=3),(t>0||s!==n-1)&&(d.push(a,o,l),C+=3)}l.addGroup(g,C,0),g+=C}(),!1===r&&(e>0&&b(!0),t>0&&b(!1)),this.setIndex(d),this.setAttribute("position",new vs(c,3)),this.setAttribute("normal",new vs(h,3)),this.setAttribute("uv",new vs(p,2))}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}static fromJSON(e){return new Kn(e.radiusTop,e.radiusBottom,e.height,e.radialSegments,e.heightSegments,e.openEnded,e.thetaStart,e.thetaLength)}}class Zn extends Ts{constructor(e=[],t=[],i=1,s=0){super(),this.type="PolyhedronGeometry",this.parameters={vertices:e,indices:t,radius:i,detail:s};const n=[],r=[];function a(e,t,i,s){const n=s+1,r=[];for(let s=0;s<=n;s++){r[s]=[];const a=e.clone().lerp(i,s/n),o=t.clone().lerp(i,s/n),l=n-s;for(let e=0;e<=l;e++)r[s][e]=0===e&&s===n?a:a.clone().lerp(o,e/l)}for(let e=0;e<n;e++)for(let t=0;t<2*(n-e)-1;t++){const i=Math.floor(t/2);t%2==0?(o(r[e][i+1]),o(r[e+1][i]),o(r[e][i])):(o(r[e][i+1]),o(r[e+1][i+1]),o(r[e+1][i]))}}function o(e){n.push(e.x,e.y,e.z)}function l(t,i){const s=3*t;i.x=e[s+0],i.y=e[s+1],i.z=e[s+2]}function d(e,t,i,s){s<0&&1===e.x&&(r[t]=e.x-1),0===i.x&&0===i.z&&(r[t]=s/2/Math.PI+.5)}function c(e){return Math.atan2(e.z,-e.x)}!function(e){const i=new mt,s=new mt,n=new mt;for(let r=0;r<t.length;r+=3)l(t[r+0],i),l(t[r+1],s),l(t[r+2],n),a(i,s,n,e)}(s),function(e){const t=new mt;for(let i=0;i<n.length;i+=3)t.x=n[i+0],t.y=n[i+1],t.z=n[i+2],t.normalize().multiplyScalar(e),n[i+0]=t.x,n[i+1]=t.y,n[i+2]=t.z}(i),function(){const e=new mt;for(let i=0;i<n.length;i+=3){e.x=n[i+0],e.y=n[i+1],e.z=n[i+2];const s=c(e)/2/Math.PI+.5,a=(t=e,Math.atan2(-t.y,Math.sqrt(t.x*t.x+t.z*t.z))/Math.PI+.5);r.push(s,1-a)}var t;(function(){const e=new mt,t=new mt,i=new mt,s=new mt,a=new pt,o=new pt,l=new pt;for(let h=0,p=0;h<n.length;h+=9,p+=6){e.set(n[h+0],n[h+1],n[h+2]),t.set(n[h+3],n[h+4],n[h+5]),i.set(n[h+6],n[h+7],n[h+8]),a.set(r[p+0],r[p+1]),o.set(r[p+2],r[p+3]),l.set(r[p+4],r[p+5]),s.copy(e).add(t).add(i).divideScalar(3);const u=c(s);d(a,p+0,e,u),d(o,p+2,t,u),d(l,p+4,i,u)}})(),function(){for(let e=0;e<r.length;e+=6){const t=r[e+0],i=r[e+2],s=r[e+4],n=Math.max(t,i,s),a=Math.min(t,i,s);n>.9&&a<.1&&(t<.2&&(r[e+0]+=1),i<.2&&(r[e+2]+=1),s<.2&&(r[e+4]+=1))}}()}(),this.setAttribute("position",new vs(n,3)),this.setAttribute("normal",new vs(n.slice(),3)),this.setAttribute("uv",new vs(r,2)),0===s?this.computeVertexNormals():this.normalizeNormals()}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}static fromJSON(e){return new Zn(e.vertices,e.indices,e.radius,e.details)}}class Jn{constructor(){this.type="Curve",this.arcLengthDivisions=200,this.needsUpdate=!1,this.cacheArcLengths=null}getPoint(){console.warn("THREE.Curve: .getPoint() not implemented.")}getPointAt(e,t){const i=this.getUtoTmapping(e);return this.getPoint(i,t)}getPoints(e=5){const t=[];for(let i=0;i<=e;i++)t.push(this.getPoint(i/e));return t}getSpacedPoints(e=5){const t=[];for(let i=0;i<=e;i++)t.push(this.getPointAt(i/e));return t}getLength(){const e=this.getLengths();return e[e.length-1]}getLengths(e=this.arcLengthDivisions){if(this.cacheArcLengths&&this.cacheArcLengths.length===e+1&&!this.needsUpdate)return this.cacheArcLengths;this.needsUpdate=!1;const t=[];let i,s=this.getPoint(0),n=0;t.push(0);for(let r=1;r<=e;r++)i=this.getPoint(r/e),n+=i.distanceTo(s),t.push(n),s=i;return this.cacheArcLengths=t,t}updateArcLengths(){this.needsUpdate=!0,this.getLengths()}getUtoTmapping(e,t=null){const i=this.getLengths();let s=0;const n=i.length;let r;r=t||e*i[n-1];let a,o=0,l=n-1;for(;o<=l;)if(s=Math.floor(o+(l-o)/2),a=i[s]-r,a<0)o=s+1;else{if(!(a>0)){l=s;break}l=s-1}if(s=l,i[s]===r)return s/(n-1);const d=i[s];return(s+(r-d)/(i[s+1]-d))/(n-1)}getTangent(e,t){const i=1e-4;let s=e-i,n=e+i;s<0&&(s=0),n>1&&(n=1);const r=this.getPoint(s),a=this.getPoint(n),o=t||(r.isVector2?new pt:new mt);return o.copy(a).sub(r).normalize(),o}getTangentAt(e,t){const i=this.getUtoTmapping(e);return this.getTangent(i,t)}computeFrenetFrames(e,t=!1){const i=new mt,s=[],n=[],r=[],a=new mt,o=new gi;for(let t=0;t<=e;t++){const i=t/e;s[t]=this.getTangentAt(i,new mt)}n[0]=new mt,r[0]=new mt;let l=Number.MAX_VALUE;const d=Math.abs(s[0].x),c=Math.abs(s[0].y),h=Math.abs(s[0].z);d<=l&&(l=d,i.set(1,0,0)),c<=l&&(l=c,i.set(0,1,0)),h<=l&&i.set(0,0,1),a.crossVectors(s[0],i).normalize(),n[0].crossVectors(s[0],a),r[0].crossVectors(s[0],n[0]);for(let t=1;t<=e;t++){if(n[t]=n[t-1].clone(),r[t]=r[t-1].clone(),a.crossVectors(s[t-1],s[t]),a.length()>Number.EPSILON){a.normalize();const e=Math.acos(lt(s[t-1].dot(s[t]),-1,1));n[t].applyMatrix4(o.makeRotationAxis(a,e))}r[t].crossVectors(s[t],n[t])}if(!0===t){let t=Math.acos(lt(n[0].dot(n[e]),-1,1));t/=e,s[0].dot(a.crossVectors(n[0],n[e]))>0&&(t=-t);for(let i=1;i<=e;i++)n[i].applyMatrix4(o.makeRotationAxis(s[i],t*i)),r[i].crossVectors(s[i],n[i])}return{tangents:s,normals:n,binormals:r}}clone(){return(new this.constructor).copy(this)}copy(e){return this.arcLengthDivisions=e.arcLengthDivisions,this}toJSON(){const e={metadata:{version:4.7,type:"Curve",generator:"Curve.toJSON"}};return e.arcLengthDivisions=this.arcLengthDivisions,e.type=this.type,e}fromJSON(e){return this.arcLengthDivisions=e.arcLengthDivisions,this}}class Qn extends Jn{constructor(e=0,t=0,i=1,s=1,n=0,r=2*Math.PI,a=!1,o=0){super(),this.isEllipseCurve=!0,this.type="EllipseCurve",this.aX=e,this.aY=t,this.xRadius=i,this.yRadius=s,this.aStartAngle=n,this.aEndAngle=r,this.aClockwise=a,this.aRotation=o}getPoint(e,t=new pt){const i=t,s=2*Math.PI;let n=this.aEndAngle-this.aStartAngle;const r=Math.abs(n)<Number.EPSILON;for(;n<0;)n+=s;for(;n>s;)n-=s;n<Number.EPSILON&&(n=r?0:s),!0!==this.aClockwise||r||(n===s?n=-s:n-=s);const a=this.aStartAngle+e*n;let o=this.aX+this.xRadius*Math.cos(a),l=this.aY+this.yRadius*Math.sin(a);if(0!==this.aRotation){const e=Math.cos(this.aRotation),t=Math.sin(this.aRotation),i=o-this.aX,s=l-this.aY;o=i*e-s*t+this.aX,l=i*t+s*e+this.aY}return i.set(o,l)}copy(e){return super.copy(e),this.aX=e.aX,this.aY=e.aY,this.xRadius=e.xRadius,this.yRadius=e.yRadius,this.aStartAngle=e.aStartAngle,this.aEndAngle=e.aEndAngle,this.aClockwise=e.aClockwise,this.aRotation=e.aRotation,this}toJSON(){const e=super.toJSON();return e.aX=this.aX,e.aY=this.aY,e.xRadius=this.xRadius,e.yRadius=this.yRadius,e.aStartAngle=this.aStartAngle,e.aEndAngle=this.aEndAngle,e.aClockwise=this.aClockwise,e.aRotation=this.aRotation,e}fromJSON(e){return super.fromJSON(e),this.aX=e.aX,this.aY=e.aY,this.xRadius=e.xRadius,this.yRadius=e.yRadius,this.aStartAngle=e.aStartAngle,this.aEndAngle=e.aEndAngle,this.aClockwise=e.aClockwise,this.aRotation=e.aRotation,this}}function er(){let e=0,t=0,i=0,s=0;function n(n,r,a,o){e=n,t=a,i=-3*n+3*r-2*a-o,s=2*n-2*r+a+o}return{initCatmullRom:function(e,t,i,s,r){n(t,i,r*(i-e),r*(s-t))},initNonuniformCatmullRom:function(e,t,i,s,r,a,o){let l=(t-e)/r-(i-e)/(r+a)+(i-t)/a,d=(i-t)/a-(s-t)/(a+o)+(s-i)/o;l*=a,d*=a,n(t,i,l,d)},calc:function(n){const r=n*n;return e+t*n+i*r+s*(r*n)}}}const tr=new mt,ir=new er,sr=new er,nr=new er;class rr extends Jn{constructor(e=[],t=!1,i="centripetal",s=.5){super(),this.isCatmullRomCurve3=!0,this.type="CatmullRomCurve3",this.points=e,this.closed=t,this.curveType=i,this.tension=s}getPoint(e,t=new mt){const i=t,s=this.points,n=s.length,r=(n-(this.closed?0:1))*e;let a,o,l=Math.floor(r),d=r-l;this.closed?l+=l>0?0:(Math.floor(Math.abs(l)/n)+1)*n:0===d&&l===n-1&&(l=n-2,d=1),this.closed||l>0?a=s[(l-1)%n]:(tr.subVectors(s[0],s[1]).add(s[0]),a=tr);const c=s[l%n],h=s[(l+1)%n];if(this.closed||l+2<n?o=s[(l+2)%n]:(tr.subVectors(s[n-1],s[n-2]).add(s[n-1]),o=tr),"centripetal"===this.curveType||"chordal"===this.curveType){const e="chordal"===this.curveType?.5:.25;let t=Math.pow(a.distanceToSquared(c),e),i=Math.pow(c.distanceToSquared(h),e),s=Math.pow(h.distanceToSquared(o),e);i<1e-4&&(i=1),t<1e-4&&(t=i),s<1e-4&&(s=i),ir.initNonuniformCatmullRom(a.x,c.x,h.x,o.x,t,i,s),sr.initNonuniformCatmullRom(a.y,c.y,h.y,o.y,t,i,s),nr.initNonuniformCatmullRom(a.z,c.z,h.z,o.z,t,i,s)}else"catmullrom"===this.curveType&&(ir.initCatmullRom(a.x,c.x,h.x,o.x,this.tension),sr.initCatmullRom(a.y,c.y,h.y,o.y,this.tension),nr.initCatmullRom(a.z,c.z,h.z,o.z,this.tension));return i.set(ir.calc(d),sr.calc(d),nr.calc(d)),i}copy(e){super.copy(e),this.points=[];for(let t=0,i=e.points.length;t<i;t++){const i=e.points[t];this.points.push(i.clone())}return this.closed=e.closed,this.curveType=e.curveType,this.tension=e.tension,this}toJSON(){const e=super.toJSON();e.points=[];for(let t=0,i=this.points.length;t<i;t++){const i=this.points[t];e.points.push(i.toArray())}return e.closed=this.closed,e.curveType=this.curveType,e.tension=this.tension,e}fromJSON(e){super.fromJSON(e),this.points=[];for(let t=0,i=e.points.length;t<i;t++){const i=e.points[t];this.points.push((new mt).fromArray(i))}return this.closed=e.closed,this.curveType=e.curveType,this.tension=e.tension,this}}function ar(e,t,i,s,n){const r=.5*(s-t),a=.5*(n-i),o=e*e;return(2*i-2*s+r+a)*(e*o)+(-3*i+3*s-2*r-a)*o+r*e+i}function or(e,t,i,s){return function(e,t){const i=1-e;return i*i*t}(e,t)+function(e,t){return 2*(1-e)*e*t}(e,i)+function(e,t){return e*e*t}(e,s)}function lr(e,t,i,s,n){return function(e,t){const i=1-e;return i*i*i*t}(e,t)+function(e,t){const i=1-e;return 3*i*i*e*t}(e,i)+function(e,t){return 3*(1-e)*e*e*t}(e,s)+function(e,t){return e*e*e*t}(e,n)}class dr extends Jn{constructor(e=new mt,t=new mt,i=new mt){super(),this.isQuadraticBezierCurve3=!0,this.type="QuadraticBezierCurve3",this.v0=e,this.v1=t,this.v2=i}getPoint(e,t=new mt){const i=t,s=this.v0,n=this.v1,r=this.v2;return i.set(or(e,s.x,n.x,r.x),or(e,s.y,n.y,r.y),or(e,s.z,n.z,r.z)),i}copy(e){return super.copy(e),this.v0.copy(e.v0),this.v1.copy(e.v1),this.v2.copy(e.v2),this}toJSON(){const e=super.toJSON();return e.v0=this.v0.toArray(),e.v1=this.v1.toArray(),e.v2=this.v2.toArray(),e}fromJSON(e){return super.fromJSON(e),this.v0.fromArray(e.v0),this.v1.fromArray(e.v1),this.v2.fromArray(e.v2),this}}var cr=Object.freeze({__proto__:null,ArcCurve:class extends Qn{constructor(e,t,i,s,n,r){super(e,t,i,i,s,n,r),this.isArcCurve=!0,this.type="ArcCurve"}},CatmullRomCurve3:rr,CubicBezierCurve:class extends Jn{constructor(e=new pt,t=new pt,i=new pt,s=new pt){super(),this.isCubicBezierCurve=!0,this.type="CubicBezierCurve",this.v0=e,this.v1=t,this.v2=i,this.v3=s}getPoint(e,t=new pt){const i=t,s=this.v0,n=this.v1,r=this.v2,a=this.v3;return i.set(lr(e,s.x,n.x,r.x,a.x),lr(e,s.y,n.y,r.y,a.y)),i}copy(e){return super.copy(e),this.v0.copy(e.v0),this.v1.copy(e.v1),this.v2.copy(e.v2),this.v3.copy(e.v3),this}toJSON(){const e=super.toJSON();return e.v0=this.v0.toArray(),e.v1=this.v1.toArray(),e.v2=this.v2.toArray(),e.v3=this.v3.toArray(),e}fromJSON(e){return super.fromJSON(e),this.v0.fromArray(e.v0),this.v1.fromArray(e.v1),this.v2.fromArray(e.v2),this.v3.fromArray(e.v3),this}},CubicBezierCurve3:class extends Jn{constructor(e=new mt,t=new mt,i=new mt,s=new mt){super(),this.isCubicBezierCurve3=!0,this.type="CubicBezierCurve3",this.v0=e,this.v1=t,this.v2=i,this.v3=s}getPoint(e,t=new mt){const i=t,s=this.v0,n=this.v1,r=this.v2,a=this.v3;return i.set(lr(e,s.x,n.x,r.x,a.x),lr(e,s.y,n.y,r.y,a.y),lr(e,s.z,n.z,r.z,a.z)),i}copy(e){return super.copy(e),this.v0.copy(e.v0),this.v1.copy(e.v1),this.v2.copy(e.v2),this.v3.copy(e.v3),this}toJSON(){const e=super.toJSON();return e.v0=this.v0.toArray(),e.v1=this.v1.toArray(),e.v2=this.v2.toArray(),e.v3=this.v3.toArray(),e}fromJSON(e){return super.fromJSON(e),this.v0.fromArray(e.v0),this.v1.fromArray(e.v1),this.v2.fromArray(e.v2),this.v3.fromArray(e.v3),this}},EllipseCurve:Qn,LineCurve:class extends Jn{constructor(e=new pt,t=new pt){super(),this.isLineCurve=!0,this.type="LineCurve",this.v1=e,this.v2=t}getPoint(e,t=new pt){const i=t;return 1===e?i.copy(this.v2):(i.copy(this.v2).sub(this.v1),i.multiplyScalar(e).add(this.v1)),i}getPointAt(e,t){return this.getPoint(e,t)}getTangent(e,t=new pt){return t.subVectors(this.v2,this.v1).normalize()}getTangentAt(e,t){return this.getTangent(e,t)}copy(e){return super.copy(e),this.v1.copy(e.v1),this.v2.copy(e.v2),this}toJSON(){const e=super.toJSON();return e.v1=this.v1.toArray(),e.v2=this.v2.toArray(),e}fromJSON(e){return super.fromJSON(e),this.v1.fromArray(e.v1),this.v2.fromArray(e.v2),this}},LineCurve3:class extends Jn{constructor(e=new mt,t=new mt){super(),this.isLineCurve3=!0,this.type="LineCurve3",this.v1=e,this.v2=t}getPoint(e,t=new mt){const i=t;return 1===e?i.copy(this.v2):(i.copy(this.v2).sub(this.v1),i.multiplyScalar(e).add(this.v1)),i}getPointAt(e,t){return this.getPoint(e,t)}getTangent(e,t=new mt){return t.subVectors(this.v2,this.v1).normalize()}getTangentAt(e,t){return this.getTangent(e,t)}copy(e){return super.copy(e),this.v1.copy(e.v1),this.v2.copy(e.v2),this}toJSON(){const e=super.toJSON();return e.v1=this.v1.toArray(),e.v2=this.v2.toArray(),e}fromJSON(e){return super.fromJSON(e),this.v1.fromArray(e.v1),this.v2.fromArray(e.v2),this}},QuadraticBezierCurve:class extends Jn{constructor(e=new pt,t=new pt,i=new pt){super(),this.isQuadraticBezierCurve=!0,this.type="QuadraticBezierCurve",this.v0=e,this.v1=t,this.v2=i}getPoint(e,t=new pt){const i=t,s=this.v0,n=this.v1,r=this.v2;return i.set(or(e,s.x,n.x,r.x),or(e,s.y,n.y,r.y)),i}copy(e){return super.copy(e),this.v0.copy(e.v0),this.v1.copy(e.v1),this.v2.copy(e.v2),this}toJSON(){const e=super.toJSON();return e.v0=this.v0.toArray(),e.v1=this.v1.toArray(),e.v2=this.v2.toArray(),e}fromJSON(e){return super.fromJSON(e),this.v0.fromArray(e.v0),this.v1.fromArray(e.v1),this.v2.fromArray(e.v2),this}},QuadraticBezierCurve3:dr,SplineCurve:class extends Jn{constructor(e=[]){super(),this.isSplineCurve=!0,this.type="SplineCurve",this.points=e}getPoint(e,t=new pt){const i=t,s=this.points,n=(s.length-1)*e,r=Math.floor(n),a=n-r,o=s[0===r?r:r-1],l=s[r],d=s[r>s.length-2?s.length-1:r+1],c=s[r>s.length-3?s.length-1:r+2];return i.set(ar(a,o.x,l.x,d.x,c.x),ar(a,o.y,l.y,d.y,c.y)),i}copy(e){super.copy(e),this.points=[];for(let t=0,i=e.points.length;t<i;t++){const i=e.points[t];this.points.push(i.clone())}return this}toJSON(){const e=super.toJSON();e.points=[];for(let t=0,i=this.points.length;t<i;t++){const i=this.points[t];e.points.push(i.toArray())}return e}fromJSON(e){super.fromJSON(e),this.points=[];for(let t=0,i=e.points.length;t<i;t++){const i=e.points[t];this.points.push((new pt).fromArray(i))}return this}}});class hr extends Zn{constructor(e=1,t=0){const i=(1+Math.sqrt(5))/2;super([-1,i,0,1,i,0,-1,-i,0,1,-i,0,0,-1,i,0,1,i,0,-1,-i,0,1,-i,i,0,-1,i,0,1,-i,0,-1,-i,0,1],[0,11,5,0,5,1,0,1,7,0,7,10,0,10,11,1,5,9,5,11,4,11,10,2,10,7,6,7,1,8,3,9,4,3,4,2,3,2,6,3,6,8,3,8,9,4,9,5,2,4,11,6,2,10,8,6,7,9,8,1],e,t),this.type="IcosahedronGeometry",this.parameters={radius:e,detail:t}}static fromJSON(e){return new hr(e.radius,e.detail)}}class pr extends Ts{constructor(e=1,t=1,i=1,s=1){super(),this.type="PlaneGeometry",this.parameters={width:e,height:t,widthSegments:i,heightSegments:s};const n=e/2,r=t/2,a=Math.floor(i),o=Math.floor(s),l=a+1,d=o+1,c=e/a,h=t/o,p=[],u=[],m=[],f=[];for(let e=0;e<d;e++){const t=e*h-r;for(let i=0;i<l;i++){const s=i*c-n;u.push(s,-t,0),m.push(0,0,1),f.push(i/a),f.push(1-e/o)}}for(let e=0;e<o;e++)for(let t=0;t<a;t++){const i=t+l*e,s=t+l*(e+1),n=t+1+l*(e+1),r=t+1+l*e;p.push(i,s,r),p.push(s,n,r)}this.setIndex(p),this.setAttribute("position",new vs(u,3)),this.setAttribute("normal",new vs(m,3)),this.setAttribute("uv",new vs(f,2))}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}static fromJSON(e){return new pr(e.width,e.height,e.widthSegments,e.heightSegments)}}class ur extends Ts{constructor(e=1,t=32,i=16,s=0,n=2*Math.PI,r=0,a=Math.PI){super(),this.type="SphereGeometry",this.parameters={radius:e,widthSegments:t,heightSegments:i,phiStart:s,phiLength:n,thetaStart:r,thetaLength:a},t=Math.max(3,Math.floor(t)),i=Math.max(2,Math.floor(i));const o=Math.min(r+a,Math.PI);let l=0;const d=[],c=new mt,h=new mt,p=[],u=[],m=[],f=[];for(let p=0;p<=i;p++){const g=[],b=p/i;let C=0;0===p&&0===r?C=.5/t:p===i&&o===Math.PI&&(C=-.5/t);for(let i=0;i<=t;i++){const o=i/t;c.x=-e*Math.cos(s+o*n)*Math.sin(r+b*a),c.y=e*Math.cos(r+b*a),c.z=e*Math.sin(s+o*n)*Math.sin(r+b*a),u.push(c.x,c.y,c.z),h.copy(c).normalize(),m.push(h.x,h.y,h.z),f.push(o+C,1-b),g.push(l++)}d.push(g)}for(let e=0;e<i;e++)for(let s=0;s<t;s++){const t=d[e][s+1],n=d[e][s],a=d[e+1][s],l=d[e+1][s+1];(0!==e||r>0)&&p.push(t,n,l),(e!==i-1||o<Math.PI)&&p.push(n,a,l)}this.setIndex(p),this.setAttribute("position",new vs(u,3)),this.setAttribute("normal",new vs(m,3)),this.setAttribute("uv",new vs(f,2))}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}static fromJSON(e){return new ur(e.radius,e.widthSegments,e.heightSegments,e.phiStart,e.phiLength,e.thetaStart,e.thetaLength)}}class mr extends Ts{constructor(e=new dr(new mt(-1,-1,0),new mt(-1,1,0),new mt(1,1,0)),t=64,i=1,s=8,n=!1){super(),this.type="TubeGeometry",this.parameters={path:e,tubularSegments:t,radius:i,radialSegments:s,closed:n};const r=e.computeFrenetFrames(t,n);this.tangents=r.tangents,this.normals=r.normals,this.binormals=r.binormals;const a=new mt,o=new mt,l=new pt;let d=new mt;const c=[],h=[],p=[],u=[];function m(n){d=e.getPointAt(n/t,d);const l=r.normals[n],p=r.binormals[n];for(let e=0;e<=s;e++){const t=e/s*Math.PI*2,n=Math.sin(t),r=-Math.cos(t);o.x=r*l.x+n*p.x,o.y=r*l.y+n*p.y,o.z=r*l.z+n*p.z,o.normalize(),h.push(o.x,o.y,o.z),a.x=d.x+i*o.x,a.y=d.y+i*o.y,a.z=d.z+i*o.z,c.push(a.x,a.y,a.z)}}!function(){for(let e=0;e<t;e++)m(e);m(!1===n?t:0),function(){for(let e=0;e<=t;e++)for(let i=0;i<=s;i++)l.x=e/t,l.y=i/s,p.push(l.x,l.y)}(),function(){for(let e=1;e<=t;e++)for(let t=1;t<=s;t++){const i=(s+1)*(e-1)+(t-1),n=(s+1)*e+(t-1),r=(s+1)*e+t,a=(s+1)*(e-1)+t;u.push(i,n,a),u.push(n,r,a)}}()}(),this.setIndex(u),this.setAttribute("position",new vs(c,3)),this.setAttribute("normal",new vs(h,3)),this.setAttribute("uv",new vs(p,2))}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}toJSON(){const e=super.toJSON();return e.path=this.parameters.path.toJSON(),e}static fromJSON(e){return new mr((new cr[e.path.type]).fromJSON(e.path),e.tubularSegments,e.radius,e.radialSegments,e.closed)}}class fr extends hs{constructor(e){super(),this.isMeshStandardMaterial=!0,this.type="MeshStandardMaterial",this.defines={STANDARD:""},this.color=new ls(16777215),this.roughness=1,this.metalness=0,this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.emissive=new ls(0),this.emissiveIntensity=1,this.emissiveMap=null,this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=0,this.normalScale=new pt(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.roughnessMap=null,this.metalnessMap=null,this.alphaMap=null,this.envMap=null,this.envMapRotation=new Mi,this.envMapIntensity=1,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.flatShading=!1,this.fog=!0,this.setValues(e)}copy(e){return super.copy(e),this.defines={STANDARD:""},this.color.copy(e.color),this.roughness=e.roughness,this.metalness=e.metalness,this.map=e.map,this.lightMap=e.lightMap,this.lightMapIntensity=e.lightMapIntensity,this.aoMap=e.aoMap,this.aoMapIntensity=e.aoMapIntensity,this.emissive.copy(e.emissive),this.emissiveMap=e.emissiveMap,this.emissiveIntensity=e.emissiveIntensity,this.bumpMap=e.bumpMap,this.bumpScale=e.bumpScale,this.normalMap=e.normalMap,this.normalMapType=e.normalMapType,this.normalScale.copy(e.normalScale),this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this.roughnessMap=e.roughnessMap,this.metalnessMap=e.metalnessMap,this.alphaMap=e.alphaMap,this.envMap=e.envMap,this.envMapRotation.copy(e.envMapRotation),this.envMapIntensity=e.envMapIntensity,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.wireframeLinecap=e.wireframeLinecap,this.wireframeLinejoin=e.wireframeLinejoin,this.flatShading=e.flatShading,this.fog=e.fog,this}}class gr extends hs{constructor(e){super(),this.isMeshPhongMaterial=!0,this.type="MeshPhongMaterial",this.color=new ls(16777215),this.specular=new ls(1118481),this.shininess=30,this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.emissive=new ls(0),this.emissiveIntensity=1,this.emissiveMap=null,this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=0,this.normalScale=new pt(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.specularMap=null,this.alphaMap=null,this.envMap=null,this.envMapRotation=new Mi,this.combine=0,this.reflectivity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.flatShading=!1,this.fog=!0,this.setValues(e)}copy(e){return super.copy(e),this.color.copy(e.color),this.specular.copy(e.specular),this.shininess=e.shininess,this.map=e.map,this.lightMap=e.lightMap,this.lightMapIntensity=e.lightMapIntensity,this.aoMap=e.aoMap,this.aoMapIntensity=e.aoMapIntensity,this.emissive.copy(e.emissive),this.emissiveMap=e.emissiveMap,this.emissiveIntensity=e.emissiveIntensity,this.bumpMap=e.bumpMap,this.bumpScale=e.bumpScale,this.normalMap=e.normalMap,this.normalMapType=e.normalMapType,this.normalScale.copy(e.normalScale),this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this.specularMap=e.specularMap,this.alphaMap=e.alphaMap,this.envMap=e.envMap,this.envMapRotation.copy(e.envMapRotation),this.combine=e.combine,this.reflectivity=e.reflectivity,this.refractionRatio=e.refractionRatio,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.wireframeLinecap=e.wireframeLinecap,this.wireframeLinejoin=e.wireframeLinejoin,this.flatShading=e.flatShading,this.fog=e.fog,this}}class br extends hs{constructor(e){super(),this.isMeshDepthMaterial=!0,this.type="MeshDepthMaterial",this.depthPacking=3200,this.map=null,this.alphaMap=null,this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.wireframe=!1,this.wireframeLinewidth=1,this.setValues(e)}copy(e){return super.copy(e),this.depthPacking=e.depthPacking,this.map=e.map,this.alphaMap=e.alphaMap,this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this}}class Cr extends hs{constructor(e){super(),this.isMeshDistanceMaterial=!0,this.type="MeshDistanceMaterial",this.map=null,this.alphaMap=null,this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.setValues(e)}copy(e){return super.copy(e),this.map=e.map,this.alphaMap=e.alphaMap,this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this}}class vr extends Ln{constructor(e){super(),this.isLineDashedMaterial=!0,this.type="LineDashedMaterial",this.scale=1,this.dashSize=3,this.gapSize=1,this.setValues(e)}copy(e){return super.copy(e),this.scale=e.scale,this.dashSize=e.dashSize,this.gapSize=e.gapSize,this}}class _r{constructor(e,t,i,s){this.parameterPositions=e,this._cachedIndex=0,this.resultBuffer=void 0!==s?s:new t.constructor(i),this.sampleValues=t,this.valueSize=i,this.settings=null,this.DefaultSettings_={}}evaluate(e){const t=this.parameterPositions;let i=this._cachedIndex,s=t[i],n=t[i-1];e:{t:{let r;i:{s:if(!(e<s)){for(let r=i+2;;){if(void 0===s){if(e<n)break s;return i=t.length,this._cachedIndex=i,this.copySampleValue_(i-1)}if(i===r)break;if(n=s,s=t[++i],e<s)break t}r=t.length;break i}if(e>=n)break e;{const a=t[1];e<a&&(i=2,n=a);for(let r=i-2;;){if(void 0===n)return this._cachedIndex=0,this.copySampleValue_(0);if(i===r)break;if(s=n,n=t[--i-1],e>=n)break t}r=i,i=0}}for(;i<r;){const s=i+r>>>1;e<t[s]?r=s:i=s+1}if(s=t[i],n=t[i-1],void 0===n)return this._cachedIndex=0,this.copySampleValue_(0);if(void 0===s)return i=t.length,this._cachedIndex=i,this.copySampleValue_(i-1)}this._cachedIndex=i,this.intervalChanged_(i,n,s)}return this.interpolate_(i,n,e,s)}getSettings_(){return this.settings||this.DefaultSettings_}copySampleValue_(e){const t=this.resultBuffer,i=this.sampleValues,s=this.valueSize,n=e*s;for(let e=0;e!==s;++e)t[e]=i[n+e];return t}interpolate_(){throw new Error("call to abstract method")}intervalChanged_(){}}const yr={enabled:!1,files:{},add:function(e,t){!1!==this.enabled&&(this.files[e]=t)},get:function(e){if(!1!==this.enabled)return this.files[e]},remove:function(e){delete this.files[e]},clear:function(){this.files={}}};class Sr{constructor(e,t,i){const s=this;let n,r=!1,a=0,o=0;const l=[];this.onStart=void 0,this.onLoad=e,this.onProgress=t,this.onError=i,this.itemStart=function(e){o++,!1===r&&void 0!==s.onStart&&s.onStart(e,a,o),r=!0},this.itemEnd=function(e){a++,void 0!==s.onProgress&&s.onProgress(e,a,o),a===o&&(r=!1,void 0!==s.onLoad&&s.onLoad())},this.itemError=function(e){void 0!==s.onError&&s.onError(e)},this.resolveURL=function(e){return n?n(e):e},this.setURLModifier=function(e){return n=e,this},this.addHandler=function(e,t){return l.push(e,t),this},this.removeHandler=function(e){const t=l.indexOf(e);return-1!==t&&l.splice(t,2),this},this.getHandler=function(e){for(let t=0,i=l.length;t<i;t+=2){const i=l[t],s=l[t+1];if(i.global&&(i.lastIndex=0),i.test(e))return s}return null}}}const wr=new Sr;class xr{constructor(e){this.manager=void 0!==e?e:wr,this.crossOrigin="anonymous",this.withCredentials=!1,this.path="",this.resourcePath="",this.requestHeader={}}load(){}loadAsync(e,t){const i=this;return new Promise((function(s,n){i.load(e,s,t,n)}))}parse(){}setCrossOrigin(e){return this.crossOrigin=e,this}setWithCredentials(e){return this.withCredentials=e,this}setPath(e){return this.path=e,this}setResourcePath(e){return this.resourcePath=e,this}setRequestHeader(e){return this.requestHeader=e,this}}xr.DEFAULT_MATERIAL_NAME="__DEFAULT";const Ar={};class Mr extends Error{constructor(e,t){super(e),this.response=t}}class Tr extends xr{constructor(e){super(e),this.mimeType="",this.responseType=""}load(e,t,i,s){void 0===e&&(e=""),void 0!==this.path&&(e=this.path+e),e=this.manager.resolveURL(e);const n=yr.get(e);if(void 0!==n)return this.manager.itemStart(e),setTimeout((()=>{t&&t(n),this.manager.itemEnd(e)}),0),n;if(void 0!==Ar[e])return void Ar[e].push({onLoad:t,onProgress:i,onError:s});Ar[e]=[],Ar[e].push({onLoad:t,onProgress:i,onError:s});const r=new Request(e,{headers:new Headers(this.requestHeader),credentials:this.withCredentials?"include":"same-origin"}),a=this.mimeType,o=this.responseType;fetch(r).then((t=>{if(200===t.status||0===t.status){if(0===t.status&&console.warn("THREE.FileLoader: HTTP Status 0 received."),"undefined"==typeof ReadableStream||void 0===t.body||void 0===t.body.getReader)return t;const i=Ar[e],s=t.body.getReader(),n=t.headers.get("X-File-Size")||t.headers.get("Content-Length"),r=n?parseInt(n):0,a=0!==r;let o=0;const l=new ReadableStream({start(e){!function t(){s.read().then((({done:s,value:n})=>{if(s)e.close();else{o+=n.byteLength;const s=new ProgressEvent("progress",{lengthComputable:a,loaded:o,total:r});for(let e=0,t=i.length;e<t;e++){const t=i[e];t.onProgress&&t.onProgress(s)}e.enqueue(n),t()}}),(t=>{e.error(t)}))}()}});return new Response(l)}throw new Mr(`fetch for "${t.url}" responded with ${t.status}: ${t.statusText}`,t)})).then((e=>{switch(o){case"arraybuffer":return e.arrayBuffer();case"blob":return e.blob();case"document":return e.text().then((e=>(new DOMParser).parseFromString(e,a)));case"json":return e.json();default:if(""===a)return e.text();{const t=/charset="?([^;"\s]*)"?/i.exec(a),i=t&&t[1]?t[1].toLowerCase():void 0,s=new TextDecoder(i);return e.arrayBuffer().then((e=>s.decode(e)))}}})).then((t=>{yr.add(e,t);const i=Ar[e];delete Ar[e];for(let e=0,s=i.length;e<s;e++){const s=i[e];s.onLoad&&s.onLoad(t)}})).catch((t=>{const i=Ar[e];if(void 0===i)throw this.manager.itemError(e),t;delete Ar[e];for(let e=0,s=i.length;e<s;e++){const s=i[e];s.onError&&s.onError(t)}this.manager.itemError(e)})).finally((()=>{this.manager.itemEnd(e)})),this.manager.itemStart(e)}setResponseType(e){return this.responseType=e,this}setMimeType(e){return this.mimeType=e,this}}class Er extends ji{constructor(e,t=1){super(),this.isLight=!0,this.type="Light",this.color=new ls(e),this.intensity=t}dispose(){}copy(e,t){return super.copy(e,t),this.color.copy(e.color),this.intensity=e.intensity,this}toJSON(e){const t=super.toJSON(e);return t.object.color=this.color.getHex(),t.object.intensity=this.intensity,void 0!==this.groundColor&&(t.object.groundColor=this.groundColor.getHex()),void 0!==this.distance&&(t.object.distance=this.distance),void 0!==this.angle&&(t.object.angle=this.angle),void 0!==this.decay&&(t.object.decay=this.decay),void 0!==this.penumbra&&(t.object.penumbra=this.penumbra),void 0!==this.shadow&&(t.object.shadow=this.shadow.toJSON()),void 0!==this.target&&(t.object.target=this.target.uuid),t}}const Rr=new gi,kr=new mt,Or=new mt;class Ir{constructor(e){this.camera=e,this.intensity=1,this.bias=0,this.normalBias=0,this.radius=1,this.blurSamples=8,this.mapSize=new pt(512,512),this.mapType=j,this.map=null,this.mapPass=null,this.matrix=new gi,this.autoUpdate=!0,this.needsUpdate=!1,this._frustum=new Dn,this._frameExtents=new pt(1,1),this._viewportCount=1,this._viewports=[new Ut(0,0,1,1)]}getViewportCount(){return this._viewportCount}getFrustum(){return this._frustum}updateMatrices(e){const t=this.camera,i=this.matrix;kr.setFromMatrixPosition(e.matrixWorld),t.position.copy(kr),Or.setFromMatrixPosition(e.target.matrixWorld),t.lookAt(Or),t.updateMatrixWorld(),Rr.multiplyMatrices(t.projectionMatrix,t.matrixWorldInverse),this._frustum.setFromProjectionMatrix(Rr),i.set(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1),i.multiply(Rr)}getViewport(e){return this._viewports[e]}getFrameExtents(){return this._frameExtents}dispose(){this.map&&this.map.dispose(),this.mapPass&&this.mapPass.dispose()}copy(e){return this.camera=e.camera.clone(),this.intensity=e.intensity,this.bias=e.bias,this.radius=e.radius,this.autoUpdate=e.autoUpdate,this.needsUpdate=e.needsUpdate,this.normalBias=e.normalBias,this.blurSamples=e.blurSamples,this.mapSize.copy(e.mapSize),this}clone(){return(new this.constructor).copy(this)}toJSON(){const e={};return 1!==this.intensity&&(e.intensity=this.intensity),0!==this.bias&&(e.bias=this.bias),0!==this.normalBias&&(e.normalBias=this.normalBias),1!==this.radius&&(e.radius=this.radius),512===this.mapSize.x&&512===this.mapSize.y||(e.mapSize=this.mapSize.toArray()),e.camera=this.camera.toJSON(!1).object,delete e.camera.matrix,e}}class Pr extends Ws{constructor(e=-1,t=1,i=1,s=-1,n=.1,r=2e3){super(),this.isOrthographicCamera=!0,this.type="OrthographicCamera",this.zoom=1,this.view=null,this.left=e,this.right=t,this.top=i,this.bottom=s,this.near=n,this.far=r,this.updateProjectionMatrix()}copy(e,t){return super.copy(e,t),this.left=e.left,this.right=e.right,this.top=e.top,this.bottom=e.bottom,this.near=e.near,this.far=e.far,this.zoom=e.zoom,this.view=null===e.view?null:Object.assign({},e.view),this}setViewOffset(e,t,i,s,n,r){null===this.view&&(this.view={enabled:!0,fullWidth:1,fullHeight:1,offsetX:0,offsetY:0,width:1,height:1}),this.view.enabled=!0,this.view.fullWidth=e,this.view.fullHeight=t,this.view.offsetX=i,this.view.offsetY=s,this.view.width=n,this.view.height=r,this.updateProjectionMatrix()}clearViewOffset(){null!==this.view&&(this.view.enabled=!1),this.updateProjectionMatrix()}updateProjectionMatrix(){const e=(this.right-this.left)/(2*this.zoom),t=(this.top-this.bottom)/(2*this.zoom),i=(this.right+this.left)/2,s=(this.top+this.bottom)/2;let n=i-e,r=i+e,a=s+t,o=s-t;if(null!==this.view&&this.view.enabled){const e=(this.right-this.left)/this.view.fullWidth/this.zoom,t=(this.top-this.bottom)/this.view.fullHeight/this.zoom;n+=e*this.view.offsetX,r=n+e*this.view.width,a-=t*this.view.offsetY,o=a-t*this.view.height}this.projectionMatrix.makeOrthographic(n,r,a,o,this.near,this.far,this.coordinateSystem),this.projectionMatrixInverse.copy(this.projectionMatrix).invert()}toJSON(e){const t=super.toJSON(e);return t.object.zoom=this.zoom,t.object.left=this.left,t.object.right=this.right,t.object.top=this.top,t.object.bottom=this.bottom,t.object.near=this.near,t.object.far=this.far,null!==this.view&&(t.object.view=Object.assign({},this.view)),t}}class Dr extends Ir{constructor(){super(new Pr(-5,5,5,-5,.5,500)),this.isDirectionalLightShadow=!0}}class Lr extends Er{constructor(e,t){super(e,t),this.isDirectionalLight=!0,this.type="DirectionalLight",this.position.copy(ji.DEFAULT_UP),this.updateMatrix(),this.target=new ji,this.shadow=new Dr}dispose(){this.shadow.dispose()}copy(e){return super.copy(e),this.target=e.target.clone(),this.shadow=e.shadow.clone(),this}}class Fr extends Er{constructor(e,t){super(e,t),this.isAmbientLight=!0,this.type="AmbientLight"}}class Nr{static extractUrlBase(e){const t=e.lastIndexOf("/");return-1===t?"./":e.slice(0,t+1)}static resolveURL(e,t){return"string"!=typeof e||""===e?"":(/^https?:\/\//i.test(t)&&/^\//.test(e)&&(t=t.replace(/(^https?:\/\/[^\/]+).*/i,"$1")),/^(https?:)?\/\//i.test(e)||/^data:.*,.*$/i.test(e)||/^blob:.*$/i.test(e)?e:t+e)}}class Ur extends Ts{constructor(){super(),this.isInstancedBufferGeometry=!0,this.type="InstancedBufferGeometry",this.instanceCount=1/0}copy(e){return super.copy(e),this.instanceCount=e.instanceCount,this}toJSON(){const e=super.toJSON();return e.instanceCount=this.instanceCount,e.isInstancedBufferGeometry=!0,e}}class Hr extends Zs{constructor(e=[]){super(),this.isArrayCamera=!0,this.isMultiViewCamera=!1,this.cameras=e}}class Br{constructor(e=!0){this.autoStart=e,this.startTime=0,this.oldTime=0,this.elapsedTime=0,this.running=!1}start(){this.startTime=zr(),this.oldTime=this.startTime,this.elapsedTime=0,this.running=!0}stop(){this.getElapsedTime(),this.running=!1,this.autoStart=!1}getElapsedTime(){return this.getDelta(),this.elapsedTime}getDelta(){let e=0;if(this.autoStart&&!this.running)return this.start(),0;if(this.running){const t=zr();e=(t-this.oldTime)/1e3,this.oldTime=t,this.elapsedTime+=e}return e}}function zr(){return performance.now()}const qr=new gi;class jr{constructor(e,t,i=0,s=1/0){this.ray=new fi(e,t),this.near=i,this.far=s,this.camera=null,this.layers=new Ti,this.params={Mesh:{},Line:{threshold:1},LOD:{},Points:{threshold:1},Sprite:{}}}set(e,t){this.ray.set(e,t)}setFromCamera(e,t){t.isPerspectiveCamera?(this.ray.origin.setFromMatrixPosition(t.matrixWorld),this.ray.direction.set(e.x,e.y,.5).unproject(t).sub(this.ray.origin).normalize(),this.camera=t):t.isOrthographicCamera?(this.ray.origin.set(e.x,e.y,(t.near+t.far)/(t.near-t.far)).unproject(t),this.ray.direction.set(0,0,-1).transformDirection(t.matrixWorld),this.camera=t):console.error("THREE.Raycaster: Unsupported camera type: "+t.type)}setFromXRController(e){return qr.identity().extractRotation(e.matrixWorld),this.ray.origin.setFromMatrixPosition(e.matrixWorld),this.ray.direction.set(0,0,-1).applyMatrix4(qr),this}intersectObject(e,t=!0,i=[]){return $r(e,this,i,t),i.sort(Gr),i}intersectObjects(e,t=!0,i=[]){for(let s=0,n=e.length;s<n;s++)$r(e[s],this,i,t);return i.sort(Gr),i}}function Gr(e,t){return e.distance-t.distance}function $r(e,t,i,s){let n=!0;if(e.layers.test(t.layers)){!1===e.raycast(t,i)&&(n=!1)}if(!0===n&&!0===s){const s=e.children;for(let e=0,n=s.length;e<n;e++)$r(s[e],t,i,!0)}}const Vr=new mt,Wr=new mt;class Xr{constructor(e=new mt,t=new mt){this.start=e,this.end=t}set(e,t){return this.start.copy(e),this.end.copy(t),this}copy(e){return this.start.copy(e.start),this.end.copy(e.end),this}getCenter(e){return e.addVectors(this.start,this.end).multiplyScalar(.5)}delta(e){return e.subVectors(this.end,this.start)}distanceSq(){return this.start.distanceToSquared(this.end)}distance(){return this.start.distanceTo(this.end)}at(e,t){return this.delta(t).multiplyScalar(e).add(this.start)}closestPointToPointParameter(e,t){Vr.subVectors(e,this.start),Wr.subVectors(this.end,this.start);const i=Wr.dot(Wr);let s=Wr.dot(Vr)/i;return t&&(s=lt(s,0,1)),s}closestPointToPoint(e,t,i){const s=this.closestPointToPointParameter(e,t);return this.delta(i).multiplyScalar(s).add(this.start)}applyMatrix4(e){return this.start.applyMatrix4(e),this.end.applyMatrix4(e),this}equals(e){return e.start.equals(this.start)&&e.end.equals(this.end)}clone(){return(new this.constructor).copy(this)}}function Yr(e,t,i,s){const n=function(e){switch(e){case j:case G:return{byteLength:1,components:1};case W:case V:case Z:return{byteLength:2,components:1};case J:case Q:return{byteLength:2,components:4};case Y:case X:case K:return{byteLength:4,components:1};case te:return{byteLength:4,components:3}}throw new Error(`Unknown texture type ${e}.`)}(s);switch(i){case 1021:return e*t;case 1028:case re:return e*t/n.components*n.byteLength;case 1030:case ae:return e*t*2/n.components*n.byteLength;case 1022:return e*t*3/n.components*n.byteLength;case ie:case oe:return e*t*4/n.components*n.byteLength;case le:case de:return Math.floor((e+3)/4)*Math.floor((t+3)/4)*8;case ce:case he:return Math.floor((e+3)/4)*Math.floor((t+3)/4)*16;case ue:case fe:return Math.max(e,16)*Math.max(t,8)/4;case pe:case me:return Math.max(e,8)*Math.max(t,8)/2;case ge:case be:return Math.floor((e+3)/4)*Math.floor((t+3)/4)*8;case Ce:case ve:return Math.floor((e+3)/4)*Math.floor((t+3)/4)*16;case _e:return Math.floor((e+4)/5)*Math.floor((t+3)/4)*16;case ye:return Math.floor((e+4)/5)*Math.floor((t+4)/5)*16;case Se:return Math.floor((e+5)/6)*Math.floor((t+4)/5)*16;case we:return Math.floor((e+5)/6)*Math.floor((t+5)/6)*16;case xe:return Math.floor((e+7)/8)*Math.floor((t+4)/5)*16;case Ae:return Math.floor((e+7)/8)*Math.floor((t+5)/6)*16;case Me:return Math.floor((e+7)/8)*Math.floor((t+7)/8)*16;case Te:return Math.floor((e+9)/10)*Math.floor((t+4)/5)*16;case Ee:return Math.floor((e+9)/10)*Math.floor((t+5)/6)*16;case Re:return Math.floor((e+9)/10)*Math.floor((t+7)/8)*16;case ke:return Math.floor((e+9)/10)*Math.floor((t+9)/10)*16;case Oe:return Math.floor((e+11)/12)*Math.floor((t+9)/10)*16;case Ie:return Math.floor((e+11)/12)*Math.floor((t+11)/12)*16;case Pe:case De:case Le:return Math.ceil(e/4)*Math.ceil(t/4)*16;case 36283:case Fe:return Math.ceil(e/4)*Math.ceil(t/4)*8;case Ne:case Ue:return Math.ceil(e/4)*Math.ceil(t/4)*16}throw new Error(`Unable to determine texture byte length for ${i} format.`)}
/**
	 * @license
	 * Copyright 2010-2025 Three.js Authors
	 * SPDX-License-Identifier: MIT
	 */
function Kr(){let e=null,t=!1,i=null,s=null;function n(t,r){i(t,r),s=e.requestAnimationFrame(n)}return{start:function(){!0!==t&&null!==i&&(s=e.requestAnimationFrame(n),t=!0)},stop:function(){e.cancelAnimationFrame(s),t=!1},setAnimationLoop:function(e){i=e},setContext:function(t){e=t}}}function Zr(e){const t=new WeakMap;return{get:function(e){return e.isInterleavedBufferAttribute&&(e=e.data),t.get(e)},remove:function(i){i.isInterleavedBufferAttribute&&(i=i.data);const s=t.get(i);s&&(e.deleteBuffer(s.buffer),t.delete(i))},update:function(i,s){if(i.isInterleavedBufferAttribute&&(i=i.data),i.isGLBufferAttribute){const e=t.get(i);return void((!e||e.version<i.version)&&t.set(i,{buffer:i.buffer,type:i.type,bytesPerElement:i.elementSize,version:i.version}))}const n=t.get(i);if(void 0===n)t.set(i,function(t,i){const s=t.array,n=t.usage,r=s.byteLength,a=e.createBuffer();let o;if(e.bindBuffer(i,a),e.bufferData(i,s,n),t.onUploadCallback(),s instanceof Float32Array)o=e.FLOAT;else if(s instanceof Uint16Array)o=t.isFloat16BufferAttribute?e.HALF_FLOAT:e.UNSIGNED_SHORT;else if(s instanceof Int16Array)o=e.SHORT;else if(s instanceof Uint32Array)o=e.UNSIGNED_INT;else if(s instanceof Int32Array)o=e.INT;else if(s instanceof Int8Array)o=e.BYTE;else if(s instanceof Uint8Array)o=e.UNSIGNED_BYTE;else{if(!(s instanceof Uint8ClampedArray))throw new Error("THREE.WebGLAttributes: Unsupported buffer data format: "+s);o=e.UNSIGNED_BYTE}return{buffer:a,type:o,bytesPerElement:s.BYTES_PER_ELEMENT,version:t.version,size:r}}(i,s));else if(n.version<i.version){if(n.size!==i.array.byteLength)throw new Error("THREE.WebGLAttributes: The size of the buffer attribute's array buffer does not match the original size. Resizing buffer attributes is not supported.");!function(t,i,s){const n=i.array,r=i.updateRanges;if(e.bindBuffer(s,t),0===r.length)e.bufferSubData(s,0,n);else{r.sort(((e,t)=>e.start-t.start));let t=0;for(let e=1;e<r.length;e++){const i=r[t],s=r[e];s.start<=i.start+i.count+1?i.count=Math.max(i.count,s.start+s.count-i.start):(++t,r[t]=s)}r.length=t+1;for(let t=0,i=r.length;t<i;t++){const i=r[t];e.bufferSubData(s,i.start*n.BYTES_PER_ELEMENT,n,i.start,i.count)}i.clearUpdateRanges()}i.onUploadCallback()}(n.buffer,i,s),n.version=i.version}}}}"undefined"!=typeof __THREE_DEVTOOLS__&&__THREE_DEVTOOLS__.dispatchEvent(new CustomEvent("register",{detail:{revision:t}})),"undefined"!=typeof window&&(window.__THREE__?console.warn("WARNING: Multiple instances of Three.js being imported."):window.__THREE__=t);const Jr={alphahash_fragment:"#ifdef USE_ALPHAHASH\n\tif ( diffuseColor.a < getAlphaHashThreshold( vPosition ) ) discard;\n#endif",alphahash_pars_fragment:"#ifdef USE_ALPHAHASH\n\tconst float ALPHA_HASH_SCALE = 0.05;\n\tfloat hash2D( vec2 value ) {\n\t\treturn fract( 1.0e4 * sin( 17.0 * value.x + 0.1 * value.y ) * ( 0.1 + abs( sin( 13.0 * value.y + value.x ) ) ) );\n\t}\n\tfloat hash3D( vec3 value ) {\n\t\treturn hash2D( vec2( hash2D( value.xy ), value.z ) );\n\t}\n\tfloat getAlphaHashThreshold( vec3 position ) {\n\t\tfloat maxDeriv = max(\n\t\t\tlength( dFdx( position.xyz ) ),\n\t\t\tlength( dFdy( position.xyz ) )\n\t\t);\n\t\tfloat pixScale = 1.0 / ( ALPHA_HASH_SCALE * maxDeriv );\n\t\tvec2 pixScales = vec2(\n\t\t\texp2( floor( log2( pixScale ) ) ),\n\t\t\texp2( ceil( log2( pixScale ) ) )\n\t\t);\n\t\tvec2 alpha = vec2(\n\t\t\thash3D( floor( pixScales.x * position.xyz ) ),\n\t\t\thash3D( floor( pixScales.y * position.xyz ) )\n\t\t);\n\t\tfloat lerpFactor = fract( log2( pixScale ) );\n\t\tfloat x = ( 1.0 - lerpFactor ) * alpha.x + lerpFactor * alpha.y;\n\t\tfloat a = min( lerpFactor, 1.0 - lerpFactor );\n\t\tvec3 cases = vec3(\n\t\t\tx * x / ( 2.0 * a * ( 1.0 - a ) ),\n\t\t\t( x - 0.5 * a ) / ( 1.0 - a ),\n\t\t\t1.0 - ( ( 1.0 - x ) * ( 1.0 - x ) / ( 2.0 * a * ( 1.0 - a ) ) )\n\t\t);\n\t\tfloat threshold = ( x < ( 1.0 - a ) )\n\t\t\t? ( ( x < a ) ? cases.x : cases.y )\n\t\t\t: cases.z;\n\t\treturn clamp( threshold , 1.0e-6, 1.0 );\n\t}\n#endif",alphamap_fragment:"#ifdef USE_ALPHAMAP\n\tdiffuseColor.a *= texture2D( alphaMap, vAlphaMapUv ).g;\n#endif",alphamap_pars_fragment:"#ifdef USE_ALPHAMAP\n\tuniform sampler2D alphaMap;\n#endif",alphatest_fragment:"#ifdef USE_ALPHATEST\n\t#ifdef ALPHA_TO_COVERAGE\n\tdiffuseColor.a = smoothstep( alphaTest, alphaTest + fwidth( diffuseColor.a ), diffuseColor.a );\n\tif ( diffuseColor.a == 0.0 ) discard;\n\t#else\n\tif ( diffuseColor.a < alphaTest ) discard;\n\t#endif\n#endif",alphatest_pars_fragment:"#ifdef USE_ALPHATEST\n\tuniform float alphaTest;\n#endif",aomap_fragment:"#ifdef USE_AOMAP\n\tfloat ambientOcclusion = ( texture2D( aoMap, vAoMapUv ).r - 1.0 ) * aoMapIntensity + 1.0;\n\treflectedLight.indirectDiffuse *= ambientOcclusion;\n\t#if defined( USE_CLEARCOAT ) \n\t\tclearcoatSpecularIndirect *= ambientOcclusion;\n\t#endif\n\t#if defined( USE_SHEEN ) \n\t\tsheenSpecularIndirect *= ambientOcclusion;\n\t#endif\n\t#if defined( USE_ENVMAP ) && defined( STANDARD )\n\t\tfloat dotNV = saturate( dot( geometryNormal, geometryViewDir ) );\n\t\treflectedLight.indirectSpecular *= computeSpecularOcclusion( dotNV, ambientOcclusion, material.roughness );\n\t#endif\n#endif",aomap_pars_fragment:"#ifdef USE_AOMAP\n\tuniform sampler2D aoMap;\n\tuniform float aoMapIntensity;\n#endif",batching_pars_vertex:"#ifdef USE_BATCHING\n\t#if ! defined( GL_ANGLE_multi_draw )\n\t#define gl_DrawID _gl_DrawID\n\tuniform int _gl_DrawID;\n\t#endif\n\tuniform highp sampler2D batchingTexture;\n\tuniform highp usampler2D batchingIdTexture;\n\tmat4 getBatchingMatrix( const in float i ) {\n\t\tint size = textureSize( batchingTexture, 0 ).x;\n\t\tint j = int( i ) * 4;\n\t\tint x = j % size;\n\t\tint y = j / size;\n\t\tvec4 v1 = texelFetch( batchingTexture, ivec2( x, y ), 0 );\n\t\tvec4 v2 = texelFetch( batchingTexture, ivec2( x + 1, y ), 0 );\n\t\tvec4 v3 = texelFetch( batchingTexture, ivec2( x + 2, y ), 0 );\n\t\tvec4 v4 = texelFetch( batchingTexture, ivec2( x + 3, y ), 0 );\n\t\treturn mat4( v1, v2, v3, v4 );\n\t}\n\tfloat getIndirectIndex( const in int i ) {\n\t\tint size = textureSize( batchingIdTexture, 0 ).x;\n\t\tint x = i % size;\n\t\tint y = i / size;\n\t\treturn float( texelFetch( batchingIdTexture, ivec2( x, y ), 0 ).r );\n\t}\n#endif\n#ifdef USE_BATCHING_COLOR\n\tuniform sampler2D batchingColorTexture;\n\tvec3 getBatchingColor( const in float i ) {\n\t\tint size = textureSize( batchingColorTexture, 0 ).x;\n\t\tint j = int( i );\n\t\tint x = j % size;\n\t\tint y = j / size;\n\t\treturn texelFetch( batchingColorTexture, ivec2( x, y ), 0 ).rgb;\n\t}\n#endif",batching_vertex:"#ifdef USE_BATCHING\n\tmat4 batchingMatrix = getBatchingMatrix( getIndirectIndex( gl_DrawID ) );\n#endif",begin_vertex:"vec3 transformed = vec3( position );\n#ifdef USE_ALPHAHASH\n\tvPosition = vec3( position );\n#endif",beginnormal_vertex:"vec3 objectNormal = vec3( normal );\n#ifdef USE_TANGENT\n\tvec3 objectTangent = vec3( tangent.xyz );\n#endif",bsdfs:"float G_BlinnPhong_Implicit( ) {\n\treturn 0.25;\n}\nfloat D_BlinnPhong( const in float shininess, const in float dotNH ) {\n\treturn RECIPROCAL_PI * ( shininess * 0.5 + 1.0 ) * pow( dotNH, shininess );\n}\nvec3 BRDF_BlinnPhong( const in vec3 lightDir, const in vec3 viewDir, const in vec3 normal, const in vec3 specularColor, const in float shininess ) {\n\tvec3 halfDir = normalize( lightDir + viewDir );\n\tfloat dotNH = saturate( dot( normal, halfDir ) );\n\tfloat dotVH = saturate( dot( viewDir, halfDir ) );\n\tvec3 F = F_Schlick( specularColor, 1.0, dotVH );\n\tfloat G = G_BlinnPhong_Implicit( );\n\tfloat D = D_BlinnPhong( shininess, dotNH );\n\treturn F * ( G * D );\n} // validated",iridescence_fragment:"#ifdef USE_IRIDESCENCE\n\tconst mat3 XYZ_TO_REC709 = mat3(\n\t\t 3.2404542, -0.9692660,  0.0556434,\n\t\t-1.5371385,  1.8760108, -0.2040259,\n\t\t-0.4985314,  0.0415560,  1.0572252\n\t);\n\tvec3 Fresnel0ToIor( vec3 fresnel0 ) {\n\t\tvec3 sqrtF0 = sqrt( fresnel0 );\n\t\treturn ( vec3( 1.0 ) + sqrtF0 ) / ( vec3( 1.0 ) - sqrtF0 );\n\t}\n\tvec3 IorToFresnel0( vec3 transmittedIor, float incidentIor ) {\n\t\treturn pow2( ( transmittedIor - vec3( incidentIor ) ) / ( transmittedIor + vec3( incidentIor ) ) );\n\t}\n\tfloat IorToFresnel0( float transmittedIor, float incidentIor ) {\n\t\treturn pow2( ( transmittedIor - incidentIor ) / ( transmittedIor + incidentIor ));\n\t}\n\tvec3 evalSensitivity( float OPD, vec3 shift ) {\n\t\tfloat phase = 2.0 * PI * OPD * 1.0e-9;\n\t\tvec3 val = vec3( 5.4856e-13, 4.4201e-13, 5.2481e-13 );\n\t\tvec3 pos = vec3( 1.6810e+06, 1.7953e+06, 2.2084e+06 );\n\t\tvec3 var = vec3( 4.3278e+09, 9.3046e+09, 6.6121e+09 );\n\t\tvec3 xyz = val * sqrt( 2.0 * PI * var ) * cos( pos * phase + shift ) * exp( - pow2( phase ) * var );\n\t\txyz.x += 9.7470e-14 * sqrt( 2.0 * PI * 4.5282e+09 ) * cos( 2.2399e+06 * phase + shift[ 0 ] ) * exp( - 4.5282e+09 * pow2( phase ) );\n\t\txyz /= 1.0685e-7;\n\t\tvec3 rgb = XYZ_TO_REC709 * xyz;\n\t\treturn rgb;\n\t}\n\tvec3 evalIridescence( float outsideIOR, float eta2, float cosTheta1, float thinFilmThickness, vec3 baseF0 ) {\n\t\tvec3 I;\n\t\tfloat iridescenceIOR = mix( outsideIOR, eta2, smoothstep( 0.0, 0.03, thinFilmThickness ) );\n\t\tfloat sinTheta2Sq = pow2( outsideIOR / iridescenceIOR ) * ( 1.0 - pow2( cosTheta1 ) );\n\t\tfloat cosTheta2Sq = 1.0 - sinTheta2Sq;\n\t\tif ( cosTheta2Sq < 0.0 ) {\n\t\t\treturn vec3( 1.0 );\n\t\t}\n\t\tfloat cosTheta2 = sqrt( cosTheta2Sq );\n\t\tfloat R0 = IorToFresnel0( iridescenceIOR, outsideIOR );\n\t\tfloat R12 = F_Schlick( R0, 1.0, cosTheta1 );\n\t\tfloat T121 = 1.0 - R12;\n\t\tfloat phi12 = 0.0;\n\t\tif ( iridescenceIOR < outsideIOR ) phi12 = PI;\n\t\tfloat phi21 = PI - phi12;\n\t\tvec3 baseIOR = Fresnel0ToIor( clamp( baseF0, 0.0, 0.9999 ) );\t\tvec3 R1 = IorToFresnel0( baseIOR, iridescenceIOR );\n\t\tvec3 R23 = F_Schlick( R1, 1.0, cosTheta2 );\n\t\tvec3 phi23 = vec3( 0.0 );\n\t\tif ( baseIOR[ 0 ] < iridescenceIOR ) phi23[ 0 ] = PI;\n\t\tif ( baseIOR[ 1 ] < iridescenceIOR ) phi23[ 1 ] = PI;\n\t\tif ( baseIOR[ 2 ] < iridescenceIOR ) phi23[ 2 ] = PI;\n\t\tfloat OPD = 2.0 * iridescenceIOR * thinFilmThickness * cosTheta2;\n\t\tvec3 phi = vec3( phi21 ) + phi23;\n\t\tvec3 R123 = clamp( R12 * R23, 1e-5, 0.9999 );\n\t\tvec3 r123 = sqrt( R123 );\n\t\tvec3 Rs = pow2( T121 ) * R23 / ( vec3( 1.0 ) - R123 );\n\t\tvec3 C0 = R12 + Rs;\n\t\tI = C0;\n\t\tvec3 Cm = Rs - T121;\n\t\tfor ( int m = 1; m <= 2; ++ m ) {\n\t\t\tCm *= r123;\n\t\t\tvec3 Sm = 2.0 * evalSensitivity( float( m ) * OPD, float( m ) * phi );\n\t\t\tI += Cm * Sm;\n\t\t}\n\t\treturn max( I, vec3( 0.0 ) );\n\t}\n#endif",bumpmap_pars_fragment:"#ifdef USE_BUMPMAP\n\tuniform sampler2D bumpMap;\n\tuniform float bumpScale;\n\tvec2 dHdxy_fwd() {\n\t\tvec2 dSTdx = dFdx( vBumpMapUv );\n\t\tvec2 dSTdy = dFdy( vBumpMapUv );\n\t\tfloat Hll = bumpScale * texture2D( bumpMap, vBumpMapUv ).x;\n\t\tfloat dBx = bumpScale * texture2D( bumpMap, vBumpMapUv + dSTdx ).x - Hll;\n\t\tfloat dBy = bumpScale * texture2D( bumpMap, vBumpMapUv + dSTdy ).x - Hll;\n\t\treturn vec2( dBx, dBy );\n\t}\n\tvec3 perturbNormalArb( vec3 surf_pos, vec3 surf_norm, vec2 dHdxy, float faceDirection ) {\n\t\tvec3 vSigmaX = normalize( dFdx( surf_pos.xyz ) );\n\t\tvec3 vSigmaY = normalize( dFdy( surf_pos.xyz ) );\n\t\tvec3 vN = surf_norm;\n\t\tvec3 R1 = cross( vSigmaY, vN );\n\t\tvec3 R2 = cross( vN, vSigmaX );\n\t\tfloat fDet = dot( vSigmaX, R1 ) * faceDirection;\n\t\tvec3 vGrad = sign( fDet ) * ( dHdxy.x * R1 + dHdxy.y * R2 );\n\t\treturn normalize( abs( fDet ) * surf_norm - vGrad );\n\t}\n#endif",clipping_planes_fragment:"#if NUM_CLIPPING_PLANES > 0\n\tvec4 plane;\n\t#ifdef ALPHA_TO_COVERAGE\n\t\tfloat distanceToPlane, distanceGradient;\n\t\tfloat clipOpacity = 1.0;\n\t\t#pragma unroll_loop_start\n\t\tfor ( int i = 0; i < UNION_CLIPPING_PLANES; i ++ ) {\n\t\t\tplane = clippingPlanes[ i ];\n\t\t\tdistanceToPlane = - dot( vClipPosition, plane.xyz ) + plane.w;\n\t\t\tdistanceGradient = fwidth( distanceToPlane ) / 2.0;\n\t\t\tclipOpacity *= smoothstep( - distanceGradient, distanceGradient, distanceToPlane );\n\t\t\tif ( clipOpacity == 0.0 ) discard;\n\t\t}\n\t\t#pragma unroll_loop_end\n\t\t#if UNION_CLIPPING_PLANES < NUM_CLIPPING_PLANES\n\t\t\tfloat unionClipOpacity = 1.0;\n\t\t\t#pragma unroll_loop_start\n\t\t\tfor ( int i = UNION_CLIPPING_PLANES; i < NUM_CLIPPING_PLANES; i ++ ) {\n\t\t\t\tplane = clippingPlanes[ i ];\n\t\t\t\tdistanceToPlane = - dot( vClipPosition, plane.xyz ) + plane.w;\n\t\t\t\tdistanceGradient = fwidth( distanceToPlane ) / 2.0;\n\t\t\t\tunionClipOpacity *= 1.0 - smoothstep( - distanceGradient, distanceGradient, distanceToPlane );\n\t\t\t}\n\t\t\t#pragma unroll_loop_end\n\t\t\tclipOpacity *= 1.0 - unionClipOpacity;\n\t\t#endif\n\t\tdiffuseColor.a *= clipOpacity;\n\t\tif ( diffuseColor.a == 0.0 ) discard;\n\t#else\n\t\t#pragma unroll_loop_start\n\t\tfor ( int i = 0; i < UNION_CLIPPING_PLANES; i ++ ) {\n\t\t\tplane = clippingPlanes[ i ];\n\t\t\tif ( dot( vClipPosition, plane.xyz ) > plane.w ) discard;\n\t\t}\n\t\t#pragma unroll_loop_end\n\t\t#if UNION_CLIPPING_PLANES < NUM_CLIPPING_PLANES\n\t\t\tbool clipped = true;\n\t\t\t#pragma unroll_loop_start\n\t\t\tfor ( int i = UNION_CLIPPING_PLANES; i < NUM_CLIPPING_PLANES; i ++ ) {\n\t\t\t\tplane = clippingPlanes[ i ];\n\t\t\t\tclipped = ( dot( vClipPosition, plane.xyz ) > plane.w ) && clipped;\n\t\t\t}\n\t\t\t#pragma unroll_loop_end\n\t\t\tif ( clipped ) discard;\n\t\t#endif\n\t#endif\n#endif",clipping_planes_pars_fragment:"#if NUM_CLIPPING_PLANES > 0\n\tvarying vec3 vClipPosition;\n\tuniform vec4 clippingPlanes[ NUM_CLIPPING_PLANES ];\n#endif",clipping_planes_pars_vertex:"#if NUM_CLIPPING_PLANES > 0\n\tvarying vec3 vClipPosition;\n#endif",clipping_planes_vertex:"#if NUM_CLIPPING_PLANES > 0\n\tvClipPosition = - mvPosition.xyz;\n#endif",color_fragment:"#if defined( USE_COLOR_ALPHA )\n\tdiffuseColor *= vColor;\n#elif defined( USE_COLOR )\n\tdiffuseColor.rgb *= vColor;\n#endif",color_pars_fragment:"#if defined( USE_COLOR_ALPHA )\n\tvarying vec4 vColor;\n#elif defined( USE_COLOR )\n\tvarying vec3 vColor;\n#endif",color_pars_vertex:"#if defined( USE_COLOR_ALPHA )\n\tvarying vec4 vColor;\n#elif defined( USE_COLOR ) || defined( USE_INSTANCING_COLOR ) || defined( USE_BATCHING_COLOR )\n\tvarying vec3 vColor;\n#endif",color_vertex:"#if defined( USE_COLOR_ALPHA )\n\tvColor = vec4( 1.0 );\n#elif defined( USE_COLOR ) || defined( USE_INSTANCING_COLOR ) || defined( USE_BATCHING_COLOR )\n\tvColor = vec3( 1.0 );\n#endif\n#ifdef USE_COLOR\n\tvColor *= color;\n#endif\n#ifdef USE_INSTANCING_COLOR\n\tvColor.xyz *= instanceColor.xyz;\n#endif\n#ifdef USE_BATCHING_COLOR\n\tvec3 batchingColor = getBatchingColor( getIndirectIndex( gl_DrawID ) );\n\tvColor.xyz *= batchingColor.xyz;\n#endif",common:"#define PI 3.141592653589793\n#define PI2 6.283185307179586\n#define PI_HALF 1.5707963267948966\n#define RECIPROCAL_PI 0.3183098861837907\n#define RECIPROCAL_PI2 0.15915494309189535\n#define EPSILON 1e-6\n#ifndef saturate\n#define saturate( a ) clamp( a, 0.0, 1.0 )\n#endif\n#define whiteComplement( a ) ( 1.0 - saturate( a ) )\nfloat pow2( const in float x ) { return x*x; }\nvec3 pow2( const in vec3 x ) { return x*x; }\nfloat pow3( const in float x ) { return x*x*x; }\nfloat pow4( const in float x ) { float x2 = x*x; return x2*x2; }\nfloat max3( const in vec3 v ) { return max( max( v.x, v.y ), v.z ); }\nfloat average( const in vec3 v ) { return dot( v, vec3( 0.3333333 ) ); }\nhighp float rand( const in vec2 uv ) {\n\tconst highp float a = 12.9898, b = 78.233, c = 43758.5453;\n\thighp float dt = dot( uv.xy, vec2( a,b ) ), sn = mod( dt, PI );\n\treturn fract( sin( sn ) * c );\n}\n#ifdef HIGH_PRECISION\n\tfloat precisionSafeLength( vec3 v ) { return length( v ); }\n#else\n\tfloat precisionSafeLength( vec3 v ) {\n\t\tfloat maxComponent = max3( abs( v ) );\n\t\treturn length( v / maxComponent ) * maxComponent;\n\t}\n#endif\nstruct IncidentLight {\n\tvec3 color;\n\tvec3 direction;\n\tbool visible;\n};\nstruct ReflectedLight {\n\tvec3 directDiffuse;\n\tvec3 directSpecular;\n\tvec3 indirectDiffuse;\n\tvec3 indirectSpecular;\n};\n#ifdef USE_ALPHAHASH\n\tvarying vec3 vPosition;\n#endif\nvec3 transformDirection( in vec3 dir, in mat4 matrix ) {\n\treturn normalize( ( matrix * vec4( dir, 0.0 ) ).xyz );\n}\nvec3 inverseTransformDirection( in vec3 dir, in mat4 matrix ) {\n\treturn normalize( ( vec4( dir, 0.0 ) * matrix ).xyz );\n}\nmat3 transposeMat3( const in mat3 m ) {\n\tmat3 tmp;\n\ttmp[ 0 ] = vec3( m[ 0 ].x, m[ 1 ].x, m[ 2 ].x );\n\ttmp[ 1 ] = vec3( m[ 0 ].y, m[ 1 ].y, m[ 2 ].y );\n\ttmp[ 2 ] = vec3( m[ 0 ].z, m[ 1 ].z, m[ 2 ].z );\n\treturn tmp;\n}\nbool isPerspectiveMatrix( mat4 m ) {\n\treturn m[ 2 ][ 3 ] == - 1.0;\n}\nvec2 equirectUv( in vec3 dir ) {\n\tfloat u = atan( dir.z, dir.x ) * RECIPROCAL_PI2 + 0.5;\n\tfloat v = asin( clamp( dir.y, - 1.0, 1.0 ) ) * RECIPROCAL_PI + 0.5;\n\treturn vec2( u, v );\n}\nvec3 BRDF_Lambert( const in vec3 diffuseColor ) {\n\treturn RECIPROCAL_PI * diffuseColor;\n}\nvec3 F_Schlick( const in vec3 f0, const in float f90, const in float dotVH ) {\n\tfloat fresnel = exp2( ( - 5.55473 * dotVH - 6.98316 ) * dotVH );\n\treturn f0 * ( 1.0 - fresnel ) + ( f90 * fresnel );\n}\nfloat F_Schlick( const in float f0, const in float f90, const in float dotVH ) {\n\tfloat fresnel = exp2( ( - 5.55473 * dotVH - 6.98316 ) * dotVH );\n\treturn f0 * ( 1.0 - fresnel ) + ( f90 * fresnel );\n} // validated",cube_uv_reflection_fragment:"#ifdef ENVMAP_TYPE_CUBE_UV\n\t#define cubeUV_minMipLevel 4.0\n\t#define cubeUV_minTileSize 16.0\n\tfloat getFace( vec3 direction ) {\n\t\tvec3 absDirection = abs( direction );\n\t\tfloat face = - 1.0;\n\t\tif ( absDirection.x > absDirection.z ) {\n\t\t\tif ( absDirection.x > absDirection.y )\n\t\t\t\tface = direction.x > 0.0 ? 0.0 : 3.0;\n\t\t\telse\n\t\t\t\tface = direction.y > 0.0 ? 1.0 : 4.0;\n\t\t} else {\n\t\t\tif ( absDirection.z > absDirection.y )\n\t\t\t\tface = direction.z > 0.0 ? 2.0 : 5.0;\n\t\t\telse\n\t\t\t\tface = direction.y > 0.0 ? 1.0 : 4.0;\n\t\t}\n\t\treturn face;\n\t}\n\tvec2 getUV( vec3 direction, float face ) {\n\t\tvec2 uv;\n\t\tif ( face == 0.0 ) {\n\t\t\tuv = vec2( direction.z, direction.y ) / abs( direction.x );\n\t\t} else if ( face == 1.0 ) {\n\t\t\tuv = vec2( - direction.x, - direction.z ) / abs( direction.y );\n\t\t} else if ( face == 2.0 ) {\n\t\t\tuv = vec2( - direction.x, direction.y ) / abs( direction.z );\n\t\t} else if ( face == 3.0 ) {\n\t\t\tuv = vec2( - direction.z, direction.y ) / abs( direction.x );\n\t\t} else if ( face == 4.0 ) {\n\t\t\tuv = vec2( - direction.x, direction.z ) / abs( direction.y );\n\t\t} else {\n\t\t\tuv = vec2( direction.x, direction.y ) / abs( direction.z );\n\t\t}\n\t\treturn 0.5 * ( uv + 1.0 );\n\t}\n\tvec3 bilinearCubeUV( sampler2D envMap, vec3 direction, float mipInt ) {\n\t\tfloat face = getFace( direction );\n\t\tfloat filterInt = max( cubeUV_minMipLevel - mipInt, 0.0 );\n\t\tmipInt = max( mipInt, cubeUV_minMipLevel );\n\t\tfloat faceSize = exp2( mipInt );\n\t\thighp vec2 uv = getUV( direction, face ) * ( faceSize - 2.0 ) + 1.0;\n\t\tif ( face > 2.0 ) {\n\t\t\tuv.y += faceSize;\n\t\t\tface -= 3.0;\n\t\t}\n\t\tuv.x += face * faceSize;\n\t\tuv.x += filterInt * 3.0 * cubeUV_minTileSize;\n\t\tuv.y += 4.0 * ( exp2( CUBEUV_MAX_MIP ) - faceSize );\n\t\tuv.x *= CUBEUV_TEXEL_WIDTH;\n\t\tuv.y *= CUBEUV_TEXEL_HEIGHT;\n\t\t#ifdef texture2DGradEXT\n\t\t\treturn texture2DGradEXT( envMap, uv, vec2( 0.0 ), vec2( 0.0 ) ).rgb;\n\t\t#else\n\t\t\treturn texture2D( envMap, uv ).rgb;\n\t\t#endif\n\t}\n\t#define cubeUV_r0 1.0\n\t#define cubeUV_m0 - 2.0\n\t#define cubeUV_r1 0.8\n\t#define cubeUV_m1 - 1.0\n\t#define cubeUV_r4 0.4\n\t#define cubeUV_m4 2.0\n\t#define cubeUV_r5 0.305\n\t#define cubeUV_m5 3.0\n\t#define cubeUV_r6 0.21\n\t#define cubeUV_m6 4.0\n\tfloat roughnessToMip( float roughness ) {\n\t\tfloat mip = 0.0;\n\t\tif ( roughness >= cubeUV_r1 ) {\n\t\t\tmip = ( cubeUV_r0 - roughness ) * ( cubeUV_m1 - cubeUV_m0 ) / ( cubeUV_r0 - cubeUV_r1 ) + cubeUV_m0;\n\t\t} else if ( roughness >= cubeUV_r4 ) {\n\t\t\tmip = ( cubeUV_r1 - roughness ) * ( cubeUV_m4 - cubeUV_m1 ) / ( cubeUV_r1 - cubeUV_r4 ) + cubeUV_m1;\n\t\t} else if ( roughness >= cubeUV_r5 ) {\n\t\t\tmip = ( cubeUV_r4 - roughness ) * ( cubeUV_m5 - cubeUV_m4 ) / ( cubeUV_r4 - cubeUV_r5 ) + cubeUV_m4;\n\t\t} else if ( roughness >= cubeUV_r6 ) {\n\t\t\tmip = ( cubeUV_r5 - roughness ) * ( cubeUV_m6 - cubeUV_m5 ) / ( cubeUV_r5 - cubeUV_r6 ) + cubeUV_m5;\n\t\t} else {\n\t\t\tmip = - 2.0 * log2( 1.16 * roughness );\t\t}\n\t\treturn mip;\n\t}\n\tvec4 textureCubeUV( sampler2D envMap, vec3 sampleDir, float roughness ) {\n\t\tfloat mip = clamp( roughnessToMip( roughness ), cubeUV_m0, CUBEUV_MAX_MIP );\n\t\tfloat mipF = fract( mip );\n\t\tfloat mipInt = floor( mip );\n\t\tvec3 color0 = bilinearCubeUV( envMap, sampleDir, mipInt );\n\t\tif ( mipF == 0.0 ) {\n\t\t\treturn vec4( color0, 1.0 );\n\t\t} else {\n\t\t\tvec3 color1 = bilinearCubeUV( envMap, sampleDir, mipInt + 1.0 );\n\t\t\treturn vec4( mix( color0, color1, mipF ), 1.0 );\n\t\t}\n\t}\n#endif",defaultnormal_vertex:"vec3 transformedNormal = objectNormal;\n#ifdef USE_TANGENT\n\tvec3 transformedTangent = objectTangent;\n#endif\n#ifdef USE_BATCHING\n\tmat3 bm = mat3( batchingMatrix );\n\ttransformedNormal /= vec3( dot( bm[ 0 ], bm[ 0 ] ), dot( bm[ 1 ], bm[ 1 ] ), dot( bm[ 2 ], bm[ 2 ] ) );\n\ttransformedNormal = bm * transformedNormal;\n\t#ifdef USE_TANGENT\n\t\ttransformedTangent = bm * transformedTangent;\n\t#endif\n#endif\n#ifdef USE_INSTANCING\n\tmat3 im = mat3( instanceMatrix );\n\ttransformedNormal /= vec3( dot( im[ 0 ], im[ 0 ] ), dot( im[ 1 ], im[ 1 ] ), dot( im[ 2 ], im[ 2 ] ) );\n\ttransformedNormal = im * transformedNormal;\n\t#ifdef USE_TANGENT\n\t\ttransformedTangent = im * transformedTangent;\n\t#endif\n#endif\ntransformedNormal = normalMatrix * transformedNormal;\n#ifdef FLIP_SIDED\n\ttransformedNormal = - transformedNormal;\n#endif\n#ifdef USE_TANGENT\n\ttransformedTangent = ( modelViewMatrix * vec4( transformedTangent, 0.0 ) ).xyz;\n\t#ifdef FLIP_SIDED\n\t\ttransformedTangent = - transformedTangent;\n\t#endif\n#endif",displacementmap_pars_vertex:"#ifdef USE_DISPLACEMENTMAP\n\tuniform sampler2D displacementMap;\n\tuniform float displacementScale;\n\tuniform float displacementBias;\n#endif",displacementmap_vertex:"#ifdef USE_DISPLACEMENTMAP\n\ttransformed += normalize( objectNormal ) * ( texture2D( displacementMap, vDisplacementMapUv ).x * displacementScale + displacementBias );\n#endif",emissivemap_fragment:"#ifdef USE_EMISSIVEMAP\n\tvec4 emissiveColor = texture2D( emissiveMap, vEmissiveMapUv );\n\t#ifdef DECODE_VIDEO_TEXTURE_EMISSIVE\n\t\temissiveColor = sRGBTransferEOTF( emissiveColor );\n\t#endif\n\ttotalEmissiveRadiance *= emissiveColor.rgb;\n#endif",emissivemap_pars_fragment:"#ifdef USE_EMISSIVEMAP\n\tuniform sampler2D emissiveMap;\n#endif",colorspace_fragment:"gl_FragColor = linearToOutputTexel( gl_FragColor );",colorspace_pars_fragment:"vec4 LinearTransferOETF( in vec4 value ) {\n\treturn value;\n}\nvec4 sRGBTransferEOTF( in vec4 value ) {\n\treturn vec4( mix( pow( value.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), value.rgb * 0.0773993808, vec3( lessThanEqual( value.rgb, vec3( 0.04045 ) ) ) ), value.a );\n}\nvec4 sRGBTransferOETF( in vec4 value ) {\n\treturn vec4( mix( pow( value.rgb, vec3( 0.41666 ) ) * 1.055 - vec3( 0.055 ), value.rgb * 12.92, vec3( lessThanEqual( value.rgb, vec3( 0.0031308 ) ) ) ), value.a );\n}",envmap_fragment:"#ifdef USE_ENVMAP\n\t#ifdef ENV_WORLDPOS\n\t\tvec3 cameraToFrag;\n\t\tif ( isOrthographic ) {\n\t\t\tcameraToFrag = normalize( vec3( - viewMatrix[ 0 ][ 2 ], - viewMatrix[ 1 ][ 2 ], - viewMatrix[ 2 ][ 2 ] ) );\n\t\t} else {\n\t\t\tcameraToFrag = normalize( vWorldPosition - cameraPosition );\n\t\t}\n\t\tvec3 worldNormal = inverseTransformDirection( normal, viewMatrix );\n\t\t#ifdef ENVMAP_MODE_REFLECTION\n\t\t\tvec3 reflectVec = reflect( cameraToFrag, worldNormal );\n\t\t#else\n\t\t\tvec3 reflectVec = refract( cameraToFrag, worldNormal, refractionRatio );\n\t\t#endif\n\t#else\n\t\tvec3 reflectVec = vReflect;\n\t#endif\n\t#ifdef ENVMAP_TYPE_CUBE\n\t\tvec4 envColor = textureCube( envMap, envMapRotation * vec3( flipEnvMap * reflectVec.x, reflectVec.yz ) );\n\t#else\n\t\tvec4 envColor = vec4( 0.0 );\n\t#endif\n\t#ifdef ENVMAP_BLENDING_MULTIPLY\n\t\toutgoingLight = mix( outgoingLight, outgoingLight * envColor.xyz, specularStrength * reflectivity );\n\t#elif defined( ENVMAP_BLENDING_MIX )\n\t\toutgoingLight = mix( outgoingLight, envColor.xyz, specularStrength * reflectivity );\n\t#elif defined( ENVMAP_BLENDING_ADD )\n\t\toutgoingLight += envColor.xyz * specularStrength * reflectivity;\n\t#endif\n#endif",envmap_common_pars_fragment:"#ifdef USE_ENVMAP\n\tuniform float envMapIntensity;\n\tuniform float flipEnvMap;\n\tuniform mat3 envMapRotation;\n\t#ifdef ENVMAP_TYPE_CUBE\n\t\tuniform samplerCube envMap;\n\t#else\n\t\tuniform sampler2D envMap;\n\t#endif\n\t\n#endif",envmap_pars_fragment:"#ifdef USE_ENVMAP\n\tuniform float reflectivity;\n\t#if defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( PHONG ) || defined( LAMBERT )\n\t\t#define ENV_WORLDPOS\n\t#endif\n\t#ifdef ENV_WORLDPOS\n\t\tvarying vec3 vWorldPosition;\n\t\tuniform float refractionRatio;\n\t#else\n\t\tvarying vec3 vReflect;\n\t#endif\n#endif",envmap_pars_vertex:"#ifdef USE_ENVMAP\n\t#if defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( PHONG ) || defined( LAMBERT )\n\t\t#define ENV_WORLDPOS\n\t#endif\n\t#ifdef ENV_WORLDPOS\n\t\t\n\t\tvarying vec3 vWorldPosition;\n\t#else\n\t\tvarying vec3 vReflect;\n\t\tuniform float refractionRatio;\n\t#endif\n#endif",envmap_physical_pars_fragment:"#ifdef USE_ENVMAP\n\tvec3 getIBLIrradiance( const in vec3 normal ) {\n\t\t#ifdef ENVMAP_TYPE_CUBE_UV\n\t\t\tvec3 worldNormal = inverseTransformDirection( normal, viewMatrix );\n\t\t\tvec4 envMapColor = textureCubeUV( envMap, envMapRotation * worldNormal, 1.0 );\n\t\t\treturn PI * envMapColor.rgb * envMapIntensity;\n\t\t#else\n\t\t\treturn vec3( 0.0 );\n\t\t#endif\n\t}\n\tvec3 getIBLRadiance( const in vec3 viewDir, const in vec3 normal, const in float roughness ) {\n\t\t#ifdef ENVMAP_TYPE_CUBE_UV\n\t\t\tvec3 reflectVec = reflect( - viewDir, normal );\n\t\t\treflectVec = normalize( mix( reflectVec, normal, roughness * roughness) );\n\t\t\treflectVec = inverseTransformDirection( reflectVec, viewMatrix );\n\t\t\tvec4 envMapColor = textureCubeUV( envMap, envMapRotation * reflectVec, roughness );\n\t\t\treturn envMapColor.rgb * envMapIntensity;\n\t\t#else\n\t\t\treturn vec3( 0.0 );\n\t\t#endif\n\t}\n\t#ifdef USE_ANISOTROPY\n\t\tvec3 getIBLAnisotropyRadiance( const in vec3 viewDir, const in vec3 normal, const in float roughness, const in vec3 bitangent, const in float anisotropy ) {\n\t\t\t#ifdef ENVMAP_TYPE_CUBE_UV\n\t\t\t\tvec3 bentNormal = cross( bitangent, viewDir );\n\t\t\t\tbentNormal = normalize( cross( bentNormal, bitangent ) );\n\t\t\t\tbentNormal = normalize( mix( bentNormal, normal, pow2( pow2( 1.0 - anisotropy * ( 1.0 - roughness ) ) ) ) );\n\t\t\t\treturn getIBLRadiance( viewDir, bentNormal, roughness );\n\t\t\t#else\n\t\t\t\treturn vec3( 0.0 );\n\t\t\t#endif\n\t\t}\n\t#endif\n#endif",envmap_vertex:"#ifdef USE_ENVMAP\n\t#ifdef ENV_WORLDPOS\n\t\tvWorldPosition = worldPosition.xyz;\n\t#else\n\t\tvec3 cameraToVertex;\n\t\tif ( isOrthographic ) {\n\t\t\tcameraToVertex = normalize( vec3( - viewMatrix[ 0 ][ 2 ], - viewMatrix[ 1 ][ 2 ], - viewMatrix[ 2 ][ 2 ] ) );\n\t\t} else {\n\t\t\tcameraToVertex = normalize( worldPosition.xyz - cameraPosition );\n\t\t}\n\t\tvec3 worldNormal = inverseTransformDirection( transformedNormal, viewMatrix );\n\t\t#ifdef ENVMAP_MODE_REFLECTION\n\t\t\tvReflect = reflect( cameraToVertex, worldNormal );\n\t\t#else\n\t\t\tvReflect = refract( cameraToVertex, worldNormal, refractionRatio );\n\t\t#endif\n\t#endif\n#endif",fog_vertex:"#ifdef USE_FOG\n\tvFogDepth = - mvPosition.z;\n#endif",fog_pars_vertex:"#ifdef USE_FOG\n\tvarying float vFogDepth;\n#endif",fog_fragment:"#ifdef USE_FOG\n\t#ifdef FOG_EXP2\n\t\tfloat fogFactor = 1.0 - exp( - fogDensity * fogDensity * vFogDepth * vFogDepth );\n\t#else\n\t\tfloat fogFactor = smoothstep( fogNear, fogFar, vFogDepth );\n\t#endif\n\tgl_FragColor.rgb = mix( gl_FragColor.rgb, fogColor, fogFactor );\n#endif",fog_pars_fragment:"#ifdef USE_FOG\n\tuniform vec3 fogColor;\n\tvarying float vFogDepth;\n\t#ifdef FOG_EXP2\n\t\tuniform float fogDensity;\n\t#else\n\t\tuniform float fogNear;\n\t\tuniform float fogFar;\n\t#endif\n#endif",gradientmap_pars_fragment:"#ifdef USE_GRADIENTMAP\n\tuniform sampler2D gradientMap;\n#endif\nvec3 getGradientIrradiance( vec3 normal, vec3 lightDirection ) {\n\tfloat dotNL = dot( normal, lightDirection );\n\tvec2 coord = vec2( dotNL * 0.5 + 0.5, 0.0 );\n\t#ifdef USE_GRADIENTMAP\n\t\treturn vec3( texture2D( gradientMap, coord ).r );\n\t#else\n\t\tvec2 fw = fwidth( coord ) * 0.5;\n\t\treturn mix( vec3( 0.7 ), vec3( 1.0 ), smoothstep( 0.7 - fw.x, 0.7 + fw.x, coord.x ) );\n\t#endif\n}",lightmap_pars_fragment:"#ifdef USE_LIGHTMAP\n\tuniform sampler2D lightMap;\n\tuniform float lightMapIntensity;\n#endif",lights_lambert_fragment:"LambertMaterial material;\nmaterial.diffuseColor = diffuseColor.rgb;\nmaterial.specularStrength = specularStrength;",lights_lambert_pars_fragment:"varying vec3 vViewPosition;\nstruct LambertMaterial {\n\tvec3 diffuseColor;\n\tfloat specularStrength;\n};\nvoid RE_Direct_Lambert( const in IncidentLight directLight, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in LambertMaterial material, inout ReflectedLight reflectedLight ) {\n\tfloat dotNL = saturate( dot( geometryNormal, directLight.direction ) );\n\tvec3 irradiance = dotNL * directLight.color;\n\treflectedLight.directDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );\n}\nvoid RE_IndirectDiffuse_Lambert( const in vec3 irradiance, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in LambertMaterial material, inout ReflectedLight reflectedLight ) {\n\treflectedLight.indirectDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );\n}\n#define RE_Direct\t\t\t\tRE_Direct_Lambert\n#define RE_IndirectDiffuse\t\tRE_IndirectDiffuse_Lambert",lights_pars_begin:"uniform bool receiveShadow;\nuniform vec3 ambientLightColor;\n#if defined( USE_LIGHT_PROBES )\n\tuniform vec3 lightProbe[ 9 ];\n#endif\nvec3 shGetIrradianceAt( in vec3 normal, in vec3 shCoefficients[ 9 ] ) {\n\tfloat x = normal.x, y = normal.y, z = normal.z;\n\tvec3 result = shCoefficients[ 0 ] * 0.886227;\n\tresult += shCoefficients[ 1 ] * 2.0 * 0.511664 * y;\n\tresult += shCoefficients[ 2 ] * 2.0 * 0.511664 * z;\n\tresult += shCoefficients[ 3 ] * 2.0 * 0.511664 * x;\n\tresult += shCoefficients[ 4 ] * 2.0 * 0.429043 * x * y;\n\tresult += shCoefficients[ 5 ] * 2.0 * 0.429043 * y * z;\n\tresult += shCoefficients[ 6 ] * ( 0.743125 * z * z - 0.247708 );\n\tresult += shCoefficients[ 7 ] * 2.0 * 0.429043 * x * z;\n\tresult += shCoefficients[ 8 ] * 0.429043 * ( x * x - y * y );\n\treturn result;\n}\nvec3 getLightProbeIrradiance( const in vec3 lightProbe[ 9 ], const in vec3 normal ) {\n\tvec3 worldNormal = inverseTransformDirection( normal, viewMatrix );\n\tvec3 irradiance = shGetIrradianceAt( worldNormal, lightProbe );\n\treturn irradiance;\n}\nvec3 getAmbientLightIrradiance( const in vec3 ambientLightColor ) {\n\tvec3 irradiance = ambientLightColor;\n\treturn irradiance;\n}\nfloat getDistanceAttenuation( const in float lightDistance, const in float cutoffDistance, const in float decayExponent ) {\n\tfloat distanceFalloff = 1.0 / max( pow( lightDistance, decayExponent ), 0.01 );\n\tif ( cutoffDistance > 0.0 ) {\n\t\tdistanceFalloff *= pow2( saturate( 1.0 - pow4( lightDistance / cutoffDistance ) ) );\n\t}\n\treturn distanceFalloff;\n}\nfloat getSpotAttenuation( const in float coneCosine, const in float penumbraCosine, const in float angleCosine ) {\n\treturn smoothstep( coneCosine, penumbraCosine, angleCosine );\n}\n#if NUM_DIR_LIGHTS > 0\n\tstruct DirectionalLight {\n\t\tvec3 direction;\n\t\tvec3 color;\n\t};\n\tuniform DirectionalLight directionalLights[ NUM_DIR_LIGHTS ];\n\tvoid getDirectionalLightInfo( const in DirectionalLight directionalLight, out IncidentLight light ) {\n\t\tlight.color = directionalLight.color;\n\t\tlight.direction = directionalLight.direction;\n\t\tlight.visible = true;\n\t}\n#endif\n#if NUM_POINT_LIGHTS > 0\n\tstruct PointLight {\n\t\tvec3 position;\n\t\tvec3 color;\n\t\tfloat distance;\n\t\tfloat decay;\n\t};\n\tuniform PointLight pointLights[ NUM_POINT_LIGHTS ];\n\tvoid getPointLightInfo( const in PointLight pointLight, const in vec3 geometryPosition, out IncidentLight light ) {\n\t\tvec3 lVector = pointLight.position - geometryPosition;\n\t\tlight.direction = normalize( lVector );\n\t\tfloat lightDistance = length( lVector );\n\t\tlight.color = pointLight.color;\n\t\tlight.color *= getDistanceAttenuation( lightDistance, pointLight.distance, pointLight.decay );\n\t\tlight.visible = ( light.color != vec3( 0.0 ) );\n\t}\n#endif\n#if NUM_SPOT_LIGHTS > 0\n\tstruct SpotLight {\n\t\tvec3 position;\n\t\tvec3 direction;\n\t\tvec3 color;\n\t\tfloat distance;\n\t\tfloat decay;\n\t\tfloat coneCos;\n\t\tfloat penumbraCos;\n\t};\n\tuniform SpotLight spotLights[ NUM_SPOT_LIGHTS ];\n\tvoid getSpotLightInfo( const in SpotLight spotLight, const in vec3 geometryPosition, out IncidentLight light ) {\n\t\tvec3 lVector = spotLight.position - geometryPosition;\n\t\tlight.direction = normalize( lVector );\n\t\tfloat angleCos = dot( light.direction, spotLight.direction );\n\t\tfloat spotAttenuation = getSpotAttenuation( spotLight.coneCos, spotLight.penumbraCos, angleCos );\n\t\tif ( spotAttenuation > 0.0 ) {\n\t\t\tfloat lightDistance = length( lVector );\n\t\t\tlight.color = spotLight.color * spotAttenuation;\n\t\t\tlight.color *= getDistanceAttenuation( lightDistance, spotLight.distance, spotLight.decay );\n\t\t\tlight.visible = ( light.color != vec3( 0.0 ) );\n\t\t} else {\n\t\t\tlight.color = vec3( 0.0 );\n\t\t\tlight.visible = false;\n\t\t}\n\t}\n#endif\n#if NUM_RECT_AREA_LIGHTS > 0\n\tstruct RectAreaLight {\n\t\tvec3 color;\n\t\tvec3 position;\n\t\tvec3 halfWidth;\n\t\tvec3 halfHeight;\n\t};\n\tuniform sampler2D ltc_1;\tuniform sampler2D ltc_2;\n\tuniform RectAreaLight rectAreaLights[ NUM_RECT_AREA_LIGHTS ];\n#endif\n#if NUM_HEMI_LIGHTS > 0\n\tstruct HemisphereLight {\n\t\tvec3 direction;\n\t\tvec3 skyColor;\n\t\tvec3 groundColor;\n\t};\n\tuniform HemisphereLight hemisphereLights[ NUM_HEMI_LIGHTS ];\n\tvec3 getHemisphereLightIrradiance( const in HemisphereLight hemiLight, const in vec3 normal ) {\n\t\tfloat dotNL = dot( normal, hemiLight.direction );\n\t\tfloat hemiDiffuseWeight = 0.5 * dotNL + 0.5;\n\t\tvec3 irradiance = mix( hemiLight.groundColor, hemiLight.skyColor, hemiDiffuseWeight );\n\t\treturn irradiance;\n\t}\n#endif",lights_toon_fragment:"ToonMaterial material;\nmaterial.diffuseColor = diffuseColor.rgb;",lights_toon_pars_fragment:"varying vec3 vViewPosition;\nstruct ToonMaterial {\n\tvec3 diffuseColor;\n};\nvoid RE_Direct_Toon( const in IncidentLight directLight, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in ToonMaterial material, inout ReflectedLight reflectedLight ) {\n\tvec3 irradiance = getGradientIrradiance( geometryNormal, directLight.direction ) * directLight.color;\n\treflectedLight.directDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );\n}\nvoid RE_IndirectDiffuse_Toon( const in vec3 irradiance, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in ToonMaterial material, inout ReflectedLight reflectedLight ) {\n\treflectedLight.indirectDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );\n}\n#define RE_Direct\t\t\t\tRE_Direct_Toon\n#define RE_IndirectDiffuse\t\tRE_IndirectDiffuse_Toon",lights_phong_fragment:"BlinnPhongMaterial material;\nmaterial.diffuseColor = diffuseColor.rgb;\nmaterial.specularColor = specular;\nmaterial.specularShininess = shininess;\nmaterial.specularStrength = specularStrength;",lights_phong_pars_fragment:"varying vec3 vViewPosition;\nstruct BlinnPhongMaterial {\n\tvec3 diffuseColor;\n\tvec3 specularColor;\n\tfloat specularShininess;\n\tfloat specularStrength;\n};\nvoid RE_Direct_BlinnPhong( const in IncidentLight directLight, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in BlinnPhongMaterial material, inout ReflectedLight reflectedLight ) {\n\tfloat dotNL = saturate( dot( geometryNormal, directLight.direction ) );\n\tvec3 irradiance = dotNL * directLight.color;\n\treflectedLight.directDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );\n\treflectedLight.directSpecular += irradiance * BRDF_BlinnPhong( directLight.direction, geometryViewDir, geometryNormal, material.specularColor, material.specularShininess ) * material.specularStrength;\n}\nvoid RE_IndirectDiffuse_BlinnPhong( const in vec3 irradiance, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in BlinnPhongMaterial material, inout ReflectedLight reflectedLight ) {\n\treflectedLight.indirectDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );\n}\n#define RE_Direct\t\t\t\tRE_Direct_BlinnPhong\n#define RE_IndirectDiffuse\t\tRE_IndirectDiffuse_BlinnPhong",lights_physical_fragment:"PhysicalMaterial material;\nmaterial.diffuseColor = diffuseColor.rgb * ( 1.0 - metalnessFactor );\nvec3 fdx = dFdx( vViewPosition );\nvec3 fdy = dFdy( vViewPosition );\nvec3 nonPerturbedNormal = normalize( cross( fdx, fdy ) );\nvec3 dxy = max( abs( dFdx( nonPerturbedNormal ) ), abs( dFdy( nonPerturbedNormal ) ) );\nfloat geometryRoughness = max( max( dxy.x, dxy.y ), dxy.z );\nmaterial.roughness = max( roughnessFactor, 0.0525 );material.roughness += geometryRoughness;\nmaterial.roughness = min( material.roughness, 1.0 );\n#ifdef IOR\n\tmaterial.ior = ior;\n\t#ifdef USE_SPECULAR\n\t\tfloat specularIntensityFactor = specularIntensity;\n\t\tvec3 specularColorFactor = specularColor;\n\t\t#ifdef USE_SPECULAR_COLORMAP\n\t\t\tspecularColorFactor *= texture2D( specularColorMap, vSpecularColorMapUv ).rgb;\n\t\t#endif\n\t\t#ifdef USE_SPECULAR_INTENSITYMAP\n\t\t\tspecularIntensityFactor *= texture2D( specularIntensityMap, vSpecularIntensityMapUv ).a;\n\t\t#endif\n\t\tmaterial.specularF90 = mix( specularIntensityFactor, 1.0, metalnessFactor );\n\t#else\n\t\tfloat specularIntensityFactor = 1.0;\n\t\tvec3 specularColorFactor = vec3( 1.0 );\n\t\tmaterial.specularF90 = 1.0;\n\t#endif\n\tmaterial.specularColor = mix( min( pow2( ( material.ior - 1.0 ) / ( material.ior + 1.0 ) ) * specularColorFactor, vec3( 1.0 ) ) * specularIntensityFactor, diffuseColor.rgb, metalnessFactor );\n#else\n\tmaterial.specularColor = mix( vec3( 0.04 ), diffuseColor.rgb, metalnessFactor );\n\tmaterial.specularF90 = 1.0;\n#endif\n#ifdef USE_CLEARCOAT\n\tmaterial.clearcoat = clearcoat;\n\tmaterial.clearcoatRoughness = clearcoatRoughness;\n\tmaterial.clearcoatF0 = vec3( 0.04 );\n\tmaterial.clearcoatF90 = 1.0;\n\t#ifdef USE_CLEARCOATMAP\n\t\tmaterial.clearcoat *= texture2D( clearcoatMap, vClearcoatMapUv ).x;\n\t#endif\n\t#ifdef USE_CLEARCOAT_ROUGHNESSMAP\n\t\tmaterial.clearcoatRoughness *= texture2D( clearcoatRoughnessMap, vClearcoatRoughnessMapUv ).y;\n\t#endif\n\tmaterial.clearcoat = saturate( material.clearcoat );\tmaterial.clearcoatRoughness = max( material.clearcoatRoughness, 0.0525 );\n\tmaterial.clearcoatRoughness += geometryRoughness;\n\tmaterial.clearcoatRoughness = min( material.clearcoatRoughness, 1.0 );\n#endif\n#ifdef USE_DISPERSION\n\tmaterial.dispersion = dispersion;\n#endif\n#ifdef USE_IRIDESCENCE\n\tmaterial.iridescence = iridescence;\n\tmaterial.iridescenceIOR = iridescenceIOR;\n\t#ifdef USE_IRIDESCENCEMAP\n\t\tmaterial.iridescence *= texture2D( iridescenceMap, vIridescenceMapUv ).r;\n\t#endif\n\t#ifdef USE_IRIDESCENCE_THICKNESSMAP\n\t\tmaterial.iridescenceThickness = (iridescenceThicknessMaximum - iridescenceThicknessMinimum) * texture2D( iridescenceThicknessMap, vIridescenceThicknessMapUv ).g + iridescenceThicknessMinimum;\n\t#else\n\t\tmaterial.iridescenceThickness = iridescenceThicknessMaximum;\n\t#endif\n#endif\n#ifdef USE_SHEEN\n\tmaterial.sheenColor = sheenColor;\n\t#ifdef USE_SHEEN_COLORMAP\n\t\tmaterial.sheenColor *= texture2D( sheenColorMap, vSheenColorMapUv ).rgb;\n\t#endif\n\tmaterial.sheenRoughness = clamp( sheenRoughness, 0.07, 1.0 );\n\t#ifdef USE_SHEEN_ROUGHNESSMAP\n\t\tmaterial.sheenRoughness *= texture2D( sheenRoughnessMap, vSheenRoughnessMapUv ).a;\n\t#endif\n#endif\n#ifdef USE_ANISOTROPY\n\t#ifdef USE_ANISOTROPYMAP\n\t\tmat2 anisotropyMat = mat2( anisotropyVector.x, anisotropyVector.y, - anisotropyVector.y, anisotropyVector.x );\n\t\tvec3 anisotropyPolar = texture2D( anisotropyMap, vAnisotropyMapUv ).rgb;\n\t\tvec2 anisotropyV = anisotropyMat * normalize( 2.0 * anisotropyPolar.rg - vec2( 1.0 ) ) * anisotropyPolar.b;\n\t#else\n\t\tvec2 anisotropyV = anisotropyVector;\n\t#endif\n\tmaterial.anisotropy = length( anisotropyV );\n\tif( material.anisotropy == 0.0 ) {\n\t\tanisotropyV = vec2( 1.0, 0.0 );\n\t} else {\n\t\tanisotropyV /= material.anisotropy;\n\t\tmaterial.anisotropy = saturate( material.anisotropy );\n\t}\n\tmaterial.alphaT = mix( pow2( material.roughness ), 1.0, pow2( material.anisotropy ) );\n\tmaterial.anisotropyT = tbn[ 0 ] * anisotropyV.x + tbn[ 1 ] * anisotropyV.y;\n\tmaterial.anisotropyB = tbn[ 1 ] * anisotropyV.x - tbn[ 0 ] * anisotropyV.y;\n#endif",lights_physical_pars_fragment:"struct PhysicalMaterial {\n\tvec3 diffuseColor;\n\tfloat roughness;\n\tvec3 specularColor;\n\tfloat specularF90;\n\tfloat dispersion;\n\t#ifdef USE_CLEARCOAT\n\t\tfloat clearcoat;\n\t\tfloat clearcoatRoughness;\n\t\tvec3 clearcoatF0;\n\t\tfloat clearcoatF90;\n\t#endif\n\t#ifdef USE_IRIDESCENCE\n\t\tfloat iridescence;\n\t\tfloat iridescenceIOR;\n\t\tfloat iridescenceThickness;\n\t\tvec3 iridescenceFresnel;\n\t\tvec3 iridescenceF0;\n\t#endif\n\t#ifdef USE_SHEEN\n\t\tvec3 sheenColor;\n\t\tfloat sheenRoughness;\n\t#endif\n\t#ifdef IOR\n\t\tfloat ior;\n\t#endif\n\t#ifdef USE_TRANSMISSION\n\t\tfloat transmission;\n\t\tfloat transmissionAlpha;\n\t\tfloat thickness;\n\t\tfloat attenuationDistance;\n\t\tvec3 attenuationColor;\n\t#endif\n\t#ifdef USE_ANISOTROPY\n\t\tfloat anisotropy;\n\t\tfloat alphaT;\n\t\tvec3 anisotropyT;\n\t\tvec3 anisotropyB;\n\t#endif\n};\nvec3 clearcoatSpecularDirect = vec3( 0.0 );\nvec3 clearcoatSpecularIndirect = vec3( 0.0 );\nvec3 sheenSpecularDirect = vec3( 0.0 );\nvec3 sheenSpecularIndirect = vec3(0.0 );\nvec3 Schlick_to_F0( const in vec3 f, const in float f90, const in float dotVH ) {\n    float x = clamp( 1.0 - dotVH, 0.0, 1.0 );\n    float x2 = x * x;\n    float x5 = clamp( x * x2 * x2, 0.0, 0.9999 );\n    return ( f - vec3( f90 ) * x5 ) / ( 1.0 - x5 );\n}\nfloat V_GGX_SmithCorrelated( const in float alpha, const in float dotNL, const in float dotNV ) {\n\tfloat a2 = pow2( alpha );\n\tfloat gv = dotNL * sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNV ) );\n\tfloat gl = dotNV * sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNL ) );\n\treturn 0.5 / max( gv + gl, EPSILON );\n}\nfloat D_GGX( const in float alpha, const in float dotNH ) {\n\tfloat a2 = pow2( alpha );\n\tfloat denom = pow2( dotNH ) * ( a2 - 1.0 ) + 1.0;\n\treturn RECIPROCAL_PI * a2 / pow2( denom );\n}\n#ifdef USE_ANISOTROPY\n\tfloat V_GGX_SmithCorrelated_Anisotropic( const in float alphaT, const in float alphaB, const in float dotTV, const in float dotBV, const in float dotTL, const in float dotBL, const in float dotNV, const in float dotNL ) {\n\t\tfloat gv = dotNL * length( vec3( alphaT * dotTV, alphaB * dotBV, dotNV ) );\n\t\tfloat gl = dotNV * length( vec3( alphaT * dotTL, alphaB * dotBL, dotNL ) );\n\t\tfloat v = 0.5 / ( gv + gl );\n\t\treturn saturate(v);\n\t}\n\tfloat D_GGX_Anisotropic( const in float alphaT, const in float alphaB, const in float dotNH, const in float dotTH, const in float dotBH ) {\n\t\tfloat a2 = alphaT * alphaB;\n\t\thighp vec3 v = vec3( alphaB * dotTH, alphaT * dotBH, a2 * dotNH );\n\t\thighp float v2 = dot( v, v );\n\t\tfloat w2 = a2 / v2;\n\t\treturn RECIPROCAL_PI * a2 * pow2 ( w2 );\n\t}\n#endif\n#ifdef USE_CLEARCOAT\n\tvec3 BRDF_GGX_Clearcoat( const in vec3 lightDir, const in vec3 viewDir, const in vec3 normal, const in PhysicalMaterial material) {\n\t\tvec3 f0 = material.clearcoatF0;\n\t\tfloat f90 = material.clearcoatF90;\n\t\tfloat roughness = material.clearcoatRoughness;\n\t\tfloat alpha = pow2( roughness );\n\t\tvec3 halfDir = normalize( lightDir + viewDir );\n\t\tfloat dotNL = saturate( dot( normal, lightDir ) );\n\t\tfloat dotNV = saturate( dot( normal, viewDir ) );\n\t\tfloat dotNH = saturate( dot( normal, halfDir ) );\n\t\tfloat dotVH = saturate( dot( viewDir, halfDir ) );\n\t\tvec3 F = F_Schlick( f0, f90, dotVH );\n\t\tfloat V = V_GGX_SmithCorrelated( alpha, dotNL, dotNV );\n\t\tfloat D = D_GGX( alpha, dotNH );\n\t\treturn F * ( V * D );\n\t}\n#endif\nvec3 BRDF_GGX( const in vec3 lightDir, const in vec3 viewDir, const in vec3 normal, const in PhysicalMaterial material ) {\n\tvec3 f0 = material.specularColor;\n\tfloat f90 = material.specularF90;\n\tfloat roughness = material.roughness;\n\tfloat alpha = pow2( roughness );\n\tvec3 halfDir = normalize( lightDir + viewDir );\n\tfloat dotNL = saturate( dot( normal, lightDir ) );\n\tfloat dotNV = saturate( dot( normal, viewDir ) );\n\tfloat dotNH = saturate( dot( normal, halfDir ) );\n\tfloat dotVH = saturate( dot( viewDir, halfDir ) );\n\tvec3 F = F_Schlick( f0, f90, dotVH );\n\t#ifdef USE_IRIDESCENCE\n\t\tF = mix( F, material.iridescenceFresnel, material.iridescence );\n\t#endif\n\t#ifdef USE_ANISOTROPY\n\t\tfloat dotTL = dot( material.anisotropyT, lightDir );\n\t\tfloat dotTV = dot( material.anisotropyT, viewDir );\n\t\tfloat dotTH = dot( material.anisotropyT, halfDir );\n\t\tfloat dotBL = dot( material.anisotropyB, lightDir );\n\t\tfloat dotBV = dot( material.anisotropyB, viewDir );\n\t\tfloat dotBH = dot( material.anisotropyB, halfDir );\n\t\tfloat V = V_GGX_SmithCorrelated_Anisotropic( material.alphaT, alpha, dotTV, dotBV, dotTL, dotBL, dotNV, dotNL );\n\t\tfloat D = D_GGX_Anisotropic( material.alphaT, alpha, dotNH, dotTH, dotBH );\n\t#else\n\t\tfloat V = V_GGX_SmithCorrelated( alpha, dotNL, dotNV );\n\t\tfloat D = D_GGX( alpha, dotNH );\n\t#endif\n\treturn F * ( V * D );\n}\nvec2 LTC_Uv( const in vec3 N, const in vec3 V, const in float roughness ) {\n\tconst float LUT_SIZE = 64.0;\n\tconst float LUT_SCALE = ( LUT_SIZE - 1.0 ) / LUT_SIZE;\n\tconst float LUT_BIAS = 0.5 / LUT_SIZE;\n\tfloat dotNV = saturate( dot( N, V ) );\n\tvec2 uv = vec2( roughness, sqrt( 1.0 - dotNV ) );\n\tuv = uv * LUT_SCALE + LUT_BIAS;\n\treturn uv;\n}\nfloat LTC_ClippedSphereFormFactor( const in vec3 f ) {\n\tfloat l = length( f );\n\treturn max( ( l * l + f.z ) / ( l + 1.0 ), 0.0 );\n}\nvec3 LTC_EdgeVectorFormFactor( const in vec3 v1, const in vec3 v2 ) {\n\tfloat x = dot( v1, v2 );\n\tfloat y = abs( x );\n\tfloat a = 0.8543985 + ( 0.4965155 + 0.0145206 * y ) * y;\n\tfloat b = 3.4175940 + ( 4.1616724 + y ) * y;\n\tfloat v = a / b;\n\tfloat theta_sintheta = ( x > 0.0 ) ? v : 0.5 * inversesqrt( max( 1.0 - x * x, 1e-7 ) ) - v;\n\treturn cross( v1, v2 ) * theta_sintheta;\n}\nvec3 LTC_Evaluate( const in vec3 N, const in vec3 V, const in vec3 P, const in mat3 mInv, const in vec3 rectCoords[ 4 ] ) {\n\tvec3 v1 = rectCoords[ 1 ] - rectCoords[ 0 ];\n\tvec3 v2 = rectCoords[ 3 ] - rectCoords[ 0 ];\n\tvec3 lightNormal = cross( v1, v2 );\n\tif( dot( lightNormal, P - rectCoords[ 0 ] ) < 0.0 ) return vec3( 0.0 );\n\tvec3 T1, T2;\n\tT1 = normalize( V - N * dot( V, N ) );\n\tT2 = - cross( N, T1 );\n\tmat3 mat = mInv * transposeMat3( mat3( T1, T2, N ) );\n\tvec3 coords[ 4 ];\n\tcoords[ 0 ] = mat * ( rectCoords[ 0 ] - P );\n\tcoords[ 1 ] = mat * ( rectCoords[ 1 ] - P );\n\tcoords[ 2 ] = mat * ( rectCoords[ 2 ] - P );\n\tcoords[ 3 ] = mat * ( rectCoords[ 3 ] - P );\n\tcoords[ 0 ] = normalize( coords[ 0 ] );\n\tcoords[ 1 ] = normalize( coords[ 1 ] );\n\tcoords[ 2 ] = normalize( coords[ 2 ] );\n\tcoords[ 3 ] = normalize( coords[ 3 ] );\n\tvec3 vectorFormFactor = vec3( 0.0 );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 0 ], coords[ 1 ] );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 1 ], coords[ 2 ] );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 2 ], coords[ 3 ] );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 3 ], coords[ 0 ] );\n\tfloat result = LTC_ClippedSphereFormFactor( vectorFormFactor );\n\treturn vec3( result );\n}\n#if defined( USE_SHEEN )\nfloat D_Charlie( float roughness, float dotNH ) {\n\tfloat alpha = pow2( roughness );\n\tfloat invAlpha = 1.0 / alpha;\n\tfloat cos2h = dotNH * dotNH;\n\tfloat sin2h = max( 1.0 - cos2h, 0.0078125 );\n\treturn ( 2.0 + invAlpha ) * pow( sin2h, invAlpha * 0.5 ) / ( 2.0 * PI );\n}\nfloat V_Neubelt( float dotNV, float dotNL ) {\n\treturn saturate( 1.0 / ( 4.0 * ( dotNL + dotNV - dotNL * dotNV ) ) );\n}\nvec3 BRDF_Sheen( const in vec3 lightDir, const in vec3 viewDir, const in vec3 normal, vec3 sheenColor, const in float sheenRoughness ) {\n\tvec3 halfDir = normalize( lightDir + viewDir );\n\tfloat dotNL = saturate( dot( normal, lightDir ) );\n\tfloat dotNV = saturate( dot( normal, viewDir ) );\n\tfloat dotNH = saturate( dot( normal, halfDir ) );\n\tfloat D = D_Charlie( sheenRoughness, dotNH );\n\tfloat V = V_Neubelt( dotNV, dotNL );\n\treturn sheenColor * ( D * V );\n}\n#endif\nfloat IBLSheenBRDF( const in vec3 normal, const in vec3 viewDir, const in float roughness ) {\n\tfloat dotNV = saturate( dot( normal, viewDir ) );\n\tfloat r2 = roughness * roughness;\n\tfloat a = roughness < 0.25 ? -339.2 * r2 + 161.4 * roughness - 25.9 : -8.48 * r2 + 14.3 * roughness - 9.95;\n\tfloat b = roughness < 0.25 ? 44.0 * r2 - 23.7 * roughness + 3.26 : 1.97 * r2 - 3.27 * roughness + 0.72;\n\tfloat DG = exp( a * dotNV + b ) + ( roughness < 0.25 ? 0.0 : 0.1 * ( roughness - 0.25 ) );\n\treturn saturate( DG * RECIPROCAL_PI );\n}\nvec2 DFGApprox( const in vec3 normal, const in vec3 viewDir, const in float roughness ) {\n\tfloat dotNV = saturate( dot( normal, viewDir ) );\n\tconst vec4 c0 = vec4( - 1, - 0.0275, - 0.572, 0.022 );\n\tconst vec4 c1 = vec4( 1, 0.0425, 1.04, - 0.04 );\n\tvec4 r = roughness * c0 + c1;\n\tfloat a004 = min( r.x * r.x, exp2( - 9.28 * dotNV ) ) * r.x + r.y;\n\tvec2 fab = vec2( - 1.04, 1.04 ) * a004 + r.zw;\n\treturn fab;\n}\nvec3 EnvironmentBRDF( const in vec3 normal, const in vec3 viewDir, const in vec3 specularColor, const in float specularF90, const in float roughness ) {\n\tvec2 fab = DFGApprox( normal, viewDir, roughness );\n\treturn specularColor * fab.x + specularF90 * fab.y;\n}\n#ifdef USE_IRIDESCENCE\nvoid computeMultiscatteringIridescence( const in vec3 normal, const in vec3 viewDir, const in vec3 specularColor, const in float specularF90, const in float iridescence, const in vec3 iridescenceF0, const in float roughness, inout vec3 singleScatter, inout vec3 multiScatter ) {\n#else\nvoid computeMultiscattering( const in vec3 normal, const in vec3 viewDir, const in vec3 specularColor, const in float specularF90, const in float roughness, inout vec3 singleScatter, inout vec3 multiScatter ) {\n#endif\n\tvec2 fab = DFGApprox( normal, viewDir, roughness );\n\t#ifdef USE_IRIDESCENCE\n\t\tvec3 Fr = mix( specularColor, iridescenceF0, iridescence );\n\t#else\n\t\tvec3 Fr = specularColor;\n\t#endif\n\tvec3 FssEss = Fr * fab.x + specularF90 * fab.y;\n\tfloat Ess = fab.x + fab.y;\n\tfloat Ems = 1.0 - Ess;\n\tvec3 Favg = Fr + ( 1.0 - Fr ) * 0.047619;\tvec3 Fms = FssEss * Favg / ( 1.0 - Ems * Favg );\n\tsingleScatter += FssEss;\n\tmultiScatter += Fms * Ems;\n}\n#if NUM_RECT_AREA_LIGHTS > 0\n\tvoid RE_Direct_RectArea_Physical( const in RectAreaLight rectAreaLight, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {\n\t\tvec3 normal = geometryNormal;\n\t\tvec3 viewDir = geometryViewDir;\n\t\tvec3 position = geometryPosition;\n\t\tvec3 lightPos = rectAreaLight.position;\n\t\tvec3 halfWidth = rectAreaLight.halfWidth;\n\t\tvec3 halfHeight = rectAreaLight.halfHeight;\n\t\tvec3 lightColor = rectAreaLight.color;\n\t\tfloat roughness = material.roughness;\n\t\tvec3 rectCoords[ 4 ];\n\t\trectCoords[ 0 ] = lightPos + halfWidth - halfHeight;\t\trectCoords[ 1 ] = lightPos - halfWidth - halfHeight;\n\t\trectCoords[ 2 ] = lightPos - halfWidth + halfHeight;\n\t\trectCoords[ 3 ] = lightPos + halfWidth + halfHeight;\n\t\tvec2 uv = LTC_Uv( normal, viewDir, roughness );\n\t\tvec4 t1 = texture2D( ltc_1, uv );\n\t\tvec4 t2 = texture2D( ltc_2, uv );\n\t\tmat3 mInv = mat3(\n\t\t\tvec3( t1.x, 0, t1.y ),\n\t\t\tvec3(    0, 1,    0 ),\n\t\t\tvec3( t1.z, 0, t1.w )\n\t\t);\n\t\tvec3 fresnel = ( material.specularColor * t2.x + ( vec3( 1.0 ) - material.specularColor ) * t2.y );\n\t\treflectedLight.directSpecular += lightColor * fresnel * LTC_Evaluate( normal, viewDir, position, mInv, rectCoords );\n\t\treflectedLight.directDiffuse += lightColor * material.diffuseColor * LTC_Evaluate( normal, viewDir, position, mat3( 1.0 ), rectCoords );\n\t}\n#endif\nvoid RE_Direct_Physical( const in IncidentLight directLight, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {\n\tfloat dotNL = saturate( dot( geometryNormal, directLight.direction ) );\n\tvec3 irradiance = dotNL * directLight.color;\n\t#ifdef USE_CLEARCOAT\n\t\tfloat dotNLcc = saturate( dot( geometryClearcoatNormal, directLight.direction ) );\n\t\tvec3 ccIrradiance = dotNLcc * directLight.color;\n\t\tclearcoatSpecularDirect += ccIrradiance * BRDF_GGX_Clearcoat( directLight.direction, geometryViewDir, geometryClearcoatNormal, material );\n\t#endif\n\t#ifdef USE_SHEEN\n\t\tsheenSpecularDirect += irradiance * BRDF_Sheen( directLight.direction, geometryViewDir, geometryNormal, material.sheenColor, material.sheenRoughness );\n\t#endif\n\treflectedLight.directSpecular += irradiance * BRDF_GGX( directLight.direction, geometryViewDir, geometryNormal, material );\n\treflectedLight.directDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );\n}\nvoid RE_IndirectDiffuse_Physical( const in vec3 irradiance, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {\n\treflectedLight.indirectDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );\n}\nvoid RE_IndirectSpecular_Physical( const in vec3 radiance, const in vec3 irradiance, const in vec3 clearcoatRadiance, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in PhysicalMaterial material, inout ReflectedLight reflectedLight) {\n\t#ifdef USE_CLEARCOAT\n\t\tclearcoatSpecularIndirect += clearcoatRadiance * EnvironmentBRDF( geometryClearcoatNormal, geometryViewDir, material.clearcoatF0, material.clearcoatF90, material.clearcoatRoughness );\n\t#endif\n\t#ifdef USE_SHEEN\n\t\tsheenSpecularIndirect += irradiance * material.sheenColor * IBLSheenBRDF( geometryNormal, geometryViewDir, material.sheenRoughness );\n\t#endif\n\tvec3 singleScattering = vec3( 0.0 );\n\tvec3 multiScattering = vec3( 0.0 );\n\tvec3 cosineWeightedIrradiance = irradiance * RECIPROCAL_PI;\n\t#ifdef USE_IRIDESCENCE\n\t\tcomputeMultiscatteringIridescence( geometryNormal, geometryViewDir, material.specularColor, material.specularF90, material.iridescence, material.iridescenceFresnel, material.roughness, singleScattering, multiScattering );\n\t#else\n\t\tcomputeMultiscattering( geometryNormal, geometryViewDir, material.specularColor, material.specularF90, material.roughness, singleScattering, multiScattering );\n\t#endif\n\tvec3 totalScattering = singleScattering + multiScattering;\n\tvec3 diffuse = material.diffuseColor * ( 1.0 - max( max( totalScattering.r, totalScattering.g ), totalScattering.b ) );\n\treflectedLight.indirectSpecular += radiance * singleScattering;\n\treflectedLight.indirectSpecular += multiScattering * cosineWeightedIrradiance;\n\treflectedLight.indirectDiffuse += diffuse * cosineWeightedIrradiance;\n}\n#define RE_Direct\t\t\t\tRE_Direct_Physical\n#define RE_Direct_RectArea\t\tRE_Direct_RectArea_Physical\n#define RE_IndirectDiffuse\t\tRE_IndirectDiffuse_Physical\n#define RE_IndirectSpecular\t\tRE_IndirectSpecular_Physical\nfloat computeSpecularOcclusion( const in float dotNV, const in float ambientOcclusion, const in float roughness ) {\n\treturn saturate( pow( dotNV + ambientOcclusion, exp2( - 16.0 * roughness - 1.0 ) ) - 1.0 + ambientOcclusion );\n}",lights_fragment_begin:"\nvec3 geometryPosition = - vViewPosition;\nvec3 geometryNormal = normal;\nvec3 geometryViewDir = ( isOrthographic ) ? vec3( 0, 0, 1 ) : normalize( vViewPosition );\nvec3 geometryClearcoatNormal = vec3( 0.0 );\n#ifdef USE_CLEARCOAT\n\tgeometryClearcoatNormal = clearcoatNormal;\n#endif\n#ifdef USE_IRIDESCENCE\n\tfloat dotNVi = saturate( dot( normal, geometryViewDir ) );\n\tif ( material.iridescenceThickness == 0.0 ) {\n\t\tmaterial.iridescence = 0.0;\n\t} else {\n\t\tmaterial.iridescence = saturate( material.iridescence );\n\t}\n\tif ( material.iridescence > 0.0 ) {\n\t\tmaterial.iridescenceFresnel = evalIridescence( 1.0, material.iridescenceIOR, dotNVi, material.iridescenceThickness, material.specularColor );\n\t\tmaterial.iridescenceF0 = Schlick_to_F0( material.iridescenceFresnel, 1.0, dotNVi );\n\t}\n#endif\nIncidentLight directLight;\n#if ( NUM_POINT_LIGHTS > 0 ) && defined( RE_Direct )\n\tPointLight pointLight;\n\t#if defined( USE_SHADOWMAP ) && NUM_POINT_LIGHT_SHADOWS > 0\n\tPointLightShadow pointLightShadow;\n\t#endif\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_POINT_LIGHTS; i ++ ) {\n\t\tpointLight = pointLights[ i ];\n\t\tgetPointLightInfo( pointLight, geometryPosition, directLight );\n\t\t#if defined( USE_SHADOWMAP ) && ( UNROLLED_LOOP_INDEX < NUM_POINT_LIGHT_SHADOWS )\n\t\tpointLightShadow = pointLightShadows[ i ];\n\t\tdirectLight.color *= ( directLight.visible && receiveShadow ) ? getPointShadow( pointShadowMap[ i ], pointLightShadow.shadowMapSize, pointLightShadow.shadowIntensity, pointLightShadow.shadowBias, pointLightShadow.shadowRadius, vPointShadowCoord[ i ], pointLightShadow.shadowCameraNear, pointLightShadow.shadowCameraFar ) : 1.0;\n\t\t#endif\n\t\tRE_Direct( directLight, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );\n\t}\n\t#pragma unroll_loop_end\n#endif\n#if ( NUM_SPOT_LIGHTS > 0 ) && defined( RE_Direct )\n\tSpotLight spotLight;\n\tvec4 spotColor;\n\tvec3 spotLightCoord;\n\tbool inSpotLightMap;\n\t#if defined( USE_SHADOWMAP ) && NUM_SPOT_LIGHT_SHADOWS > 0\n\tSpotLightShadow spotLightShadow;\n\t#endif\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_SPOT_LIGHTS; i ++ ) {\n\t\tspotLight = spotLights[ i ];\n\t\tgetSpotLightInfo( spotLight, geometryPosition, directLight );\n\t\t#if ( UNROLLED_LOOP_INDEX < NUM_SPOT_LIGHT_SHADOWS_WITH_MAPS )\n\t\t#define SPOT_LIGHT_MAP_INDEX UNROLLED_LOOP_INDEX\n\t\t#elif ( UNROLLED_LOOP_INDEX < NUM_SPOT_LIGHT_SHADOWS )\n\t\t#define SPOT_LIGHT_MAP_INDEX NUM_SPOT_LIGHT_MAPS\n\t\t#else\n\t\t#define SPOT_LIGHT_MAP_INDEX ( UNROLLED_LOOP_INDEX - NUM_SPOT_LIGHT_SHADOWS + NUM_SPOT_LIGHT_SHADOWS_WITH_MAPS )\n\t\t#endif\n\t\t#if ( SPOT_LIGHT_MAP_INDEX < NUM_SPOT_LIGHT_MAPS )\n\t\t\tspotLightCoord = vSpotLightCoord[ i ].xyz / vSpotLightCoord[ i ].w;\n\t\t\tinSpotLightMap = all( lessThan( abs( spotLightCoord * 2. - 1. ), vec3( 1.0 ) ) );\n\t\t\tspotColor = texture2D( spotLightMap[ SPOT_LIGHT_MAP_INDEX ], spotLightCoord.xy );\n\t\t\tdirectLight.color = inSpotLightMap ? directLight.color * spotColor.rgb : directLight.color;\n\t\t#endif\n\t\t#undef SPOT_LIGHT_MAP_INDEX\n\t\t#if defined( USE_SHADOWMAP ) && ( UNROLLED_LOOP_INDEX < NUM_SPOT_LIGHT_SHADOWS )\n\t\tspotLightShadow = spotLightShadows[ i ];\n\t\tdirectLight.color *= ( directLight.visible && receiveShadow ) ? getShadow( spotShadowMap[ i ], spotLightShadow.shadowMapSize, spotLightShadow.shadowIntensity, spotLightShadow.shadowBias, spotLightShadow.shadowRadius, vSpotLightCoord[ i ] ) : 1.0;\n\t\t#endif\n\t\tRE_Direct( directLight, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );\n\t}\n\t#pragma unroll_loop_end\n#endif\n#if ( NUM_DIR_LIGHTS > 0 ) && defined( RE_Direct )\n\tDirectionalLight directionalLight;\n\t#if defined( USE_SHADOWMAP ) && NUM_DIR_LIGHT_SHADOWS > 0\n\tDirectionalLightShadow directionalLightShadow;\n\t#endif\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {\n\t\tdirectionalLight = directionalLights[ i ];\n\t\tgetDirectionalLightInfo( directionalLight, directLight );\n\t\t#if defined( USE_SHADOWMAP ) && ( UNROLLED_LOOP_INDEX < NUM_DIR_LIGHT_SHADOWS )\n\t\tdirectionalLightShadow = directionalLightShadows[ i ];\n\t\tdirectLight.color *= ( directLight.visible && receiveShadow ) ? getShadow( directionalShadowMap[ i ], directionalLightShadow.shadowMapSize, directionalLightShadow.shadowIntensity, directionalLightShadow.shadowBias, directionalLightShadow.shadowRadius, vDirectionalShadowCoord[ i ] ) : 1.0;\n\t\t#endif\n\t\tRE_Direct( directLight, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );\n\t}\n\t#pragma unroll_loop_end\n#endif\n#if ( NUM_RECT_AREA_LIGHTS > 0 ) && defined( RE_Direct_RectArea )\n\tRectAreaLight rectAreaLight;\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_RECT_AREA_LIGHTS; i ++ ) {\n\t\trectAreaLight = rectAreaLights[ i ];\n\t\tRE_Direct_RectArea( rectAreaLight, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );\n\t}\n\t#pragma unroll_loop_end\n#endif\n#if defined( RE_IndirectDiffuse )\n\tvec3 iblIrradiance = vec3( 0.0 );\n\tvec3 irradiance = getAmbientLightIrradiance( ambientLightColor );\n\t#if defined( USE_LIGHT_PROBES )\n\t\tirradiance += getLightProbeIrradiance( lightProbe, geometryNormal );\n\t#endif\n\t#if ( NUM_HEMI_LIGHTS > 0 )\n\t\t#pragma unroll_loop_start\n\t\tfor ( int i = 0; i < NUM_HEMI_LIGHTS; i ++ ) {\n\t\t\tirradiance += getHemisphereLightIrradiance( hemisphereLights[ i ], geometryNormal );\n\t\t}\n\t\t#pragma unroll_loop_end\n\t#endif\n#endif\n#if defined( RE_IndirectSpecular )\n\tvec3 radiance = vec3( 0.0 );\n\tvec3 clearcoatRadiance = vec3( 0.0 );\n#endif",lights_fragment_maps:"#if defined( RE_IndirectDiffuse )\n\t#ifdef USE_LIGHTMAP\n\t\tvec4 lightMapTexel = texture2D( lightMap, vLightMapUv );\n\t\tvec3 lightMapIrradiance = lightMapTexel.rgb * lightMapIntensity;\n\t\tirradiance += lightMapIrradiance;\n\t#endif\n\t#if defined( USE_ENVMAP ) && defined( STANDARD ) && defined( ENVMAP_TYPE_CUBE_UV )\n\t\tiblIrradiance += getIBLIrradiance( geometryNormal );\n\t#endif\n#endif\n#if defined( USE_ENVMAP ) && defined( RE_IndirectSpecular )\n\t#ifdef USE_ANISOTROPY\n\t\tradiance += getIBLAnisotropyRadiance( geometryViewDir, geometryNormal, material.roughness, material.anisotropyB, material.anisotropy );\n\t#else\n\t\tradiance += getIBLRadiance( geometryViewDir, geometryNormal, material.roughness );\n\t#endif\n\t#ifdef USE_CLEARCOAT\n\t\tclearcoatRadiance += getIBLRadiance( geometryViewDir, geometryClearcoatNormal, material.clearcoatRoughness );\n\t#endif\n#endif",lights_fragment_end:"#if defined( RE_IndirectDiffuse )\n\tRE_IndirectDiffuse( irradiance, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );\n#endif\n#if defined( RE_IndirectSpecular )\n\tRE_IndirectSpecular( radiance, iblIrradiance, clearcoatRadiance, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );\n#endif",logdepthbuf_fragment:"#if defined( USE_LOGDEPTHBUF )\n\tgl_FragDepth = vIsPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;\n#endif",logdepthbuf_pars_fragment:"#if defined( USE_LOGDEPTHBUF )\n\tuniform float logDepthBufFC;\n\tvarying float vFragDepth;\n\tvarying float vIsPerspective;\n#endif",logdepthbuf_pars_vertex:"#ifdef USE_LOGDEPTHBUF\n\tvarying float vFragDepth;\n\tvarying float vIsPerspective;\n#endif",logdepthbuf_vertex:"#ifdef USE_LOGDEPTHBUF\n\tvFragDepth = 1.0 + gl_Position.w;\n\tvIsPerspective = float( isPerspectiveMatrix( projectionMatrix ) );\n#endif",map_fragment:"#ifdef USE_MAP\n\tvec4 sampledDiffuseColor = texture2D( map, vMapUv );\n\t#ifdef DECODE_VIDEO_TEXTURE\n\t\tsampledDiffuseColor = sRGBTransferEOTF( sampledDiffuseColor );\n\t#endif\n\tdiffuseColor *= sampledDiffuseColor;\n#endif",map_pars_fragment:"#ifdef USE_MAP\n\tuniform sampler2D map;\n#endif",map_particle_fragment:"#if defined( USE_MAP ) || defined( USE_ALPHAMAP )\n\t#if defined( USE_POINTS_UV )\n\t\tvec2 uv = vUv;\n\t#else\n\t\tvec2 uv = ( uvTransform * vec3( gl_PointCoord.x, 1.0 - gl_PointCoord.y, 1 ) ).xy;\n\t#endif\n#endif\n#ifdef USE_MAP\n\tdiffuseColor *= texture2D( map, uv );\n#endif\n#ifdef USE_ALPHAMAP\n\tdiffuseColor.a *= texture2D( alphaMap, uv ).g;\n#endif",map_particle_pars_fragment:"#if defined( USE_POINTS_UV )\n\tvarying vec2 vUv;\n#else\n\t#if defined( USE_MAP ) || defined( USE_ALPHAMAP )\n\t\tuniform mat3 uvTransform;\n\t#endif\n#endif\n#ifdef USE_MAP\n\tuniform sampler2D map;\n#endif\n#ifdef USE_ALPHAMAP\n\tuniform sampler2D alphaMap;\n#endif",metalnessmap_fragment:"float metalnessFactor = metalness;\n#ifdef USE_METALNESSMAP\n\tvec4 texelMetalness = texture2D( metalnessMap, vMetalnessMapUv );\n\tmetalnessFactor *= texelMetalness.b;\n#endif",metalnessmap_pars_fragment:"#ifdef USE_METALNESSMAP\n\tuniform sampler2D metalnessMap;\n#endif",morphinstance_vertex:"#ifdef USE_INSTANCING_MORPH\n\tfloat morphTargetInfluences[ MORPHTARGETS_COUNT ];\n\tfloat morphTargetBaseInfluence = texelFetch( morphTexture, ivec2( 0, gl_InstanceID ), 0 ).r;\n\tfor ( int i = 0; i < MORPHTARGETS_COUNT; i ++ ) {\n\t\tmorphTargetInfluences[i] =  texelFetch( morphTexture, ivec2( i + 1, gl_InstanceID ), 0 ).r;\n\t}\n#endif",morphcolor_vertex:"#if defined( USE_MORPHCOLORS )\n\tvColor *= morphTargetBaseInfluence;\n\tfor ( int i = 0; i < MORPHTARGETS_COUNT; i ++ ) {\n\t\t#if defined( USE_COLOR_ALPHA )\n\t\t\tif ( morphTargetInfluences[ i ] != 0.0 ) vColor += getMorph( gl_VertexID, i, 2 ) * morphTargetInfluences[ i ];\n\t\t#elif defined( USE_COLOR )\n\t\t\tif ( morphTargetInfluences[ i ] != 0.0 ) vColor += getMorph( gl_VertexID, i, 2 ).rgb * morphTargetInfluences[ i ];\n\t\t#endif\n\t}\n#endif",morphnormal_vertex:"#ifdef USE_MORPHNORMALS\n\tobjectNormal *= morphTargetBaseInfluence;\n\tfor ( int i = 0; i < MORPHTARGETS_COUNT; i ++ ) {\n\t\tif ( morphTargetInfluences[ i ] != 0.0 ) objectNormal += getMorph( gl_VertexID, i, 1 ).xyz * morphTargetInfluences[ i ];\n\t}\n#endif",morphtarget_pars_vertex:"#ifdef USE_MORPHTARGETS\n\t#ifndef USE_INSTANCING_MORPH\n\t\tuniform float morphTargetBaseInfluence;\n\t\tuniform float morphTargetInfluences[ MORPHTARGETS_COUNT ];\n\t#endif\n\tuniform sampler2DArray morphTargetsTexture;\n\tuniform ivec2 morphTargetsTextureSize;\n\tvec4 getMorph( const in int vertexIndex, const in int morphTargetIndex, const in int offset ) {\n\t\tint texelIndex = vertexIndex * MORPHTARGETS_TEXTURE_STRIDE + offset;\n\t\tint y = texelIndex / morphTargetsTextureSize.x;\n\t\tint x = texelIndex - y * morphTargetsTextureSize.x;\n\t\tivec3 morphUV = ivec3( x, y, morphTargetIndex );\n\t\treturn texelFetch( morphTargetsTexture, morphUV, 0 );\n\t}\n#endif",morphtarget_vertex:"#ifdef USE_MORPHTARGETS\n\ttransformed *= morphTargetBaseInfluence;\n\tfor ( int i = 0; i < MORPHTARGETS_COUNT; i ++ ) {\n\t\tif ( morphTargetInfluences[ i ] != 0.0 ) transformed += getMorph( gl_VertexID, i, 0 ).xyz * morphTargetInfluences[ i ];\n\t}\n#endif",normal_fragment_begin:"float faceDirection = gl_FrontFacing ? 1.0 : - 1.0;\n#ifdef FLAT_SHADED\n\tvec3 fdx = dFdx( vViewPosition );\n\tvec3 fdy = dFdy( vViewPosition );\n\tvec3 normal = normalize( cross( fdx, fdy ) );\n#else\n\tvec3 normal = normalize( vNormal );\n\t#ifdef DOUBLE_SIDED\n\t\tnormal *= faceDirection;\n\t#endif\n#endif\n#if defined( USE_NORMALMAP_TANGENTSPACE ) || defined( USE_CLEARCOAT_NORMALMAP ) || defined( USE_ANISOTROPY )\n\t#ifdef USE_TANGENT\n\t\tmat3 tbn = mat3( normalize( vTangent ), normalize( vBitangent ), normal );\n\t#else\n\t\tmat3 tbn = getTangentFrame( - vViewPosition, normal,\n\t\t#if defined( USE_NORMALMAP )\n\t\t\tvNormalMapUv\n\t\t#elif defined( USE_CLEARCOAT_NORMALMAP )\n\t\t\tvClearcoatNormalMapUv\n\t\t#else\n\t\t\tvUv\n\t\t#endif\n\t\t);\n\t#endif\n\t#if defined( DOUBLE_SIDED ) && ! defined( FLAT_SHADED )\n\t\ttbn[0] *= faceDirection;\n\t\ttbn[1] *= faceDirection;\n\t#endif\n#endif\n#ifdef USE_CLEARCOAT_NORMALMAP\n\t#ifdef USE_TANGENT\n\t\tmat3 tbn2 = mat3( normalize( vTangent ), normalize( vBitangent ), normal );\n\t#else\n\t\tmat3 tbn2 = getTangentFrame( - vViewPosition, normal, vClearcoatNormalMapUv );\n\t#endif\n\t#if defined( DOUBLE_SIDED ) && ! defined( FLAT_SHADED )\n\t\ttbn2[0] *= faceDirection;\n\t\ttbn2[1] *= faceDirection;\n\t#endif\n#endif\nvec3 nonPerturbedNormal = normal;",normal_fragment_maps:"#ifdef USE_NORMALMAP_OBJECTSPACE\n\tnormal = texture2D( normalMap, vNormalMapUv ).xyz * 2.0 - 1.0;\n\t#ifdef FLIP_SIDED\n\t\tnormal = - normal;\n\t#endif\n\t#ifdef DOUBLE_SIDED\n\t\tnormal = normal * faceDirection;\n\t#endif\n\tnormal = normalize( normalMatrix * normal );\n#elif defined( USE_NORMALMAP_TANGENTSPACE )\n\tvec3 mapN = texture2D( normalMap, vNormalMapUv ).xyz * 2.0 - 1.0;\n\tmapN.xy *= normalScale;\n\tnormal = normalize( tbn * mapN );\n#elif defined( USE_BUMPMAP )\n\tnormal = perturbNormalArb( - vViewPosition, normal, dHdxy_fwd(), faceDirection );\n#endif",normal_pars_fragment:"#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n\t#ifdef USE_TANGENT\n\t\tvarying vec3 vTangent;\n\t\tvarying vec3 vBitangent;\n\t#endif\n#endif",normal_pars_vertex:"#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n\t#ifdef USE_TANGENT\n\t\tvarying vec3 vTangent;\n\t\tvarying vec3 vBitangent;\n\t#endif\n#endif",normal_vertex:"#ifndef FLAT_SHADED\n\tvNormal = normalize( transformedNormal );\n\t#ifdef USE_TANGENT\n\t\tvTangent = normalize( transformedTangent );\n\t\tvBitangent = normalize( cross( vNormal, vTangent ) * tangent.w );\n\t#endif\n#endif",normalmap_pars_fragment:"#ifdef USE_NORMALMAP\n\tuniform sampler2D normalMap;\n\tuniform vec2 normalScale;\n#endif\n#ifdef USE_NORMALMAP_OBJECTSPACE\n\tuniform mat3 normalMatrix;\n#endif\n#if ! defined ( USE_TANGENT ) && ( defined ( USE_NORMALMAP_TANGENTSPACE ) || defined ( USE_CLEARCOAT_NORMALMAP ) || defined( USE_ANISOTROPY ) )\n\tmat3 getTangentFrame( vec3 eye_pos, vec3 surf_norm, vec2 uv ) {\n\t\tvec3 q0 = dFdx( eye_pos.xyz );\n\t\tvec3 q1 = dFdy( eye_pos.xyz );\n\t\tvec2 st0 = dFdx( uv.st );\n\t\tvec2 st1 = dFdy( uv.st );\n\t\tvec3 N = surf_norm;\n\t\tvec3 q1perp = cross( q1, N );\n\t\tvec3 q0perp = cross( N, q0 );\n\t\tvec3 T = q1perp * st0.x + q0perp * st1.x;\n\t\tvec3 B = q1perp * st0.y + q0perp * st1.y;\n\t\tfloat det = max( dot( T, T ), dot( B, B ) );\n\t\tfloat scale = ( det == 0.0 ) ? 0.0 : inversesqrt( det );\n\t\treturn mat3( T * scale, B * scale, N );\n\t}\n#endif",clearcoat_normal_fragment_begin:"#ifdef USE_CLEARCOAT\n\tvec3 clearcoatNormal = nonPerturbedNormal;\n#endif",clearcoat_normal_fragment_maps:"#ifdef USE_CLEARCOAT_NORMALMAP\n\tvec3 clearcoatMapN = texture2D( clearcoatNormalMap, vClearcoatNormalMapUv ).xyz * 2.0 - 1.0;\n\tclearcoatMapN.xy *= clearcoatNormalScale;\n\tclearcoatNormal = normalize( tbn2 * clearcoatMapN );\n#endif",clearcoat_pars_fragment:"#ifdef USE_CLEARCOATMAP\n\tuniform sampler2D clearcoatMap;\n#endif\n#ifdef USE_CLEARCOAT_NORMALMAP\n\tuniform sampler2D clearcoatNormalMap;\n\tuniform vec2 clearcoatNormalScale;\n#endif\n#ifdef USE_CLEARCOAT_ROUGHNESSMAP\n\tuniform sampler2D clearcoatRoughnessMap;\n#endif",iridescence_pars_fragment:"#ifdef USE_IRIDESCENCEMAP\n\tuniform sampler2D iridescenceMap;\n#endif\n#ifdef USE_IRIDESCENCE_THICKNESSMAP\n\tuniform sampler2D iridescenceThicknessMap;\n#endif",opaque_fragment:"#ifdef OPAQUE\ndiffuseColor.a = 1.0;\n#endif\n#ifdef USE_TRANSMISSION\ndiffuseColor.a *= material.transmissionAlpha;\n#endif\ngl_FragColor = vec4( outgoingLight, diffuseColor.a );",packing:"vec3 packNormalToRGB( const in vec3 normal ) {\n\treturn normalize( normal ) * 0.5 + 0.5;\n}\nvec3 unpackRGBToNormal( const in vec3 rgb ) {\n\treturn 2.0 * rgb.xyz - 1.0;\n}\nconst float PackUpscale = 256. / 255.;const float UnpackDownscale = 255. / 256.;const float ShiftRight8 = 1. / 256.;\nconst float Inv255 = 1. / 255.;\nconst vec4 PackFactors = vec4( 1.0, 256.0, 256.0 * 256.0, 256.0 * 256.0 * 256.0 );\nconst vec2 UnpackFactors2 = vec2( UnpackDownscale, 1.0 / PackFactors.g );\nconst vec3 UnpackFactors3 = vec3( UnpackDownscale / PackFactors.rg, 1.0 / PackFactors.b );\nconst vec4 UnpackFactors4 = vec4( UnpackDownscale / PackFactors.rgb, 1.0 / PackFactors.a );\nvec4 packDepthToRGBA( const in float v ) {\n\tif( v <= 0.0 )\n\t\treturn vec4( 0., 0., 0., 0. );\n\tif( v >= 1.0 )\n\t\treturn vec4( 1., 1., 1., 1. );\n\tfloat vuf;\n\tfloat af = modf( v * PackFactors.a, vuf );\n\tfloat bf = modf( vuf * ShiftRight8, vuf );\n\tfloat gf = modf( vuf * ShiftRight8, vuf );\n\treturn vec4( vuf * Inv255, gf * PackUpscale, bf * PackUpscale, af );\n}\nvec3 packDepthToRGB( const in float v ) {\n\tif( v <= 0.0 )\n\t\treturn vec3( 0., 0., 0. );\n\tif( v >= 1.0 )\n\t\treturn vec3( 1., 1., 1. );\n\tfloat vuf;\n\tfloat bf = modf( v * PackFactors.b, vuf );\n\tfloat gf = modf( vuf * ShiftRight8, vuf );\n\treturn vec3( vuf * Inv255, gf * PackUpscale, bf );\n}\nvec2 packDepthToRG( const in float v ) {\n\tif( v <= 0.0 )\n\t\treturn vec2( 0., 0. );\n\tif( v >= 1.0 )\n\t\treturn vec2( 1., 1. );\n\tfloat vuf;\n\tfloat gf = modf( v * 256., vuf );\n\treturn vec2( vuf * Inv255, gf );\n}\nfloat unpackRGBAToDepth( const in vec4 v ) {\n\treturn dot( v, UnpackFactors4 );\n}\nfloat unpackRGBToDepth( const in vec3 v ) {\n\treturn dot( v, UnpackFactors3 );\n}\nfloat unpackRGToDepth( const in vec2 v ) {\n\treturn v.r * UnpackFactors2.r + v.g * UnpackFactors2.g;\n}\nvec4 pack2HalfToRGBA( const in vec2 v ) {\n\tvec4 r = vec4( v.x, fract( v.x * 255.0 ), v.y, fract( v.y * 255.0 ) );\n\treturn vec4( r.x - r.y / 255.0, r.y, r.z - r.w / 255.0, r.w );\n}\nvec2 unpackRGBATo2Half( const in vec4 v ) {\n\treturn vec2( v.x + ( v.y / 255.0 ), v.z + ( v.w / 255.0 ) );\n}\nfloat viewZToOrthographicDepth( const in float viewZ, const in float near, const in float far ) {\n\treturn ( viewZ + near ) / ( near - far );\n}\nfloat orthographicDepthToViewZ( const in float depth, const in float near, const in float far ) {\n\treturn depth * ( near - far ) - near;\n}\nfloat viewZToPerspectiveDepth( const in float viewZ, const in float near, const in float far ) {\n\treturn ( ( near + viewZ ) * far ) / ( ( far - near ) * viewZ );\n}\nfloat perspectiveDepthToViewZ( const in float depth, const in float near, const in float far ) {\n\treturn ( near * far ) / ( ( far - near ) * depth - far );\n}",premultiplied_alpha_fragment:"#ifdef PREMULTIPLIED_ALPHA\n\tgl_FragColor.rgb *= gl_FragColor.a;\n#endif",project_vertex:"vec4 mvPosition = vec4( transformed, 1.0 );\n#ifdef USE_BATCHING\n\tmvPosition = batchingMatrix * mvPosition;\n#endif\n#ifdef USE_INSTANCING\n\tmvPosition = instanceMatrix * mvPosition;\n#endif\nmvPosition = modelViewMatrix * mvPosition;\ngl_Position = projectionMatrix * mvPosition;",dithering_fragment:"#ifdef DITHERING\n\tgl_FragColor.rgb = dithering( gl_FragColor.rgb );\n#endif",dithering_pars_fragment:"#ifdef DITHERING\n\tvec3 dithering( vec3 color ) {\n\t\tfloat grid_position = rand( gl_FragCoord.xy );\n\t\tvec3 dither_shift_RGB = vec3( 0.25 / 255.0, -0.25 / 255.0, 0.25 / 255.0 );\n\t\tdither_shift_RGB = mix( 2.0 * dither_shift_RGB, -2.0 * dither_shift_RGB, grid_position );\n\t\treturn color + dither_shift_RGB;\n\t}\n#endif",roughnessmap_fragment:"float roughnessFactor = roughness;\n#ifdef USE_ROUGHNESSMAP\n\tvec4 texelRoughness = texture2D( roughnessMap, vRoughnessMapUv );\n\troughnessFactor *= texelRoughness.g;\n#endif",roughnessmap_pars_fragment:"#ifdef USE_ROUGHNESSMAP\n\tuniform sampler2D roughnessMap;\n#endif",shadowmap_pars_fragment:"#if NUM_SPOT_LIGHT_COORDS > 0\n\tvarying vec4 vSpotLightCoord[ NUM_SPOT_LIGHT_COORDS ];\n#endif\n#if NUM_SPOT_LIGHT_MAPS > 0\n\tuniform sampler2D spotLightMap[ NUM_SPOT_LIGHT_MAPS ];\n#endif\n#ifdef USE_SHADOWMAP\n\t#if NUM_DIR_LIGHT_SHADOWS > 0\n\t\tuniform sampler2D directionalShadowMap[ NUM_DIR_LIGHT_SHADOWS ];\n\t\tvarying vec4 vDirectionalShadowCoord[ NUM_DIR_LIGHT_SHADOWS ];\n\t\tstruct DirectionalLightShadow {\n\t\t\tfloat shadowIntensity;\n\t\t\tfloat shadowBias;\n\t\t\tfloat shadowNormalBias;\n\t\t\tfloat shadowRadius;\n\t\t\tvec2 shadowMapSize;\n\t\t};\n\t\tuniform DirectionalLightShadow directionalLightShadows[ NUM_DIR_LIGHT_SHADOWS ];\n\t#endif\n\t#if NUM_SPOT_LIGHT_SHADOWS > 0\n\t\tuniform sampler2D spotShadowMap[ NUM_SPOT_LIGHT_SHADOWS ];\n\t\tstruct SpotLightShadow {\n\t\t\tfloat shadowIntensity;\n\t\t\tfloat shadowBias;\n\t\t\tfloat shadowNormalBias;\n\t\t\tfloat shadowRadius;\n\t\t\tvec2 shadowMapSize;\n\t\t};\n\t\tuniform SpotLightShadow spotLightShadows[ NUM_SPOT_LIGHT_SHADOWS ];\n\t#endif\n\t#if NUM_POINT_LIGHT_SHADOWS > 0\n\t\tuniform sampler2D pointShadowMap[ NUM_POINT_LIGHT_SHADOWS ];\n\t\tvarying vec4 vPointShadowCoord[ NUM_POINT_LIGHT_SHADOWS ];\n\t\tstruct PointLightShadow {\n\t\t\tfloat shadowIntensity;\n\t\t\tfloat shadowBias;\n\t\t\tfloat shadowNormalBias;\n\t\t\tfloat shadowRadius;\n\t\t\tvec2 shadowMapSize;\n\t\t\tfloat shadowCameraNear;\n\t\t\tfloat shadowCameraFar;\n\t\t};\n\t\tuniform PointLightShadow pointLightShadows[ NUM_POINT_LIGHT_SHADOWS ];\n\t#endif\n\tfloat texture2DCompare( sampler2D depths, vec2 uv, float compare ) {\n\t\treturn step( compare, unpackRGBAToDepth( texture2D( depths, uv ) ) );\n\t}\n\tvec2 texture2DDistribution( sampler2D shadow, vec2 uv ) {\n\t\treturn unpackRGBATo2Half( texture2D( shadow, uv ) );\n\t}\n\tfloat VSMShadow (sampler2D shadow, vec2 uv, float compare ){\n\t\tfloat occlusion = 1.0;\n\t\tvec2 distribution = texture2DDistribution( shadow, uv );\n\t\tfloat hard_shadow = step( compare , distribution.x );\n\t\tif (hard_shadow != 1.0 ) {\n\t\t\tfloat distance = compare - distribution.x ;\n\t\t\tfloat variance = max( 0.00000, distribution.y * distribution.y );\n\t\t\tfloat softness_probability = variance / (variance + distance * distance );\t\t\tsoftness_probability = clamp( ( softness_probability - 0.3 ) / ( 0.95 - 0.3 ), 0.0, 1.0 );\t\t\tocclusion = clamp( max( hard_shadow, softness_probability ), 0.0, 1.0 );\n\t\t}\n\t\treturn occlusion;\n\t}\n\tfloat getShadow( sampler2D shadowMap, vec2 shadowMapSize, float shadowIntensity, float shadowBias, float shadowRadius, vec4 shadowCoord ) {\n\t\tfloat shadow = 1.0;\n\t\tshadowCoord.xyz /= shadowCoord.w;\n\t\tshadowCoord.z += shadowBias;\n\t\tbool inFrustum = shadowCoord.x >= 0.0 && shadowCoord.x <= 1.0 && shadowCoord.y >= 0.0 && shadowCoord.y <= 1.0;\n\t\tbool frustumTest = inFrustum && shadowCoord.z <= 1.0;\n\t\tif ( frustumTest ) {\n\t\t#if defined( SHADOWMAP_TYPE_PCF )\n\t\t\tvec2 texelSize = vec2( 1.0 ) / shadowMapSize;\n\t\t\tfloat dx0 = - texelSize.x * shadowRadius;\n\t\t\tfloat dy0 = - texelSize.y * shadowRadius;\n\t\t\tfloat dx1 = + texelSize.x * shadowRadius;\n\t\t\tfloat dy1 = + texelSize.y * shadowRadius;\n\t\t\tfloat dx2 = dx0 / 2.0;\n\t\t\tfloat dy2 = dy0 / 2.0;\n\t\t\tfloat dx3 = dx1 / 2.0;\n\t\t\tfloat dy3 = dy1 / 2.0;\n\t\t\tshadow = (\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx0, dy0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx1, dy0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx2, dy2 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy2 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx3, dy2 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx0, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx2, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy, shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx3, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx1, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx2, dy3 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy3 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx3, dy3 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx0, dy1 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy1 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx1, dy1 ), shadowCoord.z )\n\t\t\t) * ( 1.0 / 17.0 );\n\t\t#elif defined( SHADOWMAP_TYPE_PCF_SOFT )\n\t\t\tvec2 texelSize = vec2( 1.0 ) / shadowMapSize;\n\t\t\tfloat dx = texelSize.x;\n\t\t\tfloat dy = texelSize.y;\n\t\t\tvec2 uv = shadowCoord.xy;\n\t\t\tvec2 f = fract( uv * shadowMapSize + 0.5 );\n\t\t\tuv -= f * texelSize;\n\t\t\tshadow = (\n\t\t\t\ttexture2DCompare( shadowMap, uv, shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, uv + vec2( dx, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, uv + vec2( 0.0, dy ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, uv + texelSize, shadowCoord.z ) +\n\t\t\t\tmix( texture2DCompare( shadowMap, uv + vec2( -dx, 0.0 ), shadowCoord.z ),\n\t\t\t\t\t texture2DCompare( shadowMap, uv + vec2( 2.0 * dx, 0.0 ), shadowCoord.z ),\n\t\t\t\t\t f.x ) +\n\t\t\t\tmix( texture2DCompare( shadowMap, uv + vec2( -dx, dy ), shadowCoord.z ),\n\t\t\t\t\t texture2DCompare( shadowMap, uv + vec2( 2.0 * dx, dy ), shadowCoord.z ),\n\t\t\t\t\t f.x ) +\n\t\t\t\tmix( texture2DCompare( shadowMap, uv + vec2( 0.0, -dy ), shadowCoord.z ),\n\t\t\t\t\t texture2DCompare( shadowMap, uv + vec2( 0.0, 2.0 * dy ), shadowCoord.z ),\n\t\t\t\t\t f.y ) +\n\t\t\t\tmix( texture2DCompare( shadowMap, uv + vec2( dx, -dy ), shadowCoord.z ),\n\t\t\t\t\t texture2DCompare( shadowMap, uv + vec2( dx, 2.0 * dy ), shadowCoord.z ),\n\t\t\t\t\t f.y ) +\n\t\t\t\tmix( mix( texture2DCompare( shadowMap, uv + vec2( -dx, -dy ), shadowCoord.z ),\n\t\t\t\t\t\t  texture2DCompare( shadowMap, uv + vec2( 2.0 * dx, -dy ), shadowCoord.z ),\n\t\t\t\t\t\t  f.x ),\n\t\t\t\t\t mix( texture2DCompare( shadowMap, uv + vec2( -dx, 2.0 * dy ), shadowCoord.z ),\n\t\t\t\t\t\t  texture2DCompare( shadowMap, uv + vec2( 2.0 * dx, 2.0 * dy ), shadowCoord.z ),\n\t\t\t\t\t\t  f.x ),\n\t\t\t\t\t f.y )\n\t\t\t) * ( 1.0 / 9.0 );\n\t\t#elif defined( SHADOWMAP_TYPE_VSM )\n\t\t\tshadow = VSMShadow( shadowMap, shadowCoord.xy, shadowCoord.z );\n\t\t#else\n\t\t\tshadow = texture2DCompare( shadowMap, shadowCoord.xy, shadowCoord.z );\n\t\t#endif\n\t\t}\n\t\treturn mix( 1.0, shadow, shadowIntensity );\n\t}\n\tvec2 cubeToUV( vec3 v, float texelSizeY ) {\n\t\tvec3 absV = abs( v );\n\t\tfloat scaleToCube = 1.0 / max( absV.x, max( absV.y, absV.z ) );\n\t\tabsV *= scaleToCube;\n\t\tv *= scaleToCube * ( 1.0 - 2.0 * texelSizeY );\n\t\tvec2 planar = v.xy;\n\t\tfloat almostATexel = 1.5 * texelSizeY;\n\t\tfloat almostOne = 1.0 - almostATexel;\n\t\tif ( absV.z >= almostOne ) {\n\t\t\tif ( v.z > 0.0 )\n\t\t\t\tplanar.x = 4.0 - v.x;\n\t\t} else if ( absV.x >= almostOne ) {\n\t\t\tfloat signX = sign( v.x );\n\t\t\tplanar.x = v.z * signX + 2.0 * signX;\n\t\t} else if ( absV.y >= almostOne ) {\n\t\t\tfloat signY = sign( v.y );\n\t\t\tplanar.x = v.x + 2.0 * signY + 2.0;\n\t\t\tplanar.y = v.z * signY - 2.0;\n\t\t}\n\t\treturn vec2( 0.125, 0.25 ) * planar + vec2( 0.375, 0.75 );\n\t}\n\tfloat getPointShadow( sampler2D shadowMap, vec2 shadowMapSize, float shadowIntensity, float shadowBias, float shadowRadius, vec4 shadowCoord, float shadowCameraNear, float shadowCameraFar ) {\n\t\tfloat shadow = 1.0;\n\t\tvec3 lightToPosition = shadowCoord.xyz;\n\t\t\n\t\tfloat lightToPositionLength = length( lightToPosition );\n\t\tif ( lightToPositionLength - shadowCameraFar <= 0.0 && lightToPositionLength - shadowCameraNear >= 0.0 ) {\n\t\t\tfloat dp = ( lightToPositionLength - shadowCameraNear ) / ( shadowCameraFar - shadowCameraNear );\t\t\tdp += shadowBias;\n\t\t\tvec3 bd3D = normalize( lightToPosition );\n\t\t\tvec2 texelSize = vec2( 1.0 ) / ( shadowMapSize * vec2( 4.0, 2.0 ) );\n\t\t\t#if defined( SHADOWMAP_TYPE_PCF ) || defined( SHADOWMAP_TYPE_PCF_SOFT ) || defined( SHADOWMAP_TYPE_VSM )\n\t\t\t\tvec2 offset = vec2( - 1, 1 ) * shadowRadius * texelSize.y;\n\t\t\t\tshadow = (\n\t\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.xyy, texelSize.y ), dp ) +\n\t\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.yyy, texelSize.y ), dp ) +\n\t\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.xyx, texelSize.y ), dp ) +\n\t\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.yyx, texelSize.y ), dp ) +\n\t\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D, texelSize.y ), dp ) +\n\t\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.xxy, texelSize.y ), dp ) +\n\t\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.yxy, texelSize.y ), dp ) +\n\t\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.xxx, texelSize.y ), dp ) +\n\t\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.yxx, texelSize.y ), dp )\n\t\t\t\t) * ( 1.0 / 9.0 );\n\t\t\t#else\n\t\t\t\tshadow = texture2DCompare( shadowMap, cubeToUV( bd3D, texelSize.y ), dp );\n\t\t\t#endif\n\t\t}\n\t\treturn mix( 1.0, shadow, shadowIntensity );\n\t}\n#endif",shadowmap_pars_vertex:"#if NUM_SPOT_LIGHT_COORDS > 0\n\tuniform mat4 spotLightMatrix[ NUM_SPOT_LIGHT_COORDS ];\n\tvarying vec4 vSpotLightCoord[ NUM_SPOT_LIGHT_COORDS ];\n#endif\n#ifdef USE_SHADOWMAP\n\t#if NUM_DIR_LIGHT_SHADOWS > 0\n\t\tuniform mat4 directionalShadowMatrix[ NUM_DIR_LIGHT_SHADOWS ];\n\t\tvarying vec4 vDirectionalShadowCoord[ NUM_DIR_LIGHT_SHADOWS ];\n\t\tstruct DirectionalLightShadow {\n\t\t\tfloat shadowIntensity;\n\t\t\tfloat shadowBias;\n\t\t\tfloat shadowNormalBias;\n\t\t\tfloat shadowRadius;\n\t\t\tvec2 shadowMapSize;\n\t\t};\n\t\tuniform DirectionalLightShadow directionalLightShadows[ NUM_DIR_LIGHT_SHADOWS ];\n\t#endif\n\t#if NUM_SPOT_LIGHT_SHADOWS > 0\n\t\tstruct SpotLightShadow {\n\t\t\tfloat shadowIntensity;\n\t\t\tfloat shadowBias;\n\t\t\tfloat shadowNormalBias;\n\t\t\tfloat shadowRadius;\n\t\t\tvec2 shadowMapSize;\n\t\t};\n\t\tuniform SpotLightShadow spotLightShadows[ NUM_SPOT_LIGHT_SHADOWS ];\n\t#endif\n\t#if NUM_POINT_LIGHT_SHADOWS > 0\n\t\tuniform mat4 pointShadowMatrix[ NUM_POINT_LIGHT_SHADOWS ];\n\t\tvarying vec4 vPointShadowCoord[ NUM_POINT_LIGHT_SHADOWS ];\n\t\tstruct PointLightShadow {\n\t\t\tfloat shadowIntensity;\n\t\t\tfloat shadowBias;\n\t\t\tfloat shadowNormalBias;\n\t\t\tfloat shadowRadius;\n\t\t\tvec2 shadowMapSize;\n\t\t\tfloat shadowCameraNear;\n\t\t\tfloat shadowCameraFar;\n\t\t};\n\t\tuniform PointLightShadow pointLightShadows[ NUM_POINT_LIGHT_SHADOWS ];\n\t#endif\n#endif",shadowmap_vertex:"#if ( defined( USE_SHADOWMAP ) && ( NUM_DIR_LIGHT_SHADOWS > 0 || NUM_POINT_LIGHT_SHADOWS > 0 ) ) || ( NUM_SPOT_LIGHT_COORDS > 0 )\n\tvec3 shadowWorldNormal = inverseTransformDirection( transformedNormal, viewMatrix );\n\tvec4 shadowWorldPosition;\n#endif\n#if defined( USE_SHADOWMAP )\n\t#if NUM_DIR_LIGHT_SHADOWS > 0\n\t\t#pragma unroll_loop_start\n\t\tfor ( int i = 0; i < NUM_DIR_LIGHT_SHADOWS; i ++ ) {\n\t\t\tshadowWorldPosition = worldPosition + vec4( shadowWorldNormal * directionalLightShadows[ i ].shadowNormalBias, 0 );\n\t\t\tvDirectionalShadowCoord[ i ] = directionalShadowMatrix[ i ] * shadowWorldPosition;\n\t\t}\n\t\t#pragma unroll_loop_end\n\t#endif\n\t#if NUM_POINT_LIGHT_SHADOWS > 0\n\t\t#pragma unroll_loop_start\n\t\tfor ( int i = 0; i < NUM_POINT_LIGHT_SHADOWS; i ++ ) {\n\t\t\tshadowWorldPosition = worldPosition + vec4( shadowWorldNormal * pointLightShadows[ i ].shadowNormalBias, 0 );\n\t\t\tvPointShadowCoord[ i ] = pointShadowMatrix[ i ] * shadowWorldPosition;\n\t\t}\n\t\t#pragma unroll_loop_end\n\t#endif\n#endif\n#if NUM_SPOT_LIGHT_COORDS > 0\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_SPOT_LIGHT_COORDS; i ++ ) {\n\t\tshadowWorldPosition = worldPosition;\n\t\t#if ( defined( USE_SHADOWMAP ) && UNROLLED_LOOP_INDEX < NUM_SPOT_LIGHT_SHADOWS )\n\t\t\tshadowWorldPosition.xyz += shadowWorldNormal * spotLightShadows[ i ].shadowNormalBias;\n\t\t#endif\n\t\tvSpotLightCoord[ i ] = spotLightMatrix[ i ] * shadowWorldPosition;\n\t}\n\t#pragma unroll_loop_end\n#endif",shadowmask_pars_fragment:"float getShadowMask() {\n\tfloat shadow = 1.0;\n\t#ifdef USE_SHADOWMAP\n\t#if NUM_DIR_LIGHT_SHADOWS > 0\n\tDirectionalLightShadow directionalLight;\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_DIR_LIGHT_SHADOWS; i ++ ) {\n\t\tdirectionalLight = directionalLightShadows[ i ];\n\t\tshadow *= receiveShadow ? getShadow( directionalShadowMap[ i ], directionalLight.shadowMapSize, directionalLight.shadowIntensity, directionalLight.shadowBias, directionalLight.shadowRadius, vDirectionalShadowCoord[ i ] ) : 1.0;\n\t}\n\t#pragma unroll_loop_end\n\t#endif\n\t#if NUM_SPOT_LIGHT_SHADOWS > 0\n\tSpotLightShadow spotLight;\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_SPOT_LIGHT_SHADOWS; i ++ ) {\n\t\tspotLight = spotLightShadows[ i ];\n\t\tshadow *= receiveShadow ? getShadow( spotShadowMap[ i ], spotLight.shadowMapSize, spotLight.shadowIntensity, spotLight.shadowBias, spotLight.shadowRadius, vSpotLightCoord[ i ] ) : 1.0;\n\t}\n\t#pragma unroll_loop_end\n\t#endif\n\t#if NUM_POINT_LIGHT_SHADOWS > 0\n\tPointLightShadow pointLight;\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_POINT_LIGHT_SHADOWS; i ++ ) {\n\t\tpointLight = pointLightShadows[ i ];\n\t\tshadow *= receiveShadow ? getPointShadow( pointShadowMap[ i ], pointLight.shadowMapSize, pointLight.shadowIntensity, pointLight.shadowBias, pointLight.shadowRadius, vPointShadowCoord[ i ], pointLight.shadowCameraNear, pointLight.shadowCameraFar ) : 1.0;\n\t}\n\t#pragma unroll_loop_end\n\t#endif\n\t#endif\n\treturn shadow;\n}",skinbase_vertex:"#ifdef USE_SKINNING\n\tmat4 boneMatX = getBoneMatrix( skinIndex.x );\n\tmat4 boneMatY = getBoneMatrix( skinIndex.y );\n\tmat4 boneMatZ = getBoneMatrix( skinIndex.z );\n\tmat4 boneMatW = getBoneMatrix( skinIndex.w );\n#endif",skinning_pars_vertex:"#ifdef USE_SKINNING\n\tuniform mat4 bindMatrix;\n\tuniform mat4 bindMatrixInverse;\n\tuniform highp sampler2D boneTexture;\n\tmat4 getBoneMatrix( const in float i ) {\n\t\tint size = textureSize( boneTexture, 0 ).x;\n\t\tint j = int( i ) * 4;\n\t\tint x = j % size;\n\t\tint y = j / size;\n\t\tvec4 v1 = texelFetch( boneTexture, ivec2( x, y ), 0 );\n\t\tvec4 v2 = texelFetch( boneTexture, ivec2( x + 1, y ), 0 );\n\t\tvec4 v3 = texelFetch( boneTexture, ivec2( x + 2, y ), 0 );\n\t\tvec4 v4 = texelFetch( boneTexture, ivec2( x + 3, y ), 0 );\n\t\treturn mat4( v1, v2, v3, v4 );\n\t}\n#endif",skinning_vertex:"#ifdef USE_SKINNING\n\tvec4 skinVertex = bindMatrix * vec4( transformed, 1.0 );\n\tvec4 skinned = vec4( 0.0 );\n\tskinned += boneMatX * skinVertex * skinWeight.x;\n\tskinned += boneMatY * skinVertex * skinWeight.y;\n\tskinned += boneMatZ * skinVertex * skinWeight.z;\n\tskinned += boneMatW * skinVertex * skinWeight.w;\n\ttransformed = ( bindMatrixInverse * skinned ).xyz;\n#endif",skinnormal_vertex:"#ifdef USE_SKINNING\n\tmat4 skinMatrix = mat4( 0.0 );\n\tskinMatrix += skinWeight.x * boneMatX;\n\tskinMatrix += skinWeight.y * boneMatY;\n\tskinMatrix += skinWeight.z * boneMatZ;\n\tskinMatrix += skinWeight.w * boneMatW;\n\tskinMatrix = bindMatrixInverse * skinMatrix * bindMatrix;\n\tobjectNormal = vec4( skinMatrix * vec4( objectNormal, 0.0 ) ).xyz;\n\t#ifdef USE_TANGENT\n\t\tobjectTangent = vec4( skinMatrix * vec4( objectTangent, 0.0 ) ).xyz;\n\t#endif\n#endif",specularmap_fragment:"float specularStrength;\n#ifdef USE_SPECULARMAP\n\tvec4 texelSpecular = texture2D( specularMap, vSpecularMapUv );\n\tspecularStrength = texelSpecular.r;\n#else\n\tspecularStrength = 1.0;\n#endif",specularmap_pars_fragment:"#ifdef USE_SPECULARMAP\n\tuniform sampler2D specularMap;\n#endif",tonemapping_fragment:"#if defined( TONE_MAPPING )\n\tgl_FragColor.rgb = toneMapping( gl_FragColor.rgb );\n#endif",tonemapping_pars_fragment:"#ifndef saturate\n#define saturate( a ) clamp( a, 0.0, 1.0 )\n#endif\nuniform float toneMappingExposure;\nvec3 LinearToneMapping( vec3 color ) {\n\treturn saturate( toneMappingExposure * color );\n}\nvec3 ReinhardToneMapping( vec3 color ) {\n\tcolor *= toneMappingExposure;\n\treturn saturate( color / ( vec3( 1.0 ) + color ) );\n}\nvec3 CineonToneMapping( vec3 color ) {\n\tcolor *= toneMappingExposure;\n\tcolor = max( vec3( 0.0 ), color - 0.004 );\n\treturn pow( ( color * ( 6.2 * color + 0.5 ) ) / ( color * ( 6.2 * color + 1.7 ) + 0.06 ), vec3( 2.2 ) );\n}\nvec3 RRTAndODTFit( vec3 v ) {\n\tvec3 a = v * ( v + 0.0245786 ) - 0.000090537;\n\tvec3 b = v * ( 0.983729 * v + 0.4329510 ) + 0.238081;\n\treturn a / b;\n}\nvec3 ACESFilmicToneMapping( vec3 color ) {\n\tconst mat3 ACESInputMat = mat3(\n\t\tvec3( 0.59719, 0.07600, 0.02840 ),\t\tvec3( 0.35458, 0.90834, 0.13383 ),\n\t\tvec3( 0.04823, 0.01566, 0.83777 )\n\t);\n\tconst mat3 ACESOutputMat = mat3(\n\t\tvec3(  1.60475, -0.10208, -0.00327 ),\t\tvec3( -0.53108,  1.10813, -0.07276 ),\n\t\tvec3( -0.07367, -0.00605,  1.07602 )\n\t);\n\tcolor *= toneMappingExposure / 0.6;\n\tcolor = ACESInputMat * color;\n\tcolor = RRTAndODTFit( color );\n\tcolor = ACESOutputMat * color;\n\treturn saturate( color );\n}\nconst mat3 LINEAR_REC2020_TO_LINEAR_SRGB = mat3(\n\tvec3( 1.6605, - 0.1246, - 0.0182 ),\n\tvec3( - 0.5876, 1.1329, - 0.1006 ),\n\tvec3( - 0.0728, - 0.0083, 1.1187 )\n);\nconst mat3 LINEAR_SRGB_TO_LINEAR_REC2020 = mat3(\n\tvec3( 0.6274, 0.0691, 0.0164 ),\n\tvec3( 0.3293, 0.9195, 0.0880 ),\n\tvec3( 0.0433, 0.0113, 0.8956 )\n);\nvec3 agxDefaultContrastApprox( vec3 x ) {\n\tvec3 x2 = x * x;\n\tvec3 x4 = x2 * x2;\n\treturn + 15.5 * x4 * x2\n\t\t- 40.14 * x4 * x\n\t\t+ 31.96 * x4\n\t\t- 6.868 * x2 * x\n\t\t+ 0.4298 * x2\n\t\t+ 0.1191 * x\n\t\t- 0.00232;\n}\nvec3 AgXToneMapping( vec3 color ) {\n\tconst mat3 AgXInsetMatrix = mat3(\n\t\tvec3( 0.856627153315983, 0.137318972929847, 0.11189821299995 ),\n\t\tvec3( 0.0951212405381588, 0.761241990602591, 0.0767994186031903 ),\n\t\tvec3( 0.0482516061458583, 0.101439036467562, 0.811302368396859 )\n\t);\n\tconst mat3 AgXOutsetMatrix = mat3(\n\t\tvec3( 1.1271005818144368, - 0.1413297634984383, - 0.14132976349843826 ),\n\t\tvec3( - 0.11060664309660323, 1.157823702216272, - 0.11060664309660294 ),\n\t\tvec3( - 0.016493938717834573, - 0.016493938717834257, 1.2519364065950405 )\n\t);\n\tconst float AgxMinEv = - 12.47393;\tconst float AgxMaxEv = 4.026069;\n\tcolor *= toneMappingExposure;\n\tcolor = LINEAR_SRGB_TO_LINEAR_REC2020 * color;\n\tcolor = AgXInsetMatrix * color;\n\tcolor = max( color, 1e-10 );\tcolor = log2( color );\n\tcolor = ( color - AgxMinEv ) / ( AgxMaxEv - AgxMinEv );\n\tcolor = clamp( color, 0.0, 1.0 );\n\tcolor = agxDefaultContrastApprox( color );\n\tcolor = AgXOutsetMatrix * color;\n\tcolor = pow( max( vec3( 0.0 ), color ), vec3( 2.2 ) );\n\tcolor = LINEAR_REC2020_TO_LINEAR_SRGB * color;\n\tcolor = clamp( color, 0.0, 1.0 );\n\treturn color;\n}\nvec3 NeutralToneMapping( vec3 color ) {\n\tconst float StartCompression = 0.8 - 0.04;\n\tconst float Desaturation = 0.15;\n\tcolor *= toneMappingExposure;\n\tfloat x = min( color.r, min( color.g, color.b ) );\n\tfloat offset = x < 0.08 ? x - 6.25 * x * x : 0.04;\n\tcolor -= offset;\n\tfloat peak = max( color.r, max( color.g, color.b ) );\n\tif ( peak < StartCompression ) return color;\n\tfloat d = 1. - StartCompression;\n\tfloat newPeak = 1. - d * d / ( peak + d - StartCompression );\n\tcolor *= newPeak / peak;\n\tfloat g = 1. - 1. / ( Desaturation * ( peak - newPeak ) + 1. );\n\treturn mix( color, vec3( newPeak ), g );\n}\nvec3 CustomToneMapping( vec3 color ) { return color; }",transmission_fragment:"#ifdef USE_TRANSMISSION\n\tmaterial.transmission = transmission;\n\tmaterial.transmissionAlpha = 1.0;\n\tmaterial.thickness = thickness;\n\tmaterial.attenuationDistance = attenuationDistance;\n\tmaterial.attenuationColor = attenuationColor;\n\t#ifdef USE_TRANSMISSIONMAP\n\t\tmaterial.transmission *= texture2D( transmissionMap, vTransmissionMapUv ).r;\n\t#endif\n\t#ifdef USE_THICKNESSMAP\n\t\tmaterial.thickness *= texture2D( thicknessMap, vThicknessMapUv ).g;\n\t#endif\n\tvec3 pos = vWorldPosition;\n\tvec3 v = normalize( cameraPosition - pos );\n\tvec3 n = inverseTransformDirection( normal, viewMatrix );\n\tvec4 transmitted = getIBLVolumeRefraction(\n\t\tn, v, material.roughness, material.diffuseColor, material.specularColor, material.specularF90,\n\t\tpos, modelMatrix, viewMatrix, projectionMatrix, material.dispersion, material.ior, material.thickness,\n\t\tmaterial.attenuationColor, material.attenuationDistance );\n\tmaterial.transmissionAlpha = mix( material.transmissionAlpha, transmitted.a, material.transmission );\n\ttotalDiffuse = mix( totalDiffuse, transmitted.rgb, material.transmission );\n#endif",transmission_pars_fragment:"#ifdef USE_TRANSMISSION\n\tuniform float transmission;\n\tuniform float thickness;\n\tuniform float attenuationDistance;\n\tuniform vec3 attenuationColor;\n\t#ifdef USE_TRANSMISSIONMAP\n\t\tuniform sampler2D transmissionMap;\n\t#endif\n\t#ifdef USE_THICKNESSMAP\n\t\tuniform sampler2D thicknessMap;\n\t#endif\n\tuniform vec2 transmissionSamplerSize;\n\tuniform sampler2D transmissionSamplerMap;\n\tuniform mat4 modelMatrix;\n\tuniform mat4 projectionMatrix;\n\tvarying vec3 vWorldPosition;\n\tfloat w0( float a ) {\n\t\treturn ( 1.0 / 6.0 ) * ( a * ( a * ( - a + 3.0 ) - 3.0 ) + 1.0 );\n\t}\n\tfloat w1( float a ) {\n\t\treturn ( 1.0 / 6.0 ) * ( a *  a * ( 3.0 * a - 6.0 ) + 4.0 );\n\t}\n\tfloat w2( float a ){\n\t\treturn ( 1.0 / 6.0 ) * ( a * ( a * ( - 3.0 * a + 3.0 ) + 3.0 ) + 1.0 );\n\t}\n\tfloat w3( float a ) {\n\t\treturn ( 1.0 / 6.0 ) * ( a * a * a );\n\t}\n\tfloat g0( float a ) {\n\t\treturn w0( a ) + w1( a );\n\t}\n\tfloat g1( float a ) {\n\t\treturn w2( a ) + w3( a );\n\t}\n\tfloat h0( float a ) {\n\t\treturn - 1.0 + w1( a ) / ( w0( a ) + w1( a ) );\n\t}\n\tfloat h1( float a ) {\n\t\treturn 1.0 + w3( a ) / ( w2( a ) + w3( a ) );\n\t}\n\tvec4 bicubic( sampler2D tex, vec2 uv, vec4 texelSize, float lod ) {\n\t\tuv = uv * texelSize.zw + 0.5;\n\t\tvec2 iuv = floor( uv );\n\t\tvec2 fuv = fract( uv );\n\t\tfloat g0x = g0( fuv.x );\n\t\tfloat g1x = g1( fuv.x );\n\t\tfloat h0x = h0( fuv.x );\n\t\tfloat h1x = h1( fuv.x );\n\t\tfloat h0y = h0( fuv.y );\n\t\tfloat h1y = h1( fuv.y );\n\t\tvec2 p0 = ( vec2( iuv.x + h0x, iuv.y + h0y ) - 0.5 ) * texelSize.xy;\n\t\tvec2 p1 = ( vec2( iuv.x + h1x, iuv.y + h0y ) - 0.5 ) * texelSize.xy;\n\t\tvec2 p2 = ( vec2( iuv.x + h0x, iuv.y + h1y ) - 0.5 ) * texelSize.xy;\n\t\tvec2 p3 = ( vec2( iuv.x + h1x, iuv.y + h1y ) - 0.5 ) * texelSize.xy;\n\t\treturn g0( fuv.y ) * ( g0x * textureLod( tex, p0, lod ) + g1x * textureLod( tex, p1, lod ) ) +\n\t\t\tg1( fuv.y ) * ( g0x * textureLod( tex, p2, lod ) + g1x * textureLod( tex, p3, lod ) );\n\t}\n\tvec4 textureBicubic( sampler2D sampler, vec2 uv, float lod ) {\n\t\tvec2 fLodSize = vec2( textureSize( sampler, int( lod ) ) );\n\t\tvec2 cLodSize = vec2( textureSize( sampler, int( lod + 1.0 ) ) );\n\t\tvec2 fLodSizeInv = 1.0 / fLodSize;\n\t\tvec2 cLodSizeInv = 1.0 / cLodSize;\n\t\tvec4 fSample = bicubic( sampler, uv, vec4( fLodSizeInv, fLodSize ), floor( lod ) );\n\t\tvec4 cSample = bicubic( sampler, uv, vec4( cLodSizeInv, cLodSize ), ceil( lod ) );\n\t\treturn mix( fSample, cSample, fract( lod ) );\n\t}\n\tvec3 getVolumeTransmissionRay( const in vec3 n, const in vec3 v, const in float thickness, const in float ior, const in mat4 modelMatrix ) {\n\t\tvec3 refractionVector = refract( - v, normalize( n ), 1.0 / ior );\n\t\tvec3 modelScale;\n\t\tmodelScale.x = length( vec3( modelMatrix[ 0 ].xyz ) );\n\t\tmodelScale.y = length( vec3( modelMatrix[ 1 ].xyz ) );\n\t\tmodelScale.z = length( vec3( modelMatrix[ 2 ].xyz ) );\n\t\treturn normalize( refractionVector ) * thickness * modelScale;\n\t}\n\tfloat applyIorToRoughness( const in float roughness, const in float ior ) {\n\t\treturn roughness * clamp( ior * 2.0 - 2.0, 0.0, 1.0 );\n\t}\n\tvec4 getTransmissionSample( const in vec2 fragCoord, const in float roughness, const in float ior ) {\n\t\tfloat lod = log2( transmissionSamplerSize.x ) * applyIorToRoughness( roughness, ior );\n\t\treturn textureBicubic( transmissionSamplerMap, fragCoord.xy, lod );\n\t}\n\tvec3 volumeAttenuation( const in float transmissionDistance, const in vec3 attenuationColor, const in float attenuationDistance ) {\n\t\tif ( isinf( attenuationDistance ) ) {\n\t\t\treturn vec3( 1.0 );\n\t\t} else {\n\t\t\tvec3 attenuationCoefficient = -log( attenuationColor ) / attenuationDistance;\n\t\t\tvec3 transmittance = exp( - attenuationCoefficient * transmissionDistance );\t\t\treturn transmittance;\n\t\t}\n\t}\n\tvec4 getIBLVolumeRefraction( const in vec3 n, const in vec3 v, const in float roughness, const in vec3 diffuseColor,\n\t\tconst in vec3 specularColor, const in float specularF90, const in vec3 position, const in mat4 modelMatrix,\n\t\tconst in mat4 viewMatrix, const in mat4 projMatrix, const in float dispersion, const in float ior, const in float thickness,\n\t\tconst in vec3 attenuationColor, const in float attenuationDistance ) {\n\t\tvec4 transmittedLight;\n\t\tvec3 transmittance;\n\t\t#ifdef USE_DISPERSION\n\t\t\tfloat halfSpread = ( ior - 1.0 ) * 0.025 * dispersion;\n\t\t\tvec3 iors = vec3( ior - halfSpread, ior, ior + halfSpread );\n\t\t\tfor ( int i = 0; i < 3; i ++ ) {\n\t\t\t\tvec3 transmissionRay = getVolumeTransmissionRay( n, v, thickness, iors[ i ], modelMatrix );\n\t\t\t\tvec3 refractedRayExit = position + transmissionRay;\n\t\t\t\tvec4 ndcPos = projMatrix * viewMatrix * vec4( refractedRayExit, 1.0 );\n\t\t\t\tvec2 refractionCoords = ndcPos.xy / ndcPos.w;\n\t\t\t\trefractionCoords += 1.0;\n\t\t\t\trefractionCoords /= 2.0;\n\t\t\t\tvec4 transmissionSample = getTransmissionSample( refractionCoords, roughness, iors[ i ] );\n\t\t\t\ttransmittedLight[ i ] = transmissionSample[ i ];\n\t\t\t\ttransmittedLight.a += transmissionSample.a;\n\t\t\t\ttransmittance[ i ] = diffuseColor[ i ] * volumeAttenuation( length( transmissionRay ), attenuationColor, attenuationDistance )[ i ];\n\t\t\t}\n\t\t\ttransmittedLight.a /= 3.0;\n\t\t#else\n\t\t\tvec3 transmissionRay = getVolumeTransmissionRay( n, v, thickness, ior, modelMatrix );\n\t\t\tvec3 refractedRayExit = position + transmissionRay;\n\t\t\tvec4 ndcPos = projMatrix * viewMatrix * vec4( refractedRayExit, 1.0 );\n\t\t\tvec2 refractionCoords = ndcPos.xy / ndcPos.w;\n\t\t\trefractionCoords += 1.0;\n\t\t\trefractionCoords /= 2.0;\n\t\t\ttransmittedLight = getTransmissionSample( refractionCoords, roughness, ior );\n\t\t\ttransmittance = diffuseColor * volumeAttenuation( length( transmissionRay ), attenuationColor, attenuationDistance );\n\t\t#endif\n\t\tvec3 attenuatedColor = transmittance * transmittedLight.rgb;\n\t\tvec3 F = EnvironmentBRDF( n, v, specularColor, specularF90, roughness );\n\t\tfloat transmittanceFactor = ( transmittance.r + transmittance.g + transmittance.b ) / 3.0;\n\t\treturn vec4( ( 1.0 - F ) * attenuatedColor, 1.0 - ( 1.0 - transmittedLight.a ) * transmittanceFactor );\n\t}\n#endif",uv_pars_fragment:"#if defined( USE_UV ) || defined( USE_ANISOTROPY )\n\tvarying vec2 vUv;\n#endif\n#ifdef USE_MAP\n\tvarying vec2 vMapUv;\n#endif\n#ifdef USE_ALPHAMAP\n\tvarying vec2 vAlphaMapUv;\n#endif\n#ifdef USE_LIGHTMAP\n\tvarying vec2 vLightMapUv;\n#endif\n#ifdef USE_AOMAP\n\tvarying vec2 vAoMapUv;\n#endif\n#ifdef USE_BUMPMAP\n\tvarying vec2 vBumpMapUv;\n#endif\n#ifdef USE_NORMALMAP\n\tvarying vec2 vNormalMapUv;\n#endif\n#ifdef USE_EMISSIVEMAP\n\tvarying vec2 vEmissiveMapUv;\n#endif\n#ifdef USE_METALNESSMAP\n\tvarying vec2 vMetalnessMapUv;\n#endif\n#ifdef USE_ROUGHNESSMAP\n\tvarying vec2 vRoughnessMapUv;\n#endif\n#ifdef USE_ANISOTROPYMAP\n\tvarying vec2 vAnisotropyMapUv;\n#endif\n#ifdef USE_CLEARCOATMAP\n\tvarying vec2 vClearcoatMapUv;\n#endif\n#ifdef USE_CLEARCOAT_NORMALMAP\n\tvarying vec2 vClearcoatNormalMapUv;\n#endif\n#ifdef USE_CLEARCOAT_ROUGHNESSMAP\n\tvarying vec2 vClearcoatRoughnessMapUv;\n#endif\n#ifdef USE_IRIDESCENCEMAP\n\tvarying vec2 vIridescenceMapUv;\n#endif\n#ifdef USE_IRIDESCENCE_THICKNESSMAP\n\tvarying vec2 vIridescenceThicknessMapUv;\n#endif\n#ifdef USE_SHEEN_COLORMAP\n\tvarying vec2 vSheenColorMapUv;\n#endif\n#ifdef USE_SHEEN_ROUGHNESSMAP\n\tvarying vec2 vSheenRoughnessMapUv;\n#endif\n#ifdef USE_SPECULARMAP\n\tvarying vec2 vSpecularMapUv;\n#endif\n#ifdef USE_SPECULAR_COLORMAP\n\tvarying vec2 vSpecularColorMapUv;\n#endif\n#ifdef USE_SPECULAR_INTENSITYMAP\n\tvarying vec2 vSpecularIntensityMapUv;\n#endif\n#ifdef USE_TRANSMISSIONMAP\n\tuniform mat3 transmissionMapTransform;\n\tvarying vec2 vTransmissionMapUv;\n#endif\n#ifdef USE_THICKNESSMAP\n\tuniform mat3 thicknessMapTransform;\n\tvarying vec2 vThicknessMapUv;\n#endif",uv_pars_vertex:"#if defined( USE_UV ) || defined( USE_ANISOTROPY )\n\tvarying vec2 vUv;\n#endif\n#ifdef USE_MAP\n\tuniform mat3 mapTransform;\n\tvarying vec2 vMapUv;\n#endif\n#ifdef USE_ALPHAMAP\n\tuniform mat3 alphaMapTransform;\n\tvarying vec2 vAlphaMapUv;\n#endif\n#ifdef USE_LIGHTMAP\n\tuniform mat3 lightMapTransform;\n\tvarying vec2 vLightMapUv;\n#endif\n#ifdef USE_AOMAP\n\tuniform mat3 aoMapTransform;\n\tvarying vec2 vAoMapUv;\n#endif\n#ifdef USE_BUMPMAP\n\tuniform mat3 bumpMapTransform;\n\tvarying vec2 vBumpMapUv;\n#endif\n#ifdef USE_NORMALMAP\n\tuniform mat3 normalMapTransform;\n\tvarying vec2 vNormalMapUv;\n#endif\n#ifdef USE_DISPLACEMENTMAP\n\tuniform mat3 displacementMapTransform;\n\tvarying vec2 vDisplacementMapUv;\n#endif\n#ifdef USE_EMISSIVEMAP\n\tuniform mat3 emissiveMapTransform;\n\tvarying vec2 vEmissiveMapUv;\n#endif\n#ifdef USE_METALNESSMAP\n\tuniform mat3 metalnessMapTransform;\n\tvarying vec2 vMetalnessMapUv;\n#endif\n#ifdef USE_ROUGHNESSMAP\n\tuniform mat3 roughnessMapTransform;\n\tvarying vec2 vRoughnessMapUv;\n#endif\n#ifdef USE_ANISOTROPYMAP\n\tuniform mat3 anisotropyMapTransform;\n\tvarying vec2 vAnisotropyMapUv;\n#endif\n#ifdef USE_CLEARCOATMAP\n\tuniform mat3 clearcoatMapTransform;\n\tvarying vec2 vClearcoatMapUv;\n#endif\n#ifdef USE_CLEARCOAT_NORMALMAP\n\tuniform mat3 clearcoatNormalMapTransform;\n\tvarying vec2 vClearcoatNormalMapUv;\n#endif\n#ifdef USE_CLEARCOAT_ROUGHNESSMAP\n\tuniform mat3 clearcoatRoughnessMapTransform;\n\tvarying vec2 vClearcoatRoughnessMapUv;\n#endif\n#ifdef USE_SHEEN_COLORMAP\n\tuniform mat3 sheenColorMapTransform;\n\tvarying vec2 vSheenColorMapUv;\n#endif\n#ifdef USE_SHEEN_ROUGHNESSMAP\n\tuniform mat3 sheenRoughnessMapTransform;\n\tvarying vec2 vSheenRoughnessMapUv;\n#endif\n#ifdef USE_IRIDESCENCEMAP\n\tuniform mat3 iridescenceMapTransform;\n\tvarying vec2 vIridescenceMapUv;\n#endif\n#ifdef USE_IRIDESCENCE_THICKNESSMAP\n\tuniform mat3 iridescenceThicknessMapTransform;\n\tvarying vec2 vIridescenceThicknessMapUv;\n#endif\n#ifdef USE_SPECULARMAP\n\tuniform mat3 specularMapTransform;\n\tvarying vec2 vSpecularMapUv;\n#endif\n#ifdef USE_SPECULAR_COLORMAP\n\tuniform mat3 specularColorMapTransform;\n\tvarying vec2 vSpecularColorMapUv;\n#endif\n#ifdef USE_SPECULAR_INTENSITYMAP\n\tuniform mat3 specularIntensityMapTransform;\n\tvarying vec2 vSpecularIntensityMapUv;\n#endif\n#ifdef USE_TRANSMISSIONMAP\n\tuniform mat3 transmissionMapTransform;\n\tvarying vec2 vTransmissionMapUv;\n#endif\n#ifdef USE_THICKNESSMAP\n\tuniform mat3 thicknessMapTransform;\n\tvarying vec2 vThicknessMapUv;\n#endif",uv_vertex:"#if defined( USE_UV ) || defined( USE_ANISOTROPY )\n\tvUv = vec3( uv, 1 ).xy;\n#endif\n#ifdef USE_MAP\n\tvMapUv = ( mapTransform * vec3( MAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_ALPHAMAP\n\tvAlphaMapUv = ( alphaMapTransform * vec3( ALPHAMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_LIGHTMAP\n\tvLightMapUv = ( lightMapTransform * vec3( LIGHTMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_AOMAP\n\tvAoMapUv = ( aoMapTransform * vec3( AOMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_BUMPMAP\n\tvBumpMapUv = ( bumpMapTransform * vec3( BUMPMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_NORMALMAP\n\tvNormalMapUv = ( normalMapTransform * vec3( NORMALMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_DISPLACEMENTMAP\n\tvDisplacementMapUv = ( displacementMapTransform * vec3( DISPLACEMENTMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_EMISSIVEMAP\n\tvEmissiveMapUv = ( emissiveMapTransform * vec3( EMISSIVEMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_METALNESSMAP\n\tvMetalnessMapUv = ( metalnessMapTransform * vec3( METALNESSMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_ROUGHNESSMAP\n\tvRoughnessMapUv = ( roughnessMapTransform * vec3( ROUGHNESSMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_ANISOTROPYMAP\n\tvAnisotropyMapUv = ( anisotropyMapTransform * vec3( ANISOTROPYMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_CLEARCOATMAP\n\tvClearcoatMapUv = ( clearcoatMapTransform * vec3( CLEARCOATMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_CLEARCOAT_NORMALMAP\n\tvClearcoatNormalMapUv = ( clearcoatNormalMapTransform * vec3( CLEARCOAT_NORMALMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_CLEARCOAT_ROUGHNESSMAP\n\tvClearcoatRoughnessMapUv = ( clearcoatRoughnessMapTransform * vec3( CLEARCOAT_ROUGHNESSMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_IRIDESCENCEMAP\n\tvIridescenceMapUv = ( iridescenceMapTransform * vec3( IRIDESCENCEMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_IRIDESCENCE_THICKNESSMAP\n\tvIridescenceThicknessMapUv = ( iridescenceThicknessMapTransform * vec3( IRIDESCENCE_THICKNESSMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_SHEEN_COLORMAP\n\tvSheenColorMapUv = ( sheenColorMapTransform * vec3( SHEEN_COLORMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_SHEEN_ROUGHNESSMAP\n\tvSheenRoughnessMapUv = ( sheenRoughnessMapTransform * vec3( SHEEN_ROUGHNESSMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_SPECULARMAP\n\tvSpecularMapUv = ( specularMapTransform * vec3( SPECULARMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_SPECULAR_COLORMAP\n\tvSpecularColorMapUv = ( specularColorMapTransform * vec3( SPECULAR_COLORMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_SPECULAR_INTENSITYMAP\n\tvSpecularIntensityMapUv = ( specularIntensityMapTransform * vec3( SPECULAR_INTENSITYMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_TRANSMISSIONMAP\n\tvTransmissionMapUv = ( transmissionMapTransform * vec3( TRANSMISSIONMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_THICKNESSMAP\n\tvThicknessMapUv = ( thicknessMapTransform * vec3( THICKNESSMAP_UV, 1 ) ).xy;\n#endif",worldpos_vertex:"#if defined( USE_ENVMAP ) || defined( DISTANCE ) || defined ( USE_SHADOWMAP ) || defined ( USE_TRANSMISSION ) || NUM_SPOT_LIGHT_COORDS > 0\n\tvec4 worldPosition = vec4( transformed, 1.0 );\n\t#ifdef USE_BATCHING\n\t\tworldPosition = batchingMatrix * worldPosition;\n\t#endif\n\t#ifdef USE_INSTANCING\n\t\tworldPosition = instanceMatrix * worldPosition;\n\t#endif\n\tworldPosition = modelMatrix * worldPosition;\n#endif",background_vert:"varying vec2 vUv;\nuniform mat3 uvTransform;\nvoid main() {\n\tvUv = ( uvTransform * vec3( uv, 1 ) ).xy;\n\tgl_Position = vec4( position.xy, 1.0, 1.0 );\n}",background_frag:"uniform sampler2D t2D;\nuniform float backgroundIntensity;\nvarying vec2 vUv;\nvoid main() {\n\tvec4 texColor = texture2D( t2D, vUv );\n\t#ifdef DECODE_VIDEO_TEXTURE\n\t\ttexColor = vec4( mix( pow( texColor.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), texColor.rgb * 0.0773993808, vec3( lessThanEqual( texColor.rgb, vec3( 0.04045 ) ) ) ), texColor.w );\n\t#endif\n\ttexColor.rgb *= backgroundIntensity;\n\tgl_FragColor = texColor;\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n}",backgroundCube_vert:"varying vec3 vWorldDirection;\n#include <common>\nvoid main() {\n\tvWorldDirection = transformDirection( position, modelMatrix );\n\t#include <begin_vertex>\n\t#include <project_vertex>\n\tgl_Position.z = gl_Position.w;\n}",backgroundCube_frag:"#ifdef ENVMAP_TYPE_CUBE\n\tuniform samplerCube envMap;\n#elif defined( ENVMAP_TYPE_CUBE_UV )\n\tuniform sampler2D envMap;\n#endif\nuniform float flipEnvMap;\nuniform float backgroundBlurriness;\nuniform float backgroundIntensity;\nuniform mat3 backgroundRotation;\nvarying vec3 vWorldDirection;\n#include <cube_uv_reflection_fragment>\nvoid main() {\n\t#ifdef ENVMAP_TYPE_CUBE\n\t\tvec4 texColor = textureCube( envMap, backgroundRotation * vec3( flipEnvMap * vWorldDirection.x, vWorldDirection.yz ) );\n\t#elif defined( ENVMAP_TYPE_CUBE_UV )\n\t\tvec4 texColor = textureCubeUV( envMap, backgroundRotation * vWorldDirection, backgroundBlurriness );\n\t#else\n\t\tvec4 texColor = vec4( 0.0, 0.0, 0.0, 1.0 );\n\t#endif\n\ttexColor.rgb *= backgroundIntensity;\n\tgl_FragColor = texColor;\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n}",cube_vert:"varying vec3 vWorldDirection;\n#include <common>\nvoid main() {\n\tvWorldDirection = transformDirection( position, modelMatrix );\n\t#include <begin_vertex>\n\t#include <project_vertex>\n\tgl_Position.z = gl_Position.w;\n}",cube_frag:"uniform samplerCube tCube;\nuniform float tFlip;\nuniform float opacity;\nvarying vec3 vWorldDirection;\nvoid main() {\n\tvec4 texColor = textureCube( tCube, vec3( tFlip * vWorldDirection.x, vWorldDirection.yz ) );\n\tgl_FragColor = texColor;\n\tgl_FragColor.a *= opacity;\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n}",depth_vert:"#include <common>\n#include <batching_pars_vertex>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvarying vec2 vHighPrecisionZW;\nvoid main() {\n\t#include <uv_vertex>\n\t#include <batching_vertex>\n\t#include <skinbase_vertex>\n\t#include <morphinstance_vertex>\n\t#ifdef USE_DISPLACEMENTMAP\n\t\t#include <beginnormal_vertex>\n\t\t#include <morphnormal_vertex>\n\t\t#include <skinnormal_vertex>\n\t#endif\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\tvHighPrecisionZW = gl_Position.zw;\n}",depth_frag:"#if DEPTH_PACKING == 3200\n\tuniform float opacity;\n#endif\n#include <common>\n#include <packing>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvarying vec2 vHighPrecisionZW;\nvoid main() {\n\tvec4 diffuseColor = vec4( 1.0 );\n\t#include <clipping_planes_fragment>\n\t#if DEPTH_PACKING == 3200\n\t\tdiffuseColor.a = opacity;\n\t#endif\n\t#include <map_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <alphahash_fragment>\n\t#include <logdepthbuf_fragment>\n\tfloat fragCoordZ = 0.5 * vHighPrecisionZW[0] / vHighPrecisionZW[1] + 0.5;\n\t#if DEPTH_PACKING == 3200\n\t\tgl_FragColor = vec4( vec3( 1.0 - fragCoordZ ), opacity );\n\t#elif DEPTH_PACKING == 3201\n\t\tgl_FragColor = packDepthToRGBA( fragCoordZ );\n\t#elif DEPTH_PACKING == 3202\n\t\tgl_FragColor = vec4( packDepthToRGB( fragCoordZ ), 1.0 );\n\t#elif DEPTH_PACKING == 3203\n\t\tgl_FragColor = vec4( packDepthToRG( fragCoordZ ), 0.0, 1.0 );\n\t#endif\n}",distanceRGBA_vert:"#define DISTANCE\nvarying vec3 vWorldPosition;\n#include <common>\n#include <batching_pars_vertex>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <batching_vertex>\n\t#include <skinbase_vertex>\n\t#include <morphinstance_vertex>\n\t#ifdef USE_DISPLACEMENTMAP\n\t\t#include <beginnormal_vertex>\n\t\t#include <morphnormal_vertex>\n\t\t#include <skinnormal_vertex>\n\t#endif\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <worldpos_vertex>\n\t#include <clipping_planes_vertex>\n\tvWorldPosition = worldPosition.xyz;\n}",distanceRGBA_frag:"#define DISTANCE\nuniform vec3 referencePosition;\nuniform float nearDistance;\nuniform float farDistance;\nvarying vec3 vWorldPosition;\n#include <common>\n#include <packing>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main () {\n\tvec4 diffuseColor = vec4( 1.0 );\n\t#include <clipping_planes_fragment>\n\t#include <map_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <alphahash_fragment>\n\tfloat dist = length( vWorldPosition - referencePosition );\n\tdist = ( dist - nearDistance ) / ( farDistance - nearDistance );\n\tdist = saturate( dist );\n\tgl_FragColor = packDepthToRGBA( dist );\n}",equirect_vert:"varying vec3 vWorldDirection;\n#include <common>\nvoid main() {\n\tvWorldDirection = transformDirection( position, modelMatrix );\n\t#include <begin_vertex>\n\t#include <project_vertex>\n}",equirect_frag:"uniform sampler2D tEquirect;\nvarying vec3 vWorldDirection;\n#include <common>\nvoid main() {\n\tvec3 direction = normalize( vWorldDirection );\n\tvec2 sampleUV = equirectUv( direction );\n\tgl_FragColor = texture2D( tEquirect, sampleUV );\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n}",linedashed_vert:"uniform float scale;\nattribute float lineDistance;\nvarying float vLineDistance;\n#include <common>\n#include <uv_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\tvLineDistance = scale * lineDistance;\n\t#include <uv_vertex>\n\t#include <color_vertex>\n\t#include <morphinstance_vertex>\n\t#include <morphcolor_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <fog_vertex>\n}",linedashed_frag:"uniform vec3 diffuse;\nuniform float opacity;\nuniform float dashSize;\nuniform float totalSize;\nvarying float vLineDistance;\n#include <common>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <fog_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <clipping_planes_fragment>\n\tif ( mod( vLineDistance, totalSize ) > dashSize ) {\n\t\tdiscard;\n\t}\n\tvec3 outgoingLight = vec3( 0.0 );\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\toutgoingLight = diffuseColor.rgb;\n\t#include <opaque_fragment>\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n}",meshbasic_vert:"#include <common>\n#include <batching_pars_vertex>\n#include <uv_pars_vertex>\n#include <envmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <color_vertex>\n\t#include <morphinstance_vertex>\n\t#include <morphcolor_vertex>\n\t#include <batching_vertex>\n\t#if defined ( USE_ENVMAP ) || defined ( USE_SKINNING )\n\t\t#include <beginnormal_vertex>\n\t\t#include <morphnormal_vertex>\n\t\t#include <skinbase_vertex>\n\t\t#include <skinnormal_vertex>\n\t\t#include <defaultnormal_vertex>\n\t#endif\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <worldpos_vertex>\n\t#include <envmap_vertex>\n\t#include <fog_vertex>\n}",meshbasic_frag:"uniform vec3 diffuse;\nuniform float opacity;\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n#endif\n#include <common>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <envmap_common_pars_fragment>\n#include <envmap_pars_fragment>\n#include <fog_pars_fragment>\n#include <specularmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <clipping_planes_fragment>\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <alphahash_fragment>\n\t#include <specularmap_fragment>\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\t#ifdef USE_LIGHTMAP\n\t\tvec4 lightMapTexel = texture2D( lightMap, vLightMapUv );\n\t\treflectedLight.indirectDiffuse += lightMapTexel.rgb * lightMapIntensity * RECIPROCAL_PI;\n\t#else\n\t\treflectedLight.indirectDiffuse += vec3( 1.0 );\n\t#endif\n\t#include <aomap_fragment>\n\treflectedLight.indirectDiffuse *= diffuseColor.rgb;\n\tvec3 outgoingLight = reflectedLight.indirectDiffuse;\n\t#include <envmap_fragment>\n\t#include <opaque_fragment>\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}",meshlambert_vert:"#define LAMBERT\nvarying vec3 vViewPosition;\n#include <common>\n#include <batching_pars_vertex>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <envmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <normal_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <color_vertex>\n\t#include <morphinstance_vertex>\n\t#include <morphcolor_vertex>\n\t#include <batching_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#include <normal_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\tvViewPosition = - mvPosition.xyz;\n\t#include <worldpos_vertex>\n\t#include <envmap_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n}",meshlambert_frag:"#define LAMBERT\nuniform vec3 diffuse;\nuniform vec3 emissive;\nuniform float opacity;\n#include <common>\n#include <packing>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <emissivemap_pars_fragment>\n#include <envmap_common_pars_fragment>\n#include <envmap_pars_fragment>\n#include <fog_pars_fragment>\n#include <bsdfs>\n#include <lights_pars_begin>\n#include <normal_pars_fragment>\n#include <lights_lambert_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <specularmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <clipping_planes_fragment>\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\tvec3 totalEmissiveRadiance = emissive;\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <alphahash_fragment>\n\t#include <specularmap_fragment>\n\t#include <normal_fragment_begin>\n\t#include <normal_fragment_maps>\n\t#include <emissivemap_fragment>\n\t#include <lights_lambert_fragment>\n\t#include <lights_fragment_begin>\n\t#include <lights_fragment_maps>\n\t#include <lights_fragment_end>\n\t#include <aomap_fragment>\n\tvec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + totalEmissiveRadiance;\n\t#include <envmap_fragment>\n\t#include <opaque_fragment>\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}",meshmatcap_vert:"#define MATCAP\nvarying vec3 vViewPosition;\n#include <common>\n#include <batching_pars_vertex>\n#include <uv_pars_vertex>\n#include <color_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <fog_pars_vertex>\n#include <normal_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <color_vertex>\n\t#include <morphinstance_vertex>\n\t#include <morphcolor_vertex>\n\t#include <batching_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#include <normal_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <fog_vertex>\n\tvViewPosition = - mvPosition.xyz;\n}",meshmatcap_frag:"#define MATCAP\nuniform vec3 diffuse;\nuniform float opacity;\nuniform sampler2D matcap;\nvarying vec3 vViewPosition;\n#include <common>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <fog_pars_fragment>\n#include <normal_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <clipping_planes_fragment>\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <alphahash_fragment>\n\t#include <normal_fragment_begin>\n\t#include <normal_fragment_maps>\n\tvec3 viewDir = normalize( vViewPosition );\n\tvec3 x = normalize( vec3( viewDir.z, 0.0, - viewDir.x ) );\n\tvec3 y = cross( viewDir, x );\n\tvec2 uv = vec2( dot( x, normal ), dot( y, normal ) ) * 0.495 + 0.5;\n\t#ifdef USE_MATCAP\n\t\tvec4 matcapColor = texture2D( matcap, uv );\n\t#else\n\t\tvec4 matcapColor = vec4( vec3( mix( 0.2, 0.8, uv.y ) ), 1.0 );\n\t#endif\n\tvec3 outgoingLight = diffuseColor.rgb * matcapColor.rgb;\n\t#include <opaque_fragment>\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}",meshnormal_vert:"#define NORMAL\n#if defined( FLAT_SHADED ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP_TANGENTSPACE )\n\tvarying vec3 vViewPosition;\n#endif\n#include <common>\n#include <batching_pars_vertex>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <normal_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <batching_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphinstance_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#include <normal_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n#if defined( FLAT_SHADED ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP_TANGENTSPACE )\n\tvViewPosition = - mvPosition.xyz;\n#endif\n}",meshnormal_frag:"#define NORMAL\nuniform float opacity;\n#if defined( FLAT_SHADED ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP_TANGENTSPACE )\n\tvarying vec3 vViewPosition;\n#endif\n#include <packing>\n#include <uv_pars_fragment>\n#include <normal_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\tvec4 diffuseColor = vec4( 0.0, 0.0, 0.0, opacity );\n\t#include <clipping_planes_fragment>\n\t#include <logdepthbuf_fragment>\n\t#include <normal_fragment_begin>\n\t#include <normal_fragment_maps>\n\tgl_FragColor = vec4( packNormalToRGB( normal ), diffuseColor.a );\n\t#ifdef OPAQUE\n\t\tgl_FragColor.a = 1.0;\n\t#endif\n}",meshphong_vert:"#define PHONG\nvarying vec3 vViewPosition;\n#include <common>\n#include <batching_pars_vertex>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <envmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <normal_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <color_vertex>\n\t#include <morphcolor_vertex>\n\t#include <batching_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphinstance_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#include <normal_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\tvViewPosition = - mvPosition.xyz;\n\t#include <worldpos_vertex>\n\t#include <envmap_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n}",meshphong_frag:"#define PHONG\nuniform vec3 diffuse;\nuniform vec3 emissive;\nuniform vec3 specular;\nuniform float shininess;\nuniform float opacity;\n#include <common>\n#include <packing>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <emissivemap_pars_fragment>\n#include <envmap_common_pars_fragment>\n#include <envmap_pars_fragment>\n#include <fog_pars_fragment>\n#include <bsdfs>\n#include <lights_pars_begin>\n#include <normal_pars_fragment>\n#include <lights_phong_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <specularmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <clipping_planes_fragment>\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\tvec3 totalEmissiveRadiance = emissive;\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <alphahash_fragment>\n\t#include <specularmap_fragment>\n\t#include <normal_fragment_begin>\n\t#include <normal_fragment_maps>\n\t#include <emissivemap_fragment>\n\t#include <lights_phong_fragment>\n\t#include <lights_fragment_begin>\n\t#include <lights_fragment_maps>\n\t#include <lights_fragment_end>\n\t#include <aomap_fragment>\n\tvec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + reflectedLight.directSpecular + reflectedLight.indirectSpecular + totalEmissiveRadiance;\n\t#include <envmap_fragment>\n\t#include <opaque_fragment>\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}",meshphysical_vert:"#define STANDARD\nvarying vec3 vViewPosition;\n#ifdef USE_TRANSMISSION\n\tvarying vec3 vWorldPosition;\n#endif\n#include <common>\n#include <batching_pars_vertex>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <normal_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <color_vertex>\n\t#include <morphinstance_vertex>\n\t#include <morphcolor_vertex>\n\t#include <batching_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#include <normal_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\tvViewPosition = - mvPosition.xyz;\n\t#include <worldpos_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n#ifdef USE_TRANSMISSION\n\tvWorldPosition = worldPosition.xyz;\n#endif\n}",meshphysical_frag:"#define STANDARD\n#ifdef PHYSICAL\n\t#define IOR\n\t#define USE_SPECULAR\n#endif\nuniform vec3 diffuse;\nuniform vec3 emissive;\nuniform float roughness;\nuniform float metalness;\nuniform float opacity;\n#ifdef IOR\n\tuniform float ior;\n#endif\n#ifdef USE_SPECULAR\n\tuniform float specularIntensity;\n\tuniform vec3 specularColor;\n\t#ifdef USE_SPECULAR_COLORMAP\n\t\tuniform sampler2D specularColorMap;\n\t#endif\n\t#ifdef USE_SPECULAR_INTENSITYMAP\n\t\tuniform sampler2D specularIntensityMap;\n\t#endif\n#endif\n#ifdef USE_CLEARCOAT\n\tuniform float clearcoat;\n\tuniform float clearcoatRoughness;\n#endif\n#ifdef USE_DISPERSION\n\tuniform float dispersion;\n#endif\n#ifdef USE_IRIDESCENCE\n\tuniform float iridescence;\n\tuniform float iridescenceIOR;\n\tuniform float iridescenceThicknessMinimum;\n\tuniform float iridescenceThicknessMaximum;\n#endif\n#ifdef USE_SHEEN\n\tuniform vec3 sheenColor;\n\tuniform float sheenRoughness;\n\t#ifdef USE_SHEEN_COLORMAP\n\t\tuniform sampler2D sheenColorMap;\n\t#endif\n\t#ifdef USE_SHEEN_ROUGHNESSMAP\n\t\tuniform sampler2D sheenRoughnessMap;\n\t#endif\n#endif\n#ifdef USE_ANISOTROPY\n\tuniform vec2 anisotropyVector;\n\t#ifdef USE_ANISOTROPYMAP\n\t\tuniform sampler2D anisotropyMap;\n\t#endif\n#endif\nvarying vec3 vViewPosition;\n#include <common>\n#include <packing>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <emissivemap_pars_fragment>\n#include <iridescence_fragment>\n#include <cube_uv_reflection_fragment>\n#include <envmap_common_pars_fragment>\n#include <envmap_physical_pars_fragment>\n#include <fog_pars_fragment>\n#include <lights_pars_begin>\n#include <normal_pars_fragment>\n#include <lights_physical_pars_fragment>\n#include <transmission_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <clearcoat_pars_fragment>\n#include <iridescence_pars_fragment>\n#include <roughnessmap_pars_fragment>\n#include <metalnessmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <clipping_planes_fragment>\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\tvec3 totalEmissiveRadiance = emissive;\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <alphahash_fragment>\n\t#include <roughnessmap_fragment>\n\t#include <metalnessmap_fragment>\n\t#include <normal_fragment_begin>\n\t#include <normal_fragment_maps>\n\t#include <clearcoat_normal_fragment_begin>\n\t#include <clearcoat_normal_fragment_maps>\n\t#include <emissivemap_fragment>\n\t#include <lights_physical_fragment>\n\t#include <lights_fragment_begin>\n\t#include <lights_fragment_maps>\n\t#include <lights_fragment_end>\n\t#include <aomap_fragment>\n\tvec3 totalDiffuse = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse;\n\tvec3 totalSpecular = reflectedLight.directSpecular + reflectedLight.indirectSpecular;\n\t#include <transmission_fragment>\n\tvec3 outgoingLight = totalDiffuse + totalSpecular + totalEmissiveRadiance;\n\t#ifdef USE_SHEEN\n\t\tfloat sheenEnergyComp = 1.0 - 0.157 * max3( material.sheenColor );\n\t\toutgoingLight = outgoingLight * sheenEnergyComp + sheenSpecularDirect + sheenSpecularIndirect;\n\t#endif\n\t#ifdef USE_CLEARCOAT\n\t\tfloat dotNVcc = saturate( dot( geometryClearcoatNormal, geometryViewDir ) );\n\t\tvec3 Fcc = F_Schlick( material.clearcoatF0, material.clearcoatF90, dotNVcc );\n\t\toutgoingLight = outgoingLight * ( 1.0 - material.clearcoat * Fcc ) + ( clearcoatSpecularDirect + clearcoatSpecularIndirect ) * material.clearcoat;\n\t#endif\n\t#include <opaque_fragment>\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}",meshtoon_vert:"#define TOON\nvarying vec3 vViewPosition;\n#include <common>\n#include <batching_pars_vertex>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <normal_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <color_vertex>\n\t#include <morphinstance_vertex>\n\t#include <morphcolor_vertex>\n\t#include <batching_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#include <normal_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\tvViewPosition = - mvPosition.xyz;\n\t#include <worldpos_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n}",meshtoon_frag:"#define TOON\nuniform vec3 diffuse;\nuniform vec3 emissive;\nuniform float opacity;\n#include <common>\n#include <packing>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <emissivemap_pars_fragment>\n#include <gradientmap_pars_fragment>\n#include <fog_pars_fragment>\n#include <bsdfs>\n#include <lights_pars_begin>\n#include <normal_pars_fragment>\n#include <lights_toon_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <clipping_planes_fragment>\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\tvec3 totalEmissiveRadiance = emissive;\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <alphahash_fragment>\n\t#include <normal_fragment_begin>\n\t#include <normal_fragment_maps>\n\t#include <emissivemap_fragment>\n\t#include <lights_toon_fragment>\n\t#include <lights_fragment_begin>\n\t#include <lights_fragment_maps>\n\t#include <lights_fragment_end>\n\t#include <aomap_fragment>\n\tvec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + totalEmissiveRadiance;\n\t#include <opaque_fragment>\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}",points_vert:"uniform float size;\nuniform float scale;\n#include <common>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\n#ifdef USE_POINTS_UV\n\tvarying vec2 vUv;\n\tuniform mat3 uvTransform;\n#endif\nvoid main() {\n\t#ifdef USE_POINTS_UV\n\t\tvUv = ( uvTransform * vec3( uv, 1 ) ).xy;\n\t#endif\n\t#include <color_vertex>\n\t#include <morphinstance_vertex>\n\t#include <morphcolor_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <project_vertex>\n\tgl_PointSize = size;\n\t#ifdef USE_SIZEATTENUATION\n\t\tbool isPerspective = isPerspectiveMatrix( projectionMatrix );\n\t\tif ( isPerspective ) gl_PointSize *= ( scale / - mvPosition.z );\n\t#endif\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <worldpos_vertex>\n\t#include <fog_vertex>\n}",points_frag:"uniform vec3 diffuse;\nuniform float opacity;\n#include <common>\n#include <color_pars_fragment>\n#include <map_particle_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <fog_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <clipping_planes_fragment>\n\tvec3 outgoingLight = vec3( 0.0 );\n\t#include <logdepthbuf_fragment>\n\t#include <map_particle_fragment>\n\t#include <color_fragment>\n\t#include <alphatest_fragment>\n\t#include <alphahash_fragment>\n\toutgoingLight = diffuseColor.rgb;\n\t#include <opaque_fragment>\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n}",shadow_vert:"#include <common>\n#include <batching_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <shadowmap_pars_vertex>\nvoid main() {\n\t#include <batching_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphinstance_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <worldpos_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n}",shadow_frag:"uniform vec3 color;\nuniform float opacity;\n#include <common>\n#include <packing>\n#include <fog_pars_fragment>\n#include <bsdfs>\n#include <lights_pars_begin>\n#include <logdepthbuf_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <shadowmask_pars_fragment>\nvoid main() {\n\t#include <logdepthbuf_fragment>\n\tgl_FragColor = vec4( color, opacity * ( 1.0 - getShadowMask() ) );\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n\t#include <fog_fragment>\n}",sprite_vert:"uniform float rotation;\nuniform vec2 center;\n#include <common>\n#include <uv_pars_vertex>\n#include <fog_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\tvec4 mvPosition = modelViewMatrix[ 3 ];\n\tvec2 scale = vec2( length( modelMatrix[ 0 ].xyz ), length( modelMatrix[ 1 ].xyz ) );\n\t#ifndef USE_SIZEATTENUATION\n\t\tbool isPerspective = isPerspectiveMatrix( projectionMatrix );\n\t\tif ( isPerspective ) scale *= - mvPosition.z;\n\t#endif\n\tvec2 alignedPosition = ( position.xy - ( center - vec2( 0.5 ) ) ) * scale;\n\tvec2 rotatedPosition;\n\trotatedPosition.x = cos( rotation ) * alignedPosition.x - sin( rotation ) * alignedPosition.y;\n\trotatedPosition.y = sin( rotation ) * alignedPosition.x + cos( rotation ) * alignedPosition.y;\n\tmvPosition.xy += rotatedPosition;\n\tgl_Position = projectionMatrix * mvPosition;\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <fog_vertex>\n}",sprite_frag:"uniform vec3 diffuse;\nuniform float opacity;\n#include <common>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <fog_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <clipping_planes_fragment>\n\tvec3 outgoingLight = vec3( 0.0 );\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <alphahash_fragment>\n\toutgoingLight = diffuseColor.rgb;\n\t#include <opaque_fragment>\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n\t#include <fog_fragment>\n}"},Qr={common:{diffuse:{value:new ls(16777215)},opacity:{value:1},map:{value:null},mapTransform:{value:new bt},alphaMap:{value:null},alphaMapTransform:{value:new bt},alphaTest:{value:0}},specularmap:{specularMap:{value:null},specularMapTransform:{value:new bt}},envmap:{envMap:{value:null},envMapRotation:{value:new bt},flipEnvMap:{value:-1},reflectivity:{value:1},ior:{value:1.5},refractionRatio:{value:.98}},aomap:{aoMap:{value:null},aoMapIntensity:{value:1},aoMapTransform:{value:new bt}},lightmap:{lightMap:{value:null},lightMapIntensity:{value:1},lightMapTransform:{value:new bt}},bumpmap:{bumpMap:{value:null},bumpMapTransform:{value:new bt},bumpScale:{value:1}},normalmap:{normalMap:{value:null},normalMapTransform:{value:new bt},normalScale:{value:new pt(1,1)}},displacementmap:{displacementMap:{value:null},displacementMapTransform:{value:new bt},displacementScale:{value:1},displacementBias:{value:0}},emissivemap:{emissiveMap:{value:null},emissiveMapTransform:{value:new bt}},metalnessmap:{metalnessMap:{value:null},metalnessMapTransform:{value:new bt}},roughnessmap:{roughnessMap:{value:null},roughnessMapTransform:{value:new bt}},gradientmap:{gradientMap:{value:null}},fog:{fogDensity:{value:25e-5},fogNear:{value:1},fogFar:{value:2e3},fogColor:{value:new ls(16777215)}},lights:{ambientLightColor:{value:[]},lightProbe:{value:[]},directionalLights:{value:[],properties:{direction:{},color:{}}},directionalLightShadows:{value:[],properties:{shadowIntensity:1,shadowBias:{},shadowNormalBias:{},shadowRadius:{},shadowMapSize:{}}},directionalShadowMap:{value:[]},directionalShadowMatrix:{value:[]},spotLights:{value:[],properties:{color:{},position:{},direction:{},distance:{},coneCos:{},penumbraCos:{},decay:{}}},spotLightShadows:{value:[],properties:{shadowIntensity:1,shadowBias:{},shadowNormalBias:{},shadowRadius:{},shadowMapSize:{}}},spotLightMap:{value:[]},spotShadowMap:{value:[]},spotLightMatrix:{value:[]},pointLights:{value:[],properties:{color:{},position:{},decay:{},distance:{}}},pointLightShadows:{value:[],properties:{shadowIntensity:1,shadowBias:{},shadowNormalBias:{},shadowRadius:{},shadowMapSize:{},shadowCameraNear:{},shadowCameraFar:{}}},pointShadowMap:{value:[]},pointShadowMatrix:{value:[]},hemisphereLights:{value:[],properties:{direction:{},skyColor:{},groundColor:{}}},rectAreaLights:{value:[],properties:{color:{},position:{},width:{},height:{}}},ltc_1:{value:null},ltc_2:{value:null}},points:{diffuse:{value:new ls(16777215)},opacity:{value:1},size:{value:1},scale:{value:1},map:{value:null},alphaMap:{value:null},alphaMapTransform:{value:new bt},alphaTest:{value:0},uvTransform:{value:new bt}},sprite:{diffuse:{value:new ls(16777215)},opacity:{value:1},center:{value:new pt(.5,.5)},rotation:{value:0},map:{value:null},mapTransform:{value:new bt},alphaMap:{value:null},alphaMapTransform:{value:new bt},alphaTest:{value:0}}},ea={basic:{uniforms:js([Qr.common,Qr.specularmap,Qr.envmap,Qr.aomap,Qr.lightmap,Qr.fog]),vertexShader:Jr.meshbasic_vert,fragmentShader:Jr.meshbasic_frag},lambert:{uniforms:js([Qr.common,Qr.specularmap,Qr.envmap,Qr.aomap,Qr.lightmap,Qr.emissivemap,Qr.bumpmap,Qr.normalmap,Qr.displacementmap,Qr.fog,Qr.lights,{emissive:{value:new ls(0)}}]),vertexShader:Jr.meshlambert_vert,fragmentShader:Jr.meshlambert_frag},phong:{uniforms:js([Qr.common,Qr.specularmap,Qr.envmap,Qr.aomap,Qr.lightmap,Qr.emissivemap,Qr.bumpmap,Qr.normalmap,Qr.displacementmap,Qr.fog,Qr.lights,{emissive:{value:new ls(0)},specular:{value:new ls(1118481)},shininess:{value:30}}]),vertexShader:Jr.meshphong_vert,fragmentShader:Jr.meshphong_frag},standard:{uniforms:js([Qr.common,Qr.envmap,Qr.aomap,Qr.lightmap,Qr.emissivemap,Qr.bumpmap,Qr.normalmap,Qr.displacementmap,Qr.roughnessmap,Qr.metalnessmap,Qr.fog,Qr.lights,{emissive:{value:new ls(0)},roughness:{value:1},metalness:{value:0},envMapIntensity:{value:1}}]),vertexShader:Jr.meshphysical_vert,fragmentShader:Jr.meshphysical_frag},toon:{uniforms:js([Qr.common,Qr.aomap,Qr.lightmap,Qr.emissivemap,Qr.bumpmap,Qr.normalmap,Qr.displacementmap,Qr.gradientmap,Qr.fog,Qr.lights,{emissive:{value:new ls(0)}}]),vertexShader:Jr.meshtoon_vert,fragmentShader:Jr.meshtoon_frag},matcap:{uniforms:js([Qr.common,Qr.bumpmap,Qr.normalmap,Qr.displacementmap,Qr.fog,{matcap:{value:null}}]),vertexShader:Jr.meshmatcap_vert,fragmentShader:Jr.meshmatcap_frag},points:{uniforms:js([Qr.points,Qr.fog]),vertexShader:Jr.points_vert,fragmentShader:Jr.points_frag},dashed:{uniforms:js([Qr.common,Qr.fog,{scale:{value:1},dashSize:{value:1},totalSize:{value:2}}]),vertexShader:Jr.linedashed_vert,fragmentShader:Jr.linedashed_frag},depth:{uniforms:js([Qr.common,Qr.displacementmap]),vertexShader:Jr.depth_vert,fragmentShader:Jr.depth_frag},normal:{uniforms:js([Qr.common,Qr.bumpmap,Qr.normalmap,Qr.displacementmap,{opacity:{value:1}}]),vertexShader:Jr.meshnormal_vert,fragmentShader:Jr.meshnormal_frag},sprite:{uniforms:js([Qr.sprite,Qr.fog]),vertexShader:Jr.sprite_vert,fragmentShader:Jr.sprite_frag},background:{uniforms:{uvTransform:{value:new bt},t2D:{value:null},backgroundIntensity:{value:1}},vertexShader:Jr.background_vert,fragmentShader:Jr.background_frag},backgroundCube:{uniforms:{envMap:{value:null},flipEnvMap:{value:-1},backgroundBlurriness:{value:0},backgroundIntensity:{value:1},backgroundRotation:{value:new bt}},vertexShader:Jr.backgroundCube_vert,fragmentShader:Jr.backgroundCube_frag},cube:{uniforms:{tCube:{value:null},tFlip:{value:-1},opacity:{value:1}},vertexShader:Jr.cube_vert,fragmentShader:Jr.cube_frag},equirect:{uniforms:{tEquirect:{value:null}},vertexShader:Jr.equirect_vert,fragmentShader:Jr.equirect_frag},distanceRGBA:{uniforms:js([Qr.common,Qr.displacementmap,{referencePosition:{value:new mt},nearDistance:{value:1},farDistance:{value:1e3}}]),vertexShader:Jr.distanceRGBA_vert,fragmentShader:Jr.distanceRGBA_frag},shadow:{uniforms:js([Qr.lights,Qr.fog,{color:{value:new ls(0)},opacity:{value:1}}]),vertexShader:Jr.shadow_vert,fragmentShader:Jr.shadow_frag}};ea.physical={uniforms:js([ea.standard.uniforms,{clearcoat:{value:0},clearcoatMap:{value:null},clearcoatMapTransform:{value:new bt},clearcoatNormalMap:{value:null},clearcoatNormalMapTransform:{value:new bt},clearcoatNormalScale:{value:new pt(1,1)},clearcoatRoughness:{value:0},clearcoatRoughnessMap:{value:null},clearcoatRoughnessMapTransform:{value:new bt},dispersion:{value:0},iridescence:{value:0},iridescenceMap:{value:null},iridescenceMapTransform:{value:new bt},iridescenceIOR:{value:1.3},iridescenceThicknessMinimum:{value:100},iridescenceThicknessMaximum:{value:400},iridescenceThicknessMap:{value:null},iridescenceThicknessMapTransform:{value:new bt},sheen:{value:0},sheenColor:{value:new ls(0)},sheenColorMap:{value:null},sheenColorMapTransform:{value:new bt},sheenRoughness:{value:1},sheenRoughnessMap:{value:null},sheenRoughnessMapTransform:{value:new bt},transmission:{value:0},transmissionMap:{value:null},transmissionMapTransform:{value:new bt},transmissionSamplerSize:{value:new pt},transmissionSamplerMap:{value:null},thickness:{value:0},thicknessMap:{value:null},thicknessMapTransform:{value:new bt},attenuationDistance:{value:0},attenuationColor:{value:new ls(0)},specularColor:{value:new ls(1,1,1)},specularColorMap:{value:null},specularColorMapTransform:{value:new bt},specularIntensity:{value:1},specularIntensityMap:{value:null},specularIntensityMapTransform:{value:new bt},anisotropyVector:{value:new pt},anisotropyMap:{value:null},anisotropyMapTransform:{value:new bt}}]),vertexShader:Jr.meshphysical_vert,fragmentShader:Jr.meshphysical_frag};const ta={r:0,b:0,g:0},ia=new Mi,sa=new gi;function na(e,t,i,s,n,r,a){const o=new ls(0);let l,d,c=!0===r?0:1,h=null,p=0,u=null;function m(e){let s=!0===e.isScene?e.background:null;if(s&&s.isTexture){s=(e.backgroundBlurriness>0?i:t).get(s)}return s}function f(t,i){t.getRGB(ta,Gs(e)),s.buffers.color.setClear(ta.r,ta.g,ta.b,i,a)}return{getClearColor:function(){return o},setClearColor:function(e,t=1){o.set(e),c=t,f(o,c)},getClearAlpha:function(){return c},setClearAlpha:function(e){c=e,f(o,c)},render:function(t){let i=!1;const n=m(t);null===n?f(o,c):n&&n.isColor&&(f(n,1),i=!0);const r=e.xr.getEnvironmentBlendMode();"additive"===r?s.buffers.color.setClear(0,0,0,1,a):"alpha-blend"===r&&s.buffers.color.setClear(0,0,0,0,a),(e.autoClear||i)&&(s.buffers.depth.setTest(!0),s.buffers.depth.setMask(!0),s.buffers.color.setMask(!0),e.clear(e.autoClearColor,e.autoClearDepth,e.autoClearStencil))},addToRenderList:function(t,i){const s=m(i);s&&(s.isCubeTexture||s.mapping===P)?(void 0===d&&(d=new Hs(new zs(1,1,1),new Vs({name:"BackgroundCubeMaterial",uniforms:qs(ea.backgroundCube.uniforms),vertexShader:ea.backgroundCube.vertexShader,fragmentShader:ea.backgroundCube.fragmentShader,side:1,depthTest:!1,depthWrite:!1,fog:!1,allowOverride:!1})),d.geometry.deleteAttribute("normal"),d.geometry.deleteAttribute("uv"),d.onBeforeRender=function(e,t,i){this.matrixWorld.copyPosition(i.matrixWorld)},Object.defineProperty(d.material,"envMap",{get:function(){return this.uniforms.envMap.value}}),n.update(d)),ia.copy(i.backgroundRotation),ia.x*=-1,ia.y*=-1,ia.z*=-1,s.isCubeTexture&&!1===s.isRenderTargetTexture&&(ia.y*=-1,ia.z*=-1),d.material.uniforms.envMap.value=s,d.material.uniforms.flipEnvMap.value=s.isCubeTexture&&!1===s.isRenderTargetTexture?-1:1,d.material.uniforms.backgroundBlurriness.value=i.backgroundBlurriness,d.material.uniforms.backgroundIntensity.value=i.backgroundIntensity,d.material.uniforms.backgroundRotation.value.setFromMatrix4(sa.makeRotationFromEuler(ia)),d.material.toneMapped=Tt.getTransfer(s.colorSpace)!==je,h===s&&p===s.version&&u===e.toneMapping||(d.material.needsUpdate=!0,h=s,p=s.version,u=e.toneMapping),d.layers.enableAll(),t.unshift(d,d.geometry,d.material,0,0,null)):s&&s.isTexture&&(void 0===l&&(l=new Hs(new pr(2,2),new Vs({name:"BackgroundMaterial",uniforms:qs(ea.background.uniforms),vertexShader:ea.background.vertexShader,fragmentShader:ea.background.fragmentShader,side:0,depthTest:!1,depthWrite:!1,fog:!1,allowOverride:!1})),l.geometry.deleteAttribute("normal"),Object.defineProperty(l.material,"map",{get:function(){return this.uniforms.t2D.value}}),n.update(l)),l.material.uniforms.t2D.value=s,l.material.uniforms.backgroundIntensity.value=i.backgroundIntensity,l.material.toneMapped=Tt.getTransfer(s.colorSpace)!==je,!0===s.matrixAutoUpdate&&s.updateMatrix(),l.material.uniforms.uvTransform.value.copy(s.matrix),h===s&&p===s.version&&u===e.toneMapping||(l.material.needsUpdate=!0,h=s,p=s.version,u=e.toneMapping),l.layers.enableAll(),t.unshift(l,l.geometry,l.material,0,0,null))},dispose:function(){void 0!==d&&(d.geometry.dispose(),d.material.dispose(),d=void 0),void 0!==l&&(l.geometry.dispose(),l.material.dispose(),l=void 0)}}}function ra(e,t){const i=e.getParameter(e.MAX_VERTEX_ATTRIBS),s={},n=d(null);let r=n,a=!1;function o(t){return e.bindVertexArray(t)}function l(t){return e.deleteVertexArray(t)}function d(e){const t=[],s=[],n=[];for(let e=0;e<i;e++)t[e]=0,s[e]=0,n[e]=0;return{geometry:null,program:null,wireframe:!1,newAttributes:t,enabledAttributes:s,attributeDivisors:n,object:e,attributes:{},index:null}}function c(){const e=r.newAttributes;for(let t=0,i=e.length;t<i;t++)e[t]=0}function h(e){p(e,0)}function p(t,i){const s=r.newAttributes,n=r.enabledAttributes,a=r.attributeDivisors;s[t]=1,0===n[t]&&(e.enableVertexAttribArray(t),n[t]=1),a[t]!==i&&(e.vertexAttribDivisor(t,i),a[t]=i)}function u(){const t=r.newAttributes,i=r.enabledAttributes;for(let s=0,n=i.length;s<n;s++)i[s]!==t[s]&&(e.disableVertexAttribArray(s),i[s]=0)}function m(t,i,s,n,r,a,o){!0===o?e.vertexAttribIPointer(t,i,s,r,a):e.vertexAttribPointer(t,i,s,n,r,a)}function f(){g(),a=!0,r!==n&&(r=n,o(r.object))}function g(){n.geometry=null,n.program=null,n.wireframe=!1}return{setup:function(i,n,l,f,g){let b=!1;const C=function(t,i,n){const r=!0===n.wireframe;let a=s[t.id];void 0===a&&(a={},s[t.id]=a);let o=a[i.id];void 0===o&&(o={},a[i.id]=o);let l=o[r];void 0===l&&(l=d(e.createVertexArray()),o[r]=l);return l}(f,l,n);r!==C&&(r=C,o(r.object)),b=function(e,t,i,s){const n=r.attributes,a=t.attributes;let o=0;const l=i.getAttributes();for(const t in l){if(l[t].location>=0){const i=n[t];let s=a[t];if(void 0===s&&("instanceMatrix"===t&&e.instanceMatrix&&(s=e.instanceMatrix),"instanceColor"===t&&e.instanceColor&&(s=e.instanceColor)),void 0===i)return!0;if(i.attribute!==s)return!0;if(s&&i.data!==s.data)return!0;o++}}return r.attributesNum!==o||r.index!==s}(i,f,l,g),b&&function(e,t,i,s){const n={},a=t.attributes;let o=0;const l=i.getAttributes();for(const t in l){if(l[t].location>=0){let i=a[t];void 0===i&&("instanceMatrix"===t&&e.instanceMatrix&&(i=e.instanceMatrix),"instanceColor"===t&&e.instanceColor&&(i=e.instanceColor));const s={};s.attribute=i,i&&i.data&&(s.data=i.data),n[t]=s,o++}}r.attributes=n,r.attributesNum=o,r.index=s}(i,f,l,g),null!==g&&t.update(g,e.ELEMENT_ARRAY_BUFFER),(b||a)&&(a=!1,function(i,s,n,r){c();const a=r.attributes,o=n.getAttributes(),l=s.defaultAttributeValues;for(const s in o){const n=o[s];if(n.location>=0){let o=a[s];if(void 0===o&&("instanceMatrix"===s&&i.instanceMatrix&&(o=i.instanceMatrix),"instanceColor"===s&&i.instanceColor&&(o=i.instanceColor)),void 0!==o){const s=o.normalized,a=o.itemSize,l=t.get(o);if(void 0===l)continue;const d=l.buffer,c=l.type,u=l.bytesPerElement,f=c===e.INT||c===e.UNSIGNED_INT||o.gpuType===X;if(o.isInterleavedBufferAttribute){const t=o.data,l=t.stride,g=o.offset;if(t.isInstancedInterleavedBuffer){for(let e=0;e<n.locationSize;e++)p(n.location+e,t.meshPerAttribute);!0!==i.isInstancedMesh&&void 0===r._maxInstanceCount&&(r._maxInstanceCount=t.meshPerAttribute*t.count)}else for(let e=0;e<n.locationSize;e++)h(n.location+e);e.bindBuffer(e.ARRAY_BUFFER,d);for(let e=0;e<n.locationSize;e++)m(n.location+e,a/n.locationSize,c,s,l*u,(g+a/n.locationSize*e)*u,f)}else{if(o.isInstancedBufferAttribute){for(let e=0;e<n.locationSize;e++)p(n.location+e,o.meshPerAttribute);!0!==i.isInstancedMesh&&void 0===r._maxInstanceCount&&(r._maxInstanceCount=o.meshPerAttribute*o.count)}else for(let e=0;e<n.locationSize;e++)h(n.location+e);e.bindBuffer(e.ARRAY_BUFFER,d);for(let e=0;e<n.locationSize;e++)m(n.location+e,a/n.locationSize,c,s,a*u,a/n.locationSize*e*u,f)}}else if(void 0!==l){const t=l[s];if(void 0!==t)switch(t.length){case 2:e.vertexAttrib2fv(n.location,t);break;case 3:e.vertexAttrib3fv(n.location,t);break;case 4:e.vertexAttrib4fv(n.location,t);break;default:e.vertexAttrib1fv(n.location,t)}}}}u()}(i,n,l,f),null!==g&&e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,t.get(g).buffer))},reset:f,resetDefaultState:g,dispose:function(){f();for(const e in s){const t=s[e];for(const e in t){const i=t[e];for(const e in i)l(i[e].object),delete i[e];delete t[e]}delete s[e]}},releaseStatesOfGeometry:function(e){if(void 0===s[e.id])return;const t=s[e.id];for(const e in t){const i=t[e];for(const e in i)l(i[e].object),delete i[e];delete t[e]}delete s[e.id]},releaseStatesOfProgram:function(e){for(const t in s){const i=s[t];if(void 0===i[e.id])continue;const n=i[e.id];for(const e in n)l(n[e].object),delete n[e];delete i[e.id]}},initAttributes:c,enableAttribute:h,disableUnusedAttributes:u}}function aa(e,t,i){let s;function n(t,n,r){0!==r&&(e.drawArraysInstanced(s,t,n,r),i.update(n,s,r))}this.setMode=function(e){s=e},this.render=function(t,n){e.drawArrays(s,t,n),i.update(n,s,1)},this.renderInstances=n,this.renderMultiDraw=function(e,n,r){if(0===r)return;t.get("WEBGL_multi_draw").multiDrawArraysWEBGL(s,e,0,n,0,r);let a=0;for(let e=0;e<r;e++)a+=n[e];i.update(a,s,1)},this.renderMultiDrawInstances=function(e,r,a,o){if(0===a)return;const l=t.get("WEBGL_multi_draw");if(null===l)for(let t=0;t<e.length;t++)n(e[t],r[t],o[t]);else{l.multiDrawArraysInstancedWEBGL(s,e,0,r,0,o,0,a);let t=0;for(let e=0;e<a;e++)t+=r[e]*o[e];i.update(t,s,1)}}}function oa(e,t,i,s){let n;function r(t){if("highp"===t){if(e.getShaderPrecisionFormat(e.VERTEX_SHADER,e.HIGH_FLOAT).precision>0&&e.getShaderPrecisionFormat(e.FRAGMENT_SHADER,e.HIGH_FLOAT).precision>0)return"highp";t="mediump"}return"mediump"===t&&e.getShaderPrecisionFormat(e.VERTEX_SHADER,e.MEDIUM_FLOAT).precision>0&&e.getShaderPrecisionFormat(e.FRAGMENT_SHADER,e.MEDIUM_FLOAT).precision>0?"mediump":"lowp"}let a=void 0!==i.precision?i.precision:"highp";const o=r(a);o!==a&&(console.warn("THREE.WebGLRenderer:",a,"not supported, using",o,"instead."),a=o);const l=!0===i.logarithmicDepthBuffer,d=!0===i.reverseDepthBuffer&&t.has("EXT_clip_control"),c=e.getParameter(e.MAX_TEXTURE_IMAGE_UNITS),h=e.getParameter(e.MAX_VERTEX_TEXTURE_IMAGE_UNITS);return{isWebGL2:!0,getMaxAnisotropy:function(){if(void 0!==n)return n;if(!0===t.has("EXT_texture_filter_anisotropic")){const i=t.get("EXT_texture_filter_anisotropic");n=e.getParameter(i.MAX_TEXTURE_MAX_ANISOTROPY_EXT)}else n=0;return n},getMaxPrecision:r,textureFormatReadable:function(t){return t===ie||s.convert(t)===e.getParameter(e.IMPLEMENTATION_COLOR_READ_FORMAT)},textureTypeReadable:function(i){const n=i===Z&&(t.has("EXT_color_buffer_half_float")||t.has("EXT_color_buffer_float"));return!(i!==j&&s.convert(i)!==e.getParameter(e.IMPLEMENTATION_COLOR_READ_TYPE)&&i!==K&&!n)},precision:a,logarithmicDepthBuffer:l,reverseDepthBuffer:d,maxTextures:c,maxVertexTextures:h,maxTextureSize:e.getParameter(e.MAX_TEXTURE_SIZE),maxCubemapSize:e.getParameter(e.MAX_CUBE_MAP_TEXTURE_SIZE),maxAttributes:e.getParameter(e.MAX_VERTEX_ATTRIBS),maxVertexUniforms:e.getParameter(e.MAX_VERTEX_UNIFORM_VECTORS),maxVaryings:e.getParameter(e.MAX_VARYING_VECTORS),maxFragmentUniforms:e.getParameter(e.MAX_FRAGMENT_UNIFORM_VECTORS),vertexTextures:h>0,maxSamples:e.getParameter(e.MAX_SAMPLES)}}function la(e){const t=this;let i=null,s=0,n=!1,r=!1;const a=new On,o=new bt,l={value:null,needsUpdate:!1};function d(e,i,s,n){const r=null!==e?e.length:0;let d=null;if(0!==r){if(d=l.value,!0!==n||null===d){const t=s+4*r,n=i.matrixWorldInverse;o.getNormalMatrix(n),(null===d||d.length<t)&&(d=new Float32Array(t));for(let t=0,i=s;t!==r;++t,i+=4)a.copy(e[t]).applyMatrix4(n,o),a.normal.toArray(d,i),d[i+3]=a.constant}l.value=d,l.needsUpdate=!0}return t.numPlanes=r,t.numIntersection=0,d}this.uniform=l,this.numPlanes=0,this.numIntersection=0,this.init=function(e,t){const i=0!==e.length||t||0!==s||n;return n=t,s=e.length,i},this.beginShadows=function(){r=!0,d(null)},this.endShadows=function(){r=!1},this.setGlobalState=function(e,t){i=d(e,t,0)},this.setState=function(a,o,c){const h=a.clippingPlanes,p=a.clipIntersection,u=a.clipShadows,m=e.get(a);if(!n||null===h||0===h.length||r&&!u)r?d(null):function(){l.value!==i&&(l.value=i,l.needsUpdate=s>0);t.numPlanes=s,t.numIntersection=0}();else{const e=r?0:s,t=4*e;let n=m.clippingState||null;l.value=n,n=d(h,o,t,c);for(let e=0;e!==t;++e)n[e]=i[e];m.clippingState=n,this.numIntersection=p?this.numPlanes:0,this.numPlanes+=e}}}function da(e){let t=new WeakMap;function i(e,t){return 303===t?e.mapping=O:304===t&&(e.mapping=I),e}function s(e){const i=e.target;i.removeEventListener("dispose",s);const n=t.get(i);void 0!==n&&(t.delete(i),n.dispose())}return{get:function(n){if(n&&n.isTexture){const r=n.mapping;if(303===r||304===r){if(t.has(n)){return i(t.get(n).texture,n.mapping)}{const r=n.image;if(r&&r.height>0){const a=new tn(r.height);return a.fromEquirectangularTexture(e,n),t.set(n,a),n.addEventListener("dispose",s),i(a.texture,n.mapping)}return null}}}return n},dispose:function(){t=new WeakMap}}}const ca=[.125,.215,.35,.446,.526,.582],ha=20,pa=new Pr,ua=new ls;let ma=null,fa=0,ga=0,ba=!1;const Ca=(1+Math.sqrt(5))/2,va=1/Ca,_a=[new mt(-Ca,va,0),new mt(Ca,va,0),new mt(-va,0,Ca),new mt(va,0,Ca),new mt(0,Ca,-va),new mt(0,Ca,va),new mt(-1,1,-1),new mt(1,1,-1),new mt(-1,1,1),new mt(1,1,1)],ya=new mt;class Sa{constructor(e){this._renderer=e,this._pingPongRenderTarget=null,this._lodMax=0,this._cubeSize=0,this._lodPlanes=[],this._sizeLods=[],this._sigmas=[],this._blurMaterial=null,this._cubemapMaterial=null,this._equirectMaterial=null,this._compileMaterial(this._blurMaterial)}fromScene(e,t=0,i=.1,s=100,n={}){const{size:r=256,position:a=ya}=n;ma=this._renderer.getRenderTarget(),fa=this._renderer.getActiveCubeFace(),ga=this._renderer.getActiveMipmapLevel(),ba=this._renderer.xr.enabled,this._renderer.xr.enabled=!1,this._setSize(r);const o=this._allocateTargets();return o.depthBuffer=!0,this._sceneToCubeUV(e,i,s,o,a),t>0&&this._blur(o,0,0,t),this._applyPMREM(o),this._cleanup(o),o}fromEquirectangular(e,t=null){return this._fromTexture(e,t)}fromCubemap(e,t=null){return this._fromTexture(e,t)}compileCubemapShader(){null===this._cubemapMaterial&&(this._cubemapMaterial=Ma(),this._compileMaterial(this._cubemapMaterial))}compileEquirectangularShader(){null===this._equirectMaterial&&(this._equirectMaterial=Aa(),this._compileMaterial(this._equirectMaterial))}dispose(){this._dispose(),null!==this._cubemapMaterial&&this._cubemapMaterial.dispose(),null!==this._equirectMaterial&&this._equirectMaterial.dispose()}_setSize(e){this._lodMax=Math.floor(Math.log2(e)),this._cubeSize=Math.pow(2,this._lodMax)}_dispose(){null!==this._blurMaterial&&this._blurMaterial.dispose(),null!==this._pingPongRenderTarget&&this._pingPongRenderTarget.dispose();for(let e=0;e<this._lodPlanes.length;e++)this._lodPlanes[e].dispose()}_cleanup(e){this._renderer.setRenderTarget(ma,fa,ga),this._renderer.xr.enabled=ba,e.scissorTest=!1,xa(e,0,0,e.width,e.height)}_fromTexture(e,t){e.mapping===O||e.mapping===I?this._setSize(0===e.image.length?16:e.image[0].width||e.image[0].image.width):this._setSize(e.image.width/4),ma=this._renderer.getRenderTarget(),fa=this._renderer.getActiveCubeFace(),ga=this._renderer.getActiveMipmapLevel(),ba=this._renderer.xr.enabled,this._renderer.xr.enabled=!1;const i=t||this._allocateTargets();return this._textureToCubeUV(e,i),this._applyPMREM(i),this._cleanup(i),i}_allocateTargets(){const e=3*Math.max(this._cubeSize,112),t=4*this._cubeSize,i={magFilter:B,minFilter:B,generateMipmaps:!1,type:Z,format:ie,colorSpace:ze,depthBuffer:!1},s=wa(e,t,i);if(null===this._pingPongRenderTarget||this._pingPongRenderTarget.width!==e||this._pingPongRenderTarget.height!==t){null!==this._pingPongRenderTarget&&this._dispose(),this._pingPongRenderTarget=wa(e,t,i);const{_lodMax:s}=this;({sizeLods:this._sizeLods,lodPlanes:this._lodPlanes,sigmas:this._sigmas}=function(e){const t=[],i=[],s=[];let n=e;const r=e-4+1+ca.length;for(let a=0;a<r;a++){const r=Math.pow(2,n);i.push(r);let o=1/r;a>e-4?o=ca[a-e+4-1]:0===a&&(o=0),s.push(o);const l=1/(r-2),d=-l,c=1+l,h=[d,d,c,d,c,c,d,d,c,c,d,c],p=6,u=6,m=3,f=2,g=1,b=new Float32Array(m*u*p),C=new Float32Array(f*u*p),v=new Float32Array(g*u*p);for(let e=0;e<p;e++){const t=e%3*2/3-1,i=e>2?0:-1,s=[t,i,0,t+2/3,i,0,t+2/3,i+1,0,t,i,0,t+2/3,i+1,0,t,i+1,0];b.set(s,m*u*e),C.set(h,f*u*e);const n=[e,e,e,e,e,e];v.set(n,g*u*e)}const _=new Ts;_.setAttribute("position",new gs(b,m)),_.setAttribute("uv",new gs(C,f)),_.setAttribute("faceIndex",new gs(v,g)),t.push(_),n>4&&n--}return{lodPlanes:t,sizeLods:i,sigmas:s}}(s)),this._blurMaterial=function(e,t,i){const s=new Float32Array(ha),n=new mt(0,1,0),r=new Vs({name:"SphericalGaussianBlur",defines:{n:ha,CUBEUV_TEXEL_WIDTH:1/t,CUBEUV_TEXEL_HEIGHT:1/i,CUBEUV_MAX_MIP:`${e}.0`},uniforms:{envMap:{value:null},samples:{value:1},weights:{value:s},latitudinal:{value:!1},dTheta:{value:0},mipInt:{value:0},poleAxis:{value:n}},vertexShader:Ta(),fragmentShader:"\n\n\t\t\tprecision mediump float;\n\t\t\tprecision mediump int;\n\n\t\t\tvarying vec3 vOutputDirection;\n\n\t\t\tuniform sampler2D envMap;\n\t\t\tuniform int samples;\n\t\t\tuniform float weights[ n ];\n\t\t\tuniform bool latitudinal;\n\t\t\tuniform float dTheta;\n\t\t\tuniform float mipInt;\n\t\t\tuniform vec3 poleAxis;\n\n\t\t\t#define ENVMAP_TYPE_CUBE_UV\n\t\t\t#include <cube_uv_reflection_fragment>\n\n\t\t\tvec3 getSample( float theta, vec3 axis ) {\n\n\t\t\t\tfloat cosTheta = cos( theta );\n\t\t\t\t// Rodrigues' axis-angle rotation\n\t\t\t\tvec3 sampleDirection = vOutputDirection * cosTheta\n\t\t\t\t\t+ cross( axis, vOutputDirection ) * sin( theta )\n\t\t\t\t\t+ axis * dot( axis, vOutputDirection ) * ( 1.0 - cosTheta );\n\n\t\t\t\treturn bilinearCubeUV( envMap, sampleDirection, mipInt );\n\n\t\t\t}\n\n\t\t\tvoid main() {\n\n\t\t\t\tvec3 axis = latitudinal ? poleAxis : cross( poleAxis, vOutputDirection );\n\n\t\t\t\tif ( all( equal( axis, vec3( 0.0 ) ) ) ) {\n\n\t\t\t\t\taxis = vec3( vOutputDirection.z, 0.0, - vOutputDirection.x );\n\n\t\t\t\t}\n\n\t\t\t\taxis = normalize( axis );\n\n\t\t\t\tgl_FragColor = vec4( 0.0, 0.0, 0.0, 1.0 );\n\t\t\t\tgl_FragColor.rgb += weights[ 0 ] * getSample( 0.0, axis );\n\n\t\t\t\tfor ( int i = 1; i < n; i++ ) {\n\n\t\t\t\t\tif ( i >= samples ) {\n\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t\t}\n\n\t\t\t\t\tfloat theta = dTheta * float( i );\n\t\t\t\t\tgl_FragColor.rgb += weights[ i ] * getSample( -1.0 * theta, axis );\n\t\t\t\t\tgl_FragColor.rgb += weights[ i ] * getSample( theta, axis );\n\n\t\t\t\t}\n\n\t\t\t}\n\t\t",blending:0,depthTest:!1,depthWrite:!1});return r}(s,e,t)}return s}_compileMaterial(e){const t=new Hs(this._lodPlanes[0],e);this._renderer.compile(t,pa)}_sceneToCubeUV(e,t,i,s,n){const r=new Zs(90,1,t,i),a=[1,-1,1,1,1,1],o=[1,1,1,-1,-1,-1],l=this._renderer,d=l.autoClear,c=l.toneMapping;l.getClearColor(ua),l.toneMapping=0,l.autoClear=!1;const h=new ps({name:"PMREM.Background",side:1,depthWrite:!1,depthTest:!1}),p=new Hs(new zs,h);let u=!1;const m=e.background;m?m.isColor&&(h.color.copy(m),e.background=null,u=!0):(h.color.copy(ua),u=!0);for(let t=0;t<6;t++){const i=t%3;0===i?(r.up.set(0,a[t],0),r.position.set(n.x,n.y,n.z),r.lookAt(n.x+o[t],n.y,n.z)):1===i?(r.up.set(0,0,a[t]),r.position.set(n.x,n.y,n.z),r.lookAt(n.x,n.y+o[t],n.z)):(r.up.set(0,a[t],0),r.position.set(n.x,n.y,n.z),r.lookAt(n.x,n.y,n.z+o[t]));const d=this._cubeSize;xa(s,i*d,t>2?d:0,d,d),l.setRenderTarget(s),u&&l.render(p,r),l.render(e,r)}p.geometry.dispose(),p.material.dispose(),l.toneMapping=c,l.autoClear=d,e.background=m}_textureToCubeUV(e,t){const i=this._renderer,s=e.mapping===O||e.mapping===I;s?(null===this._cubemapMaterial&&(this._cubemapMaterial=Ma()),this._cubemapMaterial.uniforms.flipEnvMap.value=!1===e.isRenderTargetTexture?-1:1):null===this._equirectMaterial&&(this._equirectMaterial=Aa());const n=s?this._cubemapMaterial:this._equirectMaterial,r=new Hs(this._lodPlanes[0],n);n.uniforms.envMap.value=e;const a=this._cubeSize;xa(t,0,0,3*a,2*a),i.setRenderTarget(t),i.render(r,pa)}_applyPMREM(e){const t=this._renderer,i=t.autoClear;t.autoClear=!1;const s=this._lodPlanes.length;for(let t=1;t<s;t++){const i=Math.sqrt(this._sigmas[t]*this._sigmas[t]-this._sigmas[t-1]*this._sigmas[t-1]),n=_a[(s-t-1)%_a.length];this._blur(e,t-1,t,i,n)}t.autoClear=i}_blur(e,t,i,s,n){const r=this._pingPongRenderTarget;this._halfBlur(e,r,t,i,s,"latitudinal",n),this._halfBlur(r,e,i,i,s,"longitudinal",n)}_halfBlur(e,t,i,s,n,r,a){const o=this._renderer,l=this._blurMaterial;"latitudinal"!==r&&"longitudinal"!==r&&console.error("blur direction must be either latitudinal or longitudinal!");const d=new Hs(this._lodPlanes[s],l),c=l.uniforms,h=this._sizeLods[i]-1,p=isFinite(n)?Math.PI/(2*h):2*Math.PI/39,u=n/p,m=isFinite(n)?1+Math.floor(3*u):ha;m>ha&&console.warn(`sigmaRadians, ${n}, is too large and will clip, as it requested ${m} samples when the maximum is set to 20`);const f=[];let g=0;for(let e=0;e<ha;++e){const t=e/u,i=Math.exp(-t*t/2);f.push(i),0===e?g+=i:e<m&&(g+=2*i)}for(let e=0;e<f.length;e++)f[e]=f[e]/g;c.envMap.value=e.texture,c.samples.value=m,c.weights.value=f,c.latitudinal.value="latitudinal"===r,a&&(c.poleAxis.value=a);const{_lodMax:b}=this;c.dTheta.value=p,c.mipInt.value=b-i;const C=this._sizeLods[s];xa(t,3*C*(s>b-4?s-b+4:0),4*(this._cubeSize-C),3*C,2*C),o.setRenderTarget(t),o.render(d,pa)}}function wa(e,t,i){const s=new Bt(e,t,i);return s.texture.mapping=P,s.texture.name="PMREM.cubeUv",s.scissorTest=!0,s}function xa(e,t,i,s,n){e.viewport.set(t,i,s,n),e.scissor.set(t,i,s,n)}function Aa(){return new Vs({name:"EquirectangularToCubeUV",uniforms:{envMap:{value:null}},vertexShader:Ta(),fragmentShader:"\n\n\t\t\tprecision mediump float;\n\t\t\tprecision mediump int;\n\n\t\t\tvarying vec3 vOutputDirection;\n\n\t\t\tuniform sampler2D envMap;\n\n\t\t\t#include <common>\n\n\t\t\tvoid main() {\n\n\t\t\t\tvec3 outputDirection = normalize( vOutputDirection );\n\t\t\t\tvec2 uv = equirectUv( outputDirection );\n\n\t\t\t\tgl_FragColor = vec4( texture2D ( envMap, uv ).rgb, 1.0 );\n\n\t\t\t}\n\t\t",blending:0,depthTest:!1,depthWrite:!1})}function Ma(){return new Vs({name:"CubemapToCubeUV",uniforms:{envMap:{value:null},flipEnvMap:{value:-1}},vertexShader:Ta(),fragmentShader:"\n\n\t\t\tprecision mediump float;\n\t\t\tprecision mediump int;\n\n\t\t\tuniform float flipEnvMap;\n\n\t\t\tvarying vec3 vOutputDirection;\n\n\t\t\tuniform samplerCube envMap;\n\n\t\t\tvoid main() {\n\n\t\t\t\tgl_FragColor = textureCube( envMap, vec3( flipEnvMap * vOutputDirection.x, vOutputDirection.yz ) );\n\n\t\t\t}\n\t\t",blending:0,depthTest:!1,depthWrite:!1})}function Ta(){return"\n\n\t\tprecision mediump float;\n\t\tprecision mediump int;\n\n\t\tattribute float faceIndex;\n\n\t\tvarying vec3 vOutputDirection;\n\n\t\t// RH coordinate system; PMREM face-indexing convention\n\t\tvec3 getDirection( vec2 uv, float face ) {\n\n\t\t\tuv = 2.0 * uv - 1.0;\n\n\t\t\tvec3 direction = vec3( uv, 1.0 );\n\n\t\t\tif ( face == 0.0 ) {\n\n\t\t\t\tdirection = direction.zyx; // ( 1, v, u ) pos x\n\n\t\t\t} else if ( face == 1.0 ) {\n\n\t\t\t\tdirection = direction.xzy;\n\t\t\t\tdirection.xz *= -1.0; // ( -u, 1, -v ) pos y\n\n\t\t\t} else if ( face == 2.0 ) {\n\n\t\t\t\tdirection.x *= -1.0; // ( -u, v, 1 ) pos z\n\n\t\t\t} else if ( face == 3.0 ) {\n\n\t\t\t\tdirection = direction.zyx;\n\t\t\t\tdirection.xz *= -1.0; // ( -1, v, -u ) neg x\n\n\t\t\t} else if ( face == 4.0 ) {\n\n\t\t\t\tdirection = direction.xzy;\n\t\t\t\tdirection.xy *= -1.0; // ( -u, -1, v ) neg y\n\n\t\t\t} else if ( face == 5.0 ) {\n\n\t\t\t\tdirection.z *= -1.0; // ( u, v, -1 ) neg z\n\n\t\t\t}\n\n\t\t\treturn direction;\n\n\t\t}\n\n\t\tvoid main() {\n\n\t\t\tvOutputDirection = getDirection( uv, faceIndex );\n\t\t\tgl_Position = vec4( position, 1.0 );\n\n\t\t}\n\t"}function Ea(e){let t=new WeakMap,i=null;function s(e){const i=e.target;i.removeEventListener("dispose",s);const n=t.get(i);void 0!==n&&(t.delete(i),n.dispose())}return{get:function(n){if(n&&n.isTexture){const r=n.mapping,a=303===r||304===r,o=r===O||r===I;if(a||o){let r=t.get(n);const l=void 0!==r?r.texture.pmremVersion:0;if(n.isRenderTargetTexture&&n.pmremVersion!==l)return null===i&&(i=new Sa(e)),r=a?i.fromEquirectangular(n,r):i.fromCubemap(n,r),r.texture.pmremVersion=n.pmremVersion,t.set(n,r),r.texture;if(void 0!==r)return r.texture;{const l=n.image;return a&&l&&l.height>0||o&&l&&function(e){let t=0;const i=6;for(let s=0;s<i;s++)void 0!==e[s]&&t++;return t===i}(l)?(null===i&&(i=new Sa(e)),r=a?i.fromEquirectangular(n):i.fromCubemap(n),r.texture.pmremVersion=n.pmremVersion,t.set(n,r),n.addEventListener("dispose",s),r.texture):null}}}return n},dispose:function(){t=new WeakMap,null!==i&&(i.dispose(),i=null)}}}function Ra(e){const t={};function i(i){if(void 0!==t[i])return t[i];let s;switch(i){case"WEBGL_depth_texture":s=e.getExtension("WEBGL_depth_texture")||e.getExtension("MOZ_WEBGL_depth_texture")||e.getExtension("WEBKIT_WEBGL_depth_texture");break;case"EXT_texture_filter_anisotropic":s=e.getExtension("EXT_texture_filter_anisotropic")||e.getExtension("MOZ_EXT_texture_filter_anisotropic")||e.getExtension("WEBKIT_EXT_texture_filter_anisotropic");break;case"WEBGL_compressed_texture_s3tc":s=e.getExtension("WEBGL_compressed_texture_s3tc")||e.getExtension("MOZ_WEBGL_compressed_texture_s3tc")||e.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc");break;case"WEBGL_compressed_texture_pvrtc":s=e.getExtension("WEBGL_compressed_texture_pvrtc")||e.getExtension("WEBKIT_WEBGL_compressed_texture_pvrtc");break;default:s=e.getExtension(i)}return t[i]=s,s}return{has:function(e){return null!==i(e)},init:function(){i("EXT_color_buffer_float"),i("WEBGL_clip_cull_distance"),i("OES_texture_float_linear"),i("EXT_color_buffer_half_float"),i("WEBGL_multisampled_render_to_texture"),i("WEBGL_render_shared_exponent")},get:function(e){const t=i(e);return null===t&&wt("THREE.WebGLRenderer: "+e+" extension not supported."),t}}}function ka(e,t,i,s){const n={},r=new WeakMap;function a(e){const o=e.target;null!==o.index&&t.remove(o.index);for(const e in o.attributes)t.remove(o.attributes[e]);o.removeEventListener("dispose",a),delete n[o.id];const l=r.get(o);l&&(t.remove(l),r.delete(o)),s.releaseStatesOfGeometry(o),!0===o.isInstancedBufferGeometry&&delete o._maxInstanceCount,i.memory.geometries--}function o(e){const i=[],s=e.index,n=e.attributes.position;let a=0;if(null!==s){const e=s.array;a=s.version;for(let t=0,s=e.length;t<s;t+=3){const s=e[t+0],n=e[t+1],r=e[t+2];i.push(s,n,n,r,r,s)}}else{if(void 0===n)return;{const e=n.array;a=n.version;for(let t=0,s=e.length/3-1;t<s;t+=3){const e=t+0,s=t+1,n=t+2;i.push(e,s,s,n,n,e)}}}const o=new(vt(i)?Cs:bs)(i,1);o.version=a;const l=r.get(e);l&&t.remove(l),r.set(e,o)}return{get:function(e,t){return!0===n[t.id]||(t.addEventListener("dispose",a),n[t.id]=!0,i.memory.geometries++),t},update:function(i){const s=i.attributes;for(const i in s)t.update(s[i],e.ARRAY_BUFFER)},getWireframeAttribute:function(e){const t=r.get(e);if(t){const i=e.index;null!==i&&t.version<i.version&&o(e)}else o(e);return r.get(e)}}}function Oa(e,t,i){let s,n,r;function a(t,a,o){0!==o&&(e.drawElementsInstanced(s,a,n,t*r,o),i.update(a,s,o))}this.setMode=function(e){s=e},this.setIndex=function(e){n=e.type,r=e.bytesPerElement},this.render=function(t,a){e.drawElements(s,a,n,t*r),i.update(a,s,1)},this.renderInstances=a,this.renderMultiDraw=function(e,r,a){if(0===a)return;t.get("WEBGL_multi_draw").multiDrawElementsWEBGL(s,r,0,n,e,0,a);let o=0;for(let e=0;e<a;e++)o+=r[e];i.update(o,s,1)},this.renderMultiDrawInstances=function(e,o,l,d){if(0===l)return;const c=t.get("WEBGL_multi_draw");if(null===c)for(let t=0;t<e.length;t++)a(e[t]/r,o[t],d[t]);else{c.multiDrawElementsInstancedWEBGL(s,o,0,n,e,0,d,0,l);let t=0;for(let e=0;e<l;e++)t+=o[e]*d[e];i.update(t,s,1)}}}function Ia(e){const t={frame:0,calls:0,triangles:0,points:0,lines:0};return{memory:{geometries:0,textures:0},render:t,programs:null,autoReset:!0,reset:function(){t.calls=0,t.triangles=0,t.points=0,t.lines=0},update:function(i,s,n){switch(t.calls++,s){case e.TRIANGLES:t.triangles+=n*(i/3);break;case e.LINES:t.lines+=n*(i/2);break;case e.LINE_STRIP:t.lines+=n*(i-1);break;case e.LINE_LOOP:t.lines+=n*i;break;case e.POINTS:t.points+=n*i;break;default:console.error("THREE.WebGLInfo: Unknown draw mode:",s)}}}}function Pa(e,t,i){const s=new WeakMap,n=new Ut;return{update:function(r,a,o){const l=r.morphTargetInfluences,d=a.morphAttributes.position||a.morphAttributes.normal||a.morphAttributes.color,c=void 0!==d?d.length:0;let h=s.get(a);if(void 0===h||h.count!==c){void 0!==h&&h.texture.dispose();const p=void 0!==a.morphAttributes.position,u=void 0!==a.morphAttributes.normal,m=void 0!==a.morphAttributes.color,f=a.morphAttributes.position||[],g=a.morphAttributes.normal||[],b=a.morphAttributes.color||[];let C=0;!0===p&&(C=1),!0===u&&(C=2),!0===m&&(C=3);let v=a.attributes.position.count*C,_=1;v>t.maxTextureSize&&(_=Math.ceil(v/t.maxTextureSize),v=t.maxTextureSize);const y=new Float32Array(v*_*4*c),S=new zt(y,v,_,c);S.type=K,S.needsUpdate=!0;const w=4*C;for(let A=0;A<c;A++){const M=f[A],T=g[A],E=b[A],R=v*_*4*A;for(let k=0;k<M.count;k++){const O=k*w;!0===p&&(n.fromBufferAttribute(M,k),y[R+O+0]=n.x,y[R+O+1]=n.y,y[R+O+2]=n.z,y[R+O+3]=0),!0===u&&(n.fromBufferAttribute(T,k),y[R+O+4]=n.x,y[R+O+5]=n.y,y[R+O+6]=n.z,y[R+O+7]=0),!0===m&&(n.fromBufferAttribute(E,k),y[R+O+8]=n.x,y[R+O+9]=n.y,y[R+O+10]=n.z,y[R+O+11]=4===E.itemSize?n.w:1)}}function x(){S.dispose(),s.delete(a),a.removeEventListener("dispose",x)}h={count:c,texture:S,size:new pt(v,_)},s.set(a,h),a.addEventListener("dispose",x)}if(!0===r.isInstancedMesh&&null!==r.morphTexture)o.getUniforms().setValue(e,"morphTexture",r.morphTexture,i);else{let I=0;for(let D=0;D<l.length;D++)I+=l[D];const P=a.morphTargetsRelative?1:1-I;o.getUniforms().setValue(e,"morphTargetBaseInfluence",P),o.getUniforms().setValue(e,"morphTargetInfluences",l)}o.getUniforms().setValue(e,"morphTargetsTexture",h.texture,i),o.getUniforms().setValue(e,"morphTargetsTextureSize",h.size)}}}function Da(e,t,i,s){let n=new WeakMap;function r(e){const t=e.target;t.removeEventListener("dispose",r),i.remove(t.instanceMatrix),null!==t.instanceColor&&i.remove(t.instanceColor)}return{update:function(a){const o=s.render.frame,l=a.geometry,d=t.get(a,l);if(n.get(d)!==o&&(t.update(d),n.set(d,o)),a.isInstancedMesh&&(!1===a.hasEventListener("dispose",r)&&a.addEventListener("dispose",r),n.get(a)!==o&&(i.update(a.instanceMatrix,e.ARRAY_BUFFER),null!==a.instanceColor&&i.update(a.instanceColor,e.ARRAY_BUFFER),n.set(a,o))),a.isSkinnedMesh){const e=a.skeleton;n.get(e)!==o&&(e.update(),n.set(e,o))}return d},dispose:function(){n=new WeakMap}}}const La=new Nt,Fa=new Yn(1,1),Na=new zt,Ua=new qt,Ha=new en,Ba=[],za=[],qa=new Float32Array(16),ja=new Float32Array(9),Ga=new Float32Array(4);function $a(e,t,i){const s=e[0];if(s<=0||s>0)return e;const n=t*i;let r=Ba[n];if(void 0===r&&(r=new Float32Array(n),Ba[n]=r),0!==t){s.toArray(r,0);for(let s=1,n=0;s!==t;++s)n+=i,e[s].toArray(r,n)}return r}function Va(e,t){if(e.length!==t.length)return!1;for(let i=0,s=e.length;i<s;i++)if(e[i]!==t[i])return!1;return!0}function Wa(e,t){for(let i=0,s=t.length;i<s;i++)e[i]=t[i]}function Xa(e,t){let i=za[t];void 0===i&&(i=new Int32Array(t),za[t]=i);for(let s=0;s!==t;++s)i[s]=e.allocateTextureUnit();return i}function Ya(e,t){const i=this.cache;i[0]!==t&&(e.uniform1f(this.addr,t),i[0]=t)}function Ka(e,t){const i=this.cache;if(void 0!==t.x)i[0]===t.x&&i[1]===t.y||(e.uniform2f(this.addr,t.x,t.y),i[0]=t.x,i[1]=t.y);else{if(Va(i,t))return;e.uniform2fv(this.addr,t),Wa(i,t)}}function Za(e,t){const i=this.cache;if(void 0!==t.x)i[0]===t.x&&i[1]===t.y&&i[2]===t.z||(e.uniform3f(this.addr,t.x,t.y,t.z),i[0]=t.x,i[1]=t.y,i[2]=t.z);else if(void 0!==t.r)i[0]===t.r&&i[1]===t.g&&i[2]===t.b||(e.uniform3f(this.addr,t.r,t.g,t.b),i[0]=t.r,i[1]=t.g,i[2]=t.b);else{if(Va(i,t))return;e.uniform3fv(this.addr,t),Wa(i,t)}}function Ja(e,t){const i=this.cache;if(void 0!==t.x)i[0]===t.x&&i[1]===t.y&&i[2]===t.z&&i[3]===t.w||(e.uniform4f(this.addr,t.x,t.y,t.z,t.w),i[0]=t.x,i[1]=t.y,i[2]=t.z,i[3]=t.w);else{if(Va(i,t))return;e.uniform4fv(this.addr,t),Wa(i,t)}}function Qa(e,t){const i=this.cache,s=t.elements;if(void 0===s){if(Va(i,t))return;e.uniformMatrix2fv(this.addr,!1,t),Wa(i,t)}else{if(Va(i,s))return;Ga.set(s),e.uniformMatrix2fv(this.addr,!1,Ga),Wa(i,s)}}function eo(e,t){const i=this.cache,s=t.elements;if(void 0===s){if(Va(i,t))return;e.uniformMatrix3fv(this.addr,!1,t),Wa(i,t)}else{if(Va(i,s))return;ja.set(s),e.uniformMatrix3fv(this.addr,!1,ja),Wa(i,s)}}function to(e,t){const i=this.cache,s=t.elements;if(void 0===s){if(Va(i,t))return;e.uniformMatrix4fv(this.addr,!1,t),Wa(i,t)}else{if(Va(i,s))return;qa.set(s),e.uniformMatrix4fv(this.addr,!1,qa),Wa(i,s)}}function io(e,t){const i=this.cache;i[0]!==t&&(e.uniform1i(this.addr,t),i[0]=t)}function so(e,t){const i=this.cache;if(void 0!==t.x)i[0]===t.x&&i[1]===t.y||(e.uniform2i(this.addr,t.x,t.y),i[0]=t.x,i[1]=t.y);else{if(Va(i,t))return;e.uniform2iv(this.addr,t),Wa(i,t)}}function no(e,t){const i=this.cache;if(void 0!==t.x)i[0]===t.x&&i[1]===t.y&&i[2]===t.z||(e.uniform3i(this.addr,t.x,t.y,t.z),i[0]=t.x,i[1]=t.y,i[2]=t.z);else{if(Va(i,t))return;e.uniform3iv(this.addr,t),Wa(i,t)}}function ro(e,t){const i=this.cache;if(void 0!==t.x)i[0]===t.x&&i[1]===t.y&&i[2]===t.z&&i[3]===t.w||(e.uniform4i(this.addr,t.x,t.y,t.z,t.w),i[0]=t.x,i[1]=t.y,i[2]=t.z,i[3]=t.w);else{if(Va(i,t))return;e.uniform4iv(this.addr,t),Wa(i,t)}}function ao(e,t){const i=this.cache;i[0]!==t&&(e.uniform1ui(this.addr,t),i[0]=t)}function oo(e,t){const i=this.cache;if(void 0!==t.x)i[0]===t.x&&i[1]===t.y||(e.uniform2ui(this.addr,t.x,t.y),i[0]=t.x,i[1]=t.y);else{if(Va(i,t))return;e.uniform2uiv(this.addr,t),Wa(i,t)}}function lo(e,t){const i=this.cache;if(void 0!==t.x)i[0]===t.x&&i[1]===t.y&&i[2]===t.z||(e.uniform3ui(this.addr,t.x,t.y,t.z),i[0]=t.x,i[1]=t.y,i[2]=t.z);else{if(Va(i,t))return;e.uniform3uiv(this.addr,t),Wa(i,t)}}function co(e,t){const i=this.cache;if(void 0!==t.x)i[0]===t.x&&i[1]===t.y&&i[2]===t.z&&i[3]===t.w||(e.uniform4ui(this.addr,t.x,t.y,t.z,t.w),i[0]=t.x,i[1]=t.y,i[2]=t.z,i[3]=t.w);else{if(Va(i,t))return;e.uniform4uiv(this.addr,t),Wa(i,t)}}function ho(e,t,i){const s=this.cache,n=i.allocateTextureUnit();let r;s[0]!==n&&(e.uniform1i(this.addr,n),s[0]=n),this.type===e.SAMPLER_2D_SHADOW?(Fa.compareFunction=515,r=Fa):r=La,i.setTexture2D(t||r,n)}function po(e,t,i){const s=this.cache,n=i.allocateTextureUnit();s[0]!==n&&(e.uniform1i(this.addr,n),s[0]=n),i.setTexture3D(t||Ua,n)}function uo(e,t,i){const s=this.cache,n=i.allocateTextureUnit();s[0]!==n&&(e.uniform1i(this.addr,n),s[0]=n),i.setTextureCube(t||Ha,n)}function mo(e,t,i){const s=this.cache,n=i.allocateTextureUnit();s[0]!==n&&(e.uniform1i(this.addr,n),s[0]=n),i.setTexture2DArray(t||Na,n)}function fo(e,t){e.uniform1fv(this.addr,t)}function go(e,t){const i=$a(t,this.size,2);e.uniform2fv(this.addr,i)}function bo(e,t){const i=$a(t,this.size,3);e.uniform3fv(this.addr,i)}function Co(e,t){const i=$a(t,this.size,4);e.uniform4fv(this.addr,i)}function vo(e,t){const i=$a(t,this.size,4);e.uniformMatrix2fv(this.addr,!1,i)}function _o(e,t){const i=$a(t,this.size,9);e.uniformMatrix3fv(this.addr,!1,i)}function yo(e,t){const i=$a(t,this.size,16);e.uniformMatrix4fv(this.addr,!1,i)}function So(e,t){e.uniform1iv(this.addr,t)}function wo(e,t){e.uniform2iv(this.addr,t)}function xo(e,t){e.uniform3iv(this.addr,t)}function Ao(e,t){e.uniform4iv(this.addr,t)}function Mo(e,t){e.uniform1uiv(this.addr,t)}function To(e,t){e.uniform2uiv(this.addr,t)}function Eo(e,t){e.uniform3uiv(this.addr,t)}function Ro(e,t){e.uniform4uiv(this.addr,t)}function ko(e,t,i){const s=this.cache,n=t.length,r=Xa(i,n);Va(s,r)||(e.uniform1iv(this.addr,r),Wa(s,r));for(let e=0;e!==n;++e)i.setTexture2D(t[e]||La,r[e])}function Oo(e,t,i){const s=this.cache,n=t.length,r=Xa(i,n);Va(s,r)||(e.uniform1iv(this.addr,r),Wa(s,r));for(let e=0;e!==n;++e)i.setTexture3D(t[e]||Ua,r[e])}function Io(e,t,i){const s=this.cache,n=t.length,r=Xa(i,n);Va(s,r)||(e.uniform1iv(this.addr,r),Wa(s,r));for(let e=0;e!==n;++e)i.setTextureCube(t[e]||Ha,r[e])}function Po(e,t,i){const s=this.cache,n=t.length,r=Xa(i,n);Va(s,r)||(e.uniform1iv(this.addr,r),Wa(s,r));for(let e=0;e!==n;++e)i.setTexture2DArray(t[e]||Na,r[e])}class Do{constructor(e,t,i){this.id=e,this.addr=i,this.cache=[],this.type=t.type,this.setValue=function(e){switch(e){case 5126:return Ya;case 35664:return Ka;case 35665:return Za;case 35666:return Ja;case 35674:return Qa;case 35675:return eo;case 35676:return to;case 5124:case 35670:return io;case 35667:case 35671:return so;case 35668:case 35672:return no;case 35669:case 35673:return ro;case 5125:return ao;case 36294:return oo;case 36295:return lo;case 36296:return co;case 35678:case 36198:case 36298:case 36306:case 35682:return ho;case 35679:case 36299:case 36307:return po;case 35680:case 36300:case 36308:case 36293:return uo;case 36289:case 36303:case 36311:case 36292:return mo}}(t.type)}}class Lo{constructor(e,t,i){this.id=e,this.addr=i,this.cache=[],this.type=t.type,this.size=t.size,this.setValue=function(e){switch(e){case 5126:return fo;case 35664:return go;case 35665:return bo;case 35666:return Co;case 35674:return vo;case 35675:return _o;case 35676:return yo;case 5124:case 35670:return So;case 35667:case 35671:return wo;case 35668:case 35672:return xo;case 35669:case 35673:return Ao;case 5125:return Mo;case 36294:return To;case 36295:return Eo;case 36296:return Ro;case 35678:case 36198:case 36298:case 36306:case 35682:return ko;case 35679:case 36299:case 36307:return Oo;case 35680:case 36300:case 36308:case 36293:return Io;case 36289:case 36303:case 36311:case 36292:return Po}}(t.type)}}class Fo{constructor(e){this.id=e,this.seq=[],this.map={}}setValue(e,t,i){const s=this.seq;for(let n=0,r=s.length;n!==r;++n){const r=s[n];r.setValue(e,t[r.id],i)}}}const No=/(\w+)(\])?(\[|\.)?/g;function Uo(e,t){e.seq.push(t),e.map[t.id]=t}function Ho(e,t,i){const s=e.name,n=s.length;for(No.lastIndex=0;;){const r=No.exec(s),a=No.lastIndex;let o=r[1];const l="]"===r[2],d=r[3];if(l&&(o|=0),void 0===d||"["===d&&a+2===n){Uo(i,void 0===d?new Do(o,e,t):new Lo(o,e,t));break}{let e=i.map[o];void 0===e&&(e=new Fo(o),Uo(i,e)),i=e}}}class Bo{constructor(e,t){this.seq=[],this.map={};const i=e.getProgramParameter(t,e.ACTIVE_UNIFORMS);for(let s=0;s<i;++s){const i=e.getActiveUniform(t,s);Ho(i,e.getUniformLocation(t,i.name),this)}}setValue(e,t,i,s){const n=this.map[t];void 0!==n&&n.setValue(e,i,s)}setOptional(e,t,i){const s=t[i];void 0!==s&&this.setValue(e,i,s)}static upload(e,t,i,s){for(let n=0,r=t.length;n!==r;++n){const r=t[n],a=i[r.id];!1!==a.needsUpdate&&r.setValue(e,a.value,s)}}static seqWithValue(e,t){const i=[];for(let s=0,n=e.length;s!==n;++s){const n=e[s];n.id in t&&i.push(n)}return i}}function zo(e,t,i){const s=e.createShader(t);return e.shaderSource(s,i),e.compileShader(s),s}let qo=0;const jo=new bt;function Go(e,t,i){const s=e.getShaderParameter(t,e.COMPILE_STATUS),n=e.getShaderInfoLog(t).trim();if(s&&""===n)return"";const r=/ERROR: 0:(\d+)/.exec(n);if(r){const s=parseInt(r[1]);return i.toUpperCase()+"\n\n"+n+"\n\n"+function(e,t){const i=e.split("\n"),s=[],n=Math.max(t-6,0),r=Math.min(t+6,i.length);for(let e=n;e<r;e++){const n=e+1;s.push(`${n===t?">":" "} ${n}: ${i[e]}`)}return s.join("\n")}(e.getShaderSource(t),s)}return n}function $o(e,t){const i=function(e){Tt._getMatrix(jo,Tt.workingColorSpace,e);const t=`mat3( ${jo.elements.map((e=>e.toFixed(4)))} )`;switch(Tt.getTransfer(e)){case qe:return[t,"LinearTransferOETF"];case je:return[t,"sRGBTransferOETF"];default:return console.warn("THREE.WebGLProgram: Unsupported color space: ",e),[t,"LinearTransferOETF"]}}(t);return[`vec4 ${e}( vec4 value ) {`,`\treturn ${i[1]}( vec4( value.rgb * ${i[0]}, value.a ) );`,"}"].join("\n")}function Vo(e,t){let i;switch(t){case 1:i="Linear";break;case 2:i="Reinhard";break;case 3:i="Cineon";break;case 4:i="ACESFilmic";break;case 6:i="AgX";break;case 7:i="Neutral";break;case 5:i="Custom";break;default:console.warn("THREE.WebGLProgram: Unsupported toneMapping:",t),i="Linear"}return"vec3 "+e+"( vec3 color ) { return "+i+"ToneMapping( color ); }"}const Wo=new mt;function Xo(){Tt.getLuminanceCoefficients(Wo);return["float luminance( const in vec3 rgb ) {",`\tconst vec3 weights = vec3( ${Wo.x.toFixed(4)}, ${Wo.y.toFixed(4)}, ${Wo.z.toFixed(4)} );`,"\treturn dot( weights, rgb );","}"].join("\n")}function Yo(e){return""!==e}function Ko(e,t){const i=t.numSpotLightShadows+t.numSpotLightMaps-t.numSpotLightShadowsWithMaps;return e.replace(/NUM_DIR_LIGHTS/g,t.numDirLights).replace(/NUM_SPOT_LIGHTS/g,t.numSpotLights).replace(/NUM_SPOT_LIGHT_MAPS/g,t.numSpotLightMaps).replace(/NUM_SPOT_LIGHT_COORDS/g,i).replace(/NUM_RECT_AREA_LIGHTS/g,t.numRectAreaLights).replace(/NUM_POINT_LIGHTS/g,t.numPointLights).replace(/NUM_HEMI_LIGHTS/g,t.numHemiLights).replace(/NUM_DIR_LIGHT_SHADOWS/g,t.numDirLightShadows).replace(/NUM_SPOT_LIGHT_SHADOWS_WITH_MAPS/g,t.numSpotLightShadowsWithMaps).replace(/NUM_SPOT_LIGHT_SHADOWS/g,t.numSpotLightShadows).replace(/NUM_POINT_LIGHT_SHADOWS/g,t.numPointLightShadows)}function Zo(e,t){return e.replace(/NUM_CLIPPING_PLANES/g,t.numClippingPlanes).replace(/UNION_CLIPPING_PLANES/g,t.numClippingPlanes-t.numClipIntersection)}const Jo=/^[ \t]*#include +<([\w\d./]+)>/gm;function Qo(e){return e.replace(Jo,tl)}const el=new Map;function tl(e,t){let i=Jr[t];if(void 0===i){const e=el.get(t);if(void 0===e)throw new Error("Can not resolve #include <"+t+">");i=Jr[e],console.warn('THREE.WebGLRenderer: Shader chunk "%s" has been deprecated. Use "%s" instead.',t,e)}return Qo(i)}const il=/#pragma unroll_loop_start\s+for\s*\(\s*int\s+i\s*=\s*(\d+)\s*;\s*i\s*<\s*(\d+)\s*;\s*i\s*\+\+\s*\)\s*{([\s\S]+?)}\s+#pragma unroll_loop_end/g;function sl(e){return e.replace(il,nl)}function nl(e,t,i,s){let n="";for(let e=parseInt(t);e<parseInt(i);e++)n+=s.replace(/\[\s*i\s*\]/g,"[ "+e+" ]").replace(/UNROLLED_LOOP_INDEX/g,e);return n}function rl(e){let t=`precision ${e.precision} float;\n\tprecision ${e.precision} int;\n\tprecision ${e.precision} sampler2D;\n\tprecision ${e.precision} samplerCube;\n\tprecision ${e.precision} sampler3D;\n\tprecision ${e.precision} sampler2DArray;\n\tprecision ${e.precision} sampler2DShadow;\n\tprecision ${e.precision} samplerCubeShadow;\n\tprecision ${e.precision} sampler2DArrayShadow;\n\tprecision ${e.precision} isampler2D;\n\tprecision ${e.precision} isampler3D;\n\tprecision ${e.precision} isamplerCube;\n\tprecision ${e.precision} isampler2DArray;\n\tprecision ${e.precision} usampler2D;\n\tprecision ${e.precision} usampler3D;\n\tprecision ${e.precision} usamplerCube;\n\tprecision ${e.precision} usampler2DArray;\n\t`;return"highp"===e.precision?t+="\n#define HIGH_PRECISION":"mediump"===e.precision?t+="\n#define MEDIUM_PRECISION":"lowp"===e.precision&&(t+="\n#define LOW_PRECISION"),t}function al(e,t,i,s){const n=e.getContext(),r=i.defines;let a=i.vertexShader,o=i.fragmentShader;const l=function(e){let t="SHADOWMAP_TYPE_BASIC";return 1===e.shadowMapType?t="SHADOWMAP_TYPE_PCF":2===e.shadowMapType?t="SHADOWMAP_TYPE_PCF_SOFT":3===e.shadowMapType&&(t="SHADOWMAP_TYPE_VSM"),t}(i),d=function(e){let t="ENVMAP_TYPE_CUBE";if(e.envMap)switch(e.envMapMode){case O:case I:t="ENVMAP_TYPE_CUBE";break;case P:t="ENVMAP_TYPE_CUBE_UV"}return t}(i),c=function(e){let t="ENVMAP_MODE_REFLECTION";e.envMap&&e.envMapMode===I&&(t="ENVMAP_MODE_REFRACTION");return t}(i),h=function(e){let t="ENVMAP_BLENDING_NONE";if(e.envMap)switch(e.combine){case 0:t="ENVMAP_BLENDING_MULTIPLY";break;case 1:t="ENVMAP_BLENDING_MIX";break;case 2:t="ENVMAP_BLENDING_ADD"}return t}(i),p=function(e){const t=e.envMapCubeUVHeight;if(null===t)return null;const i=Math.log2(t)-2,s=1/t;return{texelWidth:1/(3*Math.max(Math.pow(2,i),112)),texelHeight:s,maxMip:i}}(i),u=function(e){return[e.extensionClipCullDistance?"#extension GL_ANGLE_clip_cull_distance : require":"",e.extensionMultiDraw?"#extension GL_ANGLE_multi_draw : require":""].filter(Yo).join("\n")}(i),m=function(e){const t=[];for(const i in e){const s=e[i];!1!==s&&t.push("#define "+i+" "+s)}return t.join("\n")}(r),f=n.createProgram();let g,b,C=i.glslVersion?"#version "+i.glslVersion+"\n":"";i.isRawShaderMaterial?(g=["#define SHADER_TYPE "+i.shaderType,"#define SHADER_NAME "+i.shaderName,m].filter(Yo).join("\n"),g.length>0&&(g+="\n"),b=["#define SHADER_TYPE "+i.shaderType,"#define SHADER_NAME "+i.shaderName,m].filter(Yo).join("\n"),b.length>0&&(b+="\n")):(g=[rl(i),"#define SHADER_TYPE "+i.shaderType,"#define SHADER_NAME "+i.shaderName,m,i.extensionClipCullDistance?"#define USE_CLIP_DISTANCE":"",i.batching?"#define USE_BATCHING":"",i.batchingColor?"#define USE_BATCHING_COLOR":"",i.instancing?"#define USE_INSTANCING":"",i.instancingColor?"#define USE_INSTANCING_COLOR":"",i.instancingMorph?"#define USE_INSTANCING_MORPH":"",i.useFog&&i.fog?"#define USE_FOG":"",i.useFog&&i.fogExp2?"#define FOG_EXP2":"",i.map?"#define USE_MAP":"",i.envMap?"#define USE_ENVMAP":"",i.envMap?"#define "+c:"",i.lightMap?"#define USE_LIGHTMAP":"",i.aoMap?"#define USE_AOMAP":"",i.bumpMap?"#define USE_BUMPMAP":"",i.normalMap?"#define USE_NORMALMAP":"",i.normalMapObjectSpace?"#define USE_NORMALMAP_OBJECTSPACE":"",i.normalMapTangentSpace?"#define USE_NORMALMAP_TANGENTSPACE":"",i.displacementMap?"#define USE_DISPLACEMENTMAP":"",i.emissiveMap?"#define USE_EMISSIVEMAP":"",i.anisotropy?"#define USE_ANISOTROPY":"",i.anisotropyMap?"#define USE_ANISOTROPYMAP":"",i.clearcoatMap?"#define USE_CLEARCOATMAP":"",i.clearcoatRoughnessMap?"#define USE_CLEARCOAT_ROUGHNESSMAP":"",i.clearcoatNormalMap?"#define USE_CLEARCOAT_NORMALMAP":"",i.iridescenceMap?"#define USE_IRIDESCENCEMAP":"",i.iridescenceThicknessMap?"#define USE_IRIDESCENCE_THICKNESSMAP":"",i.specularMap?"#define USE_SPECULARMAP":"",i.specularColorMap?"#define USE_SPECULAR_COLORMAP":"",i.specularIntensityMap?"#define USE_SPECULAR_INTENSITYMAP":"",i.roughnessMap?"#define USE_ROUGHNESSMAP":"",i.metalnessMap?"#define USE_METALNESSMAP":"",i.alphaMap?"#define USE_ALPHAMAP":"",i.alphaHash?"#define USE_ALPHAHASH":"",i.transmission?"#define USE_TRANSMISSION":"",i.transmissionMap?"#define USE_TRANSMISSIONMAP":"",i.thicknessMap?"#define USE_THICKNESSMAP":"",i.sheenColorMap?"#define USE_SHEEN_COLORMAP":"",i.sheenRoughnessMap?"#define USE_SHEEN_ROUGHNESSMAP":"",i.mapUv?"#define MAP_UV "+i.mapUv:"",i.alphaMapUv?"#define ALPHAMAP_UV "+i.alphaMapUv:"",i.lightMapUv?"#define LIGHTMAP_UV "+i.lightMapUv:"",i.aoMapUv?"#define AOMAP_UV "+i.aoMapUv:"",i.emissiveMapUv?"#define EMISSIVEMAP_UV "+i.emissiveMapUv:"",i.bumpMapUv?"#define BUMPMAP_UV "+i.bumpMapUv:"",i.normalMapUv?"#define NORMALMAP_UV "+i.normalMapUv:"",i.displacementMapUv?"#define DISPLACEMENTMAP_UV "+i.displacementMapUv:"",i.metalnessMapUv?"#define METALNESSMAP_UV "+i.metalnessMapUv:"",i.roughnessMapUv?"#define ROUGHNESSMAP_UV "+i.roughnessMapUv:"",i.anisotropyMapUv?"#define ANISOTROPYMAP_UV "+i.anisotropyMapUv:"",i.clearcoatMapUv?"#define CLEARCOATMAP_UV "+i.clearcoatMapUv:"",i.clearcoatNormalMapUv?"#define CLEARCOAT_NORMALMAP_UV "+i.clearcoatNormalMapUv:"",i.clearcoatRoughnessMapUv?"#define CLEARCOAT_ROUGHNESSMAP_UV "+i.clearcoatRoughnessMapUv:"",i.iridescenceMapUv?"#define IRIDESCENCEMAP_UV "+i.iridescenceMapUv:"",i.iridescenceThicknessMapUv?"#define IRIDESCENCE_THICKNESSMAP_UV "+i.iridescenceThicknessMapUv:"",i.sheenColorMapUv?"#define SHEEN_COLORMAP_UV "+i.sheenColorMapUv:"",i.sheenRoughnessMapUv?"#define SHEEN_ROUGHNESSMAP_UV "+i.sheenRoughnessMapUv:"",i.specularMapUv?"#define SPECULARMAP_UV "+i.specularMapUv:"",i.specularColorMapUv?"#define SPECULAR_COLORMAP_UV "+i.specularColorMapUv:"",i.specularIntensityMapUv?"#define SPECULAR_INTENSITYMAP_UV "+i.specularIntensityMapUv:"",i.transmissionMapUv?"#define TRANSMISSIONMAP_UV "+i.transmissionMapUv:"",i.thicknessMapUv?"#define THICKNESSMAP_UV "+i.thicknessMapUv:"",i.vertexTangents&&!1===i.flatShading?"#define USE_TANGENT":"",i.vertexColors?"#define USE_COLOR":"",i.vertexAlphas?"#define USE_COLOR_ALPHA":"",i.vertexUv1s?"#define USE_UV1":"",i.vertexUv2s?"#define USE_UV2":"",i.vertexUv3s?"#define USE_UV3":"",i.pointsUvs?"#define USE_POINTS_UV":"",i.flatShading?"#define FLAT_SHADED":"",i.skinning?"#define USE_SKINNING":"",i.morphTargets?"#define USE_MORPHTARGETS":"",i.morphNormals&&!1===i.flatShading?"#define USE_MORPHNORMALS":"",i.morphColors?"#define USE_MORPHCOLORS":"",i.morphTargetsCount>0?"#define MORPHTARGETS_TEXTURE_STRIDE "+i.morphTextureStride:"",i.morphTargetsCount>0?"#define MORPHTARGETS_COUNT "+i.morphTargetsCount:"",i.doubleSided?"#define DOUBLE_SIDED":"",i.flipSided?"#define FLIP_SIDED":"",i.shadowMapEnabled?"#define USE_SHADOWMAP":"",i.shadowMapEnabled?"#define "+l:"",i.sizeAttenuation?"#define USE_SIZEATTENUATION":"",i.numLightProbes>0?"#define USE_LIGHT_PROBES":"",i.logarithmicDepthBuffer?"#define USE_LOGDEPTHBUF":"",i.reverseDepthBuffer?"#define USE_REVERSEDEPTHBUF":"","uniform mat4 modelMatrix;","uniform mat4 modelViewMatrix;","uniform mat4 projectionMatrix;","uniform mat4 viewMatrix;","uniform mat3 normalMatrix;","uniform vec3 cameraPosition;","uniform bool isOrthographic;","#ifdef USE_INSTANCING","\tattribute mat4 instanceMatrix;","#endif","#ifdef USE_INSTANCING_COLOR","\tattribute vec3 instanceColor;","#endif","#ifdef USE_INSTANCING_MORPH","\tuniform sampler2D morphTexture;","#endif","attribute vec3 position;","attribute vec3 normal;","attribute vec2 uv;","#ifdef USE_UV1","\tattribute vec2 uv1;","#endif","#ifdef USE_UV2","\tattribute vec2 uv2;","#endif","#ifdef USE_UV3","\tattribute vec2 uv3;","#endif","#ifdef USE_TANGENT","\tattribute vec4 tangent;","#endif","#if defined( USE_COLOR_ALPHA )","\tattribute vec4 color;","#elif defined( USE_COLOR )","\tattribute vec3 color;","#endif","#ifdef USE_SKINNING","\tattribute vec4 skinIndex;","\tattribute vec4 skinWeight;","#endif","\n"].filter(Yo).join("\n"),b=[rl(i),"#define SHADER_TYPE "+i.shaderType,"#define SHADER_NAME "+i.shaderName,m,i.useFog&&i.fog?"#define USE_FOG":"",i.useFog&&i.fogExp2?"#define FOG_EXP2":"",i.alphaToCoverage?"#define ALPHA_TO_COVERAGE":"",i.map?"#define USE_MAP":"",i.matcap?"#define USE_MATCAP":"",i.envMap?"#define USE_ENVMAP":"",i.envMap?"#define "+d:"",i.envMap?"#define "+c:"",i.envMap?"#define "+h:"",p?"#define CUBEUV_TEXEL_WIDTH "+p.texelWidth:"",p?"#define CUBEUV_TEXEL_HEIGHT "+p.texelHeight:"",p?"#define CUBEUV_MAX_MIP "+p.maxMip+".0":"",i.lightMap?"#define USE_LIGHTMAP":"",i.aoMap?"#define USE_AOMAP":"",i.bumpMap?"#define USE_BUMPMAP":"",i.normalMap?"#define USE_NORMALMAP":"",i.normalMapObjectSpace?"#define USE_NORMALMAP_OBJECTSPACE":"",i.normalMapTangentSpace?"#define USE_NORMALMAP_TANGENTSPACE":"",i.emissiveMap?"#define USE_EMISSIVEMAP":"",i.anisotropy?"#define USE_ANISOTROPY":"",i.anisotropyMap?"#define USE_ANISOTROPYMAP":"",i.clearcoat?"#define USE_CLEARCOAT":"",i.clearcoatMap?"#define USE_CLEARCOATMAP":"",i.clearcoatRoughnessMap?"#define USE_CLEARCOAT_ROUGHNESSMAP":"",i.clearcoatNormalMap?"#define USE_CLEARCOAT_NORMALMAP":"",i.dispersion?"#define USE_DISPERSION":"",i.iridescence?"#define USE_IRIDESCENCE":"",i.iridescenceMap?"#define USE_IRIDESCENCEMAP":"",i.iridescenceThicknessMap?"#define USE_IRIDESCENCE_THICKNESSMAP":"",i.specularMap?"#define USE_SPECULARMAP":"",i.specularColorMap?"#define USE_SPECULAR_COLORMAP":"",i.specularIntensityMap?"#define USE_SPECULAR_INTENSITYMAP":"",i.roughnessMap?"#define USE_ROUGHNESSMAP":"",i.metalnessMap?"#define USE_METALNESSMAP":"",i.alphaMap?"#define USE_ALPHAMAP":"",i.alphaTest?"#define USE_ALPHATEST":"",i.alphaHash?"#define USE_ALPHAHASH":"",i.sheen?"#define USE_SHEEN":"",i.sheenColorMap?"#define USE_SHEEN_COLORMAP":"",i.sheenRoughnessMap?"#define USE_SHEEN_ROUGHNESSMAP":"",i.transmission?"#define USE_TRANSMISSION":"",i.transmissionMap?"#define USE_TRANSMISSIONMAP":"",i.thicknessMap?"#define USE_THICKNESSMAP":"",i.vertexTangents&&!1===i.flatShading?"#define USE_TANGENT":"",i.vertexColors||i.instancingColor||i.batchingColor?"#define USE_COLOR":"",i.vertexAlphas?"#define USE_COLOR_ALPHA":"",i.vertexUv1s?"#define USE_UV1":"",i.vertexUv2s?"#define USE_UV2":"",i.vertexUv3s?"#define USE_UV3":"",i.pointsUvs?"#define USE_POINTS_UV":"",i.gradientMap?"#define USE_GRADIENTMAP":"",i.flatShading?"#define FLAT_SHADED":"",i.doubleSided?"#define DOUBLE_SIDED":"",i.flipSided?"#define FLIP_SIDED":"",i.shadowMapEnabled?"#define USE_SHADOWMAP":"",i.shadowMapEnabled?"#define "+l:"",i.premultipliedAlpha?"#define PREMULTIPLIED_ALPHA":"",i.numLightProbes>0?"#define USE_LIGHT_PROBES":"",i.decodeVideoTexture?"#define DECODE_VIDEO_TEXTURE":"",i.decodeVideoTextureEmissive?"#define DECODE_VIDEO_TEXTURE_EMISSIVE":"",i.logarithmicDepthBuffer?"#define USE_LOGDEPTHBUF":"",i.reverseDepthBuffer?"#define USE_REVERSEDEPTHBUF":"","uniform mat4 viewMatrix;","uniform vec3 cameraPosition;","uniform bool isOrthographic;",0!==i.toneMapping?"#define TONE_MAPPING":"",0!==i.toneMapping?Jr.tonemapping_pars_fragment:"",0!==i.toneMapping?Vo("toneMapping",i.toneMapping):"",i.dithering?"#define DITHERING":"",i.opaque?"#define OPAQUE":"",Jr.colorspace_pars_fragment,$o("linearToOutputTexel",i.outputColorSpace),Xo(),i.useDepthPacking?"#define DEPTH_PACKING "+i.depthPacking:"","\n"].filter(Yo).join("\n")),a=Qo(a),a=Ko(a,i),a=Zo(a,i),o=Qo(o),o=Ko(o,i),o=Zo(o,i),a=sl(a),o=sl(o),!0!==i.isRawShaderMaterial&&(C="#version 300 es\n",g=[u,"#define attribute in","#define varying out","#define texture2D texture"].join("\n")+"\n"+g,b=["#define varying in",i.glslVersion===et?"":"layout(location = 0) out highp vec4 pc_fragColor;",i.glslVersion===et?"":"#define gl_FragColor pc_fragColor","#define gl_FragDepthEXT gl_FragDepth","#define texture2D texture","#define textureCube texture","#define texture2DProj textureProj","#define texture2DLodEXT textureLod","#define texture2DProjLodEXT textureProjLod","#define textureCubeLodEXT textureLod","#define texture2DGradEXT textureGrad","#define texture2DProjGradEXT textureProjGrad","#define textureCubeGradEXT textureGrad"].join("\n")+"\n"+b);const v=C+g+a,_=C+b+o,y=zo(n,n.VERTEX_SHADER,v),S=zo(n,n.FRAGMENT_SHADER,_);function w(t){if(e.debug.checkShaderErrors){const i=n.getProgramInfoLog(f).trim(),s=n.getShaderInfoLog(y).trim(),r=n.getShaderInfoLog(S).trim();let a=!0,o=!0;if(!1===n.getProgramParameter(f,n.LINK_STATUS))if(a=!1,"function"==typeof e.debug.onShaderError)e.debug.onShaderError(n,f,y,S);else{const e=Go(n,y,"vertex"),s=Go(n,S,"fragment");console.error("THREE.WebGLProgram: Shader Error "+n.getError()+" - VALIDATE_STATUS "+n.getProgramParameter(f,n.VALIDATE_STATUS)+"\n\nMaterial Name: "+t.name+"\nMaterial Type: "+t.type+"\n\nProgram Info Log: "+i+"\n"+e+"\n"+s)}else""!==i?console.warn("THREE.WebGLProgram: Program Info Log:",i):""!==s&&""!==r||(o=!1);o&&(t.diagnostics={runnable:a,programLog:i,vertexShader:{log:s,prefix:g},fragmentShader:{log:r,prefix:b}})}n.deleteShader(y),n.deleteShader(S),x=new Bo(n,f),A=function(e,t){const i={},s=e.getProgramParameter(t,e.ACTIVE_ATTRIBUTES);for(let n=0;n<s;n++){const s=e.getActiveAttrib(t,n),r=s.name;let a=1;s.type===e.FLOAT_MAT2&&(a=2),s.type===e.FLOAT_MAT3&&(a=3),s.type===e.FLOAT_MAT4&&(a=4),i[r]={type:s.type,location:e.getAttribLocation(t,r),locationSize:a}}return i}(n,f)}let x,A;n.attachShader(f,y),n.attachShader(f,S),void 0!==i.index0AttributeName?n.bindAttribLocation(f,0,i.index0AttributeName):!0===i.morphTargets&&n.bindAttribLocation(f,0,"position"),n.linkProgram(f),this.getUniforms=function(){return void 0===x&&w(this),x},this.getAttributes=function(){return void 0===A&&w(this),A};let M=!1===i.rendererExtensionParallelShaderCompile;return this.isReady=function(){return!1===M&&(M=n.getProgramParameter(f,37297)),M},this.destroy=function(){s.releaseStatesOfProgram(this),n.deleteProgram(f),this.program=void 0},this.type=i.shaderType,this.name=i.shaderName,this.id=qo++,this.cacheKey=t,this.usedTimes=1,this.program=f,this.vertexShader=y,this.fragmentShader=S,this}let ol=0;class ll{constructor(){this.shaderCache=new Map,this.materialCache=new Map}update(e){const t=e.vertexShader,i=e.fragmentShader,s=this._getShaderStage(t),n=this._getShaderStage(i),r=this._getShaderCacheForMaterial(e);return!1===r.has(s)&&(r.add(s),s.usedTimes++),!1===r.has(n)&&(r.add(n),n.usedTimes++),this}remove(e){const t=this.materialCache.get(e);for(const e of t)e.usedTimes--,0===e.usedTimes&&this.shaderCache.delete(e.code);return this.materialCache.delete(e),this}getVertexShaderID(e){return this._getShaderStage(e.vertexShader).id}getFragmentShaderID(e){return this._getShaderStage(e.fragmentShader).id}dispose(){this.shaderCache.clear(),this.materialCache.clear()}_getShaderCacheForMaterial(e){const t=this.materialCache;let i=t.get(e);return void 0===i&&(i=new Set,t.set(e,i)),i}_getShaderStage(e){const t=this.shaderCache;let i=t.get(e);return void 0===i&&(i=new dl(e),t.set(e,i)),i}}class dl{constructor(e){this.id=ol++,this.code=e,this.usedTimes=0}}function cl(e,t,i,s,n,r,a){const o=new Ti,l=new ll,d=new Set,c=[],h=n.logarithmicDepthBuffer,p=n.vertexTextures;let u=n.precision;const m={MeshDepthMaterial:"depth",MeshDistanceMaterial:"distanceRGBA",MeshNormalMaterial:"normal",MeshBasicMaterial:"basic",MeshLambertMaterial:"lambert",MeshPhongMaterial:"phong",MeshToonMaterial:"toon",MeshStandardMaterial:"physical",MeshPhysicalMaterial:"physical",MeshMatcapMaterial:"matcap",LineBasicMaterial:"basic",LineDashedMaterial:"dashed",PointsMaterial:"points",ShadowMaterial:"shadow",SpriteMaterial:"sprite"};function f(e){return d.add(e),0===e?"uv":`uv${e}`}return{getParameters:function(r,o,c,g,b){const C=g.fog,v=b.geometry,_=r.isMeshStandardMaterial?g.environment:null,y=(r.isMeshStandardMaterial?i:t).get(r.envMap||_),S=y&&y.mapping===P?y.image.height:null,w=m[r.type];null!==r.precision&&(u=n.getMaxPrecision(r.precision),u!==r.precision&&console.warn("THREE.WebGLProgram.getParameters:",r.precision,"not supported, using",u,"instead."));const x=v.morphAttributes.position||v.morphAttributes.normal||v.morphAttributes.color,A=void 0!==x?x.length:0;let M,T,E,R,k=0;if(void 0!==v.morphAttributes.position&&(k=1),void 0!==v.morphAttributes.normal&&(k=2),void 0!==v.morphAttributes.color&&(k=3),w){const e=ea[w];M=e.vertexShader,T=e.fragmentShader}else M=r.vertexShader,T=r.fragmentShader,l.update(r),E=l.getVertexShaderID(r),R=l.getFragmentShaderID(r);const O=e.getRenderTarget(),I=e.state.buffers.depth.getReversed(),D=!0===b.isInstancedMesh,L=!0===b.isBatchedMesh,F=!!r.map,N=!!r.matcap,U=!!y,H=!!r.aoMap,B=!!r.lightMap,z=!!r.bumpMap,q=!!r.normalMap,j=!!r.displacementMap,G=!!r.emissiveMap,$=!!r.metalnessMap,V=!!r.roughnessMap,W=r.anisotropy>0,X=r.clearcoat>0,Y=r.dispersion>0,K=r.iridescence>0,Z=r.sheen>0,J=r.transmission>0,Q=W&&!!r.anisotropyMap,ee=X&&!!r.clearcoatMap,te=X&&!!r.clearcoatNormalMap,ie=X&&!!r.clearcoatRoughnessMap,se=K&&!!r.iridescenceMap,ne=K&&!!r.iridescenceThicknessMap,re=Z&&!!r.sheenColorMap,ae=Z&&!!r.sheenRoughnessMap,oe=!!r.specularMap,le=!!r.specularColorMap,de=!!r.specularIntensityMap,ce=J&&!!r.transmissionMap,he=J&&!!r.thicknessMap,pe=!!r.gradientMap,ue=!!r.alphaMap,me=r.alphaTest>0,fe=!!r.alphaHash,ge=!!r.extensions;let be=0;r.toneMapped&&(null!==O&&!0!==O.isXRRenderTarget||(be=e.toneMapping));const Ce={shaderID:w,shaderType:r.type,shaderName:r.name,vertexShader:M,fragmentShader:T,defines:r.defines,customVertexShaderID:E,customFragmentShaderID:R,isRawShaderMaterial:!0===r.isRawShaderMaterial,glslVersion:r.glslVersion,precision:u,batching:L,batchingColor:L&&null!==b._colorsTexture,instancing:D,instancingColor:D&&null!==b.instanceColor,instancingMorph:D&&null!==b.morphTexture,supportsVertexTextures:p,outputColorSpace:null===O?e.outputColorSpace:!0===O.isXRRenderTarget?O.texture.colorSpace:ze,alphaToCoverage:!!r.alphaToCoverage,map:F,matcap:N,envMap:U,envMapMode:U&&y.mapping,envMapCubeUVHeight:S,aoMap:H,lightMap:B,bumpMap:z,normalMap:q,displacementMap:p&&j,emissiveMap:G,normalMapObjectSpace:q&&1===r.normalMapType,normalMapTangentSpace:q&&0===r.normalMapType,metalnessMap:$,roughnessMap:V,anisotropy:W,anisotropyMap:Q,clearcoat:X,clearcoatMap:ee,clearcoatNormalMap:te,clearcoatRoughnessMap:ie,dispersion:Y,iridescence:K,iridescenceMap:se,iridescenceThicknessMap:ne,sheen:Z,sheenColorMap:re,sheenRoughnessMap:ae,specularMap:oe,specularColorMap:le,specularIntensityMap:de,transmission:J,transmissionMap:ce,thicknessMap:he,gradientMap:pe,opaque:!1===r.transparent&&1===r.blending&&!1===r.alphaToCoverage,alphaMap:ue,alphaTest:me,alphaHash:fe,combine:r.combine,mapUv:F&&f(r.map.channel),aoMapUv:H&&f(r.aoMap.channel),lightMapUv:B&&f(r.lightMap.channel),bumpMapUv:z&&f(r.bumpMap.channel),normalMapUv:q&&f(r.normalMap.channel),displacementMapUv:j&&f(r.displacementMap.channel),emissiveMapUv:G&&f(r.emissiveMap.channel),metalnessMapUv:$&&f(r.metalnessMap.channel),roughnessMapUv:V&&f(r.roughnessMap.channel),anisotropyMapUv:Q&&f(r.anisotropyMap.channel),clearcoatMapUv:ee&&f(r.clearcoatMap.channel),clearcoatNormalMapUv:te&&f(r.clearcoatNormalMap.channel),clearcoatRoughnessMapUv:ie&&f(r.clearcoatRoughnessMap.channel),iridescenceMapUv:se&&f(r.iridescenceMap.channel),iridescenceThicknessMapUv:ne&&f(r.iridescenceThicknessMap.channel),sheenColorMapUv:re&&f(r.sheenColorMap.channel),sheenRoughnessMapUv:ae&&f(r.sheenRoughnessMap.channel),specularMapUv:oe&&f(r.specularMap.channel),specularColorMapUv:le&&f(r.specularColorMap.channel),specularIntensityMapUv:de&&f(r.specularIntensityMap.channel),transmissionMapUv:ce&&f(r.transmissionMap.channel),thicknessMapUv:he&&f(r.thicknessMap.channel),alphaMapUv:ue&&f(r.alphaMap.channel),vertexTangents:!!v.attributes.tangent&&(q||W),vertexColors:r.vertexColors,vertexAlphas:!0===r.vertexColors&&!!v.attributes.color&&4===v.attributes.color.itemSize,pointsUvs:!0===b.isPoints&&!!v.attributes.uv&&(F||ue),fog:!!C,useFog:!0===r.fog,fogExp2:!!C&&C.isFogExp2,flatShading:!0===r.flatShading,sizeAttenuation:!0===r.sizeAttenuation,logarithmicDepthBuffer:h,reverseDepthBuffer:I,skinning:!0===b.isSkinnedMesh,morphTargets:void 0!==v.morphAttributes.position,morphNormals:void 0!==v.morphAttributes.normal,morphColors:void 0!==v.morphAttributes.color,morphTargetsCount:A,morphTextureStride:k,numDirLights:o.directional.length,numPointLights:o.point.length,numSpotLights:o.spot.length,numSpotLightMaps:o.spotLightMap.length,numRectAreaLights:o.rectArea.length,numHemiLights:o.hemi.length,numDirLightShadows:o.directionalShadowMap.length,numPointLightShadows:o.pointShadowMap.length,numSpotLightShadows:o.spotShadowMap.length,numSpotLightShadowsWithMaps:o.numSpotLightShadowsWithMaps,numLightProbes:o.numLightProbes,numClippingPlanes:a.numPlanes,numClipIntersection:a.numIntersection,dithering:r.dithering,shadowMapEnabled:e.shadowMap.enabled&&c.length>0,shadowMapType:e.shadowMap.type,toneMapping:be,decodeVideoTexture:F&&!0===r.map.isVideoTexture&&Tt.getTransfer(r.map.colorSpace)===je,decodeVideoTextureEmissive:G&&!0===r.emissiveMap.isVideoTexture&&Tt.getTransfer(r.emissiveMap.colorSpace)===je,premultipliedAlpha:r.premultipliedAlpha,doubleSided:2===r.side,flipSided:1===r.side,useDepthPacking:r.depthPacking>=0,depthPacking:r.depthPacking||0,index0AttributeName:r.index0AttributeName,extensionClipCullDistance:ge&&!0===r.extensions.clipCullDistance&&s.has("WEBGL_clip_cull_distance"),extensionMultiDraw:(ge&&!0===r.extensions.multiDraw||L)&&s.has("WEBGL_multi_draw"),rendererExtensionParallelShaderCompile:s.has("KHR_parallel_shader_compile"),customProgramCacheKey:r.customProgramCacheKey()};return Ce.vertexUv1s=d.has(1),Ce.vertexUv2s=d.has(2),Ce.vertexUv3s=d.has(3),d.clear(),Ce},getProgramCacheKey:function(t){const i=[];if(t.shaderID?i.push(t.shaderID):(i.push(t.customVertexShaderID),i.push(t.customFragmentShaderID)),void 0!==t.defines)for(const e in t.defines)i.push(e),i.push(t.defines[e]);return!1===t.isRawShaderMaterial&&(!function(e,t){e.push(t.precision),e.push(t.outputColorSpace),e.push(t.envMapMode),e.push(t.envMapCubeUVHeight),e.push(t.mapUv),e.push(t.alphaMapUv),e.push(t.lightMapUv),e.push(t.aoMapUv),e.push(t.bumpMapUv),e.push(t.normalMapUv),e.push(t.displacementMapUv),e.push(t.emissiveMapUv),e.push(t.metalnessMapUv),e.push(t.roughnessMapUv),e.push(t.anisotropyMapUv),e.push(t.clearcoatMapUv),e.push(t.clearcoatNormalMapUv),e.push(t.clearcoatRoughnessMapUv),e.push(t.iridescenceMapUv),e.push(t.iridescenceThicknessMapUv),e.push(t.sheenColorMapUv),e.push(t.sheenRoughnessMapUv),e.push(t.specularMapUv),e.push(t.specularColorMapUv),e.push(t.specularIntensityMapUv),e.push(t.transmissionMapUv),e.push(t.thicknessMapUv),e.push(t.combine),e.push(t.fogExp2),e.push(t.sizeAttenuation),e.push(t.morphTargetsCount),e.push(t.morphAttributeCount),e.push(t.numDirLights),e.push(t.numPointLights),e.push(t.numSpotLights),e.push(t.numSpotLightMaps),e.push(t.numHemiLights),e.push(t.numRectAreaLights),e.push(t.numDirLightShadows),e.push(t.numPointLightShadows),e.push(t.numSpotLightShadows),e.push(t.numSpotLightShadowsWithMaps),e.push(t.numLightProbes),e.push(t.shadowMapType),e.push(t.toneMapping),e.push(t.numClippingPlanes),e.push(t.numClipIntersection),e.push(t.depthPacking)}(i,t),function(e,t){o.disableAll(),t.supportsVertexTextures&&o.enable(0);t.instancing&&o.enable(1);t.instancingColor&&o.enable(2);t.instancingMorph&&o.enable(3);t.matcap&&o.enable(4);t.envMap&&o.enable(5);t.normalMapObjectSpace&&o.enable(6);t.normalMapTangentSpace&&o.enable(7);t.clearcoat&&o.enable(8);t.iridescence&&o.enable(9);t.alphaTest&&o.enable(10);t.vertexColors&&o.enable(11);t.vertexAlphas&&o.enable(12);t.vertexUv1s&&o.enable(13);t.vertexUv2s&&o.enable(14);t.vertexUv3s&&o.enable(15);t.vertexTangents&&o.enable(16);t.anisotropy&&o.enable(17);t.alphaHash&&o.enable(18);t.batching&&o.enable(19);t.dispersion&&o.enable(20);t.batchingColor&&o.enable(21);e.push(o.mask),o.disableAll(),t.fog&&o.enable(0);t.useFog&&o.enable(1);t.flatShading&&o.enable(2);t.logarithmicDepthBuffer&&o.enable(3);t.reverseDepthBuffer&&o.enable(4);t.skinning&&o.enable(5);t.morphTargets&&o.enable(6);t.morphNormals&&o.enable(7);t.morphColors&&o.enable(8);t.premultipliedAlpha&&o.enable(9);t.shadowMapEnabled&&o.enable(10);t.doubleSided&&o.enable(11);t.flipSided&&o.enable(12);t.useDepthPacking&&o.enable(13);t.dithering&&o.enable(14);t.transmission&&o.enable(15);t.sheen&&o.enable(16);t.opaque&&o.enable(17);t.pointsUvs&&o.enable(18);t.decodeVideoTexture&&o.enable(19);t.decodeVideoTextureEmissive&&o.enable(20);t.alphaToCoverage&&o.enable(21);e.push(o.mask)}(i,t),i.push(e.outputColorSpace)),i.push(t.customProgramCacheKey),i.join()},getUniforms:function(e){const t=m[e.type];let i;if(t){const e=ea[t];i=$s.clone(e.uniforms)}else i=e.uniforms;return i},acquireProgram:function(t,i){let s;for(let e=0,t=c.length;e<t;e++){const t=c[e];if(t.cacheKey===i){s=t,++s.usedTimes;break}}return void 0===s&&(s=new al(e,i,t,r),c.push(s)),s},releaseProgram:function(e){if(0===--e.usedTimes){const t=c.indexOf(e);c[t]=c[c.length-1],c.pop(),e.destroy()}},releaseShaderCache:function(e){l.remove(e)},programs:c,dispose:function(){l.dispose()}}}function hl(){let e=new WeakMap;return{has:function(t){return e.has(t)},get:function(t){let i=e.get(t);return void 0===i&&(i={},e.set(t,i)),i},remove:function(t){e.delete(t)},update:function(t,i,s){e.get(t)[i]=s},dispose:function(){e=new WeakMap}}}function pl(e,t){return e.groupOrder!==t.groupOrder?e.groupOrder-t.groupOrder:e.renderOrder!==t.renderOrder?e.renderOrder-t.renderOrder:e.material.id!==t.material.id?e.material.id-t.material.id:e.z!==t.z?e.z-t.z:e.id-t.id}function ul(e,t){return e.groupOrder!==t.groupOrder?e.groupOrder-t.groupOrder:e.renderOrder!==t.renderOrder?e.renderOrder-t.renderOrder:e.z!==t.z?t.z-e.z:e.id-t.id}function ml(){const e=[];let t=0;const i=[],s=[],n=[];function r(i,s,n,r,a,o){let l=e[t];return void 0===l?(l={id:i.id,object:i,geometry:s,material:n,groupOrder:r,renderOrder:i.renderOrder,z:a,group:o},e[t]=l):(l.id=i.id,l.object=i,l.geometry=s,l.material=n,l.groupOrder=r,l.renderOrder=i.renderOrder,l.z=a,l.group=o),t++,l}return{opaque:i,transmissive:s,transparent:n,init:function(){t=0,i.length=0,s.length=0,n.length=0},push:function(e,t,a,o,l,d){const c=r(e,t,a,o,l,d);a.transmission>0?s.push(c):!0===a.transparent?n.push(c):i.push(c)},unshift:function(e,t,a,o,l,d){const c=r(e,t,a,o,l,d);a.transmission>0?s.unshift(c):!0===a.transparent?n.unshift(c):i.unshift(c)},finish:function(){for(let i=t,s=e.length;i<s;i++){const t=e[i];if(null===t.id)break;t.id=null,t.object=null,t.geometry=null,t.material=null,t.group=null}},sort:function(e,t){i.length>1&&i.sort(e||pl),s.length>1&&s.sort(t||ul),n.length>1&&n.sort(t||ul)}}}function fl(){let e=new WeakMap;return{get:function(t,i){const s=e.get(t);let n;return void 0===s?(n=new ml,e.set(t,[n])):i>=s.length?(n=new ml,s.push(n)):n=s[i],n},dispose:function(){e=new WeakMap}}}function gl(){const e={};return{get:function(t){if(void 0!==e[t.id])return e[t.id];let i;switch(t.type){case"DirectionalLight":i={direction:new mt,color:new ls};break;case"SpotLight":i={position:new mt,direction:new mt,color:new ls,distance:0,coneCos:0,penumbraCos:0,decay:0};break;case"PointLight":i={position:new mt,color:new ls,distance:0,decay:0};break;case"HemisphereLight":i={direction:new mt,skyColor:new ls,groundColor:new ls};break;case"RectAreaLight":i={color:new ls,position:new mt,halfWidth:new mt,halfHeight:new mt}}return e[t.id]=i,i}}}let bl=0;function Cl(e,t){return(t.castShadow?2:0)-(e.castShadow?2:0)+(t.map?1:0)-(e.map?1:0)}function vl(e){const t=new gl,i=function(){const e={};return{get:function(t){if(void 0!==e[t.id])return e[t.id];let i;switch(t.type){case"DirectionalLight":case"SpotLight":i={shadowIntensity:1,shadowBias:0,shadowNormalBias:0,shadowRadius:1,shadowMapSize:new pt};break;case"PointLight":i={shadowIntensity:1,shadowBias:0,shadowNormalBias:0,shadowRadius:1,shadowMapSize:new pt,shadowCameraNear:1,shadowCameraFar:1e3}}return e[t.id]=i,i}}}(),s={version:0,hash:{directionalLength:-1,pointLength:-1,spotLength:-1,rectAreaLength:-1,hemiLength:-1,numDirectionalShadows:-1,numPointShadows:-1,numSpotShadows:-1,numSpotMaps:-1,numLightProbes:-1},ambient:[0,0,0],probe:[],directional:[],directionalShadow:[],directionalShadowMap:[],directionalShadowMatrix:[],spot:[],spotLightMap:[],spotShadow:[],spotShadowMap:[],spotLightMatrix:[],rectArea:[],rectAreaLTC1:null,rectAreaLTC2:null,point:[],pointShadow:[],pointShadowMap:[],pointShadowMatrix:[],hemi:[],numSpotLightShadowsWithMaps:0,numLightProbes:0};for(let e=0;e<9;e++)s.probe.push(new mt);const n=new mt,r=new gi,a=new gi;return{setup:function(n){let r=0,a=0,o=0;for(let e=0;e<9;e++)s.probe[e].set(0,0,0);let l=0,d=0,c=0,h=0,p=0,u=0,m=0,f=0,g=0,b=0,C=0;n.sort(Cl);for(let e=0,v=n.length;e<v;e++){const v=n[e],_=v.color,y=v.intensity,S=v.distance,w=v.shadow&&v.shadow.map?v.shadow.map.texture:null;if(v.isAmbientLight)r+=_.r*y,a+=_.g*y,o+=_.b*y;else if(v.isLightProbe){for(let e=0;e<9;e++)s.probe[e].addScaledVector(v.sh.coefficients[e],y);C++}else if(v.isDirectionalLight){const e=t.get(v);if(e.color.copy(v.color).multiplyScalar(v.intensity),v.castShadow){const e=v.shadow,t=i.get(v);t.shadowIntensity=e.intensity,t.shadowBias=e.bias,t.shadowNormalBias=e.normalBias,t.shadowRadius=e.radius,t.shadowMapSize=e.mapSize,s.directionalShadow[l]=t,s.directionalShadowMap[l]=w,s.directionalShadowMatrix[l]=v.shadow.matrix,u++}s.directional[l]=e,l++}else if(v.isSpotLight){const e=t.get(v);e.position.setFromMatrixPosition(v.matrixWorld),e.color.copy(_).multiplyScalar(y),e.distance=S,e.coneCos=Math.cos(v.angle),e.penumbraCos=Math.cos(v.angle*(1-v.penumbra)),e.decay=v.decay,s.spot[c]=e;const n=v.shadow;if(v.map&&(s.spotLightMap[g]=v.map,g++,n.updateMatrices(v),v.castShadow&&b++),s.spotLightMatrix[c]=n.matrix,v.castShadow){const e=i.get(v);e.shadowIntensity=n.intensity,e.shadowBias=n.bias,e.shadowNormalBias=n.normalBias,e.shadowRadius=n.radius,e.shadowMapSize=n.mapSize,s.spotShadow[c]=e,s.spotShadowMap[c]=w,f++}c++}else if(v.isRectAreaLight){const e=t.get(v);e.color.copy(_).multiplyScalar(y),e.halfWidth.set(.5*v.width,0,0),e.halfHeight.set(0,.5*v.height,0),s.rectArea[h]=e,h++}else if(v.isPointLight){const e=t.get(v);if(e.color.copy(v.color).multiplyScalar(v.intensity),e.distance=v.distance,e.decay=v.decay,v.castShadow){const e=v.shadow,t=i.get(v);t.shadowIntensity=e.intensity,t.shadowBias=e.bias,t.shadowNormalBias=e.normalBias,t.shadowRadius=e.radius,t.shadowMapSize=e.mapSize,t.shadowCameraNear=e.camera.near,t.shadowCameraFar=e.camera.far,s.pointShadow[d]=t,s.pointShadowMap[d]=w,s.pointShadowMatrix[d]=v.shadow.matrix,m++}s.point[d]=e,d++}else if(v.isHemisphereLight){const e=t.get(v);e.skyColor.copy(v.color).multiplyScalar(y),e.groundColor.copy(v.groundColor).multiplyScalar(y),s.hemi[p]=e,p++}}h>0&&(!0===e.has("OES_texture_float_linear")?(s.rectAreaLTC1=Qr.LTC_FLOAT_1,s.rectAreaLTC2=Qr.LTC_FLOAT_2):(s.rectAreaLTC1=Qr.LTC_HALF_1,s.rectAreaLTC2=Qr.LTC_HALF_2)),s.ambient[0]=r,s.ambient[1]=a,s.ambient[2]=o;const v=s.hash;v.directionalLength===l&&v.pointLength===d&&v.spotLength===c&&v.rectAreaLength===h&&v.hemiLength===p&&v.numDirectionalShadows===u&&v.numPointShadows===m&&v.numSpotShadows===f&&v.numSpotMaps===g&&v.numLightProbes===C||(s.directional.length=l,s.spot.length=c,s.rectArea.length=h,s.point.length=d,s.hemi.length=p,s.directionalShadow.length=u,s.directionalShadowMap.length=u,s.pointShadow.length=m,s.pointShadowMap.length=m,s.spotShadow.length=f,s.spotShadowMap.length=f,s.directionalShadowMatrix.length=u,s.pointShadowMatrix.length=m,s.spotLightMatrix.length=f+g-b,s.spotLightMap.length=g,s.numSpotLightShadowsWithMaps=b,s.numLightProbes=C,v.directionalLength=l,v.pointLength=d,v.spotLength=c,v.rectAreaLength=h,v.hemiLength=p,v.numDirectionalShadows=u,v.numPointShadows=m,v.numSpotShadows=f,v.numSpotMaps=g,v.numLightProbes=C,s.version=bl++)},setupView:function(e,t){let i=0,o=0,l=0,d=0,c=0;const h=t.matrixWorldInverse;for(let t=0,p=e.length;t<p;t++){const p=e[t];if(p.isDirectionalLight){const e=s.directional[i];e.direction.setFromMatrixPosition(p.matrixWorld),n.setFromMatrixPosition(p.target.matrixWorld),e.direction.sub(n),e.direction.transformDirection(h),i++}else if(p.isSpotLight){const e=s.spot[l];e.position.setFromMatrixPosition(p.matrixWorld),e.position.applyMatrix4(h),e.direction.setFromMatrixPosition(p.matrixWorld),n.setFromMatrixPosition(p.target.matrixWorld),e.direction.sub(n),e.direction.transformDirection(h),l++}else if(p.isRectAreaLight){const e=s.rectArea[d];e.position.setFromMatrixPosition(p.matrixWorld),e.position.applyMatrix4(h),a.identity(),r.copy(p.matrixWorld),r.premultiply(h),a.extractRotation(r),e.halfWidth.set(.5*p.width,0,0),e.halfHeight.set(0,.5*p.height,0),e.halfWidth.applyMatrix4(a),e.halfHeight.applyMatrix4(a),d++}else if(p.isPointLight){const e=s.point[o];e.position.setFromMatrixPosition(p.matrixWorld),e.position.applyMatrix4(h),o++}else if(p.isHemisphereLight){const e=s.hemi[c];e.direction.setFromMatrixPosition(p.matrixWorld),e.direction.transformDirection(h),c++}}},state:s}}function _l(e){const t=new vl(e),i=[],s=[];const n={lightsArray:i,shadowsArray:s,camera:null,lights:t,transmissionRenderTarget:{}};return{init:function(e){n.camera=e,i.length=0,s.length=0},state:n,setupLights:function(){t.setup(i)},setupLightsView:function(e){t.setupView(i,e)},pushLight:function(e){i.push(e)},pushShadow:function(e){s.push(e)}}}function yl(e){let t=new WeakMap;return{get:function(i,s=0){const n=t.get(i);let r;return void 0===n?(r=new _l(e),t.set(i,[r])):s>=n.length?(r=new _l(e),n.push(r)):r=n[s],r},dispose:function(){t=new WeakMap}}}function Sl(e,t,r){let a=new Dn;const o=new pt,l=new pt,d=new Ut,c=new br({depthPacking:3201}),h=new Cr,p={},u=r.maxTextureSize,m={[i]:1,[s]:0,[n]:2},f=new Vs({defines:{VSM_SAMPLES:8},uniforms:{shadow_pass:{value:null},resolution:{value:new pt},radius:{value:4}},vertexShader:"void main() {\n\tgl_Position = vec4( position, 1.0 );\n}",fragmentShader:"uniform sampler2D shadow_pass;\nuniform vec2 resolution;\nuniform float radius;\n#include <packing>\nvoid main() {\n\tconst float samples = float( VSM_SAMPLES );\n\tfloat mean = 0.0;\n\tfloat squared_mean = 0.0;\n\tfloat uvStride = samples <= 1.0 ? 0.0 : 2.0 / ( samples - 1.0 );\n\tfloat uvStart = samples <= 1.0 ? 0.0 : - 1.0;\n\tfor ( float i = 0.0; i < samples; i ++ ) {\n\t\tfloat uvOffset = uvStart + i * uvStride;\n\t\t#ifdef HORIZONTAL_PASS\n\t\t\tvec2 distribution = unpackRGBATo2Half( texture2D( shadow_pass, ( gl_FragCoord.xy + vec2( uvOffset, 0.0 ) * radius ) / resolution ) );\n\t\t\tmean += distribution.x;\n\t\t\tsquared_mean += distribution.y * distribution.y + distribution.x * distribution.x;\n\t\t#else\n\t\t\tfloat depth = unpackRGBAToDepth( texture2D( shadow_pass, ( gl_FragCoord.xy + vec2( 0.0, uvOffset ) * radius ) / resolution ) );\n\t\t\tmean += depth;\n\t\t\tsquared_mean += depth * depth;\n\t\t#endif\n\t}\n\tmean = mean / samples;\n\tsquared_mean = squared_mean / samples;\n\tfloat std_dev = sqrt( squared_mean - mean * mean );\n\tgl_FragColor = pack2HalfToRGBA( vec2( mean, std_dev ) );\n}"}),g=f.clone();g.defines.HORIZONTAL_PASS=1;const b=new Ts;b.setAttribute("position",new gs(new Float32Array([-1,-1,.5,3,-1,.5,-1,3,.5]),3));const C=new Hs(b,f),v=this;this.enabled=!1,this.autoUpdate=!0,this.needsUpdate=!1,this.type=1;let _=this.type;function y(i,s){const n=t.update(C);f.defines.VSM_SAMPLES!==i.blurSamples&&(f.defines.VSM_SAMPLES=i.blurSamples,g.defines.VSM_SAMPLES=i.blurSamples,f.needsUpdate=!0,g.needsUpdate=!0),null===i.mapPass&&(i.mapPass=new Bt(o.x,o.y)),f.uniforms.shadow_pass.value=i.map.texture,f.uniforms.resolution.value=i.mapSize,f.uniforms.radius.value=i.radius,e.setRenderTarget(i.mapPass),e.clear(),e.renderBufferDirect(s,null,n,f,C,null),g.uniforms.shadow_pass.value=i.mapPass.texture,g.uniforms.resolution.value=i.mapSize,g.uniforms.radius.value=i.radius,e.setRenderTarget(i.map),e.clear(),e.renderBufferDirect(s,null,n,g,C,null)}function S(t,i,s,n){let r=null;const a=!0===s.isPointLight?t.customDistanceMaterial:t.customDepthMaterial;if(void 0!==a)r=a;else if(r=!0===s.isPointLight?h:c,e.localClippingEnabled&&!0===i.clipShadows&&Array.isArray(i.clippingPlanes)&&0!==i.clippingPlanes.length||i.displacementMap&&0!==i.displacementScale||i.alphaMap&&i.alphaTest>0||i.map&&i.alphaTest>0||!0===i.alphaToCoverage){const e=r.uuid,t=i.uuid;let s=p[e];void 0===s&&(s={},p[e]=s);let n=s[t];void 0===n&&(n=r.clone(),s[t]=n,i.addEventListener("dispose",x)),r=n}if(r.visible=i.visible,r.wireframe=i.wireframe,r.side=3===n?null!==i.shadowSide?i.shadowSide:i.side:null!==i.shadowSide?i.shadowSide:m[i.side],r.alphaMap=i.alphaMap,r.alphaTest=!0===i.alphaToCoverage?.5:i.alphaTest,r.map=i.map,r.clipShadows=i.clipShadows,r.clippingPlanes=i.clippingPlanes,r.clipIntersection=i.clipIntersection,r.displacementMap=i.displacementMap,r.displacementScale=i.displacementScale,r.displacementBias=i.displacementBias,r.wireframeLinewidth=i.wireframeLinewidth,r.linewidth=i.linewidth,!0===s.isPointLight&&!0===r.isMeshDistanceMaterial){e.properties.get(r).light=s}return r}function w(i,s,n,r,o){if(!1===i.visible)return;if(i.layers.test(s.layers)&&(i.isMesh||i.isLine||i.isPoints)&&(i.castShadow||i.receiveShadow&&3===o)&&(!i.frustumCulled||a.intersectsObject(i))){i.modelViewMatrix.multiplyMatrices(n.matrixWorldInverse,i.matrixWorld);const a=t.update(i),l=i.material;if(Array.isArray(l)){const t=a.groups;for(let d=0,c=t.length;d<c;d++){const c=t[d],h=l[c.materialIndex];if(h&&h.visible){const t=S(i,h,r,o);i.onBeforeShadow(e,i,s,n,a,t,c),e.renderBufferDirect(n,null,a,t,i,c),i.onAfterShadow(e,i,s,n,a,t,c)}}}else if(l.visible){const t=S(i,l,r,o);i.onBeforeShadow(e,i,s,n,a,t,null),e.renderBufferDirect(n,null,a,t,i,null),i.onAfterShadow(e,i,s,n,a,t,null)}}const l=i.children;for(let e=0,t=l.length;e<t;e++)w(l[e],s,n,r,o)}function x(e){e.target.removeEventListener("dispose",x);for(const t in p){const i=p[t],s=e.target.uuid;if(s in i){i[s].dispose(),delete i[s]}}}this.render=function(t,i,s){if(!1===v.enabled)return;if(!1===v.autoUpdate&&!1===v.needsUpdate)return;if(0===t.length)return;const n=e.getRenderTarget(),r=e.getActiveCubeFace(),c=e.getActiveMipmapLevel(),h=e.state;h.setBlending(0),h.buffers.color.setClear(1,1,1,1),h.buffers.depth.setTest(!0),h.setScissorTest(!1);const p=3!==_&&3===this.type,m=3===_&&3!==this.type;for(let n=0,r=t.length;n<r;n++){const r=t[n],c=r.shadow;if(void 0===c){console.warn("THREE.WebGLShadowMap:",r,"has no shadow.");continue}if(!1===c.autoUpdate&&!1===c.needsUpdate)continue;o.copy(c.mapSize);const f=c.getFrameExtents();if(o.multiply(f),l.copy(c.mapSize),(o.x>u||o.y>u)&&(o.x>u&&(l.x=Math.floor(u/f.x),o.x=l.x*f.x,c.mapSize.x=l.x),o.y>u&&(l.y=Math.floor(u/f.y),o.y=l.y*f.y,c.mapSize.y=l.y)),null===c.map||!0===p||!0===m){const e=3!==this.type?{minFilter:N,magFilter:N}:{};null!==c.map&&c.map.dispose(),c.map=new Bt(o.x,o.y,e),c.map.texture.name=r.name+".shadowMap",c.camera.updateProjectionMatrix()}e.setRenderTarget(c.map),e.clear();const g=c.getViewportCount();for(let e=0;e<g;e++){const t=c.getViewport(e);d.set(l.x*t.x,l.y*t.y,l.x*t.z,l.y*t.w),h.viewport(d),c.updateMatrices(r,e),a=c.getFrustum(),w(i,s,c.camera,r,this.type)}!0!==c.isPointLightShadow&&3===this.type&&y(c,s),c.needsUpdate=!1}_=this.type,v.needsUpdate=!1,e.setRenderTarget(n,r,c)}}const wl={[w]:1,[A]:6,[T]:7,[M]:5,[x]:0,[R]:2,[k]:4,[E]:3};function xl(e,t){const i=new function(){let t=!1;const i=new Ut;let s=null;const n=new Ut(0,0,0,0);return{setMask:function(i){s===i||t||(e.colorMask(i,i,i,i),s=i)},setLocked:function(e){t=e},setClear:function(t,s,r,a,o){!0===o&&(t*=a,s*=a,r*=a),i.set(t,s,r,a),!1===n.equals(i)&&(e.clearColor(t,s,r,a),n.copy(i))},reset:function(){t=!1,s=null,n.set(-1,0,0,0)}}},s=new function(){let i=!1,s=!1,n=null,r=null,a=null;return{setReversed:function(e){if(s!==e){const i=t.get("EXT_clip_control");e?i.clipControlEXT(i.LOWER_LEFT_EXT,i.ZERO_TO_ONE_EXT):i.clipControlEXT(i.LOWER_LEFT_EXT,i.NEGATIVE_ONE_TO_ONE_EXT),s=e;const n=a;a=null,this.setClear(n)}},getReversed:function(){return s},setTest:function(t){t?ne(e.DEPTH_TEST):re(e.DEPTH_TEST)},setMask:function(t){n===t||i||(e.depthMask(t),n=t)},setFunc:function(t){if(s&&(t=wl[t]),r!==t){switch(t){case 0:e.depthFunc(e.NEVER);break;case 1:e.depthFunc(e.ALWAYS);break;case 2:e.depthFunc(e.LESS);break;case 3:default:e.depthFunc(e.LEQUAL);break;case 4:e.depthFunc(e.EQUAL);break;case 5:e.depthFunc(e.GEQUAL);break;case 6:e.depthFunc(e.GREATER);break;case 7:e.depthFunc(e.NOTEQUAL)}r=t}},setLocked:function(e){i=e},setClear:function(t){a!==t&&(s&&(t=1-t),e.clearDepth(t),a=t)},reset:function(){i=!1,n=null,r=null,a=null,s=!1}}},n=new function(){let t=!1,i=null,s=null,n=null,r=null,a=null,o=null,l=null,d=null;return{setTest:function(i){t||(i?ne(e.STENCIL_TEST):re(e.STENCIL_TEST))},setMask:function(s){i===s||t||(e.stencilMask(s),i=s)},setFunc:function(t,i,a){s===t&&n===i&&r===a||(e.stencilFunc(t,i,a),s=t,n=i,r=a)},setOp:function(t,i,s){a===t&&o===i&&l===s||(e.stencilOp(t,i,s),a=t,o=i,l=s)},setLocked:function(e){t=e},setClear:function(t){d!==t&&(e.clearStencil(t),d=t)},reset:function(){t=!1,i=null,s=null,n=null,r=null,a=null,o=null,l=null,d=null}}},w=new WeakMap,x=new WeakMap;let A={},M={},T=new WeakMap,E=[],R=null,k=!1,O=null,I=null,P=null,D=null,L=null,F=null,N=null,U=new ls(0,0,0),H=0,B=!1,z=null,q=null,j=null,G=null,$=null;const V=e.getParameter(e.MAX_COMBINED_TEXTURE_IMAGE_UNITS);let W=!1,X=0;const Y=e.getParameter(e.VERSION);-1!==Y.indexOf("WebGL")?(X=parseFloat(/^WebGL (\d)/.exec(Y)[1]),W=X>=1):-1!==Y.indexOf("OpenGL ES")&&(X=parseFloat(/^OpenGL ES (\d)/.exec(Y)[1]),W=X>=2);let K=null,Z={};const J=e.getParameter(e.SCISSOR_BOX),Q=e.getParameter(e.VIEWPORT),ee=(new Ut).fromArray(J),te=(new Ut).fromArray(Q);function ie(t,i,s,n){const r=new Uint8Array(4),a=e.createTexture();e.bindTexture(t,a),e.texParameteri(t,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(t,e.TEXTURE_MAG_FILTER,e.NEAREST);for(let a=0;a<s;a++)t===e.TEXTURE_3D||t===e.TEXTURE_2D_ARRAY?e.texImage3D(i,0,e.RGBA,1,1,n,0,e.RGBA,e.UNSIGNED_BYTE,r):e.texImage2D(i+a,0,e.RGBA,1,1,0,e.RGBA,e.UNSIGNED_BYTE,r);return a}const se={};function ne(t){!0!==A[t]&&(e.enable(t),A[t]=!0)}function re(t){!1!==A[t]&&(e.disable(t),A[t]=!1)}se[e.TEXTURE_2D]=ie(e.TEXTURE_2D,e.TEXTURE_2D,1),se[e.TEXTURE_CUBE_MAP]=ie(e.TEXTURE_CUBE_MAP,e.TEXTURE_CUBE_MAP_POSITIVE_X,6),se[e.TEXTURE_2D_ARRAY]=ie(e.TEXTURE_2D_ARRAY,e.TEXTURE_2D_ARRAY,1,1),se[e.TEXTURE_3D]=ie(e.TEXTURE_3D,e.TEXTURE_3D,1,1),i.setClear(0,0,0,1),s.setClear(1),n.setClear(0),ne(e.DEPTH_TEST),s.setFunc(3),de(!1),ce(1),ne(e.CULL_FACE),le(0);const ae={[r]:e.FUNC_ADD,[a]:e.FUNC_SUBTRACT,[o]:e.FUNC_REVERSE_SUBTRACT};ae[103]=e.MIN,ae[104]=e.MAX;const oe={[l]:e.ZERO,[d]:e.ONE,[c]:e.SRC_COLOR,[p]:e.SRC_ALPHA,[C]:e.SRC_ALPHA_SATURATE,[g]:e.DST_COLOR,[m]:e.DST_ALPHA,[h]:e.ONE_MINUS_SRC_COLOR,[u]:e.ONE_MINUS_SRC_ALPHA,[b]:e.ONE_MINUS_DST_COLOR,[f]:e.ONE_MINUS_DST_ALPHA,[v]:e.CONSTANT_COLOR,[_]:e.ONE_MINUS_CONSTANT_COLOR,[y]:e.CONSTANT_ALPHA,[S]:e.ONE_MINUS_CONSTANT_ALPHA};function le(t,i,s,n,a,o,l,d,c,h){if(0!==t){if(!1===k&&(ne(e.BLEND),k=!0),5===t)a=a||i,o=o||s,l=l||n,i===I&&a===L||(e.blendEquationSeparate(ae[i],ae[a]),I=i,L=a),s===P&&n===D&&o===F&&l===N||(e.blendFuncSeparate(oe[s],oe[n],oe[o],oe[l]),P=s,D=n,F=o,N=l),!1!==d.equals(U)&&c===H||(e.blendColor(d.r,d.g,d.b,c),U.copy(d),H=c),O=t,B=!1;else if(t!==O||h!==B){if(I===r&&L===r||(e.blendEquation(e.FUNC_ADD),I=r,L=r),h)switch(t){case 1:e.blendFuncSeparate(e.ONE,e.ONE_MINUS_SRC_ALPHA,e.ONE,e.ONE_MINUS_SRC_ALPHA);break;case 2:e.blendFunc(e.ONE,e.ONE);break;case 3:e.blendFuncSeparate(e.ZERO,e.ONE_MINUS_SRC_COLOR,e.ZERO,e.ONE);break;case 4:e.blendFuncSeparate(e.ZERO,e.SRC_COLOR,e.ZERO,e.SRC_ALPHA);break;default:console.error("THREE.WebGLState: Invalid blending: ",t)}else switch(t){case 1:e.blendFuncSeparate(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA,e.ONE,e.ONE_MINUS_SRC_ALPHA);break;case 2:e.blendFunc(e.SRC_ALPHA,e.ONE);break;case 3:e.blendFuncSeparate(e.ZERO,e.ONE_MINUS_SRC_COLOR,e.ZERO,e.ONE);break;case 4:e.blendFunc(e.ZERO,e.SRC_COLOR);break;default:console.error("THREE.WebGLState: Invalid blending: ",t)}P=null,D=null,F=null,N=null,U.set(0,0,0),H=0,O=t,B=h}}else!0===k&&(re(e.BLEND),k=!1)}function de(t){z!==t&&(t?e.frontFace(e.CW):e.frontFace(e.CCW),z=t)}function ce(t){0!==t?(ne(e.CULL_FACE),t!==q&&(1===t?e.cullFace(e.BACK):2===t?e.cullFace(e.FRONT):e.cullFace(e.FRONT_AND_BACK))):re(e.CULL_FACE),q=t}function he(t,i,s){t?(ne(e.POLYGON_OFFSET_FILL),G===i&&$===s||(e.polygonOffset(i,s),G=i,$=s)):re(e.POLYGON_OFFSET_FILL)}return{buffers:{color:i,depth:s,stencil:n},enable:ne,disable:re,bindFramebuffer:function(t,i){return M[t]!==i&&(e.bindFramebuffer(t,i),M[t]=i,t===e.DRAW_FRAMEBUFFER&&(M[e.FRAMEBUFFER]=i),t===e.FRAMEBUFFER&&(M[e.DRAW_FRAMEBUFFER]=i),!0)},drawBuffers:function(t,i){let s=E,n=!1;if(t){s=T.get(i),void 0===s&&(s=[],T.set(i,s));const r=t.textures;if(s.length!==r.length||s[0]!==e.COLOR_ATTACHMENT0){for(let t=0,i=r.length;t<i;t++)s[t]=e.COLOR_ATTACHMENT0+t;s.length=r.length,n=!0}}else s[0]!==e.BACK&&(s[0]=e.BACK,n=!0);n&&e.drawBuffers(s)},useProgram:function(t){return R!==t&&(e.useProgram(t),R=t,!0)},setBlending:le,setMaterial:function(t,r){2===t.side?re(e.CULL_FACE):ne(e.CULL_FACE);let a=1===t.side;r&&(a=!a),de(a),1===t.blending&&!1===t.transparent?le(0):le(t.blending,t.blendEquation,t.blendSrc,t.blendDst,t.blendEquationAlpha,t.blendSrcAlpha,t.blendDstAlpha,t.blendColor,t.blendAlpha,t.premultipliedAlpha),s.setFunc(t.depthFunc),s.setTest(t.depthTest),s.setMask(t.depthWrite),i.setMask(t.colorWrite);const o=t.stencilWrite;n.setTest(o),o&&(n.setMask(t.stencilWriteMask),n.setFunc(t.stencilFunc,t.stencilRef,t.stencilFuncMask),n.setOp(t.stencilFail,t.stencilZFail,t.stencilZPass)),he(t.polygonOffset,t.polygonOffsetFactor,t.polygonOffsetUnits),!0===t.alphaToCoverage?ne(e.SAMPLE_ALPHA_TO_COVERAGE):re(e.SAMPLE_ALPHA_TO_COVERAGE)},setFlipSided:de,setCullFace:ce,setLineWidth:function(t){t!==j&&(W&&e.lineWidth(t),j=t)},setPolygonOffset:he,setScissorTest:function(t){t?ne(e.SCISSOR_TEST):re(e.SCISSOR_TEST)},activeTexture:function(t){void 0===t&&(t=e.TEXTURE0+V-1),K!==t&&(e.activeTexture(t),K=t)},bindTexture:function(t,i,s){void 0===s&&(s=null===K?e.TEXTURE0+V-1:K);let n=Z[s];void 0===n&&(n={type:void 0,texture:void 0},Z[s]=n),n.type===t&&n.texture===i||(K!==s&&(e.activeTexture(s),K=s),e.bindTexture(t,i||se[t]),n.type=t,n.texture=i)},unbindTexture:function(){const t=Z[K];void 0!==t&&void 0!==t.type&&(e.bindTexture(t.type,null),t.type=void 0,t.texture=void 0)},compressedTexImage2D:function(){try{e.compressedTexImage2D(...arguments)}catch(e){console.error("THREE.WebGLState:",e)}},compressedTexImage3D:function(){try{e.compressedTexImage3D(...arguments)}catch(e){console.error("THREE.WebGLState:",e)}},texImage2D:function(){try{e.texImage2D(...arguments)}catch(e){console.error("THREE.WebGLState:",e)}},texImage3D:function(){try{e.texImage3D(...arguments)}catch(e){console.error("THREE.WebGLState:",e)}},updateUBOMapping:function(t,i){let s=x.get(i);void 0===s&&(s=new WeakMap,x.set(i,s));let n=s.get(t);void 0===n&&(n=e.getUniformBlockIndex(i,t.name),s.set(t,n))},uniformBlockBinding:function(t,i){const s=x.get(i).get(t);w.get(i)!==s&&(e.uniformBlockBinding(i,s,t.__bindingPointIndex),w.set(i,s))},texStorage2D:function(){try{e.texStorage2D(...arguments)}catch(e){console.error("THREE.WebGLState:",e)}},texStorage3D:function(){try{e.texStorage3D(...arguments)}catch(e){console.error("THREE.WebGLState:",e)}},texSubImage2D:function(){try{e.texSubImage2D(...arguments)}catch(e){console.error("THREE.WebGLState:",e)}},texSubImage3D:function(){try{e.texSubImage3D(...arguments)}catch(e){console.error("THREE.WebGLState:",e)}},compressedTexSubImage2D:function(){try{e.compressedTexSubImage2D(...arguments)}catch(e){console.error("THREE.WebGLState:",e)}},compressedTexSubImage3D:function(){try{e.compressedTexSubImage3D(...arguments)}catch(e){console.error("THREE.WebGLState:",e)}},scissor:function(t){!1===ee.equals(t)&&(e.scissor(t.x,t.y,t.z,t.w),ee.copy(t))},viewport:function(t){!1===te.equals(t)&&(e.viewport(t.x,t.y,t.z,t.w),te.copy(t))},reset:function(){e.disable(e.BLEND),e.disable(e.CULL_FACE),e.disable(e.DEPTH_TEST),e.disable(e.POLYGON_OFFSET_FILL),e.disable(e.SCISSOR_TEST),e.disable(e.STENCIL_TEST),e.disable(e.SAMPLE_ALPHA_TO_COVERAGE),e.blendEquation(e.FUNC_ADD),e.blendFunc(e.ONE,e.ZERO),e.blendFuncSeparate(e.ONE,e.ZERO,e.ONE,e.ZERO),e.blendColor(0,0,0,0),e.colorMask(!0,!0,!0,!0),e.clearColor(0,0,0,0),e.depthMask(!0),e.depthFunc(e.LESS),s.setReversed(!1),e.clearDepth(1),e.stencilMask(4294967295),e.stencilFunc(e.ALWAYS,0,4294967295),e.stencilOp(e.KEEP,e.KEEP,e.KEEP),e.clearStencil(0),e.cullFace(e.BACK),e.frontFace(e.CCW),e.polygonOffset(0,0),e.activeTexture(e.TEXTURE0),e.bindFramebuffer(e.FRAMEBUFFER,null),e.bindFramebuffer(e.DRAW_FRAMEBUFFER,null),e.bindFramebuffer(e.READ_FRAMEBUFFER,null),e.useProgram(null),e.lineWidth(1),e.scissor(0,0,e.canvas.width,e.canvas.height),e.viewport(0,0,e.canvas.width,e.canvas.height),A={},K=null,Z={},M={},T=new WeakMap,E=[],R=null,k=!1,O=null,I=null,P=null,D=null,L=null,F=null,N=null,U=new ls(0,0,0),H=0,B=!1,z=null,q=null,j=null,G=null,$=null,ee.set(0,0,e.canvas.width,e.canvas.height),te.set(0,0,e.canvas.width,e.canvas.height),i.reset(),s.reset(),n.reset()}}}function Al(e,t,i,s,n,r,a){const o=t.has("WEBGL_multisampled_render_to_texture")?t.get("WEBGL_multisampled_render_to_texture"):null,l="undefined"!=typeof navigator&&/OculusBrowser/g.test(navigator.userAgent),d=new pt,c=new WeakMap;let h;const p=new WeakMap;let u=!1;try{u="undefined"!=typeof OffscreenCanvas&&null!==new OffscreenCanvas(1,1).getContext("2d")}catch(e){}function m(e,t){return u?new OffscreenCanvas(e,t):_t("canvas")}function f(e,t,i){let s=1;const n=ae(e);if((n.width>i||n.height>i)&&(s=i/Math.max(n.width,n.height)),s<1){if("undefined"!=typeof HTMLImageElement&&e instanceof HTMLImageElement||"undefined"!=typeof HTMLCanvasElement&&e instanceof HTMLCanvasElement||"undefined"!=typeof ImageBitmap&&e instanceof ImageBitmap||"undefined"!=typeof VideoFrame&&e instanceof VideoFrame){const i=Math.floor(s*n.width),r=Math.floor(s*n.height);void 0===h&&(h=m(i,r));const a=t?m(i,r):h;a.width=i,a.height=r;return a.getContext("2d").drawImage(e,0,0,i,r),console.warn("THREE.WebGLRenderer: Texture has been resized from ("+n.width+"x"+n.height+") to ("+i+"x"+r+")."),a}return"data"in e&&console.warn("THREE.WebGLRenderer: Image in DataTexture is too big ("+n.width+"x"+n.height+")."),e}return e}function g(e){return e.generateMipmaps}function b(t){e.generateMipmap(t)}function C(t){return t.isWebGLCubeRenderTarget?e.TEXTURE_CUBE_MAP:t.isWebGL3DRenderTarget?e.TEXTURE_3D:t.isWebGLArrayRenderTarget||t.isCompressedArrayTexture?e.TEXTURE_2D_ARRAY:e.TEXTURE_2D}function v(i,s,n,r,a=!1){if(null!==i){if(void 0!==e[i])return e[i];console.warn("THREE.WebGLRenderer: Attempt to use non-existing WebGL internal format '"+i+"'")}let o=s;if(s===e.RED&&(n===e.FLOAT&&(o=e.R32F),n===e.HALF_FLOAT&&(o=e.R16F),n===e.UNSIGNED_BYTE&&(o=e.R8)),s===e.RED_INTEGER&&(n===e.UNSIGNED_BYTE&&(o=e.R8UI),n===e.UNSIGNED_SHORT&&(o=e.R16UI),n===e.UNSIGNED_INT&&(o=e.R32UI),n===e.BYTE&&(o=e.R8I),n===e.SHORT&&(o=e.R16I),n===e.INT&&(o=e.R32I)),s===e.RG&&(n===e.FLOAT&&(o=e.RG32F),n===e.HALF_FLOAT&&(o=e.RG16F),n===e.UNSIGNED_BYTE&&(o=e.RG8)),s===e.RG_INTEGER&&(n===e.UNSIGNED_BYTE&&(o=e.RG8UI),n===e.UNSIGNED_SHORT&&(o=e.RG16UI),n===e.UNSIGNED_INT&&(o=e.RG32UI),n===e.BYTE&&(o=e.RG8I),n===e.SHORT&&(o=e.RG16I),n===e.INT&&(o=e.RG32I)),s===e.RGB_INTEGER&&(n===e.UNSIGNED_BYTE&&(o=e.RGB8UI),n===e.UNSIGNED_SHORT&&(o=e.RGB16UI),n===e.UNSIGNED_INT&&(o=e.RGB32UI),n===e.BYTE&&(o=e.RGB8I),n===e.SHORT&&(o=e.RGB16I),n===e.INT&&(o=e.RGB32I)),s===e.RGBA_INTEGER&&(n===e.UNSIGNED_BYTE&&(o=e.RGBA8UI),n===e.UNSIGNED_SHORT&&(o=e.RGBA16UI),n===e.UNSIGNED_INT&&(o=e.RGBA32UI),n===e.BYTE&&(o=e.RGBA8I),n===e.SHORT&&(o=e.RGBA16I),n===e.INT&&(o=e.RGBA32I)),s===e.RGB&&n===e.UNSIGNED_INT_5_9_9_9_REV&&(o=e.RGB9_E5),s===e.RGBA){const t=a?qe:Tt.getTransfer(r);n===e.FLOAT&&(o=e.RGBA32F),n===e.HALF_FLOAT&&(o=e.RGBA16F),n===e.UNSIGNED_BYTE&&(o=t===je?e.SRGB8_ALPHA8:e.RGBA8),n===e.UNSIGNED_SHORT_4_4_4_4&&(o=e.RGBA4),n===e.UNSIGNED_SHORT_5_5_5_1&&(o=e.RGB5_A1)}return o!==e.R16F&&o!==e.R32F&&o!==e.RG16F&&o!==e.RG32F&&o!==e.RGBA16F&&o!==e.RGBA32F||t.get("EXT_color_buffer_float"),o}function _(t,i){let s;return t?null===i||i===Y||i===ee?s=e.DEPTH24_STENCIL8:i===K?s=e.DEPTH32F_STENCIL8:i===W&&(s=e.DEPTH24_STENCIL8,console.warn("DepthTexture: 16 bit depth attachment is not supported with stencil. Using 24-bit attachment.")):null===i||i===Y||i===ee?s=e.DEPTH_COMPONENT24:i===K?s=e.DEPTH_COMPONENT32F:i===W&&(s=e.DEPTH_COMPONENT16),s}function y(e,t){return!0===g(e)||e.isFramebufferTexture&&e.minFilter!==N&&e.minFilter!==B?Math.log2(Math.max(t.width,t.height))+1:void 0!==e.mipmaps&&e.mipmaps.length>0?e.mipmaps.length:e.isCompressedTexture&&Array.isArray(e.image)?t.mipmaps.length:1}function S(e){const t=e.target;t.removeEventListener("dispose",S),function(e){const t=s.get(e);if(void 0===t.__webglInit)return;const i=e.source,n=p.get(i);if(n){const s=n[t.__cacheKey];s.usedTimes--,0===s.usedTimes&&x(e),0===Object.keys(n).length&&p.delete(i)}s.remove(e)}(t),t.isVideoTexture&&c.delete(t)}function w(t){const i=t.target;i.removeEventListener("dispose",w),function(t){const i=s.get(t);t.depthTexture&&(t.depthTexture.dispose(),s.remove(t.depthTexture));if(t.isWebGLCubeRenderTarget)for(let t=0;t<6;t++){if(Array.isArray(i.__webglFramebuffer[t]))for(let s=0;s<i.__webglFramebuffer[t].length;s++)e.deleteFramebuffer(i.__webglFramebuffer[t][s]);else e.deleteFramebuffer(i.__webglFramebuffer[t]);i.__webglDepthbuffer&&e.deleteRenderbuffer(i.__webglDepthbuffer[t])}else{if(Array.isArray(i.__webglFramebuffer))for(let t=0;t<i.__webglFramebuffer.length;t++)e.deleteFramebuffer(i.__webglFramebuffer[t]);else e.deleteFramebuffer(i.__webglFramebuffer);if(i.__webglDepthbuffer&&e.deleteRenderbuffer(i.__webglDepthbuffer),i.__webglMultisampledFramebuffer&&e.deleteFramebuffer(i.__webglMultisampledFramebuffer),i.__webglColorRenderbuffer)for(let t=0;t<i.__webglColorRenderbuffer.length;t++)i.__webglColorRenderbuffer[t]&&e.deleteRenderbuffer(i.__webglColorRenderbuffer[t]);i.__webglDepthRenderbuffer&&e.deleteRenderbuffer(i.__webglDepthRenderbuffer)}const n=t.textures;for(let t=0,i=n.length;t<i;t++){const i=s.get(n[t]);i.__webglTexture&&(e.deleteTexture(i.__webglTexture),a.memory.textures--),s.remove(n[t])}s.remove(t)}(i)}function x(t){const i=s.get(t);e.deleteTexture(i.__webglTexture);const n=t.source;delete p.get(n)[i.__cacheKey],a.memory.textures--}let A=0;function M(t,n){const r=s.get(t);if(t.isVideoTexture&&function(e){const t=a.render.frame;c.get(e)!==t&&(c.set(e,t),e.update())}(t),!1===t.isRenderTargetTexture&&t.version>0&&r.__version!==t.version){const e=t.image;if(null===e)console.warn("THREE.WebGLRenderer: Texture marked for update but no image data found.");else{if(!1!==e.complete)return void P(r,t,n);console.warn("THREE.WebGLRenderer: Texture marked for update but image is incomplete")}}i.bindTexture(e.TEXTURE_2D,r.__webglTexture,e.TEXTURE0+n)}const T={[D]:e.REPEAT,[L]:e.CLAMP_TO_EDGE,[F]:e.MIRRORED_REPEAT},E={[N]:e.NEAREST,[U]:e.NEAREST_MIPMAP_NEAREST,[H]:e.NEAREST_MIPMAP_LINEAR,[B]:e.LINEAR,[z]:e.LINEAR_MIPMAP_NEAREST,[q]:e.LINEAR_MIPMAP_LINEAR},R={[$e]:e.NEVER,[Je]:e.ALWAYS,[Ve]:e.LESS,[Xe]:e.LEQUAL,[We]:e.EQUAL,[Ze]:e.GEQUAL,[Ye]:e.GREATER,[Ke]:e.NOTEQUAL};function k(i,r){if(r.type!==K||!1!==t.has("OES_texture_float_linear")||r.magFilter!==B&&r.magFilter!==z&&r.magFilter!==H&&r.magFilter!==q&&r.minFilter!==B&&r.minFilter!==z&&r.minFilter!==H&&r.minFilter!==q||console.warn("THREE.WebGLRenderer: Unable to use linear filtering with floating point textures. OES_texture_float_linear not supported on this device."),e.texParameteri(i,e.TEXTURE_WRAP_S,T[r.wrapS]),e.texParameteri(i,e.TEXTURE_WRAP_T,T[r.wrapT]),i!==e.TEXTURE_3D&&i!==e.TEXTURE_2D_ARRAY||e.texParameteri(i,e.TEXTURE_WRAP_R,T[r.wrapR]),e.texParameteri(i,e.TEXTURE_MAG_FILTER,E[r.magFilter]),e.texParameteri(i,e.TEXTURE_MIN_FILTER,E[r.minFilter]),r.compareFunction&&(e.texParameteri(i,e.TEXTURE_COMPARE_MODE,e.COMPARE_REF_TO_TEXTURE),e.texParameteri(i,e.TEXTURE_COMPARE_FUNC,R[r.compareFunction])),!0===t.has("EXT_texture_filter_anisotropic")){if(r.magFilter===N)return;if(r.minFilter!==H&&r.minFilter!==q)return;if(r.type===K&&!1===t.has("OES_texture_float_linear"))return;if(r.anisotropy>1||s.get(r).__currentAnisotropy){const a=t.get("EXT_texture_filter_anisotropic");e.texParameterf(i,a.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(r.anisotropy,n.getMaxAnisotropy())),s.get(r).__currentAnisotropy=r.anisotropy}}}function O(t,i){let s=!1;void 0===t.__webglInit&&(t.__webglInit=!0,i.addEventListener("dispose",S));const n=i.source;let r=p.get(n);void 0===r&&(r={},p.set(n,r));const o=function(e){const t=[];return t.push(e.wrapS),t.push(e.wrapT),t.push(e.wrapR||0),t.push(e.magFilter),t.push(e.minFilter),t.push(e.anisotropy),t.push(e.internalFormat),t.push(e.format),t.push(e.type),t.push(e.generateMipmaps),t.push(e.premultiplyAlpha),t.push(e.flipY),t.push(e.unpackAlignment),t.push(e.colorSpace),t.join()}(i);if(o!==t.__cacheKey){void 0===r[o]&&(r[o]={texture:e.createTexture(),usedTimes:0},a.memory.textures++,s=!0),r[o].usedTimes++;const n=r[t.__cacheKey];void 0!==n&&(r[t.__cacheKey].usedTimes--,0===n.usedTimes&&x(i)),t.__cacheKey=o,t.__webglTexture=r[o].texture}return s}function I(e,t,i){return Math.floor(Math.floor(e/i)/t)}function P(t,a,o){let l=e.TEXTURE_2D;(a.isDataArrayTexture||a.isCompressedArrayTexture)&&(l=e.TEXTURE_2D_ARRAY),a.isData3DTexture&&(l=e.TEXTURE_3D);const d=O(t,a),c=a.source;i.bindTexture(l,t.__webglTexture,e.TEXTURE0+o);const h=s.get(c);if(c.version!==h.__version||!0===d){i.activeTexture(e.TEXTURE0+o);const t=Tt.getPrimaries(Tt.workingColorSpace),s=a.colorSpace===He?null:Tt.getPrimaries(a.colorSpace),p=a.colorSpace===He||t===s?e.NONE:e.BROWSER_DEFAULT_WEBGL;e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,a.flipY),e.pixelStorei(e.UNPACK_PREMULTIPLY_ALPHA_WEBGL,a.premultiplyAlpha),e.pixelStorei(e.UNPACK_ALIGNMENT,a.unpackAlignment),e.pixelStorei(e.UNPACK_COLORSPACE_CONVERSION_WEBGL,p);let u=f(a.image,!1,n.maxTextureSize);u=re(a,u);const m=r.convert(a.format,a.colorSpace),C=r.convert(a.type);let S,w=v(a.internalFormat,m,C,a.colorSpace,a.isVideoTexture);k(l,a);const x=a.mipmaps,A=!0!==a.isVideoTexture,M=void 0===h.__version||!0===d,T=c.dataReady,E=y(a,u);if(a.isDepthTexture)w=_(a.format===ne,a.type),M&&(A?i.texStorage2D(e.TEXTURE_2D,1,w,u.width,u.height):i.texImage2D(e.TEXTURE_2D,0,w,u.width,u.height,0,m,C,null));else if(a.isDataTexture)if(x.length>0){A&&M&&i.texStorage2D(e.TEXTURE_2D,E,w,x[0].width,x[0].height);for(let t=0,s=x.length;t<s;t++)S=x[t],A?T&&i.texSubImage2D(e.TEXTURE_2D,t,0,0,S.width,S.height,m,C,S.data):i.texImage2D(e.TEXTURE_2D,t,w,S.width,S.height,0,m,C,S.data);a.generateMipmaps=!1}else A?(M&&i.texStorage2D(e.TEXTURE_2D,E,w,u.width,u.height),T&&function(t,s,n,r){const a=t.updateRanges;if(0===a.length)i.texSubImage2D(e.TEXTURE_2D,0,0,0,s.width,s.height,n,r,s.data);else{a.sort(((e,t)=>e.start-t.start));let o=0;for(let e=1;e<a.length;e++){const t=a[o],i=a[e],n=t.start+t.count,r=I(i.start,s.width,4),l=I(t.start,s.width,4);i.start<=n+1&&r===l&&I(i.start+i.count-1,s.width,4)===r?t.count=Math.max(t.count,i.start+i.count-t.start):(++o,a[o]=i)}a.length=o+1;const l=e.getParameter(e.UNPACK_ROW_LENGTH),d=e.getParameter(e.UNPACK_SKIP_PIXELS),c=e.getParameter(e.UNPACK_SKIP_ROWS);e.pixelStorei(e.UNPACK_ROW_LENGTH,s.width);for(let t=0,o=a.length;t<o;t++){const o=a[t],l=Math.floor(o.start/4),d=Math.ceil(o.count/4),c=l%s.width,h=Math.floor(l/s.width),p=d,u=1;e.pixelStorei(e.UNPACK_SKIP_PIXELS,c),e.pixelStorei(e.UNPACK_SKIP_ROWS,h),i.texSubImage2D(e.TEXTURE_2D,0,c,h,p,u,n,r,s.data)}t.clearUpdateRanges(),e.pixelStorei(e.UNPACK_ROW_LENGTH,l),e.pixelStorei(e.UNPACK_SKIP_PIXELS,d),e.pixelStorei(e.UNPACK_SKIP_ROWS,c)}}(a,u,m,C)):i.texImage2D(e.TEXTURE_2D,0,w,u.width,u.height,0,m,C,u.data);else if(a.isCompressedTexture)if(a.isCompressedArrayTexture){A&&M&&i.texStorage3D(e.TEXTURE_2D_ARRAY,E,w,x[0].width,x[0].height,u.depth);for(let t=0,s=x.length;t<s;t++)if(S=x[t],a.format!==ie)if(null!==m)if(A){if(T)if(a.layerUpdates.size>0){const s=Yr(S.width,S.height,a.format,a.type);for(const n of a.layerUpdates){const r=S.data.subarray(n*s/S.data.BYTES_PER_ELEMENT,(n+1)*s/S.data.BYTES_PER_ELEMENT);i.compressedTexSubImage3D(e.TEXTURE_2D_ARRAY,t,0,0,n,S.width,S.height,1,m,r)}a.clearLayerUpdates()}else i.compressedTexSubImage3D(e.TEXTURE_2D_ARRAY,t,0,0,0,S.width,S.height,u.depth,m,S.data)}else i.compressedTexImage3D(e.TEXTURE_2D_ARRAY,t,w,S.width,S.height,u.depth,0,S.data,0,0);else console.warn("THREE.WebGLRenderer: Attempt to load unsupported compressed texture format in .uploadTexture()");else A?T&&i.texSubImage3D(e.TEXTURE_2D_ARRAY,t,0,0,0,S.width,S.height,u.depth,m,C,S.data):i.texImage3D(e.TEXTURE_2D_ARRAY,t,w,S.width,S.height,u.depth,0,m,C,S.data)}else{A&&M&&i.texStorage2D(e.TEXTURE_2D,E,w,x[0].width,x[0].height);for(let t=0,s=x.length;t<s;t++)S=x[t],a.format!==ie?null!==m?A?T&&i.compressedTexSubImage2D(e.TEXTURE_2D,t,0,0,S.width,S.height,m,S.data):i.compressedTexImage2D(e.TEXTURE_2D,t,w,S.width,S.height,0,S.data):console.warn("THREE.WebGLRenderer: Attempt to load unsupported compressed texture format in .uploadTexture()"):A?T&&i.texSubImage2D(e.TEXTURE_2D,t,0,0,S.width,S.height,m,C,S.data):i.texImage2D(e.TEXTURE_2D,t,w,S.width,S.height,0,m,C,S.data)}else if(a.isDataArrayTexture)if(A){if(M&&i.texStorage3D(e.TEXTURE_2D_ARRAY,E,w,u.width,u.height,u.depth),T)if(a.layerUpdates.size>0){const t=Yr(u.width,u.height,a.format,a.type);for(const s of a.layerUpdates){const n=u.data.subarray(s*t/u.data.BYTES_PER_ELEMENT,(s+1)*t/u.data.BYTES_PER_ELEMENT);i.texSubImage3D(e.TEXTURE_2D_ARRAY,0,0,0,s,u.width,u.height,1,m,C,n)}a.clearLayerUpdates()}else i.texSubImage3D(e.TEXTURE_2D_ARRAY,0,0,0,0,u.width,u.height,u.depth,m,C,u.data)}else i.texImage3D(e.TEXTURE_2D_ARRAY,0,w,u.width,u.height,u.depth,0,m,C,u.data);else if(a.isData3DTexture)A?(M&&i.texStorage3D(e.TEXTURE_3D,E,w,u.width,u.height,u.depth),T&&i.texSubImage3D(e.TEXTURE_3D,0,0,0,0,u.width,u.height,u.depth,m,C,u.data)):i.texImage3D(e.TEXTURE_3D,0,w,u.width,u.height,u.depth,0,m,C,u.data);else if(a.isFramebufferTexture){if(M)if(A)i.texStorage2D(e.TEXTURE_2D,E,w,u.width,u.height);else{let t=u.width,s=u.height;for(let n=0;n<E;n++)i.texImage2D(e.TEXTURE_2D,n,w,t,s,0,m,C,null),t>>=1,s>>=1}}else if(x.length>0){if(A&&M){const t=ae(x[0]);i.texStorage2D(e.TEXTURE_2D,E,w,t.width,t.height)}for(let t=0,s=x.length;t<s;t++)S=x[t],A?T&&i.texSubImage2D(e.TEXTURE_2D,t,0,0,m,C,S):i.texImage2D(e.TEXTURE_2D,t,w,m,C,S);a.generateMipmaps=!1}else if(A){if(M){const t=ae(u);i.texStorage2D(e.TEXTURE_2D,E,w,t.width,t.height)}T&&i.texSubImage2D(e.TEXTURE_2D,0,0,0,m,C,u)}else i.texImage2D(e.TEXTURE_2D,0,w,m,C,u);g(a)&&b(l),h.__version=c.version,a.onUpdate&&a.onUpdate(a)}t.__version=a.version}function G(t,n,a,l,d,c){const h=r.convert(a.format,a.colorSpace),p=r.convert(a.type),u=v(a.internalFormat,h,p,a.colorSpace),m=s.get(n),f=s.get(a);if(f.__renderTarget=n,!m.__hasExternalTextures){const t=Math.max(1,n.width>>c),s=Math.max(1,n.height>>c);d===e.TEXTURE_3D||d===e.TEXTURE_2D_ARRAY?i.texImage3D(d,c,u,t,s,n.depth,0,h,p,null):i.texImage2D(d,c,u,t,s,0,h,p,null)}i.bindFramebuffer(e.FRAMEBUFFER,t),te(n)?o.framebufferTexture2DMultisampleEXT(e.FRAMEBUFFER,l,d,f.__webglTexture,0,Q(n)):(d===e.TEXTURE_2D||d>=e.TEXTURE_CUBE_MAP_POSITIVE_X&&d<=e.TEXTURE_CUBE_MAP_NEGATIVE_Z)&&e.framebufferTexture2D(e.FRAMEBUFFER,l,d,f.__webglTexture,c),i.bindFramebuffer(e.FRAMEBUFFER,null)}function $(t,i,s){if(e.bindRenderbuffer(e.RENDERBUFFER,t),i.depthBuffer){const n=i.depthTexture,r=n&&n.isDepthTexture?n.type:null,a=_(i.stencilBuffer,r),l=i.stencilBuffer?e.DEPTH_STENCIL_ATTACHMENT:e.DEPTH_ATTACHMENT,d=Q(i);te(i)?o.renderbufferStorageMultisampleEXT(e.RENDERBUFFER,d,a,i.width,i.height):s?e.renderbufferStorageMultisample(e.RENDERBUFFER,d,a,i.width,i.height):e.renderbufferStorage(e.RENDERBUFFER,a,i.width,i.height),e.framebufferRenderbuffer(e.FRAMEBUFFER,l,e.RENDERBUFFER,t)}else{const t=i.textures;for(let n=0;n<t.length;n++){const a=t[n],l=r.convert(a.format,a.colorSpace),d=r.convert(a.type),c=v(a.internalFormat,l,d,a.colorSpace),h=Q(i);s&&!1===te(i)?e.renderbufferStorageMultisample(e.RENDERBUFFER,h,c,i.width,i.height):te(i)?o.renderbufferStorageMultisampleEXT(e.RENDERBUFFER,h,c,i.width,i.height):e.renderbufferStorage(e.RENDERBUFFER,c,i.width,i.height)}}e.bindRenderbuffer(e.RENDERBUFFER,null)}function V(t,n){if(n&&n.isWebGLCubeRenderTarget)throw new Error("Depth Texture with cube render targets is not supported");if(i.bindFramebuffer(e.FRAMEBUFFER,t),!n.depthTexture||!n.depthTexture.isDepthTexture)throw new Error("renderTarget.depthTexture must be an instance of THREE.DepthTexture");const r=s.get(n.depthTexture);r.__renderTarget=n,r.__webglTexture&&n.depthTexture.image.width===n.width&&n.depthTexture.image.height===n.height||(n.depthTexture.image.width=n.width,n.depthTexture.image.height=n.height,n.depthTexture.needsUpdate=!0),M(n.depthTexture,0);const a=r.__webglTexture,l=Q(n);if(n.depthTexture.format===se)te(n)?o.framebufferTexture2DMultisampleEXT(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.TEXTURE_2D,a,0,l):e.framebufferTexture2D(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.TEXTURE_2D,a,0);else{if(n.depthTexture.format!==ne)throw new Error("Unknown depthTexture format");te(n)?o.framebufferTexture2DMultisampleEXT(e.FRAMEBUFFER,e.DEPTH_STENCIL_ATTACHMENT,e.TEXTURE_2D,a,0,l):e.framebufferTexture2D(e.FRAMEBUFFER,e.DEPTH_STENCIL_ATTACHMENT,e.TEXTURE_2D,a,0)}}function X(t){const n=s.get(t),r=!0===t.isWebGLCubeRenderTarget;if(n.__boundDepthTexture!==t.depthTexture){const e=t.depthTexture;if(n.__depthDisposeCallback&&n.__depthDisposeCallback(),e){const t=()=>{delete n.__boundDepthTexture,delete n.__depthDisposeCallback,e.removeEventListener("dispose",t)};e.addEventListener("dispose",t),n.__depthDisposeCallback=t}n.__boundDepthTexture=e}if(t.depthTexture&&!n.__autoAllocateDepthBuffer){if(r)throw new Error("target.depthTexture not supported in Cube render targets");const e=t.texture.mipmaps;e&&e.length>0?V(n.__webglFramebuffer[0],t):V(n.__webglFramebuffer,t)}else if(r){n.__webglDepthbuffer=[];for(let s=0;s<6;s++)if(i.bindFramebuffer(e.FRAMEBUFFER,n.__webglFramebuffer[s]),void 0===n.__webglDepthbuffer[s])n.__webglDepthbuffer[s]=e.createRenderbuffer(),$(n.__webglDepthbuffer[s],t,!1);else{const i=t.stencilBuffer?e.DEPTH_STENCIL_ATTACHMENT:e.DEPTH_ATTACHMENT,r=n.__webglDepthbuffer[s];e.bindRenderbuffer(e.RENDERBUFFER,r),e.framebufferRenderbuffer(e.FRAMEBUFFER,i,e.RENDERBUFFER,r)}}else{const s=t.texture.mipmaps;if(s&&s.length>0?i.bindFramebuffer(e.FRAMEBUFFER,n.__webglFramebuffer[0]):i.bindFramebuffer(e.FRAMEBUFFER,n.__webglFramebuffer),void 0===n.__webglDepthbuffer)n.__webglDepthbuffer=e.createRenderbuffer(),$(n.__webglDepthbuffer,t,!1);else{const i=t.stencilBuffer?e.DEPTH_STENCIL_ATTACHMENT:e.DEPTH_ATTACHMENT,s=n.__webglDepthbuffer;e.bindRenderbuffer(e.RENDERBUFFER,s),e.framebufferRenderbuffer(e.FRAMEBUFFER,i,e.RENDERBUFFER,s)}}i.bindFramebuffer(e.FRAMEBUFFER,null)}const Z=[],J=[];function Q(e){return Math.min(n.maxSamples,e.samples)}function te(e){const i=s.get(e);return e.samples>0&&!0===t.has("WEBGL_multisampled_render_to_texture")&&!1!==i.__useRenderToTexture}function re(e,t){const i=e.colorSpace,s=e.format,n=e.type;return!0===e.isCompressedTexture||!0===e.isVideoTexture||i!==ze&&i!==He&&(Tt.getTransfer(i)===je?s===ie&&n===j||console.warn("THREE.WebGLTextures: sRGB encoded textures have to use RGBAFormat and UnsignedByteType."):console.error("THREE.WebGLTextures: Unsupported texture color space:",i)),t}function ae(e){return"undefined"!=typeof HTMLImageElement&&e instanceof HTMLImageElement?(d.width=e.naturalWidth||e.width,d.height=e.naturalHeight||e.height):"undefined"!=typeof VideoFrame&&e instanceof VideoFrame?(d.width=e.displayWidth,d.height=e.displayHeight):(d.width=e.width,d.height=e.height),d}this.allocateTextureUnit=function(){const e=A;return e>=n.maxTextures&&console.warn("THREE.WebGLTextures: Trying to use "+e+" texture units while this GPU supports only "+n.maxTextures),A+=1,e},this.resetTextureUnits=function(){A=0},this.setTexture2D=M,this.setTexture2DArray=function(t,n){const r=s.get(t);t.version>0&&r.__version!==t.version?P(r,t,n):i.bindTexture(e.TEXTURE_2D_ARRAY,r.__webglTexture,e.TEXTURE0+n)},this.setTexture3D=function(t,n){const r=s.get(t);t.version>0&&r.__version!==t.version?P(r,t,n):i.bindTexture(e.TEXTURE_3D,r.__webglTexture,e.TEXTURE0+n)},this.setTextureCube=function(t,a){const o=s.get(t);t.version>0&&o.__version!==t.version?function(t,a,o){if(6!==a.image.length)return;const l=O(t,a),d=a.source;i.bindTexture(e.TEXTURE_CUBE_MAP,t.__webglTexture,e.TEXTURE0+o);const c=s.get(d);if(d.version!==c.__version||!0===l){i.activeTexture(e.TEXTURE0+o);const t=Tt.getPrimaries(Tt.workingColorSpace),s=a.colorSpace===He?null:Tt.getPrimaries(a.colorSpace),h=a.colorSpace===He||t===s?e.NONE:e.BROWSER_DEFAULT_WEBGL;e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,a.flipY),e.pixelStorei(e.UNPACK_PREMULTIPLY_ALPHA_WEBGL,a.premultiplyAlpha),e.pixelStorei(e.UNPACK_ALIGNMENT,a.unpackAlignment),e.pixelStorei(e.UNPACK_COLORSPACE_CONVERSION_WEBGL,h);const p=a.isCompressedTexture||a.image[0].isCompressedTexture,u=a.image[0]&&a.image[0].isDataTexture,m=[];for(let e=0;e<6;e++)m[e]=p||u?u?a.image[e].image:a.image[e]:f(a.image[e],!0,n.maxCubemapSize),m[e]=re(a,m[e]);const C=m[0],_=r.convert(a.format,a.colorSpace),S=r.convert(a.type),w=v(a.internalFormat,_,S,a.colorSpace),x=!0!==a.isVideoTexture,A=void 0===c.__version||!0===l,M=d.dataReady;let T,E=y(a,C);if(k(e.TEXTURE_CUBE_MAP,a),p){x&&A&&i.texStorage2D(e.TEXTURE_CUBE_MAP,E,w,C.width,C.height);for(let t=0;t<6;t++){T=m[t].mipmaps;for(let s=0;s<T.length;s++){const n=T[s];a.format!==ie?null!==_?x?M&&i.compressedTexSubImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+t,s,0,0,n.width,n.height,_,n.data):i.compressedTexImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+t,s,w,n.width,n.height,0,n.data):console.warn("THREE.WebGLRenderer: Attempt to load unsupported compressed texture format in .setTextureCube()"):x?M&&i.texSubImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+t,s,0,0,n.width,n.height,_,S,n.data):i.texImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+t,s,w,n.width,n.height,0,_,S,n.data)}}}else{if(T=a.mipmaps,x&&A){T.length>0&&E++;const t=ae(m[0]);i.texStorage2D(e.TEXTURE_CUBE_MAP,E,w,t.width,t.height)}for(let t=0;t<6;t++)if(u){x?M&&i.texSubImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+t,0,0,0,m[t].width,m[t].height,_,S,m[t].data):i.texImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+t,0,w,m[t].width,m[t].height,0,_,S,m[t].data);for(let s=0;s<T.length;s++){const n=T[s].image[t].image;x?M&&i.texSubImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+t,s+1,0,0,n.width,n.height,_,S,n.data):i.texImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+t,s+1,w,n.width,n.height,0,_,S,n.data)}}else{x?M&&i.texSubImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+t,0,0,0,_,S,m[t]):i.texImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+t,0,w,_,S,m[t]);for(let s=0;s<T.length;s++){const n=T[s];x?M&&i.texSubImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+t,s+1,0,0,_,S,n.image[t]):i.texImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+t,s+1,w,_,S,n.image[t])}}}g(a)&&b(e.TEXTURE_CUBE_MAP),c.__version=d.version,a.onUpdate&&a.onUpdate(a)}t.__version=a.version}(o,t,a):i.bindTexture(e.TEXTURE_CUBE_MAP,o.__webglTexture,e.TEXTURE0+a)},this.rebindTextures=function(t,i,n){const r=s.get(t);void 0!==i&&G(r.__webglFramebuffer,t,t.texture,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,0),void 0!==n&&X(t)},this.setupRenderTarget=function(t){const n=t.texture,o=s.get(t),l=s.get(n);t.addEventListener("dispose",w);const d=t.textures,c=!0===t.isWebGLCubeRenderTarget,h=d.length>1;if(h||(void 0===l.__webglTexture&&(l.__webglTexture=e.createTexture()),l.__version=n.version,a.memory.textures++),c){o.__webglFramebuffer=[];for(let t=0;t<6;t++)if(n.mipmaps&&n.mipmaps.length>0){o.__webglFramebuffer[t]=[];for(let i=0;i<n.mipmaps.length;i++)o.__webglFramebuffer[t][i]=e.createFramebuffer()}else o.__webglFramebuffer[t]=e.createFramebuffer()}else{if(n.mipmaps&&n.mipmaps.length>0){o.__webglFramebuffer=[];for(let t=0;t<n.mipmaps.length;t++)o.__webglFramebuffer[t]=e.createFramebuffer()}else o.__webglFramebuffer=e.createFramebuffer();if(h)for(let t=0,i=d.length;t<i;t++){const i=s.get(d[t]);void 0===i.__webglTexture&&(i.__webglTexture=e.createTexture(),a.memory.textures++)}if(t.samples>0&&!1===te(t)){o.__webglMultisampledFramebuffer=e.createFramebuffer(),o.__webglColorRenderbuffer=[],i.bindFramebuffer(e.FRAMEBUFFER,o.__webglMultisampledFramebuffer);for(let i=0;i<d.length;i++){const s=d[i];o.__webglColorRenderbuffer[i]=e.createRenderbuffer(),e.bindRenderbuffer(e.RENDERBUFFER,o.__webglColorRenderbuffer[i]);const n=r.convert(s.format,s.colorSpace),a=r.convert(s.type),l=v(s.internalFormat,n,a,s.colorSpace,!0===t.isXRRenderTarget),c=Q(t);e.renderbufferStorageMultisample(e.RENDERBUFFER,c,l,t.width,t.height),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0+i,e.RENDERBUFFER,o.__webglColorRenderbuffer[i])}e.bindRenderbuffer(e.RENDERBUFFER,null),t.depthBuffer&&(o.__webglDepthRenderbuffer=e.createRenderbuffer(),$(o.__webglDepthRenderbuffer,t,!0)),i.bindFramebuffer(e.FRAMEBUFFER,null)}}if(c){i.bindTexture(e.TEXTURE_CUBE_MAP,l.__webglTexture),k(e.TEXTURE_CUBE_MAP,n);for(let i=0;i<6;i++)if(n.mipmaps&&n.mipmaps.length>0)for(let s=0;s<n.mipmaps.length;s++)G(o.__webglFramebuffer[i][s],t,n,e.COLOR_ATTACHMENT0,e.TEXTURE_CUBE_MAP_POSITIVE_X+i,s);else G(o.__webglFramebuffer[i],t,n,e.COLOR_ATTACHMENT0,e.TEXTURE_CUBE_MAP_POSITIVE_X+i,0);g(n)&&b(e.TEXTURE_CUBE_MAP),i.unbindTexture()}else if(h){for(let n=0,r=d.length;n<r;n++){const r=d[n],a=s.get(r);i.bindTexture(e.TEXTURE_2D,a.__webglTexture),k(e.TEXTURE_2D,r),G(o.__webglFramebuffer,t,r,e.COLOR_ATTACHMENT0+n,e.TEXTURE_2D,0),g(r)&&b(e.TEXTURE_2D)}i.unbindTexture()}else{let s=e.TEXTURE_2D;if((t.isWebGL3DRenderTarget||t.isWebGLArrayRenderTarget)&&(s=t.isWebGL3DRenderTarget?e.TEXTURE_3D:e.TEXTURE_2D_ARRAY),i.bindTexture(s,l.__webglTexture),k(s,n),n.mipmaps&&n.mipmaps.length>0)for(let i=0;i<n.mipmaps.length;i++)G(o.__webglFramebuffer[i],t,n,e.COLOR_ATTACHMENT0,s,i);else G(o.__webglFramebuffer,t,n,e.COLOR_ATTACHMENT0,s,0);g(n)&&b(s),i.unbindTexture()}t.depthBuffer&&X(t)},this.updateRenderTargetMipmap=function(e){const t=e.textures;for(let n=0,r=t.length;n<r;n++){const r=t[n];if(g(r)){const t=C(e),n=s.get(r).__webglTexture;i.bindTexture(t,n),b(t),i.unbindTexture()}}},this.updateMultisampleRenderTarget=function(t){if(t.samples>0)if(!1===te(t)){const n=t.textures,r=t.width,a=t.height;let o=e.COLOR_BUFFER_BIT;const d=t.stencilBuffer?e.DEPTH_STENCIL_ATTACHMENT:e.DEPTH_ATTACHMENT,c=s.get(t),h=n.length>1;if(h)for(let t=0;t<n.length;t++)i.bindFramebuffer(e.FRAMEBUFFER,c.__webglMultisampledFramebuffer),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0+t,e.RENDERBUFFER,null),i.bindFramebuffer(e.FRAMEBUFFER,c.__webglFramebuffer),e.framebufferTexture2D(e.DRAW_FRAMEBUFFER,e.COLOR_ATTACHMENT0+t,e.TEXTURE_2D,null,0);i.bindFramebuffer(e.READ_FRAMEBUFFER,c.__webglMultisampledFramebuffer);const p=t.texture.mipmaps;p&&p.length>0?i.bindFramebuffer(e.DRAW_FRAMEBUFFER,c.__webglFramebuffer[0]):i.bindFramebuffer(e.DRAW_FRAMEBUFFER,c.__webglFramebuffer);for(let i=0;i<n.length;i++){if(t.resolveDepthBuffer&&(t.depthBuffer&&(o|=e.DEPTH_BUFFER_BIT),t.stencilBuffer&&t.resolveStencilBuffer&&(o|=e.STENCIL_BUFFER_BIT)),h){e.framebufferRenderbuffer(e.READ_FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.RENDERBUFFER,c.__webglColorRenderbuffer[i]);const t=s.get(n[i]).__webglTexture;e.framebufferTexture2D(e.DRAW_FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,t,0)}e.blitFramebuffer(0,0,r,a,0,0,r,a,o,e.NEAREST),!0===l&&(Z.length=0,J.length=0,Z.push(e.COLOR_ATTACHMENT0+i),t.depthBuffer&&!1===t.resolveDepthBuffer&&(Z.push(d),J.push(d),e.invalidateFramebuffer(e.DRAW_FRAMEBUFFER,J)),e.invalidateFramebuffer(e.READ_FRAMEBUFFER,Z))}if(i.bindFramebuffer(e.READ_FRAMEBUFFER,null),i.bindFramebuffer(e.DRAW_FRAMEBUFFER,null),h)for(let t=0;t<n.length;t++){i.bindFramebuffer(e.FRAMEBUFFER,c.__webglMultisampledFramebuffer),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0+t,e.RENDERBUFFER,c.__webglColorRenderbuffer[t]);const r=s.get(n[t]).__webglTexture;i.bindFramebuffer(e.FRAMEBUFFER,c.__webglFramebuffer),e.framebufferTexture2D(e.DRAW_FRAMEBUFFER,e.COLOR_ATTACHMENT0+t,e.TEXTURE_2D,r,0)}i.bindFramebuffer(e.DRAW_FRAMEBUFFER,c.__webglMultisampledFramebuffer)}else if(t.depthBuffer&&!1===t.resolveDepthBuffer&&l){const i=t.stencilBuffer?e.DEPTH_STENCIL_ATTACHMENT:e.DEPTH_ATTACHMENT;e.invalidateFramebuffer(e.DRAW_FRAMEBUFFER,[i])}},this.setupDepthRenderbuffer=X,this.setupFrameBufferTexture=G,this.useMultisampledRTT=te}function Ml(e,t){return{convert:function(i,s=""){let n;const r=Tt.getTransfer(s);if(i===j)return e.UNSIGNED_BYTE;if(i===J)return e.UNSIGNED_SHORT_4_4_4_4;if(i===Q)return e.UNSIGNED_SHORT_5_5_5_1;if(i===te)return e.UNSIGNED_INT_5_9_9_9_REV;if(i===G)return e.BYTE;if(i===V)return e.SHORT;if(i===W)return e.UNSIGNED_SHORT;if(i===X)return e.INT;if(i===Y)return e.UNSIGNED_INT;if(i===K)return e.FLOAT;if(i===Z)return e.HALF_FLOAT;if(1021===i)return e.ALPHA;if(1022===i)return e.RGB;if(i===ie)return e.RGBA;if(i===se)return e.DEPTH_COMPONENT;if(i===ne)return e.DEPTH_STENCIL;if(1028===i)return e.RED;if(i===re)return e.RED_INTEGER;if(1030===i)return e.RG;if(i===ae)return e.RG_INTEGER;if(i===oe)return e.RGBA_INTEGER;if(i===le||i===de||i===ce||i===he)if(r===je){if(n=t.get("WEBGL_compressed_texture_s3tc_srgb"),null===n)return null;if(i===le)return n.COMPRESSED_SRGB_S3TC_DXT1_EXT;if(i===de)return n.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;if(i===ce)return n.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;if(i===he)return n.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT}else{if(n=t.get("WEBGL_compressed_texture_s3tc"),null===n)return null;if(i===le)return n.COMPRESSED_RGB_S3TC_DXT1_EXT;if(i===de)return n.COMPRESSED_RGBA_S3TC_DXT1_EXT;if(i===ce)return n.COMPRESSED_RGBA_S3TC_DXT3_EXT;if(i===he)return n.COMPRESSED_RGBA_S3TC_DXT5_EXT}if(i===pe||i===ue||i===me||i===fe){if(n=t.get("WEBGL_compressed_texture_pvrtc"),null===n)return null;if(i===pe)return n.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;if(i===ue)return n.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;if(i===me)return n.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;if(i===fe)return n.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG}if(i===ge||i===be||i===Ce){if(n=t.get("WEBGL_compressed_texture_etc"),null===n)return null;if(i===ge||i===be)return r===je?n.COMPRESSED_SRGB8_ETC2:n.COMPRESSED_RGB8_ETC2;if(i===Ce)return r===je?n.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC:n.COMPRESSED_RGBA8_ETC2_EAC}if(i===ve||i===_e||i===ye||i===Se||i===we||i===xe||i===Ae||i===Me||i===Te||i===Ee||i===Re||i===ke||i===Oe||i===Ie){if(n=t.get("WEBGL_compressed_texture_astc"),null===n)return null;if(i===ve)return r===je?n.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR:n.COMPRESSED_RGBA_ASTC_4x4_KHR;if(i===_e)return r===je?n.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR:n.COMPRESSED_RGBA_ASTC_5x4_KHR;if(i===ye)return r===je?n.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR:n.COMPRESSED_RGBA_ASTC_5x5_KHR;if(i===Se)return r===je?n.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR:n.COMPRESSED_RGBA_ASTC_6x5_KHR;if(i===we)return r===je?n.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR:n.COMPRESSED_RGBA_ASTC_6x6_KHR;if(i===xe)return r===je?n.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR:n.COMPRESSED_RGBA_ASTC_8x5_KHR;if(i===Ae)return r===je?n.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR:n.COMPRESSED_RGBA_ASTC_8x6_KHR;if(i===Me)return r===je?n.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR:n.COMPRESSED_RGBA_ASTC_8x8_KHR;if(i===Te)return r===je?n.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR:n.COMPRESSED_RGBA_ASTC_10x5_KHR;if(i===Ee)return r===je?n.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR:n.COMPRESSED_RGBA_ASTC_10x6_KHR;if(i===Re)return r===je?n.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR:n.COMPRESSED_RGBA_ASTC_10x8_KHR;if(i===ke)return r===je?n.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR:n.COMPRESSED_RGBA_ASTC_10x10_KHR;if(i===Oe)return r===je?n.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR:n.COMPRESSED_RGBA_ASTC_12x10_KHR;if(i===Ie)return r===je?n.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR:n.COMPRESSED_RGBA_ASTC_12x12_KHR}if(i===Pe||i===De||i===Le){if(n=t.get("EXT_texture_compression_bptc"),null===n)return null;if(i===Pe)return r===je?n.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT:n.COMPRESSED_RGBA_BPTC_UNORM_EXT;if(i===De)return n.COMPRESSED_RGB_BPTC_SIGNED_FLOAT_EXT;if(i===Le)return n.COMPRESSED_RGB_BPTC_UNSIGNED_FLOAT_EXT}if(36283===i||i===Fe||i===Ne||i===Ue){if(n=t.get("EXT_texture_compression_rgtc"),null===n)return null;if(i===Pe)return n.COMPRESSED_RED_RGTC1_EXT;if(i===Fe)return n.COMPRESSED_SIGNED_RED_RGTC1_EXT;if(i===Ne)return n.COMPRESSED_RED_GREEN_RGTC2_EXT;if(i===Ue)return n.COMPRESSED_SIGNED_RED_GREEN_RGTC2_EXT}return i===ee?e.UNSIGNED_INT_24_8:void 0!==e[i]?e[i]:null}}}class Tl{constructor(){this.texture=null,this.mesh=null,this.depthNear=0,this.depthFar=0}init(e,t,i){if(null===this.texture){const s=new Nt;e.properties.get(s).__webglTexture=t.texture,t.depthNear===i.depthNear&&t.depthFar===i.depthFar||(this.depthNear=t.depthNear,this.depthFar=t.depthFar),this.texture=s}}getMesh(e){if(null!==this.texture&&null===this.mesh){const t=e.cameras[0].viewport,i=new Vs({vertexShader:"\nvoid main() {\n\n\tgl_Position = vec4( position, 1.0 );\n\n}",fragmentShader:"\nuniform sampler2DArray depthColor;\nuniform float depthWidth;\nuniform float depthHeight;\n\nvoid main() {\n\n\tvec2 coord = vec2( gl_FragCoord.x / depthWidth, gl_FragCoord.y / depthHeight );\n\n\tif ( coord.x >= 1.0 ) {\n\n\t\tgl_FragDepth = texture( depthColor, vec3( coord.x - 1.0, coord.y, 1 ) ).r;\n\n\t} else {\n\n\t\tgl_FragDepth = texture( depthColor, vec3( coord.x, coord.y, 0 ) ).r;\n\n\t}\n\n}",uniforms:{depthColor:{value:this.texture},depthWidth:{value:t.z},depthHeight:{value:t.w}}});this.mesh=new Hs(new pr(20,20),i)}return this.mesh}reset(){this.texture=null,this.mesh=null}getDepthTexture(){return this.texture}}class El extends st{constructor(e,t){super();const i=this;let s=null,n=1,r=null,a="local-floor",o=1,l=null,d=null,c=null,h=null,p=null,u=null;const m=new Tl,f=t.getContextAttributes();let g=null,b=null;const C=[],v=[],_=new pt;let y=null;const S=new Zs;S.viewport=new Ut;const w=new Zs;w.viewport=new Ut;const x=[S,w],A=new Hr;let M=null,T=null;function E(e){const t=v.indexOf(e.inputSource);if(-1===t)return;const i=C[t];void 0!==i&&(i.update(e.inputSource,e.frame,l||r),i.dispatchEvent({type:e.type,data:e.inputSource}))}function R(){s.removeEventListener("select",E),s.removeEventListener("selectstart",E),s.removeEventListener("selectend",E),s.removeEventListener("squeeze",E),s.removeEventListener("squeezestart",E),s.removeEventListener("squeezeend",E),s.removeEventListener("end",R),s.removeEventListener("inputsourceschange",k);for(let e=0;e<C.length;e++){const t=v[e];null!==t&&(v[e]=null,C[e].disconnect(t))}M=null,T=null,m.reset(),e.setRenderTarget(g),p=null,h=null,c=null,s=null,b=null,L.stop(),i.isPresenting=!1,e.setPixelRatio(y),e.setSize(_.width,_.height,!1),i.dispatchEvent({type:"sessionend"})}function k(e){for(let t=0;t<e.removed.length;t++){const i=e.removed[t],s=v.indexOf(i);s>=0&&(v[s]=null,C[s].disconnect(i))}for(let t=0;t<e.added.length;t++){const i=e.added[t];let s=v.indexOf(i);if(-1===s){for(let e=0;e<C.length;e++){if(e>=v.length){v.push(i),s=e;break}if(null===v[e]){v[e]=i,s=e;break}}if(-1===s)break}const n=C[s];n&&n.connect(i)}}this.cameraAutoUpdate=!0,this.enabled=!1,this.isPresenting=!1,this.getController=function(e){let t=C[e];return void 0===t&&(t=new rn,C[e]=t),t.getTargetRaySpace()},this.getControllerGrip=function(e){let t=C[e];return void 0===t&&(t=new rn,C[e]=t),t.getGripSpace()},this.getHand=function(e){let t=C[e];return void 0===t&&(t=new rn,C[e]=t),t.getHandSpace()},this.setFramebufferScaleFactor=function(e){n=e,!0===i.isPresenting&&console.warn("THREE.WebXRManager: Cannot change framebuffer scale while presenting.")},this.setReferenceSpaceType=function(e){a=e,!0===i.isPresenting&&console.warn("THREE.WebXRManager: Cannot change reference space type while presenting.")},this.getReferenceSpace=function(){return l||r},this.setReferenceSpace=function(e){l=e},this.getBaseLayer=function(){return null!==h?h:p},this.getBinding=function(){return c},this.getFrame=function(){return u},this.getSession=function(){return s},this.setSession=async function(d){if(s=d,null!==s){g=e.getRenderTarget(),s.addEventListener("select",E),s.addEventListener("selectstart",E),s.addEventListener("selectend",E),s.addEventListener("squeeze",E),s.addEventListener("squeezestart",E),s.addEventListener("squeezeend",E),s.addEventListener("end",R),s.addEventListener("inputsourceschange",k),!0!==f.xrCompatible&&await t.makeXRCompatible(),y=e.getPixelRatio(),e.getSize(_);if("undefined"!=typeof XRWebGLBinding&&"createProjectionLayer"in XRWebGLBinding.prototype){let i=null,r=null,a=null;f.depth&&(a=f.stencil?t.DEPTH24_STENCIL8:t.DEPTH_COMPONENT24,i=f.stencil?ne:se,r=f.stencil?ee:Y);const o={colorFormat:t.RGBA8,depthFormat:a,scaleFactor:n};c=new XRWebGLBinding(s,t),h=c.createProjectionLayer(o),s.updateRenderState({layers:[h]}),e.setPixelRatio(1),e.setSize(h.textureWidth,h.textureHeight,!1),b=new Bt(h.textureWidth,h.textureHeight,{format:ie,type:j,depthTexture:new Yn(h.textureWidth,h.textureHeight,r,void 0,void 0,void 0,void 0,void 0,void 0,i),stencilBuffer:f.stencil,colorSpace:e.outputColorSpace,samples:f.antialias?4:0,resolveDepthBuffer:!1===h.ignoreDepthValues,resolveStencilBuffer:!1===h.ignoreDepthValues})}else{const i={antialias:f.antialias,alpha:!0,depth:f.depth,stencil:f.stencil,framebufferScaleFactor:n};p=new XRWebGLLayer(s,t,i),s.updateRenderState({baseLayer:p}),e.setPixelRatio(1),e.setSize(p.framebufferWidth,p.framebufferHeight,!1),b=new Bt(p.framebufferWidth,p.framebufferHeight,{format:ie,type:j,colorSpace:e.outputColorSpace,stencilBuffer:f.stencil,resolveDepthBuffer:!1===p.ignoreDepthValues,resolveStencilBuffer:!1===p.ignoreDepthValues})}b.isXRRenderTarget=!0,this.setFoveation(o),l=null,r=await s.requestReferenceSpace(a),L.setContext(s),L.start(),i.isPresenting=!0,i.dispatchEvent({type:"sessionstart"})}},this.getEnvironmentBlendMode=function(){if(null!==s)return s.environmentBlendMode},this.getDepthTexture=function(){return m.getDepthTexture()};const O=new mt,I=new mt;function P(e,t){null===t?e.matrixWorld.copy(e.matrix):e.matrixWorld.multiplyMatrices(t.matrixWorld,e.matrix),e.matrixWorldInverse.copy(e.matrixWorld).invert()}this.updateCamera=function(e){if(null===s)return;let t=e.near,i=e.far;null!==m.texture&&(m.depthNear>0&&(t=m.depthNear),m.depthFar>0&&(i=m.depthFar)),A.near=w.near=S.near=t,A.far=w.far=S.far=i,M===A.near&&T===A.far||(s.updateRenderState({depthNear:A.near,depthFar:A.far}),M=A.near,T=A.far),S.layers.mask=2|e.layers.mask,w.layers.mask=4|e.layers.mask,A.layers.mask=S.layers.mask|w.layers.mask;const n=e.parent,r=A.cameras;P(A,n);for(let e=0;e<r.length;e++)P(r[e],n);2===r.length?function(e,t,i){O.setFromMatrixPosition(t.matrixWorld),I.setFromMatrixPosition(i.matrixWorld);const s=O.distanceTo(I),n=t.projectionMatrix.elements,r=i.projectionMatrix.elements,a=n[14]/(n[10]-1),o=n[14]/(n[10]+1),l=(n[9]+1)/n[5],d=(n[9]-1)/n[5],c=(n[8]-1)/n[0],h=(r[8]+1)/r[0],p=a*c,u=a*h,m=s/(-c+h),f=m*-c;if(t.matrixWorld.decompose(e.position,e.quaternion,e.scale),e.translateX(f),e.translateZ(m),e.matrixWorld.compose(e.position,e.quaternion,e.scale),e.matrixWorldInverse.copy(e.matrixWorld).invert(),-1===n[10])e.projectionMatrix.copy(t.projectionMatrix),e.projectionMatrixInverse.copy(t.projectionMatrixInverse);else{const t=a+m,i=o+m,n=p-f,r=u+(s-f),c=l*o/i*t,h=d*o/i*t;e.projectionMatrix.makePerspective(n,r,c,h,t,i),e.projectionMatrixInverse.copy(e.projectionMatrix).invert()}}(A,S,w):A.projectionMatrix.copy(S.projectionMatrix),function(e,t,i){null===i?e.matrix.copy(t.matrixWorld):(e.matrix.copy(i.matrixWorld),e.matrix.invert(),e.matrix.multiply(t.matrixWorld));e.matrix.decompose(e.position,e.quaternion,e.scale),e.updateMatrixWorld(!0),e.projectionMatrix.copy(t.projectionMatrix),e.projectionMatrixInverse.copy(t.projectionMatrixInverse),e.isPerspectiveCamera&&(e.fov=2*at*Math.atan(1/e.projectionMatrix.elements[5]),e.zoom=1)}(e,A,n)},this.getCamera=function(){return A},this.getFoveation=function(){if(null!==h||null!==p)return o},this.setFoveation=function(e){o=e,null!==h&&(h.fixedFoveation=e),null!==p&&void 0!==p.fixedFoveation&&(p.fixedFoveation=e)},this.hasDepthSensing=function(){return null!==m.texture},this.getDepthSensingMesh=function(){return m.getMesh(A)};let D=null;const L=new Kr;L.setAnimationLoop((function(t,n){if(d=n.getViewerPose(l||r),u=n,null!==d){const t=d.views;null!==p&&(e.setRenderTargetFramebuffer(b,p.framebuffer),e.setRenderTarget(b));let i=!1;t.length!==A.cameras.length&&(A.cameras.length=0,i=!0);for(let s=0;s<t.length;s++){const n=t[s];let r=null;if(null!==p)r=p.getViewport(n);else{const t=c.getViewSubImage(h,n);r=t.viewport,0===s&&(e.setRenderTargetTextures(b,t.colorTexture,t.depthStencilTexture),e.setRenderTarget(b))}let a=x[s];void 0===a&&(a=new Zs,a.layers.enable(s),a.viewport=new Ut,x[s]=a),a.matrix.fromArray(n.transform.matrix),a.matrix.decompose(a.position,a.quaternion,a.scale),a.projectionMatrix.fromArray(n.projectionMatrix),a.projectionMatrixInverse.copy(a.projectionMatrix).invert(),a.viewport.set(r.x,r.y,r.width,r.height),0===s&&(A.matrix.copy(a.matrix),A.matrix.decompose(A.position,A.quaternion,A.scale)),!0===i&&A.cameras.push(a)}const n=s.enabledFeatures;if(n&&n.includes("depth-sensing")&&"gpu-optimized"==s.depthUsage&&c){const i=c.getDepthInformation(t[0]);i&&i.isValid&&i.texture&&m.init(e,i,s.renderState)}}for(let e=0;e<C.length;e++){const t=v[e],i=C[e];null!==t&&void 0!==i&&i.update(t,n,l||r)}D&&D(t,n),n.detectedPlanes&&i.dispatchEvent({type:"planesdetected",data:n}),u=null})),this.setAnimationLoop=function(e){D=e},this.dispose=function(){}}}const Rl=new Mi,kl=new gi;function Ol(e,t){function i(e,t){!0===e.matrixAutoUpdate&&e.updateMatrix(),t.value.copy(e.matrix)}function s(e,s){e.opacity.value=s.opacity,s.color&&e.diffuse.value.copy(s.color),s.emissive&&e.emissive.value.copy(s.emissive).multiplyScalar(s.emissiveIntensity),s.map&&(e.map.value=s.map,i(s.map,e.mapTransform)),s.alphaMap&&(e.alphaMap.value=s.alphaMap,i(s.alphaMap,e.alphaMapTransform)),s.bumpMap&&(e.bumpMap.value=s.bumpMap,i(s.bumpMap,e.bumpMapTransform),e.bumpScale.value=s.bumpScale,1===s.side&&(e.bumpScale.value*=-1)),s.normalMap&&(e.normalMap.value=s.normalMap,i(s.normalMap,e.normalMapTransform),e.normalScale.value.copy(s.normalScale),1===s.side&&e.normalScale.value.negate()),s.displacementMap&&(e.displacementMap.value=s.displacementMap,i(s.displacementMap,e.displacementMapTransform),e.displacementScale.value=s.displacementScale,e.displacementBias.value=s.displacementBias),s.emissiveMap&&(e.emissiveMap.value=s.emissiveMap,i(s.emissiveMap,e.emissiveMapTransform)),s.specularMap&&(e.specularMap.value=s.specularMap,i(s.specularMap,e.specularMapTransform)),s.alphaTest>0&&(e.alphaTest.value=s.alphaTest);const n=t.get(s),r=n.envMap,a=n.envMapRotation;r&&(e.envMap.value=r,Rl.copy(a),Rl.x*=-1,Rl.y*=-1,Rl.z*=-1,r.isCubeTexture&&!1===r.isRenderTargetTexture&&(Rl.y*=-1,Rl.z*=-1),e.envMapRotation.value.setFromMatrix4(kl.makeRotationFromEuler(Rl)),e.flipEnvMap.value=r.isCubeTexture&&!1===r.isRenderTargetTexture?-1:1,e.reflectivity.value=s.reflectivity,e.ior.value=s.ior,e.refractionRatio.value=s.refractionRatio),s.lightMap&&(e.lightMap.value=s.lightMap,e.lightMapIntensity.value=s.lightMapIntensity,i(s.lightMap,e.lightMapTransform)),s.aoMap&&(e.aoMap.value=s.aoMap,e.aoMapIntensity.value=s.aoMapIntensity,i(s.aoMap,e.aoMapTransform))}return{refreshFogUniforms:function(t,i){i.color.getRGB(t.fogColor.value,Gs(e)),i.isFog?(t.fogNear.value=i.near,t.fogFar.value=i.far):i.isFogExp2&&(t.fogDensity.value=i.density)},refreshMaterialUniforms:function(e,n,r,a,o){n.isMeshBasicMaterial||n.isMeshLambertMaterial?s(e,n):n.isMeshToonMaterial?(s(e,n),function(e,t){t.gradientMap&&(e.gradientMap.value=t.gradientMap)}(e,n)):n.isMeshPhongMaterial?(s(e,n),function(e,t){e.specular.value.copy(t.specular),e.shininess.value=Math.max(t.shininess,1e-4)}(e,n)):n.isMeshStandardMaterial?(s(e,n),function(e,t){e.metalness.value=t.metalness,t.metalnessMap&&(e.metalnessMap.value=t.metalnessMap,i(t.metalnessMap,e.metalnessMapTransform));e.roughness.value=t.roughness,t.roughnessMap&&(e.roughnessMap.value=t.roughnessMap,i(t.roughnessMap,e.roughnessMapTransform));t.envMap&&(e.envMapIntensity.value=t.envMapIntensity)}(e,n),n.isMeshPhysicalMaterial&&function(e,t,s){e.ior.value=t.ior,t.sheen>0&&(e.sheenColor.value.copy(t.sheenColor).multiplyScalar(t.sheen),e.sheenRoughness.value=t.sheenRoughness,t.sheenColorMap&&(e.sheenColorMap.value=t.sheenColorMap,i(t.sheenColorMap,e.sheenColorMapTransform)),t.sheenRoughnessMap&&(e.sheenRoughnessMap.value=t.sheenRoughnessMap,i(t.sheenRoughnessMap,e.sheenRoughnessMapTransform)));t.clearcoat>0&&(e.clearcoat.value=t.clearcoat,e.clearcoatRoughness.value=t.clearcoatRoughness,t.clearcoatMap&&(e.clearcoatMap.value=t.clearcoatMap,i(t.clearcoatMap,e.clearcoatMapTransform)),t.clearcoatRoughnessMap&&(e.clearcoatRoughnessMap.value=t.clearcoatRoughnessMap,i(t.clearcoatRoughnessMap,e.clearcoatRoughnessMapTransform)),t.clearcoatNormalMap&&(e.clearcoatNormalMap.value=t.clearcoatNormalMap,i(t.clearcoatNormalMap,e.clearcoatNormalMapTransform),e.clearcoatNormalScale.value.copy(t.clearcoatNormalScale),1===t.side&&e.clearcoatNormalScale.value.negate()));t.dispersion>0&&(e.dispersion.value=t.dispersion);t.iridescence>0&&(e.iridescence.value=t.iridescence,e.iridescenceIOR.value=t.iridescenceIOR,e.iridescenceThicknessMinimum.value=t.iridescenceThicknessRange[0],e.iridescenceThicknessMaximum.value=t.iridescenceThicknessRange[1],t.iridescenceMap&&(e.iridescenceMap.value=t.iridescenceMap,i(t.iridescenceMap,e.iridescenceMapTransform)),t.iridescenceThicknessMap&&(e.iridescenceThicknessMap.value=t.iridescenceThicknessMap,i(t.iridescenceThicknessMap,e.iridescenceThicknessMapTransform)));t.transmission>0&&(e.transmission.value=t.transmission,e.transmissionSamplerMap.value=s.texture,e.transmissionSamplerSize.value.set(s.width,s.height),t.transmissionMap&&(e.transmissionMap.value=t.transmissionMap,i(t.transmissionMap,e.transmissionMapTransform)),e.thickness.value=t.thickness,t.thicknessMap&&(e.thicknessMap.value=t.thicknessMap,i(t.thicknessMap,e.thicknessMapTransform)),e.attenuationDistance.value=t.attenuationDistance,e.attenuationColor.value.copy(t.attenuationColor));t.anisotropy>0&&(e.anisotropyVector.value.set(t.anisotropy*Math.cos(t.anisotropyRotation),t.anisotropy*Math.sin(t.anisotropyRotation)),t.anisotropyMap&&(e.anisotropyMap.value=t.anisotropyMap,i(t.anisotropyMap,e.anisotropyMapTransform)));e.specularIntensity.value=t.specularIntensity,e.specularColor.value.copy(t.specularColor),t.specularColorMap&&(e.specularColorMap.value=t.specularColorMap,i(t.specularColorMap,e.specularColorMapTransform));t.specularIntensityMap&&(e.specularIntensityMap.value=t.specularIntensityMap,i(t.specularIntensityMap,e.specularIntensityMapTransform))}(e,n,o)):n.isMeshMatcapMaterial?(s(e,n),function(e,t){t.matcap&&(e.matcap.value=t.matcap)}(e,n)):n.isMeshDepthMaterial?s(e,n):n.isMeshDistanceMaterial?(s(e,n),function(e,i){const s=t.get(i).light;e.referencePosition.value.setFromMatrixPosition(s.matrixWorld),e.nearDistance.value=s.shadow.camera.near,e.farDistance.value=s.shadow.camera.far}(e,n)):n.isMeshNormalMaterial?s(e,n):n.isLineBasicMaterial?(function(e,t){e.diffuse.value.copy(t.color),e.opacity.value=t.opacity,t.map&&(e.map.value=t.map,i(t.map,e.mapTransform))}(e,n),n.isLineDashedMaterial&&function(e,t){e.dashSize.value=t.dashSize,e.totalSize.value=t.dashSize+t.gapSize,e.scale.value=t.scale}(e,n)):n.isPointsMaterial?function(e,t,s,n){e.diffuse.value.copy(t.color),e.opacity.value=t.opacity,e.size.value=t.size*s,e.scale.value=.5*n,t.map&&(e.map.value=t.map,i(t.map,e.uvTransform));t.alphaMap&&(e.alphaMap.value=t.alphaMap,i(t.alphaMap,e.alphaMapTransform));t.alphaTest>0&&(e.alphaTest.value=t.alphaTest)}(e,n,r,a):n.isSpriteMaterial?function(e,t){e.diffuse.value.copy(t.color),e.opacity.value=t.opacity,e.rotation.value=t.rotation,t.map&&(e.map.value=t.map,i(t.map,e.mapTransform));t.alphaMap&&(e.alphaMap.value=t.alphaMap,i(t.alphaMap,e.alphaMapTransform));t.alphaTest>0&&(e.alphaTest.value=t.alphaTest)}(e,n):n.isShadowMaterial?(e.color.value.copy(n.color),e.opacity.value=n.opacity):n.isShaderMaterial&&(n.uniformsNeedUpdate=!1)}}}function Il(e,t,i,s){let n={},r={},a=[];const o=e.getParameter(e.MAX_UNIFORM_BUFFER_BINDINGS);function l(e,t,i,s){const n=e.value,r=t+"_"+i;if(void 0===s[r])return s[r]="number"==typeof n||"boolean"==typeof n?n:n.clone(),!0;{const e=s[r];if("number"==typeof n||"boolean"==typeof n){if(e!==n)return s[r]=n,!0}else if(!1===e.equals(n))return e.copy(n),!0}return!1}function d(e){const t={boundary:0,storage:0};return"number"==typeof e||"boolean"==typeof e?(t.boundary=4,t.storage=4):e.isVector2?(t.boundary=8,t.storage=8):e.isVector3||e.isColor?(t.boundary=16,t.storage=12):e.isVector4?(t.boundary=16,t.storage=16):e.isMatrix3?(t.boundary=48,t.storage=48):e.isMatrix4?(t.boundary=64,t.storage=64):e.isTexture?console.warn("THREE.WebGLRenderer: Texture samplers can not be part of an uniforms group."):console.warn("THREE.WebGLRenderer: Unsupported uniform value type.",e),t}function c(t){const i=t.target;i.removeEventListener("dispose",c);const s=a.indexOf(i.__bindingPointIndex);a.splice(s,1),e.deleteBuffer(n[i.id]),delete n[i.id],delete r[i.id]}return{bind:function(e,t){const i=t.program;s.uniformBlockBinding(e,i)},update:function(i,h){let p=n[i.id];void 0===p&&(!function(e){const t=e.uniforms;let i=0;const s=16;for(let e=0,n=t.length;e<n;e++){const n=Array.isArray(t[e])?t[e]:[t[e]];for(let e=0,t=n.length;e<t;e++){const t=n[e],r=Array.isArray(t.value)?t.value:[t.value];for(let e=0,n=r.length;e<n;e++){const n=d(r[e]),a=i%s,o=a%n.boundary,l=a+o;i+=o,0!==l&&s-l<n.storage&&(i+=s-l),t.__data=new Float32Array(n.storage/Float32Array.BYTES_PER_ELEMENT),t.__offset=i,i+=n.storage}}}const n=i%s;n>0&&(i+=s-n);e.__size=i,e.__cache={}}(i),p=function(t){const i=function(){for(let e=0;e<o;e++)if(-1===a.indexOf(e))return a.push(e),e;return console.error("THREE.WebGLRenderer: Maximum number of simultaneously usable uniforms groups reached."),0}();t.__bindingPointIndex=i;const s=e.createBuffer(),n=t.__size,r=t.usage;return e.bindBuffer(e.UNIFORM_BUFFER,s),e.bufferData(e.UNIFORM_BUFFER,n,r),e.bindBuffer(e.UNIFORM_BUFFER,null),e.bindBufferBase(e.UNIFORM_BUFFER,i,s),s}(i),n[i.id]=p,i.addEventListener("dispose",c));const u=h.program;s.updateUBOMapping(i,u);const m=t.render.frame;r[i.id]!==m&&(!function(t){const i=n[t.id],s=t.uniforms,r=t.__cache;e.bindBuffer(e.UNIFORM_BUFFER,i);for(let t=0,i=s.length;t<i;t++){const i=Array.isArray(s[t])?s[t]:[s[t]];for(let s=0,n=i.length;s<n;s++){const n=i[s];if(!0===l(n,t,s,r)){const t=n.__offset,i=Array.isArray(n.value)?n.value:[n.value];let s=0;for(let r=0;r<i.length;r++){const a=i[r],o=d(a);"number"==typeof a||"boolean"==typeof a?(n.__data[0]=a,e.bufferSubData(e.UNIFORM_BUFFER,t+s,n.__data)):a.isMatrix3?(n.__data[0]=a.elements[0],n.__data[1]=a.elements[1],n.__data[2]=a.elements[2],n.__data[3]=0,n.__data[4]=a.elements[3],n.__data[5]=a.elements[4],n.__data[6]=a.elements[5],n.__data[7]=0,n.__data[8]=a.elements[6],n.__data[9]=a.elements[7],n.__data[10]=a.elements[8],n.__data[11]=0):(a.toArray(n.__data,s),s+=o.storage/Float32Array.BYTES_PER_ELEMENT)}e.bufferSubData(e.UNIFORM_BUFFER,t,n.__data)}}}e.bindBuffer(e.UNIFORM_BUFFER,null)}(i),r[i.id]=m)},dispose:function(){for(const t in n)e.deleteBuffer(n[t]);a=[],n={},r={}}}}class Pl{constructor(e={}){const{canvas:i=yt(),context:s=null,depth:n=!0,stencil:r=!1,alpha:a=!1,antialias:o=!1,premultipliedAlpha:l=!0,preserveDrawingBuffer:d=!1,powerPreference:c="default",failIfMajorPerformanceCaveat:h=!1,reverseDepthBuffer:p=!1}=e;let u;if(this.isWebGLRenderer=!0,null!==s){if("undefined"!=typeof WebGLRenderingContext&&s instanceof WebGLRenderingContext)throw new Error("THREE.WebGLRenderer: WebGL 1 is not supported since r163.");u=s.getContextAttributes().alpha}else u=a;const m=new Uint32Array(4),f=new Int32Array(4);let g=null,b=null;const C=[],v=[];this.domElement=i,this.debug={checkShaderErrors:!0,onShaderError:null},this.autoClear=!0,this.autoClearColor=!0,this.autoClearDepth=!0,this.autoClearStencil=!0,this.sortObjects=!0,this.clippingPlanes=[],this.localClippingEnabled=!1,this.toneMapping=0,this.toneMappingExposure=1,this.transmissionResolutionScale=1;const _=this;let y=!1;this._outputColorSpace=Be;let S=0,w=0,x=null,A=-1,M=null;const T=new Ut,E=new Ut;let R=null;const k=new ls(0);let O=0,I=i.width,P=i.height,D=1,L=null,F=null;const N=new Ut(0,0,I,P),U=new Ut(0,0,I,P);let H=!1;const B=new Dn;let z=!1,G=!1;const $=new gi,V=new gi,X=new mt,K=new Ut,te={background:null,fog:null,environment:null,overrideMaterial:null,isScene:!0};let ie=!1;function se(){return null===x?D:1}let ne,le,de,ce,he,pe,ue,me,fe,ge,be,Ce,ve,_e,ye,Se,we,xe,Ae,Me,Te,Ee,Re,ke,Oe=s;function Ie(e,t){return i.getContext(e,t)}try{const e={alpha:!0,depth:n,stencil:r,antialias:o,premultipliedAlpha:l,preserveDrawingBuffer:d,powerPreference:c,failIfMajorPerformanceCaveat:h};if("setAttribute"in i&&i.setAttribute("data-engine",`three.js r${t}`),i.addEventListener("webglcontextlost",Le,!1),i.addEventListener("webglcontextrestored",Fe,!1),i.addEventListener("webglcontextcreationerror",Ne,!1),null===Oe){const t="webgl2";if(Oe=Ie(t,e),null===Oe)throw Ie(t)?new Error("Error creating WebGL context with your selected attributes."):new Error("Error creating WebGL context.")}}catch(e){throw console.error("THREE.WebGLRenderer: "+e.message),e}function Pe(){ne=new Ra(Oe),ne.init(),Ee=new Ml(Oe,ne),le=new oa(Oe,ne,e,Ee),de=new xl(Oe,ne),le.reverseDepthBuffer&&p&&de.buffers.depth.setReversed(!0),ce=new Ia(Oe),he=new hl,pe=new Al(Oe,ne,de,he,le,Ee,ce),ue=new da(_),me=new Ea(_),fe=new Zr(Oe),Re=new ra(Oe,fe),ge=new ka(Oe,fe,ce,Re),be=new Da(Oe,ge,fe,ce),Ae=new Pa(Oe,le,pe),Se=new la(he),Ce=new cl(_,ue,me,ne,le,Re,Se),ve=new Ol(_,he),_e=new fl,ye=new yl(ne),xe=new na(_,ue,me,de,be,u,l),we=new Sl(_,be,le),ke=new Il(Oe,ce,le,de),Me=new aa(Oe,ne,ce),Te=new Oa(Oe,ne,ce),ce.programs=Ce.programs,_.capabilities=le,_.extensions=ne,_.properties=he,_.renderLists=_e,_.shadowMap=we,_.state=de,_.info=ce}Pe();const De=new El(_,Oe);function Le(e){e.preventDefault(),console.log("THREE.WebGLRenderer: Context Lost."),y=!0}function Fe(){console.log("THREE.WebGLRenderer: Context Restored."),y=!1;const e=ce.autoReset,t=we.enabled,i=we.autoUpdate,s=we.needsUpdate,n=we.type;Pe(),ce.autoReset=e,we.enabled=t,we.autoUpdate=i,we.needsUpdate=s,we.type=n}function Ne(e){console.error("THREE.WebGLRenderer: A WebGL context could not be created. Reason: ",e.statusMessage)}function Ue(e){const t=e.target;t.removeEventListener("dispose",Ue),function(e){(function(e){const t=he.get(e).programs;void 0!==t&&(t.forEach((function(e){Ce.releaseProgram(e)})),e.isShaderMaterial&&Ce.releaseShaderCache(e))})(e),he.remove(e)}(t)}function He(e,t,i){!0===e.transparent&&2===e.side&&!1===e.forceSinglePass?(e.side=1,e.needsUpdate=!0,Ze(e,t,i),e.side=0,e.needsUpdate=!0,Ze(e,t,i),e.side=2):Ze(e,t,i)}this.xr=De,this.getContext=function(){return Oe},this.getContextAttributes=function(){return Oe.getContextAttributes()},this.forceContextLoss=function(){const e=ne.get("WEBGL_lose_context");e&&e.loseContext()},this.forceContextRestore=function(){const e=ne.get("WEBGL_lose_context");e&&e.restoreContext()},this.getPixelRatio=function(){return D},this.setPixelRatio=function(e){void 0!==e&&(D=e,this.setSize(I,P,!1))},this.getSize=function(e){return e.set(I,P)},this.setSize=function(e,t,s=!0){De.isPresenting?console.warn("THREE.WebGLRenderer: Can't change size while VR device is presenting."):(I=e,P=t,i.width=Math.floor(e*D),i.height=Math.floor(t*D),!0===s&&(i.style.width=e+"px",i.style.height=t+"px"),this.setViewport(0,0,e,t))},this.getDrawingBufferSize=function(e){return e.set(I*D,P*D).floor()},this.setDrawingBufferSize=function(e,t,s){I=e,P=t,D=s,i.width=Math.floor(e*s),i.height=Math.floor(t*s),this.setViewport(0,0,e,t)},this.getCurrentViewport=function(e){return e.copy(T)},this.getViewport=function(e){return e.copy(N)},this.setViewport=function(e,t,i,s){e.isVector4?N.set(e.x,e.y,e.z,e.w):N.set(e,t,i,s),de.viewport(T.copy(N).multiplyScalar(D).round())},this.getScissor=function(e){return e.copy(U)},this.setScissor=function(e,t,i,s){e.isVector4?U.set(e.x,e.y,e.z,e.w):U.set(e,t,i,s),de.scissor(E.copy(U).multiplyScalar(D).round())},this.getScissorTest=function(){return H},this.setScissorTest=function(e){de.setScissorTest(H=e)},this.setOpaqueSort=function(e){L=e},this.setTransparentSort=function(e){F=e},this.getClearColor=function(e){return e.copy(xe.getClearColor())},this.setClearColor=function(){xe.setClearColor(...arguments)},this.getClearAlpha=function(){return xe.getClearAlpha()},this.setClearAlpha=function(){xe.setClearAlpha(...arguments)},this.clear=function(e=!0,t=!0,i=!0){let s=0;if(e){let e=!1;if(null!==x){const t=x.texture.format;e=t===oe||t===ae||t===re}if(e){const e=x.texture.type,t=e===j||e===Y||e===W||e===ee||e===J||e===Q,i=xe.getClearColor(),s=xe.getClearAlpha(),n=i.r,r=i.g,a=i.b;t?(m[0]=n,m[1]=r,m[2]=a,m[3]=s,Oe.clearBufferuiv(Oe.COLOR,0,m)):(f[0]=n,f[1]=r,f[2]=a,f[3]=s,Oe.clearBufferiv(Oe.COLOR,0,f))}else s|=Oe.COLOR_BUFFER_BIT}t&&(s|=Oe.DEPTH_BUFFER_BIT),i&&(s|=Oe.STENCIL_BUFFER_BIT,this.state.buffers.stencil.setMask(4294967295)),Oe.clear(s)},this.clearColor=function(){this.clear(!0,!1,!1)},this.clearDepth=function(){this.clear(!1,!0,!1)},this.clearStencil=function(){this.clear(!1,!1,!0)},this.dispose=function(){i.removeEventListener("webglcontextlost",Le,!1),i.removeEventListener("webglcontextrestored",Fe,!1),i.removeEventListener("webglcontextcreationerror",Ne,!1),xe.dispose(),_e.dispose(),ye.dispose(),he.dispose(),ue.dispose(),me.dispose(),be.dispose(),Re.dispose(),ke.dispose(),Ce.dispose(),De.dispose(),De.removeEventListener("sessionstart",je),De.removeEventListener("sessionend",Ge),$e.stop()},this.renderBufferDirect=function(e,t,i,s,n,r){null===t&&(t=te);const a=n.isMesh&&n.matrixWorld.determinant()<0,o=function(e,t,i,s,n){!0!==t.isScene&&(t=te);pe.resetTextureUnits();const r=t.fog,a=s.isMeshStandardMaterial?t.environment:null,o=null===x?_.outputColorSpace:!0===x.isXRRenderTarget?x.texture.colorSpace:ze,l=(s.isMeshStandardMaterial?me:ue).get(s.envMap||a),d=!0===s.vertexColors&&!!i.attributes.color&&4===i.attributes.color.itemSize,c=!!i.attributes.tangent&&(!!s.normalMap||s.anisotropy>0),h=!!i.morphAttributes.position,p=!!i.morphAttributes.normal,u=!!i.morphAttributes.color;let m=0;s.toneMapped&&(null!==x&&!0!==x.isXRRenderTarget||(m=_.toneMapping));const f=i.morphAttributes.position||i.morphAttributes.normal||i.morphAttributes.color,g=void 0!==f?f.length:0,C=he.get(s),v=b.state.lights;if(!0===z&&(!0===G||e!==M)){const t=e===M&&s.id===A;Se.setState(s,e,t)}let y=!1;s.version===C.__version?C.needsLights&&C.lightsStateVersion!==v.state.version||C.outputColorSpace!==o||n.isBatchedMesh&&!1===C.batching?y=!0:n.isBatchedMesh||!0!==C.batching?n.isBatchedMesh&&!0===C.batchingColor&&null===n.colorTexture||n.isBatchedMesh&&!1===C.batchingColor&&null!==n.colorTexture||n.isInstancedMesh&&!1===C.instancing?y=!0:n.isInstancedMesh||!0!==C.instancing?n.isSkinnedMesh&&!1===C.skinning?y=!0:n.isSkinnedMesh||!0!==C.skinning?n.isInstancedMesh&&!0===C.instancingColor&&null===n.instanceColor||n.isInstancedMesh&&!1===C.instancingColor&&null!==n.instanceColor||n.isInstancedMesh&&!0===C.instancingMorph&&null===n.morphTexture||n.isInstancedMesh&&!1===C.instancingMorph&&null!==n.morphTexture||C.envMap!==l||!0===s.fog&&C.fog!==r?y=!0:void 0===C.numClippingPlanes||C.numClippingPlanes===Se.numPlanes&&C.numIntersection===Se.numIntersection?(C.vertexAlphas!==d||C.vertexTangents!==c||C.morphTargets!==h||C.morphNormals!==p||C.morphColors!==u||C.toneMapping!==m||C.morphTargetsCount!==g)&&(y=!0):y=!0:y=!0:y=!0:y=!0:(y=!0,C.__version=s.version);let S=C.currentProgram;!0===y&&(S=Ze(s,t,n));let w=!1,T=!1,E=!1;const R=S.getUniforms(),k=C.uniforms;de.useProgram(S.program)&&(w=!0,T=!0,E=!0);s.id!==A&&(A=s.id,T=!0);if(w||M!==e){de.buffers.depth.getReversed()?($.copy(e.projectionMatrix),function(e){const t=e.elements;t[2]=.5*t[2]+.5*t[3],t[6]=.5*t[6]+.5*t[7],t[10]=.5*t[10]+.5*t[11],t[14]=.5*t[14]+.5*t[15]}($),function(e){const t=e.elements;-1===t[11]?(t[10]=-t[10]-1,t[14]=-t[14]):(t[10]=-t[10],t[14]=1-t[14])}($),R.setValue(Oe,"projectionMatrix",$)):R.setValue(Oe,"projectionMatrix",e.projectionMatrix),R.setValue(Oe,"viewMatrix",e.matrixWorldInverse);const t=R.map.cameraPosition;void 0!==t&&t.setValue(Oe,X.setFromMatrixPosition(e.matrixWorld)),le.logarithmicDepthBuffer&&R.setValue(Oe,"logDepthBufFC",2/(Math.log(e.far+1)/Math.LN2)),(s.isMeshPhongMaterial||s.isMeshToonMaterial||s.isMeshLambertMaterial||s.isMeshBasicMaterial||s.isMeshStandardMaterial||s.isShaderMaterial)&&R.setValue(Oe,"isOrthographic",!0===e.isOrthographicCamera),M!==e&&(M=e,T=!0,E=!0)}if(n.isSkinnedMesh){R.setOptional(Oe,n,"bindMatrix"),R.setOptional(Oe,n,"bindMatrixInverse");const e=n.skeleton;e&&(null===e.boneTexture&&e.computeBoneTexture(),R.setValue(Oe,"boneTexture",e.boneTexture,pe))}n.isBatchedMesh&&(R.setOptional(Oe,n,"batchingTexture"),R.setValue(Oe,"batchingTexture",n._matricesTexture,pe),R.setOptional(Oe,n,"batchingIdTexture"),R.setValue(Oe,"batchingIdTexture",n._indirectTexture,pe),R.setOptional(Oe,n,"batchingColorTexture"),null!==n._colorsTexture&&R.setValue(Oe,"batchingColorTexture",n._colorsTexture,pe));const O=i.morphAttributes;void 0===O.position&&void 0===O.normal&&void 0===O.color||Ae.update(n,i,S);(T||C.receiveShadow!==n.receiveShadow)&&(C.receiveShadow=n.receiveShadow,R.setValue(Oe,"receiveShadow",n.receiveShadow));s.isMeshGouraudMaterial&&null!==s.envMap&&(k.envMap.value=l,k.flipEnvMap.value=l.isCubeTexture&&!1===l.isRenderTargetTexture?-1:1);s.isMeshStandardMaterial&&null===s.envMap&&null!==t.environment&&(k.envMapIntensity.value=t.environmentIntensity);T&&(R.setValue(Oe,"toneMappingExposure",_.toneMappingExposure),C.needsLights&&(L=E,(I=k).ambientLightColor.needsUpdate=L,I.lightProbe.needsUpdate=L,I.directionalLights.needsUpdate=L,I.directionalLightShadows.needsUpdate=L,I.pointLights.needsUpdate=L,I.pointLightShadows.needsUpdate=L,I.spotLights.needsUpdate=L,I.spotLightShadows.needsUpdate=L,I.rectAreaLights.needsUpdate=L,I.hemisphereLights.needsUpdate=L),r&&!0===s.fog&&ve.refreshFogUniforms(k,r),ve.refreshMaterialUniforms(k,s,D,P,b.state.transmissionRenderTarget[e.id]),Bo.upload(Oe,Je(C),k,pe));var I,L;s.isShaderMaterial&&!0===s.uniformsNeedUpdate&&(Bo.upload(Oe,Je(C),k,pe),s.uniformsNeedUpdate=!1);s.isSpriteMaterial&&R.setValue(Oe,"center",n.center);if(R.setValue(Oe,"modelViewMatrix",n.modelViewMatrix),R.setValue(Oe,"normalMatrix",n.normalMatrix),R.setValue(Oe,"modelMatrix",n.matrixWorld),s.isShaderMaterial||s.isRawShaderMaterial){const e=s.uniformsGroups;for(let t=0,i=e.length;t<i;t++){const i=e[t];ke.update(i,S),ke.bind(i,S)}}return S}(e,t,i,s,n);de.setMaterial(s,a);let l=i.index,d=1;if(!0===s.wireframe){if(l=ge.getWireframeAttribute(i),void 0===l)return;d=2}const c=i.drawRange,h=i.attributes.position;let p=c.start*d,u=(c.start+c.count)*d;null!==r&&(p=Math.max(p,r.start*d),u=Math.min(u,(r.start+r.count)*d)),null!==l?(p=Math.max(p,0),u=Math.min(u,l.count)):null!=h&&(p=Math.max(p,0),u=Math.min(u,h.count));const m=u-p;if(m<0||m===1/0)return;let f;Re.setup(n,s,o,i,l);let g=Me;if(null!==l&&(f=fe.get(l),g=Te,g.setIndex(f)),n.isMesh)!0===s.wireframe?(de.setLineWidth(s.wireframeLinewidth*se()),g.setMode(Oe.LINES)):g.setMode(Oe.TRIANGLES);else if(n.isLine){let e=s.linewidth;void 0===e&&(e=1),de.setLineWidth(e*se()),n.isLineSegments?g.setMode(Oe.LINES):n.isLineLoop?g.setMode(Oe.LINE_LOOP):g.setMode(Oe.LINE_STRIP)}else n.isPoints?g.setMode(Oe.POINTS):n.isSprite&&g.setMode(Oe.TRIANGLES);if(n.isBatchedMesh)if(null!==n._multiDrawInstances)wt("THREE.WebGLRenderer: renderMultiDrawInstances has been deprecated and will be removed in r184. Append to renderMultiDraw arguments and use indirection."),g.renderMultiDrawInstances(n._multiDrawStarts,n._multiDrawCounts,n._multiDrawCount,n._multiDrawInstances);else if(ne.get("WEBGL_multi_draw"))g.renderMultiDraw(n._multiDrawStarts,n._multiDrawCounts,n._multiDrawCount);else{const e=n._multiDrawStarts,t=n._multiDrawCounts,i=n._multiDrawCount,r=l?fe.get(l).bytesPerElement:1,a=he.get(s).currentProgram.getUniforms();for(let s=0;s<i;s++)a.setValue(Oe,"_gl_DrawID",s),g.render(e[s]/r,t[s])}else if(n.isInstancedMesh)g.renderInstances(p,m,n.count);else if(i.isInstancedBufferGeometry){const e=void 0!==i._maxInstanceCount?i._maxInstanceCount:1/0,t=Math.min(i.instanceCount,e);g.renderInstances(p,m,t)}else g.render(p,m)},this.compile=function(e,t,i=null){null===i&&(i=e),b=ye.get(i),b.init(t),v.push(b),i.traverseVisible((function(e){e.isLight&&e.layers.test(t.layers)&&(b.pushLight(e),e.castShadow&&b.pushShadow(e))})),e!==i&&e.traverseVisible((function(e){e.isLight&&e.layers.test(t.layers)&&(b.pushLight(e),e.castShadow&&b.pushShadow(e))})),b.setupLights();const s=new Set;return e.traverse((function(e){if(!(e.isMesh||e.isPoints||e.isLine||e.isSprite))return;const t=e.material;if(t)if(Array.isArray(t))for(let n=0;n<t.length;n++){const r=t[n];He(r,i,e),s.add(r)}else He(t,i,e),s.add(t)})),b=v.pop(),s},this.compileAsync=function(e,t,i=null){const s=this.compile(e,t,i);return new Promise((t=>{function i(){s.forEach((function(e){he.get(e).currentProgram.isReady()&&s.delete(e)})),0!==s.size?setTimeout(i,10):t(e)}null!==ne.get("KHR_parallel_shader_compile")?i():setTimeout(i,10)}))};let qe=null;function je(){$e.stop()}function Ge(){$e.start()}const $e=new Kr;function Ve(e,t,i,s){if(!1===e.visible)return;if(e.layers.test(t.layers))if(e.isGroup)i=e.renderOrder;else if(e.isLOD)!0===e.autoUpdate&&e.update(t);else if(e.isLight)b.pushLight(e),e.castShadow&&b.pushShadow(e);else if(e.isSprite){if(!e.frustumCulled||B.intersectsSprite(e)){s&&K.setFromMatrixPosition(e.matrixWorld).applyMatrix4(V);const t=be.update(e),n=e.material;n.visible&&g.push(e,t,n,i,K.z,null)}}else if((e.isMesh||e.isLine||e.isPoints)&&(!e.frustumCulled||B.intersectsObject(e))){const t=be.update(e),n=e.material;if(s&&(void 0!==e.boundingSphere?(null===e.boundingSphere&&e.computeBoundingSphere(),K.copy(e.boundingSphere.center)):(null===t.boundingSphere&&t.computeBoundingSphere(),K.copy(t.boundingSphere.center)),K.applyMatrix4(e.matrixWorld).applyMatrix4(V)),Array.isArray(n)){const s=t.groups;for(let r=0,a=s.length;r<a;r++){const a=s[r],o=n[a.materialIndex];o&&o.visible&&g.push(e,t,o,i,K.z,a)}}else n.visible&&g.push(e,t,n,i,K.z,null)}const n=e.children;for(let e=0,r=n.length;e<r;e++)Ve(n[e],t,i,s)}function We(e,t,i,s){const n=e.opaque,r=e.transmissive,a=e.transparent;b.setupLightsView(i),!0===z&&Se.setGlobalState(_.clippingPlanes,i),s&&de.viewport(T.copy(s)),n.length>0&&Ye(n,t,i),r.length>0&&Ye(r,t,i),a.length>0&&Ye(a,t,i),de.buffers.depth.setTest(!0),de.buffers.depth.setMask(!0),de.buffers.color.setMask(!0),de.setPolygonOffset(!1)}function Xe(e,t,i,s){if(null!==(!0===i.isScene?i.overrideMaterial:null))return;void 0===b.state.transmissionRenderTarget[s.id]&&(b.state.transmissionRenderTarget[s.id]=new Bt(1,1,{generateMipmaps:!0,type:ne.has("EXT_color_buffer_half_float")||ne.has("EXT_color_buffer_float")?Z:j,minFilter:q,samples:4,stencilBuffer:r,resolveDepthBuffer:!1,resolveStencilBuffer:!1,colorSpace:Tt.workingColorSpace}));const n=b.state.transmissionRenderTarget[s.id],a=s.viewport||T;n.setSize(a.z*_.transmissionResolutionScale,a.w*_.transmissionResolutionScale);const o=_.getRenderTarget();_.setRenderTarget(n),_.getClearColor(k),O=_.getClearAlpha(),O<1&&_.setClearColor(16777215,.5),_.clear(),ie&&xe.render(i);const l=_.toneMapping;_.toneMapping=0;const d=s.viewport;if(void 0!==s.viewport&&(s.viewport=void 0),b.setupLightsView(s),!0===z&&Se.setGlobalState(_.clippingPlanes,s),Ye(e,i,s),pe.updateMultisampleRenderTarget(n),pe.updateRenderTargetMipmap(n),!1===ne.has("WEBGL_multisampled_render_to_texture")){let e=!1;for(let n=0,r=t.length;n<r;n++){const r=t[n],a=r.object,o=r.geometry,l=r.material,d=r.group;if(2===l.side&&a.layers.test(s.layers)){const t=l.side;l.side=1,l.needsUpdate=!0,Ke(a,i,s,o,l,d),l.side=t,l.needsUpdate=!0,e=!0}}!0===e&&(pe.updateMultisampleRenderTarget(n),pe.updateRenderTargetMipmap(n))}_.setRenderTarget(o),_.setClearColor(k,O),void 0!==d&&(s.viewport=d),_.toneMapping=l}function Ye(e,t,i){const s=!0===t.isScene?t.overrideMaterial:null;for(let n=0,r=e.length;n<r;n++){const r=e[n],a=r.object,o=r.geometry,l=r.group;let d=r.material;!0===d.allowOverride&&null!==s&&(d=s),a.layers.test(i.layers)&&Ke(a,t,i,o,d,l)}}function Ke(e,t,i,s,n,r){e.onBeforeRender(_,t,i,s,n,r),e.modelViewMatrix.multiplyMatrices(i.matrixWorldInverse,e.matrixWorld),e.normalMatrix.getNormalMatrix(e.modelViewMatrix),n.onBeforeRender(_,t,i,s,e,r),!0===n.transparent&&2===n.side&&!1===n.forceSinglePass?(n.side=1,n.needsUpdate=!0,_.renderBufferDirect(i,t,s,n,e,r),n.side=0,n.needsUpdate=!0,_.renderBufferDirect(i,t,s,n,e,r),n.side=2):_.renderBufferDirect(i,t,s,n,e,r),e.onAfterRender(_,t,i,s,n,r)}function Ze(e,t,i){!0!==t.isScene&&(t=te);const s=he.get(e),n=b.state.lights,r=b.state.shadowsArray,a=n.state.version,o=Ce.getParameters(e,n.state,r,t,i),l=Ce.getProgramCacheKey(o);let d=s.programs;s.environment=e.isMeshStandardMaterial?t.environment:null,s.fog=t.fog,s.envMap=(e.isMeshStandardMaterial?me:ue).get(e.envMap||s.environment),s.envMapRotation=null!==s.environment&&null===e.envMap?t.environmentRotation:e.envMapRotation,void 0===d&&(e.addEventListener("dispose",Ue),d=new Map,s.programs=d);let c=d.get(l);if(void 0!==c){if(s.currentProgram===c&&s.lightsStateVersion===a)return Qe(e,o),c}else o.uniforms=Ce.getUniforms(e),e.onBeforeCompile(o,_),c=Ce.acquireProgram(o,l),d.set(l,c),s.uniforms=o.uniforms;const h=s.uniforms;return(e.isShaderMaterial||e.isRawShaderMaterial)&&!0!==e.clipping||(h.clippingPlanes=Se.uniform),Qe(e,o),s.needsLights=function(e){return e.isMeshLambertMaterial||e.isMeshToonMaterial||e.isMeshPhongMaterial||e.isMeshStandardMaterial||e.isShadowMaterial||e.isShaderMaterial&&!0===e.lights}(e),s.lightsStateVersion=a,s.needsLights&&(h.ambientLightColor.value=n.state.ambient,h.lightProbe.value=n.state.probe,h.directionalLights.value=n.state.directional,h.directionalLightShadows.value=n.state.directionalShadow,h.spotLights.value=n.state.spot,h.spotLightShadows.value=n.state.spotShadow,h.rectAreaLights.value=n.state.rectArea,h.ltc_1.value=n.state.rectAreaLTC1,h.ltc_2.value=n.state.rectAreaLTC2,h.pointLights.value=n.state.point,h.pointLightShadows.value=n.state.pointShadow,h.hemisphereLights.value=n.state.hemi,h.directionalShadowMap.value=n.state.directionalShadowMap,h.directionalShadowMatrix.value=n.state.directionalShadowMatrix,h.spotShadowMap.value=n.state.spotShadowMap,h.spotLightMatrix.value=n.state.spotLightMatrix,h.spotLightMap.value=n.state.spotLightMap,h.pointShadowMap.value=n.state.pointShadowMap,h.pointShadowMatrix.value=n.state.pointShadowMatrix),s.currentProgram=c,s.uniformsList=null,c}function Je(e){if(null===e.uniformsList){const t=e.currentProgram.getUniforms();e.uniformsList=Bo.seqWithValue(t.seq,e.uniforms)}return e.uniformsList}function Qe(e,t){const i=he.get(e);i.outputColorSpace=t.outputColorSpace,i.batching=t.batching,i.batchingColor=t.batchingColor,i.instancing=t.instancing,i.instancingColor=t.instancingColor,i.instancingMorph=t.instancingMorph,i.skinning=t.skinning,i.morphTargets=t.morphTargets,i.morphNormals=t.morphNormals,i.morphColors=t.morphColors,i.morphTargetsCount=t.morphTargetsCount,i.numClippingPlanes=t.numClippingPlanes,i.numIntersection=t.numClipIntersection,i.vertexAlphas=t.vertexAlphas,i.vertexTangents=t.vertexTangents,i.toneMapping=t.toneMapping}$e.setAnimationLoop((function(e){qe&&qe(e)})),"undefined"!=typeof self&&$e.setContext(self),this.setAnimationLoop=function(e){qe=e,De.setAnimationLoop(e),null===e?$e.stop():$e.start()},De.addEventListener("sessionstart",je),De.addEventListener("sessionend",Ge),this.render=function(e,t){if(void 0!==t&&!0!==t.isCamera)return void console.error("THREE.WebGLRenderer.render: camera is not an instance of THREE.Camera.");if(!0===y)return;if(!0===e.matrixWorldAutoUpdate&&e.updateMatrixWorld(),null===t.parent&&!0===t.matrixWorldAutoUpdate&&t.updateMatrixWorld(),!0===De.enabled&&!0===De.isPresenting&&(!0===De.cameraAutoUpdate&&De.updateCamera(t),t=De.getCamera()),!0===e.isScene&&e.onBeforeRender(_,e,t,x),b=ye.get(e,v.length),b.init(t),v.push(b),V.multiplyMatrices(t.projectionMatrix,t.matrixWorldInverse),B.setFromProjectionMatrix(V),G=this.localClippingEnabled,z=Se.init(this.clippingPlanes,G),g=_e.get(e,C.length),g.init(),C.push(g),!0===De.enabled&&!0===De.isPresenting){const e=_.xr.getDepthSensingMesh();null!==e&&Ve(e,t,-1/0,_.sortObjects)}Ve(e,t,0,_.sortObjects),g.finish(),!0===_.sortObjects&&g.sort(L,F),ie=!1===De.enabled||!1===De.isPresenting||!1===De.hasDepthSensing(),ie&&xe.addToRenderList(g,e),this.info.render.frame++,!0===z&&Se.beginShadows();const i=b.state.shadowsArray;we.render(i,e,t),!0===z&&Se.endShadows(),!0===this.info.autoReset&&this.info.reset();const s=g.opaque,n=g.transmissive;if(b.setupLights(),t.isArrayCamera){const i=t.cameras;if(n.length>0)for(let t=0,r=i.length;t<r;t++){Xe(s,n,e,i[t])}ie&&xe.render(e);for(let t=0,s=i.length;t<s;t++){const s=i[t];We(g,e,s,s.viewport)}}else n.length>0&&Xe(s,n,e,t),ie&&xe.render(e),We(g,e,t);null!==x&&0===w&&(pe.updateMultisampleRenderTarget(x),pe.updateRenderTargetMipmap(x)),!0===e.isScene&&e.onAfterRender(_,e,t),Re.resetDefaultState(),A=-1,M=null,v.pop(),v.length>0?(b=v[v.length-1],!0===z&&Se.setGlobalState(_.clippingPlanes,b.state.camera)):b=null,C.pop(),g=C.length>0?C[C.length-1]:null},this.getActiveCubeFace=function(){return S},this.getActiveMipmapLevel=function(){return w},this.getRenderTarget=function(){return x},this.setRenderTargetTextures=function(e,t,i){const s=he.get(e);s.__autoAllocateDepthBuffer=!1===e.resolveDepthBuffer,!1===s.__autoAllocateDepthBuffer&&(s.__useRenderToTexture=!1),he.get(e.texture).__webglTexture=t,he.get(e.depthTexture).__webglTexture=s.__autoAllocateDepthBuffer?void 0:i,s.__hasExternalTextures=!0},this.setRenderTargetFramebuffer=function(e,t){const i=he.get(e);i.__webglFramebuffer=t,i.__useDefaultFramebuffer=void 0===t};const et=Oe.createFramebuffer();this.setRenderTarget=function(e,t=0,i=0){x=e,S=t,w=i;let s=!0,n=null,r=!1,a=!1;if(e){const o=he.get(e);if(void 0!==o.__useDefaultFramebuffer)de.bindFramebuffer(Oe.FRAMEBUFFER,null),s=!1;else if(void 0===o.__webglFramebuffer)pe.setupRenderTarget(e);else if(o.__hasExternalTextures)pe.rebindTextures(e,he.get(e.texture).__webglTexture,he.get(e.depthTexture).__webglTexture);else if(e.depthBuffer){const t=e.depthTexture;if(o.__boundDepthTexture!==t){if(null!==t&&he.has(t)&&(e.width!==t.image.width||e.height!==t.image.height))throw new Error("WebGLRenderTarget: Attached DepthTexture is initialized to the incorrect size.");pe.setupDepthRenderbuffer(e)}}const l=e.texture;(l.isData3DTexture||l.isDataArrayTexture||l.isCompressedArrayTexture)&&(a=!0);const d=he.get(e).__webglFramebuffer;e.isWebGLCubeRenderTarget?(n=Array.isArray(d[t])?d[t][i]:d[t],r=!0):n=e.samples>0&&!1===pe.useMultisampledRTT(e)?he.get(e).__webglMultisampledFramebuffer:Array.isArray(d)?d[i]:d,T.copy(e.viewport),E.copy(e.scissor),R=e.scissorTest}else T.copy(N).multiplyScalar(D).floor(),E.copy(U).multiplyScalar(D).floor(),R=H;0!==i&&(n=et);if(de.bindFramebuffer(Oe.FRAMEBUFFER,n)&&s&&de.drawBuffers(e,n),de.viewport(T),de.scissor(E),de.setScissorTest(R),r){const s=he.get(e.texture);Oe.framebufferTexture2D(Oe.FRAMEBUFFER,Oe.COLOR_ATTACHMENT0,Oe.TEXTURE_CUBE_MAP_POSITIVE_X+t,s.__webglTexture,i)}else if(a){const s=he.get(e.texture),n=t;Oe.framebufferTextureLayer(Oe.FRAMEBUFFER,Oe.COLOR_ATTACHMENT0,s.__webglTexture,i,n)}else if(null!==e&&0!==i){const t=he.get(e.texture);Oe.framebufferTexture2D(Oe.FRAMEBUFFER,Oe.COLOR_ATTACHMENT0,Oe.TEXTURE_2D,t.__webglTexture,i)}A=-1},this.readRenderTargetPixels=function(e,t,i,s,n,r,a,o=0){if(!e||!e.isWebGLRenderTarget)return void console.error("THREE.WebGLRenderer.readRenderTargetPixels: renderTarget is not THREE.WebGLRenderTarget.");let l=he.get(e).__webglFramebuffer;if(e.isWebGLCubeRenderTarget&&void 0!==a&&(l=l[a]),l){de.bindFramebuffer(Oe.FRAMEBUFFER,l);try{const a=e.textures[o],l=a.format,d=a.type;if(!le.textureFormatReadable(l))return void console.error("THREE.WebGLRenderer.readRenderTargetPixels: renderTarget is not in RGBA or implementation defined format.");if(!le.textureTypeReadable(d))return void console.error("THREE.WebGLRenderer.readRenderTargetPixels: renderTarget is not in UnsignedByteType or implementation defined type.");t>=0&&t<=e.width-s&&i>=0&&i<=e.height-n&&(e.textures.length>1&&Oe.readBuffer(Oe.COLOR_ATTACHMENT0+o),Oe.readPixels(t,i,s,n,Ee.convert(l),Ee.convert(d),r))}finally{const e=null!==x?he.get(x).__webglFramebuffer:null;de.bindFramebuffer(Oe.FRAMEBUFFER,e)}}},this.readRenderTargetPixelsAsync=async function(e,t,i,s,n,r,a,o=0){if(!e||!e.isWebGLRenderTarget)throw new Error("THREE.WebGLRenderer.readRenderTargetPixels: renderTarget is not THREE.WebGLRenderTarget.");let l=he.get(e).__webglFramebuffer;if(e.isWebGLCubeRenderTarget&&void 0!==a&&(l=l[a]),l){if(t>=0&&t<=e.width-s&&i>=0&&i<=e.height-n){de.bindFramebuffer(Oe.FRAMEBUFFER,l);const a=e.textures[o],d=a.format,c=a.type;if(!le.textureFormatReadable(d))throw new Error("THREE.WebGLRenderer.readRenderTargetPixelsAsync: renderTarget is not in RGBA or implementation defined format.");if(!le.textureTypeReadable(c))throw new Error("THREE.WebGLRenderer.readRenderTargetPixelsAsync: renderTarget is not in UnsignedByteType or implementation defined type.");const h=Oe.createBuffer();Oe.bindBuffer(Oe.PIXEL_PACK_BUFFER,h),Oe.bufferData(Oe.PIXEL_PACK_BUFFER,r.byteLength,Oe.STREAM_READ),e.textures.length>1&&Oe.readBuffer(Oe.COLOR_ATTACHMENT0+o),Oe.readPixels(t,i,s,n,Ee.convert(d),Ee.convert(c),0);const p=null!==x?he.get(x).__webglFramebuffer:null;de.bindFramebuffer(Oe.FRAMEBUFFER,p);const u=Oe.fenceSync(Oe.SYNC_GPU_COMMANDS_COMPLETE,0);return Oe.flush(),await function(e,t,i){return new Promise((function(s,n){setTimeout((function r(){switch(e.clientWaitSync(t,e.SYNC_FLUSH_COMMANDS_BIT,0)){case e.WAIT_FAILED:n();break;case e.TIMEOUT_EXPIRED:setTimeout(r,i);break;default:s()}}),i)}))}(Oe,u,4),Oe.bindBuffer(Oe.PIXEL_PACK_BUFFER,h),Oe.getBufferSubData(Oe.PIXEL_PACK_BUFFER,0,r),Oe.deleteBuffer(h),Oe.deleteSync(u),r}throw new Error("THREE.WebGLRenderer.readRenderTargetPixelsAsync: requested read bounds are out of range.")}},this.copyFramebufferToTexture=function(e,t=null,i=0){const s=Math.pow(2,-i),n=Math.floor(e.image.width*s),r=Math.floor(e.image.height*s),a=null!==t?t.x:0,o=null!==t?t.y:0;pe.setTexture2D(e,0),Oe.copyTexSubImage2D(Oe.TEXTURE_2D,i,0,0,a,o,n,r),de.unbindTexture()};const tt=Oe.createFramebuffer(),it=Oe.createFramebuffer();this.copyTextureToTexture=function(e,t,i=null,s=null,n=0,r=null){let a,o,l,d,c,h,p,u,m;null===r&&(0!==n?(wt("WebGLRenderer: copyTextureToTexture function signature has changed to support src and dst mipmap levels."),r=n,n=0):r=0);const f=e.isCompressedTexture?e.mipmaps[r]:e.image;if(null!==i)a=i.max.x-i.min.x,o=i.max.y-i.min.y,l=i.isBox3?i.max.z-i.min.z:1,d=i.min.x,c=i.min.y,h=i.isBox3?i.min.z:0;else{const t=Math.pow(2,-n);a=Math.floor(f.width*t),o=Math.floor(f.height*t),l=e.isDataArrayTexture?f.depth:e.isData3DTexture?Math.floor(f.depth*t):1,d=0,c=0,h=0}null!==s?(p=s.x,u=s.y,m=s.z):(p=0,u=0,m=0);const g=Ee.convert(t.format),b=Ee.convert(t.type);let C;t.isData3DTexture?(pe.setTexture3D(t,0),C=Oe.TEXTURE_3D):t.isDataArrayTexture||t.isCompressedArrayTexture?(pe.setTexture2DArray(t,0),C=Oe.TEXTURE_2D_ARRAY):(pe.setTexture2D(t,0),C=Oe.TEXTURE_2D),Oe.pixelStorei(Oe.UNPACK_FLIP_Y_WEBGL,t.flipY),Oe.pixelStorei(Oe.UNPACK_PREMULTIPLY_ALPHA_WEBGL,t.premultiplyAlpha),Oe.pixelStorei(Oe.UNPACK_ALIGNMENT,t.unpackAlignment);const v=Oe.getParameter(Oe.UNPACK_ROW_LENGTH),_=Oe.getParameter(Oe.UNPACK_IMAGE_HEIGHT),y=Oe.getParameter(Oe.UNPACK_SKIP_PIXELS),S=Oe.getParameter(Oe.UNPACK_SKIP_ROWS),w=Oe.getParameter(Oe.UNPACK_SKIP_IMAGES);Oe.pixelStorei(Oe.UNPACK_ROW_LENGTH,f.width),Oe.pixelStorei(Oe.UNPACK_IMAGE_HEIGHT,f.height),Oe.pixelStorei(Oe.UNPACK_SKIP_PIXELS,d),Oe.pixelStorei(Oe.UNPACK_SKIP_ROWS,c),Oe.pixelStorei(Oe.UNPACK_SKIP_IMAGES,h);const x=e.isDataArrayTexture||e.isData3DTexture,A=t.isDataArrayTexture||t.isData3DTexture;if(e.isDepthTexture){const i=he.get(e),s=he.get(t),f=he.get(i.__renderTarget),g=he.get(s.__renderTarget);de.bindFramebuffer(Oe.READ_FRAMEBUFFER,f.__webglFramebuffer),de.bindFramebuffer(Oe.DRAW_FRAMEBUFFER,g.__webglFramebuffer);for(let i=0;i<l;i++)x&&(Oe.framebufferTextureLayer(Oe.READ_FRAMEBUFFER,Oe.COLOR_ATTACHMENT0,he.get(e).__webglTexture,n,h+i),Oe.framebufferTextureLayer(Oe.DRAW_FRAMEBUFFER,Oe.COLOR_ATTACHMENT0,he.get(t).__webglTexture,r,m+i)),Oe.blitFramebuffer(d,c,a,o,p,u,a,o,Oe.DEPTH_BUFFER_BIT,Oe.NEAREST);de.bindFramebuffer(Oe.READ_FRAMEBUFFER,null),de.bindFramebuffer(Oe.DRAW_FRAMEBUFFER,null)}else if(0!==n||e.isRenderTargetTexture||he.has(e)){const i=he.get(e),s=he.get(t);de.bindFramebuffer(Oe.READ_FRAMEBUFFER,tt),de.bindFramebuffer(Oe.DRAW_FRAMEBUFFER,it);for(let e=0;e<l;e++)x?Oe.framebufferTextureLayer(Oe.READ_FRAMEBUFFER,Oe.COLOR_ATTACHMENT0,i.__webglTexture,n,h+e):Oe.framebufferTexture2D(Oe.READ_FRAMEBUFFER,Oe.COLOR_ATTACHMENT0,Oe.TEXTURE_2D,i.__webglTexture,n),A?Oe.framebufferTextureLayer(Oe.DRAW_FRAMEBUFFER,Oe.COLOR_ATTACHMENT0,s.__webglTexture,r,m+e):Oe.framebufferTexture2D(Oe.DRAW_FRAMEBUFFER,Oe.COLOR_ATTACHMENT0,Oe.TEXTURE_2D,s.__webglTexture,r),0!==n?Oe.blitFramebuffer(d,c,a,o,p,u,a,o,Oe.COLOR_BUFFER_BIT,Oe.NEAREST):A?Oe.copyTexSubImage3D(C,r,p,u,m+e,d,c,a,o):Oe.copyTexSubImage2D(C,r,p,u,d,c,a,o);de.bindFramebuffer(Oe.READ_FRAMEBUFFER,null),de.bindFramebuffer(Oe.DRAW_FRAMEBUFFER,null)}else A?e.isDataTexture||e.isData3DTexture?Oe.texSubImage3D(C,r,p,u,m,a,o,l,g,b,f.data):t.isCompressedArrayTexture?Oe.compressedTexSubImage3D(C,r,p,u,m,a,o,l,g,f.data):Oe.texSubImage3D(C,r,p,u,m,a,o,l,g,b,f):e.isDataTexture?Oe.texSubImage2D(Oe.TEXTURE_2D,r,p,u,a,o,g,b,f.data):e.isCompressedTexture?Oe.compressedTexSubImage2D(Oe.TEXTURE_2D,r,p,u,f.width,f.height,g,f.data):Oe.texSubImage2D(Oe.TEXTURE_2D,r,p,u,a,o,g,b,f);Oe.pixelStorei(Oe.UNPACK_ROW_LENGTH,v),Oe.pixelStorei(Oe.UNPACK_IMAGE_HEIGHT,_),Oe.pixelStorei(Oe.UNPACK_SKIP_PIXELS,y),Oe.pixelStorei(Oe.UNPACK_SKIP_ROWS,S),Oe.pixelStorei(Oe.UNPACK_SKIP_IMAGES,w),0===r&&t.generateMipmaps&&Oe.generateMipmap(C),de.unbindTexture()},this.copyTextureToTexture3D=function(e,t,i=null,s=null,n=0){return wt('WebGLRenderer: copyTextureToTexture3D function has been deprecated. Use "copyTextureToTexture" instead.'),this.copyTextureToTexture(e,t,i,s,n)},this.initRenderTarget=function(e){void 0===he.get(e).__webglFramebuffer&&pe.setupRenderTarget(e)},this.initTexture=function(e){e.isCubeTexture?pe.setTextureCube(e,0):e.isData3DTexture?pe.setTexture3D(e,0):e.isDataArrayTexture||e.isCompressedArrayTexture?pe.setTexture2DArray(e,0):pe.setTexture2D(e,0),de.unbindTexture()},this.resetState=function(){S=0,w=0,x=null,de.reset(),Re.reset()},"undefined"!=typeof __THREE_DEVTOOLS__&&__THREE_DEVTOOLS__.dispatchEvent(new CustomEvent("observe",{detail:this}))}get coordinateSystem(){return tt}get outputColorSpace(){return this._outputColorSpace}set outputColorSpace(e){this._outputColorSpace=e;const t=this.getContext();t.drawingBufferColorSpace=Tt._getDrawingBufferColorSpace(e),t.unpackColorSpace=Tt._getUnpackColorSpace()}}class Dl{constructor(e){this.icn3dui=e}cloneHash(e){this.icn3dui;let t={};void 0===e&&(e={});for(let i in e)t[i]=e[i];return t}intHash(e,t){this.icn3dui;let i={};if(void 0===e&&(e={}),void 0===t&&(t={}),Object.keys(e).length<Object.keys(t).length)for(let s in e)void 0!==t&&t[s]&&(i[s]=e[s]);else for(let s in t)void 0!==e&&e[s]&&(i[s]=t[s]);return i}exclHash(e,t){void 0===e&&(e={}),void 0===t&&(t={});let i=this.icn3dui.hashUtilsCls.cloneHash(e);for(let e in i)void 0!==t&&t[e]&&delete i[e];return i}unionHash(e,t){return this.icn3dui.hashUtilsCls.unionHashInPlace(e,t)}unionHashInPlace(e,t){return this.icn3dui,void 0===e&&(e={}),void 0===t&&(t={}),$.extend(e,t),e}unionHashNotInPlace(e,t){return this.icn3dui,$.extend({},e,t)}intHash2Atoms(e,t,i){let s=this.icn3dui;return s.hashUtilsCls.hash2Atoms(s.hashUtilsCls.intHash(e,t),i)}exclHash2Atoms(e,t,i){let s=this.icn3dui;return s.hashUtilsCls.hash2Atoms(s.hashUtilsCls.exclHash(e,t),i)}unionHash2Atoms(e,t,i){let s=this.icn3dui;return s.hashUtilsCls.hash2Atoms(s.hashUtilsCls.unionHash(e,t),i)}hash2Atoms(e,t){this.icn3dui;let i={};for(let s in e)i[s]=t[s];return i}hashvalue2array(e){this.icn3dui;let t=[];for(let i in e)t.push(e[i]);return t}}class Ll{constructor(e){this.icn3dui=e}isIE(){return this.icn3dui,!!(window.navigator.userAgent.indexOf("MSIE ")>0||window.navigator.userAgent.match(/Trident.*rv\:11\./))}isMobile(){return this.icn3dui,/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(window.navigator.userAgent)}isMac(){return this.icn3dui,/Mac/i.test(window.navigator.userAgent)}isAndroid(){return this.icn3dui,/android/i.test(window.navigator.userAgent.toLowerCase())}isChrome(){return this.icn3dui,navigator.userAgent.includes("Chrome")&&navigator.vendor.includes("Google Inc")}isSessionStorageSupported(){return this.icn3dui,window.sessionStorage}isLocalStorageSupported(){return this.icn3dui,window.localStorage}hexToRgb(e,t){this.icn3dui;let i=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e);return i?{r:parseInt(i[1],16),g:parseInt(i[2],16),b:parseInt(i[3],16),a:t}:null}isCalphaPhosOnly(e){this.icn3dui;let t=!1,i=0,s=0;for(let t in e){if(!(i<100))break;{let i=e[t].name;if(!i)continue;i=i.trim(),"CA"!==i&&"P"!==i&&"O3'"!==i&&"O3*"!==i&&++s}++i}return s<.5*i&&(t=!0),t}hasCovalentBond(e,t){let i=this.icn3dui,s=i.parasCls.covalentRadii[e.elem.toUpperCase()]+i.parasCls.covalentRadii[t.elem.toUpperCase()],n=e.coord.x-t.coord.x,r=e.coord.y-t.coord.y,a=e.coord.z-t.coord.z;return n*n+r*r+a*a<("N"==e.elem&&"H"==t.elem.substr(0,1)||"N"==t.elem&&"H"==e.elem.substr(0,1)?2.2:1.3)*s*s}residueName2Abbr(e){this.icn3dui;let t=e.indexOf(" ");switch(t>0&&(e=e.substr(0,t)),e){case"  A":case" DA":case"DA":case"ALA":return"A";case"  C":case" DC":case"DC":case"CYS":return"C";case"  G":case" DG":case"DG":case"GLY":return"G";case"  T":case" DT":case"DT":case"THR":return"T";case"  U":case" DU":case"DU":case"SEC":return"U";case"  I":case" DI":case"DI":case"ILE":return"I";case"ARG":return"R";case"ASN":return"N";case"ASP":return"D";case"GLU":return"E";case"GLN":return"Q";case"HIS":return"H";case"LEU":return"L";case"LYS":return"K";case"MET":return"M";case"PHE":return"F";case"PRO":return"P";case"SER":return"S";case"TRP":return"W";case"TYR":return"Y";case"VAL":return"V";case"HOH":case"WAT":return"O";default:return e.trim()}}residueAbbr2Name(e){if(this.icn3dui,(e=e.toUpperCase()).length>1)return e;switch(e){case"A":return"ALA";case"R":return"ARG";case"N":return"ASN";case"D":return"ASP";case"C":return"CYS";case"E":return"GLU";case"Q":return"GLN";case"G":return"GLY";case"H":return"HIS";case"I":return"ILE";case"L":return"LEU";case"K":return"LYS";case"M":return"MET";case"F":return"PHE";case"P":return"PRO";case"S":return"SER";case"T":return"THR";case"W":return"TRP";case"Y":return"TYR";case"V":return"VAL";case"O":return"HOH";default:return e.trim()}}getJSONFromArray(e){this.icn3dui;let t="";for(let i=0,s=e.length;i<s;++i)t+=JSON.stringify(e[i]),i!=s-1&&(t+=", ");return t}checkFileAPI(){this.icn3dui,window.File&&window.FileReader&&window.FileList&&window.Blob||alert("The File APIs are not fully supported in this browser.")}getIdArray(e){this.icn3dui;let t=[];if(e){let i=e.indexOf("_"),s=e.lastIndexOf("_");t.push(e.substr(0,i)),t.push(e.substr(i+1,s-i-1)),t.push(e.substr(s+1))}return t}compResid(e,t,i){let s,n,r=this.icn3dui,a=e.split(","),o=t.split(",");"save1"==i?(s=r.utilsCls.getIdArray(a[0]),n=r.utilsCls.getIdArray(o[0])):"save2"==i&&(s=r.utilsCls.getIdArray(a[1]),n=r.utilsCls.getIdArray(o[1]));let l=s[0]+"_"+s[1],d=n[0]+"_"+n[1],c=parseInt(s[2]),h=parseInt(n[2]);return l>d?1:l<d?-1:l==d?c>h?1:c<h?-1:0:void 0}toggle(e,t,i,s){this.icn3dui;let n=[e,t];for(let e in n){let t=n[e];$("#"+t).toggleClass("ui-icon-plus"),$("#"+t).toggleClass("ui-icon-minus")}n=[e,t,i,s];for(let e in n){let t=n[e];$("#"+t).toggleClass("icn3d-shown"),$("#"+t).toggleClass("icn3d-hidden")}}setViewerWidthHeight(e,t){if(e.bNode)return e.htmlCls.WIDTH=400,void(e.htmlCls.HEIGHT=400);let i,s;e.htmlCls.WIDTH=$(window).width()-e.htmlCls.LESSWIDTH,e.htmlCls.HEIGHT=$(window).height()-e.htmlCls.EXTRAHEIGHT-e.htmlCls.LESSHEIGHT,t||void 0===e.oriWidth||-1!==e.cfg.width.toString().indexOf("%")?(i=$("#"+e.pre+"viewer").css("width"),s=$("#"+e.pre+"viewer").css("height"),i=i?i.replace(/px/g,""):e.htmlCls.WIDTH,s=s?s.replace(/px/g,""):e.htmlCls.HEIGHT,t||(-1!==e.cfg.width.toString().indexOf("%")?i=$(window).width()*e.cfg.width.substr(0,e.cfg.width.toString().indexOf("%"))/100-e.htmlCls.LESSWIDTH:e.cfg.width&&(i=parseInt(e.cfg.width)),-1!==e.cfg.height.toString().indexOf("%")?s=$(window).height()*e.cfg.height.substr(0,e.cfg.height.toString().indexOf("%"))/100-e.htmlCls.EXTRAHEIGHT-e.htmlCls.LESSHEIGHT:e.cfg.height&&(s=parseInt(e.cfg.height)))):(i=e.oriWidth,s=e.oriHeight),i&&e.htmlCls.WIDTH>i&&(e.htmlCls.WIDTH=i),s&&e.htmlCls.HEIGHT>s&&(e.htmlCls.HEIGHT=s)}sumArray(e){let t=0;for(let i=0,s=e.length;i<s;++i)t+=e[i];return t}getMemDesc(){return"<div style='width:150px'><span style='color:red'>Red</span> and <span style='color:blue'>blue</span> membranes indicate <span style='color:red'>extracellular</span> and <span style='color:blue'>intracellular</span> membranes, respectively.<br><br></div>"}getStructures(e){let t=this.icn3dui,i={};for(let s in e){i[t.icn3d.atoms[s].structure]=1}return i}getHlStructures(e){let t=this.icn3dui;return e||(e=t.icn3d.hAtoms),this.getStructures(e)}getDisplayedStructures(e){let t=this.icn3dui;return e||(e=t.icn3d.dAtoms),this.getStructures(e)}getDateDigitStr(){this.icn3dui;let e=new Date,t=(e.getMonth()+1).toString();e.getMonth()+1<10&&(t="0"+t);let i=e.getDate().toString();return e.getDate()<10&&(i="0"+i),e.getFullYear().toString()+t+i}}class Fl{constructor(e){this.icn3dui=e,this.glycanHash={GLC:{c:"1E90FF",s:"sphere"},BGC:{c:"1E90FF",s:"sphere"},NAG:{c:"1E90FF",s:"cube"},NDG:{c:"1E90FF",s:"cube"},GCS:{c:"1E90FF",s:"cube"},PA1:{c:"1E90FF",s:"cube"},GCU:{c:"1E90FF",s:"cone"},BDP:{c:"1E90FF",s:"cone"},G6D:{c:"1E90FF",s:"cone"},DDA:{c:"1E90FF",s:"cylinder"},B6D:{c:"1E90FF",s:"cylinder"},XXM:{c:"1E90FF",s:"cylinder"},MAN:{c:"00FF00",s:"sphere"},BMA:{c:"00FF00",s:"sphere"},BM3:{c:"00FF00",s:"cube"},"95Z":{c:"00FF00",s:"cube"},MAV:{c:"00FF00",s:"cone"},BEM:{c:"00FF00",s:"cone"},RAM:{c:"00FF00",s:"cone"},RM4:{c:"00FF00",s:"cone"},TYV:{c:"00FF00",s:"cylinder"},ARA:{c:"00FF00",s:"cylinder"},ARB:{c:"00FF00",s:"cylinder"},KDN:{c:"00FF00",s:"cylinder"},KDM:{c:"00FF00",s:"cylinder"},"6PZ":{c:"00FF00",s:"cylinder"},GMH:{c:"00FF00",s:"cylinder"},BDF:{c:"00FF00",s:"cylinder"},GAL:{c:"FFFF00",s:"sphere"},GLA:{c:"FFFF00",s:"sphere"},NGA:{c:"FFFF00",s:"cube"},A2G:{c:"FFFF00",s:"cube"},X6X:{c:"FFFF00",s:"cube"},"1GN":{c:"FFFF00",s:"cube"},ADA:{c:"FFFF00",s:"cone"},GTR:{c:"FFFF00",s:"cone"},LDY:{c:"FFFF00",s:"cylinder"},KDO:{c:"FFFF00",s:"cylinder"},T6T:{c:"FFFF00",s:"cylinder"},GUP:{c:"A52A2A",s:"sphere"},GL0:{c:"A52A2A",s:"sphere"},LGU:{c:"A52A2A",s:"cone"},ABE:{c:"A52A2A",s:"cylinder"},XYS:{c:"A52A2A",s:"cylinder"},XYP:{c:"A52A2A",s:"cylinder"},SOE:{c:"A52A2A",s:"cylinder"},PZU:{c:"FF69B4",s:"cylinder"},RIP:{c:"FF69B4",s:"cylinder"},"0MK":{c:"FF69B4",s:"cylinder"},ALL:{c:"8A2BE2",s:"sphere"},AFD:{c:"8A2BE2",s:"sphere"},NAA:{c:"8A2BE2",s:"cube"},SIA:{c:"8A2BE2",s:"cylinder"},SIB:{c:"8A2BE2",s:"cylinder"},AMU:{c:"8A2BE2",s:"cylinder"},X0X:{c:"1E90FF",s:"cone"},X1X:{c:"1E90FF",s:"cone"},NGC:{c:"1E90FF",s:"cylinder"},NGE:{c:"1E90FF",s:"cylinder"},"4N2":{c:"A0522D",s:"sphere"},HSQ:{c:"A0522D",s:"cube"},IDR:{c:"A0522D",s:"cone"},MUR:{c:"A0522D",s:"cylinder"},FUC:{c:"FF0000",s:"cone"},FUL:{c:"FF0000",s:"cone"}},this.nucleotidesArray=["  G","  A","  T","  C","  U"," DG"," DA"," DT"," DC"," DU","G","A","T","C","U","DG","DA","DT","DC","DU"],this.ionsArray=["  K"," NA"," MG"," AL"," CA"," TI"," MN"," FE"," NI"," CU"," ZN"," AG"," BA","  F"," CL"," BR","  I","K","NA","MG","AL","CA","TI","MN","FE","NI","CU","ZN","AG","BA","F","CL","BR","I"],this.cationsTrimArray=["K","NA","MG","AL","CA","TI","MN","FE","NI","CU","ZN","AG","BA"],this.anionsTrimArray=["F","CL","BR","I"],this.ionCharges={K:1,NA:1,MG:2,AL:3,CA:2,TI:3,MN:2,FE:3,NI:2,CU:2,ZN:2,AG:1,BA:2},this.vdwRadii={H:1.08,HE:1.34,LI:1.75,BE:2.05,B:1.47,C:1.49,N:1.41,O:1.4,F:1.39,NE:1.68,NA:1.84,MG:2.05,AL:2.11,SI:2.07,P:1.92,S:1.82,CL:1.83,AR:1.93,K:2.05,CA:2.21,SC:2.16,TI:1.87,V:1.79,CR:1.89,MN:1.97,FE:1.94,CO:1.92,NI:1.84,CU:1.86,ZN:2.1,GA:2.08,GE:2.15,AS:2.06,SE:1.93,BR:1.98,KR:2.12,RB:2.16,SR:2.24,Y:2.19,ZR:1.86,NB:2.07,MO:2.09,TC:2.09,RU:2.07,RH:1.95,PD:2.02,AG:2.03,CD:2.3,IN:2.36,SN:2.33,SB:2.25,TE:2.23,I:2.23,XE:2.21,CS:2.22,BA:2.51,LA:2.4,CE:2.35,PR:2.39,ND:2.29,PM:2.36,SM:2.29,EU:2.33,GD:2.37,TB:2.21,DY:2.29,HO:2.16,ER:2.35,TM:2.27,YB:2.42,LU:2.21,HF:2.12,TA:2.17,W:2.1,RE:2.17,OS:2.16,IR:2.02,PT:2.09,AU:2.17,HG:2.09,TL:2.35,PB:2.32,BI:2.43,PO:2.29,AT:2.36,RN:2.43,FR:2.56,RA:2.43,AC:2.6,TH:2.37,PA:2.43,U:2.4,NP:2.21,PU:2.56,AM:2.56,CM:2.56,BK:2.56,CF:2.56,ES:2.56,FM:2.56},this.covalentRadii={H:.31,HE:.28,LI:1.28,BE:.96,B:.84,C:.76,N:.71,O:.66,F:.57,NE:.58,NA:1.66,MG:1.41,AL:1.21,SI:1.11,P:1.07,S:1.05,CL:1.02,AR:1.06,K:2.03,CA:1.76,SC:1.7,TI:1.6,V:1.53,CR:1.39,MN:1.39,FE:1.32,CO:1.26,NI:1.24,CU:1.32,ZN:1.22,GA:1.22,GE:1.2,AS:1.19,SE:1.2,BR:1.2,KR:1.16,RB:2.2,SR:1.95,Y:1.9,ZR:1.75,NB:1.64,MO:1.54,TC:1.47,RU:1.46,RH:1.42,PD:1.39,AG:1.45,CD:1.44,IN:1.42,SN:1.39,SB:1.39,TE:1.38,I:1.39,XE:1.4,CS:2.44,BA:2.15,LA:2.07,CE:2.04,PR:2.03,ND:2.01,PM:1.99,SM:1.98,EU:1.98,GD:1.96,TB:1.94,DY:1.92,HO:1.92,ER:1.89,TM:1.9,YB:1.87,LU:1.87,HF:1.75,TA:1.7,W:1.62,RE:1.51,OS:1.44,IR:1.41,PT:1.36,AU:1.36,HG:1.32,TL:1.45,PB:1.46,BI:1.48,PO:1.4,AT:1.5,RN:1.5,FR:2.6,RA:2.21,AC:2.15,TH:2.06,PA:2,U:1.96,NP:1.9,PU:1.87,AM:1.8,CM:1.69},this.atomColors={H:this.thr(16777215),He:this.thr(16761035),HE:this.thr(16761035),Li:this.thr(11674146),LI:this.thr(11674146),B:this.thr(65280),C:this.thr(14540253),N:this.thr(255),O:this.thr(15728640),F:this.thr(14329120),Na:this.thr(255),NA:this.thr(255),Mg:this.thr(2263842),MG:this.thr(2263842),Al:this.thr(8421520),AL:this.thr(8421520),Si:this.thr(14329120),SI:this.thr(14329120),P:this.thr(16753920),S:this.thr(16762930),Cl:this.thr(65280),CL:this.thr(65280),Ca:this.thr(8421520),CA:this.thr(8421520),Ti:this.thr(8421520),TI:this.thr(8421520),Cr:this.thr(8421520),CR:this.thr(8421520),Mn:this.thr(8421520),MN:this.thr(8421520),Fe:this.thr(16753920),FE:this.thr(16753920),Ni:this.thr(10824234),NI:this.thr(10824234),Cu:this.thr(10824234),CU:this.thr(10824234),Zn:this.thr(10824234),ZN:this.thr(10824234),Br:this.thr(10824234),BR:this.thr(10824234),Ag:this.thr(8421520),AG:this.thr(8421520),I:this.thr(10494192),Ba:this.thr(16753920),BA:this.thr(16753920),Au:this.thr(14329120),AU:this.thr(14329120)},this.atomnames={H:"Hydrogen",HE:"Helium",LI:"Lithium",B:"Boron",C:"Carbon",N:"Nitrogen",O:"Oxygen",F:"Fluorine",NA:"Sodium",MG:"Magnesium",AL:"Aluminum",SI:"Silicon",P:"Phosphorus",S:"Sulfur",CL:"Chlorine",CA:"Calcium",TI:"Titanium",CR:"Chromium",MN:"Manganese",FE:"Iron",NI:"Nickel",CU:"Copper",ZN:"Zinc",BR:"Bromine",AG:"Silver",I:"Iodine",BA:"Barium",AU:"Gold"},this.defaultAtomColor=this.thr(13421772),this.stdChainColors=[this.thr(16711935),this.thr(255),this.thr(10053171),this.thr(65433),this.thr(16750848),this.thr(16737894),this.thr(3329330),this.thr(2003199),this.thr(16416882),this.thr(16753920),this.thr(52945),this.thr(16738740),this.thr(65280),this.thr(255),this.thr(16711680),this.thr(16776960),this.thr(65535),this.thr(16711935),this.thr(3978097),this.thr(4620980),this.thr(13458524),this.thr(16770229),this.thr(11529966),this.thr(15631086),this.thr(25600),this.thr(139),this.thr(9109504),this.thr(13468991),this.thr(35723),this.thr(9699539)],this.backgroundColors={black:this.thr(0),grey:this.thr(13421772),white:this.thr(16777215),transparent:this.thr(16777215)},this.residueColors={ALA:this.thr(13158600),ARG:this.thr(1334015),ASN:this.thr(56540),ASP:this.thr(15075850),CYS:this.thr(15132160),GLN:this.thr(56540),GLU:this.thr(15075850),GLY:this.thr(15461355),HIS:this.thr(8553170),ILE:this.thr(1016335),LEU:this.thr(1016335),LYS:this.thr(1334015),MET:this.thr(15132160),PHE:this.thr(3289770),PRO:this.thr(14456450),SER:this.thr(16422400),THR:this.thr(16422400),TRP:this.thr(11819700),TYR:this.thr(3289770),VAL:this.thr(1016335),ASX:this.thr(16738740),GLX:this.thr(16738740),G:this.thr(32768),A:this.thr(6324479),T:this.thr(16744448),C:this.thr(16711680),U:this.thr(16744448),DG:this.thr(32768),DA:this.thr(6324479),DT:this.thr(16744448),DC:this.thr(16711680),DU:this.thr(16744448)},this.residueArea={ALA:247,ARG:366,ASN:290,ASP:285,CYS:271,GLN:336,GLU:325,GLY:217,HIS:340,ILE:324,LEU:328,LYS:373,MET:346,PHE:366,PRO:285,SER:265,THR:288,TRP:414,TYR:387,VAL:293,ASX:290,GLX:336,G:520,A:507,T:515,C:467,U:482,DG:520,DA:507,DT:515,DC:467,DU:482},this.defaultResidueColor=this.thr(12492910),this.chargeColors={"  G":this.thr(16711680),"  A":this.thr(16711680),"  T":this.thr(16711680),"  C":this.thr(16711680),"  U":this.thr(16711680)," DG":this.thr(16711680)," DA":this.thr(16711680)," DT":this.thr(16711680)," DC":this.thr(16711680)," DU":this.thr(16711680),G:this.thr(16711680),A:this.thr(16711680),T:this.thr(16711680),C:this.thr(16711680),U:this.thr(16711680),DG:this.thr(16711680),DA:this.thr(16711680),DT:this.thr(16711680),DC:this.thr(16711680),DU:this.thr(16711680),ARG:this.thr(255),LYS:this.thr(255),ASP:this.thr(16711680),GLU:this.thr(16711680),HIS:this.thr(8421631),GLY:this.thr(8947848),PRO:this.thr(8947848),ALA:this.thr(8947848),VAL:this.thr(8947848),LEU:this.thr(8947848),ILE:this.thr(8947848),PHE:this.thr(8947848),SER:this.thr(8947848),THR:this.thr(8947848),ASN:this.thr(8947848),GLN:this.thr(8947848),TYR:this.thr(8947848),MET:this.thr(8947848),CYS:this.thr(8947848),TRP:this.thr(8947848)},this.hydrophobicColors={"  G":this.thr(16711680),"  A":this.thr(16711680),"  T":this.thr(16711680),"  C":this.thr(16711680),"  U":this.thr(16711680)," DG":this.thr(16711680)," DA":this.thr(16711680)," DT":this.thr(16711680)," DC":this.thr(16711680)," DU":this.thr(16711680),G:this.thr(16711680),A:this.thr(16711680),T:this.thr(16711680),C:this.thr(16711680),U:this.thr(16711680),DG:this.thr(16711680),DA:this.thr(16711680),DT:this.thr(16711680),DC:this.thr(16711680),DU:this.thr(16711680),ARG:this.thr(255),LYS:this.thr(255),ASP:this.thr(16711680),GLU:this.thr(16711680),HIS:this.thr(8421631),TRP:this.thr().setHSL(1/3,1,.5),PHE:this.thr().setHSL(1/3,1,.5909090909090908),LEU:this.thr().setHSL(1/3,1,.700956937799043),ILE:this.thr().setHSL(1/3,1,.7320574162679425),TYR:this.thr().setHSL(1/3,1,.5+.69/2.09),MET:this.thr().setHSL(1/3,1,.5+.71/2.09),VAL:this.thr().setHSL(1/3,1,.5+.815/2.09),CYS:this.thr().setHSL(1/3,1,.5+1.035/2.09),PRO:this.thr().setHSL(1/6,1,.9391304347826086),THR:this.thr().setHSL(1/6,1,.8913043478260869),SER:this.thr().setHSL(1/6,1,.8),ALA:this.thr().setHSL(1/6,1,.7826086956521738),GLN:this.thr().setHSL(1/6,1,.6652173913043478),ASN:this.thr().setHSL(1/6,1,.6304347826086956),GLY:this.thr().setHSL(1/6,1,.5)},this.normalizedHPColors={"  G":this.thr(16777215),"  A":this.thr(16777215),"  T":this.thr(16777215),"  C":this.thr(16777215),"  U":this.thr(16777215)," DG":this.thr(16777215)," DA":this.thr(16777215)," DT":this.thr(16777215)," DC":this.thr(16777215)," DU":this.thr(16777215),G:this.thr(16777215),A:this.thr(16777215),T:this.thr(16777215),C:this.thr(16777215),U:this.thr(16777215),DG:this.thr(16777215),DA:this.thr(16777215),DT:this.thr(16777215),DC:this.thr(16777215),DU:this.thr(16777215),ARG:this.thr(16777215),LYS:this.thr(16777215),ASP:this.thr(16777215),GLU:this.thr(16777215),HIS:this.thr(16777215),TRP:this.thr().setHSL(1/3,1,.5),PHE:this.thr().setHSL(1/3,1,.558641975308642),LEU:this.thr().setHSL(1/3,1,.6296296296296295),ILE:this.thr().setHSL(1/3,1,.6496913580246912),TYR:this.thr().setHSL(1/3,1,.5+.69/3.24),MET:this.thr().setHSL(1/3,1,.5+.71/3.24),VAL:this.thr().setHSL(1/3,1,.5+.815/3.24),CYS:this.thr().setHSL(1/3,1,.5+1.035/3.24),PRO:this.thr().setHSL(1/3,1,.5+1.115/3.24),THR:this.thr().setHSL(1/3,1,.5+1.17/3.24),SER:this.thr().setHSL(1/3,1,.5+1.275/3.24),ALA:this.thr().setHSL(1/3,1,.5+1.295/3.24),GLN:this.thr().setHSL(1/3,1,.5+1.43/3.24),ASN:this.thr().setHSL(1/3,1,.5+1.47/3.24),GLY:this.thr().setHSL(1/3,1,1)},this.hydrophobicValues={"  G":3,"  A":3,"  T":3,"  C":3,"  U":3," DG":3," DA":3," DT":3," DC":3," DU":3,G:3,A:3,T:3,C:3,U:3,DG:3,DA:3,DT:3,DC:3,DU:3,ARG:1.5,LYS:1.5,ASP:3,GLU:3,HIS:2,TRP:-2.09,PHE:-1.71,LEU:-1.25,ILE:-1.12,TYR:-.71,MET:-.67,VAL:-.46,CYS:-.02,PRO:.14,THR:.25,SER:.46,ALA:.5,GLN:.77,ASN:.85,GLY:1.15},this.residueAbbrev={ALA:"A (Ala)",ARG:"R (Arg)",ASN:"N (Asn)",ASP:"D (Asp)",CYS:"C (Cys)",GLN:"Q (Gln)",GLU:"E (Glu)",GLY:"G (Gly)",HIS:"H (His)",ILE:"I (Ile)",LEU:"L (Leu)",LYS:"K (Lys)",MET:"M (Met)",PHE:"F (Phe)",PRO:"P (Pro)",SER:"S (Ser)",THR:"T (Thr)",TRP:"W (Trp)",TYR:"Y (Tyr)",VAL:"V (Val)",ASX:"X (Asx)",GLX:"X (Glx)",G:"Guanine",A:"Adenine",T:"Thymine",C:"Cytosine",U:"Uracil",DG:"deoxy-Guanine",DA:"deoxy-Adenine",DT:"deoxy-Thymine",DC:"deoxy-Cytosine",DU:"deoxy-Uracil"},this.ssColors={helix:this.thr(16711680),sheet:this.thr(32768),coil:this.thr(6324479)},this.ssColors2={helix:this.thr(16711680),sheet:this.thr(16762880),coil:this.thr(6324479)},this.resn2restype={ALA:1,ARG:4,ASN:7,ASP:10,CYS:13,GLN:16,GLU:19,GLY:22,HIS:25,ILE:28,LEU:31,LYS:34,MET:37,PHE:40,PRO:43,SER:46,THR:49,TRP:52,TYR:55,VAL:58},this.nuclMainArray=["C1'","C1*","C2'","C2*","C3'","C3*","C4'","C4*","C5'","C5*","O3'","O3*","O4'","O4*","O5'","O5*","P","OP1","O1P","OP2","O2P"],this.b62ResArray=["A","R","N","D","C","Q","E","G","H","I","L","K","M","F","P","S","T","W","Y","V","B","Z","X","*"],this.b62Matrix=[[4,-1,-2,-2,0,-1,-1,0,-2,-1,-1,-1,-1,-2,-1,1,0,-3,-2,0,-2,-1,0,-4],[-1,5,0,-2,-3,1,0,-2,0,-3,-2,2,-1,-3,-2,-1,-1,-3,-2,-3,-1,0,-1,-4],[-2,0,6,1,-3,0,0,0,1,-3,-3,0,-2,-3,-2,1,0,-4,-2,-3,3,0,-1,-4],[-2,-2,1,6,-3,0,2,-1,-1,-3,-4,-1,-3,-3,-1,0,-1,-4,-3,-3,4,1,-1,-4],[0,-3,-3,-3,9,-3,-4,-3,-3,-1,-1,-3,-1,-2,-3,-1,-1,-2,-2,-1,-3,-3,-2,-4],[-1,1,0,0,-3,5,2,-2,0,-3,-2,1,0,-3,-1,0,-1,-2,-1,-2,0,3,-1,-4],[-1,0,0,2,-4,2,5,-2,0,-3,-3,1,-2,-3,-1,0,-1,-3,-2,-2,1,4,-1,-4],[0,-2,0,-1,-3,-2,-2,6,-2,-4,-4,-2,-3,-3,-2,0,-2,-2,-3,-3,-1,-2,-1,-4],[-2,0,1,-1,-3,0,0,-2,8,-3,-3,-1,-2,-1,-2,-1,-2,-2,2,-3,0,0,-1,-4],[-1,-3,-3,-3,-1,-3,-3,-4,-3,4,2,-3,1,0,-3,-2,-1,-3,-1,3,-3,-3,-1,-4],[-1,-2,-3,-4,-1,-2,-3,-4,-3,2,4,-2,2,0,-3,-2,-1,-2,-1,1,-4,-3,-1,-4],[-1,2,0,-1,-3,1,1,-2,-1,-3,-2,5,-1,-3,-1,0,-1,-3,-2,-2,0,1,-1,-4],[-1,-1,-2,-3,-1,0,-2,-3,-2,1,2,-1,5,0,-2,-1,-1,-1,-1,1,-3,-1,-1,-4],[-2,-3,-3,-3,-2,-3,-3,-3,-1,0,0,-3,0,6,-4,-2,-2,1,3,-1,-3,-3,-1,-4],[-1,-2,-2,-1,-3,-1,-1,-2,-2,-3,-3,-1,-2,-4,7,-1,-1,-4,-3,-2,-2,-1,-2,-4],[1,-1,1,0,-1,0,0,0,-1,-2,-2,0,-1,-2,-1,4,1,-3,-2,-2,0,0,0,-4],[0,-1,0,-1,-1,-1,-1,-2,-2,-1,-1,-1,-1,-2,-1,1,5,-2,-2,0,-1,-1,0,-4],[-3,-3,-4,-4,-2,-2,-3,-2,-2,-3,-2,-3,-1,1,-4,-3,-2,11,2,-3,-4,-3,-2,-4],[-2,-2,-2,-3,-2,-1,-2,-3,2,-1,-1,-2,-1,3,-3,-2,-2,2,7,-1,-3,-2,-1,-4],[0,-3,-3,-3,-1,-2,-2,-3,-3,3,1,-2,1,-1,-2,-2,0,-3,-1,4,-3,-2,-1,-4],[-2,-1,3,4,-3,0,1,-1,0,-3,-4,0,-3,-3,-2,0,-1,-4,-3,-3,4,1,-1,-4],[-1,0,0,1,-3,3,4,-2,0,-3,-3,1,-1,-3,-1,0,-1,-3,-2,-2,1,4,-1,-4],[0,-1,-1,-1,-2,-1,-1,-1,-1,-1,-1,-1,-1,-1,-2,0,0,-2,-1,-1,-1,-1,-1,-4],[-4,-4,-4,-4,-4,-4,-4,-4,-4,-4,-4,-4,-4,-4,-4,-4,-4,-4,-4,-4,-4,-4,-4,1]]}thr(e){return this.icn3dui,"#0"==e&&(e="#000"),new ls(e)}}class Nl{constructor(e){this.icn3dui=e}onId(e,t,i){if(this.icn3dui,!(Object.keys(window).length<2)&&("#"==e.substr(0,1)&&(e=e.substr(1)),document.getElementById(e))){t.split(" ").forEach((t=>{document.getElementById(e).addEventListener(t,i)}))}}onIds(e,t,i){let s=this.icn3dui;Array.isArray(e)?e.forEach((e=>{s.myEventCls.onId(e,t,i)})):s.myEventCls.onId(e,t,i)}}class Ul{constructor(e){this.icn3dui=e}getRmsdSuprCls(e,t,i){let s,n,r,a,o,l,d,c,h,p,u,m,f,g=this.icn3dui,b=new Array(9),C=new mt,v=new mt,_=[],y=[],S=new Array(3),w=new Array(3),x=new Array(3),A=new Array(3),M=new Array(3),T=new Array(3);if(s=0,i<=1)return{rot:void 0,trans1:void 0,trans2:void 0,rmsd:999};let E=i;for(n=0;n<i;n++)void 0!==e[n]&&void 0!==t[n]?(_.push(e[n].clone()),y.push(t[n].clone()),C.add(e[n]),v.add(t[n])):--E;if((i=E)<=1)return{rot:void 0,trans1:void 0,trans2:void 0,rmsd:999};C.multiplyScalar(1/i),v.multiplyScalar(1/i);let R=C,k=v;for(n=0;n<i;n++)_[n].sub(C),y[n].sub(v);for(n=0,l=d=0;n<i;n++)l+=_[n].x*_[n].x+_[n].y*_[n].y+_[n].z*_[n].z,d+=y[n].x*y[n].x+y[n].y*y[n].y+y[n].z*y[n].z;l/=i,d/=i;let O=new Array(9);for(n=0;n<9;++n)O[n]=0;for(n=0;n<i;n++)O[0]+=_[n].x*y[n].x,O[1]+=_[n].x*y[n].y,O[2]+=_[n].x*y[n].z,O[3]+=_[n].y*y[n].x,O[4]+=_[n].y*y[n].y,O[5]+=_[n].y*y[n].z,O[6]+=_[n].z*y[n].x,O[7]+=_[n].z*y[n].y,O[8]+=_[n].z*y[n].z;for(n=0;n<9;++n)O[n]/=i;let I=g.rmsdSuprCls.getEigenVectors(O);return r=I.k,S=I.h1,w=I.h2,x=I.h3,A=I.k1,M=I.k2,T=I.k3,c=I.d1,h=I.d2,p=I.d3,a=I.flag,m=I.s,1!=r?(s=100,b[0]=1,b[1]=0,b[2]=0,b[3]=0,b[4]=1,b[5]=0,b[6]=0,b[7]=0,b[8]=1,{rot:b,trans1:R,trans2:k,rmsd:s}):(1==a?(A[0]=O[0]*S[0]+O[3]*S[1]+O[6]*S[2],A[1]=O[1]*S[0]+O[4]*S[1]+O[7]*S[2],A[2]=O[2]*S[0]+O[5]*S[1]+O[8]*S[2],o=Math.sqrt(c),A[0]/=o,A[1]/=o,A[2]/=o,M[0]=O[0]*w[0]+O[3]*w[1]+O[6]*w[2],M[1]=O[1]*w[0]+O[4]*w[1]+O[7]*w[2],M[2]=O[2]*w[0]+O[5]*w[1]+O[8]*w[2],o=Math.sqrt(h),M[0]/=o,M[1]/=o,M[2]/=o,T[0]=O[0]*x[0]+O[3]*x[1]+O[6]*x[2],T[1]=O[1]*x[0]+O[4]*x[1]+O[7]*x[2],T[2]=O[2]*x[0]+O[5]*x[1]+O[8]*x[2],o=Math.sqrt(p),T[0]/=o,T[1]/=o,T[2]/=o):2==a&&(S[0]=O[0]*A[0]+O[1]*A[1]+O[2]*A[2],S[1]=O[3]*A[0]+O[4]*A[1]+O[5]*A[2],S[2]=O[6]*A[0]+O[7]*A[1]+O[8]*A[2],o=Math.sqrt(c),S[0]/=o,S[1]/=o,S[2]/=o,w[0]=O[0]*M[0]+O[1]*M[1]+O[2]*M[2],w[1]=O[3]*M[0]+O[4]*M[1]+O[5]*M[2],w[2]=O[6]*M[0]+O[7]*M[1]+O[8]*M[2],o=Math.sqrt(h),w[0]/=o,w[1]/=o,w[2]/=o,x[0]=O[0]*T[0]+O[1]*T[1]+O[2]*T[2],x[1]=O[3]*T[0]+O[4]*T[1]+O[5]*T[2],x[2]=O[6]*T[0]+O[7]*T[1]+O[8]*T[2],o=Math.sqrt(p),x[0]/=o,x[1]/=o,x[2]/=o),m>0?(b[0]=A[0]*S[0]+M[0]*w[0]+T[0]*x[0],b[1]=A[0]*S[1]+M[0]*w[1]+T[0]*x[1],b[2]=A[0]*S[2]+M[0]*w[2]+T[0]*x[2],b[3]=A[1]*S[0]+M[1]*w[0]+T[1]*x[0],b[4]=A[1]*S[1]+M[1]*w[1]+T[1]*x[1],b[5]=A[1]*S[2]+M[1]*w[2]+T[1]*x[2],b[6]=A[2]*S[0]+M[2]*w[0]+T[2]*x[0],b[7]=A[2]*S[1]+M[2]*w[1]+T[2]*x[1],b[8]=A[2]*S[2]+M[2]*w[2]+T[2]*x[2]):(b[0]=A[0]*S[0]+M[0]*w[0]-T[0]*x[0],b[1]=A[0]*S[1]+M[0]*w[1]-T[0]*x[1],b[2]=A[0]*S[2]+M[0]*w[2]-T[0]*x[2],b[3]=A[1]*S[0]+M[1]*w[0]-T[1]*x[0],b[4]=A[1]*S[1]+M[1]*w[1]-T[1]*x[1],b[5]=A[1]*S[2]+M[1]*w[2]-T[1]*x[2],b[6]=A[2]*S[0]+M[2]*w[0]-T[2]*x[0],b[7]=A[2]*S[1]+M[2]*w[1]-T[2]*x[1],b[8]=A[2]*S[2]+M[2]*w[2]-T[2]*x[2]),c=Math.sqrt(c),h=Math.sqrt(h),p=Math.sqrt(p),f=c+h+m*p,u=l+d-2*f,s=u>0?Math.sqrt(u):void 0,{rot:b,trans1:R,trans2:k,rmsd:s})}eigen_values(e){let t,i,s,n,r,a,o,l,d,c,h,p,u,m,f,g,b,C,v,_;if(this.icn3dui,t=e[0],i=e[1],s=e[2],n=e[3],r=e[4],a=e[5],o=e[6],l=e[7],d=e[8],c=-(t+r+d),h=t*r+(t+r)*d-a*l-i*n-s*o,p=-t*r*d+t*a*l+i*n*d-i*a*o-s*n*l+s*r*o,u=-c*c/3+h,m=c*c*c/13.5-c*h/3+p,f=.25*m*m+u*u*u/27,f<0){let e,t;e=Math.sqrt(.25*m*m-f),t=Math.acos(-.5*m/e),C=2*Math.cbrt(e)*Math.cos(t/3)}else g=Math.cbrt(-.5*m+Math.sqrt(f)),b=Math.cbrt(-.5*m-Math.sqrt(f)),C=g+b;return C-=c/3,c+=C,p/=-C,v=.5*(-c+Math.sqrt(c*c-4*p)),_=.5*(-c-Math.sqrt(c*c-4*p)),v<_&&(f=_,_=v,v=_),C<v&&(f=v,v=C,C=f),v<_&&(f=_,_=v,v=_),{d1:C,d2:v,d3:_}}null_basis(e,t,i,s,n){let r,a,o,l,d,c,h,p,u,m,f,g,b,C,v,_,y,S;if(this.icn3dui,l=e[0],d=e[1],c=e[2],h=e[3],p=e[4],u=e[5],m=e[6],f=e[7],g=e[8],S=Math.abs(l),Math.abs(d)>S&&(S=Math.abs(d)),Math.abs(c)>S&&(S=Math.abs(c)),Math.abs(h)>S&&(S=Math.abs(h)),Math.abs(p)>S&&(S=Math.abs(p)),Math.abs(u)>S&&(S=Math.abs(u)),Math.abs(m)>S&&(S=Math.abs(m)),Math.abs(f)>S&&(S=Math.abs(f)),Math.abs(g)>S&&(S=Math.abs(g)),S<1e-10)return a=3,{k:a,v1:t,v2:i,v3:s};if(o=0,l/=S,d/=S,c/=S,h/=S,p/=S,u/=S,m/=S,f/=S,g/=S,Math.abs(l)<n&&Math.abs(h)<n&&Math.abs(m)<n)r=1,t[0]=1,t[1]=0,t[2]=0,Math.abs(d)<n&&Math.abs(p)<n&&Math.abs(f)<n?(r=2,i[0]=0,i[1]=1,i[2]=0,Math.abs(c)<n&&Math.abs(u)<n&&Math.abs(g)<n&&(r=3,s[0]=0,s[1]=0,s[2]=1)):(S=Math.abs(d),Math.abs(p)>S&&(y=l,l=h,h=y,y=d,d=p,p=y,y=c,c=u,u=y,S=Math.abs(d)),Math.abs(f)>S&&(y=l,l=m,m=y,y=d,d=f,f=y,y=c,c=g,g=y),v=u-p*c/d,_=g-f*c/d,Math.abs(v)<n&&Math.abs(_)<n&&(r=2,i[0]=0,i[1]=-c/d,i[2]=1,o=1));else if(S=Math.abs(l),Math.abs(d)>S&&(y=l,l=h,h=y,y=d,d=p,p=y,y=c,c=u,u=y,S=Math.abs(l)),Math.abs(c)>S&&(y=l,l=m,m=y,y=d,d=f,f=y,y=c,c=g,g=y),b=p-h*d/l,C=u-h*c/l,v=f-m*d/l,_=g-m*c/l,Math.abs(b)<n&&Math.abs(v)<n)r=1,t[0]=-d/l,t[1]=1,t[2]=0,Math.abs(C)<n&&Math.abs(_)<n&&(r=2,i[0]=-c/l,i[1]=0,i[2]=1,o=2);else{if(Math.abs(b)<Math.abs(v)&&(y=b,b=v,v=y,y=C,C=_,_=y),!(Math.abs(_-C*v/b)<n))return a=0,t[0]=0,t[1]=0,t[2]=0,{k:a,v1:t,v2:i,v3:s};r=1,t[0]=d/l*(C/b)-c/l,t[1]=-C/b,t[2]=1,o=3}return a=r,o>0&&(1==o?(l=i[0],d=i[1],c=i[2],y=Math.sqrt(l*l+d*d+c*c),i[0]=l/y,i[1]=d/y,i[2]=c/y):2==o?(l=t[0],d=t[1],c=t[2],h=i[0],p=i[1],u=i[2],y=l*h+d*p+c*u,Math.abs(y)>=n&&(i[0]=l+y*h,i[1]=d+y*p,i[2]=c+y*u,h=i[0],p=i[1],u=i[2]),y=Math.sqrt(l*l+d*d+c*c),t[0]=l/y,t[1]=d/y,t[2]=c/y,y=Math.sqrt(h*h+p*p+u*u),i[0]=h/y,i[1]=p/y,i[2]=u/y):(l=t[0],d=t[1],c=t[2],y=Math.sqrt(l*l+d*d+c*c),t[0]=l/y,t[1]=d/y,t[2]=c/y)),{k:a,v1:t,v2:i,v3:s}}getEigenForSelection(e,t){let i,s=this.icn3dui,n=new mt,r=[];for(i=0;i<t;i++)r.push(e[i]),n.add(e[i]);for(n.multiplyScalar(1/t),i=0;i<t;i++)r[i].sub(n);let a=new Array(9);for(i=0;i<9;++i)a[i]=0;for(i=0;i<t;i++)a[0]+=r[i].x*r[i].x,a[1]+=r[i].x*r[i].y,a[2]+=r[i].x*r[i].z,a[3]+=r[i].y*r[i].x,a[4]+=r[i].y*r[i].y,a[5]+=r[i].y*r[i].z,a[6]+=r[i].z*r[i].x,a[7]+=r[i].z*r[i].y,a[8]+=r[i].z*r[i].z;for(i=0;i<9;++i)a[i]/=t;return s.rmsdSuprCls.getEigenVectors(a)}getEigenVectors(e,t){let i,s,n,r,a,o,l,d=this.icn3dui,c=1e-8,h=new Array(9),p=new Array(3),u=new Array(3),m=new Array(3),f=new Array(3),g=new Array(3),b=new Array(3);n=e[0]*(e[4]*e[8]-e[5]*e[7]),n-=e[1]*(e[3]*e[8]-e[5]*e[6]),n+=e[2]*(e[3]*e[7]-e[4]*e[6]),l=n<0?-1:1;let C=new Array(3),v=new Array(3);for(let e=0;e<3;++e)C[e]=new mt,v[e]=new mt;C[0].x=e[0]*e[0]+e[1]*e[1]+e[2]*e[2],C[0].y=e[0]*e[3]+e[1]*e[4]+e[2]*e[5],C[0].z=e[0]*e[6]+e[1]*e[7]+e[2]*e[8],C[1].x=C[0].y,C[1].y=e[3]*e[3]+e[4]*e[4]+e[5]*e[5],C[1].z=e[3]*e[6]+e[4]*e[7]+e[5]*e[8],C[2].x=C[0].z,C[2].y=C[1].z,C[2].z=e[6]*e[6]+e[7]*e[7]+e[8]*e[8],v[0].x=e[0]*e[0]+e[3]*e[3]+e[6]*e[6],v[0].y=e[0]*e[1]+e[3]*e[4]+e[6]*e[7],v[0].z=e[0]*e[2]+e[3]*e[5]+e[6]*e[8],v[1].x=v[0].y,v[1].y=e[1]*e[1]+e[4]*e[4]+e[7]*e[7],v[1].z=e[1]*e[2]+e[4]*e[5]+e[7]*e[8],v[2].x=v[0].z,v[2].y=v[1].z,v[2].z=e[2]*e[2]+e[5]*e[5]+e[8]*e[8],h[0]=C[0].x,h[1]=C[0].y,h[2]=C[0].z,h[3]=C[1].x,h[4]=C[1].y,h[5]=C[1].z,h[6]=C[2].x,h[7]=C[2].y,h[8]=C[2].z;let _=d.rmsdSuprCls.eigen_values(h);r=_.d1,a=_.d2,o=_.d3,s=1,h[0]-=r,h[4]-=r,h[8]-=r;let y=d.rmsdSuprCls.null_basis(h,p,u,m,c);return i=y.k,p=y.v1,u=y.v2,m=y.v3,t||(1==i&&(h[0]+=r-a,h[4]+=r-a,h[8]+=r-a,y=d.rmsdSuprCls.null_basis(h,u,m,p,c),i=y.k,u=y.v1,m=y.v2,p=y.v3,1==i&&(h[0]+=a-o,h[4]+=a-o,h[8]+=a-o,y=d.rmsdSuprCls.null_basis(h,m,p,u,c),i=y.k,m=y.v1,p=y.v2,u=y.v3)),1!=i&&(h[0]=v[0].x,h[1]=v[0].y,h[2]=v[0].z,h[3]=v[1].x,h[4]=v[1].y,h[5]=v[1].z,h[6]=v[2].x,h[7]=v[2].y,h[8]=v[2].z,s=2,h[0]-=r,h[4]-=r,h[8]-=r,y=d.rmsdSuprCls.null_basis(h,f,g,b,c),i=y.k,f=y.v1,g=y.v2,b=y.v3,1==i&&(h[0]+=r-a,h[4]+=r-a,h[8]+=r-a,y=d.rmsdSuprCls.null_basis(h,g,b,f,c),i=y.k,g=y.v1,b=y.v2,f=y.v3,1==i&&(h[0]+=a-o,h[4]+=a-o,h[8]+=a-o,y=d.rmsdSuprCls.null_basis(h,b,f,g,c),i=y.k,b=y.v1,f=y.v2,g=y.v3)))),{k:i,h1:p,h2:u,h3:m,k1:f,k2:g,k3:b,d1:r,d2:a,d3:o,flag:s,s:l}}}class Hl{constructor(e){this.icn3dui=e}subdivide(e,t,i,s,n,r,a,o){let l=this.icn3dui,d=[],c=[],h=[],p=new Array,u=void 0!==r?r.length:0,m=void 0!==a?a.length:0;u>0&&Math.abs(r[0].x-e[0].x)<=6&&Math.abs(r[0].y-e[0].y)<=6&&Math.abs(r[0].z-e[0].z)<=6?(p.push(r[0]),u=1):u=0,p.push(e[0]);for(let t=1,i=e.length-1;t<i;++t){let i=e[t],s=e[t+1];p.push(i.smoothen?i.clone().add(s).multiplyScalar(.5):i)}p.push(e[e.length-1]);let f=0;m>0&&Math.abs(a[0].x-e[e.length-1].x)<=6&&Math.abs(a[0].y-e[e.length-1].y)<=6&&Math.abs(a[0].z-e[e.length-1].z)<=6&&(p.push(a[0]),++f),m>1&&Math.abs(a[0].x-a[1].x)<=6&&Math.abs(a[0].y-a[1].y)<=6&&Math.abs(a[0].z-a[1].z)<=6&&(p.push(a[1]),++f);let g=[],b=[],C=[];o&&(f=m>0?m-1:0);let v;for(let e=-1,n=p.length,r=1/i;e<=n-3;++e){v=e-u;let a=p[-1===e?0:e],o=p[e+1],m=p[e+2],_=p[e===n-3?n-1:e+3],y=0,S=l.subdivideCls.getKnot(1,y,a,o),w=l.subdivideCls.getKnot(1,S,o,m),x=l.subdivideCls.getKnot(1,w,m,_);S-y<1e-4&&(S=y+1),w-S<1e-4&&(w=S+1),x-w<1e-4&&(x=w+1),e>-1&&(void 0===s||s[v+1])&&e>=-1+u&&e<=n-3-f+1&&(d=d.concat(g),c=c.concat(b),h=h.concat(C)),g=[],b=[],C=[];let A=(w-S)*r;for(let r=0;r<i;++r){let p=S+A*r,M=l.subdivideCls.getValueFromKnot(p,y,S,w,x,a.x,o.x,m.x,_.x),T=l.subdivideCls.getValueFromKnot(p,y,S,w,x,a.y,o.y,m.y,_.y),E=l.subdivideCls.getValueFromKnot(p,y,S,w,x,a.z,o.z,m.z,_.z);s?(e>=-1+u&&e<=n-3-f&&s[v+1]&&r<=parseInt(i/2)&&(d.push(new mt(M,T,E)),c.push(s[v+1]),h.push(t[v+1])),e>=-1+u&&e<=n-3-f+1&&s[v+2]&&r>parseInt(i/2)&&(g.push(new mt(M,T,E)),b.push(s[v+2]),C.push(t[v+2]))):e>=-1+u&&e<=n-3-f&&(d.push(new mt(M,T,E)),c.push(v+1),h.push(t[v+1]))}}s&&!s[v+1]||(d=d.concat(g),c=c.concat(b),h=h.concat(C),d.push(p[p.length-1-f]),c.push(p.length-1-f),h.push(t[p.length-1-f])),g=[],b=[],C=[],p=[];let _=[];return _.push(d),_.push(c),_.push(h),_}getKnot(e,t,i,s){return this.icn3dui,i.distanceTo(s)+t}getValueFromKnot(e,t,i,s,n,r,a,o,l){this.icn3dui;let d,c,h=(a-r)/(i-t),p=(o-a)/(s-i),u=(l-o)/(n-s),m=(i+s)*(i+s)-4*(t*i+s*n-t*n);return 0==m?(d=9999,c=9999):(d=6*(3*p*i+2*h*n+u*i-2*h*i-2*p*n-p*s-u*i)/m,c=6*(3*p*s+2*u*t+h*i-2*p*t-2*u*s-h*s-p*i)/m),p*(e-i)+a+((2*d+c)/6/(i-s)*(e-i)*(e-s)*(e-s)+(2*c+d)/6/(s-i)*(e-i)*(e-i)*(e-s))}}class Bl{constructor(e){this.icn3dui=e}passFloat32(e,t){let i=this.icn3dui,s=e.length;t||(t=new Uint8Array(4*s));let n=i.convertTypeCls.getDataView(t);for(let t=0;t<s;++t)n.setFloat32(4*t,e[t],!0);return i.convertTypeCls.getUint8View(t)}passInt8(e,t){let i=this.icn3dui,s=e.length;t||(t=new Uint8Array(1*s));let n=i.convertTypeCls.getDataView(t);for(let t=0;t<s;++t)n.setInt8(1*t,e[t],!0);return i.convertTypeCls.getUint8View(t)}passInt16(e,t){let i=this.icn3dui,s=e.length;t||(t=new Uint8Array(2*s));let n=i.convertTypeCls.getDataView(t);for(let t=0;t<s;++t)n.setInt16(2*t,e[t],!0);return i.convertTypeCls.getUint8View(t)}passInt32(e,t){let i=this.icn3dui,s=e.length;t||(t=new Uint8Array(4*s));let n=i.convertTypeCls.getDataView(t);for(let t=0;t<s;++t)n.setInt32(4*t,e[t],!0);return i.convertTypeCls.getUint8View(t)}getUint8View(e){return this.icn3dui.convertTypeCls.getView(Uint8Array,e)}getDataView(e){return this.icn3dui.convertTypeCls.getView(DataView,e)}getView(e,t,i){return this.icn3dui,t?new e(t.buffer,t.byteOffset,t.byteLength/(i||1)):void 0}getBlobFromBufferAndText(e,t){let i=this.icn3dui,s=new Uint8Array(e),n=new Uint8Array(t.length);for(let e=0;e<t.length;++e)n[e]=i.convertTypeCls.passInt8([t.charCodeAt(e)])[0];let r=[];return r.push(new Blob([s],{type:"application/octet-stream"})),r.push(new Blob([n],{type:"application/octet-stream"})),new Blob(r,{type:"image/png"})}}class zl{constructor(e){this.icn3dui=e}setAlphaFoldLegend(){let e;return this.icn3dui.icn3d,e="<div>",e+='<span class="icn3d-square" style="background-color: rgb(0, 83, 204);">&nbsp;</span> <span>Very high (pLDDT &gt; 90)</span><br>',e+='<span class="icn3d-square" style="background-color: rgb(101, 203, 243);">&nbsp;</span> <span>Confident (90 &gt; pLDDT &gt; 70)</span><br>',e+='<span class="icn3d-square" style="background-color: rgb(255, 209, 19);">&nbsp;</span> <span>Low (70 &gt; pLDDT &gt; 50)</span><br>',e+='<span class="icn3d-square" style="background-color: rgb(255, 125, 69);">&nbsp;</span> <span>Very low (pLDDT &lt; 50)</span><br>',e+="</div>",'<div><span class="icn3d-square" style="background-color: rgb(0, 83, 204);">&nbsp;</span> <span>Very high (pLDDT &gt; 90)</span><br><span class="icn3d-square" style="background-color: rgb(101, 203, 243);">&nbsp;</span> <span>Confident (90 &gt; pLDDT &gt; 70)</span><br><span class="icn3d-square" style="background-color: rgb(255, 209, 19);">&nbsp;</span> <span>Low (70 &gt; pLDDT &gt; 50)</span><br><span class="icn3d-square" style="background-color: rgb(255, 125, 69);">&nbsp;</span> <span>Very low (pLDDT &lt; 50)</span><br></div>'}setLegendHtml(e){let t=this.icn3dui.icn3d,i="<br>";if(e)i+=this.setAlphaFoldLegend();else{i+="<div style='height: 20px; background: linear-gradient(to right, "+(("red"==t.startColor?"#F00":"green"==t.startColor?"#0F0":"#00F")+" 0%, "+("white"==t.midColor?"#FFF":"#000")+" 50%, "+("red"==t.endColor?"#F00":"green"==t.endColor?"#0F0":"#00F")+" 100%")+");'></div><table width='100%' border='0' cellspacing='0' cellpadding='0'><tr><td width='33%'>"+t.startValue+"</td><td width='33%' align='center'>"+t.midValue+"</td><td width='33%' align='right'>"+t.endValue+"</td></tr></table>"}return i}SetChainsAdvancedMenu(){let e=this.icn3dui,t=e.icn3d;if(void 0===t.bSetChainsAdvancedMenu||!t.bSetChainsAdvancedMenu){let i=e.hashUtilsCls.cloneHash(t.hAtoms);t.definedSetsCls.setPredefinedInMenu(),t.bSetChainsAdvancedMenu=!0,t.hAtoms=e.hashUtilsCls.cloneHash(i)}}setSetsMenus(e,t){let i=this.icn3dui,s=i.icn3d;this.SetChainsAdvancedMenu();let n=e,r=e+"2",a=s.definedSetsCls.setAtomMenu(["protein"]);$("#"+i.pre+n).length&&$("#"+i.pre+n).html("  <option value='selected'>selected</option>"+a),!t&&$("#"+i.pre+r).length&&$("#"+i.pre+r).html("  <option value='selected' selected>selected</option>"+a),$("#"+i.pre+n).resizable(),t||$("#"+i.pre+r).resizable()}applyShownMenus(e){let t=this.icn3dui;t.icn3d;let i=[];for(let e in t.htmlCls.allMenus)t.htmlCls.shownMenus.hasOwnProperty(e)?$("#"+t.pre+e).parent().show():($("#"+t.pre+e).parent().hide(),i.push(e));Object.keys(t.htmlCls.shownMenus).length==Object.keys(t.htmlCls.allMenus).length?$(".icn3d-menusep").show():$(".icn3d-menusep").hide(),localStorage&&!e&&localStorage.setItem("hiddenmenus",JSON.stringify(i))}getHiddenMenusFromCache(){let e=this.icn3dui;e.icn3d,e.htmlCls.shownMenus={};let t=e.htmlCls.setHtmlCls.getCookie("menumode"),i=localStorage?localStorage.getItem("hiddenmenus"):"";if(i&&"[]"!=i){e.htmlCls.shownMenus={};let t=JSON.parse(i);for(let i in e.htmlCls.allMenus)-1==t.indexOf(i)&&(e.htmlCls.shownMenus[i]=1)}else e.htmlCls.shownMenus="all"==t?e.hashUtilsCls.cloneHash(e.htmlCls.allMenus):e.hashUtilsCls.cloneHash(e.htmlCls.simpleMenus)}uuidv4(){return"10000000-1000-4000-8000-100000000000".replace(/[018]/g,(e=>(+e^crypto.getRandomValues(new Uint8Array(1))[0]&15>>+e/4).toString(16)))}displayShownMenus(){let e=this.icn3dui;e.icn3d;let t="<form name='"+e.pre+"selmenu'>";t+="<table><tr><th>File</th><th>Select</th><th>View</th><th>Style</th><th>Color</th><th>Analysis</th><th>Help</th></tr>",t+="<tr>";for(let i in e.htmlCls.allMenusSel){if("uniclr"==i.substr(0,6)||"mn5_opacity"==i.substr(0,11)||"mn6_labelscale"==i.substr(0,14)||"faq_"==i.substr(0,4)||"dev_"==i.substr(0,4))continue;"mn1_searchgrooup"==i?t+="<td valign='top'>":("mn2_definedsets"==i||"mn2_show_selected"==i||"mn3_proteinwrap"==i||e.cfg.cid&&"mn3_ligwrap"==i||"mn4_clrwrap"==i||"mn6_selectannotations"==i||"abouticn3d"==i)&&(t+="</td><td valign='top'>");let s=e.htmlCls.shownMenus.hasOwnProperty(i)?"checked":"",n=e.htmlCls.allMenusSel[i];t+="<span style='white-space:nowrap'><input type='checkbox' name='"+i+"' value='"+i+"'"+s+(3==n?" style='margin-left:30px'":2==n?" style='margin-left:15px'":"")+">"+e.htmlCls.allMenus[i]+"</span><br>"}t+="</td></tr></table></form>",$("#"+e.pre+"menulist").html(t)}async setIgTemplate(e){let t=this.icn3dui.icn3d;t.bRunRefnumAgain=!0;let i=t.resid2specCls.atoms2residues(Object.keys(t.hAtoms));for(let e=0,s=i.length;e<s;++e){let s=i[e];t.resid2refnum&&delete t.resid2refnum[s],t.resid2domainid&&delete t.resid2domainid[s]}t.bAnnoShown||await t.showAnnoCls.showAnnotations(),await t.annotationCls.setAnnoTabIg(!0,e),t.bRunRefnumAgain=!1}setClashedResidues(){let e=this.icn3dui.icn3d,t=Object.keys(e.chains);for(let i=0,s=t.length;i<s;++i){let s=t[i];for(let n=i+1,r=t.length;n<r;++n){let i=t[n];e.showInterCls.pickCustomSphere_base(4,e.chains[s],e.chains[i],false,true)}}e.annoDomainCls.showDomainAll(!0)}clickMenu1(){let e=this.icn3dui;if(e.icn3d,e.bNode)return;let t=this;e.myEventCls.onIds("#"+e.pre+"mn1_vastplus","click",(function(t){e.icn3d,e.htmlCls.dialogCls.openDlg("dl_vastplus","Please input PDB ID for VAST+")})),e.myEventCls.onIds("#"+e.pre+"mn1_vast","click",(function(t){e.icn3d,e.htmlCls.dialogCls.openDlg("dl_vast","Please input chain or PDB file for VAST")})),e.myEventCls.onIds("#"+e.pre+"mn1_foldseek","click",(function(t){e.icn3d,e.htmlCls.dialogCls.openDlg("dl_foldseek","Submit your selection to Foldseek")})),e.myEventCls.onIds("#"+e.pre+"mn1_mmtfid","click",(function(t){e.icn3d,e.htmlCls.dialogCls.openDlg("dl_mmtfid","Please input BCIF/MMTF ID")})),e.myEventCls.onIds("#"+e.pre+"mn1_pdbid","click",(function(t){e.icn3d,e.htmlCls.dialogCls.openDlg("dl_pdbid","Please input PDB ID")})),e.myEventCls.onIds("#"+e.pre+"mn1_afid","click",(function(t){e.icn3d,e.htmlCls.dialogCls.openDlg("dl_afid","Please input AlphaFold UniProt ID")})),e.myEventCls.onIds("#"+e.pre+"mn1_refseqid","click",(function(t){e.icn3d,e.htmlCls.dialogCls.openDlg("dl_refseqid","Please input NCBI Protein Accession")})),e.myEventCls.onIds("#"+e.pre+"mn1_opmid","click",(function(t){e.icn3d,e.htmlCls.dialogCls.openDlg("dl_opmid","Please input OPM PDB ID")})),e.myEventCls.onIds("#"+e.pre+"mn1_align","click",(function(t){e.icn3d,e.htmlCls.dialogCls.openDlg("dl_align","Align two PDB structures")})),e.myEventCls.onIds("#"+e.pre+"mn1_alignaf","click",(function(t){e.icn3d,e.htmlCls.dialogCls.openDlg("dl_alignaf","Align two AlphaFold structures")})),e.myEventCls.onIds("#"+e.pre+"mn1_chainalign","click",(function(t){e.icn3d,e.htmlCls.dialogCls.openDlg("dl_chainalign","Align multiple chains by structure alignment")})),e.myEventCls.onIds("#"+e.pre+"mn1_chainalign2","click",(function(t){e.icn3d,e.htmlCls.dialogCls.openDlg("dl_chainalign2","Align multiple chains by sequence alignment")})),e.myEventCls.onIds("#"+e.pre+"mn1_chainalign3","click",(function(t){e.icn3d,e.htmlCls.dialogCls.openDlg("dl_chainalign3","Align multiple chains residue by residue")})),e.myEventCls.onIds("#"+e.pre+"mn1_mutation","click",(function(t){e.icn3d,e.htmlCls.dialogCls.openDlg("dl_mutation","Show the mutations in 3D")})),e.myEventCls.onIds("#"+e.pre+"mn1_pdbfile","click",(function(t){e.icn3d,e.htmlCls.dialogCls.openDlg("dl_pdbfile","Please input PDB File")})),e.myEventCls.onIds(["#"+e.pre+"mn1_pdbfile_app","#"+e.pre+"tool_pdbfile"],"click",(function(t){e.icn3d,e.htmlCls.dialogCls.openDlg("dl_pdbfile_app","Please append PDB Files")})),e.myEventCls.onIds("#"+e.pre+"mn1_mol2file","click",(function(t){e.icn3d,e.htmlCls.dialogCls.openDlg("dl_mol2file","Please input Mol2 File")})),e.myEventCls.onIds("#"+e.pre+"mn1_sdffile","click",(function(t){e.icn3d,e.htmlCls.dialogCls.openDlg("dl_sdffile","Please input SDF File")})),e.myEventCls.onIds("#"+e.pre+"mn1_xyzfile","click",(function(t){e.icn3d,e.htmlCls.dialogCls.openDlg("dl_xyzfile","Please input XYZ File")})),e.myEventCls.onIds("#"+e.pre+"mn1_afmapfile","click",(function(t){e.icn3d,e.htmlCls.dialogCls.openDlg("dl_afmapfile","Please input AlphaFold PAE File")})),e.myEventCls.onIds("#"+e.pre+"mn1_urlfile","click",(function(t){e.icn3d,e.htmlCls.dialogCls.openDlg("dl_urlfile","Load data by URL")})),e.myEventCls.onIds("#"+e.pre+"mn1_clustalwfile","click",(function(t){e.icn3d,e.htmlCls.dialogCls.openDlg("dl_clustalwfile","Please input CLUSTALW MSA File")})),e.myEventCls.onIds("#"+e.pre+"mn1_fastafile","click",(function(t){e.icn3d,e.htmlCls.dialogCls.openDlg("dl_fastafile","Please input FASTA MSA File")})),e.myEventCls.onIds("#"+e.pre+"mn1_fixedversion","click",(function(t){e.icn3d,e.htmlCls.dialogCls.openDlg("dl_fixedversion","Open Share Link URL in the archived version of iCn3D")})),e.myEventCls.onIds("#"+e.pre+"reload_fixedversion","click",(function(i){let s=e.icn3d,n=$("#"+e.pre+"sharelinkurl").val();t.setLogCmd("open "+n,!1),localStorage.setItem("fixedversion","1");let r=s.structures&&Object.keys(s.structures).length>0?"_blank":"_self";window.open(n,r)})),e.myEventCls.onIds("#"+e.pre+"mn1_mmciffile","click",(function(t){e.icn3d,e.htmlCls.dialogCls.openDlg("dl_mmciffile","Please append mmCIF File")})),e.myEventCls.onIds("#"+e.pre+"mn1_mmcifid","click",(function(t){e.icn3d,e.htmlCls.dialogCls.openDlg("dl_mmcifid","Please input mmCIF ID")})),e.myEventCls.onIds("#"+e.pre+"mn1_mmdbid","click",(function(t){e.icn3d,e.htmlCls.dialogCls.openDlg("dl_mmdbid","Please input MMDB or PDB ID")})),e.myEventCls.onIds(["#"+e.pre+"mn1_mmdbafid",,"#"+e.pre+"tool_mmdbafid"],"click",(function(t){e.icn3d,e.htmlCls.dialogCls.openDlg("dl_mmdbafid","Please input PDB/MMDB/AlphaFold UniProt IDs")})),e.myEventCls.onIds("#"+e.pre+"mn1_blast_rep_id","click",(function(t){e.icn3d,e.htmlCls.dialogCls.openDlg("dl_blast_rep_id","Align sequence to structure")})),e.myEventCls.onIds("#"+e.pre+"mn1_esmfold","click",(function(t){e.icn3d,e.htmlCls.dialogCls.openDlg("dl_esmfold","Sequence to structure prediction with ESMFold")})),e.myEventCls.onIds("#"+e.pre+"mn1_proteinname","click",(function(t){e.icn3d,e.htmlCls.dialogCls.openDlg("dl_proteinname","Please input protein or gene name")})),e.myEventCls.onIds("#"+e.pre+"mn1_cid","click",(function(t){e.icn3d,e.htmlCls.dialogCls.openDlg("dl_cid","Please input PubChem Compound")})),e.myEventCls.onIds("#"+e.pre+"mn1_smiles","click",(function(t){e.icn3d,e.htmlCls.dialogCls.openDlg("dl_smiles","Please input a chemical SMILES")})),e.myEventCls.onIds("#"+e.pre+"mn1_pngimage","click",(function(t){e.icn3d,e.htmlCls.dialogCls.openDlg("dl_pngimage","Please append PNG images")})),e.myEventCls.onIds("#"+e.pre+"mn1_state","click",(function(t){e.icn3d,e.htmlCls.dialogCls.openDlg("dl_state","Please input the state file")})),e.myEventCls.onIds("#"+e.pre+"mn1_bcfviewpoint","click",(function(t){e.icn3d,e.htmlCls.dialogCls.openDlg("dl_bcfviewpoint","Please input the BCF viewpoint file")})),e.myEventCls.onIds("#"+e.pre+"mn1_selection","click",(function(t){e.icn3d,e.htmlCls.dialogCls.openDlg("dl_selection","Please input the selection file")})),e.myEventCls.onIds("#"+e.pre+"mn1_collection","click",(function(t){e.icn3d,e.htmlCls.dialogCls.openDlg("dl_selectCollections","Select Collections")})),e.myEventCls.onIds("#"+e.pre+"mn1_dsn6","click",(function(t){e.icn3d,e.htmlCls.dialogCls.openDlg("dl_dsn6","Please input the map file to display electron density map")})),e.myEventCls.onIds(["#"+e.pre+"mn1_delphi","#"+e.pre+"mn1_delphi2","#"+e.pre+"tool_delphi"],"click",(function(t){e.icn3d.loadPhiFrom="delphi",$("#"+e.pre+"dl_delphi_tabs").tabs(),e.htmlCls.dialogCls.openDlg("dl_delphi","Please set parameters to display DelPhi potential map")})),e.myEventCls.onIds("#"+e.pre+"mn1_phi","click",(function(t){e.icn3d.loadPhiFrom="phi",$("#"+e.pre+"dl_phi_tabs").tabs(),$("#"+e.pre+"phitab1_tabs").tabs(),$("#"+e.pre+"phitab2_tabs").tabs(),e.htmlCls.dialogCls.openDlg("dl_phi","Please input local phi or cube file to display DelPhi potential map")})),e.myEventCls.onIds("#"+e.pre+"mn1_phiurl","click",(function(t){e.icn3d.loadPhiFrom="phiurl",$("#"+e.pre+"dl_phiurl_tabs").tabs(),$("#"+e.pre+"phiurltab1_tabs").tabs(),$("#"+e.pre+"phiurltab2_tabs").tabs(),e.htmlCls.dialogCls.openDlg("dl_phiurl","Please input URL phi or cube file to display DelPhi potential map")})),e.myEventCls.onIds("#"+e.pre+"mn1_dsn6url","click",(function(t){e.icn3d,e.htmlCls.dialogCls.openDlg("dl_dsn6url","Please input the map file to display electron density map")})),e.myEventCls.onIds("#"+e.pre+"mn1_exportState","click",(function(i){let s=e.icn3d;t.setLogCmd("export state file",!1);let n=Object.keys(s.structures).join(",");s.saveFileCls.saveFile(n+"_statefile.txt","command")})),e.myEventCls.onIds("#"+e.pre+"mn1_exportCamera","click",(async function(i){let s=e.icn3d;t.setLogCmd("export bcf viewpoint",!1);let n=Object.keys(s.structures).join(",");await e.getAjaxPromise("./script/jszip.min.js","script");let r,a=new JSZip,o=t.uuidv4(),l=t.uuidv4();r="",r+='<?xml version="1.0" encoding="UTF-8" standalone="yes"?>\n',r+='    <Version VersionId="3.0"/>\n',a.file("bcf.version",r),r="",r+='<?xml version="1.0" encoding="UTF-8" standalone="yes"?>\n',r+="    <Extensions>\n",r+="        <TopicTypes>\n",r+="          <TopicType>ERROR</TopicType>\n",r+="          <TopicType>WARNING</TopicType>\n",r+="          <TopicType>INFORMATION</TopicType>\n",r+="          <TopicType>CLASH</TopicType>\n",r+="          <TopicType>OTHER</TopicType>\n",r+="        </TopicTypes>\n",r+="          <TopicStatuses>\n",r+="          <TopicStatus>OPEN</TopicStatus>\n",r+="          <TopicStatus>IN_PROGRESS</TopicStatus>\n",r+="          <TopicStatus>SOLVED</TopicStatus>\n",r+="          <TopicStatus>CLOSED</TopicStatus>\n",r+="        </TopicStatuses>\n",r+="        <Priorities>\n",r+="          <Priority>LOW</Priority>\n",r+="          <Priority>MEDIUM</Priority>\n",r+="          <Priority>HIGH</Priority>\n",r+="          <Priority>CRITICAL</Priority>\n",r+="        </Priorities>\n",r+="        <TopicLabels/>\n",r+="        <Users/>\n",r+="        <SnippetTypes/>\n",r+="        <Stages/>\n",r+="    </Extensions>\n",a.file("extensions.xml",r);let d=a.folder(o);r="",r+='<?xml version="1.0" encoding="UTF-8" standalone="yes"?>\n',r+="    <Markup>\n",r+="        <Header>\n",r+="          <Files/>\n",r+="        </Header>\t\t\n",r+='        <Topic Guid="'+o+'">\n',r+="        <Title>Perspective camera</Title>\n";r+="        <CreationDate>"+(new Date).toISOString()+"</CreationDate>\n",r+="        <CreationAuthor>https://www.ncbi.nlm.nih.gov/Structure/icn3d</CreationAuthor>\n",r+="        <DocumentReferences/>\n",r+="        <RelatedTopics/>\n",r+="        <Comments/>\n",r+="        <Viewpoints>\n",r+='          <ViewPoint Guid="'+l+'">\n',r+="            <Viewpoint>viewpoint-"+l+".bcfv</Viewpoint>\n",r+="            <Snapshot>snapshot-"+l+".png</Snapshot>\n",r+="          </ViewPoint>\n",r+="        </Viewpoints>\n",r+="      </Topic>\n",r+="    </Markup>\n",d.file("markup.bcf",r);let c=await s.saveFileCls.saveFile("any","png",void 0,void 0,!0);d.file("snapshot-"+l+".png",c),r="",r+='<?xml version="1.0" encoding="UTF-8" standalone="yes"?>\n',r+='    <VisualizationInfo Guid="'+l+'">\n',r+="      <Components>\n",r+="        <Selection/>\n",r+='        <Visibility DefaultVisibility="true" />\n',r+="        <Coloring/>\n",r+="      </Components>\n",r+="      <PerspectiveCamera>\n",r+="        <CameraViewPoint>\n",r+="          <X>"+s.cam.position.x+"</X>\n",r+="          <Y>"+s.cam.position.y+"</Y>\n",r+="          <Z>"+s.cam.position.z+"</Z>\n",r+="        </CameraViewPoint>\n";let h=new mt(0,0,-1).applyQuaternion(s.cam.quaternion);r+="        <CameraDirection>\n",r+="          <X>"+h.x+"</X>\n",r+="          <Y>"+h.y+"</Y>\n",r+="          <Z>"+h.z+"</Z>\n",r+="        </CameraDirection>\n",r+="        <CameraUpVector>\n",r+="          <X>"+s.cam.up.x+"</X>\n",r+="          <Y>"+s.cam.up.y+"</Y>\n",r+="          <Z>"+s.cam.up.z+"</Z>\n",r+="        </CameraUpVector>\n",r+="        <FieldOfView>"+s.cam.fov+"</FieldOfView>\n",r+="        <AspectRatio>"+s.container.whratio+"</AspectRatio>\n",r+="      </PerspectiveCamera>\n",r+="      <Lines/>\n",r+="      <ClippingPlanes/>\n",r+="      <Bitmaps/>  \n",r+="    </VisualizationInfo>\n",d.file("viewpoint-"+l+".bcfv",r),a.generateAsync({type:"blob"}).then((function(e){saveAs(e,n+"_viewpoint.bcf")}))})),e.myEventCls.onIds("#"+e.pre+"mn1_exportVideo","click",(function(i){e.icn3d,t.setLogCmd("export video",!1),e.htmlCls.dialogCls.openDlg("dl_video","Save canvas changes in a video")})),e.myEventCls.onIds("#"+e.pre+"mn1_exportPdbRes","click",(function(i){e.icn3d,e.htmlCls.setHtmlCls.exportPdb(),t.setLogCmd("export pdb",!0)})),e.myEventCls.onIds("#"+e.pre+"mn1_exportSecondary","click",(function(i){e.icn3d,e.htmlCls.setHtmlCls.exportSecondary(),t.setLogCmd("export secondary structure",!0)})),e.myEventCls.onIds(["#"+e.pre+"delphipdb","#"+e.pre+"phipdb"],"click",(function(i){let s=e.icn3d,n=s.saveFileCls.getSelectedResiduePDB();t.setLogCmd("export PDB of selected residues",!1);let r=Object.keys(s.structures).join(",");s.saveFileCls.saveFile(r+"_icn3d_residues.pdb","text",[n])})),e.myEventCls.onIds(["#"+e.pre+"delphipqr","#"+e.pre+"phipqr","#"+e.pre+"phiurlpqr"],"click",(async function(i){e.icn3d,await e.htmlCls.setHtmlCls.exportPqr(),t.setLogCmd("export pqr",!0)})),e.myEventCls.onIds("#"+e.pre+"profixpdb","click",(async function(i){let s=e.icn3d;await s.scapCls.exportPdbProfix(!1),t.setLogCmd("export pdb missing atoms",!0)})),e.myEventCls.onIds("#"+e.pre+"profixpdbh","click",(async function(i){let s=e.icn3d;await s.scapCls.exportPdbProfix(!0),t.setLogCmd("export pdb hydrogen",!0)})),e.myEventCls.onIds("#"+e.pre+"mn1_exportIgstrand","click",(async function(i){e.icn3d.refnumCls.exportRefnum("igstrand"),t.setLogCmd("export refnum igstrand",!0)})),e.myEventCls.onIds("#"+e.pre+"mn1_exportKabat","click",(async function(i){e.icn3d.refnumCls.exportRefnum("kabat"),t.setLogCmd("export refnum kabat",!0)})),e.myEventCls.onIds("#"+e.pre+"mn1_exportImgt","click",(async function(i){e.icn3d.refnumCls.exportRefnum("imgt"),t.setLogCmd("export refnum imgt",!0)})),e.myEventCls.onIds("#"+e.pre+"mn1_exportStl","click",(function(i){let s=e.icn3d;t.setLogCmd("export stl file",!1),s.export3DCls.exportStlFile("")})),e.myEventCls.onIds("#"+e.pre+"mn1_exportVrml","click",(function(i){let s=e.icn3d;t.setLogCmd("export vrml file",!1),s.export3DCls.exportVrmlFile("")})),e.myEventCls.onIds("#"+e.pre+"mn1_exportStlStab","click",(function(i){let s=e.icn3d;t.setLogCmd("export stl stabilizer file",!1),s.threeDPrintCls.hideStabilizer(),s.threeDPrintCls.resetAfter3Dprint(),s.threeDPrintCls.addStabilizer(),s.export3DCls.exportStlFile("_stab")})),e.myEventCls.onIds("#"+e.pre+"mn1_exportVrmlStab","click",(function(i){let s=e.icn3d;t.setLogCmd("export vrml stabilizer file",!1),s.threeDPrintCls.hideStabilizer(),s.threeDPrintCls.resetAfter3Dprint(),s.threeDPrintCls.addStabilizer(),s.export3DCls.exportVrmlFile("_stab")})),e.myEventCls.onIds("#"+e.pre+"mn6_exportInteraction","click",(async function(i){let s=e.icn3d;t.setLogCmd("export interactions",!1),void 0!==e.cfg.mmdbid&&await s.viewInterPairsCls.retrieveInteractionData(),s.viewInterPairsCls.exportInteractions()})),e.myEventCls.onIds(["#"+e.pre+"mn1_exportCanvas","#"+e.pre+"saveimage"],"click",(async function(i){let s=e.icn3d;t.setLogCmd("export canvas",!1);await s.shareLinkCls.shareLink(!0)})),e.myEventCls.onIds("#"+e.pre+"mn1_exportCanvas1","click",(async function(i){let s=e.icn3d;t.setLogCmd("export canvas 1",!0),s.scaleFactor=1,await s.shareLinkCls.shareLink(!0,!0)})),e.myEventCls.onIds("#"+e.pre+"mn1_exportCanvas2","click",(async function(i){let s=e.icn3d;t.setLogCmd("export canvas 2",!0),s.scaleFactor=2,await s.shareLinkCls.shareLink(!0,!0)})),e.myEventCls.onIds("#"+e.pre+"mn1_exportCanvas4","click",(async function(i){let s=e.icn3d;t.setLogCmd("export canvas 4",!0),s.scaleFactor=4,await s.shareLinkCls.shareLink(!0,!0)})),e.myEventCls.onIds("#"+e.pre+"mn1_exportCanvas8","click",(async function(i){let s=e.icn3d;t.setLogCmd("export canvas 8",!0),s.scaleFactor=8,await s.shareLinkCls.shareLink(!0,!0)})),e.myEventCls.onIds("#"+e.pre+"mn1_exportCounts","click",(function(i){let s=e.icn3d;t.setLogCmd("export counts",!1);let n='<html><body><div style="text-align:center"><br><b>Total Count for atoms with coordinates</b>:<br/><table align=center border=1 cellpadding=10 cellspacing=0><tr><th>Structure Count</th><th>Chain Count</th><th>Residue Count</th><th>Atom Count</th></tr>';n+="<tr><td>"+Object.keys(s.structures).length+"</td><td>"+Object.keys(s.chains).length+"</td><td>"+Object.keys(s.residues).length+"</td><td>"+Object.keys(s.atoms).length+"</td></tr>",n+="</table><br/>",n+="<b>Counts by Chain for atoms with coordinates</b>:<br/><table align=center border=1 cellpadding=10 cellspacing=0><tr><th>Structure</th><th>Chain</th><th>Residue Count</th><th>Atom Count</th></tr>";let r=Object.keys(s.chains);for(let e=0,t=r.length;e<t;++e){let t=r[e],i=t.indexOf("_"),a=t.substr(0,i),o=t.substr(i+1),l={},d=s.chains[t];for(let e in d)l[s.atoms[e].resi]=1;n+="<tr><td>"+a+"</td><td>"+o+"</td><td>"+Object.keys(l).length+"</td><td>"+Object.keys(s.chains[t]).length+"</td></tr>"}n+="</table><br/></div></body></html>";let a=Object.keys(s.structures).join(",");s.saveFileCls.saveFile(a+"_counts.html","html",n)})),e.myEventCls.onIds("#"+e.pre+"mn1_exportSelections","click",(function(i){let s=e.icn3d;t.setLogCmd("export all selections",!1),t.SetChainsAdvancedMenu();let n=s.saveFileCls.exportCustomAtoms(),r=Object.keys(s.structures).join(",");s.saveFileCls.saveFile(r+"_selections.txt","text",[n])})),e.myEventCls.onIds("#"+e.pre+"mn1_exportSelDetails","click",(function(i){let s=e.icn3d;t.setLogCmd("export all selections with details",!1),t.SetChainsAdvancedMenu();let n=s.saveFileCls.exportCustomAtoms(!0),r=Object.keys(s.structures).join(",");s.saveFileCls.saveFile(r+"_sel_details.txt","text",[n])})),e.myEventCls.onIds(["#"+e.pre+"mn1_sharelink","#"+e.pre+"tool_sharelink"],"click",(async function(t){let i=e.icn3d;await i.shareLinkCls.shareLink()})),e.myEventCls.onIds("#"+e.pre+"mn1_replayon","click",(async function(i){let s=e.icn3d;await s.resizeCanvasCls.replayon(),t.setLogCmd("replay on",!0)})),e.myEventCls.onIds("#"+e.pre+"mn1_replayoff","click",(async function(i){let s=e.icn3d;await s.resizeCanvasCls.replayoff(),t.setLogCmd("replay off",!0)})),e.myEventCls.onIds("#"+e.pre+"mn1_menuall","click",(function(i){e.icn3d,e.htmlCls.shownMenus=e.hashUtilsCls.cloneHash(e.htmlCls.allMenus),t.applyShownMenus()})),e.myEventCls.onIds("#"+e.pre+"mn1_menusimple","click",(function(i){e.icn3d,e.htmlCls.shownMenus=e.hashUtilsCls.cloneHash(e.htmlCls.simpleMenus),t.applyShownMenus()})),e.myEventCls.onIds("#"+e.pre+"mn1_menupref","click",(function(i){e.icn3d,e.htmlCls.dialogCls.openDlg("dl_menupref","Select Menus"),t.getHiddenMenusFromCache(),t.displayShownMenus()})),e.myEventCls.onIds(["#"+e.pre+"apply_menupref","#"+e.pre+"apply_menupref2"],"click",(function(i){e.icn3d;var s=document.querySelectorAll('form[name="'+e.pre+'selmenu"] input:checked');for(var n of(e.htmlCls.shownMenus={},s))e.htmlCls.shownMenus[n.value]=1;e.htmlCls.setHtmlCls.setCookie("menumode","custom"),t.applyShownMenus()})),e.myEventCls.onIds(["#"+e.pre+"reset_menupref","#"+e.pre+"reset_menupref2"],"click",(function(i){e.icn3d,e.htmlCls.shownMenus=e.hashUtilsCls.cloneHash(e.htmlCls.simpleMenus),e.htmlCls.setHtmlCls.setCookie("menumode","simple"),t.applyShownMenus(),t.displayShownMenus()})),e.myEventCls.onIds(["#"+e.pre+"reset_menupref_all","#"+e.pre+"reset_menupref_all2"],"click",(function(i){e.icn3d,e.htmlCls.shownMenus=e.hashUtilsCls.cloneHash(e.htmlCls.allMenus),e.htmlCls.setHtmlCls.setCookie("menumode","all"),t.applyShownMenus(),t.displayShownMenus()})),e.myEventCls.onIds(["#"+e.pre+"savepref","#"+e.pre+"savepref2"],"click",(function(t){let i=e.icn3d,s="[";var n=document.querySelectorAll('form[name="'+e.pre+'selmenu"] input:not(:checked)');let r=0;for(var a of n)r>0&&(s+=", "),s+='"'+a.value+'"',++r;s+="]",i.saveFileCls.saveFile("icn3d_menus_pref.txt","text",[s])})),e.myEventCls.onIds("#"+e.pre+"reload_menupreffile","click",(function(i){e.icn3d,i.preventDefault(),e.cfg.notebook||dialog.dialog("close");let s=$("#"+e.pre+"menupreffile")[0].files[0];if(s){e.htmlCls.setHtmlCls.fileSupport();let i=new FileReader;i.onload=function(i){let s=i.target.result,n=JSON.parse(s);e.htmlCls.shownMenus={};for(let t in e.htmlCls.allMenus)-1==n.indexOf(t)&&(e.htmlCls.shownMenus[t]=1);t.applyShownMenus(),t.displayShownMenus(),e.htmlCls.setHtmlCls.setCookie("menumode","custom")},i.readAsText(s)}else alert("Please select a file before clicking 'Load'")})),e.myEventCls.onIds(["#"+e.pre+"mn1_menuloadpref","#"+e.pre+"loadpref","#"+e.pre+"loadpref2"],"click",(function(t){e.icn3d,e.htmlCls.dialogCls.openDlg("dl_menuloadpref","Please input the menu preference file")})),e.myEventCls.onIds("#"+e.pre+"mn1_link_structure","click",(function(t){let i=e.icn3d,s=i.saveFileCls.getLinkToStructureSummary(!0),n=i.structures&&Object.keys(i.structures).length>0?"_blank":"_self";window.open(s,n)})),e.myEventCls.onIds("#"+e.pre+"mn1_alphafold","click",(function(t){e.icn3d;window.open("https://github.com/sokrypton/ColabFold","_blank")})),e.myEventCls.onIds("#"+e.pre+"mn1_link_bind","click",(function(i){let s=e.icn3d,n="https://www.ncbi.nlm.nih.gov/pccompound?LinkName=pccompound_structure&from_uid="+s.inputid;t.setLogCmd("link to 3D protein structures bound to CID "+s.inputid+": "+n,!1);let r=s.structures&&Object.keys(s.structures).length>0?"_blank":"_self";window.open(n,r)})),e.myEventCls.onIds("#"+e.pre+"mn1_link_vast","click",(function(i){let s,n=e.icn3d;if(void 0===n.inputid)s="https://www.ncbi.nlm.nih.gov/pccompound?term="+n.molTitle,t.setLogCmd("link to compounds "+n.molTitle+": "+s,!1);else if(void 0!==e.cfg.cid)s="https://www.ncbi.nlm.nih.gov/pccompound?LinkName=pccompound_pccompound_3d&from_uid="+n.inputid,t.setLogCmd("link to compounds with structure similar to CID "+n.inputid+": "+s,!1);else{let i=n.inputid.split("_");1===i.length?(s=e.htmlCls.baseUrl+"vastplus/vastplus.cgi?uid="+n.inputid,t.setLogCmd("link to structures similar to "+n.inputid+": "+s,!1)):2===i.length&&(s=e.htmlCls.baseUrl+"vastplus/vastplus.cgi?uid="+i[0],t.setLogCmd("link to structures similar to "+i[0]+": "+s,!1))}let r=n.structures&&Object.keys(n.structures).length>0?"_blank":"_self";window.open(s,r)})),e.myEventCls.onIds("#"+e.pre+"mn1_link_pubmed","click",(function(i){let s,n=e.icn3d;if(void 0===n.inputid){s="https://www.ncbi.nlm.nih.gov/pubmed/?term="+n.molTitle,t.setLogCmd("link to literature about "+n.molTitle+": "+s,!1);let e=n.structures&&Object.keys(n.structures).length>0?"_blank":"_self";window.open(s,e)}else if(n.pmid){let e=n.pmid.toString().split("_");1===e.length?(s="https://www.ncbi.nlm.nih.gov/pubmed/"+n.pmid,t.setLogCmd("link to PubMed ID "+n.pmid+": "+s,!1)):2===e.length&&(s="https://www.ncbi.nlm.nih.gov/pubmed/?term="+e[0]+" OR "+e[1],t.setLogCmd("link to PubMed IDs "+e[0]+", "+e[1]+": "+s,!1));let i=n.structures&&Object.keys(n.structures).length>0?"_blank":"_self";window.open(s,i)}else if(isNaN(n.inputid)){let e=n.inputid.toString().split("_");1===e.length?(s="https://www.ncbi.nlm.nih.gov/pubmed/?term="+n.inputid,t.setLogCmd("link to literature about PDB "+n.inputid+": "+s,!1)):2===e.length&&(s="https://www.ncbi.nlm.nih.gov/pubmed/?term="+e[0]+" OR "+e[1],t.setLogCmd("link to literature about PDB "+e[0]+" OR "+e[1]+": "+s,!1));let i=n.structures&&Object.keys(n.structures).length>0?"_blank":"_self";window.open(s,i)}else void 0!==e.cfg.cid?alert("No literature information is available for this compound in the SDF file."):alert("No literature information is available for this structure.")})),e.myEventCls.onIds("#"+e.pre+"mn1_link_protein","click",(function(i){let s=e.icn3d,n=Object.keys(s.structures),r=Object.keys(s.chains),a="";for(let e=0,t=r.length;e<t;++e){let t=s.firstAtomObjCls.getFirstCalphaAtomObj(s.chains[r[e]]);s.proteins.hasOwnProperty(t.serial)&&6==r[e].length&&(a+=r[e]+"[accession] OR ")}a.length>0&&(a=a.substr(0,a.length-4));let o="https://www.ncbi.nlm.nih.gov/protein/?term="+a;t.setLogCmd("link to Entrez protein about PDB "+n+": "+o,!1);let l=s.structures&&Object.keys(s.structures).length>0?"_blank":"_self";window.open(o,l)}))}clickMenu2(){let e=this.icn3dui;if(e.icn3d,e.bNode)return;let t=this;e.myEventCls.onIds(["#"+e.pre+"mn6_selectannotations","#"+e.pre+"tool_selectannotations"],"click",(async function(i){let s=e.icn3d;await s.showAnnoCls.showAnnotations(),t.setLogCmd("view annotations",!0)})),e.myEventCls.onIds("#"+e.pre+"mn2_selectall","click",(function(i){let s=e.icn3d;t.setLogCmd("select all",!0),s.selectionCls.selectAll(),s.hlUpdateCls.removeHlAll(),s.drawCls.draw()})),e.myEventCls.onIds("#"+e.pre+"clearall","click",(function(i){let s=e.icn3d;t.setLogCmd("clear all",!0),s.bSelectResidue=!1,s.selectionCls.selectAll(),s.hlUpdateCls.removeHlAll(),s.drawCls.draw()})),e.myEventCls.onIds("#"+e.pre+"mn2_selectdisplayed","click",(function(i){let s=e.icn3d;t.setLogCmd("select displayed set",!0),s.hAtoms=e.hashUtilsCls.cloneHash(s.viewSelectionAtoms),s.hlUpdateCls.updateHlAll()})),e.myEventCls.onIds("#"+e.pre+"mn2_clashedYes","click",(function(i){let s=e.icn3d;s.bHideClashed=!1,s.annoDomainCls.showHideClashedResidues(),s.drawCls.draw(),t.setLogCmd("clashed residues show",!0)})),e.myEventCls.onIds("#"+e.pre+"mn2_clashedNo","click",(function(i){let s=e.icn3d;s.bHideClashed=!0,t.setClashedResidues(),s.annoDomainCls.showHideClashedResidues(),s.drawCls.draw(),t.setLogCmd("clashed residues hide",!0)})),e.myEventCls.onIds("#"+e.pre+"mn2_fullstru","click",(function(i){let s=e.icn3d;t.setLogCmd("show all",!0),s.selectionCls.showAll()})),e.myEventCls.onIds("#"+e.pre+"mn2_selectcomplement","click",(function(i){let s=e.icn3d;Object.keys(s.hAtoms).length<Object.keys(s.atoms).length&&(t.setLogCmd("select complement",!0),s.resid2specCls.selectComplement())})),e.myEventCls.onIds("#"+e.pre+"mn2_selectmainchains","click",(function(i){let s=e.icn3d;t.setLogCmd("select main chains",!0),s.selectionCls.selectMainChains()})),e.myEventCls.onIds("#"+e.pre+"mn2_selectsidechains","click",(function(i){let s=e.icn3d;t.setLogCmd("select side chains",!0),s.selectionCls.selectSideChains()})),e.myEventCls.onIds("#"+e.pre+"mn2_selectmainsidechains","click",(function(i){let s=e.icn3d;t.setLogCmd("select main side chains",!0),s.selectionCls.selectMainSideChains()})),e.myEventCls.onIds("#"+e.pre+"mn2_propPos","click",(function(i){let s=e.icn3d;t.setLogCmd("select prop positive",!0),s.resid2specCls.selectProperty("positive")})),e.myEventCls.onIds("#"+e.pre+"mn2_propNeg","click",(function(i){let s=e.icn3d;t.setLogCmd("select prop negative",!0),s.resid2specCls.selectProperty("negative")})),e.myEventCls.onIds("#"+e.pre+"mn2_propHydro","click",(function(i){let s=e.icn3d;t.setLogCmd("select prop hydrophobic",!0),s.resid2specCls.selectProperty("hydrophobic")})),e.myEventCls.onIds("#"+e.pre+"mn2_propPolar","click",(function(i){let s=e.icn3d;t.setLogCmd("select prop polar",!0),s.resid2specCls.selectProperty("polar")})),e.myEventCls.onIds("#"+e.pre+"mn2_propBfactor","click",(function(t){e.icn3d,e.htmlCls.dialogCls.openDlg("dl_propbybfactor","Select residue based on B-factor/pLDDT")})),e.myEventCls.onIds("#"+e.pre+"mn2_propSolAcc","click",(function(t){e.icn3d,e.htmlCls.dialogCls.openDlg("dl_propbypercentout","Select residue based on the percentage of solvent accessilbe surface area")})),e.myEventCls.onIds("#"+e.pre+"applypropbybfactor","click",(function(i){let s=e.icn3d,n=$("#"+e.pre+"minbfactor").val(),r=$("#"+e.pre+"maxbfactor").val();t.setLogCmd("select prop b factor | "+n+"_"+r,!0),s.resid2specCls.selectProperty("b factor",n,r)})),e.myEventCls.onIds("#"+e.pre+"applypropbypercentout","click",(function(i){let s=e.icn3d,n=$("#"+e.pre+"minpercentout").val(),r=$("#"+e.pre+"maxpercentout").val();t.setLogCmd("select prop percent out | "+n+"_"+r,!0),s.resid2specCls.selectProperty("percent out",n,r)})),e.myEventCls.onIds("#"+e.pre+"mn2_alignment","click",(function(i){e.icn3d,e.htmlCls.dialogCls.openDlg("dl_alignment","Select residues in aligned sequences"),t.setLogCmd("window aligned sequences",!0)})),e.myEventCls.onIds("#"+e.pre+"mn1_window_table","click",(function(i){e.icn3d,e.htmlCls.dialogCls.openDlg("dl_allinteraction","Show interactions"),t.setLogCmd("window interaction table",!0)})),e.myEventCls.onIds("#"+e.pre+"mn1_window_linegraph","click",(function(i){e.icn3d,e.htmlCls.dialogCls.openDlg("dl_linegraph","Show interactions between two lines of residue nodes"),t.setLogCmd("window interaction graph",!0)})),e.myEventCls.onIds("#"+e.pre+"mn1_window_scatterplot","click",(function(i){e.icn3d,e.htmlCls.dialogCls.openDlg("dl_scatterplot","Show interactions as map"),t.setLogCmd("window interaction scatterplot",!0)})),e.myEventCls.onIds("#"+e.pre+"mn1_window_graph","click",(function(i){e.icn3d,e.htmlCls.dialogCls.openDlg("dl_graph","Force-directed graph"),t.setLogCmd("window force-directed graph",!0)})),e.myEventCls.onIds("#"+e.pre+"mn6_yournote","click",(function(t){e.icn3d,e.htmlCls.dialogCls.openDlg("dl_yournote","Your note about the current display")})),e.myEventCls.onIds("#"+e.pre+"applyyournote","click",(function(i){let s=e.icn3d;s.yournote=$("#"+e.pre+"yournote").val(),e.cfg.shownote&&(document.title=s.yournote),e.cfg.notebook||dialog.dialog("close"),t.setLogCmd("your note | "+s.yournote,!0)})),e.myEventCls.onIds("#"+e.pre+"mn2_command","click",(function(t){e.icn3d,e.htmlCls.dialogCls.openDlg("dl_advanced2","Select by specification")})),e.myEventCls.onIds(["#"+e.pre+"mn2_definedsets","#"+e.pre+"definedsets","#"+e.pre+"definedsets2","#"+e.pre+"tool_definedsets"],"click",(function(i){e.icn3d.definedSetsCls.showSets(),t.setLogCmd("defined sets",!0)})),$(document).on("click","#"+e.pre+"setOr",(function(t){let i=e.icn3d;t.stopImmediatePropagation(),i.setOperation="or"})),$(document).on("click","#"+e.pre+"setAnd",(function(t){let i=e.icn3d;t.stopImmediatePropagation(),i.setOperation="and"})),$(document).on("click","#"+e.pre+"setNot",(function(t){let i=e.icn3d;t.stopImmediatePropagation(),i.setOperation="not"})),e.myEventCls.onIds("#"+e.pre+"mn2_pkNo","click",(function(i){let s=e.icn3d;s.pk=0,s.opts.pk="no",t.setLogCmd("set pk off",!0),s.drawCls.draw(),s.hlObjectsCls.removeHlObjects()})),e.myEventCls.onIds("#"+e.pre+"mn2_pkYes","click",(function(i){let s=e.icn3d;s.pk=1,s.opts.pk="atom",t.setLogCmd("set pk atom",!0)})),e.myEventCls.onIds("#"+e.pre+"mn2_pkResidue","click",(function(i){let s=e.icn3d;s.pk=2,s.opts.pk="residue",t.setLogCmd("set pk residue",!0)})),e.myEventCls.onIds("#"+e.pre+"mn2_pkStrand","click",(function(i){let s=e.icn3d;s.pk=3,s.opts.pk="strand",t.setLogCmd("set pk strand",!0)})),e.myEventCls.onIds("#"+e.pre+"mn2_pkDomain","click",(function(i){let s=e.icn3d;s.pk=4,s.opts.pk="domain",t.setLogCmd("set pk domain",!0)})),e.myEventCls.onIds("#"+e.pre+"mn2_pkChain","click",(function(i){let s=e.icn3d;s.pk=5,s.opts.pk="chain",t.setLogCmd("set pk chain",!0)})),e.myEventCls.onIds("#"+e.pre+"adjustmem","click",(function(t){e.icn3d,e.htmlCls.dialogCls.openDlg("dl_adjustmem","Adjust the Z-axis positions of the membrane")})),e.myEventCls.onIds("#"+e.pre+"togglemem","click",(function(i){e.icn3d.selectionCls.toggleMembrane(),t.setLogCmd("toggle membrane",!0)})),e.myEventCls.onIds("#"+e.pre+"selectplane","click",(function(t){e.icn3d,e.htmlCls.dialogCls.openDlg("dl_selectplane","Select a region between two planes")})),e.myEventCls.onIds(["#"+e.pre+"mn2_aroundsphere","#"+e.pre+"tool_aroundsphere"],"click",(function(i){let s=e.icn3d;t.SetChainsAdvancedMenu();let n=s.definedSetsCls.setAtomMenu(["protein"]);$("#"+e.pre+"atomsCustomSphere").length&&$("#"+e.pre+"atomsCustomSphere").html("  <option value='non-selected' selected>non-selected</option><option value='selected'>selected</option>"+n),$("#"+e.pre+"atomsCustomSphere2").length&&$("#"+e.pre+"atomsCustomSphere2").html("  <option value='selected' selected>selected</option>"+n),e.htmlCls.dialogCls.openDlg("dl_aroundsphere","Select a sphere around a set of residues"),s.bSphereCalc=!1,$("#"+e.pre+"atomsCustomSphere").resizable(),$("#"+e.pre+"atomsCustomSphere2").resizable()})),e.myEventCls.onIds(["#"+e.pre+"mn2_select_chain","#"+e.pre+"definedSets"],"click",(function(t){e.icn3d,e.htmlCls.dialogCls.openDlg("dl_select_chain","Select Structure/Chain/Custom Selection")}))}clickMenu3(){let e=this.icn3dui;if(e.icn3d,e.bNode)return;let t=this;e.myEventCls.onIds(["#"+e.pre+"mn3_proteinsRibbon","#"+e.pre+"tool_proteinsRibbon"],"click",(function(i){e.icn3d.setOptionCls.setStyle("proteins","ribbon"),t.setLogCmd("style proteins ribbon",!0)})),e.myEventCls.onIds("#"+e.pre+"mn3_proteinsStrand","click",(function(i){e.icn3d.setOptionCls.setStyle("proteins","strand"),t.setLogCmd("style proteins strand",!0)})),e.myEventCls.onIds("#"+e.pre+"mn3_proteinsCylinder","click",(function(i){e.icn3d.setOptionCls.setStyle("proteins","cylinder and plate"),t.setLogCmd("style proteins cylinder and plate",!0)})),e.myEventCls.onIds("#"+e.pre+"mn3_proteinsSchematic","click",(function(i){e.icn3d.setOptionCls.setStyle("proteins","schematic"),t.setLogCmd("style proteins schematic",!0)})),e.myEventCls.onIds("#"+e.pre+"mn3_proteinsCalpha","click",(function(i){e.icn3d.setOptionCls.setStyle("proteins","c alpha trace"),t.setLogCmd("style proteins c alpha trace",!0)})),e.myEventCls.onIds("#"+e.pre+"mn3_proteinsBackbone","click",(function(i){e.icn3d.setOptionCls.setStyle("proteins","backbone"),t.setLogCmd("style proteins backbone",!0)})),e.myEventCls.onIds("#"+e.pre+"mn3_proteinsBfactor","click",(function(i){e.icn3d.setOptionCls.setStyle("proteins","b factor tube"),t.setLogCmd("style proteins b factor tube",!0)})),e.myEventCls.onIds("#"+e.pre+"mn3_proteinsLines","click",(function(i){e.icn3d.setOptionCls.setStyle("proteins","lines"),t.setLogCmd("style proteins lines",!0)})),e.myEventCls.onIds("#"+e.pre+"mn3_proteinsStick","click",(function(i){e.icn3d.setOptionCls.setStyle("proteins","stick"),t.setLogCmd("style proteins stick",!0)})),e.myEventCls.onIds(["#"+e.pre+"mn3_proteinsBallstick","#"+e.pre+"tool_proteinsBallstick"],"click",(function(i){e.icn3d.setOptionCls.setStyle("proteins","ball and stick"),t.setLogCmd("style proteins ball and stick",!0)})),e.myEventCls.onIds(["#"+e.pre+"mn3_proteinsSphere","#"+e.pre+"tool_proteinsSphere"],"click",(function(i){e.icn3d.setOptionCls.setStyle("proteins","sphere"),t.setLogCmd("style proteins sphere",!0)})),e.myEventCls.onIds("#"+e.pre+"mn3_proteinsNo","click",(function(i){e.icn3d.setOptionCls.setStyle("proteins","nothing"),t.setLogCmd("style proteins nothing",!0)})),e.myEventCls.onIds("#"+e.pre+"mn3_sidecLines","click",(function(i){e.icn3d.setOptionCls.setStyle("sidec","lines2"),t.setLogCmd("style sidec lines2",!0)})),e.myEventCls.onIds("#"+e.pre+"mn3_sidecStick","click",(function(i){e.icn3d.setOptionCls.setStyle("sidec","stick2"),t.setLogCmd("style sidec stick2",!0)})),e.myEventCls.onIds("#"+e.pre+"mn3_sidecBallstick","click",(function(i){e.icn3d.setOptionCls.setStyle("sidec","ball and stick2"),t.setLogCmd("style sidec ball and stick2",!0)})),e.myEventCls.onIds("#"+e.pre+"mn3_sidecSphere","click",(function(i){e.icn3d.setOptionCls.setStyle("sidec","sphere2"),t.setLogCmd("style sidec sphere2",!0)})),e.myEventCls.onIds("#"+e.pre+"mn3_sidecNo","click",(function(i){e.icn3d.setOptionCls.setStyle("sidec","nothing"),t.setLogCmd("style sidec nothing",!0)})),e.myEventCls.onIds("#"+e.pre+"mn3_ntbaseLines","click",(function(i){e.icn3d.setOptionCls.setStyle("ntbase","lines2"),t.setLogCmd("style ntbase lines2",!0)})),e.myEventCls.onIds("#"+e.pre+"mn3_ntbaseStick","click",(function(i){e.icn3d.setOptionCls.setStyle("ntbase","stick2"),t.setLogCmd("style ntbase stick2",!0)})),e.myEventCls.onIds("#"+e.pre+"mn3_ntbaseBallstick","click",(function(i){e.icn3d.setOptionCls.setStyle("ntbase","ball and stick2"),t.setLogCmd("style ntbase ball and stick2",!0)})),e.myEventCls.onIds("#"+e.pre+"mn3_ntbaseSphere","click",(function(i){e.icn3d.setOptionCls.setStyle("ntbase","sphere2"),t.setLogCmd("style ntbase sphere2",!0)})),e.myEventCls.onIds("#"+e.pre+"mn3_ntbaseNo","click",(function(i){e.icn3d.setOptionCls.setStyle("ntbase","nothing"),t.setLogCmd("style ntbase nothing",!0)})),e.myEventCls.onIds("#"+e.pre+"mn3_nuclCartoon","click",(function(i){e.icn3d.setOptionCls.setStyle("nucleotides","nucleotide cartoon"),t.setLogCmd("style nucleotides nucleotide cartoon",!0)})),e.myEventCls.onIds("#"+e.pre+"mn3_nuclBackbone","click",(function(i){e.icn3d.setOptionCls.setStyle("nucleotides","backbone"),t.setLogCmd("style nucleotides backbone",!0)})),e.myEventCls.onIds("#"+e.pre+"mn3_nuclSchematic","click",(function(i){e.icn3d.setOptionCls.setStyle("nucleotides","schematic"),t.setLogCmd("style nucleotides schematic",!0)})),e.myEventCls.onIds("#"+e.pre+"mn3_nuclPhos","click",(function(i){e.icn3d.setOptionCls.setStyle("nucleotides","o3 trace"),t.setLogCmd("style nucleotides o3 trace",!0)})),e.myEventCls.onIds("#"+e.pre+"mn3_nuclLines","click",(function(i){e.icn3d.setOptionCls.setStyle("nucleotides","lines"),t.setLogCmd("style nucleotides lines",!0)})),e.myEventCls.onIds("#"+e.pre+"mn3_nuclStick","click",(function(i){e.icn3d.setOptionCls.setStyle("nucleotides","stick"),t.setLogCmd("style nucleotides stick",!0)})),e.myEventCls.onIds("#"+e.pre+"mn3_nuclBallstick","click",(function(i){e.icn3d.setOptionCls.setStyle("nucleotides","ball and stick"),t.setLogCmd("style nucleotides ball and stick",!0)})),e.myEventCls.onIds("#"+e.pre+"mn3_nuclSphere","click",(function(i){e.icn3d.setOptionCls.setStyle("nucleotides","sphere"),t.setLogCmd("style nucleotides sphere",!0)})),e.myEventCls.onIds("#"+e.pre+"mn3_nuclNo","click",(function(i){e.icn3d.setOptionCls.setStyle("nucleotides","nothing"),t.setLogCmd("style nucleotides nothing",!0)})),e.myEventCls.onIds("#"+e.pre+"mn3_ligLines","click",(function(i){e.icn3d.setOptionCls.setStyle("chemicals","lines"),t.setLogCmd("style chemicals lines",!0)})),e.myEventCls.onIds("#"+e.pre+"mn3_ligStick","click",(function(i){e.icn3d.setOptionCls.setStyle("chemicals","stick"),t.setLogCmd("style chemicals stick",!0)})),e.myEventCls.onIds("#"+e.pre+"mn3_ligBallstick","click",(function(i){e.icn3d.setOptionCls.setStyle("chemicals","ball and stick"),t.setLogCmd("style chemicals ball and stick",!0)})),e.myEventCls.onIds("#"+e.pre+"mn3_ligSchematic","click",(function(i){e.icn3d.setOptionCls.setStyle("chemicals","schematic"),t.setLogCmd("style chemicals schematic",!0)})),e.myEventCls.onIds("#"+e.pre+"mn3_ligSphere","click",(function(i){e.icn3d.setOptionCls.setStyle("chemicals","sphere"),t.setLogCmd("style chemicals sphere",!0)})),e.myEventCls.onIds("#"+e.pre+"mn3_ligNo","click",(function(i){e.icn3d.setOptionCls.setStyle("chemicals","nothing"),t.setLogCmd("style chemicals nothing",!0)})),e.myEventCls.onIds("#"+e.pre+"mn3_glycansCartYes","click",(function(i){let s=e.icn3d;s.bGlycansCartoon=!0,s.drawCls.draw(),t.setLogCmd("glycans cartoon yes",!0)})),e.myEventCls.onIds("#"+e.pre+"mn3_glycansCartNo","click",(function(i){let s=e.icn3d;s.bGlycansCartoon=!1,s.drawCls.draw(),t.setLogCmd("glycans cartoon no",!0)})),e.myEventCls.onIds("#"+e.pre+"mn3_hydrogensYes","click",(function(i){let s=e.icn3d;s.showInterCls.showHydrogens(),s.drawCls.draw(),t.setLogCmd("hydrogens",!0)})),e.myEventCls.onIds("#"+e.pre+"mn3_hydrogensNo","click",(function(i){let s=e.icn3d;s.showInterCls.hideHydrogens(),s.drawCls.draw(),t.setLogCmd("set hydrogens off",!0)})),e.myEventCls.onIds("#"+e.pre+"mn3_ionsSphere","click",(function(i){e.icn3d.setOptionCls.setStyle("ions","sphere"),t.setLogCmd("style ions sphere",!0)})),e.myEventCls.onIds("#"+e.pre+"mn3_ionsDot","click",(function(i){e.icn3d.setOptionCls.setStyle("ions","dot"),t.setLogCmd("style ions dot",!0)})),e.myEventCls.onIds("#"+e.pre+"mn3_ionsNo","click",(function(i){e.icn3d.setOptionCls.setStyle("ions","nothing"),t.setLogCmd("style ions nothing",!0)})),e.myEventCls.onIds("#"+e.pre+"mn3_waterSphere","click",(function(i){e.icn3d.setOptionCls.setStyle("water","sphere"),t.setLogCmd("style water sphere",!0)})),e.myEventCls.onIds("#"+e.pre+"mn3_waterDot","click",(function(i){e.icn3d.setOptionCls.setStyle("water","dot"),t.setLogCmd("style water dot",!0)})),e.myEventCls.onIds("#"+e.pre+"mn3_waterNo","click",(function(i){e.icn3d.setOptionCls.setStyle("water","nothing"),t.setLogCmd("style water nothing",!0)}))}clickMenu4(){let e=this.icn3dui;if(e.icn3d,e.bNode)return;let t=this;e.myEventCls.onIds("#"+e.pre+"mn4_clrSpectrum","click",(function(i){e.icn3d.setOptionCls.setOption("color","spectrum"),t.setLogCmd("color spectrum",!0)})),e.myEventCls.onIds("#"+e.pre+"mn4_clrSpectrumChain","click",(function(i){e.icn3d.setOptionCls.setOption("color","spectrum for chains"),t.setLogCmd("color spectrum for chains",!0)})),e.myEventCls.onIds("#"+e.pre+"mn4_clrSpectrumAcrossSets","click",(function(i){let s=e.icn3d;t.SetChainsAdvancedMenu();let n=s.definedSetsCls.setAtomMenu(["protein"]);$("#"+e.pre+"atomsCustomColorSpectrumAcross").length&&$("#"+e.pre+"atomsCustomColorSpectrumAcross").html(n),s.bRender&&e.htmlCls.dialogCls.openDlg("dl_colorspectrumacrosssets","Please select sets to apply spectrum color for sets"),$("#"+e.pre+"atomsCustomColorSpectrumAcross").resizable()})),e.myEventCls.onIds("#"+e.pre+"mn4_clrSpectrumSets","click",(function(i){let s=e.icn3d;t.SetChainsAdvancedMenu();let n=s.definedSetsCls.setAtomMenu(["protein"]);$("#"+e.pre+"atomsCustomColorSpectrum").length&&$("#"+e.pre+"atomsCustomColorSpectrum").html(n),s.bRender&&e.htmlCls.dialogCls.openDlg("dl_colorspectrumbysets","Please select sets to apply spectrum color for residues"),$("#"+e.pre+"atomsCustomColorSpectrum").resizable()})),e.myEventCls.onIds("#"+e.pre+"mn4_clrRainbowAcrossSets","click",(function(i){let s=e.icn3d;t.SetChainsAdvancedMenu();let n=s.definedSetsCls.setAtomMenu(["protein"]);$("#"+e.pre+"atomsCustomColorRainbowAcross").length&&$("#"+e.pre+"atomsCustomColorRainbowAcross").html(n),s.bRender&&e.htmlCls.dialogCls.openDlg("dl_colorrainbowacrosssets","Please select sets to apply rainbow color for sets"),$("#"+e.pre+"atomsCustomColorRainbowAcross").resizable()})),e.myEventCls.onIds("#"+e.pre+"mn4_clrRainbowSets","click",(function(i){let s=e.icn3d;t.SetChainsAdvancedMenu();let n=s.definedSetsCls.setAtomMenu(["protein"]);$("#"+e.pre+"atomsCustomColorRainbow").length&&$("#"+e.pre+"atomsCustomColorRainbow").html(n),s.bRender&&e.htmlCls.dialogCls.openDlg("dl_colorrainbowbysets","Please select sets to apply rainbow color for residues"),$("#"+e.pre+"atomsCustomColorRainbow").resizable()})),e.myEventCls.onIds("#"+e.pre+"mn4_clrRainbow","click",(function(i){e.icn3d.setOptionCls.setOption("color","rainbow"),t.setLogCmd("color rainbow",!0)})),e.myEventCls.onIds(["#"+e.pre+"mn4_clrRainbowChain","#"+e.pre+"tool_clrRainbowChain"],"click",(function(i){e.icn3d.setOptionCls.setOption("color","rainbow for chains"),t.setLogCmd("color rainbow for chains",!0)})),e.myEventCls.onIds(["#"+e.pre+"mn4_clrChain","#"+e.pre+"tool_clrChain"],"click",(function(i){e.icn3d.setOptionCls.setOption("color","chain"),t.setLogCmd("color chain",!0)})),e.myEventCls.onIds("#"+e.pre+"mn4_clrStructure","click",(function(i){e.icn3d.setOptionCls.setOption("color","structure"),t.setLogCmd("color structure",!0)})),e.myEventCls.onIds("#"+e.pre+"mn4_clrdomain","click",(function(i){e.icn3d.setOptionCls.setOption("color","domain"),t.setLogCmd("color domain",!0)})),e.myEventCls.onIds("#"+e.pre+"mn4_clrsets","click",(function(i){e.icn3d.setOptionCls.setOption("color","defined sets"),t.setLogCmd("color defined sets",!0)})),e.myEventCls.onIds(["#"+e.pre+"mn4_clrSSGreen","#"+e.pre+"tool_clrSSGreen"],"click",(function(i){let s=e.icn3d;s.sheetcolor="green",s.setOptionCls.setOption("color","secondary structure green"),t.setLogCmd("color secondary structure green",!0)})),e.myEventCls.onIds("#"+e.pre+"mn4_clrSSYellow","click",(function(i){let s=e.icn3d;s.sheetcolor="yellow",s.setOptionCls.setOption("color","secondary structure yellow"),t.setLogCmd("color secondary structure yellow",!0)})),e.myEventCls.onIds("#"+e.pre+"mn4_clrSSSpectrum","click",(function(i){e.icn3d.setOptionCls.setOption("color","secondary structure spectrum"),t.setLogCmd("color secondary structure spectrum",!0)})),e.myEventCls.onIds("#"+e.pre+"mn4_clrResidue","click",(function(i){e.icn3d.setOptionCls.setOption("color","residue"),t.setLogCmd("color residue",!0)})),e.myEventCls.onIds("#"+e.pre+"mn4_clrResidueCustom","click",(function(t){e.icn3d,e.htmlCls.dialogCls.openDlg("dl_rescolorfile","Please input the file on residue colors")})),e.myEventCls.onIds("#"+e.pre+"reload_rescolorfile","click",(function(i){let s=e.icn3d;i.preventDefault(),e.cfg.notebook||dialog.dialog("close");let n=$("#"+e.pre+"rescolorfile")[0].files[0];if(n){e.htmlCls.setHtmlCls.fileSupport();let i=new FileReader;i.onload=function(i){let n=i.target.result.replace(/#/g,"");s.customResidueColors=JSON.parse(n);for(let t in s.customResidueColors)s.customResidueColors[t.toUpperCase()]=e.parasCls.thr("#"+s.customResidueColors[t]);s.setOptionCls.setOption("color","residue custom"),t.setLogCmd("color residue custom | "+n,!0)},i.readAsText(n)}else alert("Please select a file before clicking 'Load'")})),e.myEventCls.onIds("#"+e.pre+"reload_customcolorfile","click",(function(i){let s=e.icn3d;i.preventDefault(),e.cfg.notebook||dialog.dialog("close"),s.startColor=$("#"+e.pre+"startColor").val(),s.midColor=$("#"+e.pre+"midColor").val(),s.endColor=$("#"+e.pre+"endColor").val();let n=t.setLegendHtml();$("#"+e.pre+"dl_legend_html").html(n),e.htmlCls.dialogCls.openDlg("dl_legend","Color range"),s.addTrackCls.setCustomFile("color",s.startColor,s.midColor,s.endColor)})),e.myEventCls.onIds("#"+e.pre+"mn6_customref","click",(function(t){e.icn3d,e.htmlCls.dialogCls.openDlg("dl_customref","Set custom reference numbers")})),e.myEventCls.onIds("#"+e.pre+"reload_customreffile","click",(function(i){let s=e.icn3d;e.cfg.notebook||dialog.dialog("close");let n=$("#"+s.pre+"cstreffile")[0].files[0];if(n){e.utilsCls.checkFileAPI();let i=new FileReader;i.onload=async function(e){let i=e.target.result;await s.refnumCls.parseCustomRefFile(i),i=i.replace(/\r/g,"").replace(/\n/g,"\\n"),t.setLogCmd("custom refnum | "+i,!0)},i.readAsText(n)}else alert("Please select a file before clicking 'Apply'")})),e.myEventCls.onIds("#"+e.pre+"remove_legend","click",(function(i){e.icn3d,i.preventDefault(),$("#"+e.pre+"legend").hide(),t.setLogCmd("remove legend",!0)})),e.myEventCls.onIds("#"+e.pre+"reload_customtubefile","click",(function(t){let i=e.icn3d;t.preventDefault(),e.cfg.notebook||dialog.dialog("close"),i.addTrackCls.setCustomFile("tube")})),e.myEventCls.onIds("#"+e.pre+"mn4_clrCharge","click",(function(i){e.icn3d.setOptionCls.setOption("color","charge"),t.setLogCmd("color charge",!0)})),e.myEventCls.onIds("#"+e.pre+"mn4_clrHydrophobic","click",(function(i){e.icn3d.setOptionCls.setOption("color","hydrophobic"),t.setLogCmd("color hydrophobic",!0)})),e.myEventCls.onIds("#"+e.pre+"mn4_clrNormalizedHP","click",(function(i){e.icn3d.setOptionCls.setOption("color","normalized hydrophobic"),t.setLogCmd("color normalized hydrophobic",!0)})),e.myEventCls.onIds(["#"+e.pre+"mn4_clrAtom","#"+e.pre+"tool_clrAtom"],"click",(function(i){e.icn3d.setOptionCls.setOption("color","atom"),t.setLogCmd("color atom",!0)})),e.myEventCls.onIds("#"+e.pre+"mn4_clrBfactor","click",(function(i){e.icn3d.setOptionCls.setOption("color","b factor"),t.setLogCmd("color b factor",!0)})),e.myEventCls.onIds("#"+e.pre+"mn4_clrConfidence","click",(function(i){e.icn3d.setOptionCls.setOption("color","confidence"),t.setLogCmd("color confidence",!0)})),e.myEventCls.onIds("#"+e.pre+"mn4_clrIgstrand","click",(function(i){e.icn3d.setOptionCls.setOption("color","ig strand"),t.setLogCmd("color ig strand",!0)})),e.myEventCls.onIds("#"+e.pre+"mn4_clrIgproto","click",(function(i){e.icn3d.setOptionCls.setOption("color","ig protodomain"),t.setLogCmd("color ig protodomain",!0)})),e.myEventCls.onIds("#"+e.pre+"mn4_clrArea","click",(function(t){e.icn3d,e.htmlCls.dialogCls.openDlg("dl_colorbyarea","Color based on residue's solvent accessibility")})),e.myEventCls.onIds("#"+e.pre+"applycolorbyarea","click",(function(i){let s=e.icn3d;s.midpercent=$("#"+e.pre+"midpercent").val(),s.setOptionCls.setOption("color","area"),t.setLogCmd("color area | "+s.midpercent,!0)})),e.myEventCls.onIds("#"+e.pre+"mn4_clrBfactorNorm","click",(function(i){e.icn3d.setOptionCls.setOption("color","b factor percentile"),t.setLogCmd("color b factor percentile",!0)})),e.myEventCls.onIds("#"+e.pre+"mn4_clrIdentity","click",(function(i){e.icn3d.setOptionCls.setOption("color","identity"),t.setLogCmd("color identity",!0)})),e.myEventCls.onIds("#"+e.pre+"mn4_clrConserved","click",(function(i){e.icn3d.setOptionCls.setOption("color","conservation"),t.setLogCmd("color conservation",!0)})),e.myEventCls.onIds("#"+e.pre+"mn4_clrCustom","click",(function(t){e.icn3d,e.htmlCls.dialogCls.openDlg("dl_clr","Color picker")})),$(document).on("click",".icn3d-color-rad-text",(function(i){let s=e.icn3d;i.stopImmediatePropagation();let n=$(this).attr("color");s.setOptionCls.setOption("color",n),t.setLogCmd("color "+n,!0)})),e.myEventCls.onIds("#"+e.pre+"mn4_clrSave","click",(function(i){e.icn3d.setOptionCls.saveColor(),t.setLogCmd("save color",!0)})),e.myEventCls.onIds("#"+e.pre+"mn4_clrApplySave","click",(function(i){e.icn3d.setOptionCls.applySavedColor(),t.setLogCmd("apply saved color",!0)})),e.myEventCls.onIds("#"+e.pre+"mn3_styleSave","click",(function(i){e.icn3d.setOptionCls.saveStyle(),t.setLogCmd("save style",!0)})),e.myEventCls.onIds("#"+e.pre+"mn3_styleApplySave","click",(function(i){e.icn3d.setOptionCls.applySavedStyle(),t.setLogCmd("apply saved style",!0)}))}clickMenu5(){let e=this.icn3dui;if(e.icn3d,e.bNode)return;let t=this;e.myEventCls.onIds("#"+e.pre+"mn5_neighborsYes","click",(function(i){let s=e.icn3d;s.bConsiderNeighbors=!0,s.applyMapCls.removeLastSurface(),s.applyMapCls.applySurfaceOptions(),s.bRender&&s.drawCls.render(),t.setLogCmd("set surface neighbors on",!0)})),e.myEventCls.onIds("#"+e.pre+"mn5_neighborsNo","click",(function(i){let s=e.icn3d;s.bConsiderNeighbors=!1,s.applyMapCls.removeLastSurface(),s.applyMapCls.applySurfaceOptions(),s.bRender&&s.drawCls.render(),t.setLogCmd("set surface neighbors off",!0)})),e.myEventCls.onIds(["#"+e.pre+"mn5_surfaceVDW","#"+e.pre+"tool_surfaceVDW"],"click",(function(i){let s=e.icn3d;s.bConsiderNeighbors=!1,s.setOptionCls.setOption("surface","Van der Waals surface"),t.setLogCmd("set surface Van der Waals surface",!0)})),e.myEventCls.onIds("#"+e.pre+"mn5_surfaceSAS","click",(function(i){let s=e.icn3d;s.bConsiderNeighbors=!1,s.setOptionCls.setOption("surface","solvent accessible surface"),t.setLogCmd("set surface solvent accessible surface",!0)})),e.myEventCls.onIds("#"+e.pre+"mn5_surfaceMolecular","click",(function(i){let s=e.icn3d;s.bConsiderNeighbors=!1,s.setOptionCls.setOption("surface","molecular surface"),t.setLogCmd("set surface molecular surface",!0)})),e.myEventCls.onIds("#"+e.pre+"mn5_surfaceVDWContext","click",(function(i){let s=e.icn3d;s.bConsiderNeighbors=!0,s.setOptionCls.setOption("surface","Van der Waals surface with context"),t.setLogCmd("set surface Van der Waals surface with context",!0)})),e.myEventCls.onIds("#"+e.pre+"mn5_surfaceSASContext","click",(function(i){let s=e.icn3d;s.bConsiderNeighbors=!0,s.setOptionCls.setOption("surface","solvent accessible surface with context"),t.setLogCmd("set surface solvent accessible surface with context",!0)})),e.myEventCls.onIds("#"+e.pre+"mn5_surfaceMolecularContext","click",(function(i){let s=e.icn3d;s.bConsiderNeighbors=!0,s.setOptionCls.setOption("surface","molecular surface with context"),t.setLogCmd("set surface molecular surface with context",!0)})),e.myEventCls.onIds("#"+e.pre+"mn5_surfaceNo","click",(function(i){e.icn3d.setOptionCls.setOption("surface","nothing"),t.setLogCmd("set surface nothing",!0)})),$(document).on("click","."+e.pre+"mn5_opacity",(function(i){let s=e.icn3d;s.transparentRenderOrder=!1;let n=$(this).attr("v");s.setOptionCls.setOption("opacity",n),t.setLogCmd("set surface opacity "+n,!0)})),$(document).on("click","."+e.pre+"mn5_opacityslow",(function(i){let s=e.icn3d;s.transparentRenderOrder=!0;let n=$(this).attr("v");s.setOptionCls.setOption("opacity",n),t.setLogCmd("set surface2 opacity "+n,!0)})),e.myEventCls.onIds("#"+e.pre+"mn5_wireframeYes","click",(function(i){e.icn3d.setOptionCls.setOption("wireframe","yes"),t.setLogCmd("set surface wireframe on",!0)})),e.myEventCls.onIds("#"+e.pre+"mn5_wireframeNo","click",(function(i){e.icn3d.setOptionCls.setOption("wireframe","no"),t.setLogCmd("set surface wireframe off",!0)})),e.myEventCls.onIds("#"+e.pre+"mn5_elecmap2fofc","click",(function(t){e.icn3d,e.htmlCls.dialogCls.openDlg("dl_elecmap2fofc","2Fo-Fc Electron Density Map")})),e.myEventCls.onIds("#"+e.pre+"mn5_elecmapfofc","click",(function(t){e.icn3d,e.htmlCls.dialogCls.openDlg("dl_elecmapfofc","Fo-Fc Electron Density Map")})),e.myEventCls.onIds(["#"+e.pre+"mn5_elecmapNo","#"+e.pre+"elecmapNo2","#"+e.pre+"elecmapNo3","#"+e.pre+"elecmapNo4","#"+e.pre+"elecmapNo5"],"click",(function(i){e.icn3d.setOptionCls.setOption("map","nothing"),t.setLogCmd("setoption map nothing",!0)})),e.myEventCls.onIds(["#"+e.pre+"delphimapNo","#"+e.pre+"phimapNo","#"+e.pre+"phiurlmapNo","#"+e.pre+"mn1_phimapNo"],"click",(function(i){e.icn3d.setOptionCls.setOption("phimap","nothing"),t.setLogCmd("setoption phimap nothing",!0)})),e.myEventCls.onIds(["#"+e.pre+"delphimapNo2","#"+e.pre+"phimapNo2","#"+e.pre+"phiurlmapNo2"],"click",(function(i){e.icn3d.setOptionCls.setOption("phisurface","nothing"),t.setLogCmd("setoption phisurface nothing",!0)})),e.myEventCls.onIds("#"+e.pre+"applymap2fofc","click",(async function(i){let s=e.icn3d;i.preventDefault();let n=parseFloat($("#"+e.pre+"sigma2fofc").val());await s.densityCifParserCls.densityCifParser(s.inputid,"2fofc",n),t.setLogCmd("set map 2fofc sigma "+n,!0)})),e.myEventCls.onIds("#"+e.pre+"applymapfofc","click",(async function(i){let s=e.icn3d;i.preventDefault();let n=parseFloat($("#"+e.pre+"sigmafofc").val());await s.densityCifParserCls.densityCifParser(s.inputid,"fofc",sigma2fofc),t.setLogCmd("set map fofc sigma "+n,!0)})),e.myEventCls.onIds("#"+e.pre+"mn5_mapwireframeYes","click",(function(i){e.icn3d.setOptionCls.setOption("mapwireframe","yes"),t.setLogCmd("set map wireframe on",!0)})),e.myEventCls.onIds("#"+e.pre+"mn5_mapwireframeNo","click",(function(i){e.icn3d.setOptionCls.setOption("mapwireframe","no"),t.setLogCmd("set map wireframe off",!0)})),e.myEventCls.onIds("#"+e.pre+"mn5_emmap","click",(function(t){e.icn3d,e.htmlCls.dialogCls.openDlg("dl_emmap","EM Density Map")})),e.myEventCls.onIds(["#"+e.pre+"mn5_emmapNo","#"+e.pre+"emmapNo2"],"click",(function(i){e.icn3d.setOptionCls.setOption("emmap","nothing"),t.setLogCmd("setoption emmap nothing",!0)})),e.myEventCls.onIds("#"+e.pre+"applyemmap","click",(async function(i){let s=e.icn3d;i.preventDefault();let n=parseFloat($("#"+e.pre+"empercentage").val());await s.densityCifParserCls.densityCifParser(s.inputid,"em",n,s.emd),t.setLogCmd("set emmap percentage "+n,!0)})),e.myEventCls.onIds("#"+e.pre+"mn5_emmapwireframeYes","click",(function(i){e.icn3d.setOptionCls.setOption("emmapwireframe","yes"),t.setLogCmd("set emmap wireframe on",!0)})),e.myEventCls.onIds("#"+e.pre+"mn5_emmapwireframeNo","click",(function(i){e.icn3d.setOptionCls.setOption("emmapwireframe","no"),t.setLogCmd("set emmap wireframe off",!0)}))}clickMenu6(){let e=this.icn3dui,t=e.icn3d;if(e.bNode)return;let i=this;e.myEventCls.onIds("#"+e.pre+"mn6_assemblyYes","click",(function(t){let s=e.icn3d;s.bAssembly=!0,i.setLogCmd("set assembly on",!0),s.drawCls.draw()})),e.myEventCls.onIds("#"+e.pre+"mn6_assemblyNo","click",(function(t){let s=e.icn3d;s.bAssembly=!1,i.setLogCmd("set assembly off",!0),s.drawCls.draw()})),e.myEventCls.onIds("#"+e.pre+"mn6_igrefYes","click",(async function(t){let s=e.icn3d;s.bRunRefnumAgain=!0,i.setLogCmd("ig refnum on",!0),s.bAnnoShown||await s.showAnnoCls.showAnnotations();await s.annotationCls.setAnnoTabIg(!0),s.bRunRefnumAgain=!1})),e.myEventCls.onIds("#"+e.pre+"mn6_igrefTpl","click",(async function(t){e.icn3d,e.htmlCls.dialogCls.openDlg("dl_igrefTpl","Choose an Ig template")})),e.myEventCls.onIds("#"+e.pre+"mn6_igrefTpl_apply","click",(async function(t){e.icn3d,e.cfg.notebook||dialog.dialog("close");let s=$("#"+e.pre+"refTpl").val();await i.setIgTemplate(s),i.setLogCmd("ig template "+s,!0)})),e.myEventCls.onIds("#"+e.pre+"mn6_alignrefTpl","click",(async function(t){e.icn3d,e.htmlCls.dialogCls.openDlg("dl_alignrefTpl","Align with an Ig template")})),e.myEventCls.onIds("#"+e.pre+"mn6_alignrefTpl_apply","click",(async function(t){let s=e.icn3d;e.cfg.notebook||dialog.dialog("close");let n=$("#"+e.pre+"refTpl2").val(),r=e.hashUtilsCls.cloneHash(s.hAtoms),a=e.htmlCls.baseUrl+"icn3d/refpdb/"+n+".pdb";await s.pdbParserCls.downloadUrl(a,"pdb",void 0,n),i.setLogCmd("load url "+a+" | type pdb",!0);let o=n.replace(/_/g,"").substr(0,4),l=s.structures[o][0];s.hAtoms=e.hashUtilsCls.unionHash(r,s.chains[l]),e.cfg.aligntool="tmalign",await s.realignParserCls.realignOnStructAlign(),i.setLogCmd("realign on tmalign",!0)})),e.myEventCls.onIds("#"+e.pre+"mn6_igrefNo","click",(async function(t){let s=e.icn3d;i.setLogCmd("ig refnum off",!0),await s.refnumCls.hideIgRefNum()})),e.myEventCls.onIds("#"+e.pre+"mn6_addlabelAtoms","click",(function(t){let s=e.icn3d;s.residueLabelsCls.addAtomLabels(s.hAtoms),s.selectionCls.saveSelectionIfSelected(),i.setLogCmd("add atom labels",!0),s.drawCls.draw()})),e.myEventCls.onIds("#"+e.pre+"mn6_addlabelElements","click",(function(t){let s=e.icn3d;s.residueLabelsCls.addAtomLabels(s.hAtoms,!0),s.selectionCls.saveSelectionIfSelected(),i.setLogCmd("add element labels",!0),s.drawCls.draw()})),e.myEventCls.onIds("#"+e.pre+"mn6_addlabelResidues","click",(function(t){let s=e.icn3d;s.residueLabelsCls.addResidueLabels(s.hAtoms),s.selectionCls.saveSelectionIfSelected(),i.setLogCmd("add residue labels",!0),s.drawCls.draw()})),e.myEventCls.onIds("#"+e.pre+"mn6_addlabelResnum","click",(function(t){let s=e.icn3d;s.residueLabelsCls.addResidueLabels(s.hAtoms,void 0,void 0,!0),s.selectionCls.saveSelectionIfSelected(),i.setLogCmd("add residue number labels",!0),s.drawCls.draw()})),e.myEventCls.onIds("#"+e.pre+"mn6_addlabelRefnum","click",(function(t){let s=e.icn3d;s.residueLabelsCls.addResidueLabels(s.hAtoms,void 0,void 0,void 0,!0),s.selectionCls.saveSelectionIfSelected(),i.setLogCmd("add reference number labels",!0),s.drawCls.draw()})),e.myEventCls.onIds("#"+e.pre+"mn6_addlabelIg","click",(function(t){let s=e.icn3d;s.residueLabelsCls.addIgLabels(s.hAtoms),s.selectionCls.saveSelectionIfSelected(),i.setLogCmd("add ig labels",!0),s.drawCls.draw()})),e.myEventCls.onIds("#"+e.pre+"mn6_addlabelChains","click",(function(t){let s=e.icn3d;s.analysisCls.addChainLabels(s.hAtoms),s.selectionCls.saveSelectionIfSelected(),i.setLogCmd("add chain labels",!0),s.drawCls.draw()})),e.myEventCls.onIds("#"+e.pre+"mn6_addlabelTermini","click",(function(t){let s=e.icn3d;s.analysisCls.addTerminiLabels(s.hAtoms),s.selectionCls.saveSelectionIfSelected(),i.setLogCmd("add terminal labels",!0),s.drawCls.draw()})),e.myEventCls.onIds("#"+e.pre+"mn6_addlabelYes","click",(function(t){let i=e.icn3d;e.htmlCls.dialogCls.openDlg("dl_addlabel","Add custom labels by selection"),i.pk=1,i.opts.pk="atom",i.pickpair=!0,i.pAtomNum=0})),e.myEventCls.onIds("#"+e.pre+"mn6_addlabelSelection","click",(function(t){e.icn3d,e.htmlCls.dialogCls.openDlg("dl_addlabelselection","Add custom labels by the selected")})),e.myEventCls.onIds("#"+e.pre+"mn6_labelColor","click",(function(t){e.icn3d,e.htmlCls.dialogCls.openDlg("dl_labelColor","Change color for all labels")})),e.myEventCls.onIds(["#"+e.pre+"mn2_saveselection","#"+e.pre+"tool_saveselection"],"click",(function(t){e.icn3d,e.htmlCls.dialogCls.openDlg("dl_saveselection","Save the selected")})),e.myEventCls.onIds(["#"+e.pre+"mn6_addlabelNo","#"+e.pre+"removeLabels"],"click",(function(t){let s=e.icn3d;s.labelcolor=void 0,s.pickpair=!1;i.setLogCmd("set labels off",!0);for(let e in s.labels)s.labels[e]=[];s.drawCls.draw()})),$(document).on("click","."+e.pre+"mn6_labelscale",(function(t){let s=e.icn3d,n=$(this).attr("v");s.labelScale=n,s.drawCls.draw(),i.setLogCmd("set label scale "+n,!0)})),e.myEventCls.onIds("#"+e.pre+"mn6_distanceYes","click",(function(t){let i=e.icn3d;e.htmlCls.dialogCls.openDlg("dl_distance","Measure the distance of atoms"),i.pk=1,i.opts.pk="atom",i.pickpair=!0,i.pAtomNum=0,i.bMeasureDistance=!0})),e.myEventCls.onIds("#"+e.pre+"mn6_distTwoSets","click",(function(t){let s=e.icn3d;e.htmlCls.dialogCls.openDlg("dl_disttwosets","Measure the distance between two sets"),i.setSetsMenus("atomsCustomDist"),s.bMeasureDistance=!0})),e.myEventCls.onIds("#"+e.pre+"mn6_distManySets","click",(function(t){let s=e.icn3d;e.htmlCls.dialogCls.openDlg("dl_distmanysets","Measure the pairwise distances among many sets"),i.setSetsMenus("atomsCustomDistTable"),s.bMeasureDistance=!0})),e.myEventCls.onIds("#"+e.pre+"mn6_angleManySets","click",(function(t){let s=e.icn3d;e.htmlCls.dialogCls.openDlg("dl_anglemanysets","Measure the pairwise angles among many sets"),i.setSetsMenus("atomsCustomAngleTable"),s.bMeasureAngle=!0})),e.myEventCls.onIds("#"+e.pre+"mn6_distanceNo","click",(function(t){let s=e.icn3d;s.pickpair=!1;i.setLogCmd("set lines off",!0),s.labels.distance=[],s.lines.distance=[],s.distPnts=[],s.pk=2,s.drawCls.draw()})),e.myEventCls.onIds("#"+e.pre+"mn5_cartoonshape","click",(function(t){let s=e.icn3d;e.htmlCls.dialogCls.openDlg("dl_cartoonshape","Draw cartoon for a set");i.setSetsMenus("cartoonshape",!0),s.bCartoonshape=!0})),e.myEventCls.onIds("#"+e.pre+"mn5_linebtwsets","click",(function(t){let s=e.icn3d;e.htmlCls.dialogCls.openDlg("dl_linebtwsets","Draw a line between two sets"),i.setSetsMenus("linebtwsets"),s.bLinebtwsets=!0})),e.myEventCls.onIds(["#"+e.pre+"mn2_selectedcenter","#"+e.pre+"zoomin_selection","#"+e.pre+"tool_selectedcenter"],"click",(function(t){let s=e.icn3d;s.transformCls.zoominSelection(),s.drawCls.draw(),i.setLogCmd("zoom selection",!0)})),e.myEventCls.onIds("#"+e.pre+"mn6_center","click",(function(t){let s=e.icn3d;s.applyCenterCls.centerSelection(),s.drawCls.draw(),i.setLogCmd("center selection",!0)})),e.myEventCls.onIds(["#"+e.pre+"mn6_resetOrientation","#"+e.pre+"resetOrientation","#"+e.pre+"tool_resetOrientation"],"click",(function(t){let s=e.icn3d;s.transformCls.resetOrientation(),s.drawCls.draw(),i.setLogCmd("reset orientation",!0)})),e.myEventCls.onIds(["#"+e.pre+"mn6_chemicalbindingshow","#"+e.pre+"chemicalbindingshow"],"click",(function(t){e.icn3d.setOptionCls.setOption("chemicalbinding","show"),i.setLogCmd("set chemicalbinding show",!0)})),e.myEventCls.onIds(["#"+e.pre+"mn6_chemicalbindinghide","#"+e.pre+"chemicalbindinghide"],"click",(function(t){e.icn3d.setOptionCls.setOption("chemicalbinding","hide"),i.setLogCmd("set chemicalbinding hide",!0)})),e.myEventCls.onIds("#"+e.pre+"mn6_sidebyside","click",(function(t){let s=e.icn3d;if(s.bInputfile)return void alert("Side-by-Side does NOT work when the input is from a local file.");let n=s.shareLinkCls.shareLinkUrl(void 0);n=n.replace(/icn3d\/full[_\d\.]*\.html\?/,"icn3d/full2.html?"),n=n.replace("icn3d/?","icn3d/full2.html?"),n+="&closepopup=1";let r=s.structures&&Object.keys(s.structures).length>0?"_blank":"_self";window.open(n,r),i.setLogCmd("side by side | "+n,!1)})),e.myEventCls.onIds("#"+e.pre+"mn6_stereoYes","click",(function(t){let s=e.icn3d;s.opts.effect="stereo",s.drawCls.draw(),i.setLogCmd("stereo on",!0)})),e.myEventCls.onIds("#"+e.pre+"mn6_stereoNo","click",(function(t){let s=e.icn3d;s.opts.effect="none",s.drawCls.draw(),i.setLogCmd("stereo off",!0)})),$(document).on("click","#"+e.pre+"mn2_translate",(function(t){e.icn3d,e.htmlCls.dialogCls.openDlg("dl_translate","Translate the X,Y,Z coordinates of the structure")})),$(document).on("click","#"+e.pre+"mn6_angleTwoSets",(function(t){e.icn3d,e.htmlCls.dialogCls.openDlg("dl_angle","Measure the angle between two vectors")})),$(document).on("click","#"+e.pre+"mn2_matrix",(function(t){e.icn3d,e.htmlCls.dialogCls.openDlg("dl_matrix","Apply matrix to the X,Y,Z coordinates of the structure")})),$(document).on("click","."+e.pre+"mn6_rotate",(function(t){let s=e.icn3d,n=$(this).attr("v").toLowerCase(),r=n.split(" ")[1];i.setLogCmd(n,!0),s.bStopRotate=!1,s.transformCls.rotateCount=0,s.transformCls.rotateCountMax=6e3,s.ROT_DIR=r,s.resizeCanvasCls.rotStruc(r)})),$(document).on("click","."+e.pre+"mn6_rotate90",(function(t){let s,n=e.icn3d,r=$(this).attr("v").toLowerCase(),a=r.split(" ")[1];i.setLogCmd(r,!0),"x"==a?s=new mt(1,0,0):"y"==a?s=new mt(0,1,0):"z"==a&&(s=new mt(0,0,1));let o=.5*Math.PI;n.transformCls.setRotation(s,o)})),e.myEventCls.onIds("#"+e.pre+"mn6_cameraPers","click",(function(t){e.icn3d.setOptionCls.setOption("camera","perspective"),i.setLogCmd("set camera perspective",!0)})),e.myEventCls.onIds("#"+e.pre+"mn6_cameraOrth","click",(function(t){e.icn3d.setOptionCls.setOption("camera","orthographic"),i.setLogCmd("set camera orthographic",!0)})),e.myEventCls.onIds("#"+e.pre+"mn6_bkgdBlack","click",(function(t){e.icn3d.setStyleCls.setBackground("black")})),e.myEventCls.onIds("#"+e.pre+"tool_bkgd","click",(function(t){let i=e.icn3d;"black"==i.opts.background?i.setStyleCls.setBackground("white"):i.setStyleCls.setBackground("black")})),e.myEventCls.onIds("#"+e.pre+"mn6_bkgdGrey","click",(function(t){e.icn3d.setStyleCls.setBackground("grey")})),e.myEventCls.onIds(["#"+e.pre+"mn6_bkgdWhite","#"+e.pre+"tool_bkgdWhite"],"click",(function(t){e.icn3d.setStyleCls.setBackground("white")})),e.myEventCls.onIds("#"+e.pre+"mn6_bkgdTransparent","click",(function(t){e.icn3d.setStyleCls.setBackground("transparent")})),e.myEventCls.onIds("#"+e.pre+"mn6_showfogYes","click",(function(t){let s=e.icn3d;s.opts.fog="yes",s.fogCls.setFog(!0),s.drawCls.draw(),i.setLogCmd("set fog on",!0)})),e.myEventCls.onIds("#"+e.pre+"mn6_showfogNo","click",(function(t){let s=e.icn3d;s.opts.fog="no",s.fogCls.setFog(!0),s.drawCls.draw(),i.setLogCmd("set fog off",!0)})),e.myEventCls.onIds("#"+e.pre+"mn6_showslabYes","click",(function(t){e.icn3d.setOptionCls.setOption("slab","yes"),i.setLogCmd("set slab on",!0)})),e.myEventCls.onIds("#"+e.pre+"mn6_showslabNo","click",(function(t){e.icn3d.setOptionCls.setOption("slab","no"),i.setLogCmd("set slab off",!0)})),e.myEventCls.onIds("#"+e.pre+"mn6_showaxisYes","click",(function(t){e.icn3d.setOptionCls.setOption("axis","yes"),i.setLogCmd("set axis on",!0)})),e.myEventCls.onIds("#"+e.pre+"mn6_showaxisSel","click",(function(t){let s=e.icn3d;s.pc1=!0,s.axesCls.setPc1Axes(),i.setLogCmd("set pc1 axis",!0)})),e.myEventCls.onIds("#"+e.pre+"mn6_showaxisNo","click",(function(t){let s=e.icn3d;s.pc1=!1,s.axes=[],s.setOptionCls.setOption("axis","no"),i.setLogCmd("set axis off",!0)})),e.myEventCls.onIds("#"+e.pre+"mn6_symmetry","click",(async function(t){let i=e.icn3d;i.bAxisOnly=!1,await i.symdCls.retrieveSymmetry(Object.keys(i.structures)[0])})),e.myEventCls.onIds("#"+e.pre+"mn6_symd","click",(async function(t){let s=e.icn3d;s.bAxisOnly=!1,await s.symdCls.retrieveSymd(),s.bSymd=!0,i.setLogCmd("symd symmetry",!0)})),e.myEventCls.onIds("#"+e.pre+"mn6_clear_sym","click",(function(t){let s=e.icn3d;s.symdArray=[],s.drawCls.draw(),i.setLogCmd("clear symd symmetry",!0)})),e.myEventCls.onIds("#"+e.pre+"mn6_axes_only","click",(function(t){let s=e.icn3d;s.bAxisOnly=!0,s.drawCls.draw(),i.setLogCmd("show axis",!0)})),e.myEventCls.onIds("#"+e.pre+"mn6_area","click",(function(t){e.icn3d.analysisCls.calculateArea(),i.setLogCmd("area",!0)})),e.myEventCls.onIds("#"+e.pre+"applysymmetry","click",(function(t){let s=e.icn3d;s.bAxisOnly=!1;let n=$("#"+e.pre+"selectSymmetry").val();s.symmetrytitle="none"===n?void 0:n,s.drawCls.draw(),i.setLogCmd("symmetry "+n,!0)})),e.myEventCls.onIds("#"+e.pre+"clearsymmetry","click",(function(t){let s=e.icn3d;s.symmetrytitle=void 0,s.drawCls.draw(),i.setLogCmd("symmetry none",!0)})),e.myEventCls.onIds(["#"+e.pre+"mn6_hbondsYes","#"+e.pre+"hbondsYes"],"click",(function(t){let s=e.icn3d;i.SetChainsAdvancedMenu();let n=s.definedSetsCls.setAtomMenu(["protein"]);$("#"+e.pre+"atomsCustomHbond").length&&$("#"+e.pre+"atomsCustomHbond").html("  <option value='non-selected' selected>non-selected</option><option value='selected'>selected</option>"+n),$("#"+e.pre+"atomsCustomHbond2").length&&$("#"+e.pre+"atomsCustomHbond2").html("  <option value='selected' selected>selected</option>"+n),e.htmlCls.dialogCls.openDlg("dl_hbonds","Hydrogen bonds/interactions between two sets of atoms"),s.bHbondCalc=!1,$("#"+e.pre+"atomsCustomHbond").resizable(),$("#"+e.pre+"atomsCustomHbond2").resizable()})),e.myEventCls.onIds(["#"+e.pre+"mn6_contactmap"],"click",(function(t){e.icn3d,e.htmlCls.dialogCls.openDlg("dl_contact","Set contact map")})),e.myEventCls.onIds(["#"+e.pre+"mn6_DSSP"],"click",(async function(t){let s=e.icn3d;i.setLogCmd("set dssp sse",!0),await s.pdbParserCls.applyCommandDssp(),s.bResetAnno=!0,s.bAnnoShown&&(await s.showAnnoCls.showAnnotations(),s.annotationCls.resetAnnoTabAll())})),e.myEventCls.onIds("#"+e.pre+"mn6_hbondsNo","click",(function(t){let i=e.icn3d;i.showInterCls.hideHbondsContacts(),i.drawCls.draw()})),e.myEventCls.onIds("#"+e.pre+"mn1_stabilizerYes","click",(function(t){let s=e.icn3d;s.threeDPrintCls.addStabilizer(),s.threeDPrintCls.prepareFor3Dprint(),i.setLogCmd("stabilizer",!0)})),e.myEventCls.onIds("#"+e.pre+"mn1_stabilizerNo","click",(function(t){let s=e.icn3d;i.setLogCmd("set stabilizer off",!0),s.threeDPrintCls.hideStabilizer(),s.drawCls.draw()})),e.myEventCls.onIds("#"+e.pre+"mn1_stabilizerOne","click",(function(t){let i=e.icn3d;e.htmlCls.dialogCls.openDlg("dl_stabilizer","Add One Stabilizer"),i.pk=1,i.opts.pk="atom",i.pickpair=!0,i.pAtomNum=0})),e.myEventCls.onIds("#"+e.pre+"mn1_stabilizerRmOne","click",(function(t){let i=e.icn3d;e.htmlCls.dialogCls.openDlg("dl_stabilizer_rm","Remove One Stabilizer"),i.pk=1,i.opts.pk="atom",i.pickpair=!0,i.pAtomNum=0})),e.myEventCls.onIds("#"+e.pre+"mn1_thicknessSet","click",(function(t){e.icn3d,e.htmlCls.dialogCls.openDlg("dl_thickness","Set Thickness for 3D Printing")})),e.myEventCls.onIds("#"+e.pre+"mn3_setThickness","click",(function(t){e.icn3d,e.htmlCls.dialogCls.openDlg("dl_thickness2","Style Preferences")})),e.myEventCls.onIds("#"+e.pre+"mn6_ssbondsYes","click",(function(t){let s=e.icn3d;i.setLogCmd("disulfide bonds",!0),s.showInterCls.showSsbonds()})),e.myEventCls.onIds("#"+e.pre+"mn6_ssbondsExport","click",(function(t){e.icn3d.viewInterPairsCls.exportSsbondPairs(),i.setLogCmd("export disulfide bond pairs",!1)})),e.myEventCls.onIds("#"+e.pre+"mn6_ssbondsNo","click",(function(t){let s=e.icn3d;s.opts.ssbonds="no";i.setLogCmd("set disulfide bonds off",!0),s.lines.ssbond=[],s.setOptionCls.setStyle("sidec","nothing")})),e.myEventCls.onIds("#"+e.pre+"mn6_clbondsYes","click",(function(t){let s=e.icn3d;i.setLogCmd("cross linkage",!0),s.showInterCls.showClbonds()})),e.myEventCls.onIds("#"+e.pre+"mn6_clbondsExport","click",(function(t){e.icn3d.viewInterPairsCls.exportClbondPairs(),i.setLogCmd("export cross linkage pairs",!1)})),e.myEventCls.onIds("#"+e.pre+"mn6_clbondsNo","click",(function(t){let s=e.icn3d;s.opts.clbonds="no";i.setLogCmd("set cross linkage off",!0),s.lines.clbond=[],s.setOptionCls.setStyle("sidec","nothing")})),$("#"+e.pre+"newvs2").on("submit",(function(){let i=t.saveFileCls.getAtomPDB(t.hAtoms,void 0,void 0,void 0,void 0,void 0,void 0,!0);return $("#"+e.pre+"pdbstr").val(i),!0})),$("#"+e.pre+"fssubmit").on("click",(function(){let e=t.saveFileCls.getAtomPDB(t.hAtoms),i=window.open("","_blank");i.document.body.innerHTML="<!doctype html>\n<head>\n<title>Loading Foldseek</title>\n<style>\n  body {\n    background-color: #121212;\n    color: #fff;\n    font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;\n    height: 100vh;\n    display: flex;\n    flex-direction: column;\n    flex-wrap: wrap;\n    justify-content: center;\n    align-items: center;\n  }\n  .loader {\n    display: block;\n    width: 80px;\n    height: 80px;\n  }\n  .loader:after {\n    content: \" \";\n    display: block;\n    width: 64px;\n    height: 64px;\n    margin: 8px;\n    border-radius: 50%;\n    border: 6px solid #fff;\n    border-color: #fff transparent #fff transparent;\n    animation: loader 1.2s linear infinite;\n  }\n  @keyframes loader {\n    0% {\n      transform: rotate(0deg);\n    }\n    100% {\n      transform: rotate(360deg);\n    }\n  }\n</style>\n</head>\n<body>\n<div>Foldseek is loading...</div><div class=\"loader\"></div>\n</body>",$.ajax({url:"https://search.foldseek.com/api/ticket",type:"POST",data:{q:e,database:["afdb50","afdb-swissprot","gmgcl_id","pdb100","afdb-proteome","mgnify_esm30"],mode:"3diaa"},dataType:"text",success:function(e){i.location="https://search.foldseek.com/queue/"+JSON.parse(e).id},error:function(e,t,i){console.log("Error in submitting data to Foldseek...")}})})),e.myEventCls.onIds("#"+e.pre+"jn_copy","click",(function(t){e.icn3d;let i=$("#"+e.pre+"jn_commands").val();navigator.clipboard.writeText(i)}))}setLogCmd(e,t,i){var s=this.icn3dui,n=s.icn3d;if(""===e.trim())return!1;let r=e.indexOf("|||");-1!==r&&(e=e.substr(0,r));let a={};if(n.quaternion||(n._zoomFactor=1,n.mouseChange=new pt(0,0),n.quaternion=new ut(0,0,0,1)),a.factor=n._zoomFactor,a.mouseChange=n.mouseChange,a.quaternion={},a.quaternion._x=parseFloat(n.quaternion._x).toPrecision(5),a.quaternion._y=parseFloat(n.quaternion._y).toPrecision(5),a.quaternion._z=parseFloat(n.quaternion._z).toPrecision(5),a.quaternion._w=parseFloat(n.quaternion._w).toPrecision(5),t&&n.bAddCommands)if(n.STATENUMBER<n.commands.length){let t=n.commands[n.STATENUMBER-1],i=t.indexOf("|||");-1!=i&&e!==t.substr(0,i)&&(n.commands=n.commands.slice(0,n.STATENUMBER),n.commands.push(e+"|||"+n.transformCls.getTransformationStr(a)),n.optsHistory.push(s.hashUtilsCls.cloneHash(n.opts)),n.optsHistory[n.optsHistory.length-1].hlatomcount=Object.keys(n.hAtoms).length,s.utilsCls.isSessionStorageSupported()&&n.setStyleCls.saveCommandsToSession(),n.STATENUMBER=n.commands.length)}else n.commands.push(e+"|||"+n.transformCls.getTransformationStr(a)),n.optsHistory.push(s.hashUtilsCls.cloneHash(n.opts)),void 0!==n.hAtoms&&(n.optsHistory[n.optsHistory.length-1].hlatomcount=Object.keys(n.hAtoms).length),s.utilsCls.isSessionStorageSupported()&&n.setStyleCls.saveCommandsToSession(),n.STATENUMBER=n.commands.length;if((n.bAddLogs||i)&&s.cfg.showcommand){let i=t?e:"[comment] "+e;n.logs.push(i),$("#"+s.pre+"logtext").val("> "+n.logs.join("\n> ")+"\n> "),$("#"+s.pre+"logtext")[0]&&$("#"+s.pre+"logtext").scrollTop($("#"+s.pre+"logtext")[0].scrollHeight)}n.setStyleCls.adjustIcon()}}class ql{constructor(e){this.icn3dui=e}getLink(e,t,i,s){return this.icn3dui.htmlCls.setHtmlCls.getLink(e,t,i,s)}getMenuText(e,t,i,s,n){return this.icn3dui.htmlCls.setHtmlCls.getMenuText(e,t,i,s,n)}getMenuUrl(e,t,i,s,n){return this.icn3dui.htmlCls.setHtmlCls.getMenuUrl(e,t,i,s,n)}getMenuSep(){return this.icn3dui.htmlCls.setHtmlCls.getMenuSep()}getLinkWrapper(e,t,i,s,n,r){let a=this.icn3dui;return a.icn3d,a.htmlCls.setHtmlCls.getLinkWrapper(e,t,i,s,n,r)}getLinkWrapper2(e,t,i,s,n){let r=this.icn3dui;return r.icn3d,r.htmlCls.setHtmlCls.getLinkWrapper2(e,t,i,s,n)}getRadio(e,t,i,s,n,r){return this.icn3dui.htmlCls.setHtmlCls.getRadio(e,t,i,s,n,r)}getRadClr(e,t,i,s,n,r,a){return this.icn3dui.htmlCls.setHtmlCls.getRadioColor(e,t,i,s,n,r,a)}resetMenu(e){let t=this.icn3dui;e&&"simple"!=e?"all"==e?(t.htmlCls.shownMenus=t.hashUtilsCls.cloneHash(t.htmlCls.allMenus),t.htmlCls.clickMenuCls.applyShownMenus()):"custom"==e&&(t.htmlCls.dialogCls.openDlg("dl_menupref","Select Menus"),t.htmlCls.clickMenuCls.getHiddenMenusFromCache(),t.htmlCls.clickMenuCls.displayShownMenus()):(t.htmlCls.shownMenus=t.hashUtilsCls.cloneHash(t.htmlCls.simpleMenus),t.htmlCls.clickMenuCls.applyShownMenus())}setMenuMode(e){let t=this.icn3dui,i=e?"; padding-left:6px; background-color:#eee":"; margin:3px; background-color:white",s=e?"; font-size:14px!important":"",n=t.htmlCls.setHtmlCls.getCookie("menumode"),r='<div class="icn3d-text" style="color:#f8b84e; font-weight:bold'+i+'">';return r+='<select name="menumode" id="'+t.pre+'menumode" class="icn3d-text" style="color:#f8b84e; font-weight:bold; border:0px'+s+'">',r+="simple"!=n&&n?'<option value="simple">Simple</option>':'<option value="simple" selected>Simple</option>',r+="all"==n?'<option value="all" selected>All</option>':'<option value="all">All</option>',r+="custom"==n?'<option value="custom" selected>Custom</option>':'<option value="custom">Custom</option>',r+="</select>",r+=e?'<br><span style="font-size:12px">&nbsp;Menus</span>':"&nbsp;Menus",r+="</div>",r}setTopMenusHtml(e,t,i){let s=this.icn3dui;if(s.bNode)return"";let n="black"==s.htmlCls.opts.background?s.htmlCls.GREYD:"black",r="";r+="<div style='position:relative;'>",r+=s.htmlCls.divStr+"popup' class='icn3d-text icn3d-popup'></div>",r+=this.setReplayHtml(),r+="\x3c!--https://forum.jquery.com/topic/looking-for-a-jquery-horizontal-menu-bar--\x3e",r+=s.htmlCls.divStr+"mnlist' style='position:absolute; z-index:999; float:left; display:table-row; margin-top: -2px;'>",r+="<table border='0' cellpadding='0' cellspacing='0' width='100'><tr>";let a='<td valign="top">';r+=a+this.setMenuMode()+"</td>",r+=a+this.setMenu1()+"</td>",r+=a+this.setMenu2()+"</td>",r+=a+this.setMenu2b()+"</td>",r+=a+this.setMenu3()+"</td>",r+=a+this.setMenu4()+"</td>",r+=a+this.setMenu5()+"</td>",r+=a+this.setMenu6()+"</td>";let o=s.htmlCls.setHtmlCls.getCookie("menumode");if(this.resetMenu(o),r+=a+"<div style='position:relative; margin-left:6px;'>"+t,r+="<div class='icn3d-commandTitle' style='min-width:40px; margin-top: 3px; white-space: nowrap;'>"+i,r+=a+'<div class="icn3d-commandTitle" style="white-space:nowrap; margin-top:10px; border-left:solid 1px #888888"><span id="'+s.pre+'selection_expand" class="icn3d-expand icn3d-link" style="display:block;" title="Expand">'+s.htmlCls.space2+'Toolbar <span class="ui-icon ui-icon-plus" style="width:15px"></span>'+s.htmlCls.space2+'</span><span id="'+s.pre+'selection_shrink" class="icn3d-shrink icn3d-link" style="display:none;" title="Shrink">'+s.htmlCls.space2+'Toolbar <span class="ui-icon ui-icon-minus" style="width:15px"></span>'+s.htmlCls.space2+"</span></div></td>",r+=a+'<div class="icn3d-commandTitle" style="white-space:nowrap; margin-top:8px; border-left:solid 1px #888888">'+s.htmlCls.space2+'<input type="text" id="'+s.pre+'search_seq" size="10" placeholder="one-letter seq."> <button style="white-space:nowrap;" id="'+s.pre+'search_seq_button">Search</button> <a style="text-decoration: none;" href="'+s.htmlCls.baseUrl+'icn3d/icn3d.html#selectb" target="_blank" title="Specification tips">?</a></div></td>',r+="</tr>",r+="</table>",r+="</div>",r+=this.setTools(),r+=s.htmlCls.divStr+"title' class='icn3d-commandTitle' style='font-size:1.2em; font-weight:normal; position:absolute; z-index:1; float:left; display:table-row; margin: 85px 0px 0px 5px; color:"+n+"; width:"+s.htmlCls.WIDTH+"px'></div>",r+=s.htmlCls.divStr+"viewer' style='position:relative; width:100%; height:100%; background-color: "+s.htmlCls.GREYD+";'>",r+=s.htmlCls.divStr+"mnLogSection'>",r+="<div style='height: "+s.htmlCls.MENU_HEIGHT+"px;'></div>",r+=" </div>",void 0===s.cfg.mmtfid){let e="top:180px; font-size: 1.8em;";r+=s.htmlCls.divStr+"wait' style='position:absolute; left:50px; "+e+" color: #444444;'>Loading data...</div>"}r+="<canvas id='"+s.pre+"canvas' style='width:100%; height: 100%; background-color: #FFF;'>Your browser does not support WebGL.</canvas>",(void 0===s.cfg.showcommand||s.cfg.showcommand)&&(r+=this.setLogWindow()),r+="</div>",r+="</div>",r+=s.htmlCls.setDialogCls.setDialogs(),r+=s.htmlCls.setDialogCls.setCustomDialogs(),$("#"+e).html(r),$("accordion").accordion({collapsible:!0,active:!1,heightStyle:"content"}),$("accordion div").removeClass("ui-accordion-content ui-corner-all ui-corner-bottom ui-widget-content"),$(".icn3d-mn-item").menu({position:{my:"left top",at:"right top"}}),$(".icn3d-mn-item").hover((function(){}),(function(){$("accordion").accordion("option","active","none")})),$("#"+s.pre+"accordion1").hover((function(){$("#"+s.pre+"accordion1 div").css("display","block")}),(function(){$("#"+s.pre+"accordion1 div").css("display","none")})),$("#"+s.pre+"accordion2").hover((function(){$("#"+s.pre+"accordion2 div").css("display","block")}),(function(){$("#"+s.pre+"accordion2 div").css("display","none")})),$("#"+s.pre+"accordion2b").hover((function(){$("#"+s.pre+"accordion2b div").css("display","block")}),(function(){$("#"+s.pre+"accordion2b div").css("display","none")})),$("#"+s.pre+"accordion3").hover((function(){$("#"+s.pre+"accordion3 div").css("display","block")}),(function(){$("#"+s.pre+"accordion3 div").css("display","none")})),$("#"+s.pre+"accordion4").hover((function(){$("#"+s.pre+"accordion4 div").css("display","block")}),(function(){$("#"+s.pre+"accordion4 div").css("display","none")})),$("#"+s.pre+"accordion5").hover((function(){$("#"+s.pre+"accordion5 div").css("display","block")}),(function(){$("#"+s.pre+"accordion5 div").css("display","none")})),$("#"+s.pre+"accordion6").hover((function(){$("#"+s.pre+"accordion6 div").css("display","block")}),(function(){$("#"+s.pre+"accordion6 div").css("display","none")}))}setTopMenusHtmlMobile(e,t,i){let s=this.icn3dui;if(s.bNode)return"";let n="black"==s.htmlCls.opts.background?s.htmlCls.GREYD:"black",r="";if(r+="<div style='position:relative;'>",r+=s.htmlCls.divStr+"popup' class='icn3d-text icn3d-popup'></div>",r+=this.setReplayHtml(),!s.utilsCls.isMobile()){let e=s.htmlCls.WIDTH-40+5;r+=s.htmlCls.buttonStr+"fullscreen' style='position:absolute; z-index:1999; display:block; padding:0px; margin: 12px 0px 0px "+e+"px; width:30px; height:34px; border-radius:4px; border:none; background-color:#f6f6f6;' title='Full screen'>",r+="<svg fill='#1c94c4' viewBox='0 0 24 24' width='24' height='24'>",r+="<path d='M0 0h24v24H0z' fill='none'></path>",r+="<path d='M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z'></path>",r+="</svg>",r+="</button>"}r+="\x3c!--https://forum.jquery.com/topic/looking-for-a-jquery-horizontal-menu-bar--\x3e",r+=s.htmlCls.divStr+"mnlist' style='position:absolute; z-index:999; float:left; display:block; margin: 5px 0px 0px 5px;'>",r+="<div>",r+="<accordion id='"+s.pre+"accordion0' class='icn3d-accordion'>",s.cfg.notebook?r+="<h3 style='width:20px; height:24px; position:relative; padding: 0'><span style='position:absolute; left:3px; top:4px;'>&#9776;</span></h3>":r+="<h3 style='width:30px; height:34px; position:relative; padding: 0; margin-top:7px!important; background-color:#f6f6f6;'><span style='position:absolute; left:7px; top:8px;'>&#9776;</span></h3>",r+="<div>",r+="<li>"+this.setMenuMode(!0);let a="<li><span class='icn3d-menu-color'";r+="<ul class='icn3d-mn-item'>",r+=a+">File</span>",r+=this.setMenu1_base(),r+=a+">Select</span>",r+=this.setMenu2_base(),r+=a+">View</span>",r+=this.setMenu2b_base(),r+=a+" id='"+s.pre+"style'>Style</span>",r+=this.setMenu3_base(),r+=a+" id='"+s.pre+"color'>Color</span>",r+=this.setMenu4_base(),r+=a+">Analysis</span>",r+=this.setMenu5_base(),r+=a+">Help</span>",r+=this.setMenu6_base();let o=s.htmlCls.setHtmlCls.getCookie("menumode");if(this.resetMenu(o),r+="<li><div style='position:relative; margin-top:-6px;'>"+t,r+="<div class='icn3d-commandTitle' style='margin-top: 3px; white-space: nowrap;'>"+i,r+="<li><span id='"+s.pre+"alternate2' class='icn3d-menu-color' title='Alternate the structures'>Alternate</span>",r+="</ul>",r+="</div>",r+="</accordion>",r+="</div>",r+="</div>",r+=s.htmlCls.divStr+"title' class='icn3d-commandTitle' style='font-size:1.2em; font-weight:normal; position:absolute; z-index:1; float:left; display:block; margin: 12px 0px 0px 40px; color:"+n+"; width:"+(s.htmlCls.WIDTH-40).toString()+"px'></div>",r+=s.htmlCls.divStr+"viewer' style='position:relative; width:100%; height:100%; background-color: "+s.htmlCls.GREYD+";'>",r+=s.htmlCls.divStr+"mnLogSection'>",r+="<div style='height: "+s.htmlCls.MENU_HEIGHT+"px;'></div>",r+="</div>",void 0===s.cfg.mmtfid){let e="top:180px; font-size: 1.8em;";r+=s.htmlCls.divStr+"wait' style='position:absolute; left:50px; "+e+" color: #444444;'>Loading data...</div>"}r+="<canvas id='"+s.pre+"canvas' style='width:100%; height: 100%; background-color: #FFF;'>Your browser does not support WebGL.</canvas>",(void 0===s.cfg.showcommand||s.cfg.showcommand)&&(r+=this.setLogWindow()),r+="</div>",r+="</div>",r+=s.htmlCls.setDialogCls.setDialogs(),r+=s.htmlCls.setDialogCls.setCustomDialogs(),$("#"+e).html(r),$("accordion").accordion({collapsible:!0,active:!1,heightStyle:"content"}),$("accordion div").removeClass("ui-accordion-content ui-corner-all ui-corner-bottom ui-widget-content"),$(".icn3d-mn-item").menu({position:{my:"left top",at:"right top"}}),$(".icn3d-mn-item").hover((function(){}),(function(){$("accordion").accordion("option","active","none")})),$("#"+s.pre+"accordion0").hover((function(){$("#"+s.pre+"accordion0 div").css("display","block")}),(function(){$("#"+s.pre+"accordion0 div").css("display","none")}))}setReplayHtml(e){let t=this.icn3dui;if(t.bNode)return"";let i="";return i+=t.htmlCls.divStr+"replay' style='display:none; position:absolute; z-index:9999; top:"+parseInt(t.htmlCls.HEIGHT-100).toString()+"px; left:20px;'>",i+="<div title='Click to replay one step'><svg style='cursor:pointer;' fill='#f8b84e' viewBox='0 0 60 60' width='40' height='40'>",i+='<circle style="fill:#f8b84e;" cx="29" cy="29" r="29"/>',i+="<g>",i+='<polygon style="fill:#FFFFFF;" points="44,29 22,44 22,29.273 22,14"/>',i+='<path style="fill:#FFFFFF;" d="M22,45c-0.16,0-0.321-0.038-0.467-0.116C21.205,44.711,21,44.371,21,44V14c0-0.371,0.205-0.711,0.533-0.884c0.328-0.174,0.724-0.15,1.031,0.058l22,15C44.836,28.36,45,28.669,45,29s-0.164,0.64-0.437,0.826l-22,15C22.394,44.941,22.197,45,22,45z M23,15.893v26.215L42.225,29L23,15.893z"/>',i+="</g>",i+="</svg></div>",i+=t.htmlCls.divStr+"replay_menu' style='background-color:#DDDDDD; padding:3px; font-weight:bold;'></div>",i+=t.htmlCls.divStr+"replay_cmd' style='background-color:#DDDDDD; padding:3px; max-width:250px'></div>",i+="</div>",i}setTools(){let e=this.icn3dui;if(e.bNode)return"";let t="";return t+=e.htmlCls.divStr+"selection' style='display:none;'><div style='position:absolute; z-index:555; float:left; display:table-row; margin: 32px 0px 0px 0px;'>",t+="<table style='margin: 3px 0px 0px 76px; width:770px; background-color:#EEE;'>",t+=this.setTools_base(),t+="</table>",t+="</div></div>",t}setButton(e,t,i,s,n){let r=this.icn3dui;return r.bNode?"":(n=void 0!==n?"color:"+n:"","<div style='margin:3px 0px 0px 10px;'><button style='-webkit-appearance:"+e+"; height:36px;"+(r.utilsCls.isMobile()?" background-color:#DDDDDD;":"")+"' id='"+r.pre+t+"'><span style='white-space:nowrap;"+n+"' class='icn3d-commandTitle' title='"+i+"'>"+s+"</span></button></div>")}setIcon(e,t,i,s,n,r,a){let o=this.icn3dui;if(o.bNode)return"";let l,d=a?"color:#f8b84e; ":"color:#1c94c4; ",c=" background-color:#EEE; ",h="text"==e?"":"cursor:pointer;";return l=r?'<div id="'+o.pre+t+'" title="'+i+'" style="font-family: Arial, Helvetica, sans-serif; font-size:16px; width:16px; height:16px;'+d+c+h+'">'+s+"</div>":'<i id="'+o.pre+t+'" class="las la-'+s+'" title="'+i+'" style="width:16px; height:16px;'+d+c+h+'"></i>',"link"==e?'<a href="'+n+'" target="_blank">'+l+"</a>":l}setTools_base(){if(this.icn3dui.bNode)return"";let e="<tr valign='center'>",t="regular",i="<td valign='top' align='center'>",s="<td valign='top' align='center' style='border-left: solid 1px #888888'>";return e+=i+this.setIcon(t,"tool_mmdbafid","Input PDB/MMDB/AlphaFold IDs","id",void 0,!0)+"</td>",e+=i+this.setIcon(t,"tool_pdbfile","Input PDB Files (appendable)","file-alt")+"</td>",e+=i+this.setIcon(t,"tool_sharelink","Get Share Link","link")+"</td>",e+=i+this.setIcon(t,"saveimage","Save iCn3D PNG Image","camera")+"</td>",e+=s+this.setIcon(t,"tool_definedsets","Defined Sets","object-group")+"</td>",e+=i+this.setIcon(t,"tool_aroundsphere","Select by Distance","dot-circle")+"</td>",e+=i+this.setIcon(t,"tool_saveselection","Save Selection as a Set","save")+"</td>",e+=i+this.setIcon(t,"toggleHighlight","Toggle Highlight","highlighter")+"</td>",e+=s+this.setIcon(t,"show_selected","View Selection","eye")+"</td>",e+=i+this.setIcon(t,"tool_selectedcenter","Zoom in Selection","search-plus")+"</td>",e+=i+this.setIcon(t,"alternate","Alternate the Structures by keying the letter 'a'","a",void 0,!0,!0)+"</td>",e+=i+this.setIcon(t,"tool_resetOrientation","Reset Orientation","undo-alt")+"</td>",e+=s+this.setIcon(t,"tool_proteinsRibbon","Style Ribbon for proteins","dna")+"</td>",e+=i+this.setIcon(t,"tool_proteinsSphere","Style Sphere for proteins","volleyball-ball")+"</td>",e+=i+this.setIcon(t,"tool_surfaceVDW","Show Van der Waals Surface","cloud")+"</td>",e+=i+this.setIcon(t,"tool_bkgd","Toggle Background Color","adjust")+"</td>",e+=s+this.setIcon(t,"tool_clrRainbowChain","Color Rainbow for Chains","rainbow")+"</td>",e+=i+this.setIcon(t,"tool_clrSSGreen","Color by Secondary Structures","ring")+"</td>",e+=i+this.setIcon(t,"tool_clrChain","Color by Chains","layer-group")+"</td>",e+=i+this.setIcon(t,"tool_clrAtom","Color by Atoms","atom")+"</td>",e+=s+this.setIcon(t,"tool_selectannotations","Sequences & Annotations","grip-lines")+"</td>",e+=i+this.setIcon(t,"hbondsYes","Interactions","users")+"</td>",e+=i+this.setIcon(t,"tool_delphi","DelPhi Potentials","cloud-meatball")+"</td>",e+=i+this.setIcon(t,"removeLabels","Remove Labels","remove-format")+"</td>",e+=s+this.setIcon("link","tool-gallery","Gallery","image","https://www.ncbi.nlm.nih.gov/Structure/icn3d/icn3d.html#gallery")+"</td>",e+=i+this.setIcon("link","tool-video","Videos","file-video","https://www.ncbi.nlm.nih.gov/Structure/icn3d/icn3d.html#videos")+"</td>",e+=i+this.setIcon("link","tool-github","iCn3D GitHub","code","https://github.com/ncbi/icn3d")+"</td>",e+=i+this.setIcon("link","tool-hints","Transform Hints","info-circle","https://www.ncbi.nlm.nih.gov/Structure/icn3d/icn3d.html#useicn3d")+"</td>",e+="</tr>",e}setTheme(e){let t,i,s,n,r,a=this.icn3dui;if(a.bNode)return"";a.htmlCls.themecolor=e,"orange"==e?(t="#e78f08",i="#f6a828",s="ui-bg_gloss-wave_35_f6a828_500x100.png",n="ui-icons_ef8c08_256x240.png",r="#eb8f00"):"black"==e?(t="#333333",i="#333333",s="ui-bg_gloss-wave_25_333333_500x100.png",n="ui-icons_222222_256x240.png",r="#222222"):"blue"==e&&(t="#4297d7",i="#5c9ccc",s="ui-bg_gloss-wave_55_5c9ccc_500x100.png",n="ui-icons_228ef1_256x240.png",r="#444"),$(".ui-widget-header").css({border:"1px solid "+t,background:i+' url("https://www.ncbi.nlm.nih.gov/Structure/icn3d/lib/images/'+s+'") 50% 50% repeat-x',color:"#fff","font-weight":"bold"}),$(".ui-button .ui-icon").css({"background-image":"url(https://www.ncbi.nlm.nih.gov/Structure/icn3d/lib/images/"+n+")"}),$(".ui-state-active a, .ui-state-active a:link, .ui-state-active a:visited").css({color:r,"text-decoration":"none"})}setLogWindow(e,t){let i=this.icn3dui;if(i.bNode)return"";let s,n="",r=i.htmlCls.setHtmlCls.getCookie("cmdwindow");return""!=r?(s=void 0!==t?t:parseInt(r),1==s?(i.htmlCls.LOG_HEIGHT=180,i.htmlCls.CMD_HEIGHT=.8*i.htmlCls.LOG_HEIGHT,e||(n+=i.htmlCls.divStr+"cmdlog' style='float:left; margin-top: 5px; width: 100%;'>"),n+="<textarea id='"+i.pre+"logtext' rows='2' style='width: 100%; height: "+i.htmlCls.CMD_HEIGHT+"px;  margin: auto; padding: 5px; box-sizing: border-box; border: 4px inset orange; background-color: "+i.htmlCls.GREYD+";'></textarea>"):(i.htmlCls.LOG_HEIGHT=65,i.htmlCls.CMD_HEIGHT=.8*i.htmlCls.LOG_HEIGHT,e||(n+=i.htmlCls.divStr+"cmdlog' style='float:left; margin-top: 5px; width: 100%;'>"),n+="<textarea id='"+i.pre+"logtext' rows='2' style='width: 100%; height: "+i.htmlCls.CMD_HEIGHT+"px; padding: 0px; border: 0px; background-color: "+i.htmlCls.GREYD+";'></textarea>")):(s=0,i.htmlCls.LOG_HEIGHT=65,i.htmlCls.CMD_HEIGHT=.8*i.htmlCls.LOG_HEIGHT,e||(n+=i.htmlCls.divStr+"cmdlog' style='float:left; margin-top: 5px; width: 100%;'>"),n+="<textarea id='"+i.pre+"logtext' rows='2' style='width: 100%; height: "+i.htmlCls.CMD_HEIGHT+"px; padding: 0px; border: 0px; background-color: "+i.htmlCls.GREYD+";'></textarea>"),e||(n+="</div>"),e&&(i.htmlCls.clickMenuCls.setLogCmd("set cmdwindow "+s,!0),$("#"+i.pre+"cmdlog").html(n)),n}setMenu1(){let e=this.icn3dui;if(e.bNode)return"";let t="";return t+="<div class='icn3d-menu'>",t+="<accordion id='"+e.pre+"accordion1' class='icn3d-accordion'>",t+="<h3>File</h3>",t+="<div>",t+=this.setMenu1_base(),t+="</div>",t+="</accordion>",t+="</div>",t}setMenu1_base(){let e=this.icn3dui;if(e.bNode)return"";let t="";return t+="<ul class='icn3d-mn-item'>",t+=this.getMenuText("mn1_searchgrooup","Search Structure "+e.htmlCls.wifiStr,void 0,1,1),t+="<ul>",t+=this.getMenuUrl("mn1_searchstru","https://www.ncbi.nlm.nih.gov/structure","PDB Structures "+e.htmlCls.wifiStr,1,2),t+=this.getLink("mn1_proteinname","AlphaFold Structures "+e.htmlCls.wifiStr,1,2),t+=this.getMenuUrl("mn1_afdatabase","https://alphafold.ebi.ac.uk","AlphaFold UniProt Database "+e.htmlCls.wifiStr,void 0,2),t+="</ul>",t+="</li>",t+=this.getMenuText("mn1_searchsimilar","Search Similar"+e.htmlCls.wifiStr,void 0,void 0,1),t+="<ul>",t+=this.getLink("mn1_vastplus","NCBI VAST+ (PDB Complex)"+e.htmlCls.wifiStr,void 0,2),t+=this.getLink("mn1_vast","NCBI VAST (PDB Chain)"+e.htmlCls.wifiStr,void 0,2),t+=this.getLink("mn1_foldseek","Foldseek (PDB & AlphaFold)"+e.htmlCls.wifiStr,void 0,2),t+="</ul>",t+="</li>",t+=this.getMenuText("mn1_retrievebyid","Retrieve by ID",void 0,1,1),t+="<ul>",t+=this.getLink("mn1_mmdbafid","PDB/MMDB/AlphaFold IDs"+e.htmlCls.wifiStr,1,2),t+=this.getLink("mn1_mmdbid","NCBI MMDB ID (annotation) "+e.htmlCls.wifiStr,void 0,2),t+=this.getLink("mn1_mmtfid","RCSB BCIF/MMTF ID (fast) "+e.htmlCls.wifiStr,void 0,2),t+=this.getLink("mn1_pdbid","RCSB PDB ID "+e.htmlCls.wifiStr,void 0,2),t+=this.getMenuText("mn1_afwrap","AlphaFold Structures",void 0,void 0,2),t+="<ul>",t+=this.getLink("mn1_afid","UniProt ID "+e.htmlCls.wifiStr,void 0,3),t+=this.getLink("mn1_refseqid","NCBI Protein Accession "+e.htmlCls.wifiStr,void 0,3),t+="</ul>",t+=this.getLink("mn1_opmid","OPM PDB ID "+e.htmlCls.wifiStr,void 0,2),t+=this.getLink("mn1_mmcifid","RCSB mmCIF ID "+e.htmlCls.wifiStr,void 0,2),t+=this.getLink("mn1_cid","PubChem CID/Name/InchI "+e.htmlCls.wifiStr,1,2),t+=this.getLink("mn1_smiles","Chemical SMILES ",void 0,2),t+="</ul>",t+="</li>",t+=this.getMenuText("mn1_openfile","Open File",void 0,1,1),t+="<ul>",t+=this.getLink("mn1_pdbfile_app","PDB Files (appendable)",1,2),t+=this.getLink("mn1_mmciffile","mmCIF Files (appendable)",void 0,2),t+=this.getLink("mn1_mol2file","Mol2 File",void 0,2),t+=this.getLink("mn1_sdffile","SDF File",void 0,2),t+=this.getLink("mn1_xyzfile","XYZ File",void 0,2),t+=this.getMenuSep(),t+=this.getMenuText("mn1_msawrap","Multiple Seq. Alignment",void 0,void 0,2),t+="<ul>",t+=this.getLink("mn1_clustalwfile","CLUSTALW Format",void 0,3),t+=this.getLink("mn1_fastafile","FASTA Format",void 0,3),t+="</ul>",t+=this.getLink("mn1_afmapfile","AlphaFold PAE File",void 0,2),t+=this.getLink("mn1_urlfile","URL(CORS) "+e.htmlCls.wifiStr,void 0,2),t+=this.getMenuSep(),t+=this.getLink("mn1_pngimage","iCn3D PNG (appendable)",1,2),t+=this.getLink("mn1_state","State/Script File",void 0,2),t+=this.getLink("mn1_fixedversion","Share Link in Archived Ver. "+e.htmlCls.wifiStr,void 0,2),t+=this.getLink("mn1_selection","Selection File",void 0,2),t+=this.getLink("mn1_collection","Collection File",void 0,2),t+=this.getLink("mn1_bcfviewpoint","BCF Viewpoint File",void 0,2),t+=this.getMenuSep(),t+=this.getMenuText("mn1_dsn6wrap","Electron Density",void 0,void 0,2),t+="<ul>",t+=this.getLink("mn1_dsn6","Local File",void 0,3),t+=this.getLink("mn1_dsn6url","URL(CORS) "+e.htmlCls.wifiStr,void 0,3),t+="</ul>",t+="<li><br/></li>",t+="</ul>",t+="</li>",t+=this.getMenuText("mn1_fold","Predict by Seq.",void 0,void 0,1),t+="<ul>",t+=this.getLink("mn1_esmfold","ESMFold",void 0,2),t+=this.getLink("mn1_alphafold","AlphaFold2 via ColabFold"+e.htmlCls.wifiStr,void 0,2),t+="</ul>",t+=this.getMenuText("mn1_alignwrap","Align",void 0,1,1),t+="<ul>",t+=this.getMenuText("mn1_chainalignwrap","Multiple Chains",void 0,1,2),t+="<ul>",t+=this.getRadio("mn1_chainalignRad","mn1_chainalign","by Structure Alignment "+e.htmlCls.wifiStr,void 0,1,3),t+=this.getRadio("mn1_chainalignRad","mn1_chainalign2","by Sequence Alignment "+e.htmlCls.wifiStr,void 0,1,3),t+=this.getRadio("mn1_chainalignRad","mn1_chainalign3","Residue by Residue",void 0,void 0,3),t+="</ul>",t+="</li>",t+=this.getMenuText("mn1_aligntwostru","Protein Complexes",void 0,1,2),t+="<ul>",t+=this.getLink("mn1_align","Two PDB Structures "+e.htmlCls.wifiStr,1,3),t+=this.getLink("mn1_alignaf","Two AlphaFold Structures "+e.htmlCls.wifiStr,void 0,3),t+="</ul>",t+=this.getLink("mn1_blast_rep_id","Sequence to Structure",void 0,2),t+="</ul>",t+="</li>",t+=this.getMenuText("mn2_realignWrap","Realign Selection",void 0,void 0,1),t+="<ul>",t+=this.getMenuText("mn2_chainrealignwrap","Multiple Chains",void 0,void 0,2),t+="<ul>",t+=this.getRadio("mn2_realign","mn2_realignonstruct","by Structure Alignment "+e.htmlCls.wifiStr,void 0,void 0,3),t+=this.getRadio("mn2_realign","mn2_realignonseqalign","by Sequence Alignment "+e.htmlCls.wifiStr,void 0,void 0,3),t+=this.getRadio("mn2_realign","mn2_realignresbyres","Residue by Residue",void 0,void 0,3),t+="</ul>",t+=this.getLink("mn2_realigntwostru","Protein Complexes",void 0,2),t+="</ul>",t+="</li>",t+=this.getMenuText("mn1_3dpprint","3D Printing",void 0,1,1),t+="<ul>",void 0===e.cfg.cid?(t+=this.getLink("mn1_exportVrmlStab","WRL/VRML(Color, W/ Stab.)",1,2),t+=this.getLink("mn1_exportStlStab","STL(W/ Stabilizers)",1,2),t+=this.getMenuSep(),t+=this.getLink("mn1_exportVrml","WRL/VRML(Color)",void 0,2),t+=this.getLink("mn1_exportStl","STL",void 0,2),t+=this.getMenuSep(),t+=this.getLink("mn1_stabilizerYes","Add All Stabilizers",void 0,2),t+=this.getLink("mn1_stabilizerNo","Remove All Stabilizers",void 0,2),t+=this.getMenuSep(),t+=this.getLink("mn1_stabilizerOne","Add One Stabilizer",void 0,2),t+=this.getLink("mn1_stabilizerRmOne","Remove One Stabilizer",void 0,2),t+=this.getMenuSep(),t+=this.getLink("mn1_thicknessSet","Set Thickness",void 0,2)):(t+=this.getLink("mn1_exportVrml","VRML(Color)",1,2),t+=this.getLink("mn1_exportStl","STL",1,2)),t+="</ul>",t+="</li>",t+=this.getMenuText("mn1_savefile","Save File",void 0,1,1),t+="<ul>",t+=this.getMenuText("mn1_savepngimage","iCn3D PNG Image",void 0,1,2),t+="<ul>",t+=this.getLink("mn1_exportCanvas","Original Size & HTML",void 0,3),t+=this.getLink("mn1_exportCanvas1","Original Size",1,3),t+=this.getLink("mn1_exportCanvas2","2X Large",void 0,3),t+=this.getLink("mn1_exportCanvas4","4X Large",void 0,3),t+=this.getLink("mn1_exportCanvas8","8X Large",void 0,3),t+="</ul>",t+="</li>",t+=this.getLink("mn1_exportVideo","Video",void 0,2),t+=this.getLink("mn1_exportState","State File",void 0,2),t+=this.getLink("mn1_exportSelections","Selection File",void 0,2),t+=this.getLink("mn1_exportSelDetails","Selection Details",void 0,2),t+=this.getLink("mn1_exportCounts","Residue Counts",void 0,2),t+=this.getLink("mn1_exportPdbRes","PDB",1,2),t+=this.getLink("profixpdb","PDB with Missing Atoms",void 0,2),void 0===e.cfg.cid&&(t+=this.getLink("mn1_exportSecondary","Secondary Structure",void 0,2)),t+=this.getMenuText("m1_exportrefnum","Reference Numbers",void 0,void 0,2),t+="<ul>",t+=this.getLink("mn1_exportIgstrand","Ig Strand",void 0,3),t+=this.getLink("mn1_exportKabat","Kabat",void 0,3),t+=this.getLink("mn1_exportImgt","IMGT",void 0,3),t+="</ul>",t+=this.getLink("mn1_exportCamera","BCF Viewpoint",void 0,2),t+="<li><br/></li>",t+="</ul>",t+="</li>",t+=this.getLink("mn1_sharelink","Share Link "+e.htmlCls.wifiStr,1,1),t+=this.getLink("mn1_replayon","Replay Each Step",void 0,1),t+=this.getMenuSep(),t+=this.getMenuText("mn1_menuwrap","Customize Menus",void 0,1,1),t+="<ul>",t+=this.getLink("mn1_menuall","All Menus",1,2),t+=this.getLink("mn1_menusimple","Simple Menus",1,2),t+=this.getMenuSep(),t+=this.getLink("mn1_menupref","Preferences",1,2),t+=this.getLink("mn1_menuloadpref","Load Preferences",1,2),t+="</ul>",t+="</li>",t+="<li><br/></li>",t+="</ul>",t}setMenu2(){let e=this.icn3dui;if(e.bNode)return"";let t="";return t+="<div class='icn3d-menu'>",t+="<accordion id='"+e.pre+"accordion2' class='icn3d-accordion'>",t+="<h3>Select</h3>",t+="<div>",t+=this.setMenu2_base(),t+="</div>",t+="</accordion>",t+="</div>",t}setMenu2_base(){let e=this.icn3dui;if(e.bNode)return"";let t="";return t+="<ul class='icn3d-mn-item'>",t+=this.getLink("mn2_definedsets","Defined Sets",1,1),t+=this.getLink("mn2_selectall","All",1,1),t+=this.getLink("mn2_selectdisplayed","Displayed Set",void 0,1),t+=this.getLink("mn2_aroundsphere","by Distance",1,1),t+=this.getMenuText("mn2_selbyprop","by Property",void 0,void 0,1),t+="<ul>",t+=this.getLink("mn2_propPos","Positive",void 0,2),t+=this.getLink("mn2_propNeg","Negative",void 0,2),t+=this.getLink("mn2_propHydro","Hydrophobic",void 0,2),t+=this.getLink("mn2_propPolar","Polar",void 0,2),t+=this.getLink("mn2_propBfactor","B-factor/pLDDT",void 0,2),t+=this.getLink("mn2_propSolAcc","Solvent Accessibility",void 0,2),t+="</ul>",t+="</li>",t+=this.getLink("mn2_selectcomplement","Inverse",void 0,1),t+=this.getLink("mn2_selectmainchains","Main Chains",1,1),t+=this.getLink("mn2_selectsidechains","Side Chains",1,1),t+=this.getLink("mn2_selectmainsidechains","Main & Side Chains",void 0,1),t+=this.getLink("mn2_command","Advanced",1,1),void 0===e.cfg.cid?(t+=this.getMenuText("mn2_selon3d","Select on 3D",void 0,1,1),t+="<ul>",t+='<li>"Alt"+Click: start selection</li>',t+='<li>"Ctrl"+Click: union selection</li>',t+='<li>"Shift"+Click: range Selection</li>',t+=this.getMenuSep(),t+=this.getRadio("mn2_pk","mn2_pkChain","Chain",void 0,1,2),void 0===e.cfg.mmdbid&&void 0===e.cfg.gi||(t+=this.getRadio("mn2_pk","mn2_pkDomain","3D Domain",void 0,void 0,2)),t+=this.getRadio("mn2_pk","mn2_pkStrand","Strand/Helix",void 0,void 0,2),t+=this.getRadio("mn2_pk","mn2_pkResidue","Residue",!0,1,2),t+=this.getRadio("mn2_pk","mn2_pkYes","Atom",void 0,1,2),t+=this.getRadio("mn2_pk","mn2_pkNo","None",void 0,void 0,2),t+="</ul>",t+="</li>"):e.utilsCls.isMobile()?t+="<li><span>Touch to pick</span></li>":t+='<li><span>Picking with<br>"Alt" + Click</span></li>',t+=this.getMenuSep(),t+=this.getLink("mn2_saveselection","Save Selection",1,1),t+=this.getLink("clearall","Clear Selection",1,1),t+=this.getLink("mn2_saveresidue","Save Res. in Sel.",1,1),t+=this.getMenuSep(),t+=this.getMenuText("mn2_hlcolor","Highlight Color",void 0,void 0,1),t+="<ul>",t+=this.getRadio("mn2_hl_clr","mn2_hl_clrYellow","Yellow",!0,void 0,2),t+=this.getRadio("mn2_hl_clr","mn2_hl_clrGreen","Green",void 0,void 0,2),t+=this.getRadio("mn2_hl_clr","mn2_hl_clrRed","Red",void 0,void 0,2),t+="</ul>",t+="</li>",t+=this.getMenuText("mn2_hlstyle","Highlight Style",void 0,void 0,1),t+="<ul>",t+=this.getRadio("mn2_hl_style","mn2_hl_styleOutline","Outline",!0,void 0,2),t+=this.getRadio("mn2_hl_style","mn2_hl_styleObject","3D Objects",void 0,void 0,2),t+="</ul>",t+="</li>",t+=this.getLink("toggleHighlight2","Toggle Highlight",1,1),t+="<li><br/></li>",t+="</ul>",t}setMenu2b(){let e=this.icn3dui;if(e.bNode)return"";let t="";return t+="<div class='icn3d-menu'>",t+="<accordion id='"+e.pre+"accordion2b' class='icn3d-accordion'>",t+="<h3>View</h3>",t+="<div>",t+=this.setMenu2b_base(),t+="</div>",t+="</accordion>",t+="</div>",t}setMenu2b_base(){let e=this.icn3dui;if(e.bNode)return"";let t="";return t+="<ul class='icn3d-mn-item'>",t+=this.getLink("mn2_show_selected","View Selection",1,1),t+=this.getLink("mn2_hide_selected","Hide Selection",1,1),t+=this.getLink("mn2_selectedcenter","Zoom in Selection",1,1),t+=this.getLink("mn6_center","Center Selection",1,1),t+=this.getLink("mn2_fullstru","View Full Structure"),t+=this.getLinkWrapper("mn2_alternate",'Alternate(Key "a")',"mn2_alternateWrap",void 0,1),void 0!==e.cfg.opmid?t+=this.getLinkWrapper("togglemem","Toggle Membrane","togglememli",1,1):void 0===e.cfg.cid&&(t+=this.getLinkWrapper("togglemem","Toggle Membrane","togglememli",void 0,1,!0)),void 0!==e.cfg.opmid&&(t+=this.getLinkWrapper("adjustmem","Adjust Membrane","adjustmemli",void 0,1),t+=this.getLinkWrapper("selectplane","Select between<br>Two X-Y Planes</span>","selectplaneli",void 0,1)),t+=this.getMenuSep(),t+=this.getMenuText("mn2_vrarhints","VR & AR Hints",void 0,void 0,1),t+="<ul>",t+=this.getMenuUrl("vrhint",e.htmlCls.baseUrl+"icn3d/icn3d.html#vr","VR: VR Headsets",void 0,2),t+=this.getMenuUrl("arhint",e.htmlCls.baseUrl+"icn3d/icn3d.html#ar","AR: Chrome in Android",void 0,2),t+="</ul>",t+="</li>",t+=this.getMenuText("mn6_stereoWrapper","Stereo View",void 0,void 0,1),t+="<ul>",t+=this.getRadio("mn6_stereo","mn6_stereoYes","On",void 0,void 0,2),t+=this.getRadio("mn6_stereo","mn6_stereoNo","Off",!0,void 0,2),t+="</ul>",t+="</li>",t+=this.getLink("mn6_sidebyside","Side by Side",void 0,1),t+=this.getMenuText("mn2_rotate","Rotate",void 0,1,1),t+="<ul>",t+=this.getMenuText("mn2_rotate90","Rotate 90&deg;",void 0,void 0,2),t+="<ul>",t+=this.getRadio("mn6_rotate90","mn6_rotatex","rotate x",void 0,void 0,2),t+=this.getRadio("mn6_rotate90","mn6_rotatey","rotate y",void 0,void 0,2),t+=this.getRadio("mn6_rotate90","mn6_rotatez","rotate z",void 0,void 0,2),t+="</ul>",t+="</li>",t+=this.getMenuText("mn2_rotateauto","Auto Rotation",void 0,1,2),t+="<ul>",t+=this.getRadio("mn6_rotate","mn6_rotateleft","Rotate Left",void 0,1,3),t+=this.getRadio("mn6_rotate","mn6_rotateright","Rotate Right",void 0,1,3),t+=this.getRadio("mn6_rotate","mn6_rotateup","Rotate Up",void 0,1,3),t+=this.getRadio("mn6_rotate","mn6_rotatedown","Rotate Down",void 0,1,3),t+="</ul>",t+="</li>",t+="</ul>",t+="</li>",t+=this.getLink("mn2_translate","Translate XYZ",void 0,1),t+=this.getLink("mn2_matrix","Rotate with Matrix",void 0,1),t+=this.getMenuText("mn2_camera","Camera",void 0,void 0,1),t+="<ul>",t+=this.getRadio("mn6_camera","mn6_cameraPers","Perspective",!0,void 0,2),t+=this.getRadio("mn6_camera","mn6_cameraOrth","Orthographic",void 0,void 0,2),t+="</ul>",t+="</li>",t+=this.getMenuText("mn2_fog","Fog for Selection",void 0,void 0,1),t+="<ul>",t+=this.getRadio("mn6_showfog","mn6_showfogYes","On",void 0,void 0,2),t+=this.getRadio("mn6_showfog","mn6_showfogNo","Off",!0,void 0,2),t+="</ul>",t+="</li>",t+=this.getMenuText("mn2_slab","Slab for Selection",void 0,void 0,1),t+="<ul>",t+=this.getRadio("mn6_showslab","mn6_showslabYes","On",void 0,void 0,2),t+=this.getRadio("mn6_showslab","mn6_showslabNo","Off",!0,void 0,2),t+="</ul>",t+="</li>",t+=this.getMenuText("mn2_axes","XYZ-axes",void 0,void 0,1),t+="<ul>",t+=this.getRadio("mn6_showaxis","mn6_showaxisYes","Original",void 0,void 0,2),t+=this.getRadio("mn6_showaxis","mn6_showaxisSel","Prin. Axes on Sel.",void 0,void 0,2),t+=this.getRadio("mn6_showaxis","mn6_showaxisNo","Hide",!0,void 0,2),t+="</ul>",t+="</li>",t+=this.getMenuSep(),t+=this.getMenuText("mn2_resetwrap","Reset",void 0,1,1),t+="<ul>",t+=this.getRadio("mn6_reset","reset","All",void 0,1,2),t+=this.getRadio("mn6_reset","mn6_resetOrientation","Orientation",void 0,1,2),t+="</ul>",t+="</li>",t+=this.getLink("mn6_back","Undo",void 0,1),t+=this.getLink("mn6_forward","Redo",void 0,1),t+=this.getLink("mn6_fullscreen","Full Screen",void 0,1),t+="<li><br/></li>",t+="</ul>",t}setMenu3(){let e=this.icn3dui;if(e.bNode)return"";let t="";return t+="<div class='icn3d-menu'>",t+="<accordion id='"+e.pre+"accordion3' class='icn3d-accordion'>",t+="<h3 id='"+e.pre+"style'>Style</h3>",t+="<div>",t+=this.setMenu3_base(),t+="</div>",t+="</accordion>",t+="</div>",t}setMenu3_base(){let e=this.icn3dui;if(e.bNode)return"";let t="";t+="<ul class='icn3d-mn-item'>",void 0===e.cfg.cid&&(t+=this.getMenuText("mn3_proteinwrap","Proteins",void 0,1,1),t+="<ul>",void 0!==e.cfg.align||void 0!==e.cfg.chainalign?t+=this.getRadio("mn3_proteins","mn3_proteinsRibbon","Ribbon",void 0,1,2):t+=this.getRadio("mn3_proteins","mn3_proteinsRibbon","Ribbon",!0,1,2),t+=this.getRadio("mn3_proteins","mn3_proteinsStrand","Strand",void 0,1,2),t+=this.getRadio("mn3_proteins","mn3_proteinsCylinder","Cylinder and Plate",void 0,void 0,2),t+=this.getRadio("mn3_proteins","mn3_proteinsSchematic","Schematic",void 0,1,2),void 0!==e.cfg.align||void 0!==e.cfg.chainalign?t+=this.getRadio("mn3_proteins","mn3_proteinsCalpha","C Alpha Trace",!0,1,2):t+=this.getRadio("mn3_proteins","mn3_proteinsCalpha","C Alpha Trace",void 0,1,2),t+=this.getRadio("mn3_proteins","mn3_proteinsBackbone","Backbone",void 0,void 0,2),t+=this.getRadio("mn3_proteins","mn3_proteinsBfactor","B-factor Tube",void 0,void 0,2),t+=this.getRadio("mn3_proteins","mn3_proteinsLines","Lines",void 0,1,2),t+=this.getRadio("mn3_proteins","mn3_proteinsStick","Stick",void 0,1,2),t+=this.getRadio("mn3_proteins","mn3_proteinsBallstick","Ball and Stick",void 0,1,2),t+=this.getRadio("mn3_proteins","mn3_proteinsSphere","Sphere",void 0,1,2),t+=this.getRadio("mn3_proteins","mn3_proteinsNo","Hide",void 0,1,2),t+="</ul>",t+="</li>",t+=this.getMenuText("mn3_sidecwrap","Side Chains",void 0,1,1),t+="<ul>",t+=this.getRadio("mn3_sidec","mn3_sidecLines","Lines",void 0,1,2),t+=this.getRadio("mn3_sidec","mn3_sidecStick","Stick",void 0,1,2),t+=this.getRadio("mn3_sidec","mn3_sidecBallstick","Ball and Stick",void 0,1,2),t+=this.getRadio("mn3_sidec","mn3_sidecSphere","Sphere",void 0,1,2),t+=this.getRadio("mn3_sidec","mn3_sidecNo","Hide",!0,1,2),t+="</ul>",t+="</li>",t+=this.getMenuText("mn3_nuclwrap","Nucleotides",void 0,1,1),t+="<ul>",t+=this.getRadio("mn3_nucl","mn3_nuclCartoon","Cartoon",!0,1,2),t+=this.getRadio("mn3_nucl","mn3_nuclPhos","O3' Trace",void 0,1,2),t+=this.getRadio("mn3_nucl","mn3_nuclBackbone","Backbone",void 0,void 0,2),t+=this.getRadio("mn3_nucl","mn3_nuclSchematic","Schematic",void 0,1,2),t+=this.getRadio("mn3_nucl","mn3_nuclLines","Lines",void 0,1,2),t+=this.getRadio("mn3_nucl","mn3_nuclStick","Stick",void 0,1,2),t+=this.getRadio("mn3_nucl","mn3_nuclBallstick","Ball and Stick",void 0,1,2),t+=this.getRadio("mn3_nucl","mn3_nuclSphere","Sphere",void 0,1,2),t+=this.getRadio("mn3_nucl","mn3_nuclNo","Hide",void 0,1,2),t+="</ul>",t+="</li>",t+=this.getMenuText("mn3_ntbasewrap","Nucl. Bases",void 0,1,1),t+="<ul>",t+=this.getRadio("mn3_ntbase","mn3_ntbaseLines","Lines",void 0,1,2),t+=this.getRadio("mn3_ntbase","mn3_ntbaseStick","Stick",void 0,1,2),t+=this.getRadio("mn3_ntbase","mn3_ntbaseBallstick","Ball and Stick",void 0,1,2),t+=this.getRadio("mn3_ntbase","mn3_ntbaseSphere","Sphere",void 0,1,2),t+=this.getRadio("mn3_ntbase","mn3_ntbaseNo","Hide",!0,1,2),t+="</ul>",t+="</li>"),t+=this.getMenuText("mn3_ligwrap","Chemicals",void 0,1,1),t+="<ul>",t+=this.getRadio("mn3_lig","mn3_ligLines","Lines",void 0,1,2),void 0===e.cfg.cid?(t+=this.getRadio("mn3_lig","mn3_ligStick","Stick",!0,1,2),t+=this.getRadio("mn3_lig","mn3_ligBallstick","Ball and Stick",void 0,1,2)):(t+=this.getRadio("mn3_lig","mn3_ligStick","Stick",void 0,1,2),t+=this.getRadio("mn3_lig","mn3_ligBallstick","BalHydrogensl and Stick",!0,1,2)),t+=this.getRadio("mn3_lig","mn3_ligSchematic","Schematic",void 0,1,2),t+=this.getRadio("mn3_lig","mn3_ligSphere","Sphere",void 0,1,2),t+=this.getRadio("mn3_lig","mn3_ligNo","Hide",void 0,1,2),t+="</ul>",t+="</li>",t+=this.getMenuText("mn3_hydrogenswrap","Hydrogens",void 0,void 0,1),t+="<ul>",t+=this.getRadio("mn3_hydrogens","mn3_hydrogensYes","Show",!0,void 0,2),t+=this.getRadio("mn3_hydrogens","mn3_hydrogensNo","Hide",void 0,void 0,2),t+="</ul>",t+="</li>",void 0===e.cfg.cid&&(t+=this.getMenuText("mn3_glycanwrap","Glycans",void 0,void 0,1),t+="<ul>",t+=this.getRadio("mn3_glycansCart","mn3_glycansCartYes","Show Cartoon",void 0,void 0,2),t+=this.getRadio("mn3_glycansCart","mn3_glycansCartNo","Hide Cartoon",!0,void 0,2),t+="</ul>",t+="</li>"),t+=this.getMenuText("mn3_ionswrap","Ions",void 0,1,1),t+="<ul>",t+=this.getRadio("mn3_ions","mn3_ionsSphere","Sphere",!0,1,2),t+=this.getRadio("mn3_ions","mn3_ionsDot","Dot",void 0,1,2),t+=this.getRadio("mn3_ions","mn3_ionsNo","Hide",void 0,1,2),t+="</ul>",t+="</li>",t+=this.getMenuText("mn3_waterwrap","Water",void 0,1,1),t+="<ul>",t+=this.getRadio("mn3_water","mn3_waterSphere","Sphere",void 0,1,2),t+=this.getRadio("mn3_water","mn3_waterDot","Dot",void 0,1,2),t+=this.getRadio("mn3_water","mn3_waterNo","Hide",!0,1,2),t+="</ul>",t+="</li>",void 0===e.cfg.cid&&(t+=this.getMenuText("mn2_clashedwrap","Clashed Residues",void 0,void 0,1),t+="<ul>",t+=this.getRadio("mn2_clashed","mn2_clashedYes","Show",!0,void 0,2),t+=this.getRadio("mn2_clashed","mn2_clashedNo","Hide",void 0,void 0,2),t+="</ul>",t+="</li>"),t+=this.getLink("mn3_setThickness","Preferences",void 0,1),t+=this.getMenuSep(),t+=this.getLink("mn3_styleSave","Save Style",void 0,2),t+=this.getLink("mn3_styleApplySave","Apply Saved Style",void 0,2),t+=this.getMenuSep(),t+=this.getMenuText("mn5_surfacewrap","Surface Type",void 0,1,1),t+="<ul>",t+=this.getRadio("mn5_surface","mn5_surfaceVDW","Van der Waals",void 0,1,2),t+=this.getRadio("mn5_surface","mn5_surfaceVDWContext","VDW with Context",void 0,void 0,2),t+=this.getRadio("mn5_surface","mn5_surfaceMolecular","Molecular Surface",void 0,1,2),t+=this.getRadio("mn5_surface","mn5_surfaceMolecularContext","MS with Context",void 0,void 0,2),t+=this.getRadio("mn5_surface","mn5_surfaceSAS","Solvent Accessible",void 0,1,2),t+=this.getRadio("mn5_surface","mn5_surfaceSASContext","SA with Context",void 0,void 0,2),t+="</ul>",t+="</li>",t+=this.getLink("mn5_surfaceNo","Remove Surface",1,1),t+=this.getMenuText("mn5_surfaceop","Surface Opacity",void 0,1,1),t+="<ul>",t+=this.getMenuText("mn5_surfaceopfast","Fast Transparency",void 0,1,2),t+="<ul>",t+=this.getRadio("mn5_opacity","mn5_opacity10","1.0",!0,1,3);for(let e=9;e>0;--e)t+=this.getRadio("mn5_opacity","mn5_opacity0"+e,"0."+e,1,3);t+="</ul>",t+="</li>",t+=this.getMenuText("mn5_surfaceopslow","Slow Transparency",void 0,void 0,2),t+="<ul>",t+=this.getRadio("mn5_opacityslow","mn5_opacityslow10","1.0",!0,void 0,3);for(let e=9;e>0;--e)t+=this.getRadio("mn5_opacityslow","mn5_opacityslow0"+e,"0."+e,void 0,void 0,3);return t+="</ul>",t+="</li>",t+="</ul>",t+=this.getMenuText("mn5_wireframewrap","Surface Wireframe",void 0,1,1),t+="<ul>",t+=this.getRadio("mn5_wireframe","mn5_wireframeYes","Yes",void 0,1,2),t+=this.getRadio("mn5_wireframe","mn5_wireframeNo","No",!0,1,2),t+="</ul>",t+="</li>",t+=this.getMenuSep(),t+=this.getLink("mn5_cartoonshape","Cartoon for a Set",void 0,1),t+=this.getLink("mn5_linebtwsets","Line btw. Two Sets",void 0,1),void 0===e.cfg.cid&&void 0===e.cfg.align&&void 0===e.cfg.chainalign&&void 0===e.cfg.mmdbaf&&(t+=this.getMenuSep(),t+=this.getLinkWrapper2("mn5_map","Electron Density","mapWrapper1",void 0,1),t+="<ul>",t+=this.getLink("mn5_elecmap2fofc","2Fo-Fc Map",void 0,2),t+=this.getLink("mn5_elecmapfofc","Fo-Fc Map",void 0,2),t+=this.getLinkWrapper("mn5_elecmapNo","Remove Map","mapWrapper2",void 0,2),t+="</ul>",t+="</li>",t+=this.getLinkWrapper2("mn5_map3","Map Wireframe","mapWrapper3",void 0,1),t+="<ul>",t+=this.getRadio("mn5_mapwireframe","mn5_mapwireframeYes","Yes",!0,void 0,2),t+=this.getRadio("mn5_mapwireframe","mn5_mapwireframeNo","No",void 0,void 0,2),t+="</ul>",t+="</li>",void 0===e.cfg.mmtfid&&(t+=this.getLinkWrapper("mn5_emmap","EM Density Map","emmapWrapper1",void 0,1),t+=this.getLinkWrapper("mn5_emmapNo","Remove EM Map","emmapWrapper2",void 0,1),t+=this.getLinkWrapper2("mn5_emmap3","EM Map Wireframe","emmapWrapper3",void 0,1),t+="<ul>",t+=this.getRadio("mn5_emmapwireframe","mn5_emmapwireframeYes","Yes",!0,void 0,2),t+=this.getRadio("mn5_emmapwireframe","mn5_emmapwireframeNo","No",void 0,void 0,2),t+="</ul>",t+="</li>")),t+=this.getMenuSep(),t+=this.getMenuText("mn6_bkgdwrap","Background",void 0,1,1),t+="<ul>",t+=this.getRadio("mn6_bkgd","mn6_bkgdTransparent","Transparent",void 0,1,2),t+=this.getRadio("mn6_bkgd","mn6_bkgdBlack","Black",!0,1,2),t+=this.getRadio("mn6_bkgd","mn6_bkgdGrey","Gray",void 0,1,2),t+=this.getRadio("mn6_bkgd","mn6_bkgdWhite","White",void 0,1,2),t+="</ul>",t+="</li>",t+=this.getMenuText("mn6_themewrap","Dialog Color",void 0,void 0,1),t+="<ul>",t+=this.getRadio("mn6_theme","mn6_themeBlue","Blue",!0,void 0,2),t+=this.getRadio("mn6_theme","mn6_themeOrange","Orange",void 0,void 0,2),t+=this.getRadio("mn6_theme","mn6_themeBlack","Black",void 0,void 0,2),t+="</ul>",t+="</li>",t+="<li><br/></li>",t+="</ul>",t}setMenu4(){let e=this.icn3dui;if(e.bNode)return"";let t="";return t+="<div class='icn3d-menu'>",t+="<accordion id='"+e.pre+"accordion4' class='icn3d-accordion'>",t+="<h3 id='"+e.pre+"color'>Color</h3>",t+="<div>",t+=this.setMenu4_base(),t+="</div>",t+="</accordion>",t+="</div>",t}setMenu4_base(){let e=this.icn3dui;if(e.bNode)return"";let t="";return t+="<ul class='icn3d-mn-item'>",t+=this.getMenuText("mn4_clrwrap","Unicolor","icn3d-menupd",1,1),t+="<ul>",t+=this.getMenuText("uniclrRedwrap","Red",void 0,1,2),t+="<ul>",t+=this.getRadClr("mn4_clr","uniclrRed1","Red","F00",void 0,1,3),t+=this.getRadClr("mn4_clr","uniclrRed2","Indian Red","CD5C5C",void 0,1,3),t+=this.getRadClr("mn4_clr","uniclrRed3","Light Coral","F08080",void 0,1,3),t+=this.getRadClr("mn4_clr","uniclrRed4","Salmon","FA8072",void 0,1,3),t+=this.getRadClr("mn4_clr","uniclrRed5","Dark Salmon","E9967A",void 0,1,3),t+=this.getRadClr("mn4_clr","uniclrRed6","Light Salmon","FFA07A",void 0,1,3),t+=this.getRadClr("mn4_clr","uniclrRed7","Crimson","DC143C",void 0,1,3),t+=this.getRadClr("mn4_clr","uniclrRed8","Fire Brick","B22222",void 0,1,3),t+=this.getRadClr("mn4_clr","uniclrRed9","Dark Red","8B0000",void 0,1,3),t+="</ul>",t+=this.getMenuText("uniclrPinkwrap","Pink",void 0,1,2),t+="<ul>",t+=this.getRadClr("mn4_clr","uniclrPink1","Pink","FFC0CB",void 0,1,3),t+=this.getRadClr("mn4_clr","uniclrPink2","Light Pink","FFB6C1",void 0,1,3),t+=this.getRadClr("mn4_clr","uniclrPink3","Hot Pink","FF69B4",void 0,1,3),t+=this.getRadClr("mn4_clr","uniclrPink4","Deep Pink","FF1493",void 0,1,3),t+=this.getRadClr("mn4_clr","uniclrPink5","Medium Violet Red","C71585",void 0,1,3),t+=this.getRadClr("mn4_clr","uniclrPink6","Pale Violet Red","DB7093",void 0,1,3),t+="</ul>",t+=this.getMenuText("uniclrOrangewrap","Orange",void 0,1,2),t+="<ul>",t+=this.getRadClr("mn4_clr","uniclrOran1","Orange","FFA500",void 0,1,3),t+=this.getRadClr("mn4_clr","uniclrOran2","Dark Orange","FF8C00",void 0,1,3),t+=this.getRadClr("mn4_clr","uniclrOran3","Orange Red","FF4500",void 0,1,3),t+=this.getRadClr("mn4_clr","uniclrOran4","Tomato","FF6347",void 0,1,3),t+=this.getRadClr("mn4_clr","uniclrOran5","Coral","FF7F50",void 0,1,3),t+=this.getRadClr("mn4_clr","uniclrOran6","Light Salmon","FFA07A",void 0,1,3),t+="</ul>",t+=this.getMenuText("uniclrYellowwrap","Yellow",void 0,1,2),t+="<ul>",t+=this.getRadClr("mn4_clr","uniclrYllw1","Yellow","FF0",void 0,1,3),t+=this.getRadClr("mn4_clr","uniclrYllw2","Gold","FFD700",void 0,1,3),t+=this.getRadClr("mn4_clr","uniclrYllw3","Light Yellow","FFFFE0",void 0,1,3),t+=this.getRadClr("mn4_clr","uniclrYllw4","Lemon Chiffon","FFFACD",void 0,1,3),t+=this.getRadClr("mn4_clr","uniclrYllw5","Light Golden Rod","FAFAD2",void 0,1,3),t+=this.getRadClr("mn4_clr","uniclrYllw6","Papaya Whip","FFEFD5",void 0,1,3),t+=this.getRadClr("mn4_clr","uniclrYllw7","Moccasin","FFE4B5",void 0,1,3),t+=this.getRadClr("mn4_clr","uniclrYllw8","Peach Puff","FFDAB9",void 0,1,3),t+=this.getRadClr("mn4_clr","uniclrYllw9","Pale Golden Rod","EEE8AA",void 0,1,3),t+=this.getRadClr("mn4_clr","uniclrYllw10","Khaki","F0E68C",void 0,1,3),t+=this.getRadClr("mn4_clr","uniclrYllw11","Dark Khaki","BDB76B",void 0,1,3),t+="</ul>",t+=this.getMenuText("uniclrMagentawrap","Magenta",void 0,1,2),t+="<ul>",t+=this.getRadClr("mn4_clr","uniclrMgnt1","Magenta","F0F",void 0,1,3),t+=this.getRadClr("mn4_clr","uniclrMgnt2","Orchid","DA70D6",void 0,1,3),t+=this.getRadClr("mn4_clr","uniclrMgnt3","Violet","EE82EE",void 0,1,3),t+=this.getRadClr("mn4_clr","uniclrMgnt4","Plum","DDA0DD",void 0,1,3),t+=this.getRadClr("mn4_clr","uniclrMgnt5","Thistle","D8BFD8",void 0,1,3),t+=this.getRadClr("mn4_clr","uniclrMgnt6","Lavender","E6E6FA",void 0,1,3),t+=this.getRadClr("mn4_clr","uniclrMgnt7","Medium Orchid","BA55D3",void 0,1,3),t+=this.getRadClr("mn4_clr","uniclrMgnt8","Medium Purple","9370DB",void 0,1,3),t+=this.getRadClr("mn4_clr","uniclrMgnt9","Rebecca Purple","663399",void 0,1,3),t+=this.getRadClr("mn4_clr","uniclrMgnt10","Blue Violet","8A2BE2",void 0,1,3),t+=this.getRadClr("mn4_clr","uniclrMgnt11","Dark Violet","9400D3",void 0,1,3),t+=this.getRadClr("mn4_clr","uniclrMgnt12","Dark Orchid","9932CC",void 0,1,3),t+=this.getRadClr("mn4_clr","uniclrMgnt13","Dark Magenta","8B008B",void 0,1,3),t+=this.getRadClr("mn4_clr","uniclrMgnt14","Purple","800080",void 0,1,3),t+=this.getRadClr("mn4_clr","uniclrMgnt15","Indigo","4B0082",void 0,1,3),t+=this.getRadClr("mn4_clr","uniclrMgnt16","Slat Blue","6A5ACD",void 0,1,3),t+=this.getRadClr("mn4_clr","uniclrMgnt17","Dark Slate Blue","483D8B",void 0,1,3),t+=this.getRadClr("mn4_clr","uniclrMgnt18","Medium Slat Blue","6A5ACD",void 0,1,3),t+="</ul>",t+=this.getMenuText("uniclrGreenwrap","Green",void 0,1,2),t+="<ul>",t+=this.getRadClr("mn4_clr","uniclrGrn1","Green","0F0",void 0,1,3),t+=this.getRadClr("mn4_clr","uniclrGrn2","Dark Green","006400",void 0,1,3),t+=this.getRadClr("mn4_clr","uniclrGrn3","Yellow Green","9ACD32",void 0,1,3),t+=this.getRadClr("mn4_clr","uniclrGrn4","Olive Drab","6B8E23",void 0,1,3),t+=this.getRadClr("mn4_clr","uniclrGrn5","Olive","808000",void 0,1,3),t+=this.getRadClr("mn4_clr","uniclrGrn6","Dark Olive Green","556B2F",void 0,1,3),t+=this.getRadClr("mn4_clr","uniclrGrn7","Medium Aquamarine","66CDAA",void 0,1,3),t+=this.getRadClr("mn4_clr","uniclrGrn8","Dark Sea Green","8FBC8B",void 0,1,3),t+=this.getRadClr("mn4_clr","uniclrGrn9","Lignt Sea Green","20B2AA",void 0,1,3),t+=this.getRadClr("mn4_clr","uniclrGrn10","Dark Cyan","008B8B",void 0,1,3),t+=this.getRadClr("mn4_clr","uniclrGrn11","Teal","008080",void 0,1,3),t+=this.getRadClr("mn4_clr","uniclrGrn12","Forest Green","228B22",void 0,1,3),t+=this.getRadClr("mn4_clr","uniclrGrn13","Sea Green","2E8B57",void 0,1,3),t+=this.getRadClr("mn4_clr","uniclrGrn14","Medium Sea Green","3CB371",void 0,1,3),t+=this.getRadClr("mn4_clr","uniclrGrn15","Spring Green","00FF7F",void 0,1,3),t+=this.getRadClr("mn4_clr","uniclrGrn16","Medium Spring","00FA9A",void 0,1,3),t+=this.getRadClr("mn4_clr","uniclrGrn17","Light Green","90EE90",void 0,1,3),t+=this.getRadClr("mn4_clr","uniclrGrn18","Pale Green","98FB98",void 0,1,3),t+=this.getRadClr("mn4_clr","uniclrGrn19","Lime Green","32CD32",void 0,1,3),t+=this.getRadClr("mn4_clr","uniclrGrn20","Lawn Green","7CFC00",void 0,1,3),t+=this.getRadClr("mn4_clr","uniclrGrn21","Chartreuse","7FFF00",void 0,1,3),t+=this.getRadClr("mn4_clr","uniclrGrn22","Green Yellow","ADFF2F",void 0,1,3),t+="</ul>",t+=this.getMenuText("uniclrCyanwrap","Cyan",void 0,1,2),t+="<ul>",t+=this.getRadClr("mn4_clr","uniclrCyan1","Cyan","0FF",void 0,1,3),t+=this.getRadClr("mn4_clr","uniclrCyan2","Light Cyan","E0FFFF",void 0,1,3),t+=this.getRadClr("mn4_clr","uniclrCyan3","Pale Turquoise","AFEEEE",void 0,1,3),t+=this.getRadClr("mn4_clr","uniclrCyan4","Aquamarine","7FFFD4",void 0,1,3),t+=this.getRadClr("mn4_clr","uniclrCyan5","Turquoise","40E0D0",void 0,1,3),t+=this.getRadClr("mn4_clr","uniclrCyan6","Medium Turquoise","48D1CC",void 0,1,3),t+=this.getRadClr("mn4_clr","uniclrCyan7","Dark Turquoise","00CED1",void 0,1,3),t+="</ul>",t+=this.getMenuText("uniclrBluewrap","Blue",void 0,1,2),t+="<ul>",t+=this.getRadClr("mn4_clr","uniclrBlue1","Blue","00F",void 0,1,3),t+=this.getRadClr("mn4_clr","uniclrBlue2","Medium Blue","0000CD",void 0,1,3),t+=this.getRadClr("mn4_clr","uniclrBlue3","Dark Blue","00008B",void 0,1,3),t+=this.getRadClr("mn4_clr","uniclrBlue4","Navy","000080",void 0,1,3),t+=this.getRadClr("mn4_clr","uniclrBlue5","Midnight Blue","191970",void 0,1,3),t+=this.getRadClr("mn4_clr","uniclrBlue6","Royal Blue","4169E1",void 0,1,3),t+=this.getRadClr("mn4_clr","uniclrBlue7","Medium Slate Blue","7B68EE",void 0,1,3),t+=this.getRadClr("mn4_clr","uniclrBlue8","Corn Flower Blue","6495ED",void 0,1,3),t+=this.getRadClr("mn4_clr","uniclrBlue9","Dodger Blue","1E90FF",void 0,1,3),t+=this.getRadClr("mn4_clr","uniclrBlue10","Deep Sky Blue","00BFFF",void 0,1,3),t+=this.getRadClr("mn4_clr","uniclrBlue11","Light Sky Blue","87CEFA",void 0,1,3),t+=this.getRadClr("mn4_clr","uniclrBlue12","Sky Blue","87CEEB",void 0,1,3),t+=this.getRadClr("mn4_clr","uniclrBlue13","Light Blue","ADD8E6",void 0,1,3),t+=this.getRadClr("mn4_clr","uniclrBlue14","Powder Blue","B0E0E6",void 0,1,3),t+=this.getRadClr("mn4_clr","uniclrBlue15","Light Steel Blue","B0C4DE",void 0,1,3),t+=this.getRadClr("mn4_clr","uniclrBlue16","Steel Blue","4682B4",void 0,1,3),t+=this.getRadClr("mn4_clr","uniclrBlue17","Cadet Blue","5F9EA0",void 0,1,3),t+="</ul>",t+=this.getMenuText("uniclrBrownwrap","Brown",void 0,1,2),t+="<ul>",t+=this.getRadClr("mn4_clr","uniclrBrown1","Brown","A52A2A",void 0,1,3),t+=this.getRadClr("mn4_clr","uniclrBrown2","Maroon","800000",void 0,1,3),t+=this.getRadClr("mn4_clr","uniclrBrown3","Sienna","A0522D",void 0,1,3),t+=this.getRadClr("mn4_clr","uniclrBrown4","Saddle Brown","8B4513",void 0,1,3),t+=this.getRadClr("mn4_clr","uniclrBrown5","Chocolate","D2691E",void 0,1,3),t+=this.getRadClr("mn4_clr","uniclrBrown6","Peru","CD853F",void 0,1,3),t+=this.getRadClr("mn4_clr","uniclrBrown7","Dark Golden Rod","B8860B",void 0,1,3),t+=this.getRadClr("mn4_clr","uniclrBrown8","Golden Rod","DAA520",void 0,1,3),t+=this.getRadClr("mn4_clr","uniclrBrown9","Sandy Brown","F4A460",void 0,1,3),t+=this.getRadClr("mn4_clr","uniclrBrown10","Rosy Brown","BC8F8F",void 0,1,3),t+=this.getRadClr("mn4_clr","uniclrBrown11","Tan","D2B48C",void 0,1,3),t+=this.getRadClr("mn4_clr","uniclrBrown12","Burlywood","DEB887",void 0,1,3),t+=this.getRadClr("mn4_clr","uniclrBrown13","Wheat","F5DEB3",void 0,1,3),t+=this.getRadClr("mn4_clr","uniclrBrown14","Navajo White","FFDEAD",void 0,1,3),t+=this.getRadClr("mn4_clr","uniclrBrown15","Bisque","FFE4C4",void 0,1,3),t+=this.getRadClr("mn4_clr","uniclrBrown16","Blanched Almond","FFEBCD",void 0,1,3),t+=this.getRadClr("mn4_clr","uniclrBrown17","Corn Silk","FFF8DC",void 0,1,3),t+="</ul>",t+=this.getMenuText("uniclrWhitewrap","White",void 0,1,2),t+="<ul>",t+=this.getRadClr("mn4_clr","uniclrWhite1","White","FFF",void 0,1,3),t+=this.getRadClr("mn4_clr","uniclrWhite2","Snow","FFFAFA",void 0,1,3),t+=this.getRadClr("mn4_clr","uniclrWhite3","Honey Dew","F0FFF0",void 0,1,3),t+=this.getRadClr("mn4_clr","uniclrWhite4","Mint Cream","F5FFFA",void 0,1,3),t+=this.getRadClr("mn4_clr","uniclrWhite5","Azure","F0FFFF",void 0,1,3),t+=this.getRadClr("mn4_clr","uniclrWhite6","Alice Blue","F0F8FF",void 0,1,3),t+=this.getRadClr("mn4_clr","uniclrWhite7","Ghost White","F8F8FF",void 0,1,3),t+=this.getRadClr("mn4_clr","uniclrWhite8","White Smoke","F5F5F5",void 0,1,3),t+=this.getRadClr("mn4_clr","uniclrWhite9","Sea Shell","FFF5EE",void 0,1,3),t+=this.getRadClr("mn4_clr","uniclrWhite10","Beige","F5F5DC",void 0,1,3),t+=this.getRadClr("mn4_clr","uniclrWhite11","Old Lace","FDF5E6",void 0,1,3),t+=this.getRadClr("mn4_clr","uniclrWhite12","Floral White","FFFAF0",void 0,1,3),t+=this.getRadClr("mn4_clr","uniclrWhite13","Ivory","FFFFF0",void 0,1,3),t+=this.getRadClr("mn4_clr","uniclrWhite14","Antique White","FAEBD7",void 0,1,3),t+=this.getRadClr("mn4_clr","uniclrWhite15","Linen","FAF0E6",void 0,1,3),t+=this.getRadClr("mn4_clr","uniclrWhite16","Lavenderblush","FFF0F5",void 0,1,3),t+=this.getRadClr("mn4_clr","uniclrWhite17","Misty Rose","FFE4E1",void 0,1,3),t+="</ul>",t+=this.getMenuText("uniclrGraywrap","Gray",void 0,1,2),t+="<ul>",t+=this.getRadClr("mn4_clr","uniclrGray1","Gray","808080",void 0,1,3),t+=this.getRadClr("mn4_clr","uniclrGray2","Dim Gray","696969",void 0,1,3),t+=this.getRadClr("mn4_clr","uniclrGray3","Light Slate Gray","778899",void 0,1,3),t+=this.getRadClr("mn4_clr","uniclrGray4","Slate Gray","708090",void 0,1,3),t+=this.getRadClr("mn4_clr","uniclrGray5","Dark Slate Gray","2F4F4F",void 0,1,3),t+=this.getRadClr("mn4_clr","uniclrGray6","Black","000000",void 0,1,3),t+=this.getRadClr("mn4_clr","uniclrGray7","Dark Gray","A9A9A9",void 0,1,3),t+=this.getRadClr("mn4_clr","uniclrGray8","Silver","C0C0C0",void 0,1,3),t+=this.getRadClr("mn4_clr","uniclrGray9","Light Gray","D3D3D3",void 0,1,3),t+=this.getRadClr("mn4_clr","uniclrGray10","Gainsboro","DCDCDC",void 0,1,3),t+="</ul>",t+="</ul>",t+=this.getRadio("mn4_clr","mn4_clrCustom","Color Picker",void 0,1,1),t+=this.getMenuSep(),void 0===e.cfg.cid?(t+=this.getMenuText("mn4_clrRainbowwrap","Rainbow (R-V)","icn3d-menupd",1,1),t+="<ul>",t+=this.getRadio("mn4_clr","mn4_clrRainbow","for Selection",void 0,1,2),t+=this.getRadio("mn4_clr","mn4_clrRainbowChain","for Chains",void 0,1,2),t+=this.getRadio("mn4_clr","mn4_clrRainbowSets","for Sets",void 0,void 0,2),t+=this.getRadio("mn4_clr","mn4_clrRainbowAcrossSets","across Sets",void 0,void 0,2),t+="</ul>",t+=this.getMenuText("mn4_clrSpectrumwrap","Spectrum (V-R)","icn3d-menupd",1,1),t+="<ul>",t+=this.getRadio("mn4_clr","mn4_clrSpectrum","for Selection",void 0,1,2),t+=this.getRadio("mn4_clr","mn4_clrSpectrumChain","for Chains",void 0,1,2),t+=this.getRadio("mn4_clr","mn4_clrSpectrumSets","for Sets",void 0,void 0,2),t+=this.getRadio("mn4_clr","mn4_clrSpectrumAcrossSets","across Sets",void 0,void 0,2),t+="</ul>",t+=this.getMenuText("mn4_clrSSwrap","Secondary","icn3d-menupd",1,1),t+="<ul>",t+=this.getRadio("mn4_clr","mn4_clrSSGreen","Sheet in Green",void 0,1,2),t+=this.getRadio("mn4_clr","mn4_clrSSYellow","Sheet in Yellow",void 0,1,2),t+=this.getRadio("mn4_clr","mn4_clrSSSpectrum","Spectrum",void 0,void 0,2),t+="</ul>",t+=this.getRadio("mn4_clr","mn4_clrCharge","Charge",void 0,1,1),t+=this.getMenuText("mn4_hydrophobicwrap","Hydrophobicity","icn3d-menupd",1,1),t+="<ul>",t+=this.getRadio("mn4_clr","mn4_clrNormalizedHP","Normalized",void 0,1,2),t+=this.getRadio("mn4_clr","mn4_clrHydrophobic","Wimley-White",void 0,void 0,2),t+="</ul>",t+=this.getMenuText("mn4_clrBfactorwrap","B-factor","icn3d-menupd",1,1),t+="<ul>",t+=this.getRadio("mn4_clr","mn4_clrBfactor","Original",void 0,1,2),t+=this.getRadio("mn4_clr","mn4_clrBfactorNorm","Percentile",void 0,1,2),t+="</ul>",t+=this.getRadio("mn4_clr","mn4_clrArea",'Solvent<br><span style="padding-left:1.5em;">Accessibility</span>',void 0,1,1),t+=this.getRadio("mn4_clr","mn4_clrStructure","Structure",void 0,1,1),void 0!==e.cfg.align||void 0!==e.cfg.chainalign||void 0!==e.cfg.blast_rep_id?t+=this.getRadio("mn4_clr","mn4_clrChain","Chain",void 0,1,1):t+=this.getRadio("mn4_clr","mn4_clrChain","Chain",!0,1,1),t+=this.getRadio("mn4_clr","mn4_clrdomain","3D Domain",void 0,1,1),void 0===e.cfg.cid&&(t+=this.getMenuText("mn4_clrsetswrap","Defined Sets","icn3d-menupd",void 0,1),t+="<ul>",t+=this.getRadio("mn4_clr","mn4_clrsets",'Rainbow for Selected Sets<br><span style="padding-left:1.5em;">in "Analysis > Defined Sets"</span>',void 0,void 0,2),t+="</ul>",t+="</li>"),t+=this.getMenuText("mn4_clrResiduewrap","Residue","icn3d-menupd",1,1),t+="<ul>",t+=this.getRadio("mn4_clr","mn4_clrResidue","Default",void 0,1,2),t+=this.getRadio("mn4_clr","mn4_clrResidueCustom","Custom",void 0,void 0,2),t+="</ul>",t+=this.getRadio("mn4_clr","mn4_clrAtom","Atom",void 0,1,1),void 0!==e.cfg.align||void 0!==e.cfg.chainalign?(t+=this.getRadio("mn4_clr","mn4_clrIdentity","Identity",!0,void 0,1),t+=this.getRadio("mn4_clr","mn4_clrConserved","Conservation",void 0,void 0,1)):void 0!==e.cfg.blast_rep_id?(t+=this.getRadio("mn4_clr","mn4_clrIdentity","Identity",void 0,void 0,1),t+=this.getRadio("mn4_clr","mn4_clrConserved","Conservation",!0,void 0,1)):(t+=this.getRadio("mn4_clr","mn4_clrIdentity","Identity",void 0,void 0,1),t+=this.getRadio("mn4_clr","mn4_clrConserved","Conservation",void 0,void 0,1)),t+=this.getRadio("mn4_clr","mn4_clrConfidence","pLDDT",void 0,1,1),t+=this.getRadio("mn4_clr","mn4_clrIgstrand","Ig Strand",void 0,void 0,1),t+=this.getRadio("mn4_clr","mn4_clrIgproto","Ig Protodomain",void 0,void 0,1)):t+=this.getRadio("mn4_clr","mn4_clrAtom","Atom",!0,1,1),t+=this.getMenuSep(),t+=this.getLink("mn4_clrSave","Save Color",void 0,1),t+=this.getLink("mn4_clrApplySave","Apply Saved Color",void 0,1),t+="<li><br/></li>",t+="</ul>",t}setMenu5(){let e=this.icn3dui;if(e.bNode)return"";let t="";return t+="<div class='icn3d-menu'>",t+="<accordion id='"+e.pre+"accordion5' class='icn3d-accordion'>",t+="<h3 id='"+e.pre+"analysis' style='font-size:1.2em'>&nbsp;Analysis</h3>",t+="<div>",t+=this.setMenu5_base(),t+="</div>",t+="</accordion>",t+="</div>",t}setMenu5_base(){let e=this.icn3dui;if(e.bNode)return"";let t="";t+="<ul class='icn3d-mn-item'>",void 0===e.cfg.cid&&void 0===e.cfg.smiles||(t+=this.getLink("mn2_2ddepiction","2D Depiction "+e.htmlCls.wifiStr,1,1)),void 0===e.cfg.cid&&(t+=this.getLink("mn6_selectannotations","Seq. & Annotations "+e.htmlCls.wifiStr,1,1),t+=this.getLink("mn2_alignment","Aligned Seq. "+e.htmlCls.wifiStr,1,1),void 0===e.cfg.mmdbid&&void 0===e.cfg.gi&&void 0===e.cfg.blast_rep_id&&void 0===e.cfg.align&&void 0===e.cfg.chainalign||(t+=this.getLink("mn2_2ddgm","2D Diagram "+e.htmlCls.wifiStr,1,1)),t+=this.getMenuText("2dctnwrap","2D Cartoon",void 0,void 0,1),t+="<ul>",t+=this.getLink("2dctn_chain","Chain Level",void 0,2),t+=this.getLink("2dctn_domain","Domain Level",void 0,2),t+=this.getLink("2dctn_secondary","Helix/Sheet Level",void 0,2),t+="</ul>",t+="</li>",t+=this.getLink("definedsets2","Defined Sets",1,1),t+=this.getMenuSep(),t+=this.getLink("mn6_hbondsYes","Interactions",1,1),t+=this.getMenuText("mn1_window","Bring to Front",void 0,void 0,1),t+="<ul>",t+=this.getLink("mn1_window_table","Interaction Table",void 0,2),t+=this.getLink("mn1_window_linegraph","2D Interaction Network",void 0,2),t+=this.getLink("mn1_window_scatterplot","2D Interaction Map",void 0,2),t+=this.getLink("mn1_window_graph","2D Graph(Force-Directed)",void 0,2),t+="</ul>",t+="</li>",t+=this.getLink("mn6_contactmap","Contact Map",void 0,1),t+=this.getLink("mn1_mutation","Mutation "+e.htmlCls.wifiStr,1,1)),e.cfg.hidelicense||(t+=this.getMenuText("mn1_delphiwrap","DelPhi Potential",void 0,1,1),t+="<ul>",t+=this.getLink("mn1_delphi","DelPhi Potential "+e.htmlCls.licenseStr,1,2),t+=this.getMenuText("mn1_phiwrap","Load PQR/Phi",void 0,void 0,2),t+="<ul>",t+=this.getLink("mn1_phi","Local PQR/Phi/Cube File",void 0,3),t+=this.getLink("mn1_phiurl","URL PQR/Phi/Cube File",void 0,3),t+="</ul>",t+="</li>",t+=this.getLink("delphipqr","Download PQR",void 0,2),t+="</ul>",t+="</li>"),t+=this.getMenuSep(),t+=this.getMenuText("mn6_distancewrap","Distance",void 0,1,1),t+="<ul>",t+=this.getRadio("mn6_distance","mn6_distanceYes","between Two Atoms",void 0,1,2),t+=this.getRadio("mn6_distance","mn6_distTwoSets","between Two Sets",void 0,void 0,2),t+=this.getRadio("mn6_distance","mn6_distManySets","among Many Sets",void 0,void 0,2),t+=this.getRadio("mn6_distance","mn6_distanceNo","Hide",!0,1,2),t+="</ul>",t+="</li>",t+=this.getMenuText("mn6_anglewrap","Angle",void 0,void 0,1),t+="<ul>",t+=this.getRadio("mn6_angle","mn6_angleManySets","among Many Sets",void 0,void 0,2),t+=this.getRadio("mn6_angle","mn6_angleTwoSets","b/w Two Vectors",void 0,void 0,2),t+="</ul>",t+="</li>",t+=this.getLink("mn6_area","Surface Area",void 0,1),t+=this.getMenuText("mn6_addlabelwrap","Label",void 0,1,1),t+="<ul>",t+=this.getRadio("mn6_addlabel","mn6_addlabelYes","by Picking Atoms",void 0,void 0,2),t+=this.getRadio("mn6_addlabel","mn6_addlabelSelection","per Selection",void 0,void 0,2),t+=this.getRadio("mn6_addlabel","mn6_addlabelAtoms","per Atom",void 0,void 0,2),t+=this.getRadio("mn6_addlabel","mn6_addlabelElements","per Atom Element",void 0,void 0,2),void 0===e.cfg.cid&&(t+=this.getRadio("mn6_addlabel","mn6_addlabelResidues","per Residue",void 0,1,2),t+=this.getRadio("mn6_addlabel","mn6_addlabelResnum","per Residue & Number",void 0,1,2),t+=this.getRadio("mn6_addlabel","mn6_addlabelRefnum","per Reference Number",void 0,void 0,2),t+=this.getRadio("mn6_addlabel","mn6_addlabelIg","per Ig Domain",void 0,void 0,2),t+=this.getRadio("mn6_addlabel","mn6_addlabelChains","per Chain",void 0,void 0,2),t+=this.getRadio("mn6_addlabel","mn6_addlabelTermini","N- & C-Termini",void 0,1,2)),t+=this.getMenuSep(),t+=this.getRadio("mn6_addlabel","mn6_labelColor","Change Label Color",void 0,1,2),t+=this.getRadio("mn6_addlabel","mn6_addlabelNo","Remove",!0,1,2),t+="</ul>",t+="</li>",t+=this.getMenuText("labelscalewrap","Label Scale",void 0,1,1),t+="<ul>";for(let e=1;e<=4;++e){let i=2*e;t+=this.getRadio("mn6_labelscale","mn6_labelscale0"+i,"0."+i,void 0,1,2)}for(let e=2;e<=10;++e){let i=(e/2).toFixed(1);t+=2==e?this.getRadio("mn6_labelscale","mn6_labelscale"+e+"0",i,!0,1,2):this.getRadio("mn6_labelscale","mn6_labelscale"+e+"0",i,void 0,1,2)}if(t+="</ul>",t+="</li>",t+=this.getMenuSep(),void 0===e.cfg.cid){t+=this.getMenuText("mn6_chemicalbindingwrap","Chem. Binding",void 0,1,1),t+="<ul>",t+=this.getRadio("mn6_chemicalbinding","mn6_chemicalbindingshow","Show",void 0,1,2),t+=this.getRadio("mn6_chemicalbinding","mn6_chemicalbindinghide","Hide",!0,1,2),t+="</ul>",t+="</li>",t+=this.getMenuText("mn6_ssbondswrap","Disulfide Bonds",void 0,1,1),t+="<ul>",t+=this.getRadio("mn6_ssbonds","mn6_ssbondsYes","Show",!0,1,2),t+=this.getRadio("mn6_ssbonds","mn6_ssbondsExport","Export Pairs",void 0,void 0,2),t+=this.getRadio("mn6_ssbonds","mn6_ssbondsNo","Hide",void 0,1,2),t+="</ul>",t+="</li>",t+=this.getMenuText("mn6_clbondswrap","Cross-Linkages",void 0,void 0,1),t+="<ul>",t+=this.getRadio("mn6_clbonds","mn6_clbondsYes","Show",!0,void 0,2),t+=this.getRadio("mn6_clbonds","mn6_clbondsExport","Export Pairs",void 0,void 0,2),t+=this.getRadio("mn6_clbonds","mn6_clbondsNo","Hide",void 0,void 0,2),t+="</ul>",t+="</li>",t+=this.getLink("mn6_DSSP","DSSP Secondary",void 0,1);let i=void 0!==e.cfg.mmtfid||void 0!==e.cfg.pdbid||void 0!==e.cfg.opmid||void 0!==e.cfg.mmcifid||void 0!==e.cfg.mmdbid||void 0!==e.cfg.mmdbafid||void 0!==e.cfg.gi||void 0!==e.cfg.blast_rep_id;i&&(t+=this.getMenuText("assemblyWrapper","Assembly",void 0,1,1),t+="<ul>",e.cfg.bu?(t+=this.getRadio("mn6_assembly","mn6_assemblyYes","Biological Assembly",!0,1,2),t+=this.getRadio("mn6_assembly","mn6_assemblyNo","Asymmetric Unit",void 0,1,2)):(t+=this.getRadio("mn6_assembly","mn6_assemblyYes","Biological Assembly",void 0,1,2),t+=this.getRadio("mn6_assembly","mn6_assemblyNo","Asymmetric Unit",!0,1,2)),t+="</ul>",t+="</li>"),t+=this.getMenuText("mn6_symmetrywrap","Symmetry",void 0,void 0,1),t+="<ul>",i&&(t+=this.getLink("mn6_symmetry","from PDB(precalculated) "+e.htmlCls.wifiStr,void 0,2)),t+=this.getLink("mn6_symd","from SymD(Dynamic) "+e.htmlCls.wifiStr,void 0,2),t+=this.getLink("mn6_clear_sym","Clear SymD Symmetry",void 0,2),t+=this.getLink("mn6_axes_only","Show Axes Only",void 0,2),t+="</ul>",t+="</li>",t+=this.getMenuText("mn6_igrefwrap","Ref. Number",void 0,void 0,1),t+="<ul>",t+=this.getLink("mn6_igrefYes","Show Ig for Selection",void 0,2),t+=this.getLink("mn6_igrefTpl","Ig w/ Specified Template",void 0,2),t+=this.getLink("mn6_alignrefTpl","Align w/ Specified Template",void 0,2),t+=this.getLink("mn6_igrefNo","Reset Ig Ref. Number",void 0,2),t+=this.getMenuSep(),t+=this.getLink("mn6_customref","Custom Ref. Number",void 0,2),t+="</ul>",t+="</li>",t+=this.getMenuSep()}return t+=this.getLink("mn6_yournote","Window Title",void 0,1),void 0!==e.cfg.cid?(t+=this.getMenuText("mn1_linkwrap","Links",void 0,void 0,1),t+="<ul>",t+=this.getLink("mn1_link_structure","Compound Summary "+e.htmlCls.wifiStr,void 0,2),t+=this.getLink("mn1_link_vast","Similar Compounds "+e.htmlCls.wifiStr,void 0,2),t+=this.getLink("mn1_link_bind","Structures Bound "+e.htmlCls.wifiStr,void 0,2),t+="</ul>",t+="</li>"):(t+=this.getMenuText("mn1_linkwrap","Links",void 0,void 0,1),t+="<ul>",t+=this.getLink("mn1_link_structure","Structure Summary "+e.htmlCls.wifiStr,void 0,2),t+=this.getLink("mn1_link_vast","Similar Structures "+e.htmlCls.wifiStr,void 0,2),t+=this.getLink("mn1_link_pubmed","Literature "+e.htmlCls.wifiStr,void 0,2),t+=this.getLink("mn1_link_protein","Protein "+e.htmlCls.wifiStr,void 0,2),t+="</ul>",t+="</li>"),t+="<li><br/></li>",t+="</ul>",t}setMenu6(){let e=this.icn3dui;if(e.bNode)return"";let t="";return t+="<div class='icn3d-menu'>",t+="<accordion id='"+e.pre+"accordion6' class='icn3d-accordion'>",t+="<h3>Help</h3>",t+="<div>",t+=this.setMenu6_base(),t+="</div>",t+="</accordion>",t+="</div>",t}setMenu6_base(){let e=this.icn3dui;if(e.bNode)return"";let t="";return t+="<ul class='icn3d-mn-item'>",t+=this.getMenuUrl("abouticn3d",e.htmlCls.baseUrl+"icn3d/icn3d.html#about","About iCn3D<span style='font-size:0.9em'> "+e.REVISION+"</span>",1,1),t+=this.getMenuUrl("gallery",e.htmlCls.baseUrl+"icn3d/icn3d.html#gallery","Live Gallery "+e.htmlCls.wifiStr,1,1),t+=this.getMenuUrl("video",e.htmlCls.baseUrl+"icn3d/icn3d.html#videos","Videos & Tutorials",1,1),t+=this.getMenuText("mn6_faq","FAQ",void 0,1,1),t+="<ul>",t+=this.getMenuUrl("faq_viewstru",e.htmlCls.baseUrl+"icn3d/icn3d.html#viewstru","View structure",1,2),t+=this.getMenuUrl("faq_tfstru",e.htmlCls.baseUrl+"icn3d/icn3d.html#tfstru","Transform Structure",1,2),t+=this.getMenuUrl("faq_selsubset",e.htmlCls.baseUrl+"icn3d/icn3d.html#selsubset","Select Subsets",1,2),t+=this.getMenuUrl("faq_stylecolor",e.htmlCls.baseUrl+"icn3d/icn3d.html#changestylecolor","Change Style/Color",1,2),t+=this.getMenuUrl("faq_savework",e.htmlCls.baseUrl+"icn3d/icn3d.html#saveview","Save Work",1,2),t+=this.getMenuUrl("faq_showanno",e.htmlCls.baseUrl+"icn3d/icn3d.html#showanno","Show Annotations",1,2),t+=this.getMenuUrl("faq_exportanno",e.htmlCls.baseUrl+"icn3d/icn3d.html#exportanno","Export Annotations",1,2),t+=this.getMenuUrl("faq_interanal",e.htmlCls.baseUrl+"icn3d/icn3d.html#interanalysis","Interaction Analysis",1,2),t+=this.getMenuUrl("faq_mutanal",e.htmlCls.baseUrl+"icn3d/icn3d.html#mutationanalysis","Mutation Analysis",1,2),t+=this.getMenuUrl("faq_elecpot",e.htmlCls.baseUrl+"icn3d/icn3d.html#elecpot","Electrostatic Pot.",1,2),t+=this.getMenuUrl("faq_simipdb",e.htmlCls.baseUrl+"icn3d/icn3d.html#simivast","Similar PDB",1,2),t+=this.getMenuUrl("faq_simialphapdb",e.htmlCls.baseUrl+"icn3d/icn3d.html#simifoldseek","Similar AlphaFold/PDB",1,2),t+=this.getMenuUrl("faq_alnstru",e.htmlCls.baseUrl+"icn3d/icn3d.html#alignmul","Align Multiple Structures",1,2),t+=this.getMenuUrl("faq_batchanal",e.htmlCls.baseUrl+"icn3d/icn3d.html#batchanalysis","Batch Analysis",1,2),t+=this.getMenuUrl("faq_batchanal",e.htmlCls.baseUrl+"icn3d/icn3d.html#igrefnum","Assign Ig Ref. Numbers",1,2),t+=this.getMenuUrl("faq_embedicn3d",e.htmlCls.baseUrl+"icn3d/icn3d.html#embedicn3d","Embed iCn3D",1,2),t+="</ul>",t+="</li>",t+=this.getMenuUrl("citing",e.htmlCls.baseUrl+"icn3d/icn3d.html#citing","Citing iCn3D",1,1),t+=this.getMenuText("mn6_source","Source Code",void 0,1,1),t+="<ul>",t+=this.getMenuUrl("github","https://github.com/ncbi/icn3d","GitHub (browser) "+e.htmlCls.wifiStr,1,2),t+=this.getMenuUrl("npm","https://www.npmjs.com/package/icn3d","npm (Node.js) "+e.htmlCls.wifiStr,1,2),t+=this.getMenuUrl("notebook","https://pypi.org/project/icn3dpy","Jupyter Notebook "+e.htmlCls.wifiStr,1,2),t+="</ul>",t+="</li>",t+=this.getMenuText("mn6_develop","Develop",void 0,void 0,1),t+="<ul>",t+=this.getMenuUrl("dev_contribute",e.htmlCls.baseUrl+"icn3d/icn3d.html#HowToContribute","Become a Contributor",void 0,2),t+=this.getMenuUrl("dev_embedicn3d2",e.htmlCls.baseUrl+"icn3d/icn3d.html#HowToUse","Embed iCn3D",void 0,2),t+=this.getMenuUrl("dev_urlpara",e.htmlCls.baseUrl+"icn3d/icn3d.html#parameters","URL Parameters",void 0,2),t+=this.getMenuUrl("dev_command",e.htmlCls.baseUrl+"icn3d/icn3d.html#commands","Commands",void 0,2),t+=this.getMenuUrl("dev_datastru",e.htmlCls.baseUrl+"icn3d/icn3d.html#datastructure","Data Structure",void 0,2),t+=this.getMenuUrl("dev_classstru",e.htmlCls.baseUrl+"icn3d/icn3d.html#classstructure","Class Structure",void 0,2),t+=this.getMenuUrl("dev_addclass",e.htmlCls.baseUrl+"icn3d/icn3d.html#addclass","Add New Classes",void 0,2),t+=this.getMenuUrl("dev_modfunc",e.htmlCls.baseUrl+"icn3d/icn3d.html#modifyfunction","Modify Functions",void 0,2),t+=this.getMenuUrl("dev_restful",e.htmlCls.baseUrl+"icn3d/icn3d.html#restfulapi","RESTful APIs",void 0,2),t+=this.getMenuUrl("dev_contributor",e.htmlCls.baseUrl+"icn3d/icn3d.html#contributors","iCn3D Contributors",void 0,2),t+="</ul>",t+="</li>",t+=this.getMenuUrl("helpdoc",e.htmlCls.baseUrl+"icn3d/docs/icn3d_help.html","Help Doc "+e.htmlCls.wifiStr,1,1),t+=this.getMenuSep(),t+=this.getMenuText("mn6_tfhint","Transform Hints",void 0,1,1),t+="<ul>",t+=this.getMenuText("mn6_rotate","Rotate",void 0,1,2),t+="<ul>",t+="<li>Left Mouse (Click & Drag)</li>",t+="<li>Key l: Left</li>",t+="<li>Key j: Right</li>",t+="<li>Key i: Up</li>",t+="<li>Key m: Down</li>",t+="<li>Shift + Key l: Left 90&deg;</li>",t+="<li>Shift + Key j: Right 90&deg;</li>",t+="<li>Shift + Key i: Up 90&deg;</li>",t+="<li>Shift + Key m: Down 90&deg;</li>",t+="</ul>",t+="</li>",t+=this.getMenuText("mn6_zoom","Zoom",void 0,1,2),t+="<ul>",t+="<li>Middle Mouse <br>(Pinch & Spread)</li>",t+="<li>Key z: Zoom in</li>",t+="<li>Key x: Zoom out</li>",t+="</ul>",t+="</li>",t+=this.getMenuText("mn6_translate","Translate",void 0,1,2),t+="<ul>",t+="<li>Right Mouse <br>(Two Finger Click & Drag)</li>",t+="</ul>",t+="</li>",t+="</ul>",t+="</li>",t+=this.getMenuUrl("selhints",e.htmlCls.baseUrl+"icn3d/icn3d.html#selsubset","Selection Hints",void 0,1),t+=this.getMenuUrl("helpdesk","https://support.nlm.nih.gov/support/create-case/","Write to Help Desk",1,1),t+="<li><br/></li>",t+="</ul>",t}hideMenu(){let e=this.icn3dui;e.bNode||(void 0!==$("#"+e.pre+"mnlist")[0]&&($("#"+e.pre+"mnlist")[0].style.display="none"),void 0!==$("#"+e.pre+"mnLogSection")[0]&&($("#"+e.pre+"mnLogSection")[0].style.display="none"),void 0!==$("#"+e.pre+"cmdlog")[0]&&($("#"+e.pre+"cmdlog")[0].style.display="none"),$("#"+e.pre+"title")[0].style.margin="10px 0 0 10px")}showMenu(){let e=this.icn3dui;e.bNode||(void 0!==$("#"+e.pre+"mnlist")[0]&&($("#"+e.pre+"mnlist")[0].style.display="block"),void 0!==$("#"+e.pre+"mnLogSection")[0]&&($("#"+e.pre+"mnLogSection")[0].style.display="block"),void 0!==$("#"+e.pre+"cmdlog")[0]&&($("#"+e.pre+"cmdlog")[0].style.display="block"))}}class jl{constructor(e){this.icn3dui=e}openDlg(e,t){let i=this.icn3dui;i.icn3d,i.bNode||(e=i.pre+e,i.cfg.notebook?this.openDlgNotebook(e,t):this.openDlgRegular(e,t),i.htmlCls.themecolor||(i.htmlCls.themecolor="blue"),i.htmlCls.setMenuCls.setTheme(i.htmlCls.themecolor))}addSaveButton(e){let t=this.icn3dui;t.icn3d,t.bNode||void 0!==this.dialogHashSave&&this.dialogHashSave.hasOwnProperty(e)||($("#"+e).parent().children(".ui-dialog-titlebar").append("<div pid='"+e+"' class='icn3d-saveicon ui-icon ui-icon-disk' title='Save as an HTML file' style='background-color:white; background-image: url(&quot;https://www.ncbi.nlm.nih.gov/Structure/icn3d/lib/images/ui-icons_228ef1_256x240.png&quot;);'></div>"),void 0===this.dialogHashSave&&(this.dialogHashSave={}),this.dialogHashSave[e]=1)}addHideButton(e){let t=this.icn3dui;t.icn3d,t.bNode||void 0!==this.dialogHashHide&&this.dialogHashHide.hasOwnProperty(e)||($("#"+e).parent().children(".ui-dialog-titlebar").append("<div pid='"+e+"' class='icn3d-hideicon ui-icon ui-icon-arrowthick-2-ne-sw' title='Resize the window' style='background-color:white; background-image: url(&quot;https://www.ncbi.nlm.nih.gov/Structure/icn3d/lib/images/ui-icons_228ef1_256x240.png&quot;);'></div>"),void 0===this.dialogHashHide&&(this.dialogHashHide={}),this.dialogHashHide[e]=1)}getDialogStatus(){let e=this.icn3dui;if(e.icn3d,e.bNode)return;let t={},i={},s=$("#"+e.pre+"dl_selectannotations").hasClass("ui-dialog-content"),n=$("#"+e.pre+"dl_graph").hasClass("ui-dialog-content"),r=$("#"+e.pre+"dl_linegraph").hasClass("ui-dialog-content"),a=$("#"+e.pre+"dl_scatterplot").hasClass("ui-dialog-content"),o=$("#"+e.pre+"dl_ligplot").hasClass("ui-dialog-content"),l=$("#"+e.pre+"dl_contactmap").hasClass("ui-dialog-content"),d=$("#"+e.pre+"dl_alignerrormap").hasClass("ui-dialog-content"),c=$("#"+e.pre+"dl_interactionsorted").hasClass("ui-dialog-content"),h=$("#"+e.pre+"dl_alignment").hasClass("ui-dialog-content"),p=$("#"+e.pre+"dl_2ddgm").hasClass("ui-dialog-content"),u=$("#"+e.pre+"dl_2dctn").hasClass("ui-dialog-content"),m=$("#"+e.pre+"dl_definedsets").hasClass("ui-dialog-content");return t.bSelectannotationsInit2=!1,t.bGraph2=!1,t.bLineGraph2=!1,t.bScatterplot2=!1,t.bLigplot2=!1,t.bTable2=!1,t.bAlignmentInit2=!1,t.bTwoddgmInit2=!1,t.bTwodctnInit2=!1,t.bSetsInit2=!1,i.dl_selectannotations="bSelectannotationsInit2",i.dl_graph="bGraph2",i.dl_linegraph="bLineGraph2",i.dl_scatterplot="bScatterplot2",i.dl_ligplot="bLigplot2",i.dl_contactmap="bContactmap2",i.dl_alignerrormap="bAlignerrormap2",i.dl_interactionsorted="bTable2",i.dl_alignment="bAlignmentInit2",i.dl_2ddgm="bTwoddgmInit2",i.dl_2dctn="bTwodctnInit2",i.dl_definedsets="bSetsInit2",s&&(t.bSelectannotationsInit2=$("#"+e.pre+"dl_selectannotations").dialog("isOpen")),n&&(t.bGraph2=$("#"+e.pre+"dl_graph").dialog("isOpen")),r&&(t.bLineGraph2=$("#"+e.pre+"dl_linegraph").dialog("isOpen")),a&&(t.bScatterplot2=$("#"+e.pre+"dl_scatterplot").dialog("isOpen")),o&&(t.bLigplot2=$("#"+e.pre+"dl_ligplot").dialog("isOpen")),l&&(t.bContactmap2=$("#"+e.pre+"dl_contactmap").dialog("isOpen")),d&&(t.bAlignerror2=$("#"+e.pre+"dl_alignerrormap").dialog("isOpen")),c&&(t.bTable2=$("#"+e.pre+"dl_interactionsorted").dialog("isOpen")),h&&(t.bAlignmentInit2=$("#"+e.pre+"dl_alignment").dialog("isOpen")),p&&(t.bTwoddgmInit2=$("#"+e.pre+"dl_2ddgm").dialog("isOpen")),u&&(t.bTwodctnInit2=$("#"+e.pre+"dl_2dctn").dialog("isOpen")),m&&(t.bSetsInit2=$("#"+e.pre+"dl_definedsets").dialog("isOpen")),{status:t,id2flag:i}}openDlgHalfWindow(e,t,i,s){let n=this.icn3dui,r=n.icn3d;if(n.bNode)return;let a=this,o=n.htmlCls.width2d+20;r.resizeCanvasCls.resizeCanvas(n.htmlCls.WIDTH-i,n.htmlCls.HEIGHT,s);let l,d=n.htmlCls.HEIGHT,c=i;l=!n.cfg.showmenu||n.utilsCls.isMobile()||n.cfg.mobilemenu?{my:"left top",at:"right top",of:"#"+n.pre+"viewer",collision:"none"}:{my:"left top",at:"right top+40",of:"#"+n.pre+"viewer",collision:"none"},n.cfg.resize=!1,window.dialog=$("#"+e).dialog({autoOpen:!0,title:t,height:d,width:c,modal:!1,position:l,close:function(t){let i=a.getDialogStatus(),s=i.status,l=i.id2flag,d=!1;for(let t in l){let i=e===n.pre+t;for(let e in s)s.hasOwnProperty(e)||(i=i&&!s[e]);d=d||i}if(d)if(s.bTwoddgmInit2||s.bTwodctnInit2||s.bSetsInit2){let e=n.utilsCls.isMobile()?n.htmlCls.WIDTH:n.htmlCls.WIDTH-o;r.resizeCanvasCls.resizeCanvas(e,n.htmlCls.HEIGHT,!0),s.bTwoddgmInit2&&a.openDlg2Ddgm(n.pre+"dl_2ddgm",void 0,s.bSetsInit2),s.bTwodctnInit2&&a.openDlg2Ddgm(n.pre+"dl_2dctn",void 0,s.bSetsInit2),s.bSetsInit2&&a.openDlg2Ddgm(n.pre+"dl_definedsets")}else r.resizeCanvasCls.resizeCanvas(n.htmlCls.WIDTH,n.htmlCls.HEIGHT,!0)},resize:function(t){if(e==n.pre+"dl_selectannotations")r.annotationCls.hideFixedTitle();else if(e==n.pre+"dl_graph"){let t=$("#"+e).width(),i=$("#"+e).height();d3.select("#"+n.svgid).attr("width",t).attr("height",i)}else if(e==n.pre+"dl_linegraph"||e==n.pre+"dl_scatterplot"||e==n.pre+"dl_ligplot"||e==n.pre+"dl_contactmap"||e==n.pre+"dl_alignerrormap"){let t=status.bTwoddgmInit2||status.bSetsInit2?(n.htmlCls.WIDTH-o)/2:n.htmlCls.WIDTH/2,i=$("#"+e).width()/t;if(e==n.pre+"dl_linegraph"){let e=r.linegraphWidth*i;$("#"+n.linegraphid).attr("width",e)}else if(e==n.pre+"dl_scatterplot"){let e=r.scatterplotWidth*i;$("#"+n.scatterplotid).attr("width",e)}else if(e==n.pre+"dl_ligplot"){let e=r.ligplotWidth*i;$("#"+n.ligplotid).attr("width",e)}else if(e==n.pre+"dl_ligplot"){let e=r.ligplotWidth*i;$("#"+n.ligplotid).attr("width",e)}else if(e==n.pre+"dl_contactmap"){let e=r.contactmapWidth*i;$("#"+n.contactmapid).attr("width",e)}else if(e==n.pre+"dl_alignerrormap"){let e=r.alignerrormapWidth*i;$("#"+n.alignerrormapid).attr("width",e)}}}}),this.addSaveButton(e),this.addHideButton(e)}openDlg2Ddgm(e,t,i){let s=this.icn3dui,n=s.icn3d;if(s.bNode)return;let r,a,o=this,l=s.htmlCls.width2d+20;e===s.pre+"dl_definedsets"?(r="right top",a="Select sets"):e!==s.pre+"dl_2ddgm"&&e!==s.pre+"dl_2dctn"||(r=i?"right top+240":"right top",a=e===s.pre+"dl_2ddgm"?"2D Diagram":"2D Cartoon");let d={my:"left top+"+s.htmlCls.MENU_HEIGHT,at:r,of:"#"+s.pre+"viewer",collision:"none"};window.dialog=$("#"+e).dialog({autoOpen:!0,title:a,height:"auto",width:l,modal:!1,position:d,close:function(e){let t=o.getDialogStatus().status;t.bSelectannotationsInit2||t.bGraph2||t.bLineGraph2||t.bScatterplot2||t.bLigplot2||t.bTable2||t.bAlignmentInit2||n.resizeCanvasCls.resizeCanvas(s.htmlCls.WIDTH,s.htmlCls.HEIGHT,!0)},resize:function(t,i){e==s.pre+"dl_2dctn"&&(n.resizeRatioX=i.size.width/s.htmlCls.width2d,n.resizeRatioY=i.size.height/(s.htmlCls.width2d+70))},resizeStop:function(e,t){n.resizeRatioX=t.size.width/s.htmlCls.width2d,n.resizeRatioY=t.size.height/(s.htmlCls.width2d+70)}}),this.addSaveButton(e),this.addHideButton(e)}openDlgRegular(e,t){let i=this.icn3dui,s=i.icn3d;if(i.bNode)return;let n=400,r=150,a=i.htmlCls.width2d+20,o=this.getDialogStatus().status;if(e===i.pre+"dl_selectannotations"||e===i.pre+"dl_graph"||e===i.pre+"dl_linegraph"||e===i.pre+"dl_scatterplot"||e===i.pre+"dl_ligplot"||e===i.pre+"dl_contactmap"||e===i.pre+"dl_alignerrormap"||e===i.pre+"dl_interactionsorted"||e===i.pre+"dl_alignment"){let l=.5*i.htmlCls.WIDTH-.5*a;if(i.htmlCls.WIDTH>=i.htmlCls.HEIGHT)this.openDlgHalfWindow(e,t,l,!0),(o.bTwoddgmInit2||o.bTwodctnInit2||o.bSetsInit2)&&(s.resizeCanvasCls.resizeCanvas(i.htmlCls.WIDTH-l-a,i.htmlCls.HEIGHT,!0),o.bTwoddgmInit2&&this.openDlg2Ddgm(i.pre+"dl_2ddgm",void 0,o.bSetsInit2),o.bTwodctnInit2&&this.openDlg2Ddgm(i.pre+"dl_2dctn",void 0,o.bSetsInit2),o.bSetsInit2&&this.openDlg2Ddgm(i.pre+"dl_definedsets"));else{s.resizeCanvasCls.resizeCanvas(i.htmlCls.WIDTH,.5*i.htmlCls.HEIGHT,!0),r=.5*i.htmlCls.HEIGHT,n=i.htmlCls.WIDTH;let l={my:"left top",at:"left bottom+32",of:"#"+i.pre+"canvas",collision:"none"};window.dialog=$("#"+e).dialog({autoOpen:!0,title:t,height:r,width:n,modal:!1,position:l,close:function(t){if(!((e!==i.pre+"dl_selectannotations"||o.bAlignmentInit2||o.bGraph2||o.bTable2||o.bLineGraph2||o.bScatterplot2||o.bLigplot2||o.bContactmap2||o.bAlignerrormap2)&&(e!==i.pre+"dl_graph"||o.bSelectannotationsInit2||o.bAlignmentInit2||o.bTable2||o.bLineGraph2||o.bScatterplot2||o.bLigplot2||o.bContactmap2||o.bAlignerrormap2)&&(e!==i.pre+"dl_alignment"||o.bSelectannotationsInit2||o.bGraph2||o.bTable2||o.bLineGraph2||o.bScatterplot2||o.bLigplot2||o.bContactmap2||o.bAlignerrormap2)&&(e!==i.pre+"dl_interactionsorted"||o.bSelectannotationsInit2||o.bGraph2||o.bAlignmentInit2||o.bLineGraph2||o.bScatterplot2||o.bLigplot2||o.bContactmap2||o.bAlignerrormap2)&&(e!==i.pre+"dl_linegraph"||o.bSelectannotationsInit2||o.bGraph2||o.bAlignmentInit2||o.bTable2||o.bScatterplot2||o.bLigplot2||o.bContactmap2||o.bAlignerrormap2)&&(e!==i.pre+"dl_scatterplot"||o.bSelectannotationsInit2||o.bGraph2||o.bAlignmentInit2||o.bTable2||o.bLineGraph2||o.bLigplot2||o.bContactmap2||o.bAlignerrormap2)&&(e!==i.pre+"dl_ligplot"||o.bSelectannotationsInit2||o.bGraph2||o.bAlignmentInit2||o.bTable2||o.bLineGraph2||o.bScatterplot2||o.bContactmap2||o.bAlignerrormap2)&&(e!==i.pre+"dl_contactmap"||o.bSelectannotationsInit2||o.bGraph2||o.bAlignmentInit2||o.bTable2||o.bLineGraph2||o.bScatterplot2||o.bLigplot2||o.bAlignerrormap2)&&(e!==i.pre+"dl_alignerrormap"||o.bSelectannotationsInit2||o.bGraph2||o.bAlignmentInit2||o.bTable2||o.bLineGraph2||o.bScatterplot2||o.bLigplot2||o.bContactmap2)))if(o.bTwoddgmInit2||o.bTwodctnInit2||o.bSetsInit2){let e=i.utilsCls.isMobile()?i.htmlCls.WIDTH:i.htmlCls.WIDTH-a;s.resizeCanvasCls.resizeCanvas(e,i.htmlCls.HEIGHT,!0),o.bTwoddgmInit2&&thisClass.openDlg2Ddgm(i.pre+"dl_2ddgm",void 0,o.bSetsInit2),o.bTwodctnInit2&&thisClass.openDlg2Ddgm(i.pre+"dl_2dctn",void 0,o.bSetsInit2),o.bSetsInit2&&thisClass.openDlg2Ddgm(i.pre+"dl_definedsets")}else s.resizeCanvasCls.resizeCanvas(i.htmlCls.WIDTH,i.htmlCls.HEIGHT,!0)},resize:function(t){if(e==i.pre+"dl_selectannotations")s.annotationCls.hideFixedTitle();else if(e==i.pre+"dl_graph"){let t=$("#"+e).width(),s=$("#"+e).height();d3.select("#"+i.svgid).attr("width",t).attr("height",s)}else if(e==i.pre+"dl_linegraph"||e==i.pre+"dl_scatterplot"||e==i.pre+"dl_ligplot"||e==i.pre+"dl_contactmap"||e==i.pre+"dl_alignerrormap"){let t=o.bTwoddgmInit2||o.bSetsInit2?(i.htmlCls.WIDTH-a)/2:i.htmlCls.WIDTH/2,n=$("#"+e).width()/t;if(e==i.pre+"dl_linegraph"){let e=s.linegraphWidth*n;$("#"+i.linegraphid).attr("width",e)}else if(e==i.pre+"dl_scatterplot"){let e=s.scatterplotWidth*n;$("#"+i.scatterplotid).attr("width",e)}else if(e==i.pre+"dl_ligplot"){let e=s.ligplotWidth*n;$("#"+i.ligplotid).attr("width",e)}else if(e==i.pre+"dl_contactmap"){let e=s.contactmapWidth*n;$("#"+i.contactmapid).attr("width",e)}else if(e==i.pre+"dl_alignerrormap"){let e=s.alignerrormapWidth*n;$("#"+i.alignerrormapid).attr("width",e)}}}}),this.addSaveButton(e),this.addHideButton(e)}}else if(e===i.pre+"dl_2ddgm"||e===i.pre+"dl_2dctn"){let t=0;if(i.htmlCls.WIDTH>=i.htmlCls.HEIGHT)(o.bSelectannotationsInit2||o.bGraph2||o.bLineGraph2||o.bScatterplot2||o.bLigplot2||o.bTable2||o.bAlignmentInit2)&&(t=.5*i.htmlCls.WIDTH-.5*a),s.resizeCanvasCls.resizeCanvas(i.htmlCls.WIDTH-t-a,i.htmlCls.HEIGHT,!0),this.openDlg2Ddgm(e,void 0,o.bSetsInit2);else{let t=i.utilsCls.isMobile()?i.htmlCls.WIDTH:i.htmlCls.WIDTH-a;s.resizeCanvasCls.resizeCanvas(t,.5*i.htmlCls.HEIGHT,!0),this.openDlg2Ddgm(e,.5*i.htmlCls.HEIGHT),this.openDlg2Ddgm(e,.5*i.htmlCls.HEIGHT,o.bSetsInit2)}}else{let l;if(r="auto",n="auto",e===i.pre+"dl_addtrack"?n="50%":e===i.pre+"dl_menupref"&&(n=800,r=500),e===i.pre+"dl_definedsets"){let t=0;if(i.htmlCls.WIDTH>=i.htmlCls.HEIGHT)(o.bSelectannotationsInit2||o.bGraph2||o.bLineGraph2||o.bScatterplot2||o.bLigplot2||o.bTable2||o.bAlignmentInit2)&&(t=.5*i.htmlCls.WIDTH-.5*a),s.resizeCanvasCls.resizeCanvas(i.htmlCls.WIDTH-t-a,i.htmlCls.HEIGHT,!0),this.openDlg2Ddgm(e),o.bTwoddgmInit2&&this.openDlg2Ddgm(i.pre+"dl_2ddgm",void 0,!0),o.bTwodctnInit2&&this.openDlg2Ddgm(i.pre+"dl_2dctn",void 0,!0);else{let t=i.utilsCls.isMobile()?i.htmlCls.WIDTH:i.htmlCls.WIDTH-a;s.resizeCanvasCls.resizeCanvas(t,.5*i.htmlCls.HEIGHT,!0),this.openDlg2Ddgm(e,.5*i.htmlCls.HEIGHT),o.bTwoddgmInit2&&this.openDlg2Ddgm(i.pre+"dl_2ddgm",.5*i.htmlCls.HEIGHT,!0),o.bTwodctnInit2&&this.openDlg2Ddgm(i.pre+"dl_2dctn",.5*i.htmlCls.HEIGHT,!0)}}else i.utilsCls.isMobile()?l={my:"left top",at:"left bottom-50",of:"#"+i.pre+"canvas",collision:"none"}:e===i.pre+"dl_allinteraction"||e===i.pre+"dl_buriedarea"?(l={my:"right top",at:"right top+50",of:"#"+s.divid,collision:"none"},n=700,r=500):l=e===i.pre+"dl_rmsd"||e===i.pre+"dl_legend"?{my:"left bottom",at:"left+20 bottom-20",of:"#"+i.pre+"canvas",collision:"none"}:e===i.pre+"dl_symd"?{my:"left top",at:"right-200 bottom-200",of:"#"+i.pre+"canvas",collision:"none"}:i.cfg.align?{my:"left top",at:"left top+90",of:"#"+i.pre+"canvas",collision:"none"}:e===i.pre+"dl_mmdbafid"?{my:"left top",at:"left top+130",of:"#"+i.pre+"canvas",collision:"none"}:{my:"left top",at:"left top+50",of:"#"+i.pre+"canvas",collision:"none"},window.dialog=$("#"+e).dialog({autoOpen:!0,title:t,height:r,width:n,modal:!1,position:l}),this.addSaveButton(e),this.addHideButton(e)}$(".ui-dialog .ui-button span").removeClass("ui-icon-closethick").addClass("ui-icon-close")}openDlgNotebook(e,t){let i=this.icn3dui,s=i.icn3d;if(i.bNode)return;let n=400,r=150,a=i.htmlCls.width2d+20;e===i.pre+"dl_selectannotations"||e===i.pre+"dl_graph"||e===i.pre+"dl_linegraph"||e===i.pre+"dl_scatterplot"||e===i.pre+"dl_ligplot"||e===i.pre+"dl_contactmap"||e===i.pre+"dl_alignerrormap"||e===i.pre+"dl_interactionsorted"||e===i.pre+"dl_alignment"?($("#"+e).show(),$("#"+e+"_nb").show(),$("#"+e+"_title").html(t),r=.5*i.htmlCls.HEIGHT,n=i.htmlCls.WIDTH,$("#"+e).width(n),$("#"+e).height(r),$("#"+e).resize((function(t){let n=i.htmlCls.WIDTH/2,r=$("#"+e).width()/n;if(e==i.pre+"dl_selectannotations")s.annotationCls.hideFixedTitle();else if(e==i.pre+"dl_graph"){let t=$("#"+e).width(),s=$("#"+e).height();d3.select("#"+i.svgid).attr("width",t).attr("height",s)}else if(e==i.pre+"dl_linegraph"){let e=s.linegraphWidth*r;$("#"+i.linegraphid).attr("width",e)}else if(e==i.pre+"dl_scatterplot"){let e=s.scatterplotWidth*r;$("#"+i.scatterplotid).attr("width",e)}else if(e==i.pre+"dl_ligplot"){let e=s.ligplotWidth*r;$("#"+i.ligplotid).attr("width",e)}else if(e==i.pre+"dl_contactmap"){let e=s.contactmapWidth*r;$("#"+i.contactmapid).attr("width",e)}else if(e==i.pre+"dl_alignerrormap"){let e=s.alignerrormapWidth*r;$("#"+i.alignerrormapid).attr("width",e)}}))):(s.bRender&&($("#"+e).show(),$("#"+e+"_nb").show(),$("#"+e+"_title").html(t)),r="auto",n="auto",e===i.pre+"dl_addtrack"?n="50%":e===i.pre+"dl_2ddgm"||e===i.pre+"dl_2dctn"||e===i.pre+"dl_definedsets"?n=a:e!==i.pre+"dl_allinteraction"&&e!==i.pre+"dl_buriedarea"||(n=700,r=500),$("#"+e).width(n),$("#"+e).height(r))}}class Gl{constructor(e){this.icn3dui=e}setCustomDialogs(){let e=this.icn3dui;if(e.icn3d,e.bNode)return"";return""}getHtmlAlignResidueByResidue(e,t,i){let s=this.icn3dui;s.icn3d;let n="";return n+="All chains will be aligned to the first chain in the comma-separated chain IDs. Each chain ID has the form of PDBID_chain (e.g., 1HHO_A, case sensitive) or UniprotID (e.g., P69905 for AlphaFold structures).<br/><br/>",n+="<b>Chain IDs</b>: "+s.htmlCls.inputTextStr+"id='"+s.pre+e+"' value='P69905,P01942,1HHO_A' size=50><br/><br/>",n+='Each alignment is defined as " | "-separated residue lists in one line. "10-50" means a range of residues from 10 to 50.<br><textarea id=\''+s.pre+t+"' rows='5' style='width: 100%; height: "+s.htmlCls.LOG_HEIGHT+"px; padding: 0px; border: 0px;'>1,5,10-50 | 1,5,10-50\n2,6,11-51 | 1,5,10-50</textarea><br/>",n+=s.htmlCls.buttonStr+i+"'><b>Align Residue by Residue</b></button><br/>",n}addNotebookTitle(e,t,i){let s=this.icn3dui;s.icn3d;let n='<div id="'+s.pre+e+'_nb" style="display:none; background-color:#5C9CCC; width:100%"><span id="'+s.pre+e+'_title" style="color:white; font-weight:bold">'+t+"</span>&nbsp;&nbsp;&nbsp;<div onclick=\"$('#"+s.pre+e+'\').hide(); return false;" class="icn3d-nbclose ui-icon ui-icon-close" title="Close"></div></div>';return i&&(n+='<div id="'+s.pre+e+'_html"></div>'),n}setDialogs(){let e=this.icn3dui,t=e.icn3d;if(e.bNode)return"";let i="",s="#ffff00";e.htmlCls.optionStr="<option value=",i+="\x3c!-- dialog will not be part of the form --\x3e";let n=e.cfg.notebook?"":"icn3d-hidden",r=e.cfg.notebook?"icn3d-hidden":"";i+=e.htmlCls.divStr+"alldialogs' class='"+n+" icn3d-dialog' style='margin-top:12px'>",i+=e.htmlCls.divStr+"dl_2ddgm' class='"+r+" icn3d-dl_2ddgm' style='background-color:white'>",i+=this.addNotebookTitle("dl_2ddgm","2D Diagram",!0),i+="</div>",i+=e.htmlCls.divStr+"dl_2dctn' class='"+r+" icn3d-dl_2dctn' style='background-color:white'>",i+=this.addNotebookTitle("dl_2dctn","2D Cartoon"),e.svgid_ct=e.pre+"icn3d_cartoon";let a='<button class="icn3d-commandTitle" style="-webkit-appearance:button; height:24px;background-color:#DDD;" id="',o="icn3d-node-text";i+=e.htmlCls.divNowrapStr+"Dynamically generated for selected residues. <br>Nodes can be dragged or clicked.</div>",i+=e.htmlCls.divNowrapStr+a+e.svgid_ct+'_svg">SVG</button>'+e.htmlCls.space2,i+=a+e.svgid_ct+'_png">PNG</button>'+e.htmlCls.space2,i+=a+e.svgid_ct+'_json">JSON</button><br>',i+="<b>Label</b>: <select id='"+e.svgid_ct+"_label'>",i+=e.htmlCls.optionStr+"'"+o+"0'>No</option>",i+=e.htmlCls.optionStr+"'"+o+"4'>4px</option>",i+=e.htmlCls.optionStr+"'"+o+"8' selected>8px</option>",i+=e.htmlCls.optionStr+"'"+o+"12'>12px</option>",i+=e.htmlCls.optionStr+"'"+o+"16'>16px</option>",i+=e.htmlCls.optionStr+"'"+o+"24'>24px</option>",i+=e.htmlCls.optionStr+"'"+o+"32'>32px</option>",i+="</select>",i+="</div>",i+="<svg id='"+e.svgid_ct+"' viewBox='0,0,"+e.htmlCls.width2d+","+e.htmlCls.width2d+"'>",i+="</svg>",i+="</div>",i+=e.htmlCls.divStr+"dl_alignment' class='"+r+"' style='background-color:white;'>",i+=this.addNotebookTitle("dl_alignment","Dynamically Calculated Symmetry using SymD"),i+=e.htmlCls.divStr+"symd_info'></div>",i+=e.htmlCls.divStr+"alignseqguide_wrapper'><br>"+e.htmlCls.setHtmlCls.setAlignSequenceGuide()+"</div>",i+=e.htmlCls.divStr+"dl_sequence2' class='icn3d-dl_sequence'>",i+=this.addNotebookTitle("dl_sequence2","Select Residues in Aligned Sequences"),i+="</div>",i+="</div>",i+=e.htmlCls.divStr+"dl_definedsets' class='"+r+"'>",i+=this.addNotebookTitle("dl_definedsets","Defined Sets"),i+=e.htmlCls.divStr+"dl_setsmenu'>",i+="<b>Defined Sets:</b> <br/>",i+="<select id='"+e.pre+"atomsCustom' multiple size='6' style='min-width:130px;'>",i+="</select>",i+="<div style='margin: 6px 0 6px 0;'>"+e.htmlCls.buttonStr+"deletesets'><b>Delete Selected Sets</b></button></div>",i+='        <b>Set Operations</b>: <div style="width:20px; margin-top:6px; display:inline-block;"><span id="'+e.pre+'dl_command_expand" class="ui-icon ui-icon-plus icn3d-expand icn3d-link" style="width:15px;" title="Expand"></span><span id="'+e.pre+'dl_command_shrink" class="ui-icon ui-icon-minus icn3d-shrink icn3d-link" style="display:none; width:15px;" title="Shrink"></span></div><br>',i+="</div>",i+=e.htmlCls.divStr+"dl_command' style='display:none;'>",i+=e.htmlCls.divStr+"dl_setoperations'>",i+="<label for='"+e.pre+"setOr'>"+e.htmlCls.inputRadioStr+"name='"+e.pre+"setOperation' id='"+e.pre+"setOr' checked> Union(or) </label><br/>",i+="<label for='"+e.pre+"setAnd'>"+e.htmlCls.inputRadioStr+"name='"+e.pre+"setOperation' id='"+e.pre+"setAnd'> Intersection(and) </label><br/>",i+="<label for='"+e.pre+"setNot'>"+e.htmlCls.inputRadioStr+"name='"+e.pre+"setOperation' id='"+e.pre+"setNot'> Exclusion(not) </label>",i+="</div><br>",i+=e.htmlCls.setHtmlCls.setAdvanced(),i+="</div>",i+="</div>",i+=e.htmlCls.setHtmlCls.setAdvanced(2),i+=e.htmlCls.divStr+"dl_vastplus' class='"+r+"' style='max-width:500px'>",i+=this.addNotebookTitle("dl_vastplus","Please input PDB ID for VAST+"),i+="Note: <b>VAST+</b> finds other macromolecular structures that have a similar biological unit. To do this, VAST+ takes into consideration the complete set of 3D domains that VAST identified within a query structure, throughout all of its component protein molecules, and finds other macromolecular structures that have a similar set of proteins/3D domains.<br><br>",i+="PDB ID: "+e.htmlCls.inputTextStr+"id='"+e.pre+"vastpluspdbid' value='6VXX' size=8><br>",i+=e.htmlCls.buttonStr+"reload_vastplus'>VAST+</button>",i+="</div>",i+=e.htmlCls.divStr+"dl_vast' class='"+r+"' style='max-width:500px'>",i+=this.addNotebookTitle("dl_vast","Pleaes input chain or PDB file for VAST"),i+="Note: <b>VAST</b> identifies 3D domains (substructures) within each protein structure in the Molecular Modeling Database (MMDB), and then finds other protein structures that have one or more similar 3D domains, using purely geometric criteria. You have two ways to do a VAST search.<br><br>",i+="<b>Option 1</b>, search with your selection (all residues are selected by default) in the loaded structures:<br>",i+='<form data-ncbi-sg-search="true" method=post enctype=multipart/form-data action="https://www.ncbi.nlm.nih.gov/Structure/vast/VSMmdb.cgi" id="'+e.pre+'newvs2" name="newvs2" target="_blank">',i+='<input type=hidden id="'+e.pre+'pdbstr" name="pdbstr">',i+="Searching against: <input type='radio' name='dataset' value='Non-redundant subset' checked> Medium-redundancy Subset of PDB <a href='https://www.ncbi.nlm.nih.gov/Structure/VAST/vasthelp.html#VASTNR' title='Medium-redundancy Subset' target='_blank'>?</a> <input type='radio' name='dataset' value='All'>All of PDB <br>",i+='<input type="submit" id="'+e.pre+'cmdVSMmdb2" name="cmdVSMmdb" value="Submit"></input>',i+="</form><br>",i+="<b>Option 2</b>, search with PDB ID and chain name:<br>",i+="PDB ID: "+e.htmlCls.inputTextStr+"id='"+e.pre+"vastpdbid' value='4N7N' size=8> &nbsp;&nbsp;",i+="Chain Name: "+e.htmlCls.inputTextStr+"id='"+e.pre+"vastchainid' value='A' size=8> <br>",i+=e.htmlCls.buttonStr+"reload_vast'>VAST</button><br><br>",i+="<b>Option 3</b>, search with a PDB file:<br>",i+='<form data-ncbi-sg-search="true" method=post enctype=multipart/form-data action="https://www.ncbi.nlm.nih.gov/Structure/vast/VSMmdb.cgi" id="'+e.pre+'newvs" name="newvs" target="_blank">',i+="PDB File: "+e.htmlCls.inputFileStr+" name='pdbfile' size=8><br>",i+="Searching against: <input type='radio' name='dataset' value='Non-redundant subset' checked> Medium-redundancy Subset of PDB <a href='https://www.ncbi.nlm.nih.gov/Structure/VAST/vasthelp.html#VASTNR' title='Medium-redundancy Subset' target='_blank'>?</a> <input type='radio' name='dataset' value='All'>All of PDB <br>",i+='<input type="submit" id="'+e.pre+'cmdVSMmdb" name="cmdVSMmdb" value="Submit"></input>',i+="</form><br>",i+="</div>",i+=e.htmlCls.divStr+"dl_foldseek' class='"+r+"' style='max-width:500px'>",i+=this.addNotebookTitle("dl_foldseek","Submit your selection to Foldseek"),i+='1. <input type="submit" id="'+e.pre+'fssubmit" name="fssubmit" value="Submit"></input> your selection (all residues are selected by default) in the loaded structures to <a href="https://search.foldseek.com/search" target="_blank">Foldseek</a> web server.<br><br>',i+='2 (Optional). Once you see the structure neighbors, you can view the alignment in iCn3D by inputing a list of PDB chain IDs or AlphaFold UniProt IDs below. <br><br>The PDB chain IDs are the same as the record names such as "1HHO_A". The UniProt ID is the text between "AF-" and "-F1". For example, the UniProt ID for the record name "AF-P69905-F1-model_v4" is "P69905".<br><br>',i+="Chain ID List: "+e.htmlCls.inputTextStr+"id='"+e.pre+"foldseekchainids' value='P69905,P01942,1HHO_A' size=30> ",i+=e.htmlCls.buttonStr+"reload_foldseek'>Align</button>",i+="</div>",i+=e.htmlCls.divStr+"dl_mmtfid' class='"+r+"'>",i+=this.addNotebookTitle("dl_mmtfid","Please input an BCIF/MMTF ID"),i+="BCIF/MMTF ID: "+e.htmlCls.inputTextStr+"id='"+e.pre+"mmtfid' value='1TUP' size=8> ",i+=e.htmlCls.buttonStr+"reload_mmtf'>Load</button>",i+="</div>",i+=e.htmlCls.divStr+"dl_pdbid' class='"+r+"'>",i+=this.addNotebookTitle("dl_pdbid","Please input a PDB ID"),i+="PDB ID: "+e.htmlCls.inputTextStr+"id='"+e.pre+"pdbid' value='1TUP' size=8> ",i+=e.htmlCls.buttonStr+"reload_pdb'>Load</button>",i+="</div>",i+=e.htmlCls.divStr+"dl_afid' class='"+r+"'>",i+=this.addNotebookTitle("dl_afid","Please input an AlphaFold UniProt ID"),i+="Note: AlphaFold produces a per-residue confidence score (pLDDT) between 0 and 100:<br>",i+=e.htmlCls.clickMenuCls.setAlphaFoldLegend()+"<br>";let l=e.cfg.afid?e.cfg.afid:"A4D1S0";i+="<a href='https://alphafold.ebi.ac.uk/' target='_blank'>AlphaFold Uniprot</a> ID: "+e.htmlCls.inputTextStr+"id='"+e.pre+"afid' value='"+l+"' size=10><br><br>",i+=e.htmlCls.buttonStr+"reload_af'>Load Structure</button><br><br>",i+="PAE Map: "+e.htmlCls.buttonStr+"reload_afmap'>Load Half</button>"+e.htmlCls.buttonStr+"reload_afmapfull' style='margin-left:30px'>Load Full (slow)</button>",i+="</div>",i+=e.htmlCls.divStr+"dl_refseqid' class='"+r+"'>",i+=this.addNotebookTitle("dl_refseqid","Please input an NCBI protein accession"),i+="NCBI Protein Accession: "+e.htmlCls.inputTextStr+"id='"+e.pre+"refseqid' value='NP_001743.1' size=8> ",i+=e.htmlCls.buttonStr+"reload_refseq'>Load</button>",i+="</div>",i+=e.htmlCls.divStr+"dl_opmid' class='"+r+"'>",i+=this.addNotebookTitle("dl_opmid","Please input an OPM PDB ID"),i+="<a href='https://opm.phar.umich.edu' target='_blank'>Orientations of Proteins in Membranes(OPM)</a> PDB ID: "+e.htmlCls.inputTextStr+"id='"+e.pre+"opmid' value='6JXR' size=8> ",i+=e.htmlCls.buttonStr+"reload_opm'>Load</button>",i+="</div>",i+=e.htmlCls.divStr+"dl_pdbfile' class='"+r+"'>",i+=this.addNotebookTitle("dl_pdbfile","Please input a PDB file"),i+='Note: Several PDB files could be concatenated into a single PDB file. Use the line "ENDMDL" to separate PDB files.<br><br>',i+="PDB File: "+e.htmlCls.inputFileStr+" id='"+e.pre+"pdbfile' size=8> ",i+=e.htmlCls.buttonStr+"reload_pdbfile'>Load</button>",i+="</div>",i+=e.htmlCls.divStr+"dl_pdbfile_app' class='"+r+"'>",i+=this.addNotebookTitle("dl_pdbfile_app","Please append PDB files"),i+="Multiple PDB Files: <input type='file' multiple id='"+e.pre+"pdbfile_app' size=8> ",i+=e.htmlCls.buttonStr+"reload_pdbfile_app'>Append</button>",i+="</div>",i+=e.htmlCls.divStr+"dl_rescolorfile' class='"+r+"'>",i+=this.addNotebookTitle("dl_rescolorfile","Please input a residue color file"),i+='<div style="width:450px;">The custom JSON file on residue colors has the following format for proteins("ALA" and "ARG") and nucleotides("G" and "A"):<br>',i+='{"ALA":"#C8C8C8", "ARG":"#145AFF", ..., "G":"#008000", "A":"#6080FF", ...}</div><br>',i+="Residue Color File: "+e.htmlCls.inputFileStr+"id='"+e.pre+"rescolorfile' size=8> ",i+=e.htmlCls.buttonStr+"reload_rescolorfile'>Load</button>",i+="</div>",i+=e.htmlCls.divStr+"dl_customcolor' class='"+r+"'>",i+=this.addNotebookTitle("dl_customcolor","Please input a custom color file"),i+=" <input type='hidden' id='"+e.pre+"customcolor_chainid' value=''>",i+='<div style="width:450px;">The custom file for the structure has two columns separated by space or tab: ',i+='residue number, and score in the range of 0-100. If you click "Apply Custom Color" button, ',i+='the scores 0, 50 and 100 correspond to the three colors specified below. If you click "Apply Custom Tube", ',i+='the selected residues will be displayed in a style similar to "B-factor Tube".</div><br>',i+="Custom File: "+e.htmlCls.inputFileStr+"id='"+e.pre+"cstcolorfile' size=8> <br><br>",i+="1. "+e.htmlCls.buttonStr+"reload_customcolorfile'>Apply Custom Color</button>"+e.htmlCls.buttonStr+"remove_legend' style='margin-left:30px;'>Remove Legend</button><br>",i+="<span style='margin-left:15px'>Score to Color: 0:</span> <select id='"+e.pre+"startColor'>",i+=e.htmlCls.optionStr+"'red'>Red</option>",i+=e.htmlCls.optionStr+"'green'>Green</option>",i+=e.htmlCls.optionStr+"'blue' selected>Blue</option>",i+="</select>",i+="<span style='margin-left:30px'>50</span>: <select id='"+e.pre+"midColor'>",i+=e.htmlCls.optionStr+"'white' selected>White</option>",i+=e.htmlCls.optionStr+"'black'>Black</option>",i+="</select>",i+="<span style='margin-left:30px'>100</span>: <select id='"+e.pre+"endColor'>",i+=e.htmlCls.optionStr+"'red' selected>Red</option>",i+=e.htmlCls.optionStr+"'green'>Green</option>",i+=e.htmlCls.optionStr+"'blue'>Blue</option>",i+="</select><br>",i+="or<br><br>",i+="2. "+e.htmlCls.buttonStr+"reload_customtubefile'>Apply Custom Tube</button>",i+="</div>",i+=e.htmlCls.divStr+"dl_customref' class='"+r+"'>",i+=this.addNotebookTitle("dl_customref","Please input a reference number file"),i+='<div style="width:550px;">You can define your own reference numbers in a custom file using Excel, and then export it as a CSV file. An example file is shown below with cells separated by commas.<br>',i+="<pre>refnum,11,12,,21,22,,10C,11C,20C<br>",i+="1TUP_A,100,101,,,132,,,,<br>",i+="1TUP_B,110,111,,141,142,,,,<br>",i+="1TUP_C,,,,,,,200,201,230</pre>",i+='The first row defines the reference residue numbers, which could be any strings. The 1st cell could be anything. The rest cells are reference residue numbers (e.g., 11, 21, 10C, etc.) or empty cells. Each chain has a separate row. The first cell of the second row is the chain ID "1TUP_A". The rest cells are the corresponding real residue numbers for reference residue numbers in the first row. For example, the reference numbers for residues 100, 101, and 132 in the chain 1TUP_A are 11, 12, and 22, respectively. The fourth row shows another set of reference numners for the chain "1TUP_C". It could be a chain from a different structure.<br><br>',i+='To select all residues corresponding to the reference numbers, you can simplay replace ":" with "%" in the <a href="https://www.ncbi.nlm.nih.gov/Structure/icn3d/icn3d.html#selectb" target="_blank">Specification</a>. For example, "%12"  selects the residue 101 in 1TUP_A and the residue 111 in 1TUP_B. ".A%12" has the chain "A" filter and selects the residue 101 in 1TUP_A.<br>',i+="</div><br>",i+="Custom File: "+e.htmlCls.inputFileStr+"id='"+e.pre+"cstreffile' size=8> <br><br>",i+=e.htmlCls.buttonStr+"reload_customreffile'>Apply Custom Reference Numbers</button>",i+="</div>",i+=e.htmlCls.divStr+"dl_align' class='"+r+"'>",i+=this.addNotebookTitle("dl_align","Please select residues in aligned sequences"),i+="Enter the PDB IDs or MMDB IDs of the structures: <br/><br/>ID1: "+e.htmlCls.inputTextStr+"id='"+e.pre+"alignid1' value='2DN3' size=8>"+e.htmlCls.space3+e.htmlCls.space3+"ID2: "+e.htmlCls.inputTextStr+"id='"+e.pre+"alignid2' value='4N7N' size=8><br/><br/>",i+="<b>VAST+ based on VAST</b>: "+e.htmlCls.buttonStr+"reload_align_ori'>All Matching Molecules Superposed</button>"+e.htmlCls.space3+e.htmlCls.buttonStr+"reload_align_refined'>Invariant Substructure Superposed</button><br><br>",i+="<b>VAST+ based on TM-align</b>: "+e.htmlCls.buttonStr+"reload_align_tmalign'>All Matching Molecules Superposed</button><br><br>",i+="</div>",i+=e.htmlCls.divStr+"dl_alignaf' class='"+r+"'>",i+=this.addNotebookTitle("dl_alignaf","Align AlphaFold structures"),i+="Enter two <a href='https://alphafold.ebi.ac.uk/' target='_blank'>AlphaFold Uniprot</a> IDs: <br/><br/>ID1: "+e.htmlCls.inputTextStr+"id='"+e.pre+"alignafid1' value='P41327' size=8>"+e.htmlCls.space3+e.htmlCls.space3+"ID2: "+e.htmlCls.inputTextStr+"id='"+e.pre+"alignafid2' value='P41331' size=8><br/><br/>",i+=e.htmlCls.buttonStr+"reload_alignaf_tmalign'>Align with TM-align</button>"+e.htmlCls.buttonStr+"reload_alignaf' style='margin-left:30px'>Align with VAST</button>",i+="</div>",i+=e.htmlCls.divStr+"dl_chainalign' class='"+r+"'>",i+=this.addNotebookTitle("dl_chainalign","Align chains"),i+="<div style='width:550px'>",i+="All chains will be aligned to the first chain in the comma-separated chain IDs. Each chain ID has the form of PDBID_chain (e.g., 1HHO_A, case sensitive) or UniprotID (e.g., P69905 for AlphaFold structures).<br/><br/>",i+="<b>Chain IDs</b>: "+e.htmlCls.inputTextStr+"id='"+e.pre+"chainalignids' value='P69905,P01942,1HHO_A' size=50><br/><br/>",i+=e.htmlCls.buttonStr+"reload_chainalign_tmalign'><b>Align with TM-align</b></button>"+e.htmlCls.buttonStr+"reload_chainalign_asym' style='margin-left:30px'><b>Align with VAST</b></button><br/><br/>",i+='(Note: To align chains in custom PDB files, you could load them in "File > Open File > PDB Files (appendable)" and click "Analysis > Defined Sets". Finally select multiple chains in Defined Sets and click "File > Realign Selection".)<br><br>',i+="</div></div>",i+=e.htmlCls.divStr+"dl_chainalign2' class='"+r+"'>",i+=this.addNotebookTitle("dl_chainalign2","Align chains"),i+="<div style='width:550px'>",i+="All chains will be aligned to the first chain in the comma-separated chain IDs. Each chain ID has the form of PDBID_chain (e.g., 1HHO_A, case sensitive) or UniprotID (e.g., P69905 for AlphaFold structures).<br/><br/>",i+="<b>Chain IDs</b>: "+e.htmlCls.inputTextStr+"id='"+e.pre+"chainalignids2' value='P69905,P01942,1HHO_A' size=50><br/><br/>",i+="The sequence alignment (followed by structure alignment) is based on residue numbers in the First/Master chain: <br>"+e.htmlCls.inputTextStr+"id='"+e.pre+"resalignids' value='1,5,10-50' size=50><br/>",i+=e.htmlCls.buttonStr+"reload_chainalign_asym2' style='margin-top:3px;'><b>Align by Sequence Alignment</b></button><br/><br/>",i+='(Note: To align chains in custom PDB files, you could load them in "File > Open File > PDB Files (appendable)" and click "Analysis > Defined Sets". Finally select multiple chains in Defined Sets and click "File > Realign Selection".)<br><br>',i+="</div></div>",i+=e.htmlCls.divStr+"dl_chainalign3' class='"+r+"'>",i+=this.addNotebookTitle("dl_chainalign3","Align chains"),i+="<div style='width:550px'>",i+=this.getHtmlAlignResidueByResidue("chainalignids3","predefinedres","reload_chainalign_asym3"),i+="</div></div>",i+=e.htmlCls.divStr+"dl_realignresbyres' class='"+r+"'>",i+=this.addNotebookTitle("dl_realignresbyres","Realign residue by residue"),i+="<div style='width:550px'>",i+="<b>Option 1</b>: "+e.htmlCls.buttonStr+"realignSelection'><b>Realign Current Selection Residue by Residue</b></button><br/><br/>",i+="<b>Option 2</b>: <br>",i+="<div class='icn3d-box'>"+this.getHtmlAlignResidueByResidue("chainalignids4","predefinedres2","reload_chainalign_asym4")+"</div>",i+="</div></div>",i+=e.htmlCls.divStr+"dl_mutation' class='"+r+"'>",i+=this.addNotebookTitle("dl_mutation","Mutation analysis"),i+="<div style='width:500px'>",i+='Please specify the mutations with a comma separated mutation list. Each mutation can be specified as "[<b>uppercase</b> PDB ID or AlphaFold UniProt ID]_[Chain Name]_[Residue Number]_[One Letter Mutant Residue]". E.g., the mutation of N501Y in the E chain of PDB 6M0J can be specified as "6M0J_E_501_Y". For AlphaFold structures, the "Chain ID" is "A".<br/>If you load a custom structure without PDB or UniProt ID, you can open "Seq. & Annotations" window and find the chain ID such as "stru_A". The part before the underscore is the structure ID, which can be used to specify the mutation such as "stru_A_...". Remember to choose "Show Mutation in: Current Page".<br/><br/>',i+="<div style='display:inline-block; width:110px'>Mutations: </div>"+e.htmlCls.inputTextStr+"id='"+e.pre+"mutationids' value='6M0J_E_484_K,6M0J_E_501_Y,6M0J_E_417_N' size=50><br/><br/>",i+="<b>ID Type</b>: ",i+='<input type="radio" name="'+e.pre+'idsource" id="'+e.pre+'type_mmdbid" value="mmdbid" checked>PDB ID',i+='<input type="radio" name="'+e.pre+'idsource" id="'+e.pre+'type_afid" value="afid" style="margin-left:20px">AlphaFold UniProt ID<br><br>',i+="<b>Show Mutation in</b>: ",i+='<input type="radio" name="'+e.pre+'pdbsource" id="'+e.pre+'showin_currentpage" value="currentpage">Current Page',i+='<input type="radio" name="'+e.pre+'pdbsource" id="'+e.pre+'showin_newpage" value="newpage" style="margin-left:20px" checked>New Page<br><br>',i+=e.htmlCls.buttonStr+"reload_mutation_3d' title='Show the mutations in 3D using the scap program'>3D with scap</button>",i+=e.htmlCls.buttonStr+"reload_mutation_inter' style='margin-left:20px' title='Show the mutations in 3D and the change of interactions'>Interactions</button>",i+=e.htmlCls.buttonStr+"reload_mutation_pdb' style='margin-left:20px' title='Show the mutations in 3D and export the PDB of the mutant within 10 angstrom'>PDB</button>",i+="<br/><br/></div></div>",i+=e.htmlCls.divStr+"dl_mol2file' class='"+r+"'>",i+=this.addNotebookTitle("dl_mol2file","Please input a Mol2 file"),i+="Mol2 File: "+e.htmlCls.inputFileStr+"id='"+e.pre+"mol2file' size=8> ",i+=e.htmlCls.buttonStr+"reload_mol2file'>Load</button>",i+="</div>",i+=e.htmlCls.divStr+"dl_sdffile' class='"+r+"'>",i+=this.addNotebookTitle("dl_sdffile","Please input an SDF file"),i+="SDF File: "+e.htmlCls.inputFileStr+"id='"+e.pre+"sdffile' size=8> ",i+=e.htmlCls.buttonStr+"reload_sdffile'>Load</button>",i+="</div>",i+=e.htmlCls.divStr+"dl_xyzfile' class='"+r+"'>",i+=this.addNotebookTitle("dl_xyzfile","Please input an XYZ file"),i+="XYZ File: "+e.htmlCls.inputFileStr+"id='"+e.pre+"xyzfile' size=8> ",i+=e.htmlCls.buttonStr+"reload_xyzfile'>Load</button>",i+="</div>",i+=e.htmlCls.divStr+"dl_clustalwfile' class='"+r+"' style='max-width:500px'>",i+=this.addNotebookTitle("dl_clustalwfile","Please input a CLUSTALW MSA file"),i+="Note the sequence names are either UniProt ID (e.g., A4D1S0 or A4D1S0_A), RefSeq ID (e.g., NP_001743), or PDB chain ID (e.g., 1HHO_A).<br><br>",i+="CLUSTALW File: "+e.htmlCls.inputFileStr+"id='"+e.pre+"clustalwfile' size=8> ",i+=e.htmlCls.buttonStr+"reload_clustalwfile'>Load</button><br>",i+="</div>",i+=e.htmlCls.divStr+"dl_fastafile' class='"+r+"' style='max-width:500px'>",i+=this.addNotebookTitle("dl_fastafile","Please input a FASTA file"),i+='Note the sequence IDs following the symbol ">" contain either UniProt ID (e.g., sp| or tr|), RefSeq ID (e.g., ref|), PDB chain ID (e.g., pdb|1HHO|A), or iCn3D chain ID (e.g., A4D1S0_A, 1HHO_A).<br><br>',i+="FASTA File: "+e.htmlCls.inputFileStr+"id='"+e.pre+"fastafile' size=8> ",i+=e.htmlCls.buttonStr+"reload_fastafile'>Load</button><br>",i+="</div>",i+=e.htmlCls.divStr+"dl_afmapfile' class='"+r+"'>",i+=this.addNotebookTitle("dl_afmapfile","Please input an AlphaFold PAE file"),i+="AlphaFold PAE File: "+e.htmlCls.inputFileStr+"id='"+e.pre+"afmapfile' size=8> <br><br>",i+=e.htmlCls.buttonStr+"reload_afmapfile'>Load Half PAE Map</button>"+e.htmlCls.buttonStr+"reload_afmapfilefull' style='margin-left:30px'>Load Full PAE Map (slow)</button>",i+="</div>",i+=e.htmlCls.divStr+"dl_urlfile' class='"+r+"'>",i+=this.addNotebookTitle("dl_urlfile","Please input a file via URL"),i+="File type: ",i+="<select id='"+e.pre+"filetype'>",i+=e.htmlCls.optionStr+"'pdb' selected>PDB</option>",i+=e.htmlCls.optionStr+"'mmcif'>mmCIF</option>",i+=e.htmlCls.optionStr+"'mol2'>Mol2</option>",i+=e.htmlCls.optionStr+"'sdf'>SDF</option>",i+=e.htmlCls.optionStr+"'xyz'>XYZ</option>",i+=e.htmlCls.optionStr+"'icn3dpng'>iCn3D PNG</option>",i+=e.htmlCls.optionStr+"'pae'>AlphaFold PAE</option>",i+="</select><br/>",i+="URL in the same host: "+e.htmlCls.inputTextStr+"id='"+e.pre+"urlfile' size=20><br/> ",i+=e.htmlCls.buttonStr+"reload_urlfile'>Load</button>",i+="</div>",i+=e.htmlCls.divStr+"dl_mmciffile' class='"+r+"'>",i+=this.addNotebookTitle("dl_mmciffile","Please append mmCIF files"),i+="Multiple mmCIF Files: <input type='file' multiple id='"+e.pre+"mmciffile' size=8> ",i+=e.htmlCls.buttonStr+"reload_mmciffile'>Load</button>",i+="</div>",i+=e.htmlCls.divStr+"dl_mmcifid' class='"+r+"'>",i+=this.addNotebookTitle("dl_mmcifid","Please input an mmCIF ID"),i+="mmCIF ID: "+e.htmlCls.inputTextStr+"id='"+e.pre+"mmcifid' value='1TUP' size=8> ",i+=e.htmlCls.buttonStr+"reload_mmcif'>Load</button>",i+="</div>",i+=e.htmlCls.divStr+"dl_mmdbid' class='"+r+"' style='max-width:500px'>",i+=this.addNotebookTitle("dl_mmdbid","Please input an MMDB ID"),i+="MMDB or PDB ID: "+e.htmlCls.inputTextStr+"id='"+e.pre+"mmdbid' value='1TUP' size=8> <br><br>",i+=e.htmlCls.buttonStr+"reload_mmdb'>Load Biological Unit</button>"+e.htmlCls.buttonStr+"reload_mmdb_asym' style='margin-left:30px'>Load Asymmetric Unit (All Chains)</button><br/><br/><br/>",i+='<b>Note</b>: The "<b>biological unit</b>" is the <b>biochemically active form of a biomolecule</b>, <div style="width:20px; margin:6px 0 0 20px; display:inline-block;"><span id="'+e.pre+'asu_bu_expand" class="ui-icon ui-icon-plus icn3d-expand icn3d-link" style="width:15px;" title="Expand"></span><span id="'+e.pre+'asu_bu_shrink" class="ui-icon ui-icon-minus icn3d-shrink icn3d-link" style="display:none; width:15px;" title="Shrink"></span></div>',i+=e.htmlCls.divStr+"asu_bu' style='display:none;'>",i+='which can range from a monomer (single protein molecule) to an oligomer of 100+ protein molecules.<br><br>The "<b>asymmetric unit</b>" is the raw 3D structure data resolved by X-ray crystallography, NMR, or Cryo-electron microscopy. The asymmetric unit is equivalent to the biological unit in approximately 60% of structure records. In the remaining 40% of the records, the asymmetric unit represents a portion of the biological unit that can be reconstructed using crystallographic symmetry, or it represents multiple copies of the biological unit.</div>',i+="</div>",i+=e.htmlCls.divStr+"dl_mmdbafid' class='"+r+"' style='max-width:600px'>",i+=this.addNotebookTitle("dl_mmdbafid","Please input a list of PDB/AlphaFold IDs"),i+="List of PDB, MMDB, or AlphaFold UniProt structures: "+e.htmlCls.inputTextStr+"id='"+e.pre+"mmdbafid' placeholder='e.g., 1HHO,4N7N,P69905,P01942' size=30> <br><br>",i+="<div style='display:inline-block; width:20px'></div>"+e.htmlCls.buttonStr+"reload_mmdbaf' style='width:150px'>Load Biological Unit</button>"+e.htmlCls.buttonStr+"reload_mmdbaf_asym' style='margin-left:30px; width:250px'>Load Asymmetric Unit (All Chains)</button><br/><br/>",i+="<div style='display:inline-block; width:20px'>or</div>"+e.htmlCls.buttonStr+"reload_mmdbaf_append' style='width:150px'>Append Biological Unit</button>"+e.htmlCls.buttonStr+"reload_mmdbaf_asym_append' style='margin-left:30px; width:250px'>Append Asymmetric Unit (All Chains)</button><br/><br/>",i+='<b>Note</b>: The "<b>biological unit</b>" is the <b>biochemically active form of a biomolecule</b>, <div style="width:20px; margin:6px 0 0 20px; display:inline-block;"><span id="'+e.pre+'asu_bu2_expand" class="ui-icon ui-icon-plus icn3d-expand icn3d-link" style="width:15px;" title="Expand"></span><span id="'+e.pre+'asu_bu2_shrink" class="ui-icon ui-icon-minus icn3d-shrink icn3d-link" style="display:none; width:15px;" title="Shrink"></span></div>',i+=e.htmlCls.divStr+"asu_bu2' style='display:none;'>",i+='which can range from a monomer (single protein molecule) to an oligomer of 100+ protein molecules.<br><br>The "<b>asymmetric unit</b>" is the raw 3D structure data resolved by X-ray crystallography, NMR, or Cryo-electron microscopy. The asymmetric unit is equivalent to the biological unit in approximately 60% of structure records. In the remaining 40% of the records, the asymmetric unit represents a portion of the biological unit that can be reconstructed using crystallographic symmetry, or it represents multiple copies of the biological unit.</div>',i+="</div>",i+=e.htmlCls.divStr+"dl_blast_rep_id' style='max-width:600px;' class='"+r+"'>",i+=this.addNotebookTitle("dl_blast_rep_id","Align sequence to structure"),i+="Enter a protein sequence ID (or FASTA sequence) and the aligned protein accession, which can be found using the <a href='https://blast.ncbi.nlm.nih.gov/Blast.cgi?PROGRAM=blastp&PAGE_TYPE=BlastSearch' target='_blank'>BLAST</a> search with the protein sequence ID or FASTA sequence as input. If the protein accession is not a PDB chain, the corresponding AlphaFold UniProt structure is used.<br><br> ",i+="<b>Protein Sequence ID</b>(NCBI protein accession of a sequence): "+e.htmlCls.inputTextStr+"id='"+e.pre+"query_id' value='NP_001108451.1' size=8><br> ",i+="or FASTA sequence: <br><textarea id='"+e.pre+"query_fasta' rows='5' style='width: 100%; height: "+e.htmlCls.LOG_HEIGHT+"px; padding: 0px; border: 0px;'></textarea><br><br>",i+="<b>Aligned Protein Accession</b> (or a chain of a PDB): "+e.htmlCls.inputTextStr+"id='"+e.pre+"blast_rep_id' value='1TSR_A' size=8><br> ",i+=e.htmlCls.buttonStr+"reload_blast_rep_id'>Align with BLAST</button> "+e.htmlCls.wifiStr+e.htmlCls.buttonStr+"reload_alignsw' style='margin-left:30px'>Align with Global Smith-Waterman</button>"+e.htmlCls.buttonStr+"reload_alignswlocal' style='margin-left:30px'>Align with Local Smith-Waterman</button>",i+="</div>",i+=e.htmlCls.divStr+"dl_esmfold' style='max-width:600px;' class='"+r+"'>",i+=this.addNotebookTitle("dl_esmfold","Sequence to structure prediction with ESMFold"),i+="The sequence to structure prediction is done via <a href='https://esmatlas.com/resources?action=fold' target='_blank'>ESM Metagenomic Atlas</a>. The sequence should be less than 400 characters. For any sequence longer than 400, please see the discussion <a href='https://github.com/facebookresearch/esm/issues/21' target='_blank'>here</a>.<br><br> ",i+="FASTA sequence: <br><textarea id='"+e.pre+"esmfold_fasta' rows='5' style='width: 100%; height: "+e.htmlCls.LOG_HEIGHT+"px; padding: 0px; border: 0px;'></textarea><br><br>",i+=e.htmlCls.buttonStr+"run_esmfold'>ESMFold</button> ",i+="</div>",i+=e.htmlCls.divStr+"dl_yournote' class='"+r+"'>",i+=this.addNotebookTitle("dl_yournote","Your Note"),i+='Your note will be saved in the HTML file when you click "File > Save File > iCn3D PNG Image".<br><br>',i+="<textarea id='"+e.pre+"yournote' rows='5' style='width: 100%; height: "+e.htmlCls.LOG_HEIGHT+"px; padding: 0px; border: 0px;' placeholder='Enter your note here'></textarea><br>",i+=e.htmlCls.buttonStr+"applyyournote'>Save</button>",i+="</div>",i+=e.htmlCls.divStr+"dl_proteinname' class='"+r+"'>",i+=this.addNotebookTitle("dl_proteinname","Please input a protein/gene name"),i+="Protein/Gene name: "+e.htmlCls.inputTextStr+"id='"+e.pre+"proteinname' value='TP53' size=8> ",i+=e.htmlCls.buttonStr+"reload_proteinname'>Search</button>",i+="</div>",i+=e.htmlCls.divStr+"dl_cid' class='"+r+"'>",i+=this.addNotebookTitle("dl_cid","Please input a PubChem Compound"),i+="PubChem CID/Name/InchI: "+e.htmlCls.inputTextStr+"id='"+e.pre+"cid' value='2244' size=8> ",i+=e.htmlCls.buttonStr+"reload_cid'>Load</button>",i+="</div>",i+=e.htmlCls.divStr+"dl_smiles' class='"+r+"'>",i+=this.addNotebookTitle("dl_cid","Please input a chemical SMILES"),i+="Chemical SMILES: "+e.htmlCls.inputTextStr+"id='"+e.pre+"smiles' value='CC(=O)OC1=CC=CC=C1C(=O)O' size=30> ",i+=e.htmlCls.buttonStr+"reload_smiles'>Load</button>",i+="</div>",i+=e.htmlCls.divStr+"dl_pngimage' class='"+r+"'>",i+=this.addNotebookTitle("dl_pngimage","Please append iCn3D PNG Image files"),i+="Multiple iCn3D PNG images: "+e.htmlCls.inputFileStr+" multiple id='"+e.pre+"pngimage' size=8><br/>",i+=e.htmlCls.buttonStr+"reload_pngimage' style='margin-top: 6px;'>Append</button>",i+="</div>",i+=e.htmlCls.divStr+"dl_state' class='"+r+"'>",i+=this.addNotebookTitle("dl_state","Please input a state file"),i+="State file: "+e.htmlCls.inputFileStr+"id='"+e.pre+"state'><br/>",i+=e.htmlCls.buttonStr+"reload_state' style='margin-top: 6px;'>Load</button>",i+="</div>",i+=e.htmlCls.divStr+"dl_bcfviewpoint' class='"+r+"'>",i+=this.addNotebookTitle("dl_bcfviewpoint","Please input a BCF viewpoint file"),i+="BCF viewpoint file: "+e.htmlCls.inputFileStr+"id='"+e.pre+"bcfviewpoint'><br/>",i+=e.htmlCls.buttonStr+"reload_bcfviewpoint' style='margin-top: 6px;'>Load</button>",i+="</div>",i+=e.htmlCls.divStr+"dl_video' class='"+r+"'>",i+=this.addNotebookTitle("dl_video","Save canvas changes in a video"),i+="State file: "+e.htmlCls.inputFileStr+"id='"+e.pre+"state'><br/>",i+=e.htmlCls.buttonStr+"video_start' style='margin-top: 6px;'>Video Start</button>",i+=e.htmlCls.buttonStr+"video_end' style='margin: 6px 0px 0px 30px;'>Video End</button>",i+="</div>",i+=e.htmlCls.divStr+"dl_fixedversion' style='max-width:500px' class='"+r+"'>",i+=this.addNotebookTitle("dl_fixedversion","Use fixed version of iCn3D"),i+='Since January 6, 2021, you can show the original view with the archived version of iCn3D by pasting your URL below and click "Show Originial View". Note the version in the parameter "v" was used to replace "full.html" with "full_[v].html" in the URL.<br><br>',i+="Share Link URL: "+e.htmlCls.inputTextStr+"id='"+e.pre+"sharelinkurl' size=60><br>",i+=e.htmlCls.buttonStr+"reload_fixedversion'>Show Original View</button><br><br>",i+="</div>",i+=e.htmlCls.divStr+"dl_selection' class='"+r+"'>",i+=this.addNotebookTitle("dl_selection","Please input the selection file"),i+="Selection file: "+e.htmlCls.inputFileStr+"id='"+e.pre+"selectionfile'><br/>",i+=e.htmlCls.buttonStr+"reload_selectionfile' style='margin-top: 6px;'>Load</button>",i+="</div>",i+=e.htmlCls.divStr+"dl_selectCollections' class='"+r+"'>",i+=e.htmlCls.divStr+"dl_collectionsMenu'>",i+='<b>Collection File</b>: <div style="width:20px; margin-top:6px; display:inline-block;"><span id="'+e.pre+'dl_collection_file_expand" class="ui-icon ui-icon-plus icn3d-expand icn3d-link" style="display:none; width:15px;" title="Expand"></span><span id="'+e.pre+'dl_collection_file_shrink" class="ui-icon ui-icon-minus icn3d-shrink icn3d-link" style="width:15px;" title="Shrink"></span></div><br>',i+=e.htmlCls.divStr+"dl_collection_file' style=''>",i+="You can load a collection of structures via a file. Here are <a href='https://github.com/ncbi/icn3d/blob/master/example/collection/' target='_blank'>some example files</a><br><br>",i+="Collection file: "+e.htmlCls.inputFileStr+"id='"+e.pre+"collectionfile'><br/>",i+="<input type='radio' id='dl_collectionAppendStructureNone' name='appendStructure' value='none' checked/>",i+="<label for='dl_collectionAppendStructureNone'>Default</label>",i+="<input type='radio' id='dl_collectionAppendStructure' name='appendStructure' value='append' />",i+="<label for='dl_collectionAppendStructure'>Append</label><br/>",i+=e.htmlCls.buttonStr+"reload_collectionfile' style='margin-top: 6px;'>Load</button>",i+="</div>",i+="</div>",i+='<br/><b>Structures</b>: <div style="width:20px; margin-top:6px; display:inline-block;"><span id="'+e.pre+'dl_collection_structures_expand" class="ui-icon ui-icon-plus icn3d-expand icn3d-link" style="width:15px;" title="Expand"></span><span id="'+e.pre+'dl_collection_structures_shrink" class="ui-icon ui-icon-minus icn3d-shrink icn3d-link" style="display:none; width:15px;" title="Shrink"></span></div><br>',i+=e.htmlCls.divStr+"dl_collection_structures' style='display: none'>",i+="<select id='"+e.pre+"collections_menu'multiple size='6' style='min-width:300px;'></select>",i+="<br/>",i+=e.htmlCls.buttonStr+"collections_clear_commands' style='margin-top: 6px;'>Clear Commands</button>",i+=e.htmlCls.buttonStr+"opendl_export_collections'>Export JSON</button>",i+="</div>",i+="<br/>",i+="</div>",i+=e.htmlCls.divStr+"dl_export_collections' class='"+r+"'>",i+=this.addNotebookTitle("dl_export_collections","Export Collections"),i+="<label for='dl_collectionTitle'>Collection Title: </label>",i+="<input type='text' id='dl_collectionTitle' name='collectionTitle' placeholder='Enter collection title' />",i+="<br/>",i+="<label for='dl_collectionDescription'>Collection Description: </label>",i+="<input type='text' id='dl_collectionDescription' name='collectionDescription' placeholder='Enter collection description' />",i+="<br/>",i+="<input type='radio' id='dl_collectionExportSelected' name='exportOption' value='selected' />",i+="<label for='dl_collectionExportSelected'>Selected</label>",i+="<input type='radio' id='dl_collectionExportAll' name='exportOption' value='all' />",i+="<label for='dl_collectionExportAll'>All</label>",i+="<br/>",i+=e.htmlCls.buttonStr+"export_collections'>Export</button>",i+="</div>",i+=e.htmlCls.divStr+"dl_menuloadpref' class='"+r+"'>",i+=this.addNotebookTitle("dl_menuloadpref","Load a preference file"),i+="Preference file: "+e.htmlCls.inputFileStr+"id='"+e.pre+"menupreffile'><br/>",i+=e.htmlCls.buttonStr+"reload_menupreffile' style='margin-top: 6px;'>Load</button>",i+="</div>",i+=e.htmlCls.divStr+"dl_dsn6' class='"+r+"' style='max-width:600px'>",i+=this.addNotebookTitle("dl_dsn6","Load a map file"),i+="<b>Note</b>: Always load a PDB file before loading map files. If you don't specify the threshold below, a default one will be chosen.<br/><br/><br/>",i+="<span style='white-space:nowrap;font-weight:bold;'>2fofc contour at default threshold or at: "+e.htmlCls.inputTextStr+"id='"+e.pre+"dsn6sigma2fofc' value='' size=8> &sigma;</span><br/>",i+=e.htmlCls.inputFileStr+"id='"+e.pre+"dsn6file2fofc'><br>"+e.htmlCls.buttonStr+"reload_ccp4file2fofc' style='margin: 6px 20px 0 0;'>Load CCP4</button>"+e.htmlCls.buttonStr+"reload_mtzfile2fofc' style='margin: 6px 20px 0 0;'>Load MTZ</button>"+e.htmlCls.buttonStr+"reload_rcsbmtzfile2fofc' style='margin-top: 6px;'>Load RCSB MTZ</button><br><br><br/>",i+="<span style='white-space:nowrap;font-weight:bold;'>fofc contour at default threshold or at: "+e.htmlCls.inputTextStr+"id='"+e.pre+"dsn6sigmafofc' value='' size=8> &sigma;</span><br/>",i+=e.htmlCls.inputFileStr+"id='"+e.pre+"dsn6filefofc'><br>"+e.htmlCls.buttonStr+"reload_ccp4filefofc' style='margin: 6px 20px 0 0;'>Load CCP4</button>"+e.htmlCls.buttonStr+"reload_mtzfilefofc' style='margin: 6px 20px 0 0;'>Load MTZ</button>"+e.htmlCls.buttonStr+"reload_rcsbmtzfilefofc' style='margin-top: 6px;'>Load RCSB MTZ</button><br><br><br>",i+=e.htmlCls.buttonStr+"elecmapNo4'>Remove Map</button><br>",i+="</div>",i+=e.htmlCls.divStr+"dl_dsn6url' class='"+r+"' style='max-width:600px'>",i+=this.addNotebookTitle("dl_dsn6url","Load a selection file via a URL"),i+="<b>Note</b>: Always load a PDB file before loading map files. If you don't specify the threshold below, a default one will be chosen.<br/><br/><br/>",i+="<span style='white-space:nowrap;font-weight:bold;'>2fofc contour at default threshold or at: "+e.htmlCls.inputTextStr+"id='"+e.pre+"dsn6sigmaurl2fofc' value='' size=8> &sigma;</span><br/>",i+="URL in the same host: "+e.htmlCls.inputTextStr+"id='"+e.pre+"dsn6fileurl2fofc' size=20><br>"+e.htmlCls.buttonStr+"reload_ccp4fileurl2fofc' style='margin: 6px 20px 0 0;'>Load CCP4</button>"+e.htmlCls.buttonStr+"reload_mtzfileurl2fofc' style='margin: 6px 20px 0 0;'>Load MTZ</button>"+e.htmlCls.buttonStr+"reload_rcsbmtzfileurl2fofc' style='margin-top: 6px;'>Load RCSB MTZ</button><br><br><br/>",i+="<span style='white-space:nowrap;font-weight:bold;'>fofc contour at default threshold or at: "+e.htmlCls.inputTextStr+"id='"+e.pre+"dsn6sigmaurlfofc' value='' size=8> &sigma;</span><br/>",i+="URL in the same host: "+e.htmlCls.inputTextStr+"id='"+e.pre+"dsn6fileurlfofc' size=20><br>"+e.htmlCls.buttonStr+"reload_ccp4fileurlfofc' style='margin: 6px 20px 0 0;'>Load CCP4</button>"+e.htmlCls.buttonStr+"reload_mtzfileurlfofc' style='margin: 6px 20px 0 0;'>Load MTZ</button>"+e.htmlCls.buttonStr+"reload_rcsbmtzfileurlfofc' style='margin-top: 6px;'>Load RCSB MTZ</button><br><br><br>",i+=e.htmlCls.buttonStr+"elecmapNo5'>Remove Map</button><br>",i+="</div>",i+=e.htmlCls.divStr+"dl_clr' class='"+r+"'>",i+=this.addNotebookTitle("dl_clr","Pick a color"),i+="Click in the input box to use the color picker:<br><br> ",i+="Custom Color: "+e.htmlCls.inputTextStr+"id='"+e.pre+"colorcustom' value='FF0000' size=8> ",i+=e.htmlCls.buttonStr+"applycustomcolor'>Apply</button>",i+="</div>",i+=e.htmlCls.setHtmlCls.getPotentialHtml("delphi",r),i+=e.htmlCls.setHtmlCls.getPotentialHtml("local",r),i+=e.htmlCls.setHtmlCls.getPotentialHtml("url",r),i+=e.htmlCls.divStr+"dl_symmetry' class='"+r+"'><br>",i+=this.addNotebookTitle("dl_symmetry","Symmetry"),i+=e.htmlCls.divNowrapStr+"Symmetry: <select id='"+e.pre+"selectSymmetry'>",i+="</select>"+e.htmlCls.space3,i+=e.htmlCls.buttonStr+"applysymmetry'>Apply</button>"+e.htmlCls.space3,i+=e.htmlCls.buttonStr+"clearsymmetry'>Clear</button></div>",i+="</div>",i+=e.htmlCls.divStr+"dl_symd' style='max-width:400px' class='"+r+"'><br>",i+=this.addNotebookTitle("dl_symd","Dynamically symmetry calculation using SymD"),i+="</div>",i+=e.htmlCls.divStr+"dl_contact' class='"+r+"'>",i+=this.addNotebookTitle("dl_contact","Contact Map"),i+="<span style='white-space:nowrap;font-weight:bold;'>Distance: <select id='"+e.pre+"contactdist'>",i+=e.htmlCls.setHtmlCls.getOptionHtml(["4","5","6","7","8","9","10"],4),i+="</select></span>",i+="<span style='margin-left:30px; white-space:nowrap;font-weight:bold;'>Contact Type: <select id='"+e.pre+"contacttype'>",i+=e.htmlCls.optionStr+"'calpha' >between C-alpha Atoms</option>",i+=e.htmlCls.optionStr+"'cbeta' selected>between C-beta Atoms</option>",i+=e.htmlCls.optionStr+"'heavyatoms' >between Heavy Atoms</option>",i+="</select></span><br><br>",i+="<span style='white-space:nowrap;'>"+e.htmlCls.buttonStr+"applycontactmap'>Display</button></span><br>",i+="</div>",i+=e.htmlCls.divStr+"dl_hbonds' class='"+r+"'>",i+=this.addNotebookTitle("dl_hbonds","Interaction Analysis"),i+="1. Choose interaction types and their thresholds:<br>",i+="<div class='icn3d-box'><table border=0 width=450><tr>",i+="<td style='white-space:nowrap'>"+e.htmlCls.inputCheckStr+"id='"+e.pre+"analysis_hbond' checked>Hydrogen Bonds <span style='background-color:#"+e.htmlCls.hbondColor+"'>"+e.htmlCls.space3+"</span></td>",i+="<td>",i+=e.htmlCls.divNowrapStr+" <select id='"+e.pre+"hbondthreshold'>";let d=["3.2","3.3","3.4","3.5","3.6","3.7","3.8","3.9","4.0","4.1","4.2"];i+=e.htmlCls.setHtmlCls.getOptionHtml(d,6),i+="</select> &#197;"+e.htmlCls.space3+"</div></td>",i+="<td style='white-space:nowrap'>"+e.htmlCls.inputCheckStr+"id='"+e.pre+"analysis_saltbridge' checked>Salt Bridge/Ionic <span style='background-color:#"+e.htmlCls.ionicColor+"'>"+e.htmlCls.space3+"</span></td>",i+="<td>",i+=e.htmlCls.divNowrapStr+" <select id='"+e.pre+"saltbridgethreshold'>";let c=["3","4","5","6","7","8"];i+=e.htmlCls.setHtmlCls.getOptionHtml(c,3),i+="</select> &#197;"+e.htmlCls.space3+"</div></td>",i+="<td style='white-space:nowrap'>"+e.htmlCls.inputCheckStr+"id='"+e.pre+"analysis_contact' checked>Contacts/Interactions <span style='background-color:#"+e.htmlCls.contactColor+"'>"+e.htmlCls.space3+"</span></td>",i+="<td>",i+=e.htmlCls.divNowrapStr+" <select id='"+e.pre+"contactthreshold'>",i+=e.htmlCls.setHtmlCls.getOptionHtml(c,1),i+="</select> &#197;"+e.htmlCls.space3+"</div></td>",i+="</tr>",i+="<tr>",i+="<td style='white-space:nowrap'>"+e.htmlCls.inputCheckStr+"id='"+e.pre+"analysis_halogen' checked>Halogen Bonds <span style='background-color:#"+e.htmlCls.halogenColor+"'>"+e.htmlCls.space3+"</span></td>",i+="<td>",i+=e.htmlCls.divNowrapStr+" <select id='"+e.pre+"halogenthreshold'>",i+=e.htmlCls.setHtmlCls.getOptionHtml(d,6),i+="</select> &#197;"+e.htmlCls.space3+"</div></td>",i+="<td style='white-space:nowrap'>"+e.htmlCls.inputCheckStr+"id='"+e.pre+"analysis_pication' checked>&pi;-Cation <span style='background-color:#"+e.htmlCls.picationColor+"'>"+e.htmlCls.space3+"</span></td>",i+="<td>",i+=e.htmlCls.divNowrapStr+" <select id='"+e.pre+"picationthreshold'>",i+=e.htmlCls.setHtmlCls.getOptionHtml(c,3),i+="</select> &#197;"+e.htmlCls.space3+"</div></td>",i+="<td style='white-space:nowrap'>"+e.htmlCls.inputCheckStr+"id='"+e.pre+"analysis_pistacking' checked>&pi;-Stacking <span style='background-color:#"+e.htmlCls.pistackingColor+"'>"+e.htmlCls.space3+"</span></td>",i+="<td>",i+=e.htmlCls.divNowrapStr+" <select id='"+e.pre+"pistackingthreshold'>",i+=e.htmlCls.setHtmlCls.getOptionHtml(["3","4","5"],99),i+=e.htmlCls.optionStr+"'5.5' selected>5.5</option>",i+=e.htmlCls.setHtmlCls.getOptionHtml(["6","7","8"],99),i+="</select> &#197;"+e.htmlCls.space3+"</div></td>",i+="</tr></table></div>",i+="<table border=0 width=400 cellspacing=10><tr><td>",i+=e.htmlCls.divNowrapStr+"2. Select the first set:</div>",i+="<div style='text-indent:1.1em'><select style='max-width:200px' id='"+e.pre+"atomsCustomHbond2' multiple size='5' style='min-width:130px;'>",i+="</select></div>",i+="</td><td>",i+=e.htmlCls.divNowrapStr+"3. Select the second set:</div>",i+="<div style='text-indent:1.1em'><select style='max-width:200px' id='"+e.pre+"atomsCustomHbond' multiple size='5' style='min-width:130px;'>",i+="</select></div>",i+="</td></tr></table>",i+="<div>4. "+e.htmlCls.buttonStr+"applyhbonds'>3D Display Interactions</button></div><br>",i+="<div style='text-indent:1.1em'>"+e.htmlCls.buttonStr+"hbondWindow'>Highlight Interactions in Table</button><span style='margin-left:30px; font-wieght:bold'>Sort Interactions on</span>: "+e.htmlCls.buttonStr+"sortSet1'> Set 1</button>"+e.htmlCls.buttonStr+"sortSet2' style='margin-left:12px'>Set 2</button></div><br>",i+="<div style='text-indent:1.1em'>"+e.htmlCls.buttonStr+"hbondLineGraph'>2D Interaction Network</button> "+e.htmlCls.buttonStr+"hbondLineGraph2' style='margin-left:12px'>2D Network with Reference Numbers</button> to show two lines of residue nodes</div><br>",i+="<div style='text-indent:1.1em'>"+e.htmlCls.buttonStr+"hbondScatterplot'>2D Interaction Map</button> "+e.htmlCls.buttonStr+"hbondScatterplot2' style='margin-left:12px'>2D Map with Reference Numbers</button> to show map</div><br>",i+="<div style='text-indent:1.1em'>"+e.htmlCls.buttonStr+"hbondLigplot'>2D Interaction for One Ligand/Residue</button> with atom details</div><br>",o=': </td><td><input style="margin-left:-12px" type="text" id="',i+="<div style='text-indent:1.1em'>"+e.htmlCls.buttonStr+"hbondGraph'>2D Graph(Force-Directed)</button> to show interactions with strength parameters in 0-200:</div>",i+='<div style="text-indent:1.1em"><table><tr><td>Helix or Sheet'+o+e.pre+'dist_ss" size="4" value="100"></td>',i+="<td>Coil or Nucleotide"+o+e.pre+'dist_coil" size="4" value="50"></td>',i+="<td>Disulfide Bonds"+o+e.pre+'dist_ssbond" size="4" value="50"></td></tr>',i+="<tr><td>Hydrogen Bonds"+o+e.pre+'dist_hbond" size="4" value="50"></td>',i+="<td>Salt Bridge/Ionic"+o+e.pre+'dist_ionic" size="4" value="50"></td>',i+="<td>Contacts"+o+e.pre+'dist_inter" size="4" value="25"></td></tr>',i+="<tr><td>Halogen Bonds"+o+e.pre+'dist_halogen" size="4" value="50"></td>',i+="<td>&pi;-Cation"+o+e.pre+'dist_pication" size="4" value="50"></td>',i+="<td>&pi;-Stacking"+o+e.pre+'dist_pistacking" size="4" value="50"></td></tr></table></div>',i+='<div style="text-indent:1.1em">(Note: you can also adjust thresholds at #1 to add/remove interactions.)</div><br>',i+="<div style='text-indent:1.1em'>"+e.htmlCls.buttonStr+"areaWindow'>Buried Surface Area</button></div><br>",i+="<div>5. "+e.htmlCls.buttonStr+"hbondReset'>Reset</button> and select new sets</div>",i+="</div>",i+=e.htmlCls.divStr+"dl_realign' class='"+r+"'>",i+=this.addNotebookTitle("dl_realign","Realign by sequence"),i+=e.htmlCls.divNowrapStr+"1. Select sets below <br>or use your current selection:</div><br>",i+="<div style='text-indent:1.1em'><select id='"+e.pre+"atomsCustomRealign' multiple size='5' style='min-width:130px;'>",i+="</select></div><br>",i+="<div>2. "+e.htmlCls.buttonStr+"applyRealign'>Realign by Sequence</button></div><br>",i+="</div>",i+=e.htmlCls.divStr+"dl_realignbystruct' class='"+r+"' style='max-width:500px'>",i+=this.addNotebookTitle("dl_realignbystruct","Realign by structure"),i+="<div><b>1</b>. Select sets below or use your current selection.</div><br>",i+="<div style='text-indent:1.1em'><select id='"+e.pre+"atomsCustomRealignByStruct' multiple size='5' style='min-width:130px;'>",i+="</select></div><br>",i+="<div><b>2</b>. "+e.htmlCls.buttonStr+"applyRealignByStruct_tmalign'>Realign with TM-align</button>"+e.htmlCls.buttonStr+"applyRealignByStruct' style='margin-left:30px'>Realign with VAST</button></div><br>",i+="</div>",i+=e.htmlCls.divStr+"dl_realigntwostru' class='"+r+"'>",i+=this.addNotebookTitle("dl_realigntwostru","Realign two structure complexes"),i+=e.htmlCls.divNowrapStr+"1. Select sets below or use your current selection:</div><br>",i+="<div style='text-indent:1.1em'><select id='"+e.pre+"atomsCustomRealignByStruct2' multiple size='5' style='min-width:130px;'>",i+="</select></div><br>",i+="2. Overall maximum RMSD: "+e.htmlCls.inputTextStr+"id='"+e.pre+"maxrmsd' value='30' size='2'> &#197; <br><br>",i+="<div>3. "+e.htmlCls.buttonStr+"applyRealignByStruct_vastplus'>VAST+ Alignment based on TM-align</button></div><br>",i+="</div>",i+=e.htmlCls.divStr+"dl_colorspectrumacrosssets' class='"+r+"'>",i+=this.addNotebookTitle("dl_colorspectrumacrosssets","Set color spectrum across sets"),i+=e.htmlCls.divNowrapStr+"1. Select sets below:</div><br>",i+="<div style='text-indent:1.1em'><select id='"+e.pre+"atomsCustomColorSpectrumAcross' multiple size='5' style='min-width:130px;'>",i+="</select></div>",i+="<div>2. "+e.htmlCls.buttonStr+"applyColorSpectrumAcrossSets'>Spectrum Color for Sets</button></div><br>",i+="</div>",i+=e.htmlCls.divStr+"dl_colorspectrumbysets' class='"+r+"'>",i+=this.addNotebookTitle("dl_colorspectrumbysets","Set color spectrum for residues in sets"),i+=e.htmlCls.divNowrapStr+"1. Select sets below:</div><br>",i+="<div style='text-indent:1.1em'><select id='"+e.pre+"atomsCustomColorSpectrum' multiple size='5' style='min-width:130px;'>",i+="</select></div>",i+="<div>2. "+e.htmlCls.buttonStr+"applyColorSpectrumBySets'>Spectrum Color for Residues in Sets</button></div><br>",i+="</div>",i+=e.htmlCls.divStr+"dl_colorrainbowacrosssets' class='"+r+"'>",i+=this.addNotebookTitle("dl_colorrainbowacrosssets","Set color rainbow across sets"),i+=e.htmlCls.divNowrapStr+"1. Select sets below:</div><br>",i+="<div style='text-indent:1.1em'><select id='"+e.pre+"atomsCustomColorRainbowAcross' multiple size='5' style='min-width:130px;'>",i+="</select></div>",i+="<div>2. "+e.htmlCls.buttonStr+"applyColorRainbowAcrossSets'>Rainbow Color for Sets</button></div><br>",i+="</div>",i+=e.htmlCls.divStr+"dl_colorrainbowbysets' class='"+r+"'>",i+=this.addNotebookTitle("dl_colorrainbowbysets","Set color rainbow for residues in sets"),i+=e.htmlCls.divNowrapStr+"1. Select sets below:</div><br>",i+="<div style='text-indent:1.1em'><select id='"+e.pre+"atomsCustomColorRainbow' multiple size='5' style='min-width:130px;'>",i+="</select></div>",i+="<div>2. "+e.htmlCls.buttonStr+"applyColorRainbowBySets'>Rainbow Color for Residues in Sets</button></div><br>",i+="</div>",i+=e.htmlCls.divStr+"dl_allinteraction' style='background-color:white' class='"+r+"'>",i+=this.addNotebookTitle("dl_allinteraction","All interactions",!0),i+="</div>",i+=e.htmlCls.divStr+"dl_interactionsorted' style='background-color:white' class='"+r+"'>",i+=this.addNotebookTitle("dl_interactionsorted","Sorted interactions",!0),i+="</div>",i+=e.htmlCls.divStr+"dl_linegraph' style='background-color:white' class='"+r+"'>",i+=this.addNotebookTitle("dl_linegraph","2D Interaction Network"),i+=e.htmlCls.divNowrapStr+'<div style="width:20px; margin-top:6px; display:inline-block;"><span id="'+e.pre+'dl_linegraphcolor_expand" class="ui-icon ui-icon-plus icn3d-expand icn3d-link" style="display:none; width:15px;" title="Expand"></span><span id="'+e.pre+'dl_linegraphcolor_shrink" class="ui-icon ui-icon-minus icn3d-shrink icn3d-link" style="width:15px;" title="Shrink"></span></div>',i+=e.htmlCls.space2+"Hold Ctrl key to select multiple nodes/lines.</div>",i+=e.htmlCls.divStr+"dl_linegraphcolor' style='display:block;'>",i+=e.htmlCls.setHtmlCls.setColorHints(),i+="</div><br>",e.linegraphid=e.pre+"linegraph",i+=e.htmlCls.divNowrapStr+a+e.linegraphid+'_svg">SVG</button>'+e.htmlCls.space2,i+=a+e.linegraphid+'_png">PNG</button>'+e.htmlCls.space2,i+=a+e.linegraphid+'_json">JSON</button>'+e.htmlCls.space4,i+="<b>Scale</b>: <select id='"+e.linegraphid+"_scale'>";let h=["0.1","0.2","0.4","0.6","0.8","1","2","4","6","8","10"];i+=e.htmlCls.setHtmlCls.getOptionHtml(h,5),i+="</select></div><br>",i+='<div id="'+e.pre+'linegraphDiv"></div>',i+="</div>",i+=e.htmlCls.divStr+"dl_scatterplot' style='background-color:white' class='"+r+"'>",i+=this.addNotebookTitle("dl_scatterplot","2D Interaction Map"),i+=e.htmlCls.divNowrapStr+"Hold Ctrl key to select multiple nodes."+e.htmlCls.space3,i+='<div style="width:20px; margin-top:6px; display:inline-block;"><span id="'+e.pre+'dl_scatterplotcolor_expand" class="ui-icon ui-icon-plus icn3d-expand icn3d-link" style="width:15px;" title="Expand"></span><span id="'+e.pre+'dl_scatterplotcolor_shrink" class="ui-icon ui-icon-minus icn3d-shrink icn3d-link" style="display:none; width:15px;" title="Shrink"></span></div></div>',i+=e.htmlCls.divStr+"dl_scatterplotcolor' style='display:none;'>",i+=e.htmlCls.setHtmlCls.setColorHints(),i+="</div>",e.scatterplotid=e.pre+"scatterplot",i+=e.htmlCls.divNowrapStr+a+e.scatterplotid+'_svg">SVG</button>'+e.htmlCls.space2,i+=a+e.scatterplotid+'_png">PNG</button>'+e.htmlCls.space2,i+=a+e.scatterplotid+'_json">JSON</button>'+e.htmlCls.space4,i+="<b>Scale</b>: <select id='"+e.scatterplotid+"_scale'>",i+=e.htmlCls.setHtmlCls.getOptionHtml(h,5),i+="</select></div><br>",i+='<div id="'+e.pre+'scatterplotDiv"></div>',i+="</div>",i+=e.htmlCls.divStr+"dl_ligplot' style='background-color:white' class='"+r+"'>",void 0!==e.cfg.cid||void 0!==e.cfg.smiles?i+=this.addNotebookTitle("dl_ligplot","2D Depiction for Chemicals"):(i+=this.addNotebookTitle("dl_ligplot","2D Interaction for One Ligand/Residue with Atom Details"),i+=e.htmlCls.divNowrapStr+"<b>Note</b>: Nodes/Residues can be dragged. Both nodes and dashed lines/interactions can be clicked to select residues. "+e.htmlCls.space3,i+='<div style="width:20px; margin-top:6px; display:inline-block;"><span id="'+e.pre+'dl_ligplotcolor_expand" class="ui-icon ui-icon-plus icn3d-expand icn3d-link" style="display:none; width:15px;" title="Expand"></span><span id="'+e.pre+'dl_ligplotcolor_shrink" class="ui-icon ui-icon-minus icn3d-shrink icn3d-link" style="width:15px;" title="Shrink"></span></div></div>',i+=e.htmlCls.divStr+"dl_ligplotcolor' style='inline-block;'>",i+="<b>Color legend</b> for interactions (dashed lines): <br>",i+=e.htmlCls.setHtmlCls.setColorHints(),i+="<br></div>"),e.ligplotid=e.pre+"ligplot",i+=e.htmlCls.divNowrapStr+a+e.ligplotid+'_svg">SVG</button>'+e.htmlCls.space2,i+=a+e.ligplotid+'_png">PNG</button>'+e.htmlCls.space2,i+="<b>Scale</b>: <select id='"+e.ligplotid+"_scale'>",i+=e.htmlCls.setHtmlCls.getOptionHtml(h,5),i+="</select></div><br>",i+='<div id="'+e.pre+'ligplotDiv"></div>',i+="</div>",i+=e.htmlCls.divStr+"dl_contactmap' style='background-color:white' class='"+r+"'>",i+=this.addNotebookTitle("dl_contactmap","Contact Map"),i+=e.htmlCls.divNowrapStr+"Hold Ctrl key to select multiple nodes."+e.htmlCls.space3+"</div>",e.contactmapid=e.pre+"contactmap",i+=e.htmlCls.divNowrapStr+a+e.contactmapid+'_svg">SVG</button>'+e.htmlCls.space2,i+=a+e.contactmapid+'_png">PNG</button>'+e.htmlCls.space2,i+=a+e.contactmapid+'_json">JSON</button>'+e.htmlCls.space4,i+="<b>Scale</b>: <select id='"+e.contactmapid+"_scale'>";let p=["0.01","0.02","0.04","0.06","0.08","0.1","0.2","0.4","0.6","0.8","1"];i+=e.htmlCls.setHtmlCls.getOptionHtml(p,10),i+="</select></div><br>",i+='<div id="'+e.pre+'contactmapDiv"></div>',i+="</div>",i+=e.htmlCls.divStr+"dl_alignerrormap' style='background-color:white' class='"+r+"'>",i+=this.addNotebookTitle("dl_alignerrormap","PAE Map"),i+=e.htmlCls.divNowrapStr+"Hold Ctrl key to select multiple nodes."+e.htmlCls.space3+"</div>",e.alignerrormapid=e.pre+"alignerrormap",i+=e.htmlCls.divNowrapStr+a+e.alignerrormapid+'_svg">SVG</button>'+e.htmlCls.space2,i+=a+e.alignerrormapid+'_png">PNG (slow)</button>'+e.htmlCls.space2,i+=a+e.alignerrormapid+'_json">JSON</button>'+e.htmlCls.space4,i+='<b>Scale</b>: <select id="'+e.alignerrormapid+'_scale">',i+=e.htmlCls.setHtmlCls.getOptionHtml(p,2),i+="</select></div><br>";i+="<div style='width:200px'><div style='height: 12px; border: 1px solid #000; background: linear-gradient(to right, #004d00 0%, #FFFFFF 100%);'></div>",i+="<table width='100%' border='0' cellspacing='0' cellpadding='0'><tr><td width='15%'>0</td><td width='15%'>5</td><td width='15%'>10</td><td width='15%'>15</td><td width='15%'>20</td><td width='15%'>25</td><td>30</td></tr><tr><td colspan='7' align='center'>Expected position error (Angstroms)</td></tr></table></div><br>",i+='<div id="'+e.pre+'alignerrormapDiv"></div>',i+="</div>",i+=e.htmlCls.divStr+"dl_elecmap2fofc' class='"+r+"'>",i+=this.addNotebookTitle("dl_elecmap2fofc","Electron Density 2F0-Fc Map"),i+="<span style='white-space:nowrap;font-weight:bold;'>Contour at: <select id='"+e.pre+"sigma2fofc'>";let u=["0","0.5","1","1.5","2","3","4","5","6","7","8","9","10"];i+=e.htmlCls.setHtmlCls.getOptionHtml(u,3),i+="</select> &sigma;</span> <span style='white-space:nowrap; margin-left:30px;'>"+e.htmlCls.buttonStr+"applymap2fofc'>Display</button></span> <span style='white-space:nowrap; margin-left:30px;'>"+e.htmlCls.buttonStr+"elecmapNo2'>Remove Map</button></span>",i+="</div>",i+=e.htmlCls.divStr+"dl_elecmapfofc' class='"+r+"'>",i+=this.addNotebookTitle("dl_elecmapfofc","Electron Density F0-Fc Map"),i+="<span style='white-space:nowrap;font-weight:bold;'>Contour at: <select id='"+e.pre+"sigmafofc'>",i+=e.htmlCls.setHtmlCls.getOptionHtml(u,5),i+="</select> &sigma;</span> <span style='white-space:nowrap; margin-left:30px;'>"+e.htmlCls.buttonStr+"applymapfofc'>Display</button></span> <span style='white-space:nowrap; margin-left:30px;'>"+e.htmlCls.buttonStr+"elecmapNo3'>Remove Map</button></span>",i+="</div>",i+=e.htmlCls.divStr+"dl_emmap' class='"+r+"'>",i+=this.addNotebookTitle("dl_emmap","EM Density Map"),i+="<span style='white-space:nowrap;font-weight:bold;'>Contour at: <select id='"+e.pre+"empercentage'>",i+=e.htmlCls.setHtmlCls.getOptionHtml(["0","10","20","30","40","50","60","70","80","90","100"],3),i+="</select> % of maximum EM values</span><br><span style='white-space:nowrap; margin-left:30px;'>"+e.htmlCls.buttonStr+"applyemmap'>Display</button></span> <span style='white-space:nowrap; margin-left:30px;'>"+e.htmlCls.buttonStr+"emmapNo2'>Remove EM Map</button></span>",i+="</div>",i+=e.htmlCls.divStr+"dl_aroundsphere' class='"+r+"'>",i+=this.addNotebookTitle("dl_aroundsphere","Select a sphere around a set of residues"),i+=e.htmlCls.divNowrapStr+"1. Select the first set:</div>",i+="<div style='text-indent:1.1em'><select id='"+e.pre+"atomsCustomSphere2' multiple size='3' style='min-width:130px;'>",i+="</select></div><br>",i+=e.htmlCls.divNowrapStr+"2. Sphere with a radius: "+e.htmlCls.inputTextStr+"id='"+e.pre+"radius_aroundsphere' value='4' size='2'> &#197;</div><br/>",i+=e.htmlCls.divNowrapStr+"3. Select the second set to apply the sphere:</div>",i+="<div style='text-indent:1.1em'><select id='"+e.pre+"atomsCustomSphere' multiple size='3' style='min-width:130px;'>",i+="</select></div><br>",i+=e.htmlCls.divNowrapStr+"4. "+e.htmlCls.buttonStr+"applypick_aroundsphere'>Display</button> the sphere around the first set of atoms</div><br>",i+="<div style='text-indent:1.1em'>"+e.htmlCls.buttonStr+"sphereExport'>Save</button> interacting/contacting residue pairs in a file</div>",i+="</div>",i+=e.htmlCls.divStr+"dl_adjustmem' class='"+r+"'>",i+=this.addNotebookTitle("dl_adjustmem","Adjust membranes"),i+="<b>Note</b>: The membranes are parallel to the X-Y plane. The center of the membranes is at Z = 0. <br/><br/>",i+=e.htmlCls.divNowrapStr+"1. Extracellular membrane Z-axis position: "+e.htmlCls.inputTextStr+"id='"+e.pre+"extra_mem_z' value='' size='3'> &#197;</div><br/>",i+=e.htmlCls.divNowrapStr+"2. intracellular membrane Z-axis position: "+e.htmlCls.inputTextStr+"id='"+e.pre+"intra_mem_z' value='' size='3'> &#197;</div><br/>",i+=e.htmlCls.divNowrapStr+"3. "+e.htmlCls.buttonStr+"apply_adjustmem'>Display</button> the adjusted membranes</div><br>",i+="</div>",i+=e.htmlCls.divStr+"dl_selectplane' class='"+r+"'>",i+=this.addNotebookTitle("dl_selectplane","Select a plane"),i+="<b>Note</b>: The membranes are parallel to the X-Y plane. The center of the membranes is at Z = 0. <br/><br/>",i+=e.htmlCls.divNowrapStr+"1. Z-axis position of the first X-Y plane: "+e.htmlCls.inputTextStr+"id='"+e.pre+"selectplane_z1' value='15' size='3'> &#197;</div><br/>",i+=e.htmlCls.divNowrapStr+"2. Z-axis position of the second X-Y plane: "+e.htmlCls.inputTextStr+"id='"+e.pre+"selectplane_z2' value='-15' size='3'> &#197;</div><br/>",i+=e.htmlCls.divNowrapStr+"3. "+e.htmlCls.buttonStr+"apply_selectplane'>Save</button> the region between the planes to Defined Sets</div><br>",i+="</div>",i+=e.htmlCls.divStr+"dl_addlabel' class='"+r+"'>",i+=this.addNotebookTitle("dl_addlabel","Add labels between two atoms"),i+="1. Text: "+e.htmlCls.inputTextStr+"id='"+e.pre+"labeltext' value='Text' size=4><br/>",i+="2. Size: "+e.htmlCls.inputTextStr+"id='"+e.pre+"labelsize' value='18' size=4 maxlength=2><br/>",i+="3. Color: "+e.htmlCls.inputTextStr+"id='"+e.pre+"labelcolor' value='"+s+"' size=4><br/>",e.utilsCls.isMobile()?i+=e.htmlCls.spanNowrapStr+"4. Touch TWO atoms</span><br/>":i+=e.htmlCls.spanNowrapStr+'4. Pick TWO atoms while holding "Alt" key</span><br/>',i+=e.htmlCls.spanNowrapStr+"5. "+e.htmlCls.buttonStr+"applypick_labels'>Display</button></span>",i+="</div>",i+=e.htmlCls.divStr+"dl_addlabelselection' class='"+r+"'>",i+=this.addNotebookTitle("dl_addlabelselection","Add labels for your selection"),i+="1. Text: "+e.htmlCls.inputTextStr+"id='"+e.pre+"labeltext2' value='Text' size=4><br/>",i+="2. Size: "+e.htmlCls.inputTextStr+"id='"+e.pre+"labelsize2' value='18' size=4 maxlength=2><br/>",i+="3. Color: "+e.htmlCls.inputTextStr+"id='"+e.pre+"labelcolor2' value='"+s+"' size=4><br/>",i+=e.htmlCls.spanNowrapStr+"4. "+e.htmlCls.buttonStr+"applyselection_labels'>Display</button></span>",i+="</div>",i+=e.htmlCls.divStr+"dl_labelColor' class='"+r+"'>",i+=this.addNotebookTitle("dl_labelColor","Change label color"),i+="Color for all labels: "+e.htmlCls.inputTextStr+"id='"+e.pre+"labelcolorall' value='"+s+"' size=4><br/><br/>",i+=e.htmlCls.spanNowrapStr+e.htmlCls.buttonStr+"applylabelcolor'>Display</button></span>",i+="</div>",i+=e.htmlCls.divStr+"dl_distance' class='"+r+"'>",i+=this.addNotebookTitle("dl_distance","Measure distance"),e.utilsCls.isMobile()?i+=e.htmlCls.spanNowrapStr+"1. Touch TWO atoms</span><br/>":i+=e.htmlCls.spanNowrapStr+'1. Pick TWO atoms while holding "Alt" key</span><br/>',i+=e.htmlCls.spanNowrapStr+"2. Line Color: "+e.htmlCls.inputTextStr+"id='"+e.pre+"distancecolor' value='"+s+"' size=4><br/>",i+=e.htmlCls.spanNowrapStr+"3. "+e.htmlCls.buttonStr+"applypick_measuredistance'>Display</button></span>",i+="</div>",i+=e.htmlCls.divStr+"dl_stabilizer' class='"+r+"'>",i+=this.addNotebookTitle("dl_stabilizer","Add a stabilizer"),e.utilsCls.isMobile()?i+=e.htmlCls.spanNowrapStr+"1. Touch TWO atoms</span><br/>":i+=e.htmlCls.spanNowrapStr+'1. Pick TWO atoms while holding "Alt" key</span><br/>',i+=e.htmlCls.spanNowrapStr+"2. Color: "+e.htmlCls.inputTextStr+"id='"+e.pre+"stabilizercolor' value='ffffff' size=4><br/>",i+=e.htmlCls.spanNowrapStr+"3. "+e.htmlCls.buttonStr+"applypick_stabilizer'>Add</button></span>",i+="</div>",i+=e.htmlCls.divStr+"dl_disttwosets' class='"+r+"'>",i+=this.addNotebookTitle("dl_disttwosets","Measure the distance between two sets"),i+=e.htmlCls.spanNowrapStr+"1. Select two sets</span><br/>",i+="<table border=0 width=400 cellspacing=10><tr><td>",i+=e.htmlCls.divNowrapStr+"First set:</div>",i+="<div style='text-indent:1.1em'><select style='max-width:200px' id='"+e.pre+"atomsCustomDist2' multiple size='5' style='min-width:130px;'>",i+="</select></div>",i+="</td><td>",i+=e.htmlCls.divNowrapStr+"Second set:</div>",i+="<div style='text-indent:1.1em'><select style='max-width:200px' id='"+e.pre+"atomsCustomDist' multiple size='5' style='min-width:130px;'>",i+="</select></div>",i+="</td></tr></table>",i+=e.htmlCls.spanNowrapStr+"2. Color: "+e.htmlCls.inputTextStr+"id='"+e.pre+"distancecolor2' value='"+s+"' size=4><br/><br/>",i+=e.htmlCls.spanNowrapStr+"3. "+e.htmlCls.buttonStr+"applydist2'>Display</button></span>",i+="</div>",i+=e.htmlCls.divStr+"dl_linebtwsets' class='"+r+"'>",i+=this.addNotebookTitle("dl_linebtwsets","Add a line between  two sets"),i+=e.htmlCls.spanNowrapStr+"1. Select two sets</span><br/>",i+="<table border=0 width=400 cellspacing=10><tr><td>",i+=e.htmlCls.divNowrapStr+"First set:</div>",i+="<div style='text-indent:1.1em'><select style='max-width:200px' id='"+e.pre+"linebtwsets2' multiple size='5' style='min-width:130px;'>",i+="</select></div>",i+="</td><td>",i+=e.htmlCls.divNowrapStr+"Second set:</div>",i+="<div style='text-indent:1.1em'><select style='max-width:200px' id='"+e.pre+"linebtwsets' multiple size='5' style='min-width:130px;'>",i+="</select></div>",i+="</td></tr></table>",i+=e.htmlCls.divNowrapStr+"2. Line style: <select id='"+e.pre+"linebtwsets_style'>",i+=e.htmlCls.setHtmlCls.getOptionHtml(["Solid","Dashed"],0),i+="</select></div><br>",i+="3. Line radius: "+e.htmlCls.inputTextStr+"id='"+e.pre+"linebtwsets_radius' value='0.4' size=4><br/><br/>",i+="4. Color: "+e.htmlCls.inputTextStr+"id='"+e.pre+"linebtwsets_customcolor' value='"+s+"' size=4><br/><br/>",i+=e.htmlCls.divNowrapStr+"5. Opacity: <select id='"+e.pre+"linebtwsets_opacity'>",i+=e.htmlCls.setHtmlCls.getOptionHtml(["1.0","0.9","0.8","0.7","0.6","0.5","0.4","0.3","0.2","0.1"],7),i+="</select></div><br>",i+=e.htmlCls.spanNowrapStr+"6. "+e.htmlCls.buttonStr+"applylinebtwsets'>Display</button></span>",i+=e.htmlCls.space3+e.htmlCls.spanNowrapStr+e.htmlCls.buttonStr+"clearlinebtwsets'>Clear</button></span>",i+="</div>",i+=e.htmlCls.divStr+"dl_cartoonshape' class='"+r+"'>",i+=this.addNotebookTitle("dl_cartoonshape","Cartoon Shape"),i+=e.htmlCls.spanNowrapStr+"1. Select a set:</span><br/>",i+="<div style='text-indent:1.1em'><select style='max-width:200px' id='"+e.pre+"cartoonshape' multiple size='5' style='min-width:130px;'>",i+="</select></div><br>",i+=e.htmlCls.divNowrapStr+"2. Shape: <select id='"+e.pre+"cartoonshape_shape'>",i+=e.htmlCls.setHtmlCls.getOptionHtml(["Sphere","Cube"],0),i+="</select></div><br>",i+="3. Radius: "+e.htmlCls.inputTextStr+"id='"+e.pre+"cartoonshape_radius' value='1.5' size=4><br/><br/>",i+="4. Color: "+e.htmlCls.inputTextStr+"id='"+e.pre+"cartoonshape_customcolor' value='"+s+"' size=4><br/><br/>",i+=e.htmlCls.divNowrapStr+"5. Opacity: <select id='"+e.pre+"cartoonshape_opacity'>",i+=e.htmlCls.setHtmlCls.getOptionHtml(["1.0","0.9","0.8","0.7","0.6","0.5","0.4","0.3","0.2","0.1"],7),i+="</select></div><br>",i+=e.htmlCls.spanNowrapStr+"6. "+e.htmlCls.buttonStr+"applycartoonshape'>Display</button></span>",i+=e.htmlCls.space3+e.htmlCls.spanNowrapStr+e.htmlCls.buttonStr+"clearcartoonshape'>Clear</button></span>",i+="</div>",i+=e.htmlCls.divStr+"dl_distmanysets' class='"+r+"'>",i+=this.addNotebookTitle("dl_distmanysets","Measure distances among many sets"),i+=e.htmlCls.spanNowrapStr+"1. Select sets for pairwise distances</span><br/>",i+="<table border=0 width=400 cellspacing=10><tr><td>",i+=e.htmlCls.divNowrapStr+"First sets:</div>",i+="<div style='text-indent:1.1em'><select style='max-width:200px' id='"+e.pre+"atomsCustomDistTable2' multiple size='5' style='min-width:130px;'>",i+="</select></div>",i+="</td><td>",i+=e.htmlCls.divNowrapStr+"Second sets:</div>",i+="<div style='text-indent:1.1em'><select style='max-width:200px' id='"+e.pre+"atomsCustomDistTable' multiple size='5' style='min-width:130px;'>",i+="</select></div>",i+="</td></tr></table>",i+=e.htmlCls.spanNowrapStr+"2. "+e.htmlCls.buttonStr+"applydisttable'>Distances in Table</button></span>",i+="</div>",i+=e.htmlCls.divStr+"dl_anglemanysets' class='"+r+"' style='max-width:500px'>",i+=this.addNotebookTitle("dl_anglemanysets","Measure angles among many sets"),i+=e.htmlCls.spanNowrapStr+"Note: Each set is represented by a vector, which is the X-axis of the principle axes. The angles between the vectors are then calculated.<br/><br/>",i+=e.htmlCls.spanNowrapStr+"1. Select sets for pairwise angles</span><br/>",i+="<table border=0 width=400 cellspacing=10><tr><td>",i+=e.htmlCls.divNowrapStr+"First sets:</div>",i+="<div style='text-indent:1.1em'><select style='max-width:200px' id='"+e.pre+"atomsCustomAngleTable2' multiple size='5' style='min-width:130px;'>",i+="</select></div>",i+="</td><td>",i+=e.htmlCls.divNowrapStr+"Second sets:</div>",i+="<div style='text-indent:1.1em'><select style='max-width:200px' id='"+e.pre+"atomsCustomAngleTable' multiple size='5' style='min-width:130px;'>",i+="</select></div>",i+="</td></tr></table>",i+=e.htmlCls.spanNowrapStr+"2. "+e.htmlCls.buttonStr+"applyangletable'>Angles in Table</button></span>",i+="</div>",i+=e.htmlCls.divStr+"dl_stabilizer_rm' class='"+r+"'>",i+=this.addNotebookTitle("dl_stabilizer_rm","Remove a stabilizer"),e.utilsCls.isMobile()?i+=e.htmlCls.spanNowrapStr+"1. Touch TWO atoms</span><br/>":i+=e.htmlCls.spanNowrapStr+'1. Pick TWO atoms while holding "Alt" key</span><br/>',i+=e.htmlCls.spanNowrapStr+"2. "+e.htmlCls.buttonStr+"applypick_stabilizer_rm'>Remove</button></span>",i+="</div>",i+=e.htmlCls.divStr+"dl_thickness' class='"+r+"'>",i+=this.addNotebookTitle("dl_thickness","Set thickness"),i+=e.htmlCls.setHtmlCls.setThicknessHtml("3dprint"),i+="</div>",i+=e.htmlCls.divStr+"dl_thickness2' class='"+r+"'>",i+=this.addNotebookTitle("dl_thickness2","Set thickness"),i+=e.htmlCls.setHtmlCls.setThicknessHtml("style"),i+="</div>",i+=e.htmlCls.divStr+"dl_menupref' class='"+r+"'>",i+=this.addNotebookTitle("dl_menupref","Preferences for menus"),i+="<b>Note</b>: The following parameters will be saved in cache. You just need to set them once. <br><br>",i+=e.htmlCls.spanNowrapStr+""+e.htmlCls.buttonStr+"apply_menupref'>Apply</button></span>",i+=e.htmlCls.spanNowrapStr+""+e.htmlCls.buttonStr+"reset_menupref' style='margin-left:30px'>Reset to Simple Menus</button></span>",i+=e.htmlCls.spanNowrapStr+""+e.htmlCls.buttonStr+"reset_menupref_all' style='margin-left:30px'>Reset to All Menus</button></span>",i+=e.htmlCls.spanNowrapStr+""+e.htmlCls.buttonStr+"savepref' style='margin-left:30px'>Save Preferences</button></span>",i+=e.htmlCls.spanNowrapStr+""+e.htmlCls.buttonStr+"loadpref' style='margin-left:30px'>Load Preferences</button></span><br><br>",i+="<div id='"+e.pre+"menulist'></div><br><br>",i+=e.htmlCls.spanNowrapStr+""+e.htmlCls.buttonStr+"apply_menupref2'>Apply</button></span>",i+=e.htmlCls.spanNowrapStr+""+e.htmlCls.buttonStr+"reset_menupref2' style='margin-left:30px'>Reset to Simple Menus</button></span>",i+=e.htmlCls.spanNowrapStr+""+e.htmlCls.buttonStr+"reset_menupref_all2' style='margin-left:30px'>Reset to All Menus</button></span>",i+=e.htmlCls.spanNowrapStr+""+e.htmlCls.buttonStr+"savepref2' style='margin-left:30px'>Save Preferences</button></span>",i+=e.htmlCls.spanNowrapStr+""+e.htmlCls.buttonStr+"loadpref2' style='margin-left:30px'>Load Preferences</button></span>",i+="</div>",i+=e.htmlCls.divStr+"dl_addtrack' class='"+r+"'>",i+=this.addNotebookTitle("dl_addtrack","Add a track"),i+=" <input type='hidden' id='"+e.pre+"track_chainid' value=''>",i+=e.htmlCls.divStr+"dl_addtrack_tabs' style='border:0px;'>",i+="<ul>",i+="<li><a href='#"+e.pre+"tracktab2c'>Isoforms & Exons</a></li>",i+="<li><a href='#"+e.pre+"tracktab2b'>MSA</a></li>",i+="<li><a href='#"+e.pre+"tracktab1'>NCBI gi/Accession</a></li>",i+="<li><a href='#"+e.pre+"tracktab2'>FASTA</a></li>",i+="<li><a href='#"+e.pre+"tracktab3'>BED File</a></li>",i+="<li><a href='#"+e.pre+"tracktab4'>Custom</a></li>",i+="<li><a href='#"+e.pre+"tracktab5'>Current Selection</a></li>",i+="</ul>",i+=e.htmlCls.divStr+"tracktab1'>",i+="NCBI gi/Accession: "+e.htmlCls.inputTextStr+"id='"+e.pre+"track_gi' placeholder='gi' size=16> <br><br>",i+=e.htmlCls.buttonStr+"addtrack_button1'>Add Track</button>",i+="</div>",i+=e.htmlCls.divStr+"tracktab2'>",i+="FASTA Title: "+e.htmlCls.inputTextStr+"id='"+e.pre+"fasta_title' placeholder='track title' size=16> <br><br>",i+="FASTA sequence: <br><textarea id='"+e.pre+"track_fasta' rows='5' style='width: 100%; height: "+2*e.htmlCls.LOG_HEIGHT+"px; padding: 0px; border: 0px;'></textarea><br><br>",i+=e.htmlCls.buttonStr+"addtrack_button2'>Add Track</button>",i+="</div>",i+=e.htmlCls.divStr+"tracktab2b'>",i+="<div style='width:600px'>Note: The full protein sequences with gaps in MSA are listed one by one. The sequence of the structure is listed at the top. Each sequence has a title line starting with \">\".</div><br>",i+="<b>Precalculated Multiple Sequence Alignment (MSA)</b>:<br>",i+="<textarea id='"+e.pre+"track_fastaalign' rows='5' style='width: 100%; height: "+2*e.htmlCls.LOG_HEIGHT+"px; padding: 0px; border: 0px;'></textarea><br><br>",i+="<b>Position of the first residue in Sequences & Annotations window</b>: "+e.htmlCls.inputTextStr+"id='"+e.pre+"fasta_startpos' value='1' size=2> <br><br>",i+="Color Sequence by: <select id='"+e.pre+"colorseqby'>",i+=e.htmlCls.optionStr+"'identity' selected>Identity</option>",i+=e.htmlCls.optionStr+"'conservation'>Conservation</option>",i+="</select> <br><br>",i+=e.htmlCls.buttonStr+"addtrack_button2b'>Add Track(s)</button>",i+="</div>",i+=e.htmlCls.divStr+"tracktab2c'>",i+="<div style='width:500px'>Note: Show exons for all isoforms of the protein in the same gene as specified below.</div><br>",i+="<b><a href='https://www.ncbi.nlm.nih.gov/gene' target='_blank'>NCBI Gene</a> ID</b>: "+e.htmlCls.inputTextStr+"id='"+e.pre+"track_geneid' size=20>"+e.htmlCls.space3+e.htmlCls.buttonStr+"exons_table'>Exons & Introns in Gene Table</button><br><br>",i+="<b>Position of the first residue in Sequences & Annotations window</b>: "+e.htmlCls.inputTextStr+"id='"+e.pre+"fasta_startpos2' value='1' size=2> <br><br>",i+=e.htmlCls.buttonStr+"addtrack_button2c'>Show Isoforms & Exons</button>",i+="</div>",i+=e.htmlCls.divStr+"tracktab3'>",i+="BED file: "+e.htmlCls.inputFileStr+"id='"+e.pre+"track_bed' size=16> <br><br>",i+=e.htmlCls.buttonStr+"addtrack_button3'>Add Track</button>",i+="</div>",i+=e.htmlCls.divStr+"tracktab4'>",i+="Track Title: "+e.htmlCls.inputTextStr+"id='"+e.pre+"track_title' placeholder='track title' size=16> <br><br>",i+='Track Text (e.g., "2 G, 5-6 RR" defines a character "G" at the position 2 and two continuous characters "RR" at positions from 5 to 6. The starting position is 1): <br>',i+="<textarea id='"+e.pre+"track_text' rows='5' style='width: 100%; height: "+2*e.htmlCls.MENU_HEIGHT+"px; padding: 0px; border: 0px;'></textarea><br><br>",i+=e.htmlCls.buttonStr+"addtrack_button4'>Add Track</button>",i+="</div>",i+=e.htmlCls.divStr+"tracktab5'>",i+="Track Title: "+e.htmlCls.inputTextStr+"id='"+e.pre+"track_selection' placeholder='track title' size=16> <br><br>",i+=e.htmlCls.buttonStr+"addtrack_button5'>Add Track</button>",i+="</div>",i+="</div>",i+="</div>",i+=e.htmlCls.divStr+"dl_saveselection' class='"+r+"'>",i+=this.addNotebookTitle("dl_saveselection","Save Selection");let m=t&&t.defNames2Atoms?Object.keys(t.defNames2Atoms).length:1;return i+="Name: "+e.htmlCls.inputTextStr+"id='"+e.pre+"seq_command_name' value='seq_"+m+"' size='5'> <br>",i+="<button style='white-space:nowrap;' id='"+e.pre+"seq_saveselection'>Save</button> <button style='white-space:nowrap; margin-left:20px;' id='"+e.pre+"seq_clearselection'>Clear</button><br/><br/>",i+="</div>",i+=e.htmlCls.divStr+"dl_copyurl' style='width:520px;' class='"+r+"'>",i+=this.addNotebookTitle("dl_copyurl","Share Link"),i+="<br>",i+="1. <b>URLs Used in Browsers</b><br><br>",i+='Please copy one of the URLs below. They show the same result.<br>(To add a title to share link, click "Windows > Your Note" and click "File > Share Link" again.)<br><br>',i+="Original URL with commands: <br><textarea id='"+e.pre+"ori_url' rows='4' style='width:100%'></textarea><br><br>",e.cfg.notebook||(i+="Lifelong Short URL:(To replace this URL, send a pull request to update share.html at <a href='https://github.com/ncbi/icn3d' target='_blank'>iCn3D GitHub</a>)<br>"+e.htmlCls.inputTextStr+"id='"+e.pre+"short_url' value='' style='width:100%'><br><br>",i+='Lifelong Short URL + Window Title:(To update the window title, click "Analysis > Your Note/Window Title".)<br>'+e.htmlCls.inputTextStr+"id='"+e.pre+"short_url_title' value='' style='width:100%'><br><br>"),i+="2. <b>Commands Used in Jupyter Noteboook</b><br><br>",i+="Please copy the following commands into a cell in Jupyter Notebook to show the same result. <br>More details are at https://github.com/ncbi/icn3d/tree/master/jupyternotebook.<br><br>",i+='<textarea id="'+e.pre+'jn_commands" rows="4" style="width:100%"></textarea><br>',i+=a+e.pre+'jn_copy">Copy Commands</button><br>',i+="</div>",i+=e.htmlCls.divStr+"dl_selectannotations' class='"+r+" icn3d-annotation' style='background-color:white;'>",i+=this.addNotebookTitle("dl_selectannotations","Sequences & Annotations"),i+=e.htmlCls.divStr+"dl_annotations_tabs'>",i+=e.htmlCls.divStr+"dl_anno_view_tabs' style='border:0px; height:33px;'>",i+="<ul>",i+="<li><a href='#"+e.pre+"anno_tmp1' id='"+e.pre+"anno_summary'>Summary</a></li>",i+="<li><a href='#"+e.pre+"anno_tmp2' id='"+e.pre+"anno_details'>Details</a></li>",i+="</ul>",i+=e.htmlCls.divStr+"anno_tmp1'>",i+="</div>",i+=e.htmlCls.divStr+"anno_tmp2'>",i+="</div>",i+="</div>",i+=this.getAnnoHeader(),i+="<button style='white-space:nowrap; margin-left:5px;' id='"+e.pre+"showallchains'>Show All Chains</button><br>",i+=e.htmlCls.divStr+"seqguide_wrapper' style='display:none'><br>"+e.htmlCls.setHtmlCls.setSequenceGuide("2")+"</div>",i+="</div><br/><hr><br>",i+=e.htmlCls.divStr+"dl_annotations'>",i+="</div>",i+="</div>",i+=e.htmlCls.divStr+"dl_graph' style='background-color:white;' class='"+r+"'>",i+=this.addNotebookTitle("dl_graph","Interactions"),e.svgid=e.pre+"icn3d_viz",i+="<style>",i+="#"+e.svgid+" svg { border: 1px solid; font: 13px sans-serif; text-anchor: end; }",i+="#"+e.svgid+" .node { stroke: #eee; stroke-width: 1.5px; }",i+=".node .selected { stroke: "+e.htmlCls.ORANGE+"; }",i+=".link { stroke: #999; stroke-opacity: 0.6; }",i+="</style>",i+=e.htmlCls.divNowrapStr+"<b>Zoom</b>: mouse wheel; "+e.htmlCls.space3+" <b>Move</b>: left button; "+e.htmlCls.space3+" <b>Select Multiple Nodes</b>: Ctrl Key and drag an Area"+e.htmlCls.space3,i+='<div id="'+e.pre+'interactionDesc" style="width:20px; margin-top:6px; display:inline-block;"><span id="'+e.pre+'dl_svgcolor_expand" class="ui-icon ui-icon-plus icn3d-expand icn3d-link" style="width:15px;" title="Expand"></span><span id="'+e.pre+'dl_svgcolor_shrink" class="ui-icon ui-icon-minus icn3d-shrink icn3d-link" style="display:none; width:15px;" title="Shrink"></span></div></div>',i+=e.htmlCls.divStr+"dl_svgcolor' style='display:none;'>",i+=e.htmlCls.divNowrapStr+'<span style="margin-left:33px">Click "View > H-Bonds & Interactions" to adjust parameters and relaunch the graph</span></div>',i+=e.htmlCls.divNowrapStr+'<span style="margin-left:33px; color:#00FF00; font-weight:bold">Green</span>: H-Bonds; ',i+='<span style="color:#00FFFF; font-weight:bold">Cyan</span>: Salt Bridge/Ionic; ',i+='<span style="font-weight:bold">Grey</span>: contacts; ',i+='<span style="color:'+e.htmlCls.ORANGE+'; font-weight:bold">Orange</span>: disulfide bonds</div>',i+=e.htmlCls.divNowrapStr+'<span style="margin-left:33px; color:#FF00FF; font-weight:bold">Magenta</span>: Halogen Bonds; ',i+='<span style="color:#FF0000; font-weight:bold">Red</span>: &pi;-Cation; ',i+='<span style="color:#0000FF; font-weight:bold">Blue</span>: &pi;-Stacking</div>',i+="</div>",i+=e.htmlCls.divNowrapStr+a+e.svgid+'_svg">SVG</button>'+e.htmlCls.space2,i+=a+e.svgid+'_png">PNG</button>'+e.htmlCls.space2,i+=a+e.svgid+'_json">JSON</button>',i+=e.htmlCls.space3+"<div id='"+e.pre+"force' style='display:inline-block;'><b>Force on Nodes</b>: <select id='"+e.svgid+"_force'>",i+=e.htmlCls.optionStr+"'0'>No</option>",i+=e.htmlCls.optionStr+"'1'>X-axis</option>",i+=e.htmlCls.optionStr+"'2'>Y-axis</option>",i+=e.htmlCls.optionStr+"'3'>Circle</option>",i+=e.htmlCls.optionStr+"'4' selected>Random</option>",i+="</select></div>",i+=e.htmlCls.space3+"<b>Label Size</b>: <select id='"+e.svgid+"_label'>",o="icn3d-node-text",i+=e.htmlCls.optionStr+"'"+o+"0'>No</option>",i+=e.htmlCls.optionStr+"'"+o+"4'>4px</option>",i+=e.htmlCls.optionStr+"'"+o+"8' selected>8px</option>",i+=e.htmlCls.optionStr+"'"+o+"12'>12px</option>",i+=e.htmlCls.optionStr+"'"+o+"16'>16px</option>",i+=e.htmlCls.optionStr+"'"+o+"24'>24px</option>",i+=e.htmlCls.optionStr+"'"+o+"32'>32px</option>",i+="</select>",i+=e.htmlCls.space3+"<div id='"+e.pre+"internalEdges' style='display:inline-block;'><b>Internal Edges</b>: <select id='"+e.svgid+"_hideedges'>",i+=e.htmlCls.optionStr+"'1' selected>Hide</option>",i+=e.htmlCls.optionStr+"'0'>Show</option>",i+="</select></div>",i+="</div>",i+='<svg id="'+e.svgid+'" style="margin-top:6px;"></svg>',i+="</div>",i+=e.htmlCls.divStr+"dl_area' class='"+r+"'>",i+=this.addNotebookTitle("dl_area","Surface Area"),i+="Solvent Accessible Surface Area(SASA) calculated using the <a href='https://journals.plos.org/plosone/article?id=10.1371/journal.pone.0008140' target='_blank'>EDTSurf algorithm</a>: <br>",i+='(0-20% out is considered "in". 50-100% out is considered "out".)<br><br>',i+="<b>Toal</b>: "+e.htmlCls.inputTextStr+"id='"+e.pre+"areavalue' value='' size='10'> &#8491;<sup>2</sup><br><br>",i+="<div id='"+e.pre+"areatable' style='max-height:400px; overflow:auto'></div>",i+="</div>",i+=e.htmlCls.divStr+"dl_colorbyarea' class='"+r+"'>",i+=this.addNotebookTitle("dl_colorbyarea","Color by surface area"),i+="<div style='width:500px'>Color each residue based on the percentage of solvent accessilbe surface area. The color ranges from blue, to white, to red for a percentage of 0, 35(variable), and 100, respectively.</div><br>",i+="<b>Middle Percentage(White)</b>: "+e.htmlCls.inputTextStr+"id='"+e.pre+"midpercent' value='35' size='10'>% <br><br>",i+="<button style='white-space:nowrap;' id='"+e.pre+"applycolorbyarea'>Color</button><br/><br/>",i+="</div>",i+=e.htmlCls.divStr+"dl_rmsd' class='"+r+"' style='max-width:300px'>",i+=this.addNotebookTitle("dl_rmsd","RMSD",!0),i+="</div>",i+=e.htmlCls.divStr+"dl_buriedarea' class='"+r+"'>",i+=this.addNotebookTitle("dl_buriedarea","Buried surface area",!0),i+="</div>",i+=e.htmlCls.divStr+"dl_propbypercentout' class='"+r+"'>",i+=this.addNotebookTitle("dl_propbypercentout","Select residues basen on solvent accessilbe surface area"),i+="<div style='width:400px'>Select residue based on the percentage of solvent accessilbe surface area. The values are in the range of 0-100.</div><br>",i+="<b>Min Percentage</b>: "+e.htmlCls.inputTextStr+"id='"+e.pre+"minpercentout' value='0' size='10'>% <br>",i+="<b>Max Percentage</b>: "+e.htmlCls.inputTextStr+"id='"+e.pre+"maxpercentout' value='100' size='10'>% <br>",i+="<button style='white-space:nowrap;' id='"+e.pre+"applypropbypercentout'>Apply</button><br/><br/>",i+="</div>",i+=e.htmlCls.divStr+"dl_propbybfactor' class='"+r+"'>",i+=this.addNotebookTitle("dl_propbybfactor","Select residues basen on B-factor/pLDDT"),i+="<div style='width:400px'>Select residue based on B-factor/pLDDT. The values are in the range of 0-100.</div><br>",i+="<b>Min B-factor/pLDDT</b>: "+e.htmlCls.inputTextStr+"id='"+e.pre+"minbfactor' value='0' size='10'>% <br>",i+="<b>Max B-factor/pLDDT</b>: "+e.htmlCls.inputTextStr+"id='"+e.pre+"maxbfactor' value='100' size='10'>% <br>",i+="<button style='white-space:nowrap;' id='"+e.pre+"applypropbybfactor'>Apply</button><br/><br/>",i+="</div>",i+=e.htmlCls.divStr+"dl_legend' class='"+r+"' style='max-width:500px; background-color:white'>",i+=this.addNotebookTitle("dl_legend","Legend",!0),i+="</div>",i+=e.htmlCls.divStr+"dl_disttable' class='"+r+"'>",i+=this.addNotebookTitle("dl_disttable","Distance Table",!0),i+="</div>",i+=e.htmlCls.divStr+"dl_angletable' class='"+r+"'>",i+=this.addNotebookTitle("dl_angletable","Angle Table",!0),i+="</div>",i+=e.htmlCls.divStr+"dl_translate' class='"+r+"'>",i+=this.addNotebookTitle("dl_translate","Translate the X,Y,Z coordinates of the structure"),i+="X: "+e.htmlCls.inputTextStr+"id='"+e.pre+"translateX' value='' size=4> ",i+="Y: "+e.htmlCls.inputTextStr+"id='"+e.pre+"translateY' value='' size=4> ",i+="Z: "+e.htmlCls.inputTextStr+"id='"+e.pre+"translateZ' value='' size=4> ",i+=e.htmlCls.buttonStr+"translate_pdb'>Translate</button>",i+="</div>",i+=e.htmlCls.divStr+"dl_angle' class='"+r+"'>",i+=this.addNotebookTitle("dl_angle","Measure the angle between two vectors"),i+="<b>Vector 1</b>, X: "+e.htmlCls.inputTextStr+"id='"+e.pre+"v1X' value='' size=6> ",i+="Y: "+e.htmlCls.inputTextStr+"id='"+e.pre+"v1Y' value='' size=6> ",i+="Z: "+e.htmlCls.inputTextStr+"id='"+e.pre+"v1Z' value='' size=6><br>",i+="<b>Vector 2</b>, X: "+e.htmlCls.inputTextStr+"id='"+e.pre+"v2X' value='' size=6> ",i+="Y: "+e.htmlCls.inputTextStr+"id='"+e.pre+"v2Y' value='' size=6> ",i+="Z: "+e.htmlCls.inputTextStr+"id='"+e.pre+"v2Z' value='' size=6><br>",i+="<br>",i+=e.htmlCls.buttonStr+"measure_angle'>Measure Angle</button><br><br>",i+="The angle is: "+e.htmlCls.inputTextStr+"id='"+e.pre+"angle_value' value='' size=6> degree.<br><br>",i+="</div>",i+=e.htmlCls.divStr+"dl_matrix' class='"+r+"'>",i+=this.addNotebookTitle("dl_matrix","Apply matrix to the X,Y,Z coordinates of the structure"),i+="0: "+e.htmlCls.inputTextStr+"id='"+e.pre+"matrix0' value='1' size=2> ",i+="4: "+e.htmlCls.inputTextStr+"id='"+e.pre+"matrix4' value='0' size=2> ",i+="8: "+e.htmlCls.inputTextStr+"id='"+e.pre+"matrix8' value='0' size=2> ",i+="12: "+e.htmlCls.inputTextStr+"id='"+e.pre+"matrix12' value='0' size=2><br>",i+="1: "+e.htmlCls.inputTextStr+"id='"+e.pre+"matrix1' value='0' size=2> ",i+="5: "+e.htmlCls.inputTextStr+"id='"+e.pre+"matrix5' value='1' size=2> ",i+="9: "+e.htmlCls.inputTextStr+"id='"+e.pre+"matrix9' value='0' size=2> ",i+="13: "+e.htmlCls.inputTextStr+"id='"+e.pre+"matrix13' value='0' size=2><br>",i+="2: "+e.htmlCls.inputTextStr+"id='"+e.pre+"matrix2' value='0' size=2> ",i+="6: "+e.htmlCls.inputTextStr+"id='"+e.pre+"matrix6' value='0' size=2> ",i+="10: "+e.htmlCls.inputTextStr+"id='"+e.pre+"matrix10' value='1' size=2> ",i+="14: "+e.htmlCls.inputTextStr+"id='"+e.pre+"matrix14' value='0' size=2><br>",i+="3: "+e.htmlCls.inputTextStr+"id='"+e.pre+"matrix3' value='0' size=2> ",i+="7: "+e.htmlCls.inputTextStr+"id='"+e.pre+"matrix7' value='0' size=2> ",i+="11: "+e.htmlCls.inputTextStr+"id='"+e.pre+"matrix11' value='0' size=2> ",i+="15: "+e.htmlCls.inputTextStr+"id='"+e.pre+"matrix15' value='1' size=2><br>",i+=e.htmlCls.buttonStr+"matrix_pdb'>Rotate with Matrix</button>",i+="</div>",i+=e.htmlCls.divStr+"dl_igrefTpl' class='"+r+"'>",i+=this.addNotebookTitle("dl_igrefTpl","Choose an Ig template"),i+="<span style='white-space:nowrap;font-weight:bold;'>Choose an Ig template for selected residues:</span> <br><br><select id='"+e.pre+"refTpl'>",i+=this.setTemplateMenu(),i+="</select><br><br><span style='white-space:nowrap;'>"+e.htmlCls.buttonStr+"mn6_igrefTpl_apply'>Show Ig Ref. Number</button></span>",i+="</div>",i+=e.htmlCls.divStr+"dl_alignrefTpl' class='"+r+"'>",i+=this.addNotebookTitle("dl_alignrefTpl","Align with an Ig template"),i+="<span style='white-space:nowrap;font-weight:bold;'>Choose an Ig template to align with selected residues:</span> <br><br><select id='"+e.pre+"refTpl2'>",i+=this.setTemplateMenu(),i+="</select><br><br><span style='white-space:nowrap;'>"+e.htmlCls.buttonStr+"mn6_alignrefTpl_apply'>Align Template with Selection</button></span>",i+="</div>",i+="</div>",i+="\x3c!--/form--\x3e",i}setTemplateMenu(){let e=this.icn3dui;e.icn3d;let t={IgV:["CD28_1yjdC_human_V","CD2_1hnfA_human_V-n1","CD8a_1cd8A_human_V","FAB-HEAVY_5esv_V-n1","FAB-LIGHT_5esv_V-n1","ICOS_6x4gA_human_V","LAG3_7tzgD_human_V-n1","PD1_4zqkB_human_V","PDL1_4z18B_human_V-n1","TCRa_6jxrm_human_V-n1","VISTA_6oilA_human_V","VNAR_1t6vN_shark_V"],IgC1:["B2Microglobulin_7phrL_human_C1","CD3d_6jxrd_human_C1","CD3e_6jxrf_human_C1","FAB-LIGHT_5esv_C1-n2","FAB-HEAVY_5esv_C1-n2","GHR_1axiB_human_C1-n1","LAG3_7tzgD_human_C1-n2","MHCIa_7phrH_human_C1","Siglec3_5j0bB_human_C1-n2","TCRa_6jxrm_human_C1-n2","VTCN1_Q7Z7D3_human_C1-n2"],IgC2:["CD2_1hnfA_human_C2-n2","CD3g_6jxrg_human_C2"],IgI:["BTLA_2aw2A_human_Iset","Contactin1_3s97C_human_Iset-n2","JAM1_1nbqA_human_Iset-n2","Palladin_2dm3A_human_Iset-n1","Titin_4uowM_human_Iset-n152"],IgE:["CoAtomerGamma1_1r4xA_human","Endo-1,4-BetaXylanase10A_1i8aA_bacteria_n4","IsdA_2iteA_bacteria","NaKATPaseTransporterBeta_2zxeB_spurdogshark","TP34_2o6cA_bacteria","TP47_1o75A_bacteria"],IgFN3:["Contactin1_2ee2A_human_FN3-n9","IL6Rb_1bquB_human_FN3-n2","IL6Rb_1bquB_human_FN3-n3","InsulinR_8guyE_human_FN3-n1","InsulinR_8guyE_human_FN3-n2","Sidekick2_1wf5A_human_FN3-n7"],"IgFN3-like":["ASF1A_2iijA_human","BArrestin1_4jqiA_rat_n1","C3_2qkiD_human_n1","MPT63_1lmiA_bacteria","NaCaExchanger_2fwuA_dog_n2","RBPJ_6py8C_human_Unk-n1","TEAD1_3kysC_human"],"Other Ig":["CD19_6al5A_human-n1","CuZnSuperoxideDismutase_1hl5C_human","ECadherin_4zt1A_human_n2","LaminAC_1ifrA_human","ORF7a_1xakA_virus","RBPJ_6py8C_human_Unk-n2"]},i={ASF1A_2iijA_human:"A A' B C C' E F G G+",B2Microglobulin_7phrL_human_C1:"A B C C' D E F G",BArrestin1_4jqiA_rat_n1:"A- A A' B C C' E F G",BTLA_2aw2A_human_Iset:"A A' B C C' D E F G",C3_2qkiD_human_n1:"A A' B C C' E F G","CD19_6al5A_human-n1":"A' B C C' D E F G",CD28_1yjdC_human_V:"A A' B C C' C'' D E F G","CD2_1hnfA_human_C2-n2":"A B C C' E F G","CD2_1hnfA_human_V-n1":"A' B C C' C'' D E F G",CD3d_6jxrd_human_C1:"A B C D E F G",CD3e_6jxrf_human_C1:"A B C C' D E F G",CD3g_6jxrg_human_C2:"A B C C' E F G G+",CD8a_1cd8A_human_V:"A A' B C C' C'' D E F G",CoAtomerGamma1_1r4xA_human:"A- A B C D E F G","Contactin1_2ee2A_human_FN3-n9":"A A' B C C' E F G","Contactin1_3s97C_human_Iset-n2":"A A' B C D E F G",CuZnSuperoxideDismutase_1hl5C_human:"A- A B C C' E F G",ECadherin_4zt1A_human_n2:"A' B C D E F G","Endo-1,4-BetaXylanase10A_1i8aA_bacteria_n4":"A--- A-- A- A B C C' C'' D E F G","FAB-HEAVY_5esv_C1-n2":"A B C D E F G","FAB-HEAVY_5esv_V-n1":"A B C C' C'' D E F G","FAB-LIGHT_5esv_C1-n2":"A B C C' D E F G","FAB-LIGHT_5esv_V-n1":"A A' B C C' C'' D E F G","GHR_1axiB_human_C1-n1":"A B C C' D E F G",ICOS_6x4gA_human_V:"A B C C' C'' D E F G","IL6Rb_1bquB_human_FN3-n2":"A B C C' E F G","IL6Rb_1bquB_human_FN3-n3":"A B C C' E F G","InsulinR_8guyE_human_FN3-n1":"A B C C' E F G","InsulinR_8guyE_human_FN3-n2":"A B C C' E F G",IsdA_2iteA_bacteria:"A- A B C C' D E F G","JAM1_1nbqA_human_Iset-n2":"A A' B C C' D E F G","LAG3_7tzgD_human_C1-n2":"A A' B C C' D E F G","LAG3_7tzgD_human_V-n1":"A' B C C' D E F G",LaminAC_1ifrA_human:"A- A B C C' E E+ F G",MHCIa_7phrH_human_C1:"A B C C' D E F G",MPT63_1lmiA_bacteria:"A-- A- A BC C' E F G",NaCaExchanger_2fwuA_dog_n2:"A A' B C C' E F G",NaKATPaseTransporterBeta_2zxeB_spurdogshark:"A A' B C D E F G",ORF7a_1xakA_virus:"A' B C D E F G",PD1_4zqkB_human_V:"A A' B C C' D E F G","PDL1_4z18B_human_V-n1":"A A' B C C' C'' D E F G","Palladin_2dm3A_human_Iset-n1":"A A' B C C' D E F G","RBPJ_6py8C_human_Unk-n1":"A A' B C C' E F G","RBPJ_6py8C_human_Unk-n2":"A B C D E F G","Sidekick2_1wf5A_human_FN3-n7":"A B C C' E F G","Siglec3_5j0bB_human_C1-n2":"A A' B C D E F G","TCRa_6jxrm_human_C1-n2":"A B C D E F G","TCRa_6jxrm_human_V-n1":"A A' B C C' C'' D E F G",TEAD1_3kysC_human:"A A+ A' B C C' E F G G+",TP34_2o6cA_bacteria:"A- A B C C' D E F G",TP47_1o75A_bacteria:"A B C C' D E F G","Titin_4uowM_human_Iset-n152":"A A' B C C' D E F G",VISTA_6oilA_human_V:"A A' B C C' C'' D E F G G+",VNAR_1t6vN_shark_V:"A A' B C C' D E F G","VTCN1_Q7Z7D3_human_C1-n2":"A B C C' D E F G G+"},s="";for(let n in t){s+="<optgroup label='"+n+"'>";for(let r=0,a=t[n].length;r<a;++r){let a=t[n][r];s+=e.htmlCls.optionStr+"'"+a+"'>"+a+", Strands: "+i[a]+"</option>"}s+="</optgroup>"}return s}getAnnoHeader(){let e=this.icn3dui;e.icn3d;let t="";t+="<div id='"+e.pre+"annoHeaderSection' class='icn3d-box' style='width:520px;'><b>Annotations:&nbsp;</b><br>",t+="<div id='"+e.pre+"annoHeader'><table border=0><tr>";let i="<td style='min-width:110px;'><span style='white-space:nowrap'>",s="<td style='min-width:130px;'><span style='white-space:nowrap'>";return t+=i+e.htmlCls.inputCheckStr+"id='"+e.pre+"anno_all'>All"+e.htmlCls.space2+"</span></td>",t+=s+e.htmlCls.inputCheckStr+"id='"+e.pre+"anno_cdd' checked>Conserved Domains"+e.htmlCls.space2+"</span></td>",t+=i+e.htmlCls.inputCheckStr+"id='"+e.pre+"anno_clinvar'>ClinVar"+e.htmlCls.space2+"</span></td>",t+=i+e.htmlCls.inputCheckStr+"id='"+e.pre+"anno_binding'>Functional Sites"+e.htmlCls.space2+"</span></td>",t+="</tr><tr>",t+=i+e.htmlCls.inputCheckStr+"id='"+e.pre+"anno_custom'>Custom"+e.htmlCls.space2+"</span></td>",t+=s+e.htmlCls.inputCheckStr+"id='"+e.pre+"anno_3dd'>3D Domains"+e.htmlCls.space2+"</span></td>",t+=i+e.htmlCls.inputCheckStr+"id='"+e.pre+"anno_snp'>SNPs"+e.htmlCls.space2+"</span></td>",t+=i+e.htmlCls.inputCheckStr+"id='"+e.pre+"anno_ptm'>PTM (UniProt)"+e.htmlCls.space2+"</span></td>",t+="<td></td>",t+="</tr><tr>",t+=i+e.htmlCls.inputCheckStr+"id='"+e.pre+"anno_ssbond'>Disulfide Bonds"+e.htmlCls.space2+"</span></td>",t+=i+e.htmlCls.inputCheckStr+"id='"+e.pre+"anno_interact'>Interactions"+e.htmlCls.space2+"</span></td>",t+=i+e.htmlCls.inputCheckStr+"id='"+e.pre+"anno_crosslink'>Cross-Linkages"+e.htmlCls.space2+"</span></td>",t+=i+e.htmlCls.inputCheckStr+"id='"+e.pre+"anno_transmem'>Transmembrane"+e.htmlCls.space2+"</span></td>",t+="<td></td>",t+="</tr><tr>",t+=i+e.htmlCls.inputCheckStr+"id='"+e.pre+"anno_ig'>Ig Domains"+e.htmlCls.space2+"</span></td>",t+="<td></td>",t+="</tr></table></div></div>",t}}class $l{constructor(e){this.icn3dui=e}setLogCmd(e,t,i){var s=this.icn3dui;s.icn3d,s.htmlCls.clickMenuCls.setLogCmd(e,t,i)}fullScreenChange(){let e=this.icn3dui,t=e.icn3d,i=this;e.bNode||document.fullscreenElement||document.webkitFullscreenElement||document.mozFullscreenElement||document.msFullscreenElement||(i.setLogCmd("exit full screen",!1),t.bFullscreen=!1,e.utilsCls.setViewerWidthHeight(e,!0),t.applyCenterCls.setWidthHeight(e.htmlCls.WIDTH,e.htmlCls.HEIGHT),t.drawCls.draw())}convertUniProtInChains(e){this.icn3dui.icn3d;let t=e.split(","),i="";for(let e=0,s=t.length;e<s;++e)i+=-1!=t[e].indexOf("_")?t[e]:t[e]+"_A",e<s-1&&(i+=",");return i}async searchSeq(){let e=this.icn3dui,t=e.icn3d,i=$("#"+e.pre+"search_seq").val();isNaN(i)&&-1==i.indexOf("$")&&-1==i.indexOf(".")&&-1==i.indexOf(":")&&-1==i.indexOf("@")&&(i=":"+i);let s=i.replace(/\s+/g,"_"),n=s;await t.selByCommCls.selectByCommand(i,s,n),this.setLogCmd("select "+i+" | name "+s,!0)}async setRealign(e,t){let i=this.icn3dui,s=i.icn3d,n=this,r=$("#"+i.pre+"atomsCustomRealignByStruct").val();r.length>0&&(s.hAtoms=s.definedSetsCls.getAtomsFromNameArray(r)),i.cfg.aligntool=e;let a="vast"==e?"structure align":"tmalign";if(a+=t?" msa":"",r.length>0?n.setLogCmd("realign on "+a+" | "+r,!0):n.setLogCmd("realign on "+a,!0),t){if(0==r.length){r=[];let e={};for(let t in s.chains){let i=s.firstAtomObjCls.getFirstAtomObj(s.chains[t]);e.hasOwnProperty(i.structure)||!s.proteins.hasOwnProperty(i.serial)&&!s.nucleotides.hasOwnProperty(i.serial)||(r.push(t),e[i.structure]=1)}}await s.realignParserCls.realignOnStructAlignMsa(r)}else await s.realignParserCls.realignOnStructAlign()}async readFile(e,t,i,s,n,r){let a=this.icn3dui,o=a.icn3d,l=this,d=t[i],c=e?"append":"load";c+=n?" mmcif file ":r?" png file ":" pdb file ";let h=new FileReader;h.onload=async function(h){let p=h.target.result;if(l.setLogCmd(c+d.name,!1),e?(o.resetConfig(),o.bResetAnno=!0,o.bResetSets=!0):o.init(),o.bInputfile=!0,o.InputfileType=n?"mmcif":r?"png":"pdb",r){let e=await a.htmlCls.setHtmlCls.loadPng(p);if(p=e.pdb,!p)return;o.statefileArray||(o.statefileArray=[]),o.statefileArray.push(e.statefile)}o.InputfileData=o.InputfileData?o.InputfileData+"\nENDMDL\n"+p:p,s=i>0?s+"\nENDMDL\n"+p:p,Object.keys(t).length==i+1?(e&&(o.hAtoms={},o.dAtoms={}),n?await o.mmcifParserCls.loadMultipleMmcifData(s,void 0,e):await o.pdbParserCls.loadPdbData(s,void 0,void 0,e)):await l.readFile(e,t,i+1,s,n,r),e&&(o.bSetChainsAdvancedMenu&&o.definedSetsCls.showSets(),o.bResetAnno=!0,o.bAnnoShown&&(await o.showAnnoCls.showAnnotations(),o.annotationCls.resetAnnoTabAll()))},"object"==typeof d&&h.readAsText(d)}async loadPdbFile(e,t,i){let s=this.icn3dui,n=s.icn3d;n.bInitial=!0,this.iniFileLoad();let r=$("#"+s.pre+t)[0].files;r[0]?(s.htmlCls.setHtmlCls.fileSupport(),n.molTitle="",n.dataStrAll="",await this.readFile(e,r,0,"",i)):alert("Please select a file before clicking 'Load'")}saveHtml(e){let t=this.icn3dui.icn3d,i="";i+='<link rel="stylesheet" href="https://www.ncbi.nlm.nih.gov/Structure/icn3d/lib/jquery-ui-1.13.2.min.css">\n',i+='<link rel="stylesheet" href="https://www.ncbi.nlm.nih.gov/Structure/icn3d/icn3d_full_ui.css">\n',i+=$("#"+e).html();let s=e.split("_"),n=s.length>2?s[2]:e,r=Object.keys(t.structures)[0];Object.keys(t.structures).length>1&&(r+="-"+Object.keys(t.structures)[1]),t.saveFileCls.saveFile(r+"-"+n+".html","html",encodeURIComponent(i))}setPredefinedMenu(e){let t=this.icn3dui,i=t.icn3d;if(Object.keys(i.chains).length<2)return void alert("At least two chains are required for alignment...");t.htmlCls.clickMenuCls.SetChainsAdvancedMenu();let s=i.definedSetsCls.setAtomMenu(["protein"]);$("#"+t.pre+e).length&&$("#"+t.pre+e).html(s),$("#"+t.pre+e).resizable()}exportMsa(e){let t=this.icn3dui.icn3d,i=t.msa[e].join("\n\n"),s="fasta"==e?".fasta":"clustalw"==e?".aln":".txt";t.saveFileCls.saveFile(t.inputid+"_align"+s,"text",[i])}iniFileLoad(){let e=this.icn3dui,t=e.icn3d;e.cfg.notebook||dialog.dialog("close"),e.cfg.notebook?t.resizeCanvasCls.closeDialogs():$(".ui-dialog-content").dialog("close")}async launchMmdb(e,t,i,s){let n=this.icn3dui,r=n.icn3d,a=this;n.cfg.notebook||dialog.dialog("close");let o=t?1:0;if(!(e=e.replace(/,/g," ").replace(/\s+/g,",").trim()))return void alert("Please enter a list of PDB IDs or AlphaFold UniProt IDs...");let l=e.split(",");if(s)if(r.structures||1!=l.length||4!=l[0].length&&isNaN(l[0])){n.cfg.mmdbafid=e,n.cfg.bu=o,r.bMmdbafid=!0,r.inputid=r.inputid?r.inputid+n.cfg.mmdbafid:n.cfg.mmdbafid,1==n.cfg.bu?r.loadCmd="load mmdbaf1 "+n.cfg.mmdbafid:r.loadCmd="load mmdbaf0 "+n.cfg.mmdbafid,n.htmlCls.clickMenuCls.setLogCmd(r.loadCmd,!0);let t=!!(r.structures&&Object.keys(r.structures).length>0);await r.chainalignParserCls.downloadMmdbAf(n.cfg.mmdbafid),t&&(r.bSetChainsAdvancedMenu&&r.definedSetsCls.showSets(),r.bAnnoShown&&(await r.showAnnoCls.showAnnotations(),r.annotationCls.resetAnnoTabAll()))}else{a.setLogCmd("load mmdb"+o+" "+e,!1);let t=r.structures&&Object.keys(r.structures).length>0?"_blank":"_self";window.open(i+"?mmdbid="+e+"&bu="+o,t)}else if(1!=l.length||4!=l[0].length&&isNaN(l[0])){a.setLogCmd("load mmdbaf"+o+" "+e,!1);let t=r.structures&&Object.keys(r.structures).length>0?"_blank":"_self";window.open(i+"?mmdbafid="+e+"&bu="+o,t)}else{a.setLogCmd("load mmdb"+o+" "+e,!1);let t=r.structures&&Object.keys(r.structures).length>0?"_blank":"_self";window.open(i+"?mmdbid="+e+"&bu="+o,t)}}async openBcf(e){let t=this.icn3dui,i=t.icn3d;await t.getAjaxPromise("./script/jszip.min.js","script");let s=new JSZip;t.htmlCls.setHtmlCls.fileSupport(),s.loadAsync(e).then((function(e){e.forEach((function(e,t){if(t.dir){s.folder(e).forEach((function(e,t){"viewpoint"==e.substr(0,9)&&t.async("string").then((function(e){let t=(new DOMParser).parseFromString(e,"text/xml"),s=t.querySelector("CameraViewPoint"),n=t.querySelector("CameraDirection"),r=t.querySelector("CameraUpVector"),a=t.querySelector("FieldOfView").textContent;t.querySelector("AspectRatio").textContent;let o,l=[],d=[],c=[];o=s.children,l=[o[0].textContent,o[1].textContent,o[2].textContent],o=n.children,d=[o[0].textContent,o[1].textContent,o[2].textContent],o=r.children,c=[o[0].textContent,o[1].textContent,o[2].textContent],i.cam.position.set(l[0],l[1],l[2]),i.cam.quaternion.setFromUnitVectors(new mt(0,0,-1),new mt(d[0],d[1],d[2])),i.cam.up.set(c[0],c[1],c[2]),i.cam.fov=a,i.drawCls.applyTransformation(i._zoomFactor,i.mouseChange,i.quaternion),i.drawCls.render()}))}))}}))}),(function(e){console.error("Error loading BCF viewpoint file:",e)}))}allEventFunctions(){let e=this.icn3dui,t=e.icn3d,i=this;if(e.bNode)return;let s=document.URL,n=s.indexOf("?");s=-1==n?s:s.substr(0,n),s.indexOf("/vast/icn3d/")&&(s=s.replace(/\/vast\/icn3d\//g,"/icn3d/")),t.definedSetsCls.clickCustomAtoms(),t.definedSetsCls.clickCommand_apply(),t.definedSetsCls.clickModeswitch(),t.selectionCls.clickShow_selected(),t.selectionCls.clickHide_selected(),t.diagram2dCls.click2Ddgm(),t.cartoon2dCls.click2Dcartoon(),t.ligplotCls.clickLigplot(),t.addTrackCls.clickAddTrackButton(),t.resizeCanvasCls.windowResize(),t.annotationCls.setTabs(),t.resid2specCls.switchHighlightLevel(),e.utilsCls.isMobile()?(t.hlSeqCls.selectSequenceMobile(),t.hlSeqCls.selectChainMobile()):t.hlSeqCls.selectSequenceNonMobile(),e.htmlCls.clickMenuCls.clickMenu1(),e.htmlCls.clickMenuCls.clickMenu2(),e.htmlCls.clickMenuCls.clickMenu3(),e.htmlCls.clickMenuCls.clickMenu4(),e.htmlCls.clickMenuCls.clickMenu5(),e.htmlCls.clickMenuCls.clickMenu6(),e.myEventCls.onIds("#"+e.pre+"menumode","change",(async function(t){e.icn3d,t.preventDefault();let i=$("#"+e.pre+"menumode").val();e.htmlCls.setHtmlCls.setCookie("menumode",i),e.htmlCls.setMenuCls.resetMenu(i)})),e.myEventCls.onIds(["#"+e.pre+"back","#"+e.pre+"mn6_back"],"click",(async function(t){let s=e.icn3d;t.preventDefault(),i.setLogCmd("back",!1),await s.resizeCanvasCls.back()})),e.myEventCls.onIds(["#"+e.pre+"forward","#"+e.pre+"mn6_forward"],"click",(async function(t){let s=e.icn3d;t.preventDefault(),i.setLogCmd("forward",!1),await s.resizeCanvasCls.forward()})),e.myEventCls.onIds(["#"+e.pre+"fullscreen","#"+e.pre+"mn6_fullscreen"],"click",(function(t){let s=e.icn3d;t.preventDefault(),i.setLogCmd("enter full screen",!1),s.bFullscreen=!0,e.htmlCls.WIDTH=$(window).width(),e.htmlCls.HEIGHT=$(window).height(),s.applyCenterCls.setWidthHeight(e.htmlCls.WIDTH,e.htmlCls.HEIGHT),s.drawCls.draw(),s.resizeCanvasCls.openFullscreen($("#"+e.pre+"canvas")[0])})),document.addEventListener("fullscreenchange",this.fullScreenChange.bind(this)),document.addEventListener("webkitfullscreenchange",this.fullScreenChange.bind(this)),document.addEventListener("mozfullscreenchange",this.fullScreenChange.bind(this)),document.addEventListener("msfullscreenchange",this.fullScreenChange.bind(this)),e.myEventCls.onIds(["#"+e.pre+"toggle","#"+e.pre+"mn2_toggle"],"click",(function(t){e.icn3d.selectionCls.toggleSelection(),i.setLogCmd("toggle selection",!0)})),e.myEventCls.onIds("#"+e.pre+"mn2_hl_clrYellow","click",(function(t){let s=e.icn3d;i.setLogCmd("set highlight color yellow",!0),s.hColor=e.parasCls.thr(16776960),s.matShader=s.setColorCls.setOutlineColor("yellow"),s.drawCls.draw()})),e.myEventCls.onIds("#"+e.pre+"mn2_hl_clrGreen","click",(function(t){let s=e.icn3d;i.setLogCmd("set highlight color green",!0),s.hColor=e.parasCls.thr(65280),s.matShader=s.setColorCls.setOutlineColor("green"),s.drawCls.draw()})),e.myEventCls.onIds("#"+e.pre+"mn2_hl_clrRed","click",(function(t){let s=e.icn3d;i.setLogCmd("set highlight color red",!0),s.hColor=e.parasCls.thr(16711680),s.matShader=s.setColorCls.setOutlineColor("red"),s.drawCls.draw()})),e.myEventCls.onIds("#"+e.pre+"mn2_hl_styleOutline","click",(function(t){let s=e.icn3d;i.setLogCmd("set highlight style outline",!0),s.bHighlight=1,s.hlUpdateCls.showHighlight()})),e.myEventCls.onIds("#"+e.pre+"mn2_hl_styleObject","click",(function(t){let s=e.icn3d;i.setLogCmd("set highlight style 3d",!0),s.bHighlight=2,s.hlUpdateCls.showHighlight()})),e.myEventCls.onIds("#"+e.pre+"mn2_hl_styleNone","click",(function(t){let s=e.icn3d;t.stopImmediatePropagation(),s.hlUpdateCls.clearHighlight(),i.setLogCmd("clear selection",!0)})),e.myEventCls.onIds(["#"+e.pre+"alternate","#"+e.pre+"mn2_alternate","#"+e.pre+"alternate2"],"click",(async function(t){let s=e.icn3d;s.bAlternate=!0,await s.alternateCls.alternateStructures(),s.bAlternate=!1,i.setLogCmd("alternate structures",!1)})),e.myEventCls.onIds("#"+e.pre+"mn2_realignresbyres","click",(function(t){e.icn3d,e.htmlCls.dialogCls.openDlg("dl_realignresbyres","Align multiple chains residue by residue")})),e.myEventCls.onIds("#"+e.pre+"realignSelection","click",(function(t){let s=e.icn3d;Object.keys(s.chains).length<2?alert("At least two chains are required for alignment..."):(s.realignParserCls.realign(),i.setLogCmd("realign",!0))})),e.myEventCls.onIds("#"+e.pre+"mn2_realignonseqalign","click",(function(t){e.icn3d.bRender&&e.htmlCls.dialogCls.openDlg("dl_realign","Please select chains to realign"),i.setPredefinedMenu("atomsCustomRealign")})),e.myEventCls.onIds("#"+e.pre+"mn2_realignonstruct","click",(function(t){e.icn3d.bRender&&e.htmlCls.dialogCls.openDlg("dl_realignbystruct","Please select chains to realign"),i.setPredefinedMenu("atomsCustomRealignByStruct")})),e.myEventCls.onIds("#"+e.pre+"mn2_realigntwostru","click",(function(t){e.icn3d.bRender&&e.htmlCls.dialogCls.openDlg("dl_realigntwostru","Please select structures to realign"),i.setPredefinedMenu("atomsCustomRealignByStruct2")})),e.myEventCls.onIds("#"+e.pre+"applyRealign","click",(async function(t){let s=e.icn3d;t.preventDefault(),e.cfg.notebook||dialog.dialog("close");let n=$("#"+e.pre+"atomsCustomRealign").val();n.length>0&&(s.hAtoms=s.definedSetsCls.getAtomsFromNameArray(n)),await s.realignParserCls.realignOnSeqAlign(),n.length>0?i.setLogCmd("realign on seq align | "+n,!0):i.setLogCmd("realign on seq align",!0)})),e.myEventCls.onIds("#"+e.pre+"applyRealignByStruct","click",(async function(t){e.icn3d,t.preventDefault(),e.cfg.notebook||dialog.dialog("close"),await i.setRealign("vast",!1)})),e.myEventCls.onIds("#"+e.pre+"applyRealignByStruct_tmalign","click",(async function(t){e.icn3d,t.preventDefault(),e.cfg.notebook||dialog.dialog("close"),await i.setRealign("tmalign",!1)})),e.myEventCls.onIds("#"+e.pre+"applyRealignByStructMsa","click",(async function(t){e.icn3d,t.preventDefault(),e.cfg.notebook||dialog.dialog("close"),await i.setRealign("vast",!0)})),e.myEventCls.onIds("#"+e.pre+"applyRealignByStructMsa_tmalign","click",(async function(t){e.icn3d,t.preventDefault(),e.cfg.notebook||dialog.dialog("close"),await i.setRealign("tmalign",!0)})),e.myEventCls.onIds("#"+e.pre+"applyRealignByStruct_vastplus","click",(async function(t){let s=e.icn3d;t.preventDefault(),e.cfg.notebook||dialog.dialog("close");let n=$("#"+e.pre+"atomsCustomRealignByStruct2").val();n.length>0&&(s.hAtoms=s.definedSetsCls.getAtomsFromNameArray(n)),await s.vastplusCls.realignOnVastplus(),n.length>0?i.setLogCmd("realign on vastplus | "+n,!0):i.setLogCmd("realign on vastplus",!0)})),e.myEventCls.onIds("#"+e.pre+"applyColorSpectrumAcrossSets","click",(function(t){let s=e.icn3d;t.preventDefault(),e.cfg.notebook||dialog.dialog("close");let n=$("#"+e.pre+"atomsCustomColorSpectrumAcross").val();if(0==n.length)return void alert("Please select some sets");s.setColorCls.setColorAcrossSets(n,!0),i.setLogCmd("set color spectrum | "+n,!0)})),e.myEventCls.onIds("#"+e.pre+"applyColorSpectrumBySets","click",(function(t){let s=e.icn3d;t.preventDefault(),e.cfg.notebook||dialog.dialog("close");let n=$("#"+e.pre+"atomsCustomColorSpectrum").val();if(0==n.length)return void alert("Please select some sets");s.setColorCls.setColorBySets(n,!0),i.setLogCmd("set residues color spectrum | "+n,!0)})),e.myEventCls.onIds("#"+e.pre+"applyColorRainbowAcrossSets","click",(function(t){let s=e.icn3d;t.preventDefault(),e.cfg.notebook||dialog.dialog("close");let n=$("#"+e.pre+"atomsCustomColorRainbowAcross").val();if(0==n.length)return void alert("Please select some sets");s.setColorCls.setColorAcrossSets(n,!1),i.setLogCmd("set color rainbow | "+n,!0)})),e.myEventCls.onIds("#"+e.pre+"applyColorRainbowBySets","click",(function(t){let s=e.icn3d;t.preventDefault(),e.cfg.notebook||dialog.dialog("close");let n=$("#"+e.pre+"atomsCustomColorRainbow").val();if(0==n.length)return void alert("Please select some sets");s.setColorCls.setColorBySets(n,!1),i.setLogCmd("set residues color rainbow | "+n,!0)})),e.myEventCls.onIds("#"+e.pre+"anno_summary","click",(function(t){let s=e.icn3d;t.preventDefault(),s.annotationCls.setAnnoViewAndDisplay("overview"),i.setLogCmd("set view overview",!0)})),e.myEventCls.onIds("#"+e.pre+"anno_details","click",(function(t){let s=e.icn3d;t.preventDefault(),s.annotationCls.setAnnoViewAndDisplay("detailed view"),i.setLogCmd("set view detailed view",!0)})),e.myEventCls.onIds("#"+e.pre+"show_annotations","click",(async function(t){let s=e.icn3d;await s.showAnnoCls.showAnnotations(),i.setLogCmd("view annotations",!0)})),e.myEventCls.onIds("#"+e.pre+"showallchains","click",(function(t){e.icn3d.annotationCls.showAnnoAllChains(),i.setLogCmd("show annotations all chains",!0)})),e.myEventCls.onIds("#"+e.pre+"show_alignsequences","click",(function(t){e.icn3d,e.htmlCls.dialogCls.openDlg("dl_alignment","Select residues in aligned sequences")})),e.myEventCls.onIds(["#"+e.pre+"show_2ddgm","#"+e.pre+"mn2_2ddgm"],"click",(async function(t){let s=e.icn3d;e.htmlCls.dialogCls.openDlg("dl_2ddgm","2D Diagram"),await s.viewInterPairsCls.retrieveInteractionData(),i.setLogCmd("view interactions",!0)})),e.myEventCls.onIds("#"+e.pre+"mn2_2ddepiction","click",(async function(t){let s=e.icn3d;await s.ligplotCls.drawLigplot(s.atoms,!0),i.setLogCmd("view 2d depiction",!0)})),e.myEventCls.onIds("#"+e.pre+"search_seq_button","click",(async function(t){e.icn3d,t.stopImmediatePropagation(),await i.searchSeq()})),e.myEventCls.onIds("#"+e.pre+"search_seq","keyup",(async function(t){e.icn3d,13===t.keyCode&&(t.preventDefault(),await i.searchSeq())})),e.myEventCls.onIds("#"+e.pre+"reload_vastplus","click",(function(t){let s=e.icn3d;t.preventDefault(),e.cfg.notebook||dialog.dialog("close"),i.setLogCmd("vast+ search "+$("#"+e.pre+"vastpluspdbid").val(),!1);let n=s.structures&&Object.keys(s.structures).length>0?"_blank":"_self";window.open("https://www.ncbi.nlm.nih.gov/Structure/vastplus/vastplus.cgi?uid="+$("#"+e.pre+"vastpluspdbid").val(),n)})),e.myEventCls.onIds("#"+e.pre+"reload_vast","click",(function(t){let s=e.icn3d;t.preventDefault(),e.cfg.notebook||dialog.dialog("close"),i.setLogCmd("vast search "+$("#"+e.pre+"vastpdbid").val()+"_"+$("#"+e.pre+"vastchainid").val(),!1);let n=s.structures&&Object.keys(s.structures).length>0?"_blank":"_self";window.open("https://www.ncbi.nlm.nih.gov/Structure/vast/vastsrv.cgi?pdbid="+$("#"+e.pre+"vastpdbid").val()+"&chain="+$("#"+e.pre+"vastchainid").val(),n)})),e.myEventCls.onIds("#"+e.pre+"reload_foldseek","click",(function(t){e.icn3d,t.preventDefault(),e.cfg.notebook||dialog.dialog("close");let n=$("#"+e.pre+"foldseekchainids").val(),r=i.convertUniProtInChains(n);i.setLogCmd("load chainalignment "+r,!0),window.open(s+"?chainalign="+r+"&aligntool=tmalign&showalignseq=1&bu=0","_self")})),e.myEventCls.onIds("#"+e.pre+"reload_mmtf","click",(function(t){let n=e.icn3d;t.preventDefault(),e.cfg.notebook||dialog.dialog("close"),i.setLogCmd("load bcif "+$("#"+e.pre+"mmtfid").val(),!1);let r=n.structures&&Object.keys(n.structures).length>0?"_blank":"_self";window.open(s+"?bcifid="+$("#"+e.pre+"mmtfid").val(),r)})),e.myEventCls.onIds("#"+e.pre+"mmtfid","keyup",(function(t){let n=e.icn3d;if(13===t.keyCode){t.preventDefault(),e.cfg.notebook||dialog.dialog("close"),i.setLogCmd("load mmtf "+$("#"+e.pre+"mmtfid").val(),!1);let r=n.structures&&Object.keys(n.structures).length>0?"_blank":"_self";window.open(s+"?mmtfid="+$("#"+e.pre+"mmtfid").val(),r)}})),e.myEventCls.onIds("#"+e.pre+"reload_pdb","click",(function(t){let n=e.icn3d;t.preventDefault(),e.cfg.notebook||dialog.dialog("close"),i.setLogCmd("load pdb "+$("#"+e.pre+"pdbid").val(),!1);let r=n.structures&&Object.keys(n.structures).length>0?"_blank":"_self";window.open(s+"?pdbid="+$("#"+e.pre+"pdbid").val(),r)})),e.myEventCls.onIds("#"+e.pre+"translate_pdb","click",(function(t){let s=e.icn3d;t.preventDefault(),e.cfg.notebook||dialog.dialog("close");let n=$("#"+e.pre+"translateX").val(),r=$("#"+e.pre+"translateY").val(),a=$("#"+e.pre+"translateZ").val();s.transformCls.translateCoord(s.hAtoms,parseFloat(n),parseFloat(r),parseFloat(a)),s.drawCls.draw(),i.setLogCmd("translate pdb "+n+" "+r+" "+a,!0)})),e.myEventCls.onIds("#"+e.pre+"measure_angle","click",(function(t){e.icn3d,t.preventDefault(),e.cfg.notebook||dialog.dialog("close");let s=$("#"+e.pre+"v1X").val(),n=$("#"+e.pre+"v1Y").val(),r=$("#"+e.pre+"v1Z").val(),a=$("#"+e.pre+"v2X").val(),o=$("#"+e.pre+"v2Y").val(),l=$("#"+e.pre+"v2Z").val(),d=new mt(parseFloat(s),parseFloat(n),parseFloat(r)).angleTo(new mt(parseFloat(a),parseFloat(o),parseFloat(l)))/3.1416*180;d=Math.abs(d).toFixed(0),d>180&&(d-=180),d>90&&(d=180-d),i.setLogCmd("The angle is "+d+" degree",!1),$("#"+e.pre+"angle_value").val(d)})),e.myEventCls.onIds("#"+e.pre+"matrix_pdb","click",(function(t){let s=e.icn3d;t.preventDefault(),e.cfg.notebook||dialog.dialog("close");let n=[];for(let t=0;t<16;++t)n.push(parseFloat($("#"+e.pre+"matrix"+t).val()));s.transformCls.rotateCoord(s.hAtoms,n),s.drawCls.draw(),i.setLogCmd("rotate pdb "+n,!0)})),e.myEventCls.onIds("#"+e.pre+"pdbid","keyup",(function(t){let n=e.icn3d;if(13===t.keyCode){t.preventDefault(),e.cfg.notebook||dialog.dialog("close"),i.setLogCmd("load pdb "+$("#"+e.pre+"pdbid").val(),!1);let r=n.structures&&Object.keys(n.structures).length>0?"_blank":"_self";window.open(s+"?pdbid="+$("#"+e.pre+"pdbid").val(),r)}})),e.myEventCls.onIds("#"+e.pre+"reload_af","click",(function(t){let n=e.icn3d;t.preventDefault(),e.cfg.notebook||dialog.dialog("close"),i.setLogCmd("load af "+$("#"+e.pre+"afid").val(),!1);let r=n.structures&&Object.keys(n.structures).length>0?"_blank":"_self";window.open(s+"?afid="+$("#"+e.pre+"afid").val(),r)})),e.myEventCls.onIds("#"+e.pre+"reload_afmap","click",(async function(t){let s=e.icn3d;t.preventDefault(),e.cfg.notebook||dialog.dialog("close");let n=e.cfg.afid?e.cfg.afid:$("#"+e.pre+"afid").val();i.setLogCmd("set half pae map "+n,!0),await s.contactMapCls.afErrorMap(n)})),e.myEventCls.onIds("#"+e.pre+"reload_afmapfull","click",(async function(t){let s=e.icn3d;t.preventDefault(),e.cfg.notebook||dialog.dialog("close");let n=e.cfg.afid?e.cfg.afid:$("#"+e.pre+"afid").val();i.setLogCmd("set full pae map "+n,!0),await s.contactMapCls.afErrorMap(n,!0)})),e.myEventCls.onIds("#"+e.pre+"afid","keyup",(function(t){let n=e.icn3d;if(13===t.keyCode){t.preventDefault(),e.cfg.notebook||dialog.dialog("close"),i.setLogCmd("load af "+$("#"+e.pre+"afid").val(),!1);let r=n.structures&&Object.keys(n.structures).length>0?"_blank":"_self";window.open(s+"?afid="+$("#"+e.pre+"afid").val(),r)}})),e.myEventCls.onIds("#"+e.pre+"reload_opm","click",(function(t){let n=e.icn3d;t.preventDefault(),e.cfg.notebook||dialog.dialog("close"),i.setLogCmd("load opm "+$("#"+e.pre+"opmid").val(),!1);let r=n.structures&&Object.keys(n.structures).length>0?"_blank":"_self";window.open(s+"?opmid="+$("#"+e.pre+"opmid").val(),r)})),e.myEventCls.onIds("#"+e.pre+"opmid","keyup",(function(t){let n=e.icn3d;if(13===t.keyCode){t.preventDefault(),e.cfg.notebook||dialog.dialog("close"),i.setLogCmd("load opm "+$("#"+e.pre+"opmid").val(),!1);let r=n.structures&&Object.keys(n.structures).length>0?"_blank":"_self";window.open(s+"?opmid="+$("#"+e.pre+"opmid").val(),r)}})),e.myEventCls.onIds("#"+e.pre+"reload_align_refined","click",(function(t){let n=e.icn3d;t.preventDefault(),e.cfg.notebook||dialog.dialog("close");let r=$("#"+e.pre+"alignid1").val()+","+$("#"+e.pre+"alignid2").val();i.setLogCmd("load alignment "+r+" | parameters &atype=1&bu=1",!1);let a=n.structures&&Object.keys(n.structures).length>0?"_blank":"_self";window.open(s+"?align="+r+"&showalignseq=1&atype=1&bu=1",a)})),e.myEventCls.onIds("#"+e.pre+"reload_align_ori","click",(function(t){let n=e.icn3d;t.preventDefault(),e.cfg.notebook||dialog.dialog("close");let r=$("#"+e.pre+"alignid1").val()+","+$("#"+e.pre+"alignid2").val();i.setLogCmd("load alignment "+r+" | parameters &atype=0&bu=1",!1);let a=n.structures&&Object.keys(n.structures).length>0?"_blank":"_self";window.open(s+"?align="+r+"&showalignseq=1&atype=0&bu=1",a)})),e.myEventCls.onIds("#"+e.pre+"reload_align_tmalign","click",(function(t){let n=e.icn3d;t.preventDefault(),e.cfg.notebook||dialog.dialog("close");let r=$("#"+e.pre+"alignid1").val()+","+$("#"+e.pre+"alignid2").val();i.setLogCmd("load alignment "+r+" | parameters &atype=2&bu=1",!1);let a=n.structures&&Object.keys(n.structures).length>0?"_blank":"_self";window.open(s+"?align="+r+"&showalignseq=1&atype=2&bu=1",a)})),e.myEventCls.onIds("#"+e.pre+"reload_alignaf","click",(function(t){let n=e.icn3d;t.preventDefault(),e.cfg.notebook||dialog.dialog("close");let r=$("#"+e.pre+"alignafid1").val()+"_A,"+$("#"+e.pre+"alignafid2").val()+"_A";i.setLogCmd("load chains "+r+" | residues | resdef ",!1);let a=n.structures&&Object.keys(n.structures).length>0?"_blank":"_self";window.open(s+"?chainalign="+r+"&resnum=&resdef=&showalignseq=1",a)})),e.myEventCls.onIds("#"+e.pre+"reload_alignaf_tmalign","click",(function(t){let n=e.icn3d;t.preventDefault(),e.cfg.notebook||dialog.dialog("close");let r=$("#"+e.pre+"alignafid1").val()+"_A,"+$("#"+e.pre+"alignafid2").val()+"_A";i.setLogCmd("load chains "+r+" | residues | resdef | align tmalign",!1);let a=n.structures&&Object.keys(n.structures).length>0?"_blank":"_self";window.open(s+"?chainalign="+r+"&aligntool=tmalign&resnum=&resdef=&showalignseq=1",a)})),e.myEventCls.onIds("#"+e.pre+"reload_chainalign_asym","click",(function(t){let n=e.icn3d;t.preventDefault(),e.cfg.notebook||dialog.dialog("close");let r=$("#"+e.pre+"chainalignids").val(),a=i.convertUniProtInChains(r);i.setLogCmd("load chains "+a+" on asymmetric unit | residues | resdef ",!1);let o=n.structures&&Object.keys(n.structures).length>0?"_blank":"_self";window.open(s+"?chainalign="+a+"&resnum=&resdef=&showalignseq=1&bu=0",o)})),e.myEventCls.onIds("#"+e.pre+"reload_chainalign_asym2","click",(function(t){let n=e.icn3d;t.preventDefault(),e.cfg.notebook||dialog.dialog("close");let r=$("#"+e.pre+"chainalignids2").val(),a=i.convertUniProtInChains(r),o=$("#"+e.pre+"resalignids").val();i.setLogCmd("load chains "+a+" on asymmetric unit | residues "+o+" | resdef ",!1);let l=n.structures&&Object.keys(n.structures).length>0?"_blank":"_self";window.open(s+"?chainalign="+a+"&resnum="+o+"&resdef=&showalignseq=1&bu=0",l)})),e.myEventCls.onIds("#"+e.pre+"reload_chainalign_asym3","click",(function(t){let n=e.icn3d;t.preventDefault(),e.cfg.notebook||dialog.dialog("close");let r=$("#"+e.pre+"chainalignids3").val(),a=i.convertUniProtInChains(r),o=$("#"+e.pre+"predefinedres").val().trim().replace(/\n/g,": ");if(o&&a.split(",").length-1!=o.split(": ").length)return void alert("Please make sure the number of chains and the lines of predefined residues are the same...");i.setLogCmd("load chains "+a+" on asymmetric unit | residues | resdef "+o,!1);let l=n.structures&&Object.keys(n.structures).length>0?"_blank":"_self";window.open(s+"?chainalign="+a+"&resnum=&resdef="+o+"&showalignseq=1&bu=0",l)})),e.myEventCls.onIds("#"+e.pre+"reload_chainalign_asym4","click",(async function(t){let s=e.icn3d;t.preventDefault(),e.cfg.notebook||dialog.dialog("close");let n=$("#"+e.pre+"chainalignids4").val(),r=i.convertUniProtInChains(n),a=$("#"+e.pre+"predefinedres2").val().trim().replace(/\n/g,": ");if(a&&r.split(",").length-1!=a.split(": ").length)return void alert("Please make sure the number of chains and the lines of predefined residues are the same...");e.cfg.resdef=a.replace(/:/gi,";");let o=r.split(",");await s.realignParserCls.realignChainOnSeqAlign(void 0,o,!0,!0),i.setLogCmd("realign predefined "+r+" "+a,!0)})),e.myEventCls.onIds("#"+e.pre+"reload_chainalign_tmalign","click",(function(t){let n=e.icn3d;t.preventDefault(),e.cfg.notebook||dialog.dialog("close");let r=$("#"+e.pre+"chainalignids").val(),a=i.convertUniProtInChains(r);i.setLogCmd("load chains "+a+" on asymmetric unit | residues | resdef | align tmalign",!1);let o=n.structures&&Object.keys(n.structures).length>0?"_blank":"_self";window.open(s+"?chainalign="+a+"&aligntool=tmalign&resnum=&resdef=&showalignseq=1&bu=0",o)})),e.myEventCls.onIds("#"+e.pre+"reload_mutation_3d","click",(async function(t){let n=e.icn3d;t.preventDefault(),e.cfg.notebook||dialog.dialog("close");let r,a,o=$("#"+e.pre+"mutationids").val();if(r=$("#"+e.pre+"type_mmdbid").is(":checked")?"mmdbid":"afid",a=$("#"+e.pre+"showin_currentpage").is(":checked")?"currentpage":"newpage","currentpage"==a){let e=o;await n.scapCls.retrieveScap(e),i.setLogCmd("scap 3d "+e,!0),i.setLogCmd("select displayed set",!0)}else{let e=o.substr(0,o.indexOf("_"));i.setLogCmd("3d of mutation "+o,!1);let t=n.structures&&Object.keys(n.structures).length>0?"_blank":"_self";window.open(s+"?"+r+"="+e+"&command=scap 3d "+o+"; select displayed set",t)}})),e.myEventCls.onIds("#"+e.pre+"reload_mutation_pdb","click",(async function(t){let n=e.icn3d;t.preventDefault(),e.cfg.notebook||dialog.dialog("close");let r,a,o=$("#"+e.pre+"mutationids").val();if(r=$("#"+e.pre+"type_mmdbid").is(":checked")?"mmdbid":"afid",a=$("#"+e.pre+"showin_currentpage").is(":checked")?"currentpage":"newpage","currentpage"==a){let e=o,t=!0;await n.scapCls.retrieveScap(e,void 0,t),i.setLogCmd("scap pdb "+e,!0)}else{let e=o.substr(0,o.indexOf("_"));i.setLogCmd("pdb of mutation "+o,!1);let t=n.structures&&Object.keys(n.structures).length>0?"_blank":"_self";window.open(s+"?"+r+"="+e+"&command=scap pdb "+o+"; select displayed set",t)}})),e.myEventCls.onIds("#"+e.pre+"reload_mutation_inter","click",(async function(t){let n=e.icn3d;t.preventDefault(),e.cfg.notebook||dialog.dialog("close");let r,a,o=$("#"+e.pre+"mutationids").val();if(r=$("#"+e.pre+"type_mmdbid").is(":checked")?"mmdbid":"afid",a=$("#"+e.pre+"showin_currentpage").is(":checked")?"currentpage":"newpage","currentpage"==a){let e=o,t=!0;await n.scapCls.retrieveScap(e,t),i.setLogCmd("scap interaction "+e,!0);let s=e.split("_"),r="."+s[1]+":"+s[2],a="snp_"+s[1]+"_"+s[2];i.setLogCmd("select "+r+" | name "+a,!0),i.setLogCmd("line graph interaction pairs | selected non-selected | hbonds,salt bridge,interactions,halogen,pi-cation,pi-stacking | false | threshold 3.8 6 4 3.8 6 5.5",!0),i.setLogCmd("adjust dialog dl_linegraph",!0),i.setLogCmd("select displayed set",!0)}else{let e=o.split(","),t=[];for(let i=0,s=e.length;i<s;++i){let s=e[i].lastIndexOf("_"),n=e[i].substr(0,s);t.push(n)}let a=o.substr(0,o.indexOf("_"));n.structures||(n.structures={},n.structures[a]=1),n.resid2specCls.residueids2spec(t),i.setLogCmd("interaction change of mutation "+o,!1);let l=n.structures&&Object.keys(n.structures).length>0?"_blank":"_self";window.open(s+"?"+r+"="+a+"&command=scap interaction "+o,l)}})),e.myEventCls.onIds("#"+e.pre+"reload_mmcif","click",(function(t){let n=e.icn3d;t.preventDefault(),e.cfg.notebook||dialog.dialog("close"),i.setLogCmd("load mmcif "+$("#"+e.pre+"mmcifid").val(),!1);let r=n.structures&&Object.keys(n.structures).length>0?"_blank":"_self";window.open(s+"?mmcifid="+$("#"+e.pre+"mmcifid").val(),r)})),e.myEventCls.onIds("#"+e.pre+"mmcifid","keyup",(function(t){let n=e.icn3d;if(13===t.keyCode){t.preventDefault(),e.cfg.notebook||dialog.dialog("close"),i.setLogCmd("load mmcif "+$("#"+e.pre+"mmcifid").val(),!1);let r=n.structures&&Object.keys(n.structures).length>0?"_blank":"_self";window.open(s+"?mmcifid="+$("#"+e.pre+"mmcifid").val(),r)}})),e.myEventCls.onIds("#"+e.pre+"reload_mmdb","click",(function(t){let n=e.icn3d;t.preventDefault(),i.setLogCmd("load mmdb1 "+$("#"+e.pre+"mmdbid").val(),!1);let r=n.structures&&Object.keys(n.structures).length>0?"_blank":"_self";window.open(s+"?mmdbid="+$("#"+e.pre+"mmdbid").val()+"&bu=1",r)})),e.myEventCls.onIds("#"+e.pre+"reload_mmdb_asym","click",(function(t){let n=e.icn3d;t.preventDefault(),i.setLogCmd("load mmdb0 "+$("#"+e.pre+"mmdbid").val(),!1);let r=n.structures&&Object.keys(n.structures).length>0?"_blank":"_self";window.open(s+"?mmdbid="+$("#"+e.pre+"mmdbid").val()+"&bu=0",r)})),e.myEventCls.onIds("#"+e.pre+"reload_mmdbaf","click",(function(t){e.icn3d,t.preventDefault();let n=$("#"+e.pre+"mmdbafid").val();i.launchMmdb(n,1,s)})),e.myEventCls.onIds("#"+e.pre+"reload_mmdbaf_asym","click",(function(t){e.icn3d,t.preventDefault();let n=$("#"+e.pre+"mmdbafid").val();i.launchMmdb(n,0,s)})),e.myEventCls.onIds("#"+e.pre+"reload_mmdbaf_append","click",(function(t){e.icn3d,t.preventDefault();let n=$("#"+e.pre+"mmdbafid").val();i.launchMmdb(n,1,s,!0)})),e.myEventCls.onIds("#"+e.pre+"reload_mmdbaf_asym_append","click",(function(t){e.icn3d,t.preventDefault();let n=$("#"+e.pre+"mmdbafid").val();i.launchMmdb(n,0,s,!0)})),e.myEventCls.onIds("#"+e.pre+"mmdbid","keyup",(function(t){let n=e.icn3d;if(13===t.keyCode){t.preventDefault(),i.setLogCmd("load mmdb1 "+$("#"+e.pre+"mmdbid").val(),!1);let r=n.structures&&Object.keys(n.structures).length>0?"_blank":"_self";window.open(s+"?mmdbid="+$("#"+e.pre+"mmdbid").val()+"&bu=1",r)}})),e.myEventCls.onIds("#"+e.pre+"mmdbafid","keyup",(function(t){if(e.icn3d,13===t.keyCode){t.preventDefault();let n=$("#"+e.pre+"mmdbafid").val();i.launchMmdb(n,1,s)}})),e.myEventCls.onIds("#"+e.pre+"reload_blast_rep_id","click",(function(t){let n=e.icn3d;t.preventDefault(),e.cfg.notebook||dialog.dialog("close");let r=$("#"+e.pre+"query_id").val().trim();if("M_"==r.substr(1,2))return void alert("You are inputting a nucleotide accession "+r+". Please use a protein accession instead.");let a=encodeURIComponent($("#"+e.pre+"query_fasta").val()),o=$("#"+e.pre+"blast_rep_id").val();i.setLogCmd("load seq_struct_ids "+r+","+o,!1),r=""!==r&&void 0!==r?r:a;let l=n.structures&&Object.keys(n.structures).length>0?"_blank":"_self";window.open(s+"?from=icn3d&alg=blast&blast_rep_id="+o+"&query_id="+r+"&command=view annotations; set annotation cdd; set annotation site; set view detailed view; select chain "+o+"; show selection",l)})),e.myEventCls.onIds("#"+e.pre+"run_esmfold","click",(async function(t){let s=e.icn3d;t.preventDefault(),e.cfg.notebook||dialog.dialog("close"),$("#"+e.pre+"dl_mmdbafid").hasClass("ui-dialog-content")&&$("#"+e.pre+"dl_mmdbafid").dialog("close");let n=$("#"+e.pre+"esmfold_fasta").val(),r="stru--";if(-1!=n.indexOf(">")){let e=n.indexOf("\n");if(s.esmTitle=n.substr(1,e-1).trim(),-1!=s.esmTitle.indexOf("|")){let e=s.esmTitle.split("|");r=e.length>2?e[1]:s.esmTitle}else r=-1!=s.esmTitle.indexOf(" ")?s.esmTitle.substr(0,s.esmTitle.indexOf(" ")):s.esmTitle;r.length<6&&(r=r.padEnd(6,"-")),n=n.substr(e+1)}if(n=n.replace(/\s/g,""),n.length>400)return void alert("Your sequence is larger than 400 characters. Please consider to split it as described at https://github.com/facebookresearch/esm/issues/21.");i.setLogCmd("Run ESMFold with the sequence "+n,!1);let a=await e.getAjaxPostPromise("https://api.esmatlas.com/foldSequence/v1/pdb/",n,!0,"Problem in returning PDB from ESMFold server...",void 0,!0,"text");s.bResetAnno=!0,s.bInputfile=!0,s.InputfileType="pdb",s.InputfileData=s.InputfileData?s.InputfileData+"\nENDMDL\n"+a:a,s.bEsmfold=!0;await s.pdbParserCls.loadPdbData(a,r,void 0,!0,void 0,void 0,void 0,s.bEsmfold)})),e.myEventCls.onIds("#"+e.pre+"reload_alignsw","click",(function(t){let n=e.icn3d;t.preventDefault(),e.cfg.notebook||dialog.dialog("close");let r=$("#"+e.pre+"query_id").val().trim();if("M_"==r.substr(1,2))return void alert("You are inputting a nucleotide accession "+r+". Please use a protein accession instead.");let a=encodeURIComponent($("#"+e.pre+"query_fasta").val()),o=$("#"+e.pre+"blast_rep_id").val();i.setLogCmd("load seq_struct_ids_smithwm "+r+","+o,!1),r=""!==r&&void 0!==r?r:a;let l=n.structures&&Object.keys(n.structures).length>0?"_blank":"_self";window.open(s+"?from=icn3d&alg=smithwm&blast_rep_id="+o+"&query_id="+r+"&command=view annotations; set annotation cdd; set annotation site; set view detailed view; select chain "+o+"; show selection",l)})),e.myEventCls.onIds("#"+e.pre+"reload_alignswlocal","click",(function(t){let n=e.icn3d;t.preventDefault(),e.cfg.notebook||dialog.dialog("close");let r=$("#"+e.pre+"query_id").val().trim();if("M_"==r.substr(1,2))return void alert("You are inputting a nucleotide accession "+r+". Please use a protein accession instead.");let a=encodeURIComponent($("#"+e.pre+"query_fasta").val()),o=$("#"+e.pre+"blast_rep_id").val();i.setLogCmd("load seq_struct_ids_local_smithwm "+r+","+o,!1),r=""!==r&&void 0!==r?r:a;let l=n.structures&&Object.keys(n.structures).length>0?"_blank":"_self";window.open(s+"?from=icn3d&alg=local_smithwm&blast_rep_id="+o+"&query_id="+r+"&command=view annotations; set annotation cdd; set annotation site; set view detailed view; select chain "+o+"; show selection",l)})),e.myEventCls.onIds("#"+e.pre+"reload_proteinname","click",(function(t){let n=e.icn3d;t.preventDefault(),e.cfg.notebook||dialog.dialog("close"),i.setLogCmd("load protein "+$("#"+e.pre+"proteinname").val(),!1);let r=n.structures&&Object.keys(n.structures).length>0?"_blank":"_self";window.open(s+"?protein="+$("#"+e.pre+"proteinname").val(),r)})),e.myEventCls.onIds("#"+e.pre+"reload_refseq","click",(function(t){let n=e.icn3d;t.preventDefault(),e.cfg.notebook||dialog.dialog("close"),i.setLogCmd("load refseq "+$("#"+e.pre+"refseqid").val(),!1);let r=n.structures&&Object.keys(n.structures).length>0?"_blank":"_self";window.open(s+"?refseqid="+$("#"+e.pre+"refseqid").val(),r)})),e.myEventCls.onIds("#"+e.pre+"gi","keyup",(function(t){let n=e.icn3d;if(13===t.keyCode){t.preventDefault(),e.cfg.notebook||dialog.dialog("close"),i.setLogCmd("load gi "+$("#"+e.pre+"gi").val(),!1);let r=n.structures&&Object.keys(n.structures).length>0?"_blank":"_self";window.open(s+"?gi="+$("#"+e.pre+"gi").val(),r)}})),e.myEventCls.onIds("#"+e.pre+"reload_uniprotid","click",(function(t){let n=e.icn3d;t.preventDefault(),e.cfg.notebook||dialog.dialog("close"),i.setLogCmd("load uniprotid "+$("#"+e.pre+"uniprotid").val(),!1);let r=n.structures&&Object.keys(n.structures).length>0?"_blank":"_self";window.open(s+"?uniprotid="+$("#"+e.pre+"uniprotid").val(),r)})),e.myEventCls.onIds("#"+e.pre+"uniprotid","keyup",(function(t){let n=e.icn3d;if(13===t.keyCode){t.preventDefault(),e.cfg.notebook||dialog.dialog("close"),i.setLogCmd("load uniprotid "+$("#"+e.pre+"uniprotid").val(),!1);let r=n.structures&&Object.keys(n.structures).length>0?"_blank":"_self";window.open(s+"?uniprotid="+$("#"+e.pre+"uniprotid").val(),r)}})),e.myEventCls.onIds("#"+e.pre+"reload_cid","click",(function(t){let n=e.icn3d;t.preventDefault(),e.cfg.notebook||dialog.dialog("close"),i.setLogCmd("load cid "+$("#"+e.pre+"cid").val(),!1);let r=n.structures&&Object.keys(n.structures).length>0?"_blank":"_self";window.open(s+"?cid="+$("#"+e.pre+"cid").val(),r)})),e.myEventCls.onIds("#"+e.pre+"reload_smiles","click",(function(t){let i=e.icn3d;t.preventDefault(),e.cfg.notebook||dialog.dialog("close");let n=i.structures&&Object.keys(i.structures).length>0?"_blank":"_self";n="_blank",window.open(s+"?smiles="+encodeURIComponent($("#"+e.pre+"smiles").val()),"_blank")})),e.myEventCls.onIds("#"+e.pre+"cid","keyup",(function(t){let n=e.icn3d;if(13===t.keyCode){t.preventDefault(),e.cfg.notebook||dialog.dialog("close"),i.setLogCmd("load cid "+$("#"+e.pre+"cid").val(),!1);let r=n.structures&&Object.keys(n.structures).length>0?"_blank":"_self";window.open(s+"?cid="+$("#"+e.pre+"cid").val(),r)}})),e.htmlCls.setHtmlCls.clickReload_pngimage(),e.myEventCls.onIds("#"+e.pre+"video_start","click",(function(t){let s=e.icn3d;t.preventDefault();const n=document.getElementById(s.pre+"canvas");s.videoRecorder=new MediaRecorder(n.captureStream());const r=[];s.videoRecorder.ondataavailable=e=>{r.push(e.data)},s.videoRecorder.onstop=e=>{const t=new Blob(r,{type:s.videoRecorder.mimeType});let i=s.inputid+"_video";saveAs(t,i)},s.videoRecorder.start(),i.setLogCmd("Video revording started",!1)})),e.myEventCls.onIds("#"+e.pre+"video_end","click",(function(t){let s=e.icn3d;t.preventDefault(),s.videoRecorder.stop(),i.setLogCmd("Video revording ended",!1)})),e.myEventCls.onIds("#"+e.pre+"reload_state","click",(function(t){let s=e.icn3d;t.preventDefault(),i.iniFileLoad(),s.bInputfile||s.init();let n=$("#"+e.pre+"state")[0].files[0];if(n){e.htmlCls.setHtmlCls.fileSupport();let t=new FileReader;t.onload=async function(t){s.bStatefile=!0;let n=t.target.result;i.setLogCmd("load state file "+$("#"+e.pre+"state").val(),!1),s.commands=[],s.optsHistory=[],await s.loadScriptCls.loadScript(n,!0)},t.readAsText(n)}else alert("Please select a file before clicking 'Load'")})),e.myEventCls.onIds("#"+e.pre+"reload_bcfviewpoint","click",(async function(t){e.icn3d,t.preventDefault(),e.cfg.notebook||dialog.dialog("close");let s=$("#"+e.pre+"bcfviewpoint")[0].files[0];s?await i.openBcf(s):alert("Please select a file before clicking 'Load'")})),e.myEventCls.onIds("#"+e.pre+"reload_selectionfile","click",(function(t){let s=e.icn3d;t.preventDefault(),e.cfg.notebook||dialog.dialog("close");let n=$("#"+e.pre+"selectionfile")[0].files[0];if(n){e.htmlCls.setHtmlCls.fileSupport();let t=new FileReader;t.onload=async function(t){let n=t.target.result;await s.selectionCls.loadSelection(n),i.setLogCmd("load selection file "+$("#"+e.pre+"selectionfile").val(),!1)},t.readAsText(n)}else alert("Please select a file before clicking 'Load'")})),e.myEventCls.onIds("#"+e.pre+"reload_collectionfile","click",(function(t){let s=e.icn3d;t.preventDefault();let n=$("#"+e.pre+"collectionfile")[0].files[0];if(n){i.iniFileLoad(),s.dAtoms=e.hashUtilsCls.cloneHash(s.atoms),s.hAtoms=e.hashUtilsCls.cloneHash(s.atoms),e.htmlCls.setHtmlCls.fileSupport();let r=n.name.split(".").pop().toLowerCase(),a={};function o(e){let t=JSON.parse(e),i={};return t.structures.map((({id:e,title:t,description:s,commands:n})=>{e&&e.includes(".pdb")&&(e=e.split(".pdb")[0]),i[e]=[e,t,s,n,!1]})),i}function l(e,t="",i=[]){let n=e.split("\n"),r=[],a=[];n.forEach((e=>{e.startsWith("HEADER")&&(a=[],r.push(a)),a.push(e)}));let o={};return r.forEach((e=>{let n=e[0].replace(/[\n\r]/g,"").trim().split(" ").filter(Boolean),r=n[n.length-1],a=e[1].startsWith("TITLE")?e[1].split("TITLE").pop().trim():r;o[r]=[r,a,t,i,!0];const l=e.map((e=>e.trim()));s.pdbCollection[r]=l})),o}if($("#"+s.pre+"collections_menu").empty(),$("#"+s.pre+"collections_menu").off("change"),dl_collectionAppendStructureNone.checked||void 0===s.allData?(s.bInputfile=!1,s.pdbCollection={},s.allData={},s.allData.all={atoms:{},proteins:{},nucleotides:{},chemicals:{},ions:{},water:{},structures:{},ssbondpnts:{},residues:{},chains:{},chainsSeq:{},defNames2Atoms:{},defNames2Residues:{}},s.allData.prev={},s.selectCollectionsCls.reset()):s.collections&&(a=s.collections),"json"===r||"pdb"===r){let d=new FileReader;d.onload=async function(t){if("json"===r){let e=o(t.target.result);a={...a,...e}}else if("pdb"===r){s.bInputfile=!0;let e=l(t.target.result);a={...a,...e}}let i=await s.selectCollectionsCls.setAtomMenu(a);s.collections=a,$("#"+s.pre+"collections_menu").html(i),await s.selectCollectionsCls.clickStructure(a),$("#"+s.pre+"collections_menu").trigger("change"),e.htmlCls.clickMenuCls.setLogCmd("load collection file "+$("#"+e.pre+"collectionfile").val(),!1)},d.readAsText(n)}else{if("zip"!==r&&"gz"!==r)throw new Error("Invalid file type");{s.bInputfile=!0;let c=new FileReader;c.onload=async function(t){if("zip"===r){let i="./script/jszip.min.js";await e.getAjaxPromise(i,"script");let s=new JSZip;try{let i=await s.loadAsync(t.target.result),n=!1,r=!1,d=!1,c=[],h=[],p=[];for(let e in i.files){let t=i.files[e];t.dir||(e.endsWith(".json")?(n=!0,c.push(t)):e.endsWith(".pdb")?(r=!0,h.push(t)):e.endsWith(".gz")&&(d=!0,p.push(t)))}if(n&&r){let e=[];for(const t of c){let i=await t.async("text");Object.values(o(i)).forEach((t=>{e.push(t)}))}for(const[t,i,s,n,r]of e){let e=h.find((e=>e.name.toLowerCase().includes(t.toLowerCase())));if(e){let i=await e.async("text");Object.values(l(i,s,n)).forEach((e=>{a[t]=e}))}}}else if(n)c.forEach((async e=>{let t=await e.async("text");Object.values(o(t)).forEach((e=>{a[e[0]]=e}))}));else if(r)h.forEach((async e=>{let t=await e.async("text");Object.values(parsedPdbCollection(t)).forEach((e=>{a[e[0]]=e}))}));else if(d){let t="./script/pako.min.js";await e.getAjaxPromise(t,"script");try{for(const e of p){let t=await e.async("uint8array"),i=pako.inflate(t,{to:"string"});Object.values(l(i)).forEach((e=>{a[e[0]]=e}))}}catch(e){console.error("Error loading GZ file",e)}}}catch(e){console.error("Error loading ZIP file",e)}}else if("gz"===r){let i="./script/pako.min.js";await e.getAjaxPromise(i,"script");try{const e=new Uint8Array(t.target.result),i=pako.inflate(e,{to:"string"});a=l(i)}catch(e){console.error("Error loading GZ file",e)}}let i=await s.selectCollectionsCls.setAtomMenu(a);$("#"+s.pre+"collections_menu").html(i),await s.selectCollectionsCls.clickStructure(a),s.collections=a,$("#"+s.pre+"collections_menu").trigger("change"),e.htmlCls.clickMenuCls.setLogCmd("load collection file "+$("#"+e.pre+"collectionfile").val(),!1)},c.onerror=function(e){console.error("Error reading file",e)},c.readAsArrayBuffer(n)}}s.allData&&Object.keys(s.allData).length>0?($("#"+e.pre+"dl_collection_file").hide(),$("#"+e.pre+"dl_collection_structures").show(),$("#"+e.pre+"dl_collection_file_expand").show(),$("#"+e.pre+"dl_collection_file_shrink").hide(),$("#"+e.pre+"dl_collection_structures_expand").hide(),$("#"+e.pre+"dl_collection_structures_shrink").show()):($("#"+e.pre+"dl_collection_file").show(),$("#"+e.pre+"dl_collection_structures").hide(),$("#"+e.pre+"dl_collection_file_expand").hide(),$("#"+e.pre+"dl_collection_file_shrink").hide(),$("#"+e.pre+"dl_collection_structures_expand").show(),$("#"+e.pre+"dl_collection_structures_shrink").hide()),e.htmlCls.dialogCls.openDlg("dl_selectCollections","Select Collections")}else alert("Please select a file before clicking 'Load'")})),e.myEventCls.onIds("#"+e.pre+"collections_clear_commands","click",(function(e){$("#"+t.pre+"collections_menu").val().forEach((function(e){t.allData[e]?t.allData[e].commands=[]:console.warn("No data found for selectedValue:",e)}))})),e.myEventCls.onIds("#"+e.pre+"opendl_export_collections","click",(function(t){e.htmlCls.dialogCls.openDlg("dl_export_collections","Export Collections")})),e.myEventCls.onIds("#"+e.pre+"export_collections","click",(function(t){let i=e.icn3d;const s=document.getElementById(e.pre+"collections_menu"),n=[],r=document.getElementById("dl_collectionExportSelected"),a=document.getElementById("dl_collectionExportAll");r.checked?Array.from(s.options).filter((e=>e.selected)).forEach((e=>{const t=e.value,s=e.textContent.trim(),r=e.getAttribute("data-description");n.push({id:t,title:s,description:r||"",commands:i.allData[t]&&i.allData[t].commands?i.allData[t].commands:[]})})):a.checked&&Array.from(s.options).forEach((e=>{const t=e.value,s=e.textContent.trim(),r=e.getAttribute("data-description");n.push({name:t,title:s,description:r||"",commands:i.allData[t]&&i.allData[t].commands?i.allData[t].commands:[]})}));const o=new Date,l=`${o.getMonth()+1}_${o.getDate()}_${o.getFullYear()}`,d={collectionTitle:document.getElementById("dl_collectionTitle").value,collectionDescription:document.getElementById("dl_collectionDescription").value,structures:n},c=`${d.collectionTitle.replace(/\s+/g,"_")}_${l}.json`,h=JSON.stringify(d,null,2),p=new Blob([h],{type:"application/json"}),u=URL.createObjectURL(p),m=document.createElement("a");m.href=u,m.download=c,document.body.appendChild(m),m.click(),document.body.removeChild(m),URL.revokeObjectURL(u)})),e.myEventCls.onIds("#"+e.pre+"reload_dsn6file2fofc","click",(function(t){let i=e.icn3d;t.preventDefault(),i.dsn6ParserCls.loadDsn6File("2fofc")})),e.myEventCls.onIds("#"+e.pre+"reload_dsn6filefofc","click",(function(t){let i=e.icn3d;t.preventDefault(),i.dsn6ParserCls.loadDsn6File("fofc")})),e.myEventCls.onIds("#"+e.pre+"reload_ccp4file2fofc","click",(function(t){let i=e.icn3d;t.preventDefault(),i.ccp4ParserCls.loadCcp4File("2fofc")})),e.myEventCls.onIds("#"+e.pre+"reload_ccp4filefofc","click",(function(t){let i=e.icn3d;t.preventDefault(),i.ccp4ParserCls.loadCcp4File("fofc")})),e.myEventCls.onIds("#"+e.pre+"reload_mtzfile2fofc","click",(function(t){let i=e.icn3d;t.preventDefault(),i.mtzParserCls.loadMtzFile("2fofc")})),e.myEventCls.onIds("#"+e.pre+"reload_mtzfilefofc","click",(function(t){let i=e.icn3d;t.preventDefault(),i.mtzParserCls.loadMtzFile("fofc")})),e.myEventCls.onIds("#"+e.pre+"reload_rcsbmtzfile2fofc","click",(function(t){let i=e.icn3d;t.preventDefault(),i.mtzParserCls.loadMtzFile("2fofc",!0)})),e.myEventCls.onIds("#"+e.pre+"reload_rcsbmtzfilefofc","click",(function(t){let i=e.icn3d;t.preventDefault(),i.mtzParserCls.loadMtzFile("fofc",!0)})),e.myEventCls.onIds("#"+e.pre+"reload_delphifile","click",(async function(t){let i=e.icn3d;t.preventDefault(),e.cfg.notebook||dialog.dialog("close"),await i.delphiCls.loadDelphiFile("delphi")})),e.myEventCls.onIds("#"+e.pre+"reload_pqrfile","click",(function(t){let i=e.icn3d;t.preventDefault(),e.cfg.notebook||dialog.dialog("close"),i.delphiCls.loadPhiFile("pqr")})),e.myEventCls.onIds("#"+e.pre+"reload_phifile","click",(function(t){let i=e.icn3d;t.preventDefault(),e.cfg.notebook||dialog.dialog("close"),i.delphiCls.loadPhiFile("phi")})),e.myEventCls.onIds("#"+e.pre+"reload_cubefile","click",(function(t){let i=e.icn3d;t.preventDefault(),e.cfg.notebook||dialog.dialog("close"),i.delphiCls.loadPhiFile("cube")})),e.myEventCls.onIds("#"+e.pre+"reload_pqrurlfile","click",(async function(t){let i=e.icn3d;t.preventDefault(),e.cfg.notebook||dialog.dialog("close"),await i.delphiCls.loadPhiFileUrl("pqrurl")})),e.myEventCls.onIds("#"+e.pre+"reload_phiurlfile","click",(async function(t){let i=e.icn3d;t.preventDefault(),e.cfg.notebook||dialog.dialog("close"),await i.delphiCls.loadPhiFileUrl("phiurl")})),e.myEventCls.onIds("#"+e.pre+"reload_cubeurlfile","click",(async function(t){let i=e.icn3d;t.preventDefault(),e.cfg.notebook||dialog.dialog("close"),await i.delphiCls.loadPhiFileUrl("cubeurl")})),e.myEventCls.onIds("#"+e.pre+"reload_delphifile2","click",(async function(t){let i=e.icn3d;t.preventDefault(),e.htmlCls.setHtmlCls.updateSurfPara("delphi"),e.cfg.notebook||dialog.dialog("close"),await i.delphiCls.loadDelphiFile("delphi2")})),e.myEventCls.onIds("#"+e.pre+"reload_pqrfile2","click",(function(t){let i=e.icn3d;t.preventDefault(),e.htmlCls.setHtmlCls.updateSurfPara("phi"),e.cfg.notebook||dialog.dialog("close"),i.delphiCls.loadPhiFile("pqr2")})),e.myEventCls.onIds("#"+e.pre+"reload_phifile2","click",(function(t){let i=e.icn3d;t.preventDefault(),e.htmlCls.setHtmlCls.updateSurfPara("phi"),e.cfg.notebook||dialog.dialog("close"),i.delphiCls.loadPhiFile("phi2")})),e.myEventCls.onIds("#"+e.pre+"reload_cubefile2","click",(function(t){let i=e.icn3d;t.preventDefault(),e.htmlCls.setHtmlCls.updateSurfPara("phi"),e.cfg.notebook||dialog.dialog("close"),i.delphiCls.loadPhiFile("cube2")})),e.myEventCls.onIds("#"+e.pre+"reload_pqrurlfile2","click",(async function(t){let i=e.icn3d;t.preventDefault(),e.htmlCls.setHtmlCls.updateSurfPara("phiurl"),e.cfg.notebook||dialog.dialog("close"),await i.delphiCls.loadPhiFileUrl("pqrurl2")})),e.myEventCls.onIds("#"+e.pre+"reload_phiurlfile2","click",(async function(t){let i=e.icn3d;t.preventDefault(),e.htmlCls.setHtmlCls.updateSurfPara("phiurl"),e.cfg.notebook||dialog.dialog("close"),await i.delphiCls.loadPhiFileUrl("phiurl2")})),e.myEventCls.onIds("#"+e.pre+"reload_cubeurlfile2","click",(async function(t){let i=e.icn3d;t.preventDefault(),e.htmlCls.setHtmlCls.updateSurfPara("phiurl"),e.cfg.notebook||dialog.dialog("close"),await i.delphiCls.loadPhiFileUrl("cubeurl2")})),e.myEventCls.onIds("#"+e.pre+"reload_dsn6fileurl2fofc","click",(function(t){let i=e.icn3d;t.preventDefault(),i.dsn6ParserCls.loadDsn6FileUrl("2fofc")})),e.myEventCls.onIds("#"+e.pre+"reload_dsn6fileurlfofc","click",(function(t){let i=e.icn3d;t.preventDefault(),i.dsn6ParserCls.loadDsn6FileUrl("fofc")})),e.myEventCls.onIds("#"+e.pre+"reload_ccp4fileurl2fofc","click",(function(t){let i=e.icn3d;t.preventDefault(),i.ccp4ParserCls.loadCcp4FileUrl("2fofc")})),e.myEventCls.onIds("#"+e.pre+"reload_ccp4fileurlfofc","click",(function(t){let i=e.icn3d;t.preventDefault(),i.ccp4ParserCls.loadCcp4FileUrl("fofc")})),e.myEventCls.onIds("#"+e.pre+"reload_mtzfileurl2fofc","click",(function(t){let i=e.icn3d;t.preventDefault(),i.mtzParserCls.loadMtzFileUrl("2fofc")})),e.myEventCls.onIds("#"+e.pre+"reload_mtzfileurlfofc","click",(function(t){let i=e.icn3d;t.preventDefault(),i.mtzParserCls.loadMtzFileUrl("fofc")})),e.myEventCls.onIds("#"+e.pre+"reload_rcsbmtzfileurl2fofc","click",(async function(t){let i=e.icn3d;t.preventDefault(),await i.mtzParserCls.loadMtzFileUrl("2fofc",!0)})),e.myEventCls.onIds("#"+e.pre+"reload_rcsbmtzfileurlfofc","click",(async function(t){let i=e.icn3d;t.preventDefault(),await i.mtzParserCls.loadMtzFileUrl("fofc",!0)})),e.myEventCls.onIds("#"+e.pre+"reload_pdbfile","click",(async function(t){e.icn3d,t.preventDefault();await i.loadPdbFile(!1,"pdbfile")})),e.myEventCls.onIds("#"+e.pre+"reload_pdbfile_app","click",(async function(t){let s=e.icn3d;t.preventDefault(),s.bAppend=!0,await i.loadPdbFile(s.bAppend,"pdbfile_app")})),e.myEventCls.onIds("#"+e.pre+"reload_mol2file","click",(function(t){let s=e.icn3d;t.preventDefault(),s.bInitial=!0,i.iniFileLoad();let n=$("#"+e.pre+"mol2file")[0].files[0];if(n){e.htmlCls.setHtmlCls.fileSupport();let t=new FileReader;t.onload=async function(t){let n=t.target.result;i.setLogCmd("load mol2 file "+$("#"+e.pre+"mol2file").val(),!1),s.molTitle="",s.inputid=void 0,s.init(),s.bInputfile=!0,s.InputfileData=s.InputfileData?s.InputfileData+"\nENDMDL\n"+n:n,s.InputfileType="mol2",await s.mol2ParserCls.loadMol2Data(n)},t.readAsText(n)}else alert("Please select a file before clicking 'Load'")})),e.myEventCls.onIds("#"+e.pre+"reload_sdffile","click",(function(t){let s=e.icn3d;t.preventDefault(),s.bInitial=!0,i.iniFileLoad();let n=$("#"+e.pre+"sdffile")[0].files[0];if(n){e.htmlCls.setHtmlCls.fileSupport();let t=new FileReader;t.onload=async function(t){let n=t.target.result;i.setLogCmd("load sdf file "+$("#"+e.pre+"sdffile").val(),!1),s.molTitle="",s.inputid=void 0,s.init(),s.bInputfile=!0,s.InputfileData=s.InputfileData?s.InputfileData+"\nENDMDL\n"+n:n,s.InputfileType="sdf",await s.sdfParserCls.loadSdfData(n)},t.readAsText(n)}else alert("Please select a file before clicking 'Load'")})),e.myEventCls.onIds("#"+e.pre+"reload_xyzfile","click",(function(t){let s=e.icn3d;t.preventDefault(),s.bInitial=!0,i.iniFileLoad();let n=$("#"+e.pre+"xyzfile")[0].files[0];if(n){e.htmlCls.setHtmlCls.fileSupport();let t=new FileReader;t.onload=async function(t){let n=t.target.result;i.setLogCmd("load xyz file "+$("#"+e.pre+"xyzfile").val(),!1),s.molTitle="",s.inputid=void 0,s.init(),s.bInputfile=!0,s.InputfileData=s.InputfileData?s.InputfileData+"\nENDMDL\n"+n:n,s.InputfileType="xyz",await s.xyzParserCls.loadXyzData(n)},t.readAsText(n)}else alert("Please select a file before clicking 'Load'")})),e.myEventCls.onIds("#"+e.pre+"reload_clustalwfile","click",(function(t){let s=e.icn3d;t.preventDefault(),s.bInitial=!0,i.iniFileLoad();let n=$("#"+e.pre+"clustalwfile")[0].files[0];if(n){e.htmlCls.setHtmlCls.fileSupport();let t=new FileReader;t.onload=async function(t){let n=t.target.result;i.setLogCmd("load CLUSTALW file "+$("#"+e.pre+"clustalwfile").val(),!1),s.molTitle="",s.inputid=void 0,s.init(),s.bInputfile=!1,s.InputfileType="clustalw",await s.msaParserCls.loadMsaData(n,"clustalw")},t.readAsText(n)}else alert("Please select a file before clicking 'Load'")})),e.myEventCls.onIds("#"+e.pre+"reload_fastafile","click",(function(t){let s=e.icn3d;t.preventDefault(),s.bInitial=!0,i.iniFileLoad();let n=$("#"+e.pre+"fastafile")[0].files[0];if(n){e.htmlCls.setHtmlCls.fileSupport();let t=new FileReader;t.onload=async function(t){let n=t.target.result;i.setLogCmd("load FASTA file "+$("#"+e.pre+"fastafile").val(),!1),s.molTitle="",s.inputid=void 0,s.init(),s.bInputfile=!1,s.InputfileType="fasta",await s.msaParserCls.loadMsaData(n,"fasta")},t.readAsText(n)}else alert("Please select a file before clicking 'Load'")})),e.myEventCls.onIds("#"+e.pre+"reload_afmapfile","click",(function(t){let s=e.icn3d;t.preventDefault(),s.bInitial=!0,i.iniFileLoad();let n=$("#"+e.pre+"afmapfile")[0].files[0];if(n){e.htmlCls.setHtmlCls.fileSupport();let t=new FileReader;t.onload=function(t){let n=t.target.result;i.setLogCmd("load AlphaFold PAE file "+$("#"+e.pre+"afmapfile").val(),!1),e.htmlCls.dialogCls.openDlg("dl_alignerrormap","Show Predicted Aligned Error (PAE) map"),s.contactMapCls.processAfErrorMap(JSON.parse(n))},t.readAsText(n)}else alert("Please select a file before clicking 'Load'")})),e.myEventCls.onIds("#"+e.pre+"reload_afmapfilefull","click",(function(t){let s=e.icn3d;t.preventDefault(),s.bInitial=!0,i.iniFileLoad();let n=$("#"+e.pre+"afmapfile")[0].files[0];if(n){e.htmlCls.setHtmlCls.fileSupport();let t=new FileReader;t.onload=function(t){let n=t.target.result;i.setLogCmd("load AlphaFold PAE file "+$("#"+e.pre+"afmapfile").val(),!1),e.htmlCls.dialogCls.openDlg("dl_alignerrormap","Show Predicted Aligned Error (PAE) map"),s.contactMapCls.processAfErrorMap(JSON.parse(n),!0)},t.readAsText(n)}else alert("Please select a file before clicking 'Load'")})),e.myEventCls.onIds("#"+e.pre+"reload_urlfile","click",(async function(t){let s=e.icn3d;t.preventDefault(),s.bInitial=!0,i.iniFileLoad();let n=$("#"+e.pre+"filetype").val(),r=$("#"+e.pre+"urlfile").val();s.inputurl="type="+n+"&url="+encodeURIComponent(r),s.init(),s.bInputfile=!0,s.bInputUrlfile=!0,await s.pdbParserCls.downloadUrl(r,n)})),e.myEventCls.onIds("#"+e.pre+"reload_mmciffile","click",(async function(t){let s=e.icn3d;t.preventDefault(),s.bAppend=!0;await i.loadPdbFile(s.bAppend,"mmciffile",!0)})),e.myEventCls.onIds("#"+e.pre+"applycustomcolor","click",(function(t){let s=e.icn3d;t.preventDefault(),e.cfg.notebook||dialog.dialog("close"),s.setOptionCls.setOption("color",$("#"+e.pre+"colorcustom").val()),i.setLogCmd("color "+$("#"+e.pre+"colorcustom").val(),!0)})),e.myEventCls.onIds(["#"+e.pre+"atomsCustomSphere2","#"+e.pre+"atomsCustomSphere","#"+e.pre+"radius_aroundsphere"],"change",(function(t){e.icn3d.bSphereCalc=!1})),e.myEventCls.onIds("#"+e.pre+"applypick_aroundsphere","click",(function(t){let s=e.icn3d,n=parseFloat($("#"+e.pre+"radius_aroundsphere").val()),r=$("#"+e.pre+"atomsCustomSphere").val(),a=$("#"+e.pre+"atomsCustomSphere2").val();if(0==a.length)alert("Please select the first set at step #1");else{let e="select zone cutoff "+n+" | sets "+a+" "+r+" | "+s.bSphereCalc;s.bSphereCalc||s.showInterCls.pickCustomSphere(n,a,r,s.bSphereCalc),s.bSphereCalc=!0,s.hlUpdateCls.updateHlAll(),i.setLogCmd(e,!0)}})),e.myEventCls.onIds("#"+e.pre+"sphereExport","click",(function(t){let s=e.icn3d;t.preventDefault();let n=parseFloat($("#"+e.pre+"radius_aroundsphere").val()),r=$("#"+e.pre+"atomsCustomSphere").val(),a=$("#"+e.pre+"atomsCustomSphere2").val();if(0==a.length)alert("Please select the first set at step #1");else{s.showInterCls.pickCustomSphere(n,a,r,s.bSphereCalc),s.bSphereCalc=!0;let t=s.viewInterPairsCls.exportSpherePairs(),o=Object.keys(e.utilsCls.getHlStructures()).join(",");s.saveFileCls.saveFile(o+"_sphere_pairs.html","html",t),i.setLogCmd("export pairs | "+a+" "+r+" | dist "+n,!0)}})),e.myEventCls.onIds("#"+e.pre+"apply_adjustmem","click",(function(t){let s=e.icn3d;e.cfg.notebook||dialog.dialog("close");let n=parseFloat($("#"+e.pre+"extra_mem_z").val()),r=parseFloat($("#"+e.pre+"intra_mem_z").val());s.selectionCls.adjustMembrane(n,r);let a="adjust membrane z-axis "+n+" "+r;i.setLogCmd(a,!0)})),e.myEventCls.onIds("#"+e.pre+"apply_selectplane","click",(function(t){let s=e.icn3d;e.cfg.notebook||dialog.dialog("close");let n=parseFloat($("#"+e.pre+"selectplane_z1").val()),r=parseFloat($("#"+e.pre+"selectplane_z2").val());s.selectionCls.selectBtwPlanes(n,r);let a="select planes z-axis "+n+" "+r;i.setLogCmd(a,!0)})),e.myEventCls.onIds(["#"+e.pre+"atomsCustomHbond2","#"+e.pre+"atomsCustomHbond","#"+e.pre+"analysis_hbond","#"+e.pre+"analysis_saltbridge","#"+e.pre+"analysis_contact","#"+e.pre+"hbondthreshold","#"+e.pre+"saltbridgethreshold","#"+e.pre+"contactthreshold"],"change",(function(t){e.icn3d.bHbondCalc=!1})),e.myEventCls.onIds("#"+e.pre+"crossstrucinter","change",(function(t){let s=e.icn3d;t.preventDefault(),s.crossstrucinter=parseInt($("#"+e.pre+"crossstrucinter").val()),i.setLogCmd("cross structure interaction "+s.crossstrucinter,!0)})),e.myEventCls.onIds("#"+e.pre+"applyhbonds","click",(async function(t){let i=e.icn3d;t.preventDefault(),await i.showInterCls.showInteractions("3d")})),e.myEventCls.onIds("#"+e.pre+"applycontactmap","click",(async function(t){let s=e.icn3d;t.preventDefault(),e.cfg.notebook||dialog.dialog("close");let n=parseFloat($("#"+s.pre+"contactdist").val()),r=$("#"+s.pre+"contacttype").val();await s.contactMapCls.contactMap(n,r),i.setLogCmd("contact map | dist "+n+" | type "+r,!0)})),e.myEventCls.onIds("#"+e.pre+"hbondWindow","click",(async function(t){let i=e.icn3d;t.preventDefault(),await i.showInterCls.showInteractions("view")})),e.myEventCls.onIds("#"+e.pre+"areaWindow","click",(function(t){let s=e.icn3d;t.preventDefault();let n=$("#"+e.pre+"atomsCustomHbond").val(),r=$("#"+e.pre+"atomsCustomHbond2").val();s.analysisCls.calcBuriedSurface(r,n),i.setLogCmd("calc buried surface | "+r+" "+n,!0)})),e.myEventCls.onIds("#"+e.pre+"sortSet1","click",(async function(t){let i=e.icn3d;t.preventDefault(),await i.showInterCls.showInteractions("save1")})),$(document).on("click","."+e.pre+"showintercntonly",(function(t){e.icn3d,t.stopImmediatePropagation(),$(".icn3d-border").hide(),i.setLogCmd("table inter count only",!0)})),$(document).on("click","."+e.pre+"showinterdetails",(function(t){e.icn3d,t.stopImmediatePropagation(),$(".icn3d-border").show(),i.setLogCmd("table inter details",!0)})),e.myEventCls.onIds("#"+e.pre+"sortSet2","click",(async function(t){let i=e.icn3d;t.preventDefault(),await i.showInterCls.showInteractions("save2")})),e.myEventCls.onIds("#"+e.pre+"hbondGraph","click",(async function(t){let i=e.icn3d;t.preventDefault(),await i.showInterCls.showInteractions("graph")})),e.myEventCls.onIds("#"+e.pre+"hbondLineGraph","click",(async function(t){let s=e.icn3d;t.preventDefault(),s.bShownRefnum=!1,i.setLogCmd("hide ref number",!0),await s.showInterCls.showInteractions("linegraph")})),e.myEventCls.onIds("#"+e.pre+"hbondLineGraph2","click",(async function(t){let s=e.icn3d;t.preventDefault(),s.bShownRefnum=!0,i.setLogCmd("show ref number",!0),await s.showInterCls.showInteractions("linegraph")})),e.myEventCls.onIds("#"+e.pre+"hbondScatterplot","click",(async function(t){let s=e.icn3d;t.preventDefault(),s.bShownRefnum=!1,i.setLogCmd("hide ref number",!0),await s.showInterCls.showInteractions("scatterplot")})),e.myEventCls.onIds("#"+e.pre+"hbondScatterplot2","click",(async function(t){let s=e.icn3d;t.preventDefault(),s.bShownRefnum=!0,i.setLogCmd("show ref number",!0),await s.showInterCls.showInteractions("scatterplot")})),e.myEventCls.onIds("#"+e.pre+"hbondLigplot","click",(async function(t){let s=e.icn3d;t.preventDefault(),s.bShownRefnum=!1,i.setLogCmd("hide ref number",!0),await s.showInterCls.showInteractions("ligplot")})),$(document).on("click","#"+e.svgid+" circle.selected",(function(t){let i=e.icn3d;t.stopImmediatePropagation();let s=$(this).attr("res");!1!==i.bSelectResidue||i.bShift||i.bCtrl||i.selectionCls.removeSelection(),void 0!==s&&(i.hlSeqCls.selectResidues(s,this),i.hlObjectsCls.addHlObjects())})),e.myEventCls.onIds("#"+e.svgid+"_svg","click",(function(t){let i=e.icn3d;t.preventDefault(),i.saveFileCls.saveSvg(e.svgid,i.inputid+"_force_directed_graph.svg")})),e.myEventCls.onIds("#"+e.svgid+"_png","click",(function(t){let i=e.icn3d;t.preventDefault(),i.saveFileCls.savePng(e.svgid,i.inputid+"_force_directed_graph.png")})),e.myEventCls.onIds("#"+e.svgid+"_json","click",(function(t){let i=e.icn3d;t.preventDefault();let s=i.graphStr.substr(0,i.graphStr.lastIndexOf("}"));s+=e.htmlCls.setHtmlCls.getLinkColor(),i.saveFileCls.saveFile(i.inputid+"_force_directed_graph.json","text",[s])})),$(document).on("click","#"+e.svgid_ct+"_svg",(function(t){let i=e.icn3d;t.preventDefault(),i.saveFileCls.saveSvg(e.svgid_ct,i.inputid+"_cartoon.svg")})),$(document).on("click","#"+e.svgid_ct+"_png",(function(t){let i=e.icn3d;t.preventDefault(),i.saveFileCls.savePng(e.svgid_ct,i.inputid+"_cartoon.png")})),$(document).on("click","#"+e.svgid_ct+"_json",(function(t){let i=e.icn3d;t.preventDefault(),i.saveFileCls.saveFile(i.inputid+"_cartoon.json","text",[i.graphStr])})),$(document).on("change","#"+e.svgid_ct+"_label",(function(t){e.icn3d,t.preventDefault();let s=$("#"+e.svgid_ct+"_label").val();$("#"+e.svgid_ct+" text").removeClass(),$("#"+e.svgid_ct+" text").addClass(s),i.setLogCmd("cartoon label "+s,!0)})),e.myEventCls.onIds("#"+e.linegraphid+"_svg","click",(function(t){let i=e.icn3d;t.preventDefault(),i.saveFileCls.saveSvg(e.linegraphid,i.inputid+"_line_graph.svg")})),e.myEventCls.onIds("#"+e.linegraphid+"_png","click",(function(t){let i=e.icn3d;t.preventDefault(),i.saveFileCls.savePng(e.linegraphid,i.inputid+"_line_graph.png")})),e.myEventCls.onIds("#"+e.linegraphid+"_json","click",(function(t){let i=e.icn3d;t.preventDefault();let s=i.lineGraphStr.substr(0,i.lineGraphStr.lastIndexOf("}"));s+=e.htmlCls.setHtmlCls.getLinkColor(),i.saveFileCls.saveFile(i.inputid+"_line_graph.json","text",[s])})),e.myEventCls.onIds("#"+e.linegraphid+"_scale","change",(function(t){let s=e.icn3d;t.preventDefault();let n=$("#"+e.linegraphid+"_scale").val();$("#"+e.linegraphid).attr("width",(s.linegraphWidth*parseFloat(n)).toString()+"px"),i.setLogCmd("line graph scale "+n,!0)})),e.myEventCls.onIds("#"+e.scatterplotid+"_svg","click",(function(t){let i=e.icn3d;t.preventDefault(),i.saveFileCls.saveSvg(e.scatterplotid,i.inputid+"_scatterplot.svg")})),e.myEventCls.onIds("#"+e.scatterplotid+"_png","click",(function(t){let i=e.icn3d;t.preventDefault(),i.saveFileCls.savePng(e.scatterplotid,i.inputid+"_scatterplot.png")})),e.myEventCls.onIds("#"+e.scatterplotid+"_json","click",(function(t){let i=e.icn3d;t.preventDefault();let s=i.scatterplotStr.substr(0,i.scatterplotStr.lastIndexOf("}"));s+=e.htmlCls.setHtmlCls.getLinkColor(),i.saveFileCls.saveFile(i.inputid+"_scatterplot.json","text",[s])})),e.myEventCls.onIds("#"+e.scatterplotid+"_scale","change",(function(t){let s=e.icn3d;t.preventDefault();let n=$("#"+e.scatterplotid+"_scale").val();$("#"+e.scatterplotid).attr("width",(s.scatterplotWidth*parseFloat(n)).toString()+"px"),i.setLogCmd("scatterplot scale "+n,!0)})),e.myEventCls.onIds("#"+e.ligplotid+"_svg","click",(function(t){let i=e.icn3d;t.preventDefault(),i.saveFileCls.saveSvg(e.ligplotid,i.inputid+"_ligplot.svg",void 0,!0)})),e.myEventCls.onIds("#"+e.ligplotid+"_png","click",(function(t){let i=e.icn3d;t.preventDefault(),i.saveFileCls.savePng(e.ligplotid,i.inputid+"_ligplot.png",void 0,!0)})),e.myEventCls.onIds("#"+e.ligplotid+"_scale","change",(function(t){let s=e.icn3d;t.preventDefault();let n=$("#"+e.ligplotid+"_scale").val();$("#"+e.ligplotid).attr("width",(s.ligplotWidth*parseFloat(n)).toString()+"px"),s.ligplotScale=parseFloat(n),i.setLogCmd("ligplot scale "+n,!0)})),e.myEventCls.onIds("#"+e.contactmapid+"_svg","click",(function(t){let i=e.icn3d;t.preventDefault(),i.saveFileCls.saveSvg(e.contactmapid,i.inputid+"_contactmap.svg",!0)})),e.myEventCls.onIds("#"+e.contactmapid+"_png","click",(function(t){let i=e.icn3d;t.preventDefault(),i.saveFileCls.savePng(e.contactmapid,i.inputid+"_contactmap.png",!0)})),e.myEventCls.onIds("#"+e.contactmapid+"_json","click",(function(t){let i=e.icn3d;t.preventDefault();let s=i.contactmapStr.substr(0,i.contactmapStr.lastIndexOf("}"));s+=e.htmlCls.setHtmlCls.getLinkColor(),i.saveFileCls.saveFile(i.inputid+"_contactmap.json","text",[s])})),e.myEventCls.onIds("#"+e.contactmapid+"_scale","change",(function(t){let s=e.icn3d;t.preventDefault();let n=$("#"+e.contactmapid+"_scale").val();$("#"+e.contactmapid).attr("width",(s.contactmapWidth*parseFloat(n)).toString()+"px"),i.setLogCmd("contactmap scale "+n,!0)})),e.myEventCls.onIds("#"+e.alignerrormapid+"_svg","click",(function(t){let i=e.icn3d;t.preventDefault();$("#"+e.alignerrormapid+"_scale").val(1),$("#"+e.alignerrormapid).attr("width",(i.alignerrormapWidth*parseFloat(1)).toString()+"px"),i.saveFileCls.saveSvg(e.alignerrormapid,i.inputid+"_alignerrormap.svg",!0)})),e.myEventCls.onIds("#"+e.alignerrormapid+"_png","click",(function(t){let i=e.icn3d;t.preventDefault();$("#"+e.alignerrormapid+"_scale").val(1),$("#"+e.alignerrormapid).attr("width",(i.alignerrormapWidth*parseFloat(1)).toString()+"px"),i.saveFileCls.savePng(e.alignerrormapid,i.inputid+"_alignerrormap.png",!0)})),e.myEventCls.onIds("#"+e.alignerrormapid+"_full","click",(async function(t){let i=e.icn3d;t.preventDefault(),await i.contactMapCls.afErrorMap(afid,!0)})),e.myEventCls.onIds("#"+e.alignerrormapid+"_json","click",(function(t){let i=e.icn3d;t.preventDefault();let s=i.alignerrormapStr.substr(0,i.alignerrormapStr.lastIndexOf("}"));s+=e.htmlCls.setHtmlCls.getLinkColor(),i.saveFileCls.saveFile(i.inputid+"_alignerrormap.json","text",[s])})),e.myEventCls.onIds("#"+e.alignerrormapid+"_scale","change",(function(t){let s=e.icn3d;t.preventDefault();let n=$("#"+e.alignerrormapid+"_scale").val();$("#"+e.alignerrormapid).attr("width",(s.alignerrormapWidth*parseFloat(n)).toString()+"px"),i.setLogCmd("alignerrormap scale "+n,!0)})),e.myEventCls.onIds("#"+e.svgid+"_label","change",(function(t){e.icn3d,t.preventDefault();let s=$("#"+e.svgid+"_label").val();$("#"+e.svgid+" text").removeClass(),$("#"+e.svgid+" text").addClass(s),i.setLogCmd("graph label "+s,!0)})),e.myEventCls.onIds("#"+e.svgid+"_hideedges","change",(function(t){let s=e.icn3d;t.preventDefault(),e.htmlCls.hideedges=parseInt($("#"+e.svgid+"_hideedges").val()),e.htmlCls.hideedges?(e.htmlCls.contactInsideColor="FFF",e.htmlCls.hbondInsideColor="FFF",e.htmlCls.ionicInsideColor="FFF"):(e.htmlCls.contactInsideColor="DDD",e.htmlCls.hbondInsideColor="AFA",e.htmlCls.ionicInsideColor="8FF"),void 0!==s.graphStr&&(s.bRender&&e.htmlCls.force&&e.drawGraph(s.graphStr,e.pre+"dl_graph"),i.setLogCmd("hide edges "+e.htmlCls.hideedges,!0))})),e.myEventCls.onIds("#"+e.svgid+"_force","change",(function(t){let s=e.icn3d;t.preventDefault(),e.htmlCls.force=parseInt($("#"+e.svgid+"_force").val()),void 0!==s.graphStr&&(i.setLogCmd("graph force "+e.htmlCls.force,!0),s.getGraphCls.handleForce())})),e.myEventCls.onIds("#"+e.pre+"hbondReset","click",(function(t){let s=e.icn3d;t.preventDefault(),s.viewInterPairsCls.resetInteractionPairs(),i.setLogCmd("reset interaction pairs",!0)})),e.myEventCls.onIds("#"+e.pre+"applypick_labels","click",(function(t){let s=e.icn3d;t.preventDefault(),e.cfg.notebook||dialog.dialog("close");let n=$("#"+e.pre+"labeltext").val(),r=$("#"+e.pre+"labelsize").val(),a=$("#"+e.pre+"labelcolor").val(),o=$("#"+e.pre+"labelbkgd").val();if("0"!==r&&""!==r&&"undefined"!==r||(r=0),"0"!==a&&""!==a&&"undefined"!==a||(a=0),"0"!==o&&""!==o&&"undefined"!==o||(o=0),void 0===s.pAtom||void 0===s.pAtom2)alert("Please pick another atom");else{let e=(s.pAtom.coord.x+s.pAtom2.coord.x)/2,t=(s.pAtom.coord.y+s.pAtom2.coord.y)/2,l=(s.pAtom.coord.z+s.pAtom2.coord.z)/2;s.analysisCls.addLabel(n,e,t,l,r,a,o,"custom"),s.pickpair=!1;let d="",c="",h="";0!=r&&(d=" | size "+r),0!=a&&(c=" | color "+a),0!=o&&(h=" | background "+o),i.setLogCmd("add label "+n+" | x "+e.toPrecision(4)+" y "+t.toPrecision(4)+" z "+l.toPrecision(4)+d+c+h+" | type custom",!0),s.drawCls.draw()}})),e.myEventCls.onIds("#"+e.pre+"applyselection_labels","click",(function(t){let s=e.icn3d;t.preventDefault(),e.cfg.notebook||dialog.dialog("close");let n=$("#"+e.pre+"labeltext2").val(),r=$("#"+e.pre+"labelsize2").val(),a=$("#"+e.pre+"labelcolor2").val(),o=$("#"+e.pre+"labelbkgd2").val();"0"!==r&&""!==r&&"undefined"!==r||(r=0),"0"!==a&&""!==a&&"undefined"!==a||(a=0),"0"!==o&&""!==o&&"undefined"!==o||(o=0);let l=s.applyCenterCls.centerAtoms(e.hashUtilsCls.hash2Atoms(s.hAtoms,s.atoms)),d=l.center.x,c=l.center.y,h=l.center.z;s.analysisCls.addLabel(n,d,c,h,r,a,o,"custom");let p="",u="",m="";0!=r&&(p=" | size "+r),0!=a&&(u=" | color "+a),0!=o&&(m=" | background "+o),i.setLogCmd("add label "+n+" | x "+d.toPrecision(4)+" y "+c.toPrecision(4)+" z "+h.toPrecision(4)+p+u+m+" | type custom",!0),s.drawCls.draw()})),e.myEventCls.onIds("#"+e.pre+"applylabelcolor","click",(function(t){let s=e.icn3d;t.preventDefault(),e.cfg.notebook||dialog.dialog("close"),s.labelcolor=$("#"+e.pre+"labelcolorall").val(),i.setLogCmd("set label color "+s.labelcolor,!0),s.drawCls.draw()})),e.myEventCls.onIds("#"+e.pre+"applypick_stabilizer","click",(function(t){let s=e.icn3d;t.preventDefault(),e.cfg.notebook||dialog.dialog("close"),void 0===s.pAtom||void 0===s.pAtom2?alert("Please pick another atom"):(s.pickpair=!1,i.setLogCmd("add one stabilizer | "+s.pAtom.serial+" "+s.pAtom2.serial,!0),void 0===s.pairArray&&(s.pairArray=[]),s.pairArray.push(s.pAtom.serial),s.pairArray.push(s.pAtom2.serial),s.threeDPrintCls.setThichknessFor3Dprint(),s.drawCls.draw())}));let r=new CP(document.querySelector("#"+e.pre+"colorcustom"));r.on("change",(function(e){this.target.value=e})),e.myEventCls.onIds("#"+e.pre+"colorcustom","input",(function(){let t=$("#"+e.pre+"colorcustom").val();r.set("#"+t).enter()})),e.myEventCls.onIds("#"+e.pre+"colorcustom","keyup",(function(){let t=$("#"+e.pre+"colorcustom").val();r.set("#"+t).enter()})),e.myEventCls.onIds("#"+e.pre+"colorcustom","paste",(function(){let t=$("#"+e.pre+"colorcustom").val();r.set("#"+t).enter()})),e.myEventCls.onIds("#"+e.pre+"colorcustom","cut",(function(){let t=$("#"+e.pre+"colorcustom").val();r.set("#"+t).enter()}));let a=new CP(document.querySelector("#"+e.pre+"labelcolorall"));a.on("change",(function(e){this.target.value=e})),e.myEventCls.onIds("#"+e.pre+"labelcolorall","input",(function(){let t=$("#"+e.pre+"labelcolorall").val();a.set("#"+t).enter()})),e.myEventCls.onIds("#"+e.pre+"labelcolorall","keyup",(function(){let t=$("#"+e.pre+"labelcolorall").val();a.set("#"+t).enter()})),e.myEventCls.onIds("#"+e.pre+"labelcolorall","paste",(function(){let t=$("#"+e.pre+"labelcolorall").val();a.set("#"+t).enter()})),e.myEventCls.onIds("#"+e.pre+"labelcolorall","cut",(function(){let t=$("#"+e.pre+"labelcolorall").val();a.set("#"+t).enter()})),e.myEventCls.onIds("#"+e.pre+"applypick_stabilizer_rm","click",(function(t){let s=e.icn3d;if(t.preventDefault(),e.cfg.notebook||dialog.dialog("close"),void 0===s.pAtom||void 0===s.pAtom2)alert("Please pick another atom");else{s.pickpair=!1,i.setLogCmd("remove one stabilizer | "+s.pAtom.serial+" "+s.pAtom2.serial,!0);let e=[];e.push(s.pAtom.serial),e.push(s.pAtom2.serial),s.threeDPrintCls.removeOneStabilizer(e),s.drawCls.draw()}})),e.myEventCls.onIds("#"+e.pre+"applypick_measuredistance","click",(function(t){let s=e.icn3d;if(t.preventDefault(),e.cfg.notebook||dialog.dialog("close"),s.bMeasureDistance=!1,void 0===s.pAtom||void 0===s.pAtom2)alert("Please pick another atom");else{let t=0,n=0,r=$("#"+e.pre+"linecolor").val(),a=(s.pAtom.coord.x+s.pAtom2.coord.x)/2,o=(s.pAtom.coord.y+s.pAtom2.coord.y)/2,l=(s.pAtom.coord.z+s.pAtom2.coord.z)/2;s.analysisCls.addLineFromPicking("distance");let d=(parseInt(10*s.pAtom.coord.distanceTo(s.pAtom2.coord))/10).toString()+" A";s.analysisCls.addLabel(d,a,o,l,t,r,n,"distance");let c="",h="",p="";0!=r&&(h=" | color "+r),i.setLogCmd("add label "+d+" | x "+a.toPrecision(4)+" y "+o.toPrecision(4)+" z "+l.toPrecision(4)+c+h+p+" | type distance",!0),s.drawCls.draw(),s.pk=2}})),e.myEventCls.onIds("#"+e.pre+"applydist2","click",(function(t){let s=e.icn3d;t.preventDefault(),e.cfg.notebook||dialog.dialog("close"),s.bMeasureDistance=!1;let n=$("#"+e.pre+"atomsCustomDist").val(),r=$("#"+e.pre+"atomsCustomDist2").val();s.analysisCls.measureDistTwoSets(n,r),i.setLogCmd("dist | "+r+" "+n,!0)})),$(document).on("click",".icn3d-distance",(function(t){let s=e.icn3d;t.preventDefault(),s.bMeasureDistance=!1,s.distPnts=[],s.labels.distance=[],s.lines.distance=[];let n=$(this).attr("sets").split("|"),r=[n[0]],a=[n[1]];s.analysisCls.measureDistTwoSets(r,a),i.setLogCmd("dist | "+a+" "+r,!0)})),e.myEventCls.onIds("#"+e.pre+"applydisttable","click",(function(t){let s=e.icn3d;t.preventDefault(),e.cfg.notebook||dialog.dialog("close"),s.bMeasureDistance=!1;let n=$("#"+e.pre+"atomsCustomDistTable").val(),r=$("#"+e.pre+"atomsCustomDistTable2").val();s.analysisCls.measureDistManySets(n,r),e.htmlCls.dialogCls.openDlg("dl_disttable","Distance among the sets"),i.setLogCmd("disttable | "+r+" "+n,!0)})),e.myEventCls.onIds("#"+e.pre+"applyangletable","click",(function(t){let s=e.icn3d;t.preventDefault(),e.cfg.notebook||dialog.dialog("close"),s.bMeasureAngle=!1;let n=$("#"+e.pre+"atomsCustomAngleTable").val(),r=$("#"+e.pre+"atomsCustomAngleTable2").val();s.analysisCls.measureAngleManySets(n,r),e.htmlCls.dialogCls.openDlg("dl_angletable","Angles among the sets"),i.setLogCmd("angletable | "+r+" "+n,!0)})),e.myEventCls.onIds("#"+e.pre+"applylinebtwsets","click",(function(t){let s=e.icn3d;t.preventDefault(),s.bLinebtwsets=!1;let n=$("#"+e.pre+"linebtwsets").val(),r=$("#"+e.pre+"linebtwsets2").val(),a=s.definedSetsCls.getAtomsFromNameArray(n),o=s.definedSetsCls.getAtomsFromNameArray(r),l=s.contactCls.getExtent(a),d=s.contactCls.getExtent(o),c=new mt(l[2][0],l[2][1],l[2][2]),h=new mt(d[2][0],d[2][1],d[2][2]),p=$("#"+e.pre+"linebtwsets_radius").val(),u=$("#"+e.pre+"linebtwsets_customcolor").val(),m=$("#"+e.pre+"linebtwsets_opacity").val(),f="Solid"!=$("#"+e.pre+"linebtwsets_style").val(),g="cylinder",b="add line | x1 "+c.x.toPrecision(4)+" y1 "+c.y.toPrecision(4)+" z1 "+c.z.toPrecision(4)+" | x2 "+h.x.toPrecision(4)+" y2 "+h.y.toPrecision(4)+" z2 "+h.z.toPrecision(4)+" | color "+u+" | dashed "+f+" | type "+g+" | radius "+p+" | opacity "+m;i.setLogCmd(b,!0),s.analysisCls.addLine(c.x,c.y,c.z,h.x,h.y,h.z,u,f,g,p,m),s.drawCls.draw()})),e.myEventCls.onIds("#"+e.pre+"applycartoonshape","click",(function(t){let s=e.icn3d;t.preventDefault(),s.bCartoonshape=!1;let n=$("#"+e.pre+"cartoonshape").val(),r=s.definedSetsCls.getAtomsFromNameArray(n),a=s.contactCls.getExtent(r),o=new mt(a[2][0],a[2][1],a[2][2]),l=$("#"+e.pre+"cartoonshape_shape").val(),d=$("#"+e.pre+"cartoonshape_radius").val(),c=$("#"+e.pre+"cartoonshape_customcolor").val(),h=$("#"+e.pre+"cartoonshape_opacity").val();c="#"+c.replace(/\#/g,"");let p,u=e.parasCls.thr(c);"Sphere"==l?(s.sphereCls.createSphereBase(o,u,d,void 0,void 0,void 0,h),p="add sphere | "+n+" | color "+c+" | opacity "+h+" | radius "+d):(s.boxCls.createBox_base(o,d,u,void 0,void 0,void 0,h),p="add cube | "+n+" | color "+c+" | opacity "+h+" | radius "+d),i.setLogCmd(p,!0),s.shapeCmdHash[p]=1,s.drawCls.draw()})),e.myEventCls.onIds("#"+e.pre+"clearlinebtwsets","click",(function(t){let s=e.icn3d;t.preventDefault(),s.lines.cylinder=[],i.setLogCmd("clear line between sets",!0),s.drawCls.draw()})),e.myEventCls.onIds("#"+e.pre+"clearcartoonshape","click",(function(t){let s=e.icn3d;t.preventDefault(),s.shapeCmdHash={},i.setLogCmd("clear shape",!0),s.drawCls.draw()})),e.myEventCls.onIds("#"+e.pre+"apply_thickness_3dprint","click",(function(t){e.icn3d,t.preventDefault(),e.htmlCls.setHtmlCls.setLineThickness("3dprint")})),e.myEventCls.onIds("#"+e.pre+"apply_thickness_style","click",(function(t){e.icn3d,t.preventDefault(),e.htmlCls.setHtmlCls.setLineThickness("style"),e.htmlCls.setMenuCls.setLogWindow(!0)})),e.myEventCls.onIds("#"+e.pre+"reset_thickness_3dprint","click",(function(t){e.icn3d,t.preventDefault(),e.htmlCls.setHtmlCls.setLineThickness("3dprint",!0)})),e.myEventCls.onIds("#"+e.pre+"reset_thickness_style","click",(function(t){e.icn3d,t.preventDefault(),e.htmlCls.setHtmlCls.setLineThickness("style",!0),e.htmlCls.setMenuCls.setLogWindow(!0)})),e.myEventCls.onIds("#"+e.pre+"reset","click",(function(t){let i=e.icn3d;i.selectionCls.resetAll(),i.bRender&&i.drawCls.draw()})),e.myEventCls.onIds(["#"+e.pre+"toggleHighlight","#"+e.pre+"toggleHighlight2"],"click",(function(t){let s=e.icn3d;t.stopImmediatePropagation(),s.hlUpdateCls.toggleHighlight(),i.setLogCmd("toggle highlight",!0)})),e.myEventCls.onIds("#"+e.pre+"seq_clearselection","click",(function(t){let s=e.icn3d;t.stopImmediatePropagation(),e.cfg.notebook||dialog.dialog("close"),s.hlUpdateCls.clearHighlight(),i.setLogCmd("clear selection",!0)})),e.myEventCls.onIds("#"+e.pre+"seq_clearselection2","click",(function(t){let s=e.icn3d;t.stopImmediatePropagation(),t.preventDefault(),s.hlUpdateCls.clearHighlight(),i.setLogCmd("clear selection",!0)})),e.myEventCls.onIds("#"+e.pre+"alignseq_clearselection","click",(function(t){let s=e.icn3d;t.stopImmediatePropagation(),s.hlUpdateCls.clearHighlight(),i.setLogCmd("clear selection",!0)})),e.myEventCls.onIds("#"+e.pre+"replay","click",(async function(t){let s=e.icn3d;t.stopImmediatePropagation(),s.CURRENTNUMBER++;let n=e.cfg.replay?s.STATENUMBER:s.STATENUMBER-1;if(s.CURRENTNUMBER==n)s.bReplay=0,$("#"+e.pre+"replay").hide();else if(s.commands.length>0&&s.commands[s.CURRENTNUMBER]){await s.loadScriptCls.execCommandsBase(s.CURRENTNUMBER,s.CURRENTNUMBER,s.STATENUMBER);let t=s.commands[s.CURRENTNUMBER].indexOf("|||"),n=-1!=t?s.commands[s.CURRENTNUMBER].substr(0,t):s.commands[s.CURRENTNUMBER],r=30,a=n.length>r?n.substr(0,r)+"...":n,o=s.applyCommandCls.getMenuFromCmd(a);$("#"+e.pre+"replay_cmd").html("Cmd: "+a),$("#"+e.pre+"replay_menu").html("Menu: "+o),i.setLogCmd(n,!0),s.drawCls.draw()}})),t.loadScriptCls.pressCommandtext(),e.myEventCls.onIds("#"+e.pre+"seq_saveselection","click",(function(t){let i=e.icn3d;t.stopImmediatePropagation(),e.cfg.notebook||dialog.dialog("close"),i.selectionCls.saveSelectionPrep();let s=$("#"+e.pre+"seq_command_name").val().replace(/\s+/g,"_");i.selectionCls.saveSelection(s,s)})),e.myEventCls.onIds("#"+e.pre+"seq_saveselection2","click",(function(t){let i=e.icn3d;t.stopImmediatePropagation(),i.selectionCls.saveSelectionPrep();let s=$("#"+e.pre+"seq_command_name2").val().replace(/\s+/g,"_");i.selectionCls.saveSelection(s,s)})),e.myEventCls.onIds("#"+e.pre+"mn2_saveresidue","click",(function(t){let s=e.icn3d;t.stopImmediatePropagation(),e.cfg.notebook||dialog.dialog("close"),s.selectionCls.saveEachResiInSel(),i.setLogCmd("select each residue",!0)})),e.myEventCls.onIds("#"+e.pre+"alignseq_saveselection","click",(function(t){let i=e.icn3d;t.stopImmediatePropagation(),i.selectionCls.saveSelectionPrep();let s=$("#"+e.pre+"alignseq_command_name").val().replace(/\s+/g,"_");i.selectionCls.saveSelection(s,s)})),e.myEventCls.onIds("#"+e.pre+"saveFasta","click",(function(t){e.icn3d,t.stopImmediatePropagation(),i.exportMsa("fasta"),i.setLogCmd("Save alignment in FASTA format",!1)})),e.myEventCls.onIds("#"+e.pre+"saveClustal","click",(function(t){e.icn3d,t.stopImmediatePropagation(),i.exportMsa("clustalw"),i.setLogCmd("Save alignment in CLUSTALWW format",!1)})),e.myEventCls.onIds("#"+e.pre+"saveResbyres","click",(function(t){e.icn3d,t.stopImmediatePropagation(),i.exportMsa("resbyres"),i.setLogCmd("Save alignment in Residue by Residue format to be used in File > Align (or Realign) > Multiple Chain > Residue by Residue",!1)})),$(document).on("click","."+e.pre+"outputselection",(function(t){let s=e.icn3d;t.stopImmediatePropagation(),s.bSelectResidue=!1,s.bSelectAlignResidue=!1,i.setLogCmd("output selection",!0),s.threeDPrintCls.outputSelection()})),$(document).on("click",".icn3d-saveicon",(function(t){e.icn3d,t.stopImmediatePropagation();let s=$(this).attr("pid");i.saveHtml(s),i.setLogCmd("save html "+s,!0)})),$(document).on("click",".icn3d-hideicon",(function(t){let i=e.icn3d;t.stopImmediatePropagation();let s=$(this).attr("pid");if(!e.cfg.notebook)if(void 0===i.dialogHashHideDone&&(i.dialogHashHideDone={}),void 0===i.dialogHashPosToRight&&(i.dialogHashPosToRight={}),i.dialogHashHideDone.hasOwnProperty(s)){let e=i.dialogHashHideDone[s].width,t=i.dialogHashHideDone[s].height,n=i.dialogHashHideDone[s].position;$("#"+s).dialog("option","width",e),$("#"+s).dialog("option","height",t),$("#"+s).dialog("option","position",n),delete i.dialogHashHideDone[s]}else{i.dialogHashHideDone[s]={width:$("#"+s).dialog("option","width"),height:$("#"+s).dialog("option","height"),position:$("#"+s).dialog("option","position")};let e,t=160,n=80;$("#"+s).dialog("option","width",t),$("#"+s).dialog("option","height",n),i.dialogHashPosToRight.hasOwnProperty(s)?e=i.dialogHashPosToRight[s]:(e=Object.keys(i.dialogHashPosToRight).length*(t+10),i.dialogHashPosToRight[s]=e);let r={my:"right bottom",at:"right-"+e+" bottom+60",of:"#"+i.divid,collision:"none"};$("#"+s).dialog("option","position",r)}})),$(document).on("click","."+e.pre+"selres",(function(t){let s=e.icn3d;t.stopImmediatePropagation(),s.bSelOneRes=!1;let n=$("."+e.pre+"seloneres");for(let e=0,t=n.length;e<t;++e)n[e].checked=!1;let r=$(this).attr("resid").split("|");s.hAtoms={},s.selectedResidues={};let a="select ";for(let e=0,t=r.length;e<t;++e){let t=r[e];e>0&&(a+=" or "),a+=s.selectionCls.selectOneResid(t)}s.hlUpdateCls.updateHlAll(),i.setLogCmd(a,!0)})),$(document).on("click","."+e.pre+"seloneres",(function(t){let i=e.icn3d;t.stopImmediatePropagation(),i.bSelOneRes||(i.hAtoms={},i.selectedResidues={},i.bSelOneRes=!0);let s=$(this).attr("resid"),n=$(this).attr("id");$("#"+n).length&&$("#"+n)[0].checked?i.selectionCls.selectOneResid(s):$("#"+n).length&&!$("#"+n)[0].checked&&i.selectionCls.selectOneResid(s,!0),i.hlUpdateCls.updateHlAll()})),$(document).on("click","."+e.pre+"selset",(async function(t){let s=e.icn3d;t.stopImmediatePropagation(),s.bSelOneRes=!1;let n=$("."+e.pre+"seloneres");for(let e=0,t=n.length;e<t;++e)n[e].checked=!1;let r=$(this).attr("cmd");await s.selByCommCls.selectByCommand(r,"",""),s.hlObjectsCls.removeHlObjects(),s.hlObjectsCls.addHlObjects(),i.setLogCmd(r,!0)})),$(document).on("click",".icn3d-addtrack",(function(t){let i=e.icn3d;t.stopImmediatePropagation(),$("#"+e.pre+"anno_custom")[0].checked=!0,$("[id^="+e.pre+"custom]").show();let s=$(this).attr("chainid"),n=i.chainsGene[s].geneId;$("#"+e.pre+"track_chainid").val(s),$("#"+e.pre+"track_geneid").val(n),e.htmlCls.dialogCls.openDlg("dl_addtrack","Add track for Chain: "+s),$("#"+e.pre+"track_gi").focus()})),$(document).on("click",".icn3d-customcolor",(function(t){e.icn3d,t.stopImmediatePropagation();let i=$(this).attr("chainid");$("#"+e.pre+"customcolor_chainid").val(i),e.htmlCls.dialogCls.openDlg("dl_customcolor","Apply custom color or tube for Chain: "+i)})),$(document).on("click",".icn3d-helixsets",(function(t){let s=e.icn3d;t.stopImmediatePropagation();let n=$(this).attr("chainid");s.addTrackCls.defineSecondary(n,"helix"),i.setLogCmd("define helix sets | chain "+n,!0)})),$(document).on("click",".icn3d-sheetsets",(function(t){let s=e.icn3d;t.stopImmediatePropagation();let n=$(this).attr("chainid");s.addTrackCls.defineSecondary(n,"sheet"),i.setLogCmd("define sheet sets | chain "+n,!0)})),$(document).on("click",".icn3d-coilsets",(function(t){let s=e.icn3d;t.stopImmediatePropagation();let n=$(this).attr("chainid");s.addTrackCls.defineSecondary(n,"coil"),i.setLogCmd("define coil sets | chain "+n,!0)})),$(document).on("click",".icn3d-iganchorsets",(function(t){let s=e.icn3d;t.stopImmediatePropagation();let n=$(this).attr("chainid");s.addTrackCls.defineIgstrand(n,"iganchor"),i.setLogCmd("define iganchor sets | chain "+n,!0)})),$(document).on("click",".icn3d-igstrandsets",(function(t){let s=e.icn3d;t.stopImmediatePropagation();let n=$(this).attr("chainid");s.addTrackCls.defineIgstrand(n,"igstrand"),i.setLogCmd("define igstrand sets | chain "+n,!0)})),$(document).on("click",".icn3d-igloopsets",(function(t){let s=e.icn3d;t.stopImmediatePropagation();let n=$(this).attr("chainid");s.addTrackCls.defineIgstrand(n,"igloop"),i.setLogCmd("define igloop sets | chain "+n,!0)})),$(document).on("click",".icn3d-igdomainsets",(function(t){let s=e.icn3d;t.stopImmediatePropagation();let n=$(this).attr("chainid");s.addTrackCls.defineIgstrand(n,"igdomain"),i.setLogCmd("define igdomain sets | chain "+n,!0)})),e.myEventCls.onIds("#"+e.pre+"deletesets","click",(function(t){e.icn3d.definedSetsCls.deleteSelectedSets(),i.setLogCmd("delete selected sets",!0)})),$(document).on("mouseup touchend","accordion",(function(t){let i=e.icn3d;i.bControlGl&&!e.bNode?window.controls&&(window.controls.noRotate=!1,window.controls.noZoom=!1,window.controls.noPan=!1):i.controls&&(i.controls.noRotate=!1,i.controls.noZoom=!1,i.controls.noPan=!1)})),$(document).on("mousedown touchstart","accordion",(function(t){let i=e.icn3d;i.bControlGl&&!e.bNode?window.controls&&(window.controls.noRotate=!0,window.controls.noZoom=!0,window.controls.noPan=!0):i.controls&&(i.controls.noRotate=!0,i.controls.noZoom=!0,i.controls.noPan=!0)})),$(document).on("click",".icn3d-expand",(function(t){e.icn3d,t.stopImmediatePropagation();let i=$(this).attr("id"),s=i.lastIndexOf("_"),n=i.substr(0,s);$("#"+n).show(),$("#"+n+"_expand").hide(),$("#"+n+"_shrink").show()})),$(document).on("click",".icn3d-shrink",(function(t){e.icn3d,t.stopImmediatePropagation();let i=$(this).attr("id"),s=i.lastIndexOf("_"),n=i.substr(0,s);$("#"+n).hide(),$("#"+n+"_expand").show(),$("#"+n+"_shrink").hide()})),window.onscroll=function(t){let i=e.icn3d;"detailed view"==i.view&&0==$(window).scrollTop()&&0==$(window).scrollTop()&&0==$("#"+e.pre+"dl_selectannotations").scrollTop()?i.annotationCls.showFixedTitle():i.annotationCls.hideFixedTitle()},e.myEventCls.onIds("#"+e.pre+"dl_selectannotations","scroll",(function(){"detailed view"==t.view&&0==$(window).scrollTop()&&0==$(window).scrollTop()&&0==$("#"+e.pre+"dl_selectannotations").scrollTop()?t.annotationCls.showFixedTitle():t.annotationCls.hideFixedTitle()})),e.myEventCls.onIds("#"+e.pre+"mn6_themeBlue","click",(function(t){e.icn3d,e.htmlCls.setMenuCls.setTheme("blue"),i.setLogCmd("set theme blue",!0)})),e.myEventCls.onIds("#"+e.pre+"mn6_themeOrange","click",(function(t){e.icn3d,e.htmlCls.setMenuCls.setTheme("orange"),i.setLogCmd("set theme orange",!0)})),e.myEventCls.onIds("#"+e.pre+"mn6_themeBlack","click",(function(t){e.icn3d,e.htmlCls.setMenuCls.setTheme("black"),i.setLogCmd("set theme black",!0)})),e.myEventCls.onIds("#"+e.pre+"viewer","dragover",(function(t){e.icn3d,t.preventDefault(),$("#"+e.pre+"viewer")[0].style.border="5px solid blue"})),e.myEventCls.onIds("#"+e.pre+"viewer","drop",(async function(t){e.icn3d,t.preventDefault();let s=t.dataTransfer.files;for(let n=0,r=t.dataTransfer.files.length;n<r;++n){let r=t.dataTransfer.files[n],a=r.name,o=a.substr(a.lastIndexOf(".")+1).toLowerCase();"pdb"==o||"mmcif"==o||"png"==o?await e.htmlCls.eventsCls.readFile(!0,s,n,"","mmcif"==o,"png"==o):"bcf"==o&&await i.openBcf(r)}$("#"+e.pre+"viewer")[0].style.border="0px solid black"})),$(document).on("click","."+e.pre+"snpin3d",(async function(t){let s=e.icn3d;t.stopImmediatePropagation();let n=$(this).attr("snp");await s.scapCls.retrieveScap(n),i.setLogCmd("scap 3d "+n,!0),i.setLogCmd("select displayed set",!0)})),$(document).on("click","."+e.pre+"snpinter",(async function(t){let s=e.icn3d;t.stopImmediatePropagation();let n=$(this).attr("snp");await s.scapCls.retrieveScap(n,!0),i.setLogCmd("scap interaction "+n,!0);let r=n.split("_"),a="."+r[1]+":"+r[2],o="snp_"+r[1]+"_"+r[2];i.setLogCmd("select "+a+" | name "+o,!0),i.setLogCmd("line graph interaction pairs | selected non-selected | hbonds,salt bridge,interactions,halogen,pi-cation,pi-stacking | false | threshold 3.8 6 4 3.8 6 5.5",!0),i.setLogCmd("adjust dialog dl_linegraph",!0),i.setLogCmd("select displayed set",!0)})),$(document).on("click","."+e.pre+"snppdb",(async function(t){let s=e.icn3d;t.stopImmediatePropagation();let n=$(this).attr("snp");await s.scapCls.retrieveScap(n,void 0,!0),i.setLogCmd("scap pdb "+n,!0)}))}}class Vl{constructor(e){this.icn3dui=e}getAlignSequencesAnnotations(e,t,i,s,n,r){let a=this.icn3dui,o=a.icn3d,l="";e=Object.keys(o.alnChains),r&&(e=e.reverse());let d=0,c={};if(void 0!==e)for(let t=0,i=e.length;t<i;++t){let i=e[t];if(!(o.alnChainsSeq[i]&&o.alnChainsSeq[i].length>0))return{sequencesHtml:l,maxSeqCnt:d};c[i]=1}let h,p=void 0===t||t;p&&(o.hAtoms={});let u,m,f=0,g=0;for(let t=0,r=e.length;t<r;++t){let r=e[t];0==f&&(u=r),m=n&&f>0?u:r,p&&(o.hAtoms=a.hashUtilsCls.unionHash(o.hAtoms,o.alnChains[r]));let b=[],C="",v=void 0!==o.alnChainsSeq[r]?o.alnChainsSeq[r].length:0;v>d&&(d=v);let _,y,S=m.indexOf("_"),w=m.substr(0,S),x=m.substr(S+1);for(let e=0,t=v;e<t;++e)if("-"!=o.alnChainsSeq[r][e].resn){_=o.alnChainsSeq[r][e].resi;break}for(let e=v-1;e>=0;--e)if("-"!=o.alnChainsSeq[r][e].resn){y=o.alnChainsSeq[r][e].resi;break}C+="<span class='icn3d-residueNum' title='starting residue number'>"+_+"</span>",h=!(void 0===e||!c.hasOwnProperty(m));for(let e=0,t=v;e<t;++e){let t="N/A",l="";""!==o.alnChainsSeq[r][e].resi&&(t=o.alnChainsSeq[r][e].resi,l=w+"_"+x+"_"+t,o.alnChainsSeq[r][e].color);let d,c="class='icn3d-residue";if((void 0===s||s)&&(h||void 0!==i&&""!==l&&-1!==i.indexOf(l))&&(c="class='icn3d-residue icn3d-highlightSeq"),c+=""===l?"'":" "+o.alnChainsSeq[r][e].class+"'",o.residues.hasOwnProperty(l)){let e=o.firstAtomObjCls.getFirstCalphaAtomObj(o.residues[l]);d=void 0!==e.color?"#"+e.color.getHexString()+";":"#000000;"}else d="#000000;";if("#FFFFFF;"===d.toUpperCase()&&(d=a.htmlCls.GREYD),n&&0==e){C+="<span style='width:"+g*10+"px'></span>"}""!==l?-1!=o.alnChainsSeq[r][e].resi?C+="<span id='align_"+a.pre+l+"' "+c+" style='color:"+d+"' title='"+o.alnChainsSeq[r][e].resn+o.alnChainsSeq[r][e].resi+"'>"+o.alnChainsSeq[r][e].resn+"</span>":C+="<span>"+o.alnChainsSeq[r][e].resn+"</span>":C+="<span title='"+o.alnChainsSeq[r][e].resn+o.alnChainsSeq[r][e].resi+"'>"+o.alnChainsSeq[r][e].resn+"</span>"}C+="<span class='icn3d-residueNum' title='ending residue number'>"+y+"</span>";let A=e.length,M=void 0!==o.alnChainsAnno[r]?o.alnChainsAnno[r].length:0;for(let t=0,i=M;t<i;++t){b[t]="";let i=t<A?e[A-1-t]:m;b[t]+="<span class='icn3d-residueNum'></span>";for(let e=0,s=o.alnChainsAnno[r][t].length;e<s;++e){let s=o.alnChainsAnno[r][t][e];if("H"==s||"E"==s||"c"==s||"o"==s)if("H"==s)b[t]+=e%2==0?'<span class="icn3d-helix">&nbsp;</span>':'<span class="icn3d-helix2">&nbsp;</span>';else if("E"==s)if(void 0!==o.alnChainsSeq[i][e]){let s=i+"_"+o.alnChainsSeq[i][e].resi;if(o.residues.hasOwnProperty(s)){o.firstAtomObjCls.getFirstCalphaAtomObj(o.residues[s]).ssend?b[t]+='<span class="icn3d-sheet2">&nbsp;</span>':b[t]+='<span class="icn3d-sheet">&nbsp;</span>'}else b[t]+='<span class="icn3d-sheet">&nbsp;</span>'}else b[t]+='<span class="icn3d-sheet">&nbsp;</span>';else b[t]+="c"==s?'<span class="icn3d-coil">&nbsp;</span>':"o"==s?'<span class="icn3d-other">&nbsp;</span>':"<span></span>";else b[t]+="<span>"+s+"</span>"}b[t]+="<span class='icn3d-residueNum'></span>"}let T=r,E=void 0!==o.pdbid_chain2title?o.pdbid_chain2title[m]:"";for(let e=M-1;e>=0;--e){let t=o.alnChainsAnTtl[r][e][0];"SS"==t&&(t=""),l+="<div class='icn3d-residueLine' style='white-space:nowrap;'><div class='icn3d-seqTitle' anno='"+e+"'>"+t+"</div>"+b[e]+"<br/></div>"}l+='<div class="icn3d-seqTitle icn3d-link icn3d-blue" chain="'+r+'" anno="sequence" title="'+E+'">'+T+' </div><span class="icn3d-seqLine">'+C+"</span><br/>",f>0&&(g+=v),++f}return{sequencesHtml:l,maxSeqCnt:d}}}class Wl{constructor(e){this.icn3dui=e}getLink(e,t,i,s){let n=this.icn3dui;return n.icn3d,n.htmlCls.allMenus[e]=t,s&&(n.htmlCls.allMenusSel[e]=s),i&&(n.htmlCls.simpleMenus[e]=1),"<li><span data-pinger id='"+n.pre+e+"' class='icn3d-link'>"+t+"</span></li>"}getMenuText(e,t,i,s,n){let r=this.icn3dui;r.icn3d,r.htmlCls.allMenus[e]=t,n&&(r.htmlCls.allMenusSel[e]=n),s&&(r.htmlCls.simpleMenus[e]=1);let a="icn3d-menupd"==i?" style='padding-left:1.5em!important;'":"";return"<li><span data-pinger id='"+r.pre+e+"'"+a+">"+t+"</span>"}getMenuUrl(e,t,i,s,n){let r=this.icn3dui;return r.icn3d,r.htmlCls.allMenus[e]=i,n&&(r.htmlCls.allMenusSel[e]=n),s&&(r.htmlCls.simpleMenus[e]=1),"<li><a id='"+r.pre+e+"' href='"+t+"' target='_blank'>"+i+"</a></li>"}getMenuSep(){return this.icn3dui.icn3d,"<li class='icn3d-menusep'>-</li>"}getLinkWrapper(e,t,i,s,n,r){let a=this.icn3dui;a.icn3d,a.htmlCls.allMenus[e]=t,n&&(a.htmlCls.allMenusSel[e]=n),s&&(a.htmlCls.simpleMenus[e]=1);let o=r?' style="display:none"':"";return"<li id='"+a.pre+i+"'"+o+"><span data-pinger id='"+a.pre+e+"' class='icn3d-link'>"+t+"</span></li>"}getLinkWrapper2(e,t,i,s,n){let r=this.icn3dui;return r.icn3d,r.htmlCls.allMenus[e]=t,n&&(r.htmlCls.allMenusSel[e]=n),s&&(r.htmlCls.simpleMenus[e]=1),"<li id='"+r.pre+i+"'><span data-pinger id='"+r.pre+e+"' class='icn3d-link'>"+t+"</span>"}getRadio(e,t,i,s,n,r){let a=this.icn3dui;a.icn3d,a.htmlCls.allMenus[t]=i,r&&(a.htmlCls.allMenusSel[t]=r),n&&(a.htmlCls.simpleMenus[t]=1);let o=s?" checked":"";return"<li><label data-pinger id='"+a.pre+t+"' class='icn3d-rad'>"+a.htmlCls.inputRadioStr+"name='"+a.pre+e+"' class='"+a.pre+e+"' v='"+i+"'"+o+"><span class='ui-icon ui-icon-blank'></span> <span class='icn3d-rad-text'>"+i+"</span></label></li>"}getRadioColor(e,t,i,s,n,r,a){let o=this.icn3dui;o.icn3d,o.htmlCls.allMenus[t]=i,a&&(o.htmlCls.allMenusSel[t]=a),r&&(o.htmlCls.simpleMenus[t]=1);let l=n?" checked":"";return"<li><label data-pinger id='"+o.pre+t+"' class='icn3d-rad'>"+o.htmlCls.inputRadioStr+"name='"+o.pre+e+"'"+l+"><span class='ui-icon ui-icon-blank'></span> <span class='icn3d-color-rad-text' color='"+s+"'><span style='background-color:#"+s+"'>"+o.htmlCls.space3+"</span> "+i+"</span></label></li>"}setAdvanced(e){let t=this.icn3dui;t.icn3d;let i=void 0===e?"":e,s=t.cfg.notebook?"icn3d-hidden":"",n=t.htmlCls.divStr+"dl_advanced"+i+"' class='"+s+"'>";return n+="<table width='500'><tr><td valign='top'><table cellspacing='0'>",n+="<tr><td><b>Select:</b></td><td>"+t.htmlCls.inputTextStr+"id='"+t.pre+"command"+i+"' placeholder='$[structures].[chains]:[residues]@[atoms]' size='60'></td></tr>",n+="<tr><td><b>Name:</b></td><td>"+t.htmlCls.inputTextStr+"id='"+t.pre+"command_name"+i+"' placeholder='my_selection' size='60'></td></tr>",n+="<tr><td colspan='2' align='left'>"+t.htmlCls.space3+t.htmlCls.buttonStr+"command_apply"+i+"'><b>Save Selection to Defined Sets</b></button></td></tr>",n+="</table></td>",n+="</tr>",n+="<tr><td>",n+='Specification Tips: <div style="width:20px; margin-top:6px; display:inline-block;"><span id="'+t.pre+"specguide"+i+'_expand" class="ui-icon ui-icon-plus icn3d-expand icn3d-link" style="width:15px;" title="Expand"></span><span id="'+t.pre+"specguide"+i+'_shrink" class="ui-icon ui-icon-minus icn3d-shrink icn3d-link" style="display:none; width:15px;" title="Shrink"></span></div><br>',n+=t.htmlCls.divStr+"specguide"+i+"' style='display:none; width:500px' class='icn3d-box'>",n+='<b>Specification:</b> In the selection "$1HHO,4N7N.A,B,C:5-10,LV,3AlaVal,chemicals@CA,C,C*":',n+='<ul><li>"$1HHO,4N7N" uses "$" to indicate structure selection.<br/>',n+='<li>".A,B,C" uses "." to indicate chain selection.<br/>',n+='<li>":5-10,LV,3LeuVal,chemicals" uses the colon ":" to indicate residue selection. Residue selection could be residue number(5-10), one-letter IUPAC residue name abbreviations(LV), three-letter residue names(AlaVal, "3" indicates each residue name has three letters), or predefined names: "proteins", "nucleotides", "chemicals", "ions", and "water". IUPAC abbreviations can be written either as a contiguous string(e.g., ":LV"), in order to find all instances of that sequence in the structure, or they can be separated by commas(e.g., ":L,V") to select all residues of a given type in the structure(in the latter case, select all Leucine and Valine in the structure).<br/>',n+='<li>"@CA,C,C*" uses "@" to indicate atom name selection. "C*" selects any atom names starting with "C". <br/>',n+='<li>Partial definition is allowed, e.g., ":1-10" selects all residue IDs 1-10 in all chains.<br/>',n+='<li>Different selections can be unioned(with "<b>or</b>", default), intersected(with "<b>and</b>"), or negated(with "<b>not</b>"). For example, ":1-10 or :K" selects all residues 1-10 and all Lys residues. ":1-10 and :K" selects all Lys residues in the range of residue number 1-10. ":1-10 or not :K" selects all residues 1-10, which are not Lys residues.<br/>',n+='<li>The wild card character "X" or "x" can be used to represent any character.',n+="</ul>",n+="<b>Set Operation:</b>",n+='<ul><li>Users can select multiple sets in the menu "Select > Defined Sets".<br/>',n+='<li>Different sets can be unioned(with "<b>or</b>", default), intersected(with "<b>and</b>"), or negated(with "<b>not</b>"). For example, if the "Defined Sets" menu has four sets ":1-10", ":11-20", ":5-15", and ":7-8", the command "saved atoms :1-10 or :11-20 and :5-15 not :7-8" unions all residues 1-10 and 11-20 to get the residues 1-20, then intersects with the residues 5-15 to get the residues 5-15, then exclude the residues 7-8 to get the final residues 5-6 and 9-15.</ul>',n+="<b>Full commands in url or command window:</b>",n+="<ul><li>Select without saving the set: select $1HHO,4N7N.A,B,C:5-10,LV,chemicals@CA,C,C*<br/>",n+="<li>Select and save: select $1HHO,4N7N.A,B,C:5-10,LV,chemicals@CA,C,C* | name my_name</ul>",n+="</div>",n+="</td></tr></table>",n+="</div>",n}getOptionHtml(e,t){let i=this.icn3dui;i.icn3d;let s="";for(let n=0,r=e.length;n<r;++n){let r=e[n];s+=n==t?i.htmlCls.optionStr+"'"+r+"' selected>"+r+"</option>":i.htmlCls.optionStr+"'"+r+"'>"+r+"</option>"}return s}setColorHints(){let e=this.icn3dui;e.icn3d;let t="";return t+=e.htmlCls.divNowrapStr+'<span style="margin-left:33px; color:#00FF00; font-weight:bold">Green</span>: H-Bonds; ',t+='<span style="color:#00FFFF; font-weight:bold">Cyan</span>: Salt Bridge/Ionic; ',t+='<span style="font-weight:bold">Grey</span>: Contacts</div>',t+=e.htmlCls.divNowrapStr+'<span style="margin-left:33px; color:#FF00FF; font-weight:bold">Magenta</span>: Halogen Bonds; ',t+='<span style="color:#FF0000; font-weight:bold">Red</span>: &pi;-Cation; ',t+='<span style="color:#0000FF; font-weight:bold">Blue</span>: &pi;-Stacking</div>',t}setThicknessHtml(e){let t=this.icn3dui,i=t.icn3d,s="",n="3dprint"==e?"1":"0.1",r="3dprint"==e?"1.2":"0.3",a="3dprint"==e?"0.8":"0.4",o="3dprint"==e?"0.8":"0.4",l="3dprint"==e?"1":"0.4",d="3dprint"==e?"0.6":"0.3",c="3dprint"==e?"1":"0.2",h="3dprint"==e?"2":"1.3",p="3dprint"==e?"1.4":"0.8",u=40,m=2,f=1,g=1,b=0,C=1,v=0;if("style"==e){if(""!=this.getCookie("shininess")&&(u=parseFloat(this.getCookie("shininess"))),""!=this.getCookie("light1")&&(m=parseFloat(this.getCookie("light1")),f=parseFloat(this.getCookie("light2")),g=parseFloat(this.getCookie("light3"))),""!=this.getCookie("lineRadius")){n=parseFloat(this.getCookie("lineRadius")),r=parseFloat(this.getCookie("coilWidth")),a=parseFloat(this.getCookie("cylinderRadius"));let e=this.getCookie("crosslinkRadius");o=isNaN(e)?i.crosslinkRadius:parseFloat(e),l=parseFloat(this.getCookie("traceRadius")),d=parseFloat(this.getCookie("dotSphereScale")),c=parseFloat(this.getCookie("ribbonthickness")),h=parseFloat(this.getCookie("helixSheetWidth")),p=parseFloat(this.getCookie("nucleicAcidWidth"))}""!=this.getCookie("glycan")&&(b=parseFloat(this.getCookie("glycan"))),""!=this.getCookie("membrane")&&(C=parseFloat(this.getCookie("membrane"))),""!=this.getCookie("cmdwindow")&&(v=parseFloat(this.getCookie("cmdwindow"))),s+="<b>Note</b>: The following parameters will be saved in cache. You just need to set them once. <br><br>",s+="<b>1. Shininess</b>: "+t.htmlCls.inputTextStr+"id='"+t.pre+"shininess' value='"+u+"' size=4>"+t.htmlCls.space3+"(for the shininess of the 3D objects, default 40)<br/><br/>",s+="<b>2. Three directional lights</b>: <br>",s+="<b>Key Light</b>: "+t.htmlCls.inputTextStr+"id='"+t.pre+"light1' value='"+m+"' size=4>"+t.htmlCls.space3+"(for the light strength of the key light, default 2)<br/>",s+="<b>Fill Light</b>: "+t.htmlCls.inputTextStr+"id='"+t.pre+"light2' value='"+f+"' size=4>"+t.htmlCls.space3+"(for the light strength of the fill light, default 1)<br/>",s+="<b>Back Light</b>: "+t.htmlCls.inputTextStr+"id='"+t.pre+"light3' value='"+g+"' size=4>"+t.htmlCls.space3+"(for the light strength of the back light, default 1)<br/><br/>",s+="<b>3. Thickness</b>: <br>"}return s+="<b>Line Radius</b>: "+t.htmlCls.inputTextStr+"id='"+t.pre+"linerad_"+e+"' value='"+n+"' size=4>"+t.htmlCls.space3+"(for stabilizers, hydrogen bonds, distance lines, default 0.1)<br/>",s+="<b>Coil Radius</b>: "+t.htmlCls.inputTextStr+"id='"+t.pre+"coilrad_"+e+"' value='"+r+"' size=4>"+t.htmlCls.space3+"(for coils, default 0.3)<br/>",s+="<b>Stick Radius</b>: "+t.htmlCls.inputTextStr+"id='"+t.pre+"stickrad_"+e+"' value='"+a+"' size=4>"+t.htmlCls.space3+"(for sticks, default 0.4)<br/>",s+="<b>Cross-Linkage Radius</b>: "+t.htmlCls.inputTextStr+"id='"+t.pre+"crosslinkrad_"+e+"' value='"+o+"' size=4>"+t.htmlCls.space3+"(for cross-linkages, default 0.4)<br/>",s+="<b>Trace Radius</b>: "+t.htmlCls.inputTextStr+"id='"+t.pre+"tracerad_"+e+"' value='"+l+"' size=4>"+t.htmlCls.space3+"(for C alpha trace, O3' trace, default 0.4)<br/>",s+="<b>Ribbon Thickness</b>: "+t.htmlCls.inputTextStr+"id='"+t.pre+"ribbonthick_"+e+"' value='"+c+"' size=4>"+t.htmlCls.space3+"(for helix and sheet ribbons, nucleotide ribbons, default 0.2)<br/>",s+="<b>Protein Ribbon Width</b>: "+t.htmlCls.inputTextStr+"id='"+t.pre+"prtribbonwidth_"+e+"' value='"+h+"' size=4>"+t.htmlCls.space3+"(for helix and sheet ribbons, default 1.3)<br/>",s+="<b>Nucleotide Ribbon Width</b>: "+t.htmlCls.inputTextStr+"id='"+t.pre+"nucleotideribbonwidth_"+e+"' value='"+p+"' size=4>"+t.htmlCls.space3+"(for nucleotide ribbons, default 0.8)<br/>",s+="<b>Ball Scale</b>: "+t.htmlCls.inputTextStr+"id='"+t.pre+"ballscale_"+e+"' value='"+d+"' size=4>"+t.htmlCls.space3+"(for styles 'Ball and Stick' and 'Dot', default 0.3)<br/>","style"==e&&(s+="<br><b>4. Show Glycan Cartoon</b>: "+t.htmlCls.inputTextStr+"id='"+t.pre+"glycan' value='"+b+"' size=4>"+t.htmlCls.space3+"(0: hide, 1: show, default 0)<br/>",s+="<br><b>5. Show Membrane</b>: "+t.htmlCls.inputTextStr+"id='"+t.pre+"membrane' value='"+C+"' size=4>"+t.htmlCls.space3+"(0: hide, 1: show, default 1)<br/>",s+="<br><b>6. Enlarge Command Window</b>: "+t.htmlCls.inputTextStr+"id='"+t.pre+"cmdwindow' value='"+v+"' size=4>"+t.htmlCls.space3+"(0: Regular, 1: Large, default 0)<br/><br/>"),s+=t.htmlCls.spanNowrapStr+""+t.htmlCls.buttonStr+"apply_thickness_"+e+"'>Apply</button></span>&nbsp;&nbsp;&nbsp;",s+=t.htmlCls.spanNowrapStr+""+t.htmlCls.buttonStr+"reset_thickness_"+e+"'>Reset</button></span>",s}getCookie(e){let t=e+"=",i=decodeURIComponent(document.cookie).split(";");for(let e=0;e<i.length;e++){let s=i[e];for(;" "==s.charAt(0);)s=s.substring(1);if(0==s.indexOf(t))return s.substring(t.length,s.length)}return""}setSequenceGuide(e,t){let i=this.icn3dui,s=i.icn3d,n="",r=s&&s.defNames2Atoms?Object.keys(s.defNames2Atoms).length:1;t?n+=i.htmlCls.divStr+"seqguide"+e+"'>":(n+='<div style="width:20px; margin-left:3px; display:inline-block;"><span id="'+i.pre+"seqguide"+e+'_expand" class="ui-icon ui-icon-plus icn3d-expand icn3d-link" style="width:15px;" title="Expand"></span><span id="'+i.pre+"seqguide"+e+'_shrink" class="ui-icon ui-icon-minus icn3d-shrink icn3d-link" style="display:none; width:15px;" title="Shrink"></span></div> ',n+="<div style='min-width:200px; display:inline-block;'><b>Selection:</b> Name: "+i.htmlCls.inputTextStr+"id='"+i.pre+"seq_command_name"+e+"' value='seq_"+r+"' size='5'> "+i.htmlCls.space2+"<button style='white-space:nowrap;' id='"+i.pre+"seq_saveselection"+e+"'>Save</button> <button style='white-space:nowrap; margin-left:20px;' id='"+i.pre+"seq_clearselection"+e+"'>Clear</button></div><br/>",n+=i.htmlCls.divStr+"seqguide"+e+"' style='display:none; white-space:normal;' class='icn3d-box'>"),n+=this.getSelectionHints();return n+="<b>Residue labeling:</b> standard residue with coordinates: UPPER case letter; nonstandard residue with coordinates: the first UPPER case letter plus a period except that water residue uses the letter 'O'; residue missing coordinates: lower case letter."+(i.utilsCls.isMac()&&!i.utilsCls.isMobile()?"<br/><br/><b>Turn on scroll bar:</b> System preferences -> General -> show scroll bars -> check Always":"")+"<br/></div>",n}setAlignSequenceGuide(e,t){let i=this.icn3dui,s=i.icn3d,n="";let r=s&&s.defNames2Atoms?Object.keys(s.defNames2Atoms).length:1;n+='<div style="width:20px; margin-left:3px; display:inline-block;"><span id="'+i.pre+'alignseqguide_expand" class="ui-icon ui-icon-plus icn3d-expand icn3d-link" style="width:15px;" title="Expand"></span><span id="'+i.pre+'alignseqguide_shrink" class="ui-icon ui-icon-minus icn3d-shrink icn3d-link" style="display:none; width:15px;" title="Shrink"></span></div> ',n+="<div style='min-width:200px; display:inline-block;'><b>Selection:</b> Name: "+i.htmlCls.inputTextStr+"id='"+i.pre+"alignseq_command_name' value='alseq_"+r+"' size='10'> "+i.htmlCls.space2+"<button style='white-space:nowrap;' id='"+i.pre+"alignseq_saveselection'>Save</button> <button style='white-space:nowrap; margin-left:20px;' id='"+i.pre+"alignseq_clearselection'>Clear</button></div><br/>",n+="<div style='min-width:200px; display:inline-block; margin-top:3px'><b>Save Alignment</b>: <button style='white-space:nowrap;' id='"+i.pre+"saveFasta'>FASTA</button> <button style='white-space:nowrap; margin-left:20px;' id='"+i.pre+"saveClustal'>CLUSTALW</button> <button style='white-space:nowrap; margin-left:20px;' id='"+i.pre+"saveResbyres'>Residue by Residue</button></div><br/>",n+=i.htmlCls.divStr+"alignseqguide' style='display:none; white-space:normal;' class='icn3d-box'>",n+=this.getSelectionHints();return n+="<b>Residue labeling:</b> aligned residue with coordinates: UPPER case letter; non-aligned residue with coordinates: lower case letter which can be highlighted; residue missing coordinates: lower case letter which can NOT be highlighted."+(i.utilsCls.isMac()&&!i.utilsCls.isMobile()?"<br/><br/><b>Turn on scroll bar:</b> System preferences -> General -> show scroll bars -> check Always":"")+"<br/>",n+="</div>",n}getSelectionHints(){let e=this.icn3dui;e.icn3d;let t="";if(e.utilsCls.isMobile())t+='<b>Select Aligned Sequences:</b> touch to select, touch again to deselect, multiple selection is allowed without Ctrl key, click "Save Selection" to save the current selection.<br/>';else{t+='<b>Select on 1D sequences:</b> drag to select, drag again to deselect, multiple selection is allowed without Ctrl key, click "Save Selection" to save the current selection.<br/><br/>',t+="<b>Select on 2D interaction diagram:</b> click on the nodes or lines. The nodes are chains and can be united with the Ctrl key. The lines are interactions and can NOT be united. Each click on the lines selects half of the lines, i.e., select the interacting residues in one of the two chains.<br/><br/>",t+="<b>Select on 3D structures:</b> "+(e.utilsCls.isMobile()?"use finger to pick":'hold "Alt" and use mouse to pick')+', click the second time to deselect, hold "Ctrl" to union selection, hold "Shift" to select a range, press the up/down arrow to switch among atom/residue/strand/chain/structure, click "Save Selection" to save the current selection.<br/><br/>',t+='<b>Save the current selection</b>(either on 3D structure, 2D interactions, or 1D sequence): open the menu "Select -> Save Selection", specify the name and description for the selection, and click "Save".<br/><br/>'}return t}addGsizeSalt(e){let t=this.icn3dui;t.icn3d;let i="";i+="<span style='white-space:nowrap;font-weight:bold;'>Grid Size: <select id='"+t.pre+e+"gsize'>";i+=this.getOptionHtml(["65","97","129"],0),i+="</select></span>",i+="<span style='white-space:nowrap;font-weight:bold;margin-left:30px;'>Salt Concentration: <select id='"+t.pre+e+"salt'>";return i+=this.getOptionHtml(["0","0.15"],1),i+="</select> M</span><br/>",i}getFootHtml(e,t){let i=this.icn3dui;i.icn3d;let s="<div style='width:500px;'>";return"delphi"==e?i.cfg.cid?s+="<b>Note</b>: Partial charges(MMFF94) are from PubChem Compound SDF files.<br/><br/>":(s+="<b>Note</b>: Only the selected residues are used for <a href='http://honig.c2b2.columbia.edu/delphi'>DelPhi</a> potential calculation by solving linear Poisson-Boltzmann equation.",s+='<div style="width:20px; margin-top:6px; display:inline-block;"><span id="'+i.pre+t+'_expand" class="ui-icon ui-icon-plus icn3d-expand icn3d-link" style="width:15px;" title="Expand"></span><span id="'+i.pre+t+'_shrink" class="ui-icon ui-icon-minus icn3d-shrink icn3d-link" style="display:none; width:15px;" title="Shrink"></span></div><br>',s+=i.htmlCls.divStr+t+"' style='display:none;'>",s+="<br>The hydrogens and partial charges of proteins and nucleotides are added using <a href='http://compbio.clemson.edu/pka_webserver'>DelPhiPKa</a> with the Amber charge and size files. The hydrogens of ligands are added using <a href='http://openbabel.org/wiki/Main_Page'>Open Babel</a>. The partial charges of ligands are calculated using <a href='http://ambermd.org/antechamber/ac.html'>Antechamber</a> with the Gasteiger charge method. All partial charges are calculated at pH 7.<br/><br/>",s+='Lipids are treated as ligands. Please use "HETATM" instead of "ATOM  " for each lipid atom in your PDB file. Each phosphate in lipids is assigned with a charge of -1. You can download PQR and modify it, or prepare your PQR file using other tools. Then load the PQR file at the menu "Analysis > Load PQR/Potential".<br/><br/>',s+="</div>"):(s+="<b>Note</b>: Always load a PDB file before loading a PQR or DelPhi potential file.",s+='<div style="width:20px; margin-top:6px; display:inline-block;"><span id="'+i.pre+t+'_expand" class="ui-icon ui-icon-plus icn3d-expand icn3d-link" style="width:15px;" title="Expand"></span><span id="'+i.pre+t+'_shrink" class="ui-icon ui-icon-minus icn3d-shrink icn3d-link" style="display:none; width:15px;" title="Shrink"></span></div><br>',s+=i.htmlCls.divStr+t+"' style='display:none;'>",s+='The PDB file can be loaded in the URL with "pdbid=" or at "File > Open File". The PQR file can be prepared at the menu "Analysis > Download PQR" with your modification or using other tools. The DelPhi potential file can be calculated at <a href=\'http://compbio.clemson.edu/sapp/delphi_webserver/\'>DelPhi Web Server</a> and be exported as a Cube file. ',"url"==e&&(s+="The PQR or potential file can be accessed in a URL if it is located in the same host as iCn3D."),s+="<br/><br/>",s+="</div>"),s+="</div>",s}getPotentialHtml(e,t){let i=this.icn3dui;i.icn3d;let s,n,r,a,o,l="";a="Equipotential Map",o="Surface with Potential","delphi"==e?n="delphi":"local"==e?(s="pqr",n="phi",r="cube"):"url"==e&&(s="pqrurl",n="phiurl",r="cubeurl"),l+=i.htmlCls.divStr+"dl_"+n+"' class='"+t+"'>",l+=i.htmlCls.setDialogCls.addNotebookTitle("dl_"+n,"DelPhi Potential"),l+=i.htmlCls.divStr+"dl_"+n+"_tabs' style='border:0px;'>",l+="<ul>",l+="<li><a href='#"+i.pre+n+"tab1'>Equipotential Map</a></li>",l+="<li><a href='#"+i.pre+n+"tab2'>Surface with Potential</a></li>",l+="</ul>",l+=i.htmlCls.divStr+n+"tab1'>","delphi"==e&&(l+=this.addGsizeSalt(n+"1")+"<br>"),l+="<span style='white-space:nowrap;font-weight:bold;'>Potential contour at: <select id='"+i.pre+n+"contour'>";let d;l+=this.getOptionHtml(["0.5","1","2","3","4","5","6","7","8","9","10"],2),l+="</select> kT/e(25.6mV at 298K)</span><br/><br/>","delphi"==e?(l+=i.htmlCls.buttonStr+"reload_"+n+"file' style='margin-top: 6px;'>Equipotential Map</button>",l+=i.htmlCls.buttonStr+n+"mapNo' style='margin-left:30px;'>Remove Map</button><br>"):"local"==e?(l+=i.htmlCls.divStr+n+"tab1_tabs' style='border:0px;'>",l+="<ul>",l+="<li><a href='#"+i.pre+n+"tab1_"+s+"'>PQR</a></li>",l+="<li><a href='#"+i.pre+n+"tab1_"+n+"'>Phi</a></li>",l+="<li><a href='#"+i.pre+n+"tab1_"+r+"'>Cube</a></li>",l+="</ul>",d="<span style='margin-left:30px'>"+i.htmlCls.buttonStr+n+"mapNo'>Remove Map</button></span></div>",l+=i.htmlCls.divStr+n+"tab1_"+s+"'>",l+=this.addGsizeSalt(s)+"<br>",l+="<b>PQR File</b>: "+i.htmlCls.inputFileStr+"id='"+i.pre+s+"file'> <br><br>"+i.htmlCls.buttonStr+"reload_"+s+"file' style='margin-top: 6px;'>Equipotential Map</button>"+d,l+=i.htmlCls.divStr+n+"tab1_"+n+"'>",l+="<b>Phi File</b>: "+i.htmlCls.inputFileStr+"id='"+i.pre+n+"file'> <br><br>"+i.htmlCls.buttonStr+"reload_"+n+"file' style='margin-top: 6px;'>Equipotential Map</button>"+d,l+=i.htmlCls.divStr+n+"tab1_"+r+"'>",l+="<b>Cube File</b>: "+i.htmlCls.inputFileStr+"id='"+i.pre+r+"file'> <br><br>"+i.htmlCls.buttonStr+"reload_"+r+"file' style='margin-top: 6px;'>Equipotential Map</button>"+d,l+="</div>"):"url"==e&&(l+=i.htmlCls.divStr+n+"tab1_tabs' style='border:0px;'>",l+="<ul>",l+="<li><a href='#"+i.pre+n+"tab1_"+s+"2'>PQR</a></li>",l+="<li><a href='#"+i.pre+n+"tab1_"+n+"2'>Phi</a></li>",l+="<li><a href='#"+i.pre+n+"tab1_"+r+"2'>Cube</a></li>",l+="</ul>",d="<span style='margin-left:30px'>"+i.htmlCls.buttonStr+n+"mapNo'>Remove Map</button></span></div>",l+=i.htmlCls.divStr+n+"tab1_"+s+"2'>",l+=this.addGsizeSalt(s)+"<br>",l+="<b>PQR URL</b> in the same host: "+i.htmlCls.inputTextStr+"id='"+i.pre+s+"file'> <br><br>"+i.htmlCls.buttonStr+"reload_"+s+"file' style='margin-top: 6px;'>Equipotential Map</button>"+d,l+=i.htmlCls.divStr+n+"tab1_"+n+"2'>",l+="<b>Phi URL</b> in the same host: "+i.htmlCls.inputTextStr+"id='"+i.pre+n+"file'> <br><br>"+i.htmlCls.buttonStr+"reload_"+n+"file' style='margin-top: 6px;'>Equipotential Map</button>"+d,l+=i.htmlCls.divStr+n+"tab1_"+r+"2'>",l+="<b>Cube URL</b> in the same host: "+i.htmlCls.inputTextStr+"id='"+i.pre+r+"file'> <br><br>"+i.htmlCls.buttonStr+"reload_"+r+"file' style='margin-top: 6px;'>Equipotential Map</button>"+d,l+="</div>"),l+="<br>"+this.getFootHtml(e,n+"tab1_foot"),l+="</div>",l+=i.htmlCls.divStr+n+"tab2'>","delphi"==e&&(l+=this.addGsizeSalt(n+"2")+"<br>"),l+="<span style='white-space:nowrap;font-weight:bold;'>Surface with max potential at: <select id='"+i.pre+n+"contour2'>";l+=this.getOptionHtml(["0.5","1","2","3","4","5","6","7","8","9","10"],2),l+="</select> kT/e(25.6mV at 298K)</span><br/><br/>",l+="<b>Surface</b>: <select id='"+i.pre+n+"surftype'>",l+="<option value='21'>Van der Waals</option>",l+="<option value='22' selected>Molecular Surface</option>",l+="<option value='23'>Solvent Accessible</option>",l+="</select>",l+="<span style='margin-left:20px'><b>Opacity</b>: <select id='"+i.pre+n+"surfop'>";return l+=this.getOptionHtml(["1.0","0.9","0.8","0.7","0.6","0.5","0.4","0.3","0.2","0.1"],0),l+="</select></span>",l+="<span style='margin-left:20px'><b>Wireframe</b>: <select id='"+i.pre+n+"surfwf'>",l+="<option value='yes'>Yes</option>",l+="<option value='no' selected>No</option>",l+="</select></span><br/>",l+="<br/>","delphi"==e?(l+=i.htmlCls.buttonStr+"reload_"+n+"file2' style='margin-top: 6px;'>Surface with Potential</button>",l+=i.htmlCls.buttonStr+n+"mapNo2' style='margin-left:30px;'>Remove Surface</button><br>"):"local"==e?(l+=i.htmlCls.divStr+n+"tab2_tabs' style='border:0px;'>",l+="<ul>",l+="<li><a href='#"+i.pre+n+"tab2_"+s+"'>PQR</a></li>",l+="<li><a href='#"+i.pre+n+"tab2_"+n+"'>Phi</a></li>",l+="<li><a href='#"+i.pre+n+"tab2_"+r+"'>Cube</a></li>",l+="</ul>",d="<span style='margin-left:30px'>"+i.htmlCls.buttonStr+n+"mapNo2'>Remove Surface</button></span></div>",l+=i.htmlCls.divStr+n+"tab2_"+s+"'>",l+=this.addGsizeSalt(s+"2")+"<br>",l+="<b>PQR File</b>: "+i.htmlCls.inputFileStr+"id='"+i.pre+s+"file2'> <br><br>"+i.htmlCls.buttonStr+"reload_"+s+"file2' style='margin-top: 6px;'>Surface with Potential</button>"+d,l+=i.htmlCls.divStr+n+"tab2_"+n+"'>",l+="<b>Phi File</b>: "+i.htmlCls.inputFileStr+"id='"+i.pre+n+"file2'> <br><br>"+i.htmlCls.buttonStr+"reload_"+n+"file2' style='margin-top: 6px;'>Surface with Potential</button>"+d,l+=i.htmlCls.divStr+n+"tab2_"+r+"'>",l+="<b>Cube File</b>: "+i.htmlCls.inputFileStr+"id='"+i.pre+r+"file2'> <br><br>"+i.htmlCls.buttonStr+"reload_"+r+"file2' style='margin-top: 6px;'>Surface with Potential</button>"+d,l+="</div>"):"url"==e&&(l+=i.htmlCls.divStr+n+"tab2_tabs' style='border:0px;'>",l+="<ul>",l+="<li><a href='#"+i.pre+n+"tab2_"+s+"2'>PQR</a></li>",l+="<li><a href='#"+i.pre+n+"tab2_"+n+"2'>Phi</a></li>",l+="<li><a href='#"+i.pre+n+"tab2_"+r+"2'>Cube</a></li>",l+="</ul>",d="<span style='margin-left:30px'>"+i.htmlCls.buttonStr+n+"mapNo2'>Remove Surface</button></span></div>",l+=i.htmlCls.divStr+n+"tab2_"+s+"2'>",l+=this.addGsizeSalt(s+"2")+"<br>",l+="<b>PQR URL</b> in the same host: "+i.htmlCls.inputTextStr+"id='"+i.pre+s+"file2'> <br><br>"+i.htmlCls.buttonStr+"reload_"+s+"file2' style='margin-top: 6px;'>Surface with Potential</button>"+d,l+=i.htmlCls.divStr+n+"tab2_"+n+"2'>",l+="<b>Phi URL</b> in the same host: "+i.htmlCls.inputTextStr+"id='"+i.pre+n+"file2'> <br><br>"+i.htmlCls.buttonStr+"reload_"+n+"file2' style='margin-top: 6px;'>Surface with Potential</button>"+d,l+=i.htmlCls.divStr+n+"tab2_"+r+"2'>",l+="<b>Cube URL</b> in the same host: "+i.htmlCls.inputTextStr+"id='"+i.pre+r+"file2'> <br><br>"+i.htmlCls.buttonStr+"reload_"+r+"file2' style='margin-top: 6px;'>Surface with Potential</button>"+d,l+="</div>"),l+="<br>"+this.getFootHtml(e,n+"tab2_foot"),l+="</div>",l+="</div>",l+="</div>",l}async exportPqr(e){let t=this.icn3dui,i=t.icn3d,s={},n={},r=t.hashUtilsCls.intHash(i.dAtoms,i.hAtoms);for(let e in r)i.atoms[e],i.ions.hasOwnProperty(e)?s[e]=1:n[e]=1;let a=e?"pdb":"pqr";if(t.cfg.cid){let r="",o=!e;r+=i.saveFileCls.getAtomPDB(n,o)+i.saveFileCls.getAtomPDB(s,o);let l=Object.keys(t.utilsCls.getHlStructures()).join(",");i.saveFileCls.saveFile(l+"_icn3d."+a,"text",[r])}else{if(t.utilsCls.isCalphaPhosOnly(t.hashUtilsCls.hash2Atoms(n,i.atoms)))return void alert("The potential will not be shown because the side chains are missing in the structure...");let r="",o=!0,l=!0;r+=t.cfg.cid?i.saveFileCls.getAtomPDB(n,!0,void 0,void 0,void 0,void 0,o,l):i.saveFileCls.getAtomPDB(n,void 0,void 0,void 0,void 0,void 0,o,l),r+=i.saveFileCls.getAtomPDB(s,!0,void 0,!0,void 0,void 0,o,l);let d=t.htmlCls.baseUrl+"delphi/delphi.cgi",c={pdb2pqr:r,pdbid:t.cfg.cid?t.cfg.cid:Object.keys(i.structures).toString()},h=await t.getAjaxPostPromise(d,c,!0,void 0,void 0,!0,"text");if(e){let e=h.split("\n"),i="";for(let s=0,n=e.length;s<n;++s){let n=e[s];if("ATOM  "==n.substr(0,6)||"HETATM"==n.substr(0,6)){let e,s=n.substr(12,4).trim();if("ATOM  "==n.substr(0,6))e=s.substr(0,1);else{let i=s.substr(0,2);e=t.parasCls.vdwRadii.hasOwnProperty(i)?i:s.substr(0,1)}i+=n.substr(0,54)+"                      "+e.padStart(2," ")+"\n"}else i+=n+"\n"}h=i}let p=Object.keys(t.utilsCls.getHlStructures()).join(",");i.saveFileCls.saveFile(p+"_icn3d_residues."+a,"text",[h])}}clickReload_pngimage(){let e=this.icn3dui;if(e.icn3d,e.bNode)return;let t=this;e.myEventCls.onIds("#"+e.pre+"reload_pngimage","click",(async function(i){let s=e.icn3d;i.preventDefault(),e.cfg.notebook||dialog.dialog("close"),e.cfg.notebook?s.resizeCanvasCls.closeDialogs():$(".ui-dialog-content").dialog("close");let n=$("#"+e.pre+"pngimage")[0].files;if(n[0]){t.fileSupport();let i=!0,s=!1,r=!0;await e.htmlCls.eventsCls.readFile(i,n,0,"",s,r)}else alert("Please select a file before clicking 'Load'")}))}async loadPng(e,t,i){let s=this.icn3dui,n=s.icn3d,r="Share Link: ",a=e.indexOf(r),o="Start of state file======\n",l=e.indexOf(o),d="",c="";if(-1==a&&-1==l)alert('Please load a PNG image saved by clicking the menu "File > Save File > iCn3D PNG Image"...');else if(-1!=a){let t=e.substr(a+12);s.htmlCls.clickMenuCls.setLogCmd("load iCn3D PNG image "+$("#"+s.pre+"pngimage").val(),!1),window.open(t,"_self")}else if(-1!=l){let s="Start of data file======\n",r=e.indexOf(s);n.bInputfile=-1!=r,n.bInputPNGWithData=n.bInputfile;let a=t?t.replace(/;/g,"\n"):"",o=e.indexOf("End of data file======\n");d=e.substr(r+s.length,o-r-s.length);let h="Start of type file======\n",p=e.indexOf(h),u=e.indexOf("End of type file======\n"),m=e.substr(p+h.length,u-p-h.length-1);n.InputfileType=m;let f=e.indexOf("End of state file======\n");c=e.substr(l+26,f-l-26),c=decodeURIComponent(c+"\n"+a),i&&("pdb"===m?(await n.pdbParserCls.loadPdbData(d),n.commands=[],n.optsHistory=[]):("mol2"===m?await n.mol2ParserCls.loadMol2Data(d):"sdf"===m?await n.sdfParserCls.loadSdfData(d):"xyz"===m?await n.xyzParserCls.loadXyzData(d):"mmcif"===m&&await n.mmcifParserCls.loadMmcifData(d),n.commands=[],n.optsHistory=[]),await n.loadScriptCls.loadScript(c,!0))}return{pdb:d,statefile:c}}fileSupport(){window.File&&window.FileReader&&window.FileList&&window.Blob||alert("The File APIs are not fully supported in this browser.")}getLinkColor(){let e="";return e+=", linkmap: {\n",e+='3: {"type": "peptidebond", "c":""},\n',e+='4: {"type": "ssbond", "c":"FFA500"},\n',e+='5: {"type": "ionic", "c":"0FF"},\n',e+='6: {"type": "ionicInside", "c":"FFF"},\n',e+='11: {"type": "contact", "c":"888"},\n',e+='12: {"type": "contactInside", "c":"FFF"},\n',e+='13: {"type": "hbond", "c":"0F0"},\n',e+='14: {"type": "hbondInside", "c":"FFF"},\n',e+='15: {"type": "clbond", "c":"006400"},\n',e+='17: {"type": "halogen", "c":"F0F"},\n',e+='18: {"type": "halogenInside", "c":"FFF"},\n',e+='19: {"type": "pication", "c":"F00"},\n',e+='20: {"type": "picationInside", "c":"FFF"},\n',e+='21: {"type": "pistacking", "c":"00F"},\n',e+='22: {"type": "pistackingInside", "c":"FFF"}\n',e+="}}\n",', linkmap: {\n3: {"type": "peptidebond", "c":""},\n4: {"type": "ssbond", "c":"FFA500"},\n5: {"type": "ionic", "c":"0FF"},\n6: {"type": "ionicInside", "c":"FFF"},\n11: {"type": "contact", "c":"888"},\n12: {"type": "contactInside", "c":"FFF"},\n13: {"type": "hbond", "c":"0F0"},\n14: {"type": "hbondInside", "c":"FFF"},\n15: {"type": "clbond", "c":"006400"},\n17: {"type": "halogen", "c":"F0F"},\n18: {"type": "halogenInside", "c":"FFF"},\n19: {"type": "pication", "c":"F00"},\n20: {"type": "picationInside", "c":"FFF"},\n21: {"type": "pistacking", "c":"00F"},\n22: {"type": "pistackingInside", "c":"FFF"}\n}}\n'}setCookieForThickness(){let e=this.icn3dui,t=e.icn3d;if(!e.bNode){let e=3650;this.setCookie("lineRadius",t.lineRadius,e),this.setCookie("coilWidth",t.coilWidth,e),this.setCookie("cylinderRadius",t.cylinderRadius,e),this.setCookie("crosslinkRadius",t.crosslinkRadius,e),this.setCookie("traceRadius",t.traceRadius,e),this.setCookie("dotSphereScale",t.dotSphereScale,e),this.setCookie("ribbonthickness",t.ribbonthickness,e),this.setCookie("helixSheetWidth",t.helixSheetWidth,e),this.setCookie("nucleicAcidWidth",t.nucleicAcidWidth,e)}}setLineThickness(e,t){let i=this.icn3dui,s=i.icn3d;if(s.bSetThickness=!0,"style"==e&&(t&&($("#"+i.pre+"shininess").val("40"),$("#"+i.pre+"light1").val("2"),$("#"+i.pre+"light2").val("1"),$("#"+i.pre+"light3").val("1"),$("#"+i.pre+"glycan").val("0"),$("#"+i.pre+"membrane").val("1"),$("#"+i.pre+"cmdwindow").val("0")),s.shininess=parseFloat($("#"+i.pre+"shininess").val()),s.light1=parseFloat($("#"+i.pre+"light1").val()),s.light2=parseFloat($("#"+i.pre+"light2").val()),s.light3=parseFloat($("#"+i.pre+"light3").val()),s.bGlycansCartoon=parseInt($("#"+i.pre+"glycan").val()),s.bMembrane=parseInt($("#"+i.pre+"membrane").val()),s.bCmdWindow=parseInt($("#"+i.pre+"cmdwindow").val())),t&&($("#"+i.pre+"linerad_"+e).val(.1),$("#"+i.pre+"coilrad_"+e).val(.3),$("#"+i.pre+"stickrad_"+e).val(.4),$("#"+i.pre+"crosslinkrad_"+e).val(.4),$("#"+i.pre+"tracerad_"+e).val(.4),$("#"+i.pre+"ballscale_"+e).val(.3),$("#"+i.pre+"ribbonthick_"+e).val(.2),$("#"+i.pre+"prtribbonwidth_"+e).val(1.3),$("#"+i.pre+"nucleotideribbonwidth_"+e).val(.8)),s.lineRadius=parseFloat($("#"+i.pre+"linerad_"+e).val()),s.coilWidth=parseFloat($("#"+i.pre+"coilrad_"+e).val()),s.cylinderRadius=parseFloat($("#"+i.pre+"stickrad_"+e).val()),s.crosslinkRadius=parseFloat($("#"+i.pre+"crosslinkrad_"+e).val()),s.traceRadius=parseFloat($("#"+i.pre+"tracerad_"+e).val()),s.dotSphereScale=parseFloat($("#"+i.pre+"ballscale_"+e).val()),s.ribbonthickness=parseFloat($("#"+i.pre+"ribbonthick_"+e).val()),s.helixSheetWidth=parseFloat($("#"+i.pre+"prtribbonwidth_"+e).val()),s.nucleicAcidWidth=parseFloat($("#"+i.pre+"nucleotideribbonwidth_"+e).val()),!i.bNode){let e=3650;this.setCookie("shininess",s.shininess,e),this.setCookie("light1",s.light1,e),this.setCookie("light2",s.light2,e),this.setCookie("light3",s.light3,e),this.setCookie("glycan",s.bGlycansCartoon,e),this.setCookie("membrane",s.bMembrane,e),this.setCookie("cmdwindow",s.bCmdWindow,e)}if(this.setCookieForThickness(),e=t){let e="reset thickness";i.htmlCls.clickMenuCls.setLogCmd(e,!0),s.bSetThickness=!1,s.threeDPrintCls.resetAfter3Dprint()}else i.htmlCls.clickMenuCls.setLogCmd("set thickness | linerad "+s.lineRadius+" | coilrad "+s.coilWidth+" | stickrad "+s.cylinderRadius+" | crosslinkrad "+s.crosslinkRadius+" | tracerad "+s.traceRadius+" | ribbonthick "+s.ribbonthickness+" | proteinwidth "+s.helixSheetWidth+" | nucleotidewidth "+s.nucleicAcidWidth+" | ballscale "+s.dotSphereScale,!0),i.htmlCls.clickMenuCls.setLogCmd("set glycan "+s.bGlycansCartoon,!0),i.htmlCls.clickMenuCls.setLogCmd("set membrane "+s.bMembrane,!0),i.htmlCls.clickMenuCls.setLogCmd("set cmdwindow "+s.bCmdWindow,!0);s.drawCls.draw()}setCookie(e,t,i){let s=new Date;s.setTime(s.getTime()+24*i*60*60*1e3);let n="expires="+s.toUTCString();document.cookie=e+"="+t+";"+n+";path=/"}updateSurfPara(e){let t=this.icn3dui,i=t.icn3d;i.phisurftype=$("#"+t.pre+e+"surftype").val(),i.phisurfop=$("#"+t.pre+e+"surfop").val(),i.phisurfwf=$("#"+t.pre+e+"surfwf").val()}exportPdb(){let e=this.icn3dui,t=e.icn3d,i="",s=e.hashUtilsCls.intHash(t.dAtoms,t.hAtoms);if(i+=t.saveFileCls.getAtomPDB(s),!e.bNode){let s=Object.keys(e.utilsCls.getHlStructures()).join(",");t.saveFileCls.saveFile(s+"_icn3d.pdb","text",[i])}return i}exportSecondary(){let e=this.icn3dui,t=e.icn3d,i="",s=e.hashUtilsCls.intHash(t.dAtoms,t.hAtoms);if(i+=t.saveFileCls.getSecondary(s),!e.bNode){let s=Object.keys(e.utilsCls.getHlStructures()).join(",");t.saveFileCls.saveFile(s+"_icn3d_ss.txt","text",[i])}return i}}class Xl{constructor(e){let t=e;this.icn3dui=e,this.cfg=this.icn3dui.cfg,this.opts={},this.opts.background="black",this.allMenus={},this.allMenusSel={},this.simpleMenus={},this.shownMenus={},this.WIDTH=400,this.HEIGHT=400,this.RESIDUE_WIDTH=10,t.utilsCls.isMobile()||this.cfg.mobilemenu?this.MENU_HEIGHT=0:this.MENU_HEIGHT=40,this.LOG_HEIGHT=65,this.MENU_WIDTH=750,this.LESSWIDTH=20,this.LESSWIDTH_RESIZE=30,this.LESSHEIGHT=t.cfg.showlogo?60:20,this.width2d=200,this.CMD_HEIGHT=.8*this.LOG_HEIGHT,this.EXTRAHEIGHT=this.MENU_HEIGHT+this.CMD_HEIGHT,null!=this.cfg.showmenu&&0==this.cfg.showmenu&&(this.EXTRAHEIGHT-=this.MENU_HEIGHT),null!=this.cfg.showcommand&&0==this.cfg.showcommand&&(this.EXTRAHEIGHT-=this.CMD_HEIGHT),this.GREY8="#AAAAAA",this.GREYB="#CCCCCC",this.GREYC="#DDDDDD",this.GREYD="#EEEEEE",this.ORANGE="#FFA500",this.themecolor="blue",this.defaultValue=1,this.ssValue=3,this.coilValue=3,this.contactValue=11,this.contactInsideValue=12,this.hbondValue=13,this.hbondInsideValue=14,this.ssbondValue=4,this.ionicValue=5,this.ionicInsideValue=6,this.clbondValue=15,this.halogenValue=17,this.halogenInsideValue=18,this.picationValue=19,this.picationInsideValue=20,this.pistackingValue=21,this.pistackingInsideValue=22,this.contactColor="888",this.contactInsideColor="FFF",this.hbondColor="0F0",this.hbondInsideColor="FFF",this.ssbondColor="FFA500",this.ionicColor="0FF",this.ionicInsideColor="FFF",this.clbondColor="006400",this.halogenColor="F0F",this.halogenInsideColor="FFF",this.picationColor="F00",this.picationInsideColor="FFF",this.pistackingColor="00F",this.pistackingInsideColor="FFF",this.hideedges=1,this.force=4,this.simulation=void 0,this.baseUrl=window&&window.location&&"structure.ncbi.nlm.nih.gov"==window.location.hostname?"https://structure.ncbi.nlm.nih.gov/Structure/":"https://www.ncbi.nlm.nih.gov/Structure/",this.tmalignUrl=this.baseUrl+"tmalign/tmalign.cgi",this.divStr="<div id='"+this.icn3dui.pre,this.divNowrapStr="<div style='white-space:nowrap'>",this.spanNowrapStr="<span style='white-space:nowrap'>",this.inputTextStr="<input type='text' ",this.inputFileStr="<input type='file' ",this.inputRadioStr="<input type='radio' ",this.inputCheckStr="<input type='checkbox' ",this.optionStr="<option value=",this.buttonStr="<button id='"+this.icn3dui.pre,this.postfix="2",this.space2="&nbsp;&nbsp;",this.space3=this.space2+"&nbsp;",this.space4=this.space2+this.space2,this.wifiStr="",this.licenseStr="",this.closeAc={collapsible:!0,active:!1},this.clickMenuCls=new zl(this.icn3dui),this.setMenuCls=new ql(this.icn3dui),this.dialogCls=new jl(this.icn3dui),this.setDialogCls=new Gl(this.icn3dui),this.eventsCls=new $l(this.icn3dui),this.alignSeqCls=new Vl(this.icn3dui),this.setHtmlCls=new Wl(this.icn3dui)}}const Yl={Handedness:Object.freeze({NONE:"none",LEFT:"left",RIGHT:"right"}),ComponentState:Object.freeze({DEFAULT:"default",TOUCHED:"touched",PRESSED:"pressed"}),ComponentProperty:Object.freeze({BUTTON:"button",X_AXIS:"xAxis",Y_AXIS:"yAxis",STATE:"state"}),ComponentType:Object.freeze({TRIGGER:"trigger",SQUEEZE:"squeeze",TOUCHPAD:"touchpad",THUMBSTICK:"thumbstick",BUTTON:"button"}),ButtonTouchThreshold:.05,AxisTouchThreshold:.1,VisualResponseProperty:Object.freeze({TRANSFORM:"transform",VISIBILITY:"visibility"})};async function Kl(e){const t=await fetch(e);if(t.ok)return t.json();throw new Error(t.statusText)}async function Zl(e,t,i=null,s=!0){if(!e)throw new Error("No xrInputSource supplied");if(!t)throw new Error("No basePath supplied");const n=await async function(e){if(!e)throw new Error("No basePath supplied");return await Kl(`${e}/profilesList.json`)}(t);let r;if(e.profiles.some((e=>{const i=n[e];return i&&(r={profileId:e,profilePath:`${t}/${i.path}`,deprecated:!!i.deprecated}),!!r})),!r){if(!i)throw new Error("No matching profile name found");const e=n[i];if(!e)throw new Error(`No matching profile name found and default profile "${i}" missing.`);r={profileId:i,profilePath:`${t}/${e.path}`,deprecated:!!e.deprecated}}const a=await Kl(r.profilePath);let o;if(s){let t;if(t="any"===e.handedness?a.layouts[Object.keys(a.layouts)[0]]:a.layouts[e.handedness],!t)throw new Error(`No matching handedness, ${e.handedness}, in profile ${r.profileId}`);t.assetPath&&(o=r.profilePath.replace("profile.json",t.assetPath))}return{profile:a,assetPath:o}}const Jl={xAxis:0,yAxis:0,button:0,state:Yl.ComponentState.DEFAULT};class Ql{constructor(e){this.componentProperty=e.componentProperty,this.states=e.states,this.valueNodeName=e.valueNodeName,this.valueNodeProperty=e.valueNodeProperty,this.valueNodeProperty===Yl.VisualResponseProperty.TRANSFORM&&(this.minNodeName=e.minNodeName,this.maxNodeName=e.maxNodeName),this.value=0,this.updateFromComponent(Jl)}updateFromComponent({xAxis:e,yAxis:t,button:i,state:s}){const{normalizedXAxis:n,normalizedYAxis:r}=function(e=0,t=0){let i=e,s=t;if(Math.sqrt(e*e+t*t)>1){const n=Math.atan2(t,e);i=Math.cos(n),s=Math.sin(n)}return{normalizedXAxis:.5*i+.5,normalizedYAxis:.5*s+.5}}(e,t);switch(this.componentProperty){case Yl.ComponentProperty.X_AXIS:this.value=this.states.includes(s)?n:.5;break;case Yl.ComponentProperty.Y_AXIS:this.value=this.states.includes(s)?r:.5;break;case Yl.ComponentProperty.BUTTON:this.value=this.states.includes(s)?i:0;break;case Yl.ComponentProperty.STATE:this.valueNodeProperty===Yl.VisualResponseProperty.VISIBILITY?this.value=this.states.includes(s):this.value=this.states.includes(s)?1:0;break;default:throw new Error(`Unexpected visualResponse componentProperty ${this.componentProperty}`)}}}class ed{constructor(e,t){if(!(e&&t&&t.visualResponses&&t.gamepadIndices&&0!==Object.keys(t.gamepadIndices).length))throw new Error("Invalid arguments supplied");this.id=e,this.type=t.type,this.rootNodeName=t.rootNodeName,this.touchPointNodeName=t.touchPointNodeName,this.visualResponses={},Object.keys(t.visualResponses).forEach((e=>{const i=new Ql(t.visualResponses[e]);this.visualResponses[e]=i})),this.gamepadIndices=Object.assign({},t.gamepadIndices),this.values={state:Yl.ComponentState.DEFAULT,button:void 0!==this.gamepadIndices.button?0:void 0,xAxis:void 0!==this.gamepadIndices.xAxis?0:void 0,yAxis:void 0!==this.gamepadIndices.yAxis?0:void 0}}get data(){return{id:this.id,...this.values}}updateFromGamepad(e){if(this.values.state=Yl.ComponentState.DEFAULT,void 0!==this.gamepadIndices.button&&e.buttons.length>this.gamepadIndices.button){const t=e.buttons[this.gamepadIndices.button];this.values.button=t.value,this.values.button=this.values.button<0?0:this.values.button,this.values.button=this.values.button>1?1:this.values.button,t.pressed||1===this.values.button?this.values.state=Yl.ComponentState.PRESSED:(t.touched||this.values.button>Yl.ButtonTouchThreshold)&&(this.values.state=Yl.ComponentState.TOUCHED)}void 0!==this.gamepadIndices.xAxis&&e.axes.length>this.gamepadIndices.xAxis&&(this.values.xAxis=e.axes[this.gamepadIndices.xAxis],this.values.xAxis=this.values.xAxis<-1?-1:this.values.xAxis,this.values.xAxis=this.values.xAxis>1?1:this.values.xAxis,this.values.state===Yl.ComponentState.DEFAULT&&Math.abs(this.values.xAxis)>Yl.AxisTouchThreshold&&(this.values.state=Yl.ComponentState.TOUCHED)),void 0!==this.gamepadIndices.yAxis&&e.axes.length>this.gamepadIndices.yAxis&&(this.values.yAxis=e.axes[this.gamepadIndices.yAxis],this.values.yAxis=this.values.yAxis<-1?-1:this.values.yAxis,this.values.yAxis=this.values.yAxis>1?1:this.values.yAxis,this.values.state===Yl.ComponentState.DEFAULT&&Math.abs(this.values.yAxis)>Yl.AxisTouchThreshold&&(this.values.state=Yl.ComponentState.TOUCHED)),Object.values(this.visualResponses).forEach((e=>{e.updateFromComponent(this.values)}))}}class td{constructor(e,t,i){if(!e)throw new Error("No xrInputSource supplied");if(!t)throw new Error("No profile supplied");this.xrInputSource=e,this.assetUrl=i,this.id=t.profileId,this.layoutDescription=t.layouts[e.handedness],this.components={},Object.keys(this.layoutDescription.components).forEach((e=>{const t=this.layoutDescription.components[e];this.components[e]=new ed(e,t)})),this.updateFromGamepad()}get gripSpace(){return this.xrInputSource.gripSpace}get targetRaySpace(){return this.xrInputSource.targetRaySpace}get data(){const e=[];return Object.values(this.components).forEach((t=>{e.push(t.data)})),e}updateFromGamepad(){Object.values(this.components).forEach((e=>{e.updateFromGamepad(this.xrInputSource.gamepad)}))}}class id extends xr{constructor(e){super(e),this.dracoLoader=null,this.ktx2Loader=null,this.meshoptDecoder=null,this.pluginCallbacks=[],this.register((function(e){return new od(e)})),this.register((function(e){return new ud(e)})),this.register((function(e){return new md(e)})),this.register((function(e){return new ld(e)})),this.register((function(e){return new dd(e)})),this.register((function(e){return new cd(e)})),this.register((function(e){return new hd(e)})),this.register((function(e){return new pd(e)})),this.register((function(e){return new rd(e)})),this.register((function(e){return new fd(e)}))}load(e,t,i,s){const n=this;let r;r=""!==this.resourcePath?this.resourcePath:""!==this.path?this.path:Nr.extractUrlBase(e),this.manager.itemStart(e);const a=function(t){s?s(t):console.error(t),n.manager.itemError(e),n.manager.itemEnd(e)},o=new Tr(this.manager);o.setPath(this.path),o.setResponseType("arraybuffer"),o.setRequestHeader(this.requestHeader),o.setWithCredentials(this.withCredentials),o.load(e,(function(i){try{n.parse(i,r,(function(i){t(i),n.manager.itemEnd(e)}),a)}catch(e){a(e)}}),i,a)}setDRACOLoader(e){return this.dracoLoader=e,this}setDDSLoader(){throw new Error('THREE.GLTFLoader: "MSFT_texture_dds" no longer supported. Please update to "KHR_texture_basisu".')}setKTX2Loader(e){return this.ktx2Loader=e,this}setMeshoptDecoder(e){return this.meshoptDecoder=e,this}register(e){return-1===this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.push(e),this}unregister(e){return-1!==this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(e),1),this}parse(e,t,i,s){let n;const r={},a={};if("string"==typeof e)n=e;else{if(Nr.decodeText(new Uint8Array(e,0,4))===gd){try{r[nd.KHR_BINARY_GLTF]=new vd(e)}catch(e){return void(s&&s(e))}n=r[nd.KHR_BINARY_GLTF].content}else n=Nr.decodeText(new Uint8Array(e))}const o=JSON.parse(n);if(void 0===o.asset||o.asset.version[0]<2)return void(s&&s(new Error("THREE.GLTFLoader: Unsupported asset. glTF versions >=2.0 are supported.")));const l=new Zd(o,{path:t||this.resourcePath||"",crossOrigin:this.crossOrigin,requestHeader:this.requestHeader,manager:this.manager,ktx2Loader:this.ktx2Loader,meshoptDecoder:this.meshoptDecoder});l.fileLoader.setRequestHeader(this.requestHeader);for(let e=0;e<this.pluginCallbacks.length;e++){const t=this.pluginCallbacks[e](l);a[t.name]=t,r[t.name]=!0}if(o.extensionsUsed)for(let e=0;e<o.extensionsUsed.length;++e){const t=o.extensionsUsed[e],i=o.extensionsRequired||[];switch(t){case nd.KHR_MATERIALS_UNLIT:r[t]=new ad;break;case nd.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS:r[t]=new wd;break;case nd.KHR_DRACO_MESH_COMPRESSION:r[t]=new _d(o,this.dracoLoader);break;case nd.KHR_TEXTURE_TRANSFORM:r[t]=new yd;break;case nd.KHR_MESH_QUANTIZATION:r[t]=new xd;break;default:i.indexOf(t)>=0&&void 0===a[t]&&console.warn('THREE.GLTFLoader: Unknown extension "'+t+'".')}}l.setExtensions(r),l.setPlugins(a),l.parse(i,s)}parseAsync(e,t){const i=this;return new Promise((function(s,n){i.parse(e,t,s,n)}))}}function sd(){let e={};return{get:function(t){return e[t]},add:function(t,i){e[t]=i},remove:function(t){delete e[t]},removeAll:function(){e={}}}}const nd={KHR_BINARY_GLTF:"KHR_binary_glTF",KHR_DRACO_MESH_COMPRESSION:"KHR_draco_mesh_compression",KHR_LIGHTS_PUNCTUAL:"KHR_lights_punctual",KHR_MATERIALS_CLEARCOAT:"KHR_materials_clearcoat",KHR_MATERIALS_IOR:"KHR_materials_ior",KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS:"KHR_materials_pbrSpecularGlossiness",KHR_MATERIALS_SHEEN:"KHR_materials_sheen",KHR_MATERIALS_SPECULAR:"KHR_materials_specular",KHR_MATERIALS_TRANSMISSION:"KHR_materials_transmission",KHR_MATERIALS_UNLIT:"KHR_materials_unlit",KHR_MATERIALS_VOLUME:"KHR_materials_volume",KHR_TEXTURE_BASISU:"KHR_texture_basisu",KHR_TEXTURE_TRANSFORM:"KHR_texture_transform",KHR_MESH_QUANTIZATION:"KHR_mesh_quantization",EXT_TEXTURE_WEBP:"EXT_texture_webp",EXT_MESHOPT_COMPRESSION:"EXT_meshopt_compression"};class rd{constructor(e){this.parser=e,this.name=nd.KHR_LIGHTS_PUNCTUAL,this.cache={refs:{},uses:{}}}_markDefs(){const e=this.parser,t=this.parser.json.nodes||[];for(let i=0,s=t.length;i<s;i++){const s=t[i];s.extensions&&s.extensions[this.name]&&void 0!==s.extensions[this.name].light&&e._addNodeRef(this.cache,s.extensions[this.name].light)}}_loadLight(e){const t=this.parser,i="light:"+e;let s=t.cache.get(i);if(s)return s;const n=t.json,r=((n.extensions&&n.extensions[this.name]||{}).lights||[])[e];let a;const o=new Color(16777215);void 0!==r.color&&o.fromArray(r.color);const l=void 0!==r.range?r.range:0;switch(r.type){case"directional":a=new DirectionalLight(o),a.target.position.set(0,0,-1),a.add(a.target);break;case"point":a=new PointLight(o),a.distance=l;break;case"spot":a=new SpotLight(o),a.distance=l,r.spot=r.spot||{},r.spot.innerConeAngle=void 0!==r.spot.innerConeAngle?r.spot.innerConeAngle:0,r.spot.outerConeAngle=void 0!==r.spot.outerConeAngle?r.spot.outerConeAngle:Math.PI/4,a.angle=r.spot.outerConeAngle,a.penumbra=1-r.spot.innerConeAngle/r.spot.outerConeAngle,a.target.position.set(0,0,-1),a.add(a.target);break;default:throw new Error("THREE.GLTFLoader: Unexpected light type: "+r.type)}return a.position.set(0,0,0),a.decay=2,void 0!==r.intensity&&(a.intensity=r.intensity),a.name=t.createUniqueName(r.name||"light_"+e),s=Promise.resolve(a),t.cache.add(i,s),s}createNodeAttachment(e){const t=this,i=this.parser,s=i.json.nodes[e],n=(s.extensions&&s.extensions[this.name]||{}).light;return void 0===n?null:this._loadLight(n).then((function(e){return i._getNodeRef(t.cache,n,e)}))}}class ad{constructor(){this.name=nd.KHR_MATERIALS_UNLIT}getMaterialType(){return MeshBasicMaterial}extendParams(e,t,i){const s=[];e.color=new Color(1,1,1),e.opacity=1;const n=t.pbrMetallicRoughness;if(n){if(Array.isArray(n.baseColorFactor)){const t=n.baseColorFactor;e.color.fromArray(t),e.opacity=t[3]}void 0!==n.baseColorTexture&&s.push(i.assignTexture(e,"map",n.baseColorTexture,sRGBEncoding))}return Promise.all(s)}}class od{constructor(e){this.parser=e,this.name=nd.KHR_MATERIALS_CLEARCOAT}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?MeshPhysicalMaterial:null}extendMaterialParams(e,t){const i=this.parser,s=i.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const n=[],r=s.extensions[this.name];if(void 0!==r.clearcoatFactor&&(t.clearcoat=r.clearcoatFactor),void 0!==r.clearcoatTexture&&n.push(i.assignTexture(t,"clearcoatMap",r.clearcoatTexture)),void 0!==r.clearcoatRoughnessFactor&&(t.clearcoatRoughness=r.clearcoatRoughnessFactor),void 0!==r.clearcoatRoughnessTexture&&n.push(i.assignTexture(t,"clearcoatRoughnessMap",r.clearcoatRoughnessTexture)),void 0!==r.clearcoatNormalTexture&&(n.push(i.assignTexture(t,"clearcoatNormalMap",r.clearcoatNormalTexture)),void 0!==r.clearcoatNormalTexture.scale)){const e=r.clearcoatNormalTexture.scale;t.clearcoatNormalScale=new Vector2(e,e)}return Promise.all(n)}}class ld{constructor(e){this.parser=e,this.name=nd.KHR_MATERIALS_SHEEN}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?MeshPhysicalMaterial:null}extendMaterialParams(e,t){const i=this.parser,s=i.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const n=[];t.sheenColor=new Color(0,0,0),t.sheenRoughness=0,t.sheen=1;const r=s.extensions[this.name];return void 0!==r.sheenColorFactor&&t.sheenColor.fromArray(r.sheenColorFactor),void 0!==r.sheenRoughnessFactor&&(t.sheenRoughness=r.sheenRoughnessFactor),void 0!==r.sheenColorTexture&&n.push(i.assignTexture(t,"sheenColorMap",r.sheenColorTexture,sRGBEncoding)),void 0!==r.sheenRoughnessTexture&&n.push(i.assignTexture(t,"sheenRoughnessMap",r.sheenRoughnessTexture)),Promise.all(n)}}class dd{constructor(e){this.parser=e,this.name=nd.KHR_MATERIALS_TRANSMISSION}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?MeshPhysicalMaterial:null}extendMaterialParams(e,t){const i=this.parser,s=i.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const n=[],r=s.extensions[this.name];return void 0!==r.transmissionFactor&&(t.transmission=r.transmissionFactor),void 0!==r.transmissionTexture&&n.push(i.assignTexture(t,"transmissionMap",r.transmissionTexture)),Promise.all(n)}}class cd{constructor(e){this.parser=e,this.name=nd.KHR_MATERIALS_VOLUME}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?MeshPhysicalMaterial:null}extendMaterialParams(e,t){const i=this.parser,s=i.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const n=[],r=s.extensions[this.name];t.thickness=void 0!==r.thicknessFactor?r.thicknessFactor:0,void 0!==r.thicknessTexture&&n.push(i.assignTexture(t,"thicknessMap",r.thicknessTexture)),t.attenuationDistance=r.attenuationDistance||0;const a=r.attenuationColor||[1,1,1];return t.attenuationColor=new Color(a[0],a[1],a[2]),Promise.all(n)}}class hd{constructor(e){this.parser=e,this.name=nd.KHR_MATERIALS_IOR}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?MeshPhysicalMaterial:null}extendMaterialParams(e,t){const i=this.parser.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const s=i.extensions[this.name];return t.ior=void 0!==s.ior?s.ior:1.5,Promise.resolve()}}class pd{constructor(e){this.parser=e,this.name=nd.KHR_MATERIALS_SPECULAR}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?MeshPhysicalMaterial:null}extendMaterialParams(e,t){const i=this.parser,s=i.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const n=[],r=s.extensions[this.name];t.specularIntensity=void 0!==r.specularFactor?r.specularFactor:1,void 0!==r.specularTexture&&n.push(i.assignTexture(t,"specularIntensityMap",r.specularTexture));const a=r.specularColorFactor||[1,1,1];return t.specularColor=new Color(a[0],a[1],a[2]),void 0!==r.specularColorTexture&&n.push(i.assignTexture(t,"specularColorMap",r.specularColorTexture,sRGBEncoding)),Promise.all(n)}}class ud{constructor(e){this.parser=e,this.name=nd.KHR_TEXTURE_BASISU}loadTexture(e){const t=this.parser,i=t.json,s=i.textures[e];if(!s.extensions||!s.extensions[this.name])return null;const n=s.extensions[this.name],r=t.options.ktx2Loader;if(!r){if(i.extensionsRequired&&i.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setKTX2Loader must be called before loading KTX2 textures");return null}return t.loadTextureImage(e,n.source,r)}}class md{constructor(e){this.parser=e,this.name=nd.EXT_TEXTURE_WEBP,this.isSupported=null}loadTexture(e){const t=this.name,i=this.parser,s=i.json,n=s.textures[e];if(!n.extensions||!n.extensions[t])return null;const r=n.extensions[t],a=s.images[r.source];let o=i.textureLoader;if(a.uri){const e=i.options.manager.getHandler(a.uri);null!==e&&(o=e)}return this.detectSupport().then((function(n){if(n)return i.loadTextureImage(e,r.source,o);if(s.extensionsRequired&&s.extensionsRequired.indexOf(t)>=0)throw new Error("THREE.GLTFLoader: WebP required by asset but unsupported.");return i.loadTexture(e)}))}detectSupport(){return this.isSupported||(this.isSupported=new Promise((function(e){const t=new Image;t.src="data:image/webp;base64,UklGRiIAAABXRUJQVlA4IBYAAAAwAQCdASoBAAEADsD+JaQAA3AAAAAA",t.onload=t.onerror=function(){e(1===t.height)}}))),this.isSupported}}class fd{constructor(e){this.name=nd.EXT_MESHOPT_COMPRESSION,this.parser=e}loadBufferView(e){const t=this.parser.json,i=t.bufferViews[e];if(i.extensions&&i.extensions[this.name]){const e=i.extensions[this.name],s=this.parser.getDependency("buffer",e.buffer),n=this.parser.options.meshoptDecoder;if(!n||!n.supported){if(t.extensionsRequired&&t.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setMeshoptDecoder must be called before loading compressed files");return null}return Promise.all([s,n.ready]).then((function(t){const i=e.byteOffset||0,s=e.byteLength||0,r=e.count,a=e.byteStride,o=new ArrayBuffer(r*a),l=new Uint8Array(t[0],i,s);return n.decodeGltfBuffer(new Uint8Array(o),r,a,l,e.mode,e.filter),o}))}return null}}const gd="glTF",bd=1313821514,Cd=5130562;class vd{constructor(e){this.name=nd.KHR_BINARY_GLTF,this.content=null,this.body=null;const t=new DataView(e,0,12);if(this.header={magic:Nr.decodeText(new Uint8Array(e.slice(0,4))),version:t.getUint32(4,!0),length:t.getUint32(8,!0)},this.header.magic!==gd)throw new Error("THREE.GLTFLoader: Unsupported glTF-Binary header.");if(this.header.version<2)throw new Error("THREE.GLTFLoader: Legacy binary file detected.");const i=this.header.length-12,s=new DataView(e,12);let n=0;for(;n<i;){const t=s.getUint32(n,!0);n+=4;const i=s.getUint32(n,!0);if(n+=4,i===bd){const i=new Uint8Array(e,12+n,t);this.content=Nr.decodeText(i)}else if(i===Cd){const i=12+n;this.body=e.slice(i,i+t)}n+=t}if(null===this.content)throw new Error("THREE.GLTFLoader: JSON content not found.")}}class _d{constructor(e,t){if(!t)throw new Error("THREE.GLTFLoader: No DRACOLoader instance provided.");this.name=nd.KHR_DRACO_MESH_COMPRESSION,this.json=e,this.dracoLoader=t,this.dracoLoader.preload()}decodePrimitive(e,t){const i=this.json,s=this.dracoLoader,n=e.extensions[this.name].bufferView,r=e.extensions[this.name].attributes,a={},o={},l={};for(const e in r){const t=Hd[e]||e.toLowerCase();a[t]=r[e]}for(const t in e.attributes){const s=Hd[t]||t.toLowerCase();if(void 0!==r[t]){const n=i.accessors[e.attributes[t]],r=Ld[n.componentType];l[s]=r,o[s]=!0===n.normalized}}return t.getDependency("bufferView",n).then((function(e){return new Promise((function(t){s.decodeDracoFile(e,(function(e){for(const t in e.attributes){const i=e.attributes[t],s=o[t];void 0!==s&&(i.normalized=s)}t(e)}),a,l)}))}))}}class yd{constructor(){this.name=nd.KHR_TEXTURE_TRANSFORM}extendTexture(e,t){return void 0!==t.texCoord&&console.warn('THREE.GLTFLoader: Custom UV sets in "'+this.name+'" extension not yet supported.'),void 0===t.offset&&void 0===t.rotation&&void 0===t.scale||(e=e.clone(),void 0!==t.offset&&e.offset.fromArray(t.offset),void 0!==t.rotation&&(e.rotation=t.rotation),void 0!==t.scale&&e.repeat.fromArray(t.scale),e.needsUpdate=!0),e}}class Sd extends fr{constructor(e){super(),this.isGLTFSpecularGlossinessMaterial=!0;const t=["#ifdef USE_SPECULARMAP","   uniform sampler2D specularMap;","#endif"].join("\n"),i=["#ifdef USE_GLOSSINESSMAP","   uniform sampler2D glossinessMap;","#endif"].join("\n"),s=["vec3 specularFactor = specular;","#ifdef USE_SPECULARMAP","   vec4 texelSpecular = texture2D( specularMap, vUv );","   // reads channel RGB, compatible with a glTF Specular-Glossiness (RGBA) texture","   specularFactor *= texelSpecular.rgb;","#endif"].join("\n"),n=["float glossinessFactor = glossiness;","#ifdef USE_GLOSSINESSMAP","   vec4 texelGlossiness = texture2D( glossinessMap, vUv );","   // reads channel A, compatible with a glTF Specular-Glossiness (RGBA) texture","   glossinessFactor *= texelGlossiness.a;","#endif"].join("\n"),r=["PhysicalMaterial material;","material.diffuseColor = diffuseColor.rgb * ( 1. - max( specularFactor.r, max( specularFactor.g, specularFactor.b ) ) );","vec3 dxy = max( abs( dFdx( geometryNormal ) ), abs( dFdy( geometryNormal ) ) );","float geometryRoughness = max( max( dxy.x, dxy.y ), dxy.z );","material.roughness = max( 1.0 - glossinessFactor, 0.0525 ); // 0.0525 corresponds to the base mip of a 256 cubemap.","material.roughness += geometryRoughness;","material.roughness = min( material.roughness, 1.0 );","material.specularColor = specularFactor;"].join("\n"),a={specular:{value:(new Color).setHex(16777215)},glossiness:{value:1},specularMap:{value:null},glossinessMap:{value:null}};this._extraUniforms=a,this.onBeforeCompile=function(e){for(const t in a)e.uniforms[t]=a[t];e.fragmentShader=e.fragmentShader.replace("uniform float roughness;","uniform vec3 specular;").replace("uniform float metalness;","uniform float glossiness;").replace("#include <roughnessmap_pars_fragment>",t).replace("#include <metalnessmap_pars_fragment>",i).replace("#include <roughnessmap_fragment>",s).replace("#include <metalnessmap_fragment>",n).replace("#include <lights_physical_fragment>",r)},Object.defineProperties(this,{specular:{get:function(){return a.specular.value},set:function(e){a.specular.value=e}},specularMap:{get:function(){return a.specularMap.value},set:function(e){a.specularMap.value=e,e?this.defines.USE_SPECULARMAP="":delete this.defines.USE_SPECULARMAP}},glossiness:{get:function(){return a.glossiness.value},set:function(e){a.glossiness.value=e}},glossinessMap:{get:function(){return a.glossinessMap.value},set:function(e){a.glossinessMap.value=e,e?(this.defines.USE_GLOSSINESSMAP="",this.defines.USE_UV=""):(delete this.defines.USE_GLOSSINESSMAP,delete this.defines.USE_UV)}}}),delete this.metalness,delete this.roughness,delete this.metalnessMap,delete this.roughnessMap,this.setValues(e)}copy(e){return super.copy(e),this.specularMap=e.specularMap,this.specular.copy(e.specular),this.glossinessMap=e.glossinessMap,this.glossiness=e.glossiness,delete this.metalness,delete this.roughness,delete this.metalnessMap,delete this.roughnessMap,this}}class wd{constructor(){this.name=nd.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS,this.specularGlossinessParams=["color","map","lightMap","lightMapIntensity","aoMap","aoMapIntensity","emissive","emissiveIntensity","emissiveMap","bumpMap","bumpScale","normalMap","normalMapType","displacementMap","displacementScale","displacementBias","specularMap","specular","glossinessMap","glossiness","alphaMap","envMap","envMapIntensity"]}getMaterialType(){return Sd}extendParams(e,t,i){const s=t.extensions[this.name];e.color=new Color(1,1,1),e.opacity=1;const n=[];if(Array.isArray(s.diffuseFactor)){const t=s.diffuseFactor;e.color.fromArray(t),e.opacity=t[3]}if(void 0!==s.diffuseTexture&&n.push(i.assignTexture(e,"map",s.diffuseTexture,sRGBEncoding)),e.emissive=new Color(0,0,0),e.glossiness=void 0!==s.glossinessFactor?s.glossinessFactor:1,e.specular=new Color(1,1,1),Array.isArray(s.specularFactor)&&e.specular.fromArray(s.specularFactor),void 0!==s.specularGlossinessTexture){const t=s.specularGlossinessTexture;n.push(i.assignTexture(e,"glossinessMap",t)),n.push(i.assignTexture(e,"specularMap",t,sRGBEncoding))}return Promise.all(n)}createMaterial(e){const t=new Sd(e);return t.fog=!0,t.color=e.color,t.map=void 0===e.map?null:e.map,t.lightMap=null,t.lightMapIntensity=1,t.aoMap=void 0===e.aoMap?null:e.aoMap,t.aoMapIntensity=1,t.emissive=e.emissive,t.emissiveIntensity=1,t.emissiveMap=void 0===e.emissiveMap?null:e.emissiveMap,t.bumpMap=void 0===e.bumpMap?null:e.bumpMap,t.bumpScale=1,t.normalMap=void 0===e.normalMap?null:e.normalMap,t.normalMapType=TangentSpaceNormalMap,e.normalScale&&(t.normalScale=e.normalScale),t.displacementMap=null,t.displacementScale=1,t.displacementBias=0,t.specularMap=void 0===e.specularMap?null:e.specularMap,t.specular=e.specular,t.glossinessMap=void 0===e.glossinessMap?null:e.glossinessMap,t.glossiness=e.glossiness,t.alphaMap=null,t.envMap=void 0===e.envMap?null:e.envMap,t.envMapIntensity=1,t}}class xd{constructor(){this.name=nd.KHR_MESH_QUANTIZATION}}class Ad extends _r{constructor(e,t,i,s){super(e,t,i,s)}copySampleValue_(e){const t=this.resultBuffer,i=this.sampleValues,s=this.valueSize,n=e*s*3+s;for(let e=0;e!==s;e++)t[e]=i[n+e];return t}}Ad.prototype.beforeStart_=Ad.prototype.copySampleValue_,Ad.prototype.afterEnd_=Ad.prototype.copySampleValue_,Ad.prototype.interpolate_=function(e,t,i,s){const n=this.resultBuffer,r=this.sampleValues,a=this.valueSize,o=2*a,l=3*a,d=s-t,c=(i-t)/d,h=c*c,p=h*c,u=e*l,m=u-l,f=-2*p+3*h,g=p-h,b=1-f,C=g-h+c;for(let e=0;e!==a;e++){const t=r[m+e+a],i=r[m+e+o]*d,s=r[u+e+a],l=r[u+e]*d;n[e]=b*t+C*i+f*s+g*l}return n};const Md=new ut;class Td extends Ad{interpolate_(e,t,i,s){const n=super.interpolate_(e,t,i,s);return Md.fromArray(n).normalize().toArray(n),n}}const Ed=0,Rd=1,kd=2,Od=3,Id=4,Pd=5,Dd=6,Ld={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},Fd={9728:N,9729:B,9984:1004,9985:z,9986:H,9987:q},Nd={33071:L,33648:F,10497:D},Ud={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},Hd={POSITION:"position",NORMAL:"normal",TANGENT:"tangent",TEXCOORD_0:"uv",TEXCOORD_1:"uv2",COLOR_0:"color",WEIGHTS_0:"skinWeight",JOINTS_0:"skinIndex"},Bd={scale:"scale",translation:"position",rotation:"quaternion",weights:"morphTargetInfluences"},zd={CUBICSPLINE:void 0,LINEAR:2301,STEP:2300},qd="OPAQUE",jd="MASK",Gd="BLEND";function $d(e,t,i){for(const s in i.extensions)void 0===e[s]&&(t.userData.gltfExtensions=t.userData.gltfExtensions||{},t.userData.gltfExtensions[s]=i.extensions[s])}function Vd(e,t){void 0!==t.extras&&("object"==typeof t.extras?Object.assign(e.userData,t.extras):console.warn("THREE.GLTFLoader: Ignoring primitive type .extras, "+t.extras))}function Wd(e,t){if(e.updateMorphTargets(),void 0!==t.weights)for(let i=0,s=t.weights.length;i<s;i++)e.morphTargetInfluences[i]=t.weights[i];if(t.extras&&Array.isArray(t.extras.targetNames)){const i=t.extras.targetNames;if(e.morphTargetInfluences.length===i.length){e.morphTargetDictionary={};for(let t=0,s=i.length;t<s;t++)e.morphTargetDictionary[i[t]]=t}else console.warn("THREE.GLTFLoader: Invalid extras.targetNames length. Ignoring names.")}}function Xd(e){const t=e.extensions&&e.extensions[nd.KHR_DRACO_MESH_COMPRESSION];let i;return i=t?"draco:"+t.bufferView+":"+t.indices+":"+Yd(t.attributes):e.indices+":"+Yd(e.attributes)+":"+e.mode,i}function Yd(e){let t="";const i=Object.keys(e).sort();for(let s=0,n=i.length;s<n;s++)t+=i[s]+":"+e[i[s]]+";";return t}function Kd(e){switch(e){case Int8Array:return 1/127;case Uint8Array:return 1/255;case Int16Array:return 1/32767;case Uint16Array:return 1/65535;default:throw new Error("THREE.GLTFLoader: Unsupported normalized accessor component type.")}}class Zd{constructor(e={},t={}){this.json=e,this.extensions={},this.plugins={},this.options=t,this.cache=new sd,this.associations=new Map,this.primitiveCache={},this.meshCache={refs:{},uses:{}},this.cameraCache={refs:{},uses:{}},this.lightCache={refs:{},uses:{}},this.sourceCache={},this.textureCache={},this.nodeNamesUsed={},"undefined"!=typeof createImageBitmap&&!1===/^((?!chrome|android).)*safari/i.test(navigator.userAgent)?this.textureLoader=new ImageBitmapLoader(this.options.manager):this.textureLoader=new TextureLoader(this.options.manager),this.textureLoader.setCrossOrigin(this.options.crossOrigin),this.textureLoader.setRequestHeader(this.options.requestHeader),this.fileLoader=new Tr(this.options.manager),this.fileLoader.setResponseType("arraybuffer"),"use-credentials"===this.options.crossOrigin&&this.fileLoader.setWithCredentials(!0)}setExtensions(e){this.extensions=e}setPlugins(e){this.plugins=e}parse(e,t){const i=this,s=this.json,n=this.extensions;this.cache.removeAll(),this._invokeAll((function(e){return e._markDefs&&e._markDefs()})),Promise.all(this._invokeAll((function(e){return e.beforeRoot&&e.beforeRoot()}))).then((function(){return Promise.all([i.getDependencies("scene"),i.getDependencies("animation"),i.getDependencies("camera")])})).then((function(t){const r={scene:t[0][s.scene||0],scenes:t[0],animations:t[1],cameras:t[2],asset:s.asset,parser:i,userData:{}};$d(n,r,s),Vd(r,s),Promise.all(i._invokeAll((function(e){return e.afterRoot&&e.afterRoot(r)}))).then((function(){e(r)}))})).catch(t)}_markDefs(){const e=this.json.nodes||[],t=this.json.skins||[],i=this.json.meshes||[];for(let i=0,s=t.length;i<s;i++){const s=t[i].joints;for(let t=0,i=s.length;t<i;t++)e[s[t]].isBone=!0}for(let t=0,s=e.length;t<s;t++){const s=e[t];void 0!==s.mesh&&(this._addNodeRef(this.meshCache,s.mesh),void 0!==s.skin&&(i[s.mesh].isSkinnedMesh=!0)),void 0!==s.camera&&this._addNodeRef(this.cameraCache,s.camera)}}_addNodeRef(e,t){void 0!==t&&(void 0===e.refs[t]&&(e.refs[t]=e.uses[t]=0),e.refs[t]++)}_getNodeRef(e,t,i){if(e.refs[t]<=1)return i;const s=i.clone(),n=(e,t)=>{const i=this.associations.get(e);null!=i&&this.associations.set(t,i);for(const[i,s]of e.children.entries())n(s,t.children[i])};return n(i,s),s.name+="_instance_"+e.uses[t]++,s}_invokeOne(e){const t=Object.values(this.plugins);t.push(this);for(let i=0;i<t.length;i++){const s=e(t[i]);if(s)return s}return null}_invokeAll(e){const t=Object.values(this.plugins);t.unshift(this);const i=[];for(let s=0;s<t.length;s++){const n=e(t[s]);n&&i.push(n)}return i}getDependency(e,t){const i=e+":"+t;let s=this.cache.get(i);if(!s){switch(e){case"scene":s=this.loadScene(t);break;case"node":s=this.loadNode(t);break;case"mesh":s=this._invokeOne((function(e){return e.loadMesh&&e.loadMesh(t)}));break;case"accessor":s=this.loadAccessor(t);break;case"bufferView":s=this._invokeOne((function(e){return e.loadBufferView&&e.loadBufferView(t)}));break;case"buffer":s=this.loadBuffer(t);break;case"material":s=this._invokeOne((function(e){return e.loadMaterial&&e.loadMaterial(t)}));break;case"texture":s=this._invokeOne((function(e){return e.loadTexture&&e.loadTexture(t)}));break;case"skin":s=this.loadSkin(t);break;case"animation":s=this.loadAnimation(t);break;case"camera":s=this.loadCamera(t);break;default:throw new Error("Unknown type: "+e)}this.cache.add(i,s)}return s}getDependencies(e){let t=this.cache.get(e);if(!t){const i=this,s=this.json[e+("mesh"===e?"es":"s")]||[];t=Promise.all(s.map((function(t,s){return i.getDependency(e,s)}))),this.cache.add(e,t)}return t}loadBuffer(e){const t=this.json.buffers[e],i=this.fileLoader;if(t.type&&"arraybuffer"!==t.type)throw new Error("THREE.GLTFLoader: "+t.type+" buffer type is not supported.");if(void 0===t.uri&&0===e)return Promise.resolve(this.extensions[nd.KHR_BINARY_GLTF].body);const s=this.options;return new Promise((function(e,n){i.load(Nr.resolveURL(t.uri,s.path),e,void 0,(function(){n(new Error('THREE.GLTFLoader: Failed to load buffer "'+t.uri+'".'))}))}))}loadBufferView(e){const t=this.json.bufferViews[e];return this.getDependency("buffer",t.buffer).then((function(e){const i=t.byteLength||0,s=t.byteOffset||0;return e.slice(s,s+i)}))}loadAccessor(e){const t=this,i=this.json,s=this.json.accessors[e];if(void 0===s.bufferView&&void 0===s.sparse)return Promise.resolve(null);const n=[];return void 0!==s.bufferView?n.push(this.getDependency("bufferView",s.bufferView)):n.push(null),void 0!==s.sparse&&(n.push(this.getDependency("bufferView",s.sparse.indices.bufferView)),n.push(this.getDependency("bufferView",s.sparse.values.bufferView))),Promise.all(n).then((function(e){const n=e[0],r=Ud[s.type],a=Ld[s.componentType],o=a.BYTES_PER_ELEMENT,l=o*r,d=s.byteOffset||0,c=void 0!==s.bufferView?i.bufferViews[s.bufferView].byteStride:void 0,h=!0===s.normalized;let p,u;if(c&&c!==l){const e=Math.floor(d/c),i="InterleavedBuffer:"+s.bufferView+":"+s.componentType+":"+e+":"+s.count;let l=t.cache.get(i);l||(p=new a(n,e*c,s.count*c/o),l=new InterleavedBuffer(p,c/o),t.cache.add(i,l)),u=new InterleavedBufferAttribute(l,r,d%c/o,h)}else p=null===n?new a(s.count*r):new a(n,d,s.count*r),u=new BufferAttribute(p,r,h);if(void 0!==s.sparse){const t=Ud.SCALAR,i=Ld[s.sparse.indices.componentType],o=s.sparse.indices.byteOffset||0,l=s.sparse.values.byteOffset||0,d=new i(e[1],o,s.sparse.count*t),c=new a(e[2],l,s.sparse.count*r);null!==n&&(u=new BufferAttribute(u.array.slice(),u.itemSize,u.normalized));for(let e=0,t=d.length;e<t;e++){const t=d[e];if(u.setX(t,c[e*r]),r>=2&&u.setY(t,c[e*r+1]),r>=3&&u.setZ(t,c[e*r+2]),r>=4&&u.setW(t,c[e*r+3]),r>=5)throw new Error("THREE.GLTFLoader: Unsupported itemSize in sparse BufferAttribute.")}}return u}))}loadTexture(e){const t=this.json,i=this.options,s=t.textures[e].source,n=t.images[s];let r=this.textureLoader;if(n.uri){const e=i.manager.getHandler(n.uri);null!==e&&(r=e)}return this.loadTextureImage(e,s,r)}loadTextureImage(e,t,i){const s=this,n=this.json,r=n.textures[e],a=n.images[t],o=(a.uri||a.bufferView)+":"+r.sampler;if(this.textureCache[o])return this.textureCache[o];const l=this.loadImageSource(t,i).then((function(t){t.flipY=!1,r.name&&(t.name=r.name);const i=(n.samplers||{})[r.sampler]||{};return t.magFilter=Fd[i.magFilter]||LinearFilter,t.minFilter=Fd[i.minFilter]||LinearMipmapLinearFilter,t.wrapS=Nd[i.wrapS]||RepeatWrapping,t.wrapT=Nd[i.wrapT]||RepeatWrapping,s.associations.set(t,{textures:e}),t})).catch((function(){return null}));return this.textureCache[o]=l,l}loadImageSource(e,t){const i=this,s=this.json,n=this.options;if(void 0!==this.sourceCache[e])return this.sourceCache[e].then((e=>e.clone()));const r=s.images[e],a=self.URL||self.webkitURL;let o=r.uri||"",l=!1;if(void 0!==r.bufferView)o=i.getDependency("bufferView",r.bufferView).then((function(e){l=!0;const t=new Blob([e],{type:r.mimeType});return o=a.createObjectURL(t),o}));else if(void 0===r.uri)throw new Error("THREE.GLTFLoader: Image "+e+" is missing URI and bufferView");const d=Promise.resolve(o).then((function(e){return new Promise((function(i,s){let r=i;!0===t.isImageBitmapLoader&&(r=function(e){const t=new Texture(e);t.needsUpdate=!0,i(t)}),t.load(Nr.resolveURL(e,n.path),r,void 0,s)}))})).then((function(e){var t;return!0===l&&a.revokeObjectURL(o),e.userData.mimeType=r.mimeType||((t=r.uri).search(/\.jpe?g($|\?)/i)>0||0===t.search(/^data\:image\/jpeg/)?"image/jpeg":t.search(/\.webp($|\?)/i)>0||0===t.search(/^data\:image\/webp/)?"image/webp":"image/png"),e})).catch((function(e){throw console.error("THREE.GLTFLoader: Couldn't load texture",o),e}));return this.sourceCache[e]=d,d}assignTexture(e,t,i,s){const n=this;return this.getDependency("texture",i.index).then((function(r){if(void 0===i.texCoord||0==i.texCoord||"aoMap"===t&&1==i.texCoord||console.warn("THREE.GLTFLoader: Custom UV set "+i.texCoord+" for texture "+t+" not yet supported."),n.extensions[nd.KHR_TEXTURE_TRANSFORM]){const e=void 0!==i.extensions?i.extensions[nd.KHR_TEXTURE_TRANSFORM]:void 0;if(e){const t=n.associations.get(r);r=n.extensions[nd.KHR_TEXTURE_TRANSFORM].extendTexture(r,e),n.associations.set(r,t)}}return void 0!==s&&(r.encoding=s),e[t]=r,r}))}assignFinalMaterial(e){const t=e.geometry;let i=e.material;const s=void 0===t.attributes.tangent,n=void 0!==t.attributes.color,r=void 0===t.attributes.normal;if(e.isPoints){const e="PointsMaterial:"+i.uuid;let t=this.cache.get(e);t||(t=new PointsMaterial,Material.prototype.copy.call(t,i),t.color.copy(i.color),t.map=i.map,t.sizeAttenuation=!1,this.cache.add(e,t)),i=t}else if(e.isLine){const e="LineBasicMaterial:"+i.uuid;let t=this.cache.get(e);t||(t=new LineBasicMaterial,Material.prototype.copy.call(t,i),t.color.copy(i.color),this.cache.add(e,t)),i=t}if(s||n||r){let e="ClonedMaterial:"+i.uuid+":";i.isGLTFSpecularGlossinessMaterial&&(e+="specular-glossiness:"),s&&(e+="derivative-tangents:"),n&&(e+="vertex-colors:"),r&&(e+="flat-shading:");let t=this.cache.get(e);t||(t=i.clone(),n&&(t.vertexColors=!0),r&&(t.flatShading=!0),s&&(t.normalScale&&(t.normalScale.y*=-1),t.clearcoatNormalScale&&(t.clearcoatNormalScale.y*=-1)),this.cache.add(e,t),this.associations.set(t,this.associations.get(i))),i=t}i.aoMap&&void 0===t.attributes.uv2&&void 0!==t.attributes.uv&&t.setAttribute("uv2",t.attributes.uv),e.material=i}getMaterialType(){return MeshStandardMaterial}loadMaterial(e){const t=this,i=this.json,s=this.extensions,n=i.materials[e];let r;const a={},o=n.extensions||{},l=[];if(o[nd.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS]){const e=s[nd.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS];r=e.getMaterialType(),l.push(e.extendParams(a,n,t))}else if(o[nd.KHR_MATERIALS_UNLIT]){const e=s[nd.KHR_MATERIALS_UNLIT];r=e.getMaterialType(),l.push(e.extendParams(a,n,t))}else{const i=n.pbrMetallicRoughness||{};if(a.color=new Color(1,1,1),a.opacity=1,Array.isArray(i.baseColorFactor)){const e=i.baseColorFactor;a.color.fromArray(e),a.opacity=e[3]}void 0!==i.baseColorTexture&&l.push(t.assignTexture(a,"map",i.baseColorTexture,sRGBEncoding)),a.metalness=void 0!==i.metallicFactor?i.metallicFactor:1,a.roughness=void 0!==i.roughnessFactor?i.roughnessFactor:1,void 0!==i.metallicRoughnessTexture&&(l.push(t.assignTexture(a,"metalnessMap",i.metallicRoughnessTexture)),l.push(t.assignTexture(a,"roughnessMap",i.metallicRoughnessTexture))),r=this._invokeOne((function(t){return t.getMaterialType&&t.getMaterialType(e)})),l.push(Promise.all(this._invokeAll((function(t){return t.extendMaterialParams&&t.extendMaterialParams(e,a)}))))}!0===n.doubleSided&&(a.side=DoubleSide);const d=n.alphaMode||qd;if(d===Gd?(a.transparent=!0,a.depthWrite=!1):(a.transparent=!1,d===jd&&(a.alphaTest=void 0!==n.alphaCutoff?n.alphaCutoff:.5)),void 0!==n.normalTexture&&r!==MeshBasicMaterial&&(l.push(t.assignTexture(a,"normalMap",n.normalTexture)),a.normalScale=new Vector2(1,1),void 0!==n.normalTexture.scale)){const e=n.normalTexture.scale;a.normalScale.set(e,e)}return void 0!==n.occlusionTexture&&r!==MeshBasicMaterial&&(l.push(t.assignTexture(a,"aoMap",n.occlusionTexture)),void 0!==n.occlusionTexture.strength&&(a.aoMapIntensity=n.occlusionTexture.strength)),void 0!==n.emissiveFactor&&r!==MeshBasicMaterial&&(a.emissive=(new Color).fromArray(n.emissiveFactor)),void 0!==n.emissiveTexture&&r!==MeshBasicMaterial&&l.push(t.assignTexture(a,"emissiveMap",n.emissiveTexture,sRGBEncoding)),Promise.all(l).then((function(){let i;return i=r===Sd?s[nd.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS].createMaterial(a):new r(a),n.name&&(i.name=n.name),Vd(i,n),t.associations.set(i,{materials:e}),n.extensions&&$d(s,i,n),i}))}createUniqueName(e){const t=PropertyBinding.sanitizeNodeName(e||"");let i=t;for(let e=1;this.nodeNamesUsed[i];++e)i=t+"_"+e;return this.nodeNamesUsed[i]=!0,i}loadGeometries(e){const t=this,i=this.extensions,s=this.primitiveCache;function n(e){return i[nd.KHR_DRACO_MESH_COMPRESSION].decodePrimitive(e,t).then((function(i){return Qd(i,e,t)}))}const r=[];for(let i=0,a=e.length;i<a;i++){const a=e[i],o=Xd(a),l=s[o];if(l)r.push(l.promise);else{let e;e=a.extensions&&a.extensions[nd.KHR_DRACO_MESH_COMPRESSION]?n(a):Qd(new BufferGeometry,a,t),s[o]={primitive:a,promise:e},r.push(e)}}return Promise.all(r)}loadMesh(e){const t=this,i=this.json,s=this.extensions,n=i.meshes[e],r=n.primitives,a=[];for(let e=0,t=r.length;e<t;e++){const t=void 0===r[e].material?(void 0===(o=this.cache).DefaultMaterial&&(o.DefaultMaterial=new MeshStandardMaterial({color:16777215,emissive:0,metalness:1,roughness:1,transparent:!1,depthTest:!0,side:FrontSide})),o.DefaultMaterial):this.getDependency("material",r[e].material);a.push(t)}var o;return a.push(t.loadGeometries(r)),Promise.all(a).then((function(i){const a=i.slice(0,i.length-1),o=i[i.length-1],l=[];for(let i=0,d=o.length;i<d;i++){const d=o[i],c=r[i];let h;const p=a[i];if(c.mode===Id||c.mode===Pd||c.mode===Dd||void 0===c.mode)h=!0===n.isSkinnedMesh?new SkinnedMesh(d,p):new Mesh(d,p),!0!==h.isSkinnedMesh||h.geometry.attributes.skinWeight.normalized||h.normalizeSkinWeights(),c.mode===Pd?h.geometry=ec(h.geometry,TriangleStripDrawMode):c.mode===Dd&&(h.geometry=ec(h.geometry,TriangleFanDrawMode));else if(c.mode===Rd)h=new LineSegments(d,p);else if(c.mode===Od)h=new Line(d,p);else if(c.mode===kd)h=new LineLoop(d,p);else{if(c.mode!==Ed)throw new Error("THREE.GLTFLoader: Primitive mode unsupported: "+c.mode);h=new Points(d,p)}Object.keys(h.geometry.morphAttributes).length>0&&Wd(h,n),h.name=t.createUniqueName(n.name||"mesh_"+e),Vd(h,n),c.extensions&&$d(s,h,c),t.assignFinalMaterial(h),l.push(h)}for(let i=0,s=l.length;i<s;i++)t.associations.set(l[i],{meshes:e,primitives:i});if(1===l.length)return l[0];const d=new Group;t.associations.set(d,{meshes:e});for(let e=0,t=l.length;e<t;e++)d.add(l[e]);return d}))}loadCamera(e){let t;const i=this.json.cameras[e],s=i[i.type];if(s)return"perspective"===i.type?t=new PerspectiveCamera(MathUtils.radToDeg(s.yfov),s.aspectRatio||1,s.znear||1,s.zfar||2e6):"orthographic"===i.type&&(t=new OrthographicCamera(-s.xmag,s.xmag,s.ymag,-s.ymag,s.znear,s.zfar)),i.name&&(t.name=this.createUniqueName(i.name)),Vd(t,i),Promise.resolve(t);console.warn("THREE.GLTFLoader: Missing camera parameters.")}loadSkin(e){const t=this.json.skins[e],i={joints:t.joints};return void 0===t.inverseBindMatrices?Promise.resolve(i):this.getDependency("accessor",t.inverseBindMatrices).then((function(e){return i.inverseBindMatrices=e,i}))}loadAnimation(e){const t=this.json.animations[e],i=[],s=[],n=[],r=[],a=[];for(let e=0,o=t.channels.length;e<o;e++){const o=t.channels[e],l=t.samplers[o.sampler],d=o.target,c=void 0!==d.node?d.node:d.id,h=void 0!==t.parameters?t.parameters[l.input]:l.input,p=void 0!==t.parameters?t.parameters[l.output]:l.output;i.push(this.getDependency("node",c)),s.push(this.getDependency("accessor",h)),n.push(this.getDependency("accessor",p)),r.push(l),a.push(d)}return Promise.all([Promise.all(i),Promise.all(s),Promise.all(n),Promise.all(r),Promise.all(a)]).then((function(i){const s=i[0],n=i[1],r=i[2],a=i[3],o=i[4],l=[];for(let e=0,t=s.length;e<t;e++){const t=s[e],i=n[e],d=r[e],c=a[e],h=o[e];if(void 0===t)continue;let p;switch(t.updateMatrix(),t.matrixAutoUpdate=!0,Bd[h.path]){case Bd.weights:p=NumberKeyframeTrack;break;case Bd.rotation:p=QuaternionKeyframeTrack;break;default:p=VectorKeyframeTrack}const u=t.name?t.name:t.uuid,m=void 0!==c.interpolation?zd[c.interpolation]:InterpolateLinear,f=[];Bd[h.path]===Bd.weights?t.traverse((function(e){e.morphTargetInfluences&&f.push(e.name?e.name:e.uuid)})):f.push(u);let g=d.array;if(d.normalized){const e=Kd(g.constructor),t=new Float32Array(g.length);for(let i=0,s=g.length;i<s;i++)t[i]=g[i]*e;g=t}for(let e=0,t=f.length;e<t;e++){const t=new p(f[e]+"."+Bd[h.path],i.array,g,m);"CUBICSPLINE"===c.interpolation&&(t.createInterpolant=function(e){return new(this instanceof QuaternionKeyframeTrack?Td:Ad)(this.times,this.values,this.getValueSize()/3,e)},t.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline=!0),l.push(t)}}const d=t.name?t.name:"animation_"+e;return new AnimationClip(d,void 0,l)}))}createNodeMesh(e){const t=this.json,i=this,s=t.nodes[e];return void 0===s.mesh?null:i.getDependency("mesh",s.mesh).then((function(e){const t=i._getNodeRef(i.meshCache,s.mesh,e);return void 0!==s.weights&&t.traverse((function(e){if(e.isMesh)for(let t=0,i=s.weights.length;t<i;t++)e.morphTargetInfluences[t]=s.weights[t]})),t}))}loadNode(e){const t=this.json,i=this.extensions,s=this,n=t.nodes[e],r=n.name?s.createUniqueName(n.name):"";return function(){const t=[],i=s._invokeOne((function(t){return t.createNodeMesh&&t.createNodeMesh(e)}));return i&&t.push(i),void 0!==n.camera&&t.push(s.getDependency("camera",n.camera).then((function(e){return s._getNodeRef(s.cameraCache,n.camera,e)}))),s._invokeAll((function(t){return t.createNodeAttachment&&t.createNodeAttachment(e)})).forEach((function(e){t.push(e)})),Promise.all(t)}().then((function(t){let a;if(a=!0===n.isBone?new Bone:t.length>1?new Group:1===t.length?t[0]:new Object3D,a!==t[0])for(let e=0,i=t.length;e<i;e++)a.add(t[e]);if(n.name&&(a.userData.name=n.name,a.name=r),Vd(a,n),n.extensions&&$d(i,a,n),void 0!==n.matrix){const e=new Matrix4;e.fromArray(n.matrix),a.applyMatrix4(e)}else void 0!==n.translation&&a.position.fromArray(n.translation),void 0!==n.rotation&&a.quaternion.fromArray(n.rotation),void 0!==n.scale&&a.scale.fromArray(n.scale);return s.associations.has(a)||s.associations.set(a,{}),s.associations.get(a).nodes=e,a}))}loadScene(e){const t=this.json,i=this.extensions,s=this.json.scenes[e],n=this,r=new Group;s.name&&(r.name=n.createUniqueName(s.name)),Vd(r,s),s.extensions&&$d(i,r,s);const a=s.nodes||[],o=[];for(let e=0,i=a.length;e<i;e++)o.push(Jd(a[e],r,t,n));return Promise.all(o).then((function(){return n.associations=(e=>{const t=new Map;for(const[e,i]of n.associations)(e instanceof Material||e instanceof Texture)&&t.set(e,i);return e.traverse((e=>{const i=n.associations.get(e);null!=i&&t.set(e,i)})),t})(r),r}))}}function Jd(e,t,i,s){const n=i.nodes[e];return s.getDependency("node",e).then((function(e){if(void 0===n.skin)return e;let t;return s.getDependency("skin",n.skin).then((function(e){t=e;const i=[];for(let e=0,n=t.joints.length;e<n;e++)i.push(s.getDependency("node",t.joints[e]));return Promise.all(i)})).then((function(i){return e.traverse((function(e){if(!e.isMesh)return;const s=[],n=[];for(let e=0,r=i.length;e<r;e++){const r=i[e];if(r){s.push(r);const i=new Matrix4;void 0!==t.inverseBindMatrices&&i.fromArray(t.inverseBindMatrices.array,16*e),n.push(i)}else console.warn('THREE.GLTFLoader: Joint "%s" could not be found.',t.joints[e])}e.bind(new Skeleton(s,n),e.matrixWorld)})),e}))})).then((function(e){t.add(e);const r=[];if(n.children){const t=n.children;for(let n=0,a=t.length;n<a;n++){const a=t[n];r.push(Jd(a,e,i,s))}}return Promise.all(r)}))}function Qd(e,t,i){const s=t.attributes,n=[];function r(t,s){return i.getDependency("accessor",t).then((function(t){e.setAttribute(s,t)}))}for(const t in s){const i=Hd[t]||t.toLowerCase();i in e.attributes||n.push(r(s[t],i))}if(void 0!==t.indices&&!e.index){const s=i.getDependency("accessor",t.indices).then((function(t){e.setIndex(t)}));n.push(s)}return Vd(e,t),function(e,t,i){const s=t.attributes,n=new Box3;if(void 0===s.POSITION)return;{const e=i.json.accessors[s.POSITION],t=e.min,r=e.max;if(void 0===t||void 0===r)return void console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.");if(n.set(new Vector3(t[0],t[1],t[2]),new Vector3(r[0],r[1],r[2])),e.normalized){const t=Kd(Ld[e.componentType]);n.min.multiplyScalar(t),n.max.multiplyScalar(t)}}const r=t.targets;if(void 0!==r){const e=new Vector3,t=new Vector3;for(let s=0,n=r.length;s<n;s++){const n=r[s];if(void 0!==n.POSITION){const s=i.json.accessors[n.POSITION],r=s.min,a=s.max;if(void 0!==r&&void 0!==a){if(t.setX(Math.max(Math.abs(r[0]),Math.abs(a[0]))),t.setY(Math.max(Math.abs(r[1]),Math.abs(a[1]))),t.setZ(Math.max(Math.abs(r[2]),Math.abs(a[2]))),s.normalized){const e=Kd(Ld[s.componentType]);t.multiplyScalar(e)}e.max(t)}else console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.")}}n.expandByVector(e)}e.boundingBox=n;const a=new Sphere;n.getCenter(a.center),a.radius=n.min.distanceTo(n.max)/2,e.boundingSphere=a}(e,t,i),Promise.all(n).then((function(){return void 0!==t.targets?function(e,t,i){let s=!1,n=!1,r=!1;for(let e=0,i=t.length;e<i;e++){const i=t[e];if(void 0!==i.POSITION&&(s=!0),void 0!==i.NORMAL&&(n=!0),void 0!==i.COLOR_0&&(r=!0),s&&n&&r)break}if(!s&&!n&&!r)return Promise.resolve(e);const a=[],o=[],l=[];for(let d=0,c=t.length;d<c;d++){const c=t[d];if(s){const t=void 0!==c.POSITION?i.getDependency("accessor",c.POSITION):e.attributes.position;a.push(t)}if(n){const t=void 0!==c.NORMAL?i.getDependency("accessor",c.NORMAL):e.attributes.normal;o.push(t)}if(r){const t=void 0!==c.COLOR_0?i.getDependency("accessor",c.COLOR_0):e.attributes.color;l.push(t)}}return Promise.all([Promise.all(a),Promise.all(o),Promise.all(l)]).then((function(t){const i=t[0],a=t[1],o=t[2];return s&&(e.morphAttributes.position=i),n&&(e.morphAttributes.normal=a),r&&(e.morphAttributes.color=o),e.morphTargetsRelative=!0,e}))}(e,t.targets,i):e}))}function ec(e,t){let i=e.getIndex();if(null===i){const t=[],s=e.getAttribute("position");if(void 0===s)return console.error("THREE.GLTFLoader.toTrianglesDrawMode(): Undefined position attribute. Processing not possible."),e;for(let e=0;e<s.count;e++)t.push(e);e.setIndex(t),i=e.getIndex()}const s=i.count-2,n=[];if(t===TriangleFanDrawMode)for(let e=1;e<=s;e++)n.push(i.getX(0)),n.push(i.getX(e)),n.push(i.getX(e+1));else for(let e=0;e<s;e++)e%2==0?(n.push(i.getX(e)),n.push(i.getX(e+1)),n.push(i.getX(e+2))):(n.push(i.getX(e+2)),n.push(i.getX(e+1)),n.push(i.getX(e)));n.length/3!==s&&console.error("THREE.GLTFLoader.toTrianglesDrawMode(): Unable to generate correct amount of triangles.");const r=e.clone();return r.setIndex(n),r}class tc extends ji{constructor(){super(),this.motionController=null,this.envMap=null}setEnvironmentMap(e){return this.envMap==e||(this.envMap=e,this.traverse((e=>{e.isMesh&&(e.material.envMap=this.envMap,e.material.needsUpdate=!0)}))),this}updateMatrixWorld(e){super.updateMatrixWorld(e),this.motionController&&(this.motionController.updateFromGamepad(),Object.values(this.motionController.components).forEach((e=>{Object.values(e.visualResponses).forEach((e=>{const{valueNode:t,minNode:i,maxNode:s,value:n,valueNodeProperty:r}=e;t&&(r===Yl.VisualResponseProperty.VISIBILITY?t.visible=n:r===Yl.VisualResponseProperty.TRANSFORM&&(t.quaternion.slerpQuaternions(i.quaternion,s.quaternion,n),t.position.lerpVectors(i.position,s.position,n)))}))})))}}function ic(e,t){!function(e,t){Object.values(e.components).forEach((e=>{const{type:i,touchPointNodeName:s,visualResponses:n}=e;if(i===Yl.ComponentType.TOUCHPAD)if(e.touchPointNode=t.getObjectByName(s),e.touchPointNode){const t=new SphereGeometry(.001),i=new MeshBasicMaterial({color:255}),s=new Mesh(t,i);e.touchPointNode.add(s)}else console.warn(`Could not find touch dot, ${e.touchPointNodeName}, in touchpad component ${e.id}`);Object.values(n).forEach((e=>{const{valueNodeName:i,minNodeName:s,maxNodeName:n,valueNodeProperty:r}=e;if(r===Yl.VisualResponseProperty.TRANSFORM){if(e.minNode=t.getObjectByName(s),e.maxNode=t.getObjectByName(n),!e.minNode)return void console.warn(`Could not find ${s} in the model`);if(!e.maxNode)return void console.warn(`Could not find ${n} in the model`)}e.valueNode=t.getObjectByName(i),e.valueNode||console.warn(`Could not find ${i} in the model`)}))}))}(e.motionController,t),e.envMap&&t.traverse((t=>{t.isMesh&&(t.material.envMap=e.envMap,t.material.needsUpdate=!0)})),e.add(t)}class sc{constructor(e=null){this.gltfLoader=e,this.path="https://cdn.jsdelivr.net/npm/@webxr-input-profiles/assets@1.0/dist/profiles",this._assetCache={},this.gltfLoader||(this.gltfLoader=new id)}createControllerModel(e){const t=new tc;let i=null;return e.addEventListener("connected",(e=>{const s=e.data;"tracked-pointer"===s.targetRayMode&&s.gamepad&&Zl(s,this.path,"generic-trigger").then((({profile:e,assetPath:n})=>{t.motionController=new td(s,e,n);const r=this._assetCache[t.motionController.assetUrl];if(r)i=r.scene.clone(),ic(t,i);else{if(!this.gltfLoader)throw new Error("GLTFLoader not set.");this.gltfLoader.setPath(""),this.gltfLoader.load(t.motionController.assetUrl,(e=>{this._assetCache[t.motionController.assetUrl]=e,i=e.scene.clone(),ic(t,i)}),null,(()=>{throw new Error(`Asset ${t.motionController.assetUrl} missing or malformed.`)}))}})).catch((e=>{console.warn(e)}))})),e.addEventListener("disconnected",(()=>{t.motionController=null,t.remove(i),i=null})),t}}class nc extends st{constructor(e){if(super(),void 0===e)return void console.error("ControllerGestures must be passed a renderer");const t=new Br;this.controller1=e.xr.getController(0),this.controller1.userData.gestures={index:0},this.controller1.userData.selectPressed=!1,this.controller1.addEventListener("selectstart",s),this.controller1.addEventListener("selectend",n),this.controller2=e.xr.getController(1),this.controller2.userData.gestures={index:1},this.controller2.userData.selectPressed=!1,this.controller2.addEventListener("selectstart",s),this.controller2.addEventListener("selectend",n),this.doubleClickLimit=.2,this.pressMinimum=.4,this.right=new mt(1,0,0),this.up=new mt(0,1,0),this.type="unknown",this.prevTap="none",this.clock=t;const i=this;function s(){const e=this.userData.gestures;e.startPosition=void 0,e.startTime=t.getElapsedTime(),-1==i.type.indexOf("tap")&&(e.taps=0),i.type="unknown",this.userData.selectPressed=!0}function n(){const e=this.userData.gestures;e.endTime=t.getElapsedTime();e.endTime-e.startTime<i.doubleClickLimit&&e.taps++,i.type="tap",this.userData.selectPressed=!1,e.startPosition=void 0}}get multiTouch(){let e;return e=void 0!==this.controller1&&void 0!==this.controller2&&(this.controller1.userData.selectPressed&&this.controller2.userData.selectPressed),e}get touch(){let e;return e=void 0!==this.controller1&&void 0!==this.controller2&&(this.controller1.userData.selectPressed||this.controller2.userData.selectPressed),e}get debugMsg(){return this.type}update(){const e=this.controller1.userData.gestures,t=this.controller2.userData.gestures,i=this.clock.getElapsedTime();let s;if(this.controller1.userData.selectPressed&&void 0===e.startPosition&&(s=i-e.startTime,s>.05&&(e.startPosition=this.controller1.position.clone())),this.controller2.userData.selectPressed&&void 0===t.startPosition&&(s=i-t.startTime,s>.05&&(t.startPosition=this.controller2.position.clone())),!this.controller1.userData.selectPressed&&"tap"===this.type&&(s=this.clock.getElapsedTime()-e.endTime,s>this.doubleClickLimit)){switch(e.taps){case 1:self.prevTap="tap";break;case 2:this.dispatchEvent({type:"doubletap",position:this.controller1.position,matrixWorld:this.controller1.matrixWorld}),self.prevTap="doubletap"}this.type="unknown",e.taps=0}if("unknown"===this.type&&this.touch)"doubletap"==self.prevTap?(this.type="pinch",this.startDistance=this.controller1.position.distanceTo(this.controller2.position),this.dispatchEvent({type:"pinch",delta:new mt(0,0,0),scale:1,initialise:!0})):(this.type="pan",this.startPosition=this.controller1.position.clone(),this.dispatchEvent({type:"pan",delta:new mt(0,0,0),initialise:!0}));else if(("pinch"===this.type||"pan"===this.type)&&"doubletap"==self.prevTap&&this.controller2.position){const e=this.controller1.position.distanceTo(this.controller2.position)/this.startDistance,t=this.controller1.position.clone().sub(this.startPosition);this.dispatchEvent({type:"pinch",delta:t,scale:e})}}}class rc{constructor(e,t){this.config=void 0===t?{panelSize:{width:1,height:1},width:512,height:512,opacity:.7,body:{fontFamily:"Arial",fontSize:30,padding:2,backgroundColor:"#000",fontColor:"#fff",borderRadius:6}}:t,void 0===this.config.width&&(this.config.width=512),void 0===this.config.height&&(this.config.height=512),void 0===this.config.body&&(this.config.body={fontFamily:"Arial",size:30,padding:2,backgroundColor:"#000",fontColor:"#fff",borderRadius:6});const i=this.config.body;void 0===i.borderRadius&&(i.borderRadius=6),void 0===i.fontFamily&&(i.fontFamily="Arial"),void 0===i.padding&&(i.padding=2),void 0===i.fontSize&&(i.fontSize=30),void 0===i.backgroundColor&&(i.backgroundColor="#000"),void 0===i.fontColor&&(i.fontColor="#fff"),Object.entries(this.config).forEach((([e,t])=>{if(!("object"!=typeof t||"panelSize"===e||t instanceof Pl||t instanceof on)){const e=void 0!==t.position?t.position:{x:0,y:0};void 0!==e.left&&void 0===e.x&&(e.x=e.left),void 0!==e.top&&void 0===e.y&&(e.y=e.top);const i=void 0!==t.width?t.width:this.config.width,s=void 0!==t.height?t.height:this.config.height;void 0!==e.right&&void 0===e.x&&(e.x=this.config.width-e.right-i),void 0!==e.bottom&&void 0===e.y&&(e.y=this.config.height-e.bottom-s),void 0===e.x&&(e.x=0),void 0===e.y&&(e.y=0),t.position=e,void 0===t.type&&(t.type="text")}}));const s=this.createOffscreenCanvas(this.config.width,this.config.height);this.context=s.getContext("2d"),this.context.save();const n=void 0!==this.config.opacity?this.config.opacity:.7,r=new ps({transparent:!0,opacity:n});this.panelSize=void 0!==this.config.panelSize?this.config.panelSize:{width:1,height:1};const a=new pr(this.panelSize.width,this.panelSize.height);this.mesh=new Hs(a,r),this.texture=new Xn(s),this.mesh.material.map=this.texture,this.scene=this.config.scene;if(Object.values(this.config).filter((e=>"input-text"===e.type)).length>0){this.keyboard=new ac(this.panelSize.width,this.config.renderer);this.keyboard.mesh.position.set(0,-.3,.2),this.mesh.add(this.keyboard.mesh)}if(void 0===e)this.content={body:""},this.config.body.type="text";else{this.content=e;Object.values(t).filter((e=>"button"===e.type||"scroll"===e.overflow||"input-text"===e.type)).length>0&&(void 0===t||void 0===t.renderer?console.warn("CanvasUI: button, scroll or input-text in the config but no renderer"):(this.renderer=t.renderer,this.initControllers()))}this.selectedElements=[void 0,void 0],this.selectPressed=[!1,!1],this.scrollData=[void 0,void 0],this.intersects=[void 0,void 0],this.needsUpdate=!0,this.update()}getIntersectY(e){const t=this.config.height||512,i=this.intersects[e];return void 0===i||void 0===i.uv?0:(1-i.uv.y)*t}initControllers(){this.vec3=new mt,this.mat4=new gi,this.raycaster=new jr;const e=this;function t(t){const i=t.target===e.controller?0:1,s=e.selectedElements[i];if(void 0!==s)if("button"==s.type)e.select(i);else if("input-text"==s.type&&e.keyboard)if(e.keyboard.visible)e.keyboard.linkedUI=void 0,e.keyboard.linkedText=void 0,e.keyboard.linkedElement=void 0,e.keyboard.visible=!1;else{let t;e.keyboard.linkedUI=e,Object.entries(e.config).forEach((([e,i])=>{i==s&&(t=e)}));const i=(.5-(s.position.y+s.height+e.config.body.padding)/e.config.height)*e.panelSize.height,n=Math.max(e.panelSize.width,e.panelSize.height)/2;e.keyboard.position.set(0,-n/1.5-i,.1),e.keyboard.linkedText=e.content[t],e.keyboard.linkedName=t,e.keyboard.linkedElement=s,e.keyboard.visible=!0}}function i(t){const i=t.target===e.controller?0:1;if(e.selectPressed[i]=!0,void 0!==e.selectedElements[i]&&"scroll"==e.selectedElements[i].overflow){const t=e.selectedElements[i];e.scrollData[i]={scrollY:t.scrollY,rayY:e.getIntersectY(i)}}}function s(t){const i=t.target===e.controller?0:1;e.selectPressed[i]=!1,void 0!==e.selectedElements[i]&&"scroll"==e.selectedElements[i].overflow&&(e.scrollData[i]=void 0)}if(this.controller=this.renderer.xr.getController(0),this.controller.addEventListener("select",t),this.controller.addEventListener("selectstart",i),this.controller.addEventListener("selectend",s),this.controller1=this.renderer.xr.getController(1),this.controller1.addEventListener("select",t),this.controller1.addEventListener("selectstart",i),this.controller1.addEventListener("selectend",s),this.scene){const e=new hr(.015),t=new ps({color:170}),i=new Hs(e,t);i.visible=!1,this.scene.add(i);const s=new Hs(e,t);s.visible=!1,this.scene.add(s),this.intersectMesh=[i,s]}}setClip(e){const t=this.context;if(t.restore(),t.save(),void 0!==e.clipPath){const i=new Path2D(e.clipPath);t.clip(i)}else{const i=void 0!==e.position?e.position:{x:0,y:0},s=e.borderRadius||0,n=e.width||this.config.width,r=e.height||this.config.height;if(t.beginPath(),0!==s){const e=Math.PI/2;t.moveTo(i.x+s,i.y),t.arc(i.x+s,i.y+s,s,e,2*e,!0),t.lineTo(i.x,i.y+r-s),t.arc(i.x+s,i.y+r-s,s,0,e,!0),t.lineTo(i.x+n-s,i.y+r),t.arc(i.x+n-s,i.y+r-s,s,3*e,4*e,!0),t.lineTo(i.x+n,i.y+s),t.arc(i.x+n-s,i.y+s,s,2*e,3*e,!0),t.closePath(),t.clip()}else t.rect(i.x,i.y,n,r),t.clip()}}setPosition(e,t,i){void 0!==this.mesh&&this.mesh.position.set(e,t,i)}setRotation(e,t,i){void 0!==this.mesh&&this.mesh.rotation.set(e,t,i)}updateElement(e,t){let i=this.content[e];void 0!==i?("object"==typeof i?i.content=t:i=t,this.content[e]=i,this.needsUpdate=!0):console.warn(`CanvasGUI.updateElement: No ${e} found`)}get panel(){return this.mesh}getElementAtLocation(e,t){const i=this,s=Object.entries(this.config).filter((([s,n])=>{if(!("object"!=typeof n||"panelSize"===s||"body"===s||n instanceof Pl||n instanceof on)){const s=n.position,r=void 0!==n.width?n.width:i.config.width,a=void 0!==n.height?n.height:i.config.height;return e>=s.x&&e<s.x+r&&t>=s.y&&t<s.y+a}}));return 0==s.length?null:this.config[s[0][0]]}updateConfig(e,t,i){let s=this.config[e];void 0!==s?(s[t]=i,this.needsUpdate=!0):console.warn(`CanvasUI.updateconfig: No ${e} found`)}hover(e=0,t){if(void 0===t)void 0!==this.selectedElements[e]&&(this.selectedElements[e]=void 0,this.needsUpdate=!0);else{const i=t.x*(this.config.width||512),s=(1-t.y)*(this.config.height||512),n=this.getElementAtLocation(i,s);null===n?void 0!==this.selectedElements[e]&&(this.selectedElements[e]=void 0,this.needsUpdate=!0):this.selectedElements[e]!==n&&(this.selectedElements[e]=n,this.needsUpdate=!0)}}select(e=0){if(void 0!==this.selectedElements[e]){const t=this.selectedElements[e];t.onSelect&&t.onSelect(),"input-text"===t.type?this.keyboard.mesh.visible=!0:this.selectedElements[e]=void 0}}scroll(e){if(void 0===this.selectedElements[e])return void(this.intersectMesh&&(this.intersectMesh[e].visible=!1));if("scroll"!==this.selectedElements[e].overflow)return;const t=this.selectedElements[e];if(this.selectPressed[e]){const i=this.scrollData[e];if(void 0!==i){this.intersectMesh&&(this.intersectMesh[e].visible=!0,this.intersectMesh[e].position.copy(this.intersects[e].point));const s=this.getIntersectY(e)-i.rayY;t.scrollY=Math.min(Math.max(t.minScrollY,i.scrollY+s),0),this.needsUpdate=!0}}else this.intersectMesh&&(this.intersectMesh[e].visible=!1)}handleController(e,t){this.mat4.identity().extractRotation(e.matrixWorld),this.raycaster.ray.origin.setFromMatrixPosition(e.matrixWorld),this.raycaster.ray.direction.set(0,0,-1).applyMatrix4(this.mat4);const i=this.raycaster.intersectObject(this.mesh);i.length>0?(this.hover(t,i[0].uv),this.intersects[t]=i[0],this.scroll(t)):(this.hover(t),this.intersects[t]=void 0,this.scroll(t))}update(){if(void 0===this.mesh)return;if(this.controller&&this.handleController(this.controller,0),this.controller1&&this.handleController(this.controller1,1),this.keyboard&&this.keyboard.visible&&this.keyboard.update(),!this.needsUpdate)return;let e=this.context;e.clearRect(0,0,this.config.width,this.config.height);const t=this.config.body.backgroundColor?this.config.body.backgroundColor:"#000";!this.config.body.fontFamily||this.config.body.fontFamily;const i=this.config.body.fontColor?this.config.body.fontColor:"#fff";!this.config.body.fontSize||this.config.body.fontSize,this.setClip(this.config.body),e.fillStyle=t,e.fillRect(0,0,this.config.width,this.config.height);const s=this;Object.entries(this.content).forEach((([t,n])=>{const r=void 0!==s.config[t]?s.config[t]:s.config.body;if("none"!==(void 0!==r.display?r.display:"block")){const a=void 0!==r.position?r.position:{x:0,y:0},o=void 0!==r.width?r.width:s.config.width,l=void 0!==r.height?r.height:s.config.height;"button"!=r.type||n.toLowerCase().startsWith("<path>")||(void 0===r.borderRadius&&(r.borderRadius=6),void 0===r.textAlign&&(r.textAlign="center")),s.setClip(r);const d=n.toLowerCase().startsWith("<path>"),c=void 0!==s.selectedElements[0]&&this.selectedElements[0]===r||void 0!==s.selectedElements[1]&&this.selectedElements[1]===r;if(void 0!==r.backgroundColor&&(c&&"button"==r.type&&void 0!==r.hover?e.fillStyle=r.hover:e.fillStyle=r.backgroundColor,e.fillRect(a.x,a.y,o,l)),"text"==r.type||"button"==r.type||"input-text"==r.type){let h=!1;if(c?(d||"button"!=r.type?e.fillStyle=void 0!==r.hover?r.hover:void 0!==r.fontColor?r.fontColor:i:e.fillStyle=void 0!==r.fontColor?r.fontColor:i,h=void 0===r.hover):e.fillStyle=void 0!==r.fontColor?r.fontColor:i,d){const t=n.toUpperCase().substring(6,n.length-7);e.save(),e.translate(a.x,a.y);const i=new Path2D(t);e.fill(i),e.restore()}else s.wrapText(t,n);h&&(e.beginPath(),e.strokeStyle="#fff",e.lineWidth=2,e.rect(a.x,a.y,o,l),e.stroke())}else if("img"==r.type)if(void 0===r.img)this.loadImage(n).then((e=>{console.log(`w: ${e.width} | h: ${e.height}`),r.img=e,s.needsUpdate=!0,s.update()})).catch((e=>console.error(e)));else{const t=o/(r.img.width/r.img.height);e.drawImage(r.img,a.x,a.y,o,t)}}})),this.needsUpdate=!1,this.texture.needsUpdate=!0}loadImage(e){return new Promise(((t,i)=>{const s=new Image;s.addEventListener("load",(()=>t(s))),s.addEventListener("error",(e=>i(e))),s.src=e}))}createOffscreenCanvas(e,t){const i=document.createElement("canvas");return i.width=e,i.height=t,i}fillRoundedRect(e,t,i,s,n){const r=this.context;r.beginPath(),r.moveTo(e+n,t),r.lineTo(e+i-n,t),r.quadraticCurveTo(e+i,t,e+i,t+n),r.lineTo(e+i,t+s-n),r.quadraticCurveTo(e+i,t+s,e+i-n,t+s),r.lineTo(e+n,t+s),r.quadraticCurveTo(e,t+s,e,t+s-n),r.lineTo(e,t+n),r.quadraticCurveTo(e,t,e+n,t),r.closePath(),r.fill()}lookAt(e){void 0!==this.mesh&&(e instanceof Vector3?this.mesh.lookAt(e):console.error("CanvasUI lookAt called parameter not a THREE.Vector3"))}get visible(){return void 0!==this.mesh&&this.mesh.visible}set visible(e){this.mesh&&(this.mesh.visible=e)}get position(){if(void 0!==this.mesh)return this.mesh.position}set position(e){void 0!==this.mesh&&(e instanceof Vector3?this.mesh.position.copy(e):console.error("CanvasUI trying to set the mesh position using a parameter that is not a THREE.Vector3"))}get quaternion(){if(void 0!==this.mesh)return this.mesh.quaternion}set quaternion(e){void 0!==this.mesh&&(e instanceof QUaternion?this.mesh.quaternion.copy(e):console.error("CanvasUI trying to set the mesh quaternion using a parameter that is not a THREE.Quaternion"))}wrapText(e,t){const i=t.split(" ");let s="";const n=[],r=void 0!==this.config[e]?this.config[e]:this.config.body,a=void 0!==r.width?r.width:this.config.width,o=void 0!==r.height?r.height:this.config.height,l=void 0!==r.position?r.position:{x:0,y:0},d=void 0!==r.padding?r.padding:void 0!==this.config.body.padding?this.config.body.padding:10,c=void 0!==r.paddingTop?r.paddingTop:d,h=void 0!==r.paddingLeft?r.paddingLeft:d,p=void 0!==r.paddingBottom?r.paddingBottom:d,u=void 0!==r.paddingRight?r.paddingRight:d,m={x:l.x+h,y:l.y+c,width:a-h-u,height:o-c-p},f=void 0!==r.textAlign?r.textAlign:void 0!==this.config.body.textAlign?this.config.body.textAlign:"left",g=void 0!==r.fontSize?r.fontSize:void 0!==this.config.body.fontSize?this.config.body.fontSize:30,b=void 0!==r.fontFamily?r.fontFamily:void 0!==this.config.body.fontFamily?this.config.body.fontFamily:"Arial",C=g+(void 0!==r.leading?r.leading:void 0!==this.config.body.leading?this.config.body.leading:8),v=this.context;v.textAlign=f,v.font=`${g}px '${b}'`,i.forEach((function(e){let t=i.length>1?`${s}${e} `:e,r=v.measureText(t);if(r.width>m.width&&e.length>1)if(0==s.length&&r.width>m.width){for(;r.width>m.width;){let i=0;do{i++,t=e.substr(0,i),r=v.measureText(t)}while(r.width<m.width&&i<e.length-1);if(i--,t=e.substr(0,i),n.push(t),e=e.substr(i),i<=1)break;r=v.measureText(e)}""!=e&&n.push(e)}else n.push(s),s=`${e} `;else s=t})),""!=s&&n.push(s);const _=n.length*C;let y=0;if(_>m.height&&"scroll"===r.overflow){void 0===r.scrollY&&(r.scrollY=0);const e=void 0!==r.fontColor?r.fontColor:this.config.body.fontColor;v.fillStyle="#aaa",this.fillRoundedRect(l.x+a-12,l.y,12,o,6),v.fillStyle="#666";const t=m.height/_,i=t*o,s=-r.scrollY*t;this.fillRoundedRect(l.x+a-12,l.y+s,12,i,6),v.fillStyle=e,y=r.scrollY,r.minScrollY=m.height-_}let S,w=y+m.y+g/2;switch(f){case"center":S=m.x+m.width/2;break;case"right":S=m.x+m.width;break;default:S=m.x}n.forEach((e=>{w+C>0&&v.fillText(e,S,w),w+=C}))}}class ac{constructor(e,t,i="EN"){const s=this.getConfig(i);s.panelSize={width:e,height:.5*e},s.height=256,s.body={backgroundColor:"#555"},s.renderer=t;const n=this.getContent(i);this.keyboard=new rc(n,s),this.keyboard.mesh.visible=!1,this.shift=!1}get mesh(){return this.keyboard.mesh}getConfig(e){const t={};let i=10;const s=39.2,n=49,r="#333",a="#000";let o=i,l=i;for(let e=0;e<10;e++){const d={type:"button",position:{x:l,y:o},width:s,height:n,padding:i,paddingTop:20,backgroundColor:a,borderRadius:6,hover:r,onSelect:this.onSelect.bind(this,e)};t[`btn${e}`]=d,l+=49.2}o+=59,l=i;for(let e=0;e<10;e++){const d={type:"button",position:{x:l,y:o},width:s,height:n,padding:i,paddingTop:20,backgroundColor:a,borderRadius:6,hover:r,onSelect:this.onSelect.bind(this,e+10)};t[`btn${e+10}`]=d,l+=49.2}o+=59,l=i;for(let e=0;e<9;e++){const d=0==e||8==e?1.5*s+5:s,c={type:"button",position:{x:l,y:o},width:d,height:n,padding:i,paddingTop:20,backgroundColor:a,borderRadius:6,hover:r,onSelect:this.onSelect.bind(this,e+20)};t[`btn${e+20}`]=c,l+=d+i}o+=59,l=i;for(let e=0;e<5;e++){const d=0==e||4==e?88.4:2==e?186.8:s,c={type:"button",position:{x:l,y:o},width:d,height:n,padding:i,paddingTop:20,backgroundColor:a,borderRadius:6,hover:r,onSelect:this.onSelect.bind(this,e+30)};0==e&&(c.fontSize=20),t[`btn${e+30}`]=c,l+=d+i}return t}getContent(e,t=0){let i,s={};switch(this.language=e,this.keyboardIndex=t,t){case 0:i=["q","w","e","r","t","y","u","i","o","p","a","s","d","f","g","h","j","k","l","@","⇧","z","x","c","v","b","n","m","⇦","","?123",",","   ",".","↲"];for(let e=0;e<i.length;e++){const t=i[e];""!==t&&(s[`btn${e}`]=t)}break;case 1:i=["Q","W","E","R","T","Y","U","I","O","P","A","S","D","F","G","H","J","K","L","@","⇧","Z","X","C","V","B","N","M","⇦","","?123",",","   ",".","↲"];for(let e=0;e<i.length;e++){const t=i[e];""!==t&&(s[`btn${e}`]=t)}break;case 2:i=["1","2","3","4","5","6","7","8","9","0","@","#","%","&","*","/","-","+","(",")","⇧","?","!",'"',"'","\\",":",";","⇦","","abc",",","   ",".","↲"];for(let e=0;e<i.length;e++){const t=i[e];""!==t&&(s[`btn${e}`]=t)}break;case 3:i=["1","2","3","4","5","6","7","8","9","0","€","£","$","^","=","|","{","}","[","}","⇧","<",">","_","`","~",":",";","⇦","","abc",",","   ",".","↲"];for(let e=0;e<i.length;e++){const t=i[e];""!==t&&(s[`btn${e}`]=t)}}return s}get position(){return this.keyboard.mesh.position}get visible(){return this.keyboard.mesh.visible}set visible(e){this.keyboard.mesh.visible=e}setKeyboard(e){this.keyboard.content=this.getContent(this.language,e),this.keyboard.needsUpdate=!0}onSelect(e){if(!this.visible)return;let t=!1;switch(e){case 34:this.visible=!1,this.linkedElement.onEnter&&this.linkedElement.onEnter(this.linkedText);break;case 32:this.linkedText+=" ",t=!0;break;case 30:this.shift=!1,this.keyboardIndex<2?this.setKeyboard(2):this.setKeyboard(0),this.keyboard.needsUpdate=!0;break;case 28:this.linkedText=this.linkedText.substring(0,this.linkedText.length-1),t=!0;break;case 20:this.shift=!this.shift,0==this.keyboardIndex?this.setKeyboard(1):1==this.keyboardIndex?this.setKeyboard(0):2==this.keyboardIndex?this.setKeyboard(3):3==this.keyboardIndex&&this.setKeyboard(2);break;default:const i=this.keyboard.content[`btn${e}`];this.linkedText+=i,t=!0,1==this.keyboardIndex&&this.setKeyboard(0)}t&&(this.linkedUI.updateElement(this.linkedName,this.linkedText),this.linkedElement.onChanged&&this.linkedElement.onChanged(this.linkedText))}update(){this.keyboard&&this.keyboard.update()}}class oc{constructor(e){this.icn3d=e}rebuildScene(e){let t=this.icn3d,i=t.icn3dui;void 0===e&&(e=t.opts),this.rebuildSceneBase(e),t.fogCls.setFog(),t.cameraCls.setCamera(),i.cfg.imageonly||this.setVrArButtons(),this.setVrAr(),void 0!==t.bSkipChemicalbinding&&t.bSkipChemicalbinding||t.applyOtherCls.applyChemicalbindingOptions(),t.bSkipChemicalbinding=!0,"show"===e.chemicalbinding&&(t.opts.hbonds="yes"),t.applySsbondsCls.applySsbondsOptions(),t.applyClbondsCls.applyClbondsOptions(),t.applyMissingResCls.applyMissingResOptions(),t.applyDisplayCls.applyDisplayOptions(t.opts,t.dAtoms),t.applyOtherCls.applyOtherOptions(),t.scene_ghost.updateMatrixWorld(!0)}rebuildSceneBase(e){let t=this.icn3d,i=t.icn3dui;if($.extend(t.opts,e),t.cam_z=2*t.maxD,void 0!==t.scene)for(let e=t.scene.children.length-1;e>=0;e--){let i=t.scene.children[e];t.scene.remove(i)}else t.scene=new on;if(void 0!==t.scene_ghost)for(let e=t.scene_ghost.children.length-1;e>=0;e--){let i=t.scene_ghost.children[e];t.scene_ghost.remove(i)}else t.scene_ghost=new on;if(""!=i.htmlCls.setHtmlCls.getCookie("shininess")){let e=parseFloat(i.htmlCls.setHtmlCls.getCookie("shininess"));t.shininess!=e&&i.htmlCls.clickMenuCls.setLogCmd("set shininess "+e,!0),t.shininess=e}if(!i.bNode&&""!=i.htmlCls.setHtmlCls.getCookie("light1")){let e=parseFloat(i.htmlCls.setHtmlCls.getCookie("light1")),s=parseFloat(i.htmlCls.setHtmlCls.getCookie("light2")),n=parseFloat(i.htmlCls.setHtmlCls.getCookie("light3"));t.light1==e&&t.light2==s&&t.light3==n||i.htmlCls.clickMenuCls.setLogCmd("set light | light1 "+e+" | light2 "+s+" | light3 "+n,!0),t.light1=e,t.light2=s,t.light3=n}t.directionalLight=new Lr(16777215,t.light1),t.directionalLight2=new Lr(16777215,t.light2),t.directionalLight3=new Lr(16777215,t.light3),t.cam_z>0?(t.directionalLight.position.set(-1,1,1),t.directionalLight2.position.set(1,1,1),t.directionalLight3.position.set(1,1,-1),t.lightPos=new mt(-1,1,1),t.lightPos2=new mt(1,1,1),t.lightPos3=new mt(1,1,-1)):(t.directionalLight.position.set(-1,1,-1),t.directionalLight2.position.set(1,1,-1),t.directionalLight3.position.set(1,1,1),t.lightPos=new mt(-1,1,-1),t.lightPos2=new mt(1,1,-1),t.lightPos3=new mt(1,1,1));let s=new Fr(16777215);if(t.scene.add(t.directionalLight),t.scene.add(s),void 0!==t.mdl)for(let e=t.mdl.children.length-1;e>=0;e--){let i=t.mdl.children[e];i.geometry&&i.geometry.dispose(),i.material&&i.material.dispose(),t.mdl.remove(i)}if(void 0!==t.mdlImpostor){for(let e=t.mdlImpostor.children.length-1;e>=0;e--){let i=t.mdlImpostor.children[e];i.geometry&&i.geometry.dispose(),i.material&&i.material.dispose(),t.mdlImpostor.remove(i)}t.mdlImpostor.children.length=0}i.bNode||t.renderer.renderLists.dispose(),t.mdl=new ji,t.mdlImpostor=new ji,t.scene.add(t.mdl),t.scene.add(t.mdlImpostor),t.mdl_ghost=new ji,t.scene_ghost.add(t.mdl_ghost),t.objects=[],t.objects_ghost=[],t.raycaster=new jr,t.mouse=new pt;let n=i.parasCls.backgroundColors[t.opts.background.toLowerCase()];i.bNode||("transparent"===t.opts.background.toLowerCase()?t.renderer.setClearColor(n,0):t.renderer.setClearColor(n,1)),t.perspectiveCamera=new Zs(20,t.container.whratio,.1,1e4),t.perspectiveCamera.position.set(0,0,t.cam_z),t.perspectiveCamera.lookAt(new mt(0,0,0)),t.orthographicCamera=new Pr,t.orthographicCamera.position.set(0,0,t.cam_z),t.orthographicCamera.lookAt(new mt(0,0,0)),t.cams={perspective:t.perspectiveCamera,orthographic:t.orthographicCamera},i.bNode||"stereo"!=t.opts.effect||window.icn3duiHash||(t.effect=t.effects[e.effect],t.effect.setSize(t.container.width(),t.container.height()))}setVrAr(){let e=this.icn3d;e.icn3dui;let t=this;e.bSetVrAr=!0,e.bVr?(e.canvasUI=this.createUI(),e.raycasterVR=new jr,e.workingMatrix=new gi,e.workingVector=new mt,e.origin=new mt,e.dolly=new ji,e.dolly.position.z=5,e.dolly.add(e.cam),e.scene.add(e.dolly),e.dollyId=e.dolly.id,e.dummyCam=new ji,e.cam.add(e.dummyCam),e.clock=new Br,e.controllers=this.getControllers(),e.controllers.forEach((i=>{i.addEventListener("connected",(function(e){try{const i={},s="https://cdn.jsdelivr.net/npm/@webxr-input-profiles/assets@1.0/dist/profiles",n="generic-trigger";Zl(e.data,s,n).then((({profile:s,assetPath:n})=>{i.name=s.profileId,i.targetRayMode=e.data.targetRayMode,Object.entries(s.layouts).forEach((([e,t])=>{const s={};Object.values(t.components).forEach((e=>{s[e.rootNodeName]=e.gamepadIndices})),i[e]=s})),t.updateControllers(i)}))}catch(e){}})),i.addEventListener("disconnected",(function(){this.remove(this.children[0]),e.controllers.forEach((e=>{}))}))}))):e.bAr&&(e.gestures=new nc(e.renderer),e.scene.add(e.gestures.controller1),e.scene.add(e.gestures.controller2),e.gestures.addEventListener("doubletap",(e=>{t.positionCenter()})),e.gestures.addEventListener("pinch",(i=>{if(void 0!==i.initialise)t.startPosition=e.mdl.position.clone(),t.startScale=e.mdl.scale.clone();else{let s=1;const n=t.startScale.clone().multiplyScalar(i.scale*s);e.mdl.scale.copy(n)}})))}positionCenter(){let e=this.icn3d;e.icn3dui;const t=e.gestures.controller1;e.mdl.position.set(-.06,0,-.6).applyMatrix4(t.matrixWorld),e.mdl.scale.copy(new mt(.005,.005,.005))}setVrArButtons(){let e=this.icn3d,t=e.icn3dui;e.bSetVrArButtons=!0,t.bNode||($("#"+t.pre+"VRButton").remove(),$("#"+t.pre+"viewer").get(0).appendChild(e.VRButtonCls.createButton(e.renderer)),$("#"+t.pre+"ARButton").remove(),$("#"+t.pre+"viewer").get(0).appendChild(e.ARButtonCls.createButton(e.renderer)))}updateControllers(e){this.icn3d.icn3dui,this.addEventForController(e,"right"),this.addEventForController(e,"left")}addEventForController(e,t){let i=this.icn3d;i.icn3dui;const s="right"==t?i.renderer.xr.getController(0):i.renderer.xr.getController(1),n="right"==t?e.right:e.left;if(s&&void 0!==n){let e=!1,t=!1;Object.keys(n).forEach((s=>{-1!=s.indexOf("trigger")&&(e=!0),-1!=s.indexOf("squeeze")&&(t=!0),-1==s.indexOf("thumbstick")&&-1==s.indexOf("touchpad")||(i.xAxisIndex=n[s].xAxis,i.yAxisIndex=n[s].yAxis)})),e&&(s.addEventListener("selectstart",(function(){this.userData.selectPressed=!0})),s.addEventListener("selectend",(function(){this.userData.selectPressed=!1,this.userData.selected=void 0}))),t&&(s.addEventListener("squeezestart",(function(){this.userData.squeezePressed=!0,i.cam.add(i.canvasUI.mesh)})),s.addEventListener("squeezeend",(function(){this.userData.squeezePressed=!1,i.cam.remove(i.canvasUI.mesh)})))}}createUI(){let e=this.icn3d,t=e.icn3dui,i=94,s=50,n=94,r=34,a=12,o="#1c94c4",l="#ccc",d="#fbcb09",c=20;const h={panelSize:{width:2,height:1.6},height:400,select:{type:"button",paddingTop:c,position:{top:6,left:6},width:i,height:s,fontColor:"#000",fontSize:14,backgroundColor:l},residue:{type:"button",paddingTop:c,position:{top:62,left:6},width:i,height:s,fontColor:o,fontSize:a,backgroundColor:l,hover:d,onSelect:function(){e.pk=2,e.pAtomNum||(e.pAtomNum=0),e.cam.remove(e.canvasUI.mesh)}},secondarySelect:{type:"button",paddingTop:12,position:{top:118,left:6},width:i,height:s,fontColor:o,fontSize:a,backgroundColor:l,hover:d,onSelect:function(){e.pk=3,e.pAtomNum||(e.pAtomNum=0),e.cam.remove(e.canvasUI.mesh)}},chainSelect:{type:"button",paddingTop:c,position:{top:174,left:6},width:i,height:s,fontColor:o,fontSize:a,backgroundColor:l,hover:d,onSelect:function(){e.pk=5,e.pAtomNum||(e.pAtomNum=0),e.cam.remove(e.canvasUI.mesh)}},atom:{type:"button",paddingTop:c,position:{top:230,left:6},width:i,height:s,fontColor:o,fontSize:a,backgroundColor:l,hover:d,onSelect:function(){e.pk=1,e.pAtomNum||(e.pAtomNum=0),e.cam.remove(e.canvasUI.mesh)}},reset:{type:"button",paddingTop:c,position:{top:286,left:6},width:i,height:s,fontColor:o,fontSize:a,backgroundColor:l,hover:d,onSelect:function(){e.viewInterPairsCls.resetInteractionPairs(),e.selectionCls.resetAll(),e.cam.remove(e.canvasUI.mesh)}},togglehl:{type:"button",paddingTop:12,position:{top:342,left:6},width:i,height:s,fontColor:o,fontSize:a,backgroundColor:l,hover:d,onSelect:function(){e.hlUpdateCls.toggleHighlight(),e.cam.remove(e.canvasUI.mesh)}},style:{type:"button",paddingTop:c,position:{top:6,left:106},width:i,height:s,fontColor:"#000",fontSize:14,backgroundColor:l},ribbon:{type:"button",paddingTop:c,position:{top:62,left:106},width:i,height:s,fontColor:o,fontSize:a,backgroundColor:l,hover:d,onSelect:function(){e.setOptionCls.setStyle("proteins","ribbon"),e.setOptionCls.setStyle("nucleotides","nucleotide cartoon"),e.cam.remove(e.canvasUI.mesh)}},schematic:{type:"button",paddingTop:c,position:{top:118,left:106},width:i,height:s,fontColor:o,fontSize:a,backgroundColor:l,hover:d,onSelect:function(){e.setOptionCls.setStyle("proteins","schematic"),e.setOptionCls.setStyle("nucleotides","schematic"),e.cam.remove(e.canvasUI.mesh)}},stick:{type:"button",paddingTop:c,position:{top:174,left:106},width:i,height:s,fontColor:o,fontSize:a,backgroundColor:l,hover:d,onSelect:function(){e.setOptionCls.setStyle("proteins","stick"),e.setOptionCls.setStyle("nucleotides","stick"),e.cam.remove(e.canvasUI.mesh)}},sphere:{type:"button",paddingTop:c,position:{top:230,left:106},width:i,height:s,fontColor:o,fontSize:a,backgroundColor:l,hover:d,onSelect:function(){e.setOptionCls.setStyle("proteins","sphere"),e.setOptionCls.setStyle("nucleotides","sphere"),e.cam.remove(e.canvasUI.mesh)}},surface:{type:"button",paddingTop:c,position:{top:286,left:106},width:i,height:s,fontColor:o,fontSize:a,backgroundColor:l,hover:d,onSelect:function(){e.opts.surface="molecular surface",e.applyMapCls.applySurfaceOptions(),e.cam.remove(e.canvasUI.mesh)}},surfaceTrn:{type:"button",paddingTop:12,position:{top:342,left:106},width:i,height:s,fontColor:o,fontSize:a,backgroundColor:l,hover:d,onSelect:function(){e.opts.surface="molecular surface",e.opts.opacity="0.2",e.applyMapCls.applySurfaceOptions(),e.cam.remove(e.canvasUI.mesh)}},color:{type:"button",paddingTop:c,position:{top:6,left:206},width:i,height:s,fontColor:"#000",fontSize:14,backgroundColor:l},rainbow:{type:"button",paddingTop:c,position:{top:62,left:206},width:i,height:s,fontColor:o,fontSize:a,backgroundColor:l,hover:d,onSelect:function(){e.setOptionCls.setOption("color","rainbow for chains"),e.cam.remove(e.canvasUI.mesh)}},atomColor:{type:"button",paddingTop:c,position:{top:118,left:206},width:i,height:s,fontColor:o,fontSize:a,backgroundColor:l,hover:d,onSelect:function(){e.setOptionCls.setOption("color","atom"),e.cam.remove(e.canvasUI.mesh)}},chainColor:{type:"button",paddingTop:c,position:{top:174,left:206},width:i,height:s,fontColor:o,fontSize:a,backgroundColor:l,hover:d,onSelect:function(){e.setOptionCls.setOption("color","chain"),e.cam.remove(e.canvasUI.mesh)}},secondaryColor:{type:"button",paddingTop:12,position:{top:230,left:206},width:i,height:s,fontColor:o,fontSize:a,backgroundColor:l,hover:d,onSelect:function(){e.setOptionCls.setOption("color","secondary structure green"),e.cam.remove(e.canvasUI.mesh)}},charge:{type:"button",paddingTop:c,position:{top:342,left:206},width:i,height:s,fontColor:o,fontSize:a,backgroundColor:l,hover:d,onSelect:function(){e.setOptionCls.setOption("color","charge"),e.cam.remove(e.canvasUI.mesh)}},AlphaFold:{type:"button",paddingTop:c,position:{top:286,left:206},width:i,height:s,fontColor:o,fontSize:a,backgroundColor:l,hover:d,onSelect:function(){e.setOptionCls.setOption("color","confidence"),e.cam.remove(e.canvasUI.mesh)}},unicolor:{type:"button",paddingTop:c,position:{top:6,left:306},width:i,height:s,fontColor:"#000",fontSize:14,backgroundColor:l},red:{type:"button",position:{top:s,left:300},width:n,height:r,fontColor:"red",hover:d,onSelect:function(){e.setOptionCls.setOption("color","red"),e.cam.remove(e.canvasUI.mesh)}},green:{type:"button",position:{top:78,left:300},width:n,height:r,fontColor:"green",hover:d,onSelect:function(){e.setOptionCls.setOption("color","green"),e.cam.remove(e.canvasUI.mesh)}},blue:{type:"button",position:{top:106,left:300},width:n,height:r,fontColor:"blue",hover:d,onSelect:function(){e.setOptionCls.setOption("color","blue"),e.cam.remove(e.canvasUI.mesh)}},blueviolet:{type:"button",position:{top:134,left:300},width:n,height:r,fontColor:"#8A2BE2",hover:d,onSelect:function(){e.setOptionCls.setOption("color","8A2BE2"),e.cam.remove(e.canvasUI.mesh)}},magenta:{type:"button",position:{top:162,left:300},width:n,height:r,fontColor:"magenta",hover:d,onSelect:function(){e.setOptionCls.setOption("color","magenta"),e.cam.remove(e.canvasUI.mesh)}},yellow:{type:"button",position:{top:190,left:300},width:n,height:r,fontColor:"yellow",hover:d,onSelect:function(){e.setOptionCls.setOption("color","yellow"),e.cam.remove(e.canvasUI.mesh)}},orange:{type:"button",position:{top:218,left:300},width:n,height:r,fontColor:"orange",hover:d,onSelect:function(){e.setOptionCls.setOption("color","FFA500"),e.cam.remove(e.canvasUI.mesh)}},cyan:{type:"button",position:{top:246,left:300},width:n,height:r,fontColor:"cyan",hover:d,onSelect:function(){e.setOptionCls.setOption("color","cyan"),e.cam.remove(e.canvasUI.mesh)}},gray:{type:"button",position:{top:274,left:300},width:n,height:r,fontColor:"gray",hover:d,onSelect:function(){e.setOptionCls.setOption("color","888888"),e.cam.remove(e.canvasUI.mesh)}},white:{type:"button",position:{top:302,left:300},width:n,height:r,fontColor:"white",hover:d,onSelect:function(){e.setOptionCls.setOption("color","white"),e.cam.remove(e.canvasUI.mesh)}},analysis:{type:"button",paddingTop:c,position:{top:6,left:406},width:i,height:s,fontColor:"#000",fontSize:14,backgroundColor:l},distance:{type:"button",paddingTop:c,position:{top:62,left:406},width:i,height:s,fontColor:o,fontSize:a,backgroundColor:l,hover:d,onSelect:function(){try{e.bMeasureDistance=!0;let i=e.pickingCls.getPickedAtomList(e.pk,e.pAtom),s=e.pickingCls.getPickedAtomList(e.pk,e.pAtom2),n=e.applyCenterCls.centerAtoms(t.hashUtilsCls.hash2Atoms(i,e.atoms)).center,r=e.applyCenterCls.centerAtoms(t.hashUtilsCls.hash2Atoms(s,e.atoms)).center,a=0,o=0,l="#FFFF00",d=(n.x+r.x)/2,c=(n.y+r.y)/2,h=(n.z+r.z)/2,p=!0;e.analysisCls.addLine(n.x,n.y,n.z,r.x,r.y,r.z,l,p,"distance");let u=(parseInt(10*n.distanceTo(r))/10).toString()+" A";e.analysisCls.addLabel(u,d,c,h,a,l,o,"distance"),e.drawCls.draw(),e.cam.remove(e.canvasUI.mesh)}catch(e){}}},interaction:{type:"button",paddingTop:c,position:{top:118,left:406},width:i,height:s,fontColor:o,fontSize:a,backgroundColor:l,hover:d,onSelect:function(){try{e.viewInterPairsCls.viewInteractionPairs(["selected"],["non-selected"],!1,"3d",1,1,1,1,1,1),e.cam.remove(e.canvasUI.mesh)}catch(e){}}},delphi:{type:"button",paddingTop:c,position:{top:174,left:406},width:i,height:s,fontColor:o,fontSize:a,backgroundColor:l,hover:d,onSelect:async function(){e.phisurftype=22,e.phisurfop=1,e.phisurfwf="no",await e.delphiCls.CalcPhi(65,.15,2,!0),e.cam.remove(e.canvasUI.mesh)}},removeLabel:{type:"button",paddingTop:c,position:{top:230,left:406},width:i,height:s,fontColor:o,fontSize:a,backgroundColor:l,hover:d,onSelect:function(){for(let t in e.labels)e.labels[t]=[];e.drawCls.draw(),e.cam.remove(e.canvasUI.mesh)}},renderer:e.renderer},p=new rc({select:"Select",residue:"Residue",secondarySelect:"Secondary Structure",chainSelect:"Chain",atom:"Atom",reset:"Reset",togglehl:"Toggle Highlight",style:"Style",ribbon:"Ribbon",schematic:"Schematic",stick:"Stick",sphere:"Sphere",surface:"Surface",surfaceTrn:"Transparent Surface",color:"Color",rainbow:"Rainbow",atomColor:"Atom",chainColor:"Chain",secondaryColor:"Secondary Structure",AlphaFold:"AlphaFold",charge:"Charge",unicolor:"UniColor",red:"<path>M 100 15 L 15 15 L 15 100 L 100 100 Z<path>",green:"<path>M 100 15 L 15 15 L 15 100 L 100 100 Z<path>",blue:"<path>M 100 15 L 15 15 L 15 100 L 100 100 Z<path>",blueviolet:"<path>M 100 15 L 15 15 L 15 100 L 100 100 Z<path>",magenta:"<path>M 100 15 L 15 15 L 15 100 L 100 100 Z<path>",yellow:"<path>M 100 15 L 15 15 L 15 100 L 100 100 Z<path>",orange:"<path>M 100 15 L 15 15 L 15 100 L 100 100 Z<path>",cyan:"<path>M 100 15 L 15 15 L 15 100 L 100 100 Z<path>",gray:"<path>M 100 15 L 15 15 L 15 100 L 100 100 Z<path>",white:"<path>M 100 15 L 15 15 L 15 100 L 100 100 Z<path>",analysis:"Analysis",distance:"Distance",interaction:"Interaction",delphi:"DelPhi Potential",removeLabel:"Remove Label"},h);return p.mesh.position.set(0,0,-3),p}createUILog(){let e=this.icn3d;e.icn3dui;const t={panelSize:{width:2,height:2},height:512,info:{type:"text",overflow:"scroll",position:{top:6,left:6},width:506,height:506,backgroundColor:"#aaa",fontColor:"#000"},renderer:e.renderer},i=new rc({info:"Debug info"},t);return i.mesh.position.set(0,-1,-2),i}getControllers(){let e=this.icn3d;e.icn3dui;const t=new sc,i=(new Ts).setFromPoints([new mt(0,0,0),new mt(0,0,-1)]),s=new jn(i);s.name="line",s.scale.z=50;const n=[];for(let i=0;i<=1;i++){const r=e.renderer.xr.getController(i);if(!r)continue;e.dolly.add(r),r.add(s.clone()),r.userData.selectPressed=!1,e.cam.add(r),n.push(r);const a=e.renderer.xr.getControllerGrip(i);a.add(t.createControllerModel(a)),e.scene.add(a)}return n}}function lc(e,t,i){var s=this;this.STATE={NONE:-1,ROTATE:0,ZOOM:1,PAN:2,TOUCH_ROTATE:3,TOUCH_ZOOM_PAN:4},this.object=e,this.domElement=void 0!==t?t:document,this.enabled=!0,this.screen={left:0,top:0,width:0,height:0},this.rotateSpeed=1,this.zoomSpeed=1.2,this.panSpeed=.3,this.noRotate=!1,this.noZoom=!1,this.noPan=!1,this.noRoll=!1,this.staticMoving=!1,this.dynamicDampingFactor=.2,this.minDistance=0,this.maxDistance=1/0,this.keys=[65,83,68],this.target=new mt;var n=new mt;this._state=this.STATE.NONE;var r=this.STATE.NONE,a=new mt;this._rotateStart=new mt,this._rotateEnd=new mt,this._zoomStart=new pt,this._zoomEnd=new pt;var o=0,l=0;this._panStart=new pt,this._panEnd=new pt,this.target0=this.target.clone(),this.position0=this.object.position.clone(),this.up0=this.object.up.clone();var d={type:"change"},c={type:"start"},h={type:"end"};this.handleResize=function(){if(this.domElement===document)this.screen.left=0,this.screen.top=0,this.screen.width=window.innerWidth,this.screen.height=window.innerHeight;else if(this.domElement){var e=this.domElement.getBoundingClientRect(),t=this.domElement.ownerDocument.documentElement;this.screen.left=e.left+window.pageXOffset-t.clientLeft,this.screen.top=e.top+window.pageYOffset-t.clientTop,this.screen.width=e.width,this.screen.height=e.height}},this.handleEvent=function(e){"function"==typeof this[e.type]&&this[e.type](e)};var p,u,m,f,g,b,C=(p=new pt,function(e,t){return p.set((e-s.screen.left)/s.screen.width,(t-s.screen.top)/s.screen.height),p}),v=function(){var e=new mt,t=new mt,i=new mt;return function(n,r){i.set((n-.5*s.screen.width-s.screen.left)/(.5*s.screen.width),(.5*s.screen.height+s.screen.top-r)/(.5*s.screen.height),0);var o=i.length();return s.noRoll?o<Math.SQRT1_2?i.z=Math.sqrt(1-o*o):i.z=.5/o:o>1?i.normalize():i.z=Math.sqrt(1-o*o),a.copy(s.object.position).sub(s.target),e.copy(s.object.up).setLength(i.y),e.add(t.copy(s.object.up).cross(a).setLength(i.x)),e.add(a.setLength(i.z)),e}}();function _(e){!1===s.enabled||Object.keys(window).length<2||(window.removeEventListener("keydown",_),r=s._state,s._state===s.STATE.NONE&&(e.keyCode!==s.keys[s.STATE.ROTATE]||s.noRotate?e.keyCode!==s.keys[s.STATE.ZOOM]||s.noZoom?e.keyCode!==s.keys[s.STATE.PAN]||s.noPan||(s._state=s.STATE.PAN):s._state=s.STATE.ZOOM:s._state=s.STATE.ROTATE))}function y(e){!1===s.enabled||Object.keys(window).length<2||(e.stopPropagation(),s._state!==s.STATE.ROTATE||s.noRotate?s._state!==s.STATE.ZOOM||s.noZoom?s._state!==s.STATE.PAN||s.noPan||s._panEnd.copy(C(e.pageX,e.pageY)):s._zoomEnd.copy(C(e.pageX,e.pageY)):s._rotateEnd.copy(v(e.pageX,e.pageY)))}function S(e){!1===s.enabled||Object.keys(window).length<2||(e.stopPropagation(),s._state=s.STATE.NONE,document.removeEventListener("mousemove",y),document.removeEventListener("mouseup",S),s.dispatchEvent(h))}function w(e){if(!(!1===s.enabled||Object.keys(window).length<2)){e.stopPropagation();var t=0;e.wheelDelta?t=e.wheelDelta/40:e.detail&&(t=-e.detail/3),s._zoomStart.y=.005*t,s.dispatchEvent(c),s.dispatchEvent(h)}}this.rotateCamera=(u=new mt,m=new ut,function(e,t){var n;void 0===e&&(n=Math.acos(s._rotateStart.dot(s._rotateEnd)/s._rotateStart.length()/s._rotateEnd.length())),(n||void 0!==e)&&(void 0===e?(u.crossVectors(s._rotateStart,s._rotateEnd).normalize(),n*=s.rotateSpeed,m.setFromAxisAngle(u,-n)):m.copy(e),void 0===i||void 0===i.quaternion||void 0!==t&&!0!==t||i.quaternion.multiplyQuaternions(m,i.quaternion),a.applyQuaternion(m),s.object.up.applyQuaternion(m),s._rotateEnd.applyQuaternion(m),s.staticMoving?s._rotateStart.copy(s._rotateEnd):(m.setFromAxisAngle(u,n*(s.dynamicDampingFactor-1)),s._rotateStart.applyQuaternion(m)))}),this.zoomCamera=function(e,t){var n;s._state===s.STATE.TOUCH_ZOOM_PAN?(void 0!==e?n=e:(n=o/l,o=l),a.multiplyScalar(n),void 0===i||void 0===i._zoomFactor||void 0!==t&&!0!==t||(i._zoomFactor*=n,i.fogCls.setFog())):(n=void 0!==e?e:1+(s._zoomEnd.y-s._zoomStart.y)*s.zoomSpeed,void 0===i||void 0===i._zoomFactor||void 0!==t&&!0!==t||(i._zoomFactor*=n,i.fogCls.setFog()),1!==n&&(a.multiplyScalar(n),s.staticMoving?s._zoomStart.copy(s._zoomEnd):s._zoomStart.y+=(s._zoomEnd.y-s._zoomStart.y)*this.dynamicDampingFactor))},this.panCamera=(f=new pt,g=new mt,b=new mt,function(e,t){void 0!==e?(f=e,void 0===i||void 0===i.mouseChange||void 0!==t&&!0!==t||i.mouseChange.add(e)):(f.copy(s._panEnd).sub(s._panStart),void 0===i||void 0===i.mouseChange||void 0!==t&&!0!==t||i.mouseChange.add(s._panEnd).sub(s._panStart)),f.lengthSq()&&(f.multiplyScalar(a.length()*s.panSpeed),b.copy(a).cross(s.object.up).setLength(f.x),b.add(g.copy(s.object.up).setLength(f.y)),s.object.position.add(b),s.target.add(b),s.staticMoving?s._panStart.copy(s._panEnd):s._panStart.add(f.subVectors(s._panEnd,s._panStart).multiplyScalar(s.dynamicDampingFactor)))}),this.checkDistances=function(){s.noZoom&&s.noPan||(a.lengthSq()>s.maxDistance*s.maxDistance&&s.object.position.addVectors(s.target,a.setLength(s.maxDistance)),a.lengthSq()<s.minDistance*s.minDistance&&s.object.position.addVectors(s.target,a.setLength(s.minDistance)))},this.update=function(e){a.subVectors(s.object.position,s.target),s.noRotate||(void 0!==e&&void 0!==e.quaternion?s.rotateCamera(e.quaternion,e.update):s.rotateCamera()),s.noZoom||(void 0!==e&&void 0!==e._zoomFactor?s.zoomCamera(e._zoomFactor,e.update):s.zoomCamera()),s.noPan||(void 0!==e&&void 0!==e.mouseChange?s.panCamera(e.mouseChange,e.update):s.panCamera()),s.object.position.addVectors(s.target,a),s.checkDistances(),s.object.lookAt(s.target),n.distanceToSquared(s.object.position)>1e-6&&(s.dispatchEvent(d),n.copy(s.object.position))},this.reset=function(){s._state=s.STATE.NONE,r=s.STATE.NONE,s.target.copy(s.target0),s.object.position.copy(s.position0),s.object.up.copy(s.up0),a.subVectors(s.object.position,s.target),s.object.lookAt(s.target),s.dispatchEvent(d),n.copy(s.object.position)},Object.keys(window).length>=2&&this.domElement&&(this.domElement.addEventListener("contextmn",(function(e){}),!1),this.domElement.addEventListener("mousedown",(function(e){!1===s.enabled||Object.keys(window).length<2||(e.stopPropagation(),s._state===s.STATE.NONE&&(s._state=e.button),s._state!==s.STATE.ROTATE||s.noRotate?s._state!==s.STATE.ZOOM||s.noZoom?s._state!==s.STATE.PAN||s.noPan||(s._panStart.copy(C(e.pageX,e.pageY)),s._panEnd.copy(s._panStart)):(s._zoomStart.copy(C(e.pageX,e.pageY)),s._zoomEnd.copy(s._zoomStart)):(s._rotateStart.copy(v(e.pageX,e.pageY)),s._rotateEnd.copy(s._rotateStart)),document.addEventListener("mousemove",y,!1),document.addEventListener("mouseup",S,!1),s.dispatchEvent(c))}),!1),this.domElement.addEventListener("mousewheel",w,!1),this.domElement.addEventListener("DOMMouseScroll",w,!1),this.domElement.addEventListener("touchstart",(function(e){if(!(!1===s.enabled||Object.keys(window).length<2)){switch(e.touches.length){case 1:s._state=s.STATE.TOUCH_ROTATE,s._rotateStart.copy(v(e.touches[0].pageX,e.touches[0].pageY)),s._rotateEnd.copy(s._rotateStart);break;case 2:s._state=s.STATE.TOUCH_ZOOM_PAN;var t=e.touches[0].pageX-e.touches[1].pageX,i=e.touches[0].pageY-e.touches[1].pageY;l=o=Math.sqrt(t*t+i*i);var n=(e.touches[0].pageX+e.touches[1].pageX)/2,r=(e.touches[0].pageY+e.touches[1].pageY)/2;s._panStart.copy(C(n,r)),s._panEnd.copy(s._panStart);break;default:s._state=s.STATE.NONE}s.dispatchEvent(c)}}),!1),this.domElement.addEventListener("touchend",(function(e){if(!(!1===s.enabled||Object.keys(window).length<2)){switch(e.touches.length){case 1:s._rotateEnd.copy(v(e.touches[0].pageX,e.touches[0].pageY)),s._rotateStart.copy(s._rotateEnd);break;case 2:o=l=0;var t=(e.touches[0].pageX+e.touches[1].pageX)/2,i=(e.touches[0].pageY+e.touches[1].pageY)/2;s._panEnd.copy(C(t,i)),s._panStart.copy(s._panEnd)}s._state=s.STATE.NONE,s.dispatchEvent(h)}}),!1),this.domElement.addEventListener("touchmove",(function(e){if(!(!1===s.enabled||Object.keys(window).length<2))switch(e.stopPropagation(),e.touches.length){case 1:s._rotateEnd.copy(v(e.touches[0].pageX,e.touches[0].pageY));break;case 2:var t=e.touches[0].pageX-e.touches[1].pageX,i=e.touches[0].pageY-e.touches[1].pageY;l=Math.sqrt(t*t+i*i);var n=(e.touches[0].pageX+e.touches[1].pageX)/2,r=(e.touches[0].pageY+e.touches[1].pageY)/2;s._panEnd.copy(C(n,r));break;default:s._state=s.STATE.NONE}}),!1),Object.keys(window).length>=2&&window.addEventListener("keydown",_,!1),Object.keys(window).length>=2&&window.addEventListener("keyup",(function(e){!1===s.enabled||Object.keys(window).length<2||(s._state=r,window.addEventListener("keydown",_,!1))}),!1)),this.handleResize(),this.update()}function dc(e,t,i){this.icn3d;var s=this,n=-1,r=0,a=1,o=2,l=3,d=4;this.object=e,this.domElement=void 0!==t?t:document,this.enabled=!0,this.screen={left:0,top:0,width:0,height:0},this.rotateSpeed=.5,this.zoomSpeed=1.2;this.zoomSpeed*=.01,this.panSpeed=.03,this.noRotate=!1,this.noZoom=!1,this.noPan=!1,this.noRoll=!1,this.staticMoving=!1,this.dynamicDampingFactor=.2,this.keys=[65,83,68],this.target=new mt;var c=new mt;this._state=n;var h=n,p=new mt;this._rotateStart=new mt,this._rotateEnd=new mt,this._zoomStart=new pt,this._zoomEnd=new pt;var u=1,m=0,f=0;this._panStart=new pt,this._panEnd=new pt,this.target0=this.target.clone(),this.position0=this.object.position.clone(),this.up0=this.object.up.clone(),this.left0=this.object.left,this.right0=this.object.right,this.top0=this.object.top,this.bottom0=this.object.bottom,this.center0=new pt((this.left0+this.right0)/2,(this.top0+this.bottom0)/2);var g={type:"change"},b={type:"start"},C={type:"end"};this.handleResize=function(){if(this.domElement===document)this.screen.left=0,this.screen.top=0,this.screen.width=window.innerWidth,this.screen.height=window.innerHeight;else if(this.domElement){var e=this.domElement.getBoundingClientRect(),t=this.domElement.ownerDocument.documentElement;this.screen.left=e.left+window.pageXOffset-t.clientLeft,this.screen.top=e.top+window.pageYOffset-t.clientTop,this.screen.width=e.width,this.screen.height=e.height}this.left0=this.object.left,this.right0=this.object.right,this.top0=this.object.top,this.bottom0=this.object.bottom,this.center0.set((this.left0+this.right0)/2,(this.top0+this.bottom0)/2)},this.handleEvent=function(e){"function"==typeof this[e.type]&&this[e.type](e)};var v,_,y,S,w,x,A=(v=new pt,function(e,t){return v.set((e-s.screen.left)/s.screen.width,(t-s.screen.top)/s.screen.height),v}),M=function(){var e=new mt,t=new mt,i=new mt;return function(n,r){i.set((n-.5*s.screen.width-s.screen.left)/(.5*s.screen.width),(.5*s.screen.height+s.screen.top-r)/(.5*s.screen.height),0);var a=i.length();return s.noRoll?a<Math.SQRT1_2?i.z=Math.sqrt(1-a*a):i.z=.5/a:a>1?i.normalize():i.z=Math.sqrt(1-a*a),p.copy(s.object.position).sub(s.target),e.copy(s.object.up).setLength(i.y),e.add(t.copy(s.object.up).cross(p).setLength(i.x)),e.add(p.setLength(i.z)),e}}();function T(e){!1===s.enabled||Object.keys(window).length<2||(window.removeEventListener("keydown",T),h=s._state,s._state===n&&(e.keyCode!==s.keys[r]||s.noRotate?e.keyCode!==s.keys[a]||s.noZoom?e.keyCode!==s.keys[o]||s.noPan||(s._state=o):s._state=a:s._state=r))}function E(e){!1===s.enabled||Object.keys(window).length<2||(e.stopPropagation(),s._state!==r||s.noRotate?s._state!==a||s.noZoom?s._state!==o||s.noPan||s._panEnd.copy(A(e.pageX,e.pageY)):s._zoomEnd.copy(A(e.pageX,e.pageY)):s._rotateEnd.copy(M(e.pageX,e.pageY)))}function R(e){!1===s.enabled||Object.keys(window).length<2||(e.stopPropagation(),s._state=n,document.removeEventListener("mousemove",E),document.removeEventListener("mouseup",R),s.dispatchEvent(C))}function k(e){if(!(!1===s.enabled||Object.keys(window).length<2)){e.stopPropagation();var t=0;e.wheelDelta?t=e.wheelDelta/40:e.detail&&(t=-e.detail/3),s._zoomStart.y=.01*t,s.dispatchEvent(b),s.dispatchEvent(C)}}this.rotateCamera=(_=new mt,y=new ut,function(e,t){var n;void 0===e&&(n=Math.acos(s._rotateStart.dot(s._rotateEnd)/s._rotateStart.length()/s._rotateEnd.length())),(n||void 0!==e)&&(void 0===e?(_.crossVectors(s._rotateStart,s._rotateEnd).normalize(),n*=s.rotateSpeed,y.setFromAxisAngle(_,-n)):y.copy(e),void 0===i||void 0===i.quaternion||void 0!==t&&!0!==t||i.quaternion.multiplyQuaternions(y,i.quaternion),p.applyQuaternion(y),s.object.up.applyQuaternion(y),s._rotateEnd.applyQuaternion(y),s.staticMoving?s._rotateStart.copy(s._rotateEnd):(y.setFromAxisAngle(_,n*(s.dynamicDampingFactor-1)),s._rotateStart.applyQuaternion(y)))}),this.zoomCamera=function(e,t){var n;s._state===d?void 0!==e?n=e:(n=m/f,m=f):n=void 0!==e?e:1+(s._zoomEnd.y-s._zoomStart.y)*s.zoomSpeed/.01,void 0===i||void 0===i._zoomFactor||void 0!==t&&!0!==t||(i._zoomFactor*=n),1!==n&&(u=n,s.object.left=u*s.left0+(1-u)*s.center0.x,s.object.right=u*s.right0+(1-u)*s.center0.x,s.object.top=u*s.top0+(1-u)*s.center0.y,s.object.bottom=u*s.bottom0+(1-u)*s.center0.y,s.staticMoving?s._zoomStart.copy(s._zoomEnd):s._zoomStart.y+=(s._zoomEnd.y-s._zoomStart.y)*this.dynamicDampingFactor)},this.panCamera=(S=new pt,w=new mt,x=new mt,function(e,t){void 0!==e?(S=e,void 0===i||void 0===i.mouseChange||void 0!==t&&!0!==t||i.mouseChange.add(e)):(S.copy(s._panEnd).sub(s._panStart),void 0===i||void 0===i.mouseChange||void 0!==t&&!0!==t||i.mouseChange.add(s._panEnd).sub(s._panStart)),S.lengthSq()&&(S.multiplyScalar(p.length()*s.panSpeed),x.copy(p).cross(s.object.up).setLength(S.x),x.add(w.copy(s.object.up).setLength(S.y)),s.object.position.add(x),s.target.add(x),s.staticMoving?s._panStart.copy(s._panEnd):s._panStart.add(S.subVectors(s._panEnd,s._panStart).multiplyScalar(s.dynamicDampingFactor)))}),this.update=function(e){p.subVectors(s.object.position,s.target),s.noRotate||(void 0!==e&&void 0!==e.quaternion?s.rotateCamera(e.quaternion,e.update):s.rotateCamera()),s.noZoom||(void 0!==e&&void 0!==e._zoomFactor?s.zoomCamera(e._zoomFactor,e.update):s.zoomCamera(),s.object.updateProjectionMatrix()),s.noPan||(void 0!==e&&void 0!==e.mouseChange?s.panCamera(e.mouseChange,e.update):s.panCamera()),s.object.position.addVectors(s.target,p),s.object.lookAt(s.target),c.distanceToSquared(s.object.position)>1e-6&&(s.dispatchEvent(g),c.copy(s.object.position))},this.reset=function(){s._state=n,h=n,s.target.copy(s.target0),s.object.position.copy(s.position0),s.object.up.copy(s.up0),p.subVectors(s.object.position,s.target),s.object.left=s.left0,s.object.right=s.right0,s.object.top=s.top0,s.object.bottom=s.bottom0,s.object.lookAt(s.target),s.dispatchEvent(g),c.copy(s.object.position)},Object.keys(window).length>=2&&this.domElement&&(this.domElement.addEventListener("contextmn",(function(e){}),!1),this.domElement.addEventListener("mousedown",(function(e){!1===s.enabled||Object.keys(window).length<2||(e.stopPropagation(),s._state===n&&(s._state=e.button),s._state!==r||s.noRotate?s._state!==a||s.noZoom?s._state!==o||s.noPan||(s._panStart.copy(A(e.pageX,e.pageY)),s._panEnd.copy(s._panStart)):(s._zoomStart.copy(A(e.pageX,e.pageY)),s._zoomEnd.copy(s._zoomStart)):(s._rotateStart.copy(M(e.pageX,e.pageY)),s._rotateEnd.copy(s._rotateStart)),document.addEventListener("mousemove",E,!1),document.addEventListener("mouseup",R,!1),s.dispatchEvent(b))}),!1),this.domElement.addEventListener("mousewheel",k,!1),this.domElement.addEventListener("DOMMouseScroll",k,!1),this.domElement.addEventListener("touchstart",(function(e){if(!(!1===s.enabled||Object.keys(window).length<2)){switch(e.touches.length){case 1:s._state=l,s._rotateStart.copy(M(e.touches[0].pageX,e.touches[0].pageY)),s._rotateEnd.copy(s._rotateStart);break;case 2:s._state=d;var t=e.touches[0].pageX-e.touches[1].pageX,i=e.touches[0].pageY-e.touches[1].pageY;f=m=Math.sqrt(t*t+i*i);var r=(e.touches[0].pageX+e.touches[1].pageX)/2,a=(e.touches[0].pageY+e.touches[1].pageY)/2;s._panStart.copy(A(r,a)),s._panEnd.copy(s._panStart);break;default:s._state=n}s.dispatchEvent(b)}}),!1),this.domElement.addEventListener("touchend",(function(e){if(!(!1===s.enabled||Object.keys(window).length<2)){switch(e.touches.length){case 1:s._rotateEnd.copy(M(e.touches[0].pageX,e.touches[0].pageY)),s._rotateStart.copy(s._rotateEnd);break;case 2:m=f=0;var t=(e.touches[0].pageX+e.touches[1].pageX)/2,i=(e.touches[0].pageY+e.touches[1].pageY)/2;s._panEnd.copy(A(t,i)),s._panStart.copy(s._panEnd)}s._state=n,s.dispatchEvent(C)}}),!1),this.domElement.addEventListener("touchmove",(function(e){if(!(!1===s.enabled||Object.keys(window).length<2))switch(e.stopPropagation(),e.touches.length){case 1:s._rotateEnd.copy(M(e.touches[0].pageX,e.touches[0].pageY));break;case 2:var t=e.touches[0].pageX-e.touches[1].pageX,i=e.touches[0].pageY-e.touches[1].pageY;f=Math.sqrt(t*t+i*i);var r=(e.touches[0].pageX+e.touches[1].pageX)/2,a=(e.touches[0].pageY+e.touches[1].pageY)/2;s._panEnd.copy(A(r,a));break;default:s._state=n}}),!1),window.addEventListener("keydown",T,!1),window.addEventListener("keyup",(function(e){!1===s.enabled||Object.keys(window).length<2||(s._state=h,window.addEventListener("keydown",T,!1))}),!1)),this.handleResize(),this.update()}lc.prototype=Object.create(st.prototype),lc.prototype.constructor=lc,dc.prototype=Object.create(st.prototype),dc.prototype.constructor=dc;class cc{constructor(e){this.icn3d=e}setCamera(){let e=this.icn3d,t=e.icn3dui;if(e.bControlGl&&!t.bNode){window.cam=e.cams[e.opts.camera.toLowerCase()];let i=e.maxD;if(window.cam===e.perspectiveCamera){let s=void 0!==e.biomtMatrices&&e.biomtMatrices.length*e.cnt>e.maxatomcnt;s?window.camMaxDFactor=1:void 0!==window.camMaxDFactorFog?window.camMaxDFactor=window.camMaxDFactorFog:window.camMaxDFactor=3,window.cam_z>0?window.cam.position.z=i*window.camMaxDFactor:window.cam.position.z=-i*window.camMaxDFactor,"yes"===e.opts.slab?s?window.cam.near=.1:void 0!==window.camMaxDFactorFog?window.cam.near=i*window.camMaxDFactorFog-10:window.cam.near=i*window.camMaxDFactor:window.cam.near=.1,window.cam.far=1e4,e.bControlGl&&!t.bNode?window.controls=new lc(window.cam,void 0,e):t.bNode?e.controls=new lc(e.cam,document,e):e.controls=new lc(e.cam,document.getElementById(e.id),e)}else window.cam===e.orthographicCamera&&(void 0!==e.biomtMatrices&&e.biomtMatrices.length*e.cnt>10*e.maxatomcnt?window.cam.right=e.maxD/2*1.5:window.cam.right=e.maxD/2*2.5,window.cam.left=-window.cam.right,window.cam.top=window.cam.right/e.container.whratio,window.cam.bottom=-window.cam.right/e.container.whratio,"yes"===e.opts.slab?window.cam.near=2*e.maxD:window.cam.near=0,window.cam.far=1e4,e.bControlGl&&!t.bNode?window.controls=new dc(window.cam,void 0,e):t.bNode?e.controls=new dc(e.cam,document,e):e.controls=new dc(e.cam,document.getElementById(e.id),e));window.cam.updateProjectionMatrix()}e.cam=e.cams[e.opts.camera.toLowerCase()];let i=e.maxD;if(e.cam===e.perspectiveCamera){let s=void 0!==e.biomtMatrices&&e.biomtMatrices.length*e.cnt>e.maxatomcnt;s?e.camMaxDFactor=1:void 0!==e.camMaxDFactorFog?e.camMaxDFactor=e.camMaxDFactorFog:e.camMaxDFactor=3,e.cam_z>0?e.cam.position.z=i*e.camMaxDFactor:e.cam.position.z=-i*e.camMaxDFactor,"yes"===e.opts.slab?s?e.cam.near=.1:void 0!==e.camMaxDFactorFog?e.cam.near=i*e.camMaxDFactorFog-10:e.cam.near=i*e.camMaxDFactor:e.cam.near=.1,e.cam.far=1e4,e.bControlGl&&!t.bNode?window.controls=new lc(e.cam,void 0,e):t.bNode?e.controls=new lc(e.cam,document,e):e.controls=new lc(e.cam,document.getElementById(e.id),e)}else e.cam===e.orthographicCamera&&(void 0!==e.biomtMatrices&&e.biomtMatrices.length*e.cnt>10*e.maxatomcnt?e.cam.right=e.maxD/2*1.5:e.cam.right=e.maxD/2*2.5,e.cam.left=-e.cam.right,e.cam.top=e.cam.right/e.container.whratio,e.cam.bottom=-e.cam.right/e.container.whratio,"yes"===e.opts.slab?e.cam.near=2*e.maxD:e.cam.near=0,e.cam.far=1e4,e.bControlGl&&!t.bNode?window.controls=new dc(e.cam,void 0,e):t.bNode?e.controls=new dc(e.cam,document,e):e.controls=new dc(e.cam,document.getElementById(e.id),e));e.cam.updateProjectionMatrix()}}class hc{constructor(e){this.icn3d=e}setFog(e){let t=this.icn3d,i=t.icn3dui.parasCls.backgroundColors[t.opts.background.toLowerCase()];if(e){let e=t.applyCenterCls.centerAtoms(t.hAtoms);t.maxD=e.maxD,t.maxD<25&&(t.maxD=25)}let s=void 0!==t.biomtMatrices&&t.biomtMatrices.length*t.cnt>t.maxatomcnt;if("yes"===t.opts.fog)if("perspective"===t.opts.camera)if(s)t.scene.fog=void 0,t.bSetFog=!1;else{let e=t._zoomFactor>1?1*t._zoomFactor:t._zoomFactor;t.scene.fog=new an(i,2.5*t.maxD*e,4*t.maxD*e),t.bSetFog=!0,t.camMaxDFactorFog=3}else"orthographic"===t.opts.camera&&(t.scene.fog=void 0,t.bSetFog=!1);else t.scene.fog=void 0,t.bSetFog=!1}}class pc{constructor(e){this.icn3d=e}createBox(e,t,i,s,n,r){let a=this.icn3d,o=a.icn3dui;if(o.bNode)return;void 0===t&&(t=.8),void 0===i&&(i=!1),void 0===s&&(s=.8),r?void 0===n&&(n=a.hColor):void 0===n&&(n=e.color);let l=i?t:(o.parasCls.vdwRadii[e.elem.toUpperCase()]||t)*(s||1);this.createBox_base(e.coord,l,n,r)}createBox_base(e,t,i,s,n,r,a){let o,l=this.icn3d;l.icn3dui.bNode||(void 0===a&&(a=r?.5:1),new zs(1,1,1),o=new Hs(l.boxGeometry,new gr({transparent:!0,opacity:a,specular:l.frac,shininess:l.shininess,emissive:l.emissive,color:i})),o.scale.x=o.scale.y=o.scale.z=t,o.position.copy(e),l.mdl.add(o),s?l.prevHighlightObjects.push(o):n?l.prevOtherMesh.push(o):l.objects.push(o))}createBoxRepresentation_P_CA(e,t,i){let s=this.icn3d;if(s.icn3dui.bNode)return;let n=this;s.reprSubCls.createRepresentationSub(e,(function(e){"CA"!==e.name&&"O3'"!==e.name&&"O3*"!==e.name||n.createBox(e,void 0,void 0,t,void 0,i)}))}}class uc{constructor(e){this.icn3d=e}createBrick(e,t,i,s){let n=this.icn3d;if(n.icn3dui.bNode)return;let r=new Kn(1,1,1,4,1),a=new Hs(r,new gr({specular:n.frac,shininess:n.shininess,emissive:n.emissive,color:s}));a.position.copy(e).add(t).multiplyScalar(.5),a.matrixAutoUpdate=!1,a.lookAt(t.clone().sub(e)),a.updateMatrix(),a.matrix.multiply((new gi).makeScale(i,i,e.distanceTo(t))).multiply((new gi).makeRotationX(.5*Math.PI)),n.mdl.add(a)}}class mc{constructor(e){this.icn3d=e}createCurveSubArrow(e,t,i,s,n,r,a,o,l,d,c,h,p,u,m){if(this.icn3d.icn3dui.bNode)return;let f=[],g=[];f.push(e),g.push(o),this.prepareStrand(f,g,t,i,s,void 0,n,r,a,l,d,!1,c,h,p,u,m),f=[],g=[]}createStripArrow(e,t,i,s,n,r,a,o,l,d,c,h,p,u,m,f){if(this.icn3d.icn3dui.bNode)return;let g=[],b=[];g.push(e),g.push(t),b.push(o),b.push(l),this.prepareStrand(g,b,void 0,i,s,n,r,void 0,a,d,c,!0,h,p,u,m,f),g=[],b=[]}prepareStrand(e,t,i,s,n,r,a,o,l,d,c,h,p,u,m,f,g){let b=this.icn3d,C=b.icn3dui;if(1===d.length)return;let v=s,_=!m,y=[];y.push(s[s.length-2]),y.push(s[s.length-1]),n=n||b.axisDIV;let S,w,x,A,M=2/(l-1),T={};for(let e=0,i=t.length;e<i;++e)T[e]=[];let E=C.subdivideCls.subdivide(d,s,n,void 0,void 0,f,g)[0];if(1===E.length)return;let R,k=[],O=void 0===m||m?d.length-2:d.length;for(R=0;R<O;++R){for(let i=0,s=t.length;i<s;++i)T[i].push(e[i][R]);k.push(s[R])}if(k.push(s[R]),void 0===m||m)for(let e=0,i=t.length;e<i;++e)S=M*t[e]-1,w=E.length-1-n,x=d.length-2,A=new mt(E[w].x+c[x].x*S,E[w].y+c[x].y*S,E[w].z+c[x].z*S),T[e].push(A);let I,P=[];for(let e=0,i=t.length;e<i;++e)I=C.subdivideCls.subdivide(T[e],k,n,p,a),T[e]=I[0],s=I[2],0===e&&(P=I[1]);if(h?_?b.bDoublecolor?b.stripCls.createStrip(T[0],T[1],v,n,r,a,!0,void 0,u,P,f,g,d,c):b.stripCls.createStrip(T[0],T[1],s,n,r,a,!0,void 0,u,P,f,g,d,c):b.stripCls.createStrip(T[0],T[1],s,n,r,a,!0,void 0,u,P,f,g):b.curveCls.createCurveSub(T[0],i,s,n,a,o,!0,void 0,u,P,f,g),void 0===m||m){k=[],P=[];for(let e=0,i=t.length;e<i;++e){T[e]=[];for(let i=n*(d.length-2),s=n*(d.length-1);p[parseInt(i/n)]&&i<s;i+=n){let s=parseInt(i/n);for(let r=0;r<n;++r){let a=M*t[e]-1;a=a*1.8*(n-r)/n;let o=parseInt(i/n),l=new mt(E[i+r].x+c[o].x*a,E[i+r].y+c[o].y*a,E[i+r].z+c[o].z*a);l.smoothen=!0,T[e].push(l),k.push(y[0]),0===e&&P.push(s)}}let i=0,s=E.length-1,r=d.length-1,a=new mt(E[s].x+c[r].x*i,E[s].y+c[r].y*i,E[s].z+c[r].z*i);a.smoothen=!0,T[e].push(a),k.push(y[1]),0===e&&P.push(s)}E=[],h?b.stripCls.createStrip(T[0],T[1],k,n,r,a,!0,void 0,void 0,P,f,g):b.curveCls.createCurveSub(T[0],i,k,n,a,o,!0,void 0,void 0,P,f,g)}for(let e in T){for(let t=0,i=T[e].length;t<i;++t)T[e][t]=null;T[e]=[]}T={}}}class fc{constructor(e){this.icn3d=e}createCurveSub(e,t,i,s,n,r,a,o,l,d,c,h){let p,u=this.icn3d,m=u.icn3dui;if(!m.bNode&&0!==e.length){if(s=s||5,a)p=e;else{let t=!0,r=m.subdivideCls.subdivide(e,i,s,o,n,c,h,t);p=r[0],i=r[2]}if(0!==p.length){if(u.stripCls.setCalphaDrawnCoord(p,s,l),1===n){let e=u.coilWidth/2,t=4,i=!1;if(p.length>1)if(void 0!==d){let s,n,r=[];for(let a=0,o=p.length;a<o;++a){if(s=d[a],s!==n&&parseInt(s)!==parseInt(n)+1&&void 0!==n||a===o-1){let s=new mr(new rr(r),r.length,e,t,i),n=new Hs(s,u.matShader);n.renderOrder=u.renderOrderPicking,u.mdl.add(n),u.prevHighlightObjects.push(n),s=null,r=[]}r.push(p[a]),n=s}r=[]}else{let s=new mr(new rr(p),p.length,e,t,i),n=new Hs(s,u.matShader);n.renderOrder=u.renderOrderPicking,u.mdl.add(n),u.prevHighlightObjects.push(n),s=null}}else{let e,s=new Ts,a=[],o=[],l=0;if(2===n&&r)for(let t=0;t<p.length;++t,l+=3)p[t].addScalar(.6),a[l]=p[t].x,a[l+1]=p[t].y,a[l+2]=p[t].z,e=m.parasCls.thr(i[t]),o[l]=e.r,o[l+1]=e.g,o[l+2]=e.b;else for(let t=0;t<p.length;++t,l+=3)a[l]=p[t].x,a[l+1]=p[t].y,a[l+2]=p[t].z,e=m.parasCls.thr(i[t]),o[l]=e.r,o[l+1]=e.g,o[l+2]=e.b;let d=3;s.setAttribute("position",new gs(new Float32Array(a),d)),s.setAttribute("color",new gs(new Float32Array(o),d));let c=new jn(s,new Ln({linewidth:t,vertexColors:!0}));u.mdl.add(c),2===n?u.prevHighlightObjects.push(c):u.objects.push(c)}p=null}}}}class gc{constructor(e){this.icn3d=e}createCylinder(e,t,i,s,n,r,a,o,l){let d=this.icn3d,c=d.icn3dui;if(c.bNode)return;let h,p=l;void 0===l&&(l=o?.5:1),1===n?(h=new Hs(d.cylinderGeometryOutline,d.matShader),h.position.copy(e).add(t).multiplyScalar(.5),h.matrixAutoUpdate=!1,h.lookAt(t.clone().sub(e)),h.updateMatrix(),h.matrix.multiply((new gi).makeScale(i,i,e.distanceTo(t))).multiply((new gi).makeRotationX(.5*Math.PI)),h.renderOrder=d.renderOrderPicking,d.mdl.add(h),d.prevHighlightObjects.push(h)):(2===n?(h=new Hs(d.cylinderGeometry,new gr({transparent:!0,opacity:l,specular:d.frac,shininess:d.shininess,emissive:d.emissive,color:s})),i*=1.5):h=new Hs(d.cylinderGeometry,new gr({transparent:!0,opacity:l,specular:d.frac,shininess:d.shininess,emissive:d.emissive,color:s})),h.position.copy(e).add(t).multiplyScalar(.5),h.matrixAutoUpdate=!1,h.lookAt(t.clone().sub(e)),h.updateMatrix(),h.matrix.multiply((new gi).makeScale(i,i,e.distanceTo(t))).multiply((new gi).makeRotationX(.5*Math.PI)),!d.bImpo||p||o?d.mdl.add(h):(d.posArray.push(e.x),d.posArray.push(e.y),d.posArray.push(e.z),s||(s=c.parasCls.thr(16777215)),d.colorArray.push(s.r),d.colorArray.push(s.g),d.colorArray.push(s.b),d.pos2Array.push(t.x),d.pos2Array.push(t.y),d.pos2Array.push(t.z),void 0!==r?(d.color2Array.push(r.r),d.color2Array.push(r.g),d.color2Array.push(r.b)):(d.color2Array.push(s.r),d.color2Array.push(s.g),d.color2Array.push(s.b)),d.radiusArray.push(i),d.cnt<=d.maxatomcnt&&d.mdl_ghost.add(h)),2===n?d.bImpo&&!p?d.cnt<=d.maxatomcnt&&d.prevHighlightObjects_ghost.push(h):d.prevHighlightObjects.push(h):d.bImpo&&!p?d.cnt<=d.maxatomcnt&&d.objects_ghost.push(h):(void 0===a||a)&&d.objects.push(h))}createCylinder_base(e,t,i,s,n,r,a){let o=this.icn3d;if(o.icn3dui.bNode)return;let l=new Hs(o.cylinderGeometry,new gr({specular:o.frac,shininess:o.shininess,emissive:o.emissive,color:s}));return l.position.copy(e).add(t).multiplyScalar(.5),l.matrixAutoUpdate=!1,l.lookAt(t.clone().sub(e)),l.updateMatrix(),l.matrix.multiply((new gi).makeScale(i,i,e.distanceTo(t))).multiply((new gi).makeRotationX(.5*Math.PI)),l}createCylinderHelix(e,t,i){let s=this.icn3d;if(s.icn3dui.bNode)return;let n,r,a,o=null,l={},d={};for(a in e){let c=e[a];c.het||(("helix"!==c.ss&&"sheet"!==c.ss||c.ssend||c.ssbegin)&&(l[c.serial]=c),"sheet"===c.ss&&(d[c.serial]=c),"CA"===c.name&&("helix"===c.ss&&c.ssend&&(null!==o&&n===c.chain&&parseInt(r)<parseInt(c.resi)&&(1===i||2===i?this.createCylinder(o.coord,c.coord,t,s.hColor,i):this.createCylinder(o.coord,c.coord,t,c.color)),o=null),null===o&&"helix"===c.ss&&c.ssbegin&&(o=c,n=c.chain,r=c.resi)))}1===i||2===i?(Object.keys(l).length>0&&s.tubeCls.createTube(l,"CA",s.coilWidth,i),Object.keys(d).length>0&&s.strandCls.createStrand(d,void 0,void 0,!0,0,s.helixSheetWidth,!1,2*s.ribbonthickness,i)):(Object.keys(l).length>0&&s.tubeCls.createTube(l,"CA",s.coilWidth),Object.keys(d).length>0&&s.strandCls.createStrand(d,void 0,void 0,!0,0,s.helixSheetWidth,!1,2*s.ribbonthickness))}createCylinderCurve(e,t,i,s,n){let r=this.icn3d;if(r.icn3dui.bNode)return;let a,o,l,d,c,h,p=null;for(l in e)if(d=e[l],!d.het&&(c=d.structure+"_"+d.chain,h=d.structure+"_"+a,-1!=t.indexOf(d.name))){if(null!==p&&a===d.chain&&r.ParserUtilsCls.getResiNCBI(h,o)+1===r.ParserUtilsCls.getResiNCBI(c,d.resi)&&Math.abs(p.coord.x-d.coord.x)<8&&Math.abs(p.coord.y-d.coord.y)<8&&Math.abs(p.coord.z-d.coord.z)<8){let e=p.coord.clone().add(d.coord).multiplyScalar(.5);if(n)1===n&&(this.createCylinder(p.coord,e,i,p.color,n),this.createCylinder(e,d.coord,i,d.color,n),r.sphereCls.createSphere(d,i,!0,1,n));else if(s){let t=r.lineCls.createSingleLine(p.coord,e,p.color,!1);r.mdl.add(t),r.objects.push(t),t=r.lineCls.createSingleLine(e,d.coord,d.color,!1),r.mdl.add(t),r.objects.push(t)}else this.createCylinder(p.coord,e,i,p.color),this.createCylinder(e,d.coord,i,d.color),r.sphereCls.createSphere(d,i,!0,1,n)}p=d,a=d.chain,o=d.resi,r.sphereCls.createSphere(d,i,!0,1,n),2===n&&r.boxCls.createBox(d,void 0,void 0,void 0,void 0,n)}if(null!==p&&a===d.chain&&r.ParserUtilsCls.getResiNCBI(h,o)+1===r.ParserUtilsCls.getResiNCBI(c,d.resi)&&Math.abs(p.coord.x-d.coord.x)<8&&Math.abs(p.coord.y-d.coord.y)<8&&Math.abs(p.coord.z-d.coord.z)<8){let e=p.coord.add(d.coord).multiplyScalar(.5);if(n)1===n&&(this.createCylinder(p.coord,e,i,p.color,n),this.createCylinder(e,d.coord,i,d.color,n),r.sphereCls.createSphere(d,i,!0,1,n));else if(s){let t=r.lineCls.createSingleLine(p.coord,e,p.color,!1);r.mdl.add(t),r.objects.push(t),t=r.lineCls.createSingleLine(e,d.coord,d.color,!1),r.mdl.add(t),r.objects.push(t)}else this.createCylinder(p.coord,e,i,p.color),this.createCylinder(e,d.coord,i,d.color)}}}class bc{constructor(e){this.icn3d=e}createLineRepresentation(e,t){let i=this.icn3d;if(i.icn3dui.bNode)return;let s=new Ts,n=[],r=[],a=0,o=0;i.reprSubCls.createRepresentationSub(e,void 0,(function(e,t){if(e.color===t.color)n[a++]=e.coord.x,n[a++]=e.coord.y,n[a++]=e.coord.z,n[a++]=t.coord.x,n[a++]=t.coord.y,n[a++]=t.coord.z,r[o++]=e.color.r,r[o++]=e.color.g,r[o++]=e.color.b,r[o++]=t.color.r,r[o++]=t.color.g,r[o++]=t.color.b;else{let i=e.coord.clone().add(t.coord).multiplyScalar(.5);n[a++]=e.coord.x,n[a++]=e.coord.y,n[a++]=e.coord.z,n[a++]=i.x,n[a++]=i.y,n[a++]=i.z,n[a++]=t.coord.x,n[a++]=t.coord.y,n[a++]=t.coord.z,n[a++]=i.x,n[a++]=i.y,n[a++]=i.z,r[o++]=e.color.r,r[o++]=e.color.g,r[o++]=e.color.b,r[o++]=e.color.r,r[o++]=e.color.g,r[o++]=e.color.b,r[o++]=t.color.r,r[o++]=t.color.g,r[o++]=t.color.b,r[o++]=t.color.r,r[o++]=t.color.g,r[o++]=t.color.b}}));if(s.setAttribute("position",new gs(new Float32Array(n),3)),s.setAttribute("color",new gs(new Float32Array(r),3)),2!==t){let e;1===t||(e=new Wn(s,new Ln({linewidth:i.linewidth,vertexColors:!0})),i.mdl.add(e)),1===t?i.prevHighlightObjects.push(e):i.objects.push(e)}else 2===t&&i.boxCls.createBoxRepresentation_P_CA(e,.8,t)}createConnCalphSidechain(e,t){let i=this.icn3d;if(i.icn3dui.bNode)return;let s={};for(let i in e){let n=e[i];if(!n.het&&n.style2===t){s[n.structure+"_"+n.chain+"_"+n.resi]=1}}let n=[],r=[];for(let e in s){let t=i.firstAtomObjCls.getFirstAtomObjByName(i.residues[e],"CA");if(void 0!==t)for(let e=0,s=t.bonds.length;e<s;++e){let s=i.atoms[t.bonds[e]];"C"!==s.name&&"N"!==s.name&&"H"!==s.elem&&s.resi==t.resi&&(n.push(t.coord),n.push(s.coord),r.push(t.color),r.push(s.color))}}for(let e=0,s=n.length;e<s;e+=2)if("ball and stick"===t||"stick"===t||"ball and stick2"===t||"stick2"===t){let s="stick"===t||"stick2"===t?i.cylinderRadius:.5*i.cylinderRadius;i.cylinderCls.createCylinder(n[e],n[e+1],s,r[e+1])}else if("lines"===t||"lines2"===t){let t=this.createSingleLine(n[e],n[e+1],r[e+1],!1,.5);i.mdl.add(t)}}createSingleLine(e,t,i,s,n){if(this.icn3d.icn3dui.bNode)return;let r,a=new Ts,o=[];r=s?new vr({linewidth:1,color:i,dashSize:n,gapSize:.5*n}):new Ln({linewidth:1,color:i}),o[0]=e.x,o[1]=e.y,o[2]=e.z,o[3]=t.x,o[4]=t.y,o[5]=t.z;a.setAttribute("position",new gs(new Float32Array(o),3));let l=new Wn(a,r);return s&&l.computeLineDistances(),l}createLines(e){let t=this.icn3d,i=t.icn3dui;if(!i.bNode&&void 0!==e)for(let s in e){let n=e[s];for(let e=0,r=n.length;e<r;++e){let r=n[e],a=r.position1,o=r.position2,l=!!r.dashed&&r.dashed,d="missingres"==s?.8:.3,c=r.radius?r.radius:t.lineRadius,h=r.opacity?r.opacity:1,p="#"+r.color.replace(/\#/g,""),u=i.parasCls.thr(p);if(l){let e,i,n=a.distanceTo(o),r=parseInt(n/d),l=o.clone().sub(a).multiplyScalar(d/n);for(let n=0;n<r;++n)n%2==1&&(e=a.clone().add(l.clone().multiplyScalar(n)),i=a.clone().add(l.clone().multiplyScalar(n+1)),"stabilizer"==s?t.brickCls.createBrick(e,i,c,u):t.cylinderCls.createCylinder(e,i,c,u,void 0,void 0,void 0,void 0,h))}else"stabilizer"==s?t.brickCls.createBrick(a,o,c,u):t.cylinderCls.createCylinder(a,o,c,u,void 0,void 0,void 0,void 0,h)}}}}class Cc{constructor(e){this.icn3d=e}createRepresentationSub(e,t,i){if(!this.icn3d.icn3dui.bNode)for(let s in e){let n=e[s];t&&t(n);for(let e in n.bonds){let t=this.icn3d.atoms[n.bonds[e]];void 0===t||t.serial<n.serial||t.chain===n.chain&&(t.resi===n.resi||"C"===n.name&&"N"===t.name||"O3'"===n.name&&"P"===t.name||"O3*"===n.name&&"P"===t.name||"SG"===n.name&&"SG"===t.name)&&i&&i(n,t)}}}}class vc{constructor(e){this.icn3d=e}createSphere(e,t,i,s,n){let r=this.icn3d.icn3dui;if(r.bNode)return;void 0===t&&(t=.8),void 0===i&&(i=!1);let a=r.parasCls.vdwRadii[e.elem.toUpperCase()]||t;i&&(a=t,s=1),this.createSphereBase(e.coord,e.color,a,s,n)}createSphereBase(e,t,i,s,n,r,a){let o,l=this.icn3d,d=l.icn3dui;if(d.bNode)return;void 0===s&&(s=1);let c=a;if(void 0===a&&(a=r?.5:1),2===n)s*=1.5,t=l.hColor,o=new Hs(l.sphereGeometry,new gr({transparent:!0,opacity:a,specular:l.frac,shininess:l.shininess,emissive:l.emissive,color:t})),o.scale.x=o.scale.y=o.scale.z=i*(s||1),o.position.copy(e),l.mdl.add(o);else if(1===n)o=new Hs(l.sphereGeometry,l.matShader),o.scale.x=o.scale.y=o.scale.z=i*(s||1),o.position.copy(e),o.renderOrder=l.renderOrderPicking,l.mdl.add(o);else if(void 0===t&&(t=d.parasCls.defaultAtomColor),o=new Hs(l.sphereGeometry,new gr({transparent:!0,opacity:a,specular:l.frac,shininess:l.shininess,emissive:l.emissive,color:t})),o.scale.x=o.scale.y=o.scale.z=i*(s||1),o.position.copy(e),!l.bImpo||c||r)l.mdl.add(o);else{l.posArraySphere.push(e.x),l.posArraySphere.push(e.y),l.posArraySphere.push(e.z),l.colorArraySphere.push(t.r),l.colorArraySphere.push(t.g),l.colorArraySphere.push(t.b);let n=i*(s||1);l.radiusArraySphere.push(n),l.cnt<=l.maxatomcnt&&l.mdl_ghost.add(o)}1===n||2===n?l.bImpo?l.cnt<=l.maxatomcnt&&l.prevHighlightObjects_ghost.push(o):l.prevHighlightObjects.push(o):l.bImpo&&!c?l.cnt<=l.maxatomcnt&&l.objects_ghost.push(o):l.objects.push(o)}createSphereRepresentation(e,t,i,s,n){let r=this.icn3d;if(r.icn3dui.bNode)return;let a=this;r.reprSubCls.createRepresentationSub(e,(function(e){a.createSphere(e,t,i,s,n)}))}}class _c{constructor(e){this.icn3d=e}createStickRepresentation(e,t,i,s,n,r){let a=this.icn3d;if(a.icn3dui.bNode)return;let o=void 0!==r&&r?t/a.cylinderRadius:1,l=a.cylinderRadius*o*.4,d=a.cylinderRadius*o*.3;a.reprSubCls.createRepresentationSub(e,(function(e){a.sphereCls.createSphere(e,t,!s,s,n)}),(function(e,t){let s=e.coord.clone().add(t.coord).multiplyScalar(.5),r=e.serial+"_"+t.serial;if(a.doublebonds.hasOwnProperty(r)){let i,r,d,c,h=new mt(Math.random(),Math.random(),Math.random());if(1==e.bonds.length&&1==t.bonds.length){c=t.coord.clone(),c.sub(e.coord);let i=h.clone();c.cross(i).normalize().multiplyScalar(.2*o)}else{if(e.bonds.length>=t.bonds.length&&e.bonds.length>1)i=e.serial,r=e.bonds[0],d=e.bonds[1];else{if(!(t.bonds.length>=e.bonds.length&&t.bonds.length>1))return void console.log("Double bond was not drawn due to the undefined cross plane");i=t.serial,r=t.bonds[0],d=t.bonds[1]}let s=a.atoms[i].coord.clone();s.sub(a.atoms[r].coord);let n=a.atoms[i].coord.clone();n.sub(a.atoms[d].coord),s.cross(n),0==parseInt(1e4*s.length())&&(s=new mt(.2,.3,.5)),c=t.coord.clone(),c.sub(e.coord),c.cross(s).normalize().multiplyScalar(.2*o),0==parseInt(1e4*c.length())&&(s=new mt(.5,.3,.2),c.cross(s).normalize().multiplyScalar(.2*o))}e.color===t.color?a.dAtoms.hasOwnProperty(e.serial)&&a.dAtoms.hasOwnProperty(t.serial)&&(a.cylinderCls.createCylinder(e.coord.clone().add(c),t.coord.clone().add(c),l,e.color,n),a.cylinderCls.createCylinder(e.coord.clone().sub(c),t.coord.clone().sub(c),l,e.color,n)):a.bImpo?a.dAtoms.hasOwnProperty(e.serial)&&a.dAtoms.hasOwnProperty(t.serial)&&(a.cylinderCls.createCylinder(e.coord.clone().add(c),t.coord.clone().add(c),l,e.color,n,t.color),a.cylinderCls.createCylinder(e.coord.clone().sub(c),t.coord.clone().sub(c),l,e.color,n,t.color)):a.dAtoms.hasOwnProperty(e.serial)&&a.dAtoms.hasOwnProperty(t.serial)&&(a.cylinderCls.createCylinder(e.coord.clone().add(c),s.clone().add(c),l,e.color,n),a.cylinderCls.createCylinder(t.coord.clone().add(c),s.clone().add(c),l,t.color,n),a.cylinderCls.createCylinder(e.coord.clone().sub(c),s.clone().sub(c),l,e.color,n),a.cylinderCls.createCylinder(t.coord.clone().sub(c),s.clone().sub(c),l,t.color,n))}else if(a.aromaticbonds.hasOwnProperty(r)){let i,r,d;if(e.bonds.length>t.bonds.length&&e.bonds.length>1)i=e.serial,r=e.bonds[0],d=e.bonds[1];else{if(!(t.bonds.length>1))return;i=t.serial,r=t.bonds[0],d=t.bonds[1]}let c=a.atoms[i].coord.clone();c.sub(a.atoms[r].coord);let h=a.atoms[i].coord.clone();h.sub(a.atoms[d].coord),c.cross(h);let p=t.coord.clone();p.sub(e.coord),p.cross(c).normalize().multiplyScalar(.2*o);let u=0;for(let i=0,s=e.bondOrder.length;i<s;++i)"1.5"===e.bondOrder[i]&&e.bonds[i]!==t.serial&&(u=e.bonds[i]);let m="add";if(0===u)m="add";else{let i=e.coord.clone().add(p),s=e.coord.clone().sub(p),n=t.coord.clone().sub(i).normalize(),r=a.atoms[u].coord.clone().sub(i).normalize(),o=t.coord.clone().sub(s).normalize(),l=a.atoms[u].coord.clone().sub(s).normalize();m=Math.acos(n.dot(r))<Math.acos(o.dot(l))?"sub":"add"}if(e.color===t.color){let i,s;"add"===m?(a.cylinderCls.createCylinder(e.coord.clone().sub(p),t.coord.clone().sub(p),l,e.color,n),i=e.coord.clone().add(p),s=t.coord.clone().add(p).sub(i).multiplyScalar(1/11)):(a.cylinderCls.createCylinder(e.coord.clone().add(p),t.coord.clone().add(p),l,e.color,n),i=e.coord.clone().sub(p),s=t.coord.clone().sub(p).sub(i).multiplyScalar(1/11));for(let t=0;t<=10;++t)if(t%2==0){let r=i.clone().add(s.clone().multiplyScalar(t)),o=i.clone().add(s.clone().multiplyScalar(t+1));a.cylinderCls.createCylinder(r,o,l,e.color,n)}}else{let i,r;"add"===m?(a.dAtoms.hasOwnProperty(e.serial)&&a.dAtoms.hasOwnProperty(t.serial)&&(a.cylinderCls.createCylinder(e.coord.clone().sub(p),s.clone().sub(p),l,e.color,n),a.cylinderCls.createCylinder(t.coord.clone().sub(p),s.clone().sub(p),l,t.color,n)),i=e.coord.clone().add(p),r=t.coord.clone().add(p).sub(i).multiplyScalar(1/11)):(a.dAtoms.hasOwnProperty(e.serial)&&a.dAtoms.hasOwnProperty(t.serial)&&(a.cylinderCls.createCylinder(e.coord.clone().add(p),s.clone().add(p),l,e.color,n),a.cylinderCls.createCylinder(t.coord.clone().add(p),s.clone().add(p),l,t.color,n)),i=e.coord.clone().sub(p),r=t.coord.clone().sub(p).sub(i).multiplyScalar(1/11));for(let s=0;s<=10;++s)if(s%2==0&&a.dAtoms.hasOwnProperty(e.serial)&&a.dAtoms.hasOwnProperty(t.serial)){let o=i.clone().add(r.clone().multiplyScalar(s)),d=i.clone().add(r.clone().multiplyScalar(s+1));s<5?a.cylinderCls.createCylinder(o,d,l,e.color,n):a.cylinderCls.createCylinder(o,d,l,t.color,n)}}}else if(a.triplebonds.hasOwnProperty(r)){let i=new mt(Math.random(),Math.random(),Math.random()),r=t.coord.clone();r.sub(e.coord);let l=i.clone();l.cross(r).normalize().multiplyScalar(.3*o),e.color===t.color?a.dAtoms.hasOwnProperty(e.serial)&&a.dAtoms.hasOwnProperty(t.serial)&&(a.cylinderCls.createCylinder(e.coord,t.coord,d,e.color,n),a.cylinderCls.createCylinder(e.coord.clone().add(l),t.coord.clone().add(l),d,e.color,n),a.cylinderCls.createCylinder(e.coord.clone().sub(l),t.coord.clone().sub(l),a.triBondRadius,e.color,n)):a.bImpo?a.dAtoms.hasOwnProperty(e.serial)&&a.dAtoms.hasOwnProperty(t.serial)&&(a.cylinderCls.createCylinder(e.coord,t.coord,d,e.color,n,t.color),a.cylinderCls.createCylinder(e.coord.clone().add(l),t.coord.clone().add(l),d,e.color,n,t.color),a.cylinderCls.createCylinder(e.coord.clone().sub(l),t.coord.clone().sub(l),d,e.color,n,t.color)):a.dAtoms.hasOwnProperty(e.serial)&&a.dAtoms.hasOwnProperty(t.serial)&&(a.cylinderCls.createCylinder(e.coord,s,d,e.color,n),a.cylinderCls.createCylinder(t.coord,s,d,t.color,n),a.cylinderCls.createCylinder(e.coord.clone().add(l),s.clone().add(l),d,e.color,n),a.cylinderCls.createCylinder(t.coord.clone().add(l),s.clone().add(l),d,t.color,n),a.cylinderCls.createCylinder(e.coord.clone().sub(l),s.clone().sub(l),d,e.color,n),a.cylinderCls.createCylinder(t.coord.clone().sub(l),s.clone().sub(l),d,t.color,n))}else e.color===t.color?a.cylinderCls.createCylinder(e.coord,t.coord,i,e.color,n):a.bImpo?a.dAtoms.hasOwnProperty(e.serial)&&a.dAtoms.hasOwnProperty(t.serial)&&a.cylinderCls.createCylinder(e.coord,t.coord,i,e.color,n,t.color):a.dAtoms.hasOwnProperty(e.serial)&&a.dAtoms.hasOwnProperty(t.serial)&&(a.cylinderCls.createCylinder(e.coord,s,i,e.color,n),a.cylinderCls.createCylinder(t.coord,s,i,t.color,n))}))}}class yc{constructor(e){this.icn3d=e}getFirstAtomObj(e){let t=this.icn3d;if(t.icn3dui,void 0===e||0===Object.keys(e).length)return;let i=Object.keys(e)[0];return t.atoms[i]}getMiddleAtomObj(e,t){let i=this.icn3d;if(i.icn3dui,void 0===e||0===Object.keys(e).length)return;let s=Object.keys(e),n=t&&t<s.length?s[t]:s[parseInt(s.length/2)];return i.atoms[n]}getFirstCalphaAtomObj(e){let t,i=this.icn3d;if(i.icn3dui,void 0!==e&&0!==Object.keys(e).length){for(let s in e)if("CA"==i.atoms[s].name){t=s;break}if(!t)for(let s in e)if("O3'"==i.atoms[s].name||"O3*"==i.atoms[s].name){t=s;break}return void 0!==t?i.atoms[t]:this.getFirstAtomObj(e)}}getFirstAtomObjByName(e,t){let i,s=this.icn3d;if(s.icn3dui,void 0===e||0===Object.keys(e).length)return s.atoms[0];for(let n in e)if(s.atoms[n].name==t){i=n;break}return void 0!==i?s.atoms[i]:void 0}getLastAtomObj(e){let t=this.icn3d;if(t.icn3dui,void 0===e||0===Object.keys(e).length)return t.atoms[0];let i=Object.keys(e),s=i[i.length-1];return t.atoms[s]}getResiduesFromAtoms(e){let t=this.icn3d;t.icn3dui;let i={};for(let s in e){i[t.atoms[s].structure+"_"+t.atoms[s].chain+"_"+t.atoms[s].resi]=1}return i}getResiduesFromCalphaAtoms(e){let t=this.icn3d;t.icn3dui;let i={};for(let s in e)if("CA"==t.atoms[s].name&&t.proteins.hasOwnProperty(s)||!t.proteins.hasOwnProperty(s)){i[t.atoms[s].structure+"_"+t.atoms[s].chain+"_"+t.atoms[s].resi]=t.atoms[s].resn}return i}getChainsFromAtoms(e){let t=this.icn3d;t.icn3dui;let i={};for(let s in e){let e=t.atoms[s];i[e.structure+"_"+e.chain]=1}return i}getAtomFromResi(e,t){let i=this.icn3d;if(i.icn3dui,i.residues.hasOwnProperty(e))for(let s in i.residues[e])if(i.atoms[s].name===t&&!i.atoms[s].het)return i.atoms[s]}getAtomCoordFromResi(e,t){this.icn3d.icn3dui;let i=this.getAtomFromResi(e,t);if(void 0!==i){return void 0!==i.coord2?i.coord2:i.coord}}}class Sc{constructor(e){this.icn3d=e}createStrip(e,t,i,s,n,r,a,o,l,d,c,h,p,u){let m=this.icn3d,f=m.icn3dui;if(!(f.bNode||e.length<2)){if(s=s||m.axisDIV,p&&m.bDoublecolor){let e=!1,t=f.subdivideCls.subdivide(p,i,s,o,r,c,h,e);p=t[0],this.setCalphaDrawnCoord(p,s,l);for(let e=0,t=u.length;e<t;++e)u[e].normalize();u=f.subdivideCls.subdivide(u,i,s,o,r,c,h,e)[0],i=t[2]}else{if(!a){let n=!1,a=f.subdivideCls.subdivide(e,i,s,o,r,c,h,n),l=f.subdivideCls.subdivide(t,i,s,o,r,c,h,n);e=a[0],t=l[0],i=a[2]}if(e.length<2)return;this.setCalphaDrawnCoord(e,s,l)}if(1===r){let i=m.coilWidth/2,s=4,n=!1;if(void 0!==d){let r,a,o=[],l=[];for(let c=0,h=e.length;c<h;++c){if(r=d[c],r!==a&&parseInt(r)!==parseInt(a)+1&&void 0!==a||c===h-1){let e=new mr(new rr(o),o.length,i,s,n),t=new Hs(e,m.matShader);t.renderOrder=m.renderOrderPicking,m.mdl.add(t),m.prevHighlightObjects.push(t),e=null;let r=new mr(new rr(l),l.length,i,s,n);t=new Hs(r,m.matShader),t.renderOrder=m.renderOrderPicking,m.mdl.add(t),m.prevHighlightObjects.push(t),r=null,o=[],l=[]}o.push(e[c]),l.push(t[c]),a=r}o=[],l=[]}else{let r=new mr(new rr(e),e.length,i,s,n),a=new Hs(r,m.matShader);a.renderOrder=m.renderOrderPicking,m.mdl.add(a),m.prevHighlightObjects.push(a),r=null;let o=new mr(new rr(t),t.length,i,s,n);a=new Hs(o,m.matShader),a.renderOrder=m.renderOrderPicking,m.mdl.add(a),m.prevHighlightObjects.push(a),o=null}}else{let s,a,o,l,d,c=new Ts,h=[],p=[],u=[],f=0,g=0,b=0;for(let r=0,c=e.length;r<c;++r)if(a=e[r],o=t[r],a&&o){for(let e=0;e<2;++e)h[f++]=a.x,h[f++]=a.y,h[f++]=a.z;for(let e=0;e<2;++e)h[f++]=o.x,h[f++]=o.y,h[f++]=o.z;r<c-1&&(s=t[r].clone().sub(e[r]).cross(e[r+1].clone().sub(e[r])).normalize().multiplyScalar(n)),l=e[r].clone().add(s),d=t[r].clone().add(s);for(let e=0;e<2;++e)h[f++]=l.x,h[f++]=l.y,h[f++]=l.z;for(let e=0;e<2;++e)h[f++]=d.x,h[f++]=d.y,h[f++]=d.z;for(let e=0;e<8;++e){let e=i[r]?i[r]:i[r-1]?i[r-1]:{r:0,g:0,b:0};p[g++]=e.r,p[g++]=e.g,p[g++]=e.b}}let C=[[0,2,-6,-8],[-4,-2,6,4],[7,3,-5,-1],[-3,-7,1,5]];for(let t=1,i=e.length;t<i;++t){let e=8*t;for(let t=0;t<4;++t)u[b++]=e+C[t][0],u[b++]=e+C[t][1],u[b++]=e+C[t][2],u[b++]=e+C[t][3],u[b++]=e+C[t][0],u[b++]=e+C[t][2]}let v,_=3,y=h.length/_-8;for(let t=0;t<4;++t){for(let e=0;e<_;++e)h[f++]=h[2*t*_+e];for(let e=0;e<_;++e)h[f++]=h[(y+2*t)*_+e];if(i[0]){p[g++]=i[0].r,p[g++]=i[0].g,p[g++]=i[0].b;let t=i[e.length-1]?i[e.length-1]:i[e.length-2]?i[e.length-2]:{r:0,g:0,b:0};p[g++]=t.r,p[g++]=t.g,p[g++]=t.b}}y+=8,u[b++]=y,u[b++]=y+2,u[b++]=y+6,u[b++]=y+4,u[b++]=y,u[b++]=y+6,u[b++]=y+1,u[b++]=y+5,u[b++]=y+7,u[b++]=y+3,u[b++]=y+1,u[b++]=y+7,c.setAttribute("position",new gs(new Float32Array(h),_)),c.setAttribute("color",new gs(new Float32Array(p),_)),c.setIndex(new gs(new Uint32Array(u),1)),c.computeVertexNormals(),2===r?(v=new Hs(c,new gr({transparent:!0,opacity:.5,specular:m.frac,shininess:m.shininess,emissive:m.emissive,vertexColors:!0,side:2})),m.mdl.add(v),m.prevHighlightObjects.push(v)):(v=new Hs(c,new gr({specular:m.frac,shininess:m.shininess,emissive:m.emissive,vertexColors:!0,side:2})),m.mdl.add(v),m.objects.push(v))}e=null,t=null}}setCalphaDrawnCoord(e,t,i){let s=this.icn3d;s.icn3dui;let n=0;if(void 0!==i)for(let r=0,a=e.length;r<a;r+=t){let t=i[n];s.atoms.hasOwnProperty(t)&&(s.atoms[t].coord2=e[r].clone()),++n}}}class wc{constructor(e){this.icn3d=e}createTube(e,t,i,s,n,r){let a=this.icn3d;if(a.icn3dui.bNode)return;let o,l,d,c,h,p=[],u=[],m=[],f=[],g=[],b=0,C=[];for(let r in e)if(c=e[r],c.name===t&&!c.het){if(0==b&&(d=c),c.structure,c.chain,(parseInt(c.resi)-1).toString(),b>0&&(o!==c.chain||Math.abs(c.coord.x-h.coord.x)>6||Math.abs(c.coord.y-h.coord.y)>6||Math.abs(c.coord.z-h.coord.z)>6||h.ssbegin||a.ParserUtilsCls.getResiNCBI(c.structure+"_"+o,l)+1<a.ParserUtilsCls.getResiNCBI(c.structure+"_"+c.chain,c.resi)&&(Math.abs(c.coord.x-h.coord.x)>3||Math.abs(c.coord.y-h.coord.y)>3||Math.abs(c.coord.z-h.coord.z)>3))){if(2!==s){if(!isNaN(d.resi)&&!isNaN(h.resi)){let e=d.structure+"_"+d.chain+"_"+(parseInt(d.resi)-1).toString(),s=a.firstAtomObjCls.getAtomCoordFromResi(e,t);f=void 0!==s?[s]:[];let r=h.structure+"_"+h.chain+"_"+(parseInt(h.resi)+1).toString(),o=h.structure+"_"+h.chain+"_"+(parseInt(h.resi)+2).toString(),l=h.structure+"_"+h.chain+"_"+(parseInt(h.resi)+3).toString();if(a.residues.hasOwnProperty(r)){let e=a.firstAtomObjCls.getAtomFromResi(r,t);void 0!==e&&e.ssbegin&&(r=h.structure+"_"+h.chain+"_"+(parseInt(h.resi)+2).toString(),o=h.structure+"_"+h.chain+"_"+(parseInt(h.resi)+3).toString(),p.push(e.coord),n?m.push(this.getCustomtubesize(r)):m.push(this.getRadius(i,e)),u.push(e.color))}if(1==p.length&&a.residues.hasOwnProperty(r)){let e=a.firstAtomObjCls.getAtomFromResi(r,t);if(e){p.push(e.coord),u.push(e.color);let t=this.getRadius(i,c);m.push(t),r=o,o=l}}let b=a.firstAtomObjCls.getAtomCoordFromResi(r,t);void 0!==b&&g.push(b);let C=a.firstAtomObjCls.getAtomCoordFromResi(o,t);void 0!==C&&g.push(C)}C.push({pnts:p,colors:u,radii:m,prevone:f,nexttwo:g})}p=[],u=[],m=[],f=[],g=[],d=c,b=0}if(0==p.length&&!isNaN(c.resi)){let e=c.structure+"_"+c.chain+"_"+(parseInt(c.resi)-1).toString();a.residues.hasOwnProperty(e)&&(h=a.firstAtomObjCls.getAtomFromResi(e,t),void 0!==h&&h.ssend&&(p.push(h.coord),n?m.push(this.getCustomtubesize(e)):m.push(this.getRadius(i,h)),u.push(h.color)))}let e;p.push(c.coord),e=n?this.getCustomtubesize(c.structure+"_"+c.chain+"_"+c.resi):this.getRadius(i,c),m.push(e),u.push(c.color),1===b&&(u[u.length-2]=c.color),o=c.chain,l=c.resi;let r=1.2;2!==s||c.ssbegin||a.boxCls.createBox(c,void 0,void 0,r,void 0,s),++b,h=c}if(2!==s){if(f=[],void 0!==d&&!isNaN(d.resi)){let e=d.structure+"_"+d.chain+"_"+(parseInt(d.resi)-1).toString(),i=a.firstAtomObjCls.getAtomCoordFromResi(e,t);f=void 0!==i?[i]:[]}if(g=[],void 0!==c&&!isNaN(c.resi)){let e=c.structure+"_"+c.chain+"_"+(parseInt(c.resi)+1).toString(),s=c.structure+"_"+c.chain+"_"+(parseInt(c.resi)+2).toString(),n=c.structure+"_"+c.chain+"_"+(parseInt(c.resi)+3).toString();if(1==p.length&&a.residues.hasOwnProperty(e)){let r=a.firstAtomObjCls.getAtomFromResi(e,t);if(r){p.push(r.coord),u.push(r.color);let t=this.getRadius(i,c);m.push(t),e=s,s=n}}let r=a.firstAtomObjCls.getAtomCoordFromResi(e,t);void 0!==r&&g.push(r);let o=a.firstAtomObjCls.getAtomCoordFromResi(s,t);void 0!==o&&g.push(o)}C.push({pnts:p,colors:u,radii:m,prevone:f,nexttwo:g})}for(let e=0,t=C.length;e<t;++e){let t=C[e].pnts,i=C[e].colors,n=C[e].radii,a=C[e].prevone,o=C[e].nexttwo;this.createTubeSub(t,i,n,s,a,o,r)}C=[]}getCustomtubesize(e){let t=this.icn3d;t.icn3dui;let i=e.lastIndexOf("_"),s=e.substr(i+1),n=e.substr(0,i);return t.queryresi2score[n]&&t.queryresi2score[n].hasOwnProperty(s)?.01*t.queryresi2score[n][s]:t.coilWidth}createTubeSub(e,t,i,s,n,r,a){let o=this.icn3d,l=o.icn3dui;if(l.bNode)return;if(e.length<2)return;let d,c,h=o.tubeDIV,p=o.axisDIV,u=1/h,m=1/p,f=new Ts,g=[],b=[],C=[],v=0,_=0,y=0,S=l.subdivideCls.subdivide(e,t,p,void 0,void 0,n,r),w=S[0];t=S[2];let x,A=new mt;for(let e=0,s=w.length;e<s;++e){let n,r,o,p,f=(e-1)*m;if(0===e)n=i[0],n>0&&(c=n);else if(f%1==0)n=i[f],n>0&&(c=n);else{let e=Math.floor(f),t=f-e;n=i[e]*(1-t)+i[e+1]*t,a||n<1*c&&(n=0)}e<s-1?(r=w[e].clone().sub(w[e+1]),o=new mt(0,-r.z,r.y).normalize().multiplyScalar(n),p=r.clone().cross(o).normalize().multiplyScalar(n),A.dot(o)<0&&(o.negate(),p.negate()),A=o,x=p):(o=A,p=x);for(let i=0;i<h;++i){let s=2*Math.PI*u*i,n=w[e].clone().add(o.clone().multiplyScalar(Math.cos(s))).add(p.clone().multiplyScalar(Math.sin(s)));g[v++]=n.x,g[v++]=n.y,g[v++]=n.z,d=e==t.length-1&&t.length>1?l.parasCls.thr(t[t.length-2]):l.parasCls.thr(t[e]),b[_++]=d.r,b[_++]=d.g,b[_++]=d.b}}let M,T=0;for(let e=0,t=w.length-1;e<t;++e){let e=0,t=3*T,i=new mt(g[t],g[t+1],g[t+2]);t=3*(T+h);let s=new mt(g[t],g[t+1],g[t+2]);t=3*(T+h+1);let n=new mt(g[t],g[t+1],g[t+2]),r=i.clone().sub(s).lengthSq(),a=i.clone().sub(n).lengthSq();r>a&&(r=a,e=1);for(let t=0;t<h;++t)C[y++]=T+t,C[y++]=T+(t+e)%h+h,C[y++]=T+(t+1)%h,C[y++]=T+(t+1)%h,C[y++]=T+(t+e)%h+h,C[y++]=T+(t+e+1)%h+h;T+=h}f.setAttribute("position",new gs(new Float32Array(g),3)),f.setAttribute("color",new gs(new Float32Array(b),3)),f.setIndex(new gs(new Uint32Array(C),1)),f.computeVertexNormals(),2===s?(M=new Hs(f,new gr({transparent:!0,opacity:.5,specular:o.frac,shininess:o.shininess,emissive:o.emissive,vertexColors:!0,side:2})),o.mdl&&o.mdl.add(M)):1===s?(M=new Hs(f,o.matShader),M.renderOrder=o.renderOrderPicking,o.mdl&&o.mdl.add(M)):(M=new Hs(f,new gr({specular:o.frac,shininess:o.shininess,emissive:o.emissive,vertexColors:!0,side:2})),o.mdl&&o.mdl.add(M)),1===s||2===s?o.prevHighlightObjects.push(M):o.objects.push(M)}getRadius(e,t){let i=this.icn3d;i.icn3dui;let s=e;return s=e||(t.b>0&&t.b<=100?.01*t.b:t.b>100?1:i.coilWidth),s}}class xc{constructor(e){this.icn3d=e}createStrand(e,t,i,s,n,r,a,o,l){let d=this.icn3d,c=d.icn3dui;if(c.bNode)return;let h=!!s,p={};p=Object.keys(e).length<Object.keys(d.atoms).length?this.getSSExpandedAtoms(e):e,2===l&&(s?(s=!1,t=null,i=null,n=null,r=null,o=void 0):(s=!0,t=2,i=void 0,n=void 0,r=void 0,o=d.ribbonthickness)),t=t||d.strandDIV,i=i||d.axisDIV,n=n||d.coilWidth,a=a||!1,r=r||d.helixSheetWidth;let u={};for(let e=0;e<t;++e)u[e]=[];let m,f,g,b=[],C=[],v=[],_=[],y=[],S=null,w=null,x=null,A=null,M=null,T=null,E=null,R=null,k=!1,O=null,I=null,P=null,D=null,L=null,F=!1,N=!1,U={};d.bCalphaOnly=c.utilsCls.isCalphaPhosOnly(p);let H={};for(let e in p){let t=p[e];H[t.structure+"_"+t.chain+"_"+t.resi]=1}let B=Object.keys(H).length,z=0,q=Object.keys(d.hAtoms).length==Object.keys(d.atoms).length,j=[];for(let c in p)if(g=p[c],("O"===g.name||"CA"===g.name)&&!g.het&&("CA"===g.name&&(e.hasOwnProperty(c)&&("helix"!==g.ss&&"sheet"!==g.ss||g.ssend||g.ssbegin)&&(U[c]=g),S=g.coord,x=g.color,D=g.serial,j.push(g.serial)),"O"===g.name||d.bCalphaOnly&&"CA"===g.name)){null==S&&(S=g.coord,x=g.color,D=g.serial),"O"===g.name&&(w=g.coord);let c=!0;if(m!==g.chain&&(c=!1),g.ssend&&"sheet"===g.ss?F=!0:g.ssend&&"helix"===g.ss&&(N=!0),M){1===l||2===l?y.push(d.hColor):y.push(T),f="coil"!==R&&"coil"===g.ss||k&&g.ssbegin||"coil"===R?n:r;let i,s,o=4;"O"===g.name?(i=M.clone(),null!=A?i.sub(A):(A=M.clone(),j.length>o+1?(i=A.clone(),s=d.atoms[j[j.length-1-o-1]].coord.clone(),s.sub(i)):i=new mt(Math.random(),Math.random(),Math.random()))):d.bCalphaOnly&&"CA"===g.name&&(j.length>o+1?(i=A.clone(),s=d.atoms[j[j.length-1-o-1]].coord.clone(),s.sub(i)):i=new mt(Math.random(),Math.random(),Math.random())),i.normalize(),i.multiplyScalar(f),null!==E&&i.dot(E)<0&&i.negate(),E=i;for(let e=0,i=2/(t-1);e<t;++e){let t=i*e-1,s=new mt(A.x+E.x*t,A.y+E.y*t,A.z+E.z*t);a||"sheet"!==R||(s.smoothen=!0),u[e].push(s)}b.push(A),C.push(E),e.hasOwnProperty(I)?(v.push(P),_.push(L)):(v.push(0),_.push(0)),++z}let p=6,U=A&&Math.abs(S.x-A.x)>p||A&&Math.abs(S.y-A.y)>p||A&&Math.abs(S.z-A.z)>p;if((g.ssbegin||g.ssend||z===B-1||U)&&u[0].length>0&&c){let c="CA",p=[],m=[];if(isNaN(d.atoms[I].resi))p=[];else{let e=d.atoms[I].structure+"_"+d.atoms[I].chain+"_"+(parseInt(d.atoms[I].resi)-1).toString(),t=d.firstAtomObjCls.getAtomCoordFromResi(e,c);p=void 0!==t?[t]:[]}if(!isNaN(d.atoms[I].resi)){let e=d.atoms[I].structure+"_"+d.atoms[I].chain+"_"+(parseInt(d.atoms[I].resi)+1).toString(),t=d.firstAtomObjCls.getAtomCoordFromResi(e,c);void 0!==t&&m.push(t);let i=d.atoms[I].structure+"_"+d.atoms[I].chain+"_"+(parseInt(d.atoms[I].resi)+2).toString(),s=d.firstAtomObjCls.getAtomCoordFromResi(i,c);void 0!==s&&m.push(s)}if(!U){1===l||2===l?y.push(d.hColor):y.push(T),f=g.ssend&&"sheet"===g.ss?0:"coil"===R&&g.ssbegin||k&&g.ssbegin||"coil"===g.ss?n:r;let i,s,o=4;"O"===g.name?(i=w.clone(),i.sub(S)):d.bCalphaOnly&&"CA"===g.name&&(j.length>o?(i=S.clone(),s=d.atoms[j[j.length-1-o]].coord.clone(),s.sub(i)):i=new mt(Math.random(),Math.random(),Math.random())),i.normalize(),i.multiplyScalar(f),null!==E&&i.dot(E)<0&&i.negate(),E=i;for(let e=0,i=2/(t-1);e<t;++e){let t=i*e-1,s=new mt(S.x+E.x*t,S.y+E.y*t,S.z+E.z*t);a||"sheet"!==R||(s.smoothen=!0),u[e].push(s)}O=g.serial,b.push(S),C.push(E),e.hasOwnProperty(O)?(v.push(g.resi),_.push(D)):(v.push(0),_.push(0))}for(let e=0;!s&&e<t;++e)F?d.curveStripArrowCls.createCurveSubArrow(u[e],1,y,i,l,h,t,e,b,C,v,_,!0,p,m):N&&(q?d.curveCls.createCurveSub(u[e],1,y,i,l,h,!1,v,_,void 0,p,m):d.curveStripArrowCls.createCurveSubArrow(u[e],1,y,i,l,h,t,e,b,C,v,_,!1,p,m));if(s)if(F){let e=0,s=t-1;d.curveStripArrowCls.createStripArrow(u[0],u[t-1],y,i,o,l,t,e,s,b,C,v,_,!0,p,m)}else if(N)if(q)d.stripCls.createStrip(u[0],u[t-1],y,i,o,l,!1,v,_,void 0,p,m,b,C);else{let e=0,s=t-1;d.curveStripArrowCls.createStripArrow(u[0],u[t-1],y,i,o,l,t,e,s,b,C,v,_,!1,p,m)}else 2===l&&d.stripCls.createStrip(u[0],u[t-1],y,i,o,l,!1,v,_,void 0,p,m,b,C);for(let e=0;e<t;++e)u[e]=[];y=[],b=[],C=[],v=[],_=[],F=!1,N=!1}if(m!==g.chain&&u[0].length>0){let e="CA",n=[],r=[];if(isNaN(d.atoms[I].resi))n=[];else{let t=d.atoms[I].structure+"_"+d.atoms[I].chain+"_"+(parseInt(d.atoms[I].resi)-1).toString();d.firstAtomObjCls.getAtomCoordFromResi(t,e)}for(let e=0;!s&&e<t;++e)F?d.curveStripArrowCls.createCurveSubArrow(u[e],1,y,i,l,h,t,e,b,C,v,_,!0,n,r):N&&(q?d.curveCls.createCurveSub(u[e],1,y,i,l,h,!1,v,_,void 0,n,r):d.curveStripArrowCls.createCurveSubArrow(u[e],1,y,i,l,h,t,e,b,C,v,_,!1,n,r));if(s)if(F){let e=0,s=t-1;d.curveStripArrowCls.createStripArrow(u[0],u[t-1],y,i,o,l,t,e,s,b,C,v,_,!0,n,r)}else if(N)if(q)d.stripCls.createStrip(u[0],u[t-1],y,i,o,l,!1,v,_,void 0,n,r,b,C);else{let e=0,s=t-1;d.curveStripArrowCls.createStripArrow(u[0],u[t-1],y,i,o,l,t,e,s,b,C,v,_,!1,n,r)}for(let e=0;e<t;++e)u[e]=[];y=[],b=[],C=[],v=[],_=[],F=!1,N=!1}m=g.chain,g.resi,R=g.ss,k=g.ssend,I=g.serial,P=g.resi,L=D,A=S,M=g.coord,T=x}j=[],d.tubeCls.createTube(U,"CA",n,l),U={},u={}}getSSExpandedAtoms(e,t){let i,s,n,r,a,o,l,d,c=this.icn3d,h=c.icn3dui,p=0,u=Object.keys(e).length,m=h.hashUtilsCls.cloneHash(e);for(let f in e){if(i=e[f].structure+"_"+e[f].chain,s=e[f].resi,n=e[f],void 0===r&&(l=e[f]),i!==r&&void 0!==r||s!==a&&s!==parseInt(a)+1&&void 0!==a||p===u-1){i!==r&&void 0!==r||s!==a&&s!==parseInt(a)+1&&void 0!==a?d=o:p===u-1&&(d=n);let f=l.resi;if(!isNaN(l.resi)&&"coil"!==l.ss&&!l.ssbegin){for(let e=parseInt(l.resi)-1;e>0;--e){let t=l.structure+"_"+l.chain+"_"+e;if(!c.residues.hasOwnProperty(t))break;let i=c.firstAtomObjCls.getFirstCalphaAtomObj(c.residues[t]);if(i.ss===l.ss&&i.ssbegin){f=i.resi;break}}for(let e=f;e<l.resi;++e){let t=l.structure+"_"+l.chain+"_"+e;m=h.hashUtilsCls.unionHash(m,h.hashUtilsCls.hash2Atoms(c.residues[t],c.atoms))}}if(!isNaN(l.resi)&&3===c.pk&&1===t&&"coil"===l.ss&&"stick"!=l.style&&"ball and stick"!=l.style&&"lines"!=l.style&&"sphere"!=l.style&&"dot"!=l.style){let t=l.structure+"_"+l.chain+"_"+(parseInt(l.resi)-1).toString();c.residues.hasOwnProperty(t)&&(m=h.hashUtilsCls.unionHash(m,h.hashUtilsCls.hash2Atoms(c.residues[t],c.atoms)),e=h.hashUtilsCls.unionHash(e,h.hashUtilsCls.hash2Atoms(c.residues[t],c.atoms)))}let g=d.resi;if(void 0!==d.ss&&"coil"!==d.ss&&!d.ssend&&!d.notshow){let e=c.firstAtomObjCls.getLastAtomObj(c.chains[d.structure+"_"+d.chain]).resi;for(let t=parseInt(d.resi)+1;t<=parseInt(e);++t){let e=d.structure+"_"+d.chain+"_"+t;if(!c.residues.hasOwnProperty(e))break;let i=c.firstAtomObjCls.getFirstCalphaAtomObj(c.residues[e]);if(i.ss===d.ss&&i.ssend){g=i.resi;break}}for(let e=parseInt(d.resi)+1;e<=parseInt(g);++e){let t=d.structure+"_"+d.chain+"_"+e;m=h.hashUtilsCls.unionHash(m,h.hashUtilsCls.hash2Atoms(c.residues[t],c.atoms))}}if(3===c.pk&&1===t&&"coil"===d.ss&&"stick"!=l.style&&"ball and stick"!=l.style&&"lines"!=l.style&&"sphere"!=l.style&&"dot"!=l.style){let t=d.structure+"_"+d.chain+"_"+(parseInt(d.resi)+1).toString();c.residues.hasOwnProperty(t)&&(m=h.hashUtilsCls.unionHash(m,h.hashUtilsCls.hash2Atoms(c.residues[t],c.atoms)),e=h.hashUtilsCls.unionHash(e,h.hashUtilsCls.hash2Atoms(c.residues[t],c.atoms)))}d.notshow&&(d.notshow=void 0),l=n}r=i,a=s,o=n,++p}return m}}class Ac{constructor(e){this.icn3d=e}drawCartoonNucleicAcid(e,t,i,s){this.drawStrandNucleicAcid(e,2,t,!0,void 0,i,s)}drawStrandNucleicAcid(e,t,i,s,n,r,a){let o,l,d,c=this.icn3d;if(c.icn3dui.bNode)return;2===a&&(t=void 0,r=void 0),n=n||c.nucleicAcidWidth,i=i||c.axisDIV,t=t||c.nucleicAcidStrandDIV;let h=[];for(d=0;d<t;d++)h[d]=[];let p,u,m,f=[],g=null;for(o in e){let b=e[o];if(void 0===b)continue;let C=b.structure+"_"+b.chain,v=b.structure+"_"+p;if(("O3'"===b.name||"OP2"===b.name||"O3*"===b.name||"O2P"===b.name)&&!b.het)if("O3'"===b.name||"O3*"===b.name){if(p!==b.chain||c.ParserUtilsCls.getResiNCBI(v,u)+1!==c.ParserUtilsCls.getResiNCBI(C,b.resi)){if(m&&g)for(l=0;l<t;l++){let e=2/(t-1)*l-1;h[l].push(new mt(m.x+g.x*e,m.y+g.y*e,m.z+g.z*e))}for(s&&c.stripCls.createStrip(h[0],h[1],f,i,r,a),l=0;!r&&l<t;l++)c.curveCls.createCurveSub(h[l],1,f,i,a);for(h=[],d=0;d<t;d++)h[d]=[];f=[],g=null}m=new mt(b.coord.x,b.coord.y,b.coord.z),p=b.chain,u=b.resi,1===a||2===a?f.push(c.hColor):f.push(b.color)}else if("OP2"===b.name||"O2P"===b.name){if(!m){g=null;continue}let e=new mt(b.coord.x,b.coord.y,b.coord.z);for(e.sub(m),e.normalize().multiplyScalar(n),null!==g&&e.dot(g)<0&&e.negate(),g=e,l=0;l<t;l++){let e=2/(t-1)*l-1;h[l].push(new mt(m.x+g.x*e,m.y+g.y*e,m.z+g.z*e))}m=null}}if(m&&g)for(l=0;l<t;l++){let e=2/(t-1)*l-1;h[l].push(new mt(m.x+g.x*e,m.y+g.y*e,m.z+g.z*e))}for(s&&c.stripCls.createStrip(h[0],h[1],f,i,r,a),l=0;!r&&l<t;l++)c.curveCls.createCurveSub(h[l],1,f,i,a)}drawNucleicAcidStick(e,t){let i=this.icn3d;if(i.icn3dui.bNode)return;let s,n,r,a=null,o=null;for(r in e){let l=e[r];void 0===l||l.het||(l.resi===n&&l.chain===s||(null!==a&&null!==o&&i.cylinderCls.createCylinder(new mt(a.coord.x,a.coord.y,a.coord.z),new mt(o.coord.x,o.coord.y,o.coord.z),i.cylinderRadius,a.color,t),a=null,o=null),"O3'"!==l.name&&"O3*"!==l.name||(a=l),"A"===l.resn.trim()||"G"===l.resn.trim()||"DA"===l.resn.trim()||"DG"===l.resn.trim()?"N9"===l.name&&(o=l):"N1"===l.name&&(o=l),n=l.resi,s=l.chain)}null!==a&&null!==o&&i.cylinderCls.createCylinder(new mt(a.coord.x,a.coord.y,a.coord.z),new mt(o.coord.x,o.coord.y,o.coord.z),i.cylinderRadius,a.color,t)}}class Mc{constructor(e){this.icn3d=e}makeTextSprite(e,t){let i=this.icn3d,s=i.icn3dui;if(s.bNode)return;void 0===t&&(t={});let n,r,a,o=t.hasOwnProperty("fontface")?t.fontface:"Arial",l=t.hasOwnProperty("fontsize")?t.fontsize:18,d=t.hasOwnProperty("factor")?t.factor:1,c=t.hasOwnProperty("alpha")?t.alpha:1,h=!1,p=!1;t.hasOwnProperty("bSchematic")&&t.bSchematic&&(p=!0,h=!0,l=40),t.hasOwnProperty("backgroundColor")&&void 0!==t.backgroundColor?(n=s.utilsCls.hexToRgb(t.backgroundColor,c),r=t.hasOwnProperty("borderColor")?s.utilsCls.hexToRgb(t.borderColor,c):{r:0,g:0,b:0,a:1},a=t.hasOwnProperty("borderThickness")?t.borderThickness:4):(h=!1,n=void 0,r=void 0,a=0);let u="black"!=i.opts.background?{r:0,g:0,b:0,a:1}:{r:255,g:255,b:0,a:1},m=t.hasOwnProperty("textColor")&&void 0!==t.textColor?s.utilsCls.hexToRgb(t.textColor,1):u;m||(m=u);let f=document.createElement("canvas"),g=f.getContext("2d");g.font="Bold "+l+"px "+o;let b=g.measureText(e).width,C=b+2*a,v=l+2*a;p&&(C>v?v=C:C=v);let _=.8*b/v;if(f.width=C,f.height=v,g.clearRect(0,0,C,v),h)if(g.fillStyle="rgba("+n.r+","+n.g+","+n.b+","+n.a+")",g.strokeStyle="rgba("+r.r+","+r.g+","+r.b+","+r.a+")",g.lineWidth=a,p){let e=.4*C;this.circle(g,0,0,C,v,e)}else{let e=0;this.roundRect(g,0,0,C,v,e)}g.font="Bold "+l+"px "+o,g.textAlign="center",g.textBaseline="middle",g.fillStyle="rgba("+m.r+", "+m.g+", "+m.b+", 1.0)",g.strokeStyle="rgba("+m.r+", "+m.g+", "+m.b+", 1.0)",g.fillText(e,.5*C,.5*v);let y=new Nt(f);y.needsUpdate=!0;let S=new hn({map:y,depthTest:!1,depthWrite:!1});S.map.minFilter=B;let w=new An(S);return p?w.scale.set(.3*d,.3*d,1):w.scale.set(_*d,d,1),w.renderOrder=1,w}roundRect(e,t,i,s,n,r){e.beginPath(),e.moveTo(t+r,i),e.lineTo(t+s-r,i),e.quadraticCurveTo(t+s,i,t+s,i+r),e.lineTo(t+s,i+n-r),e.quadraticCurveTo(t+s,i+n,t+s-r,i+n),e.lineTo(t+r,i+n),e.quadraticCurveTo(t,i+n,t,i+n-r),e.lineTo(t,i+r),e.quadraticCurveTo(t,i,t+r,i),e.closePath(),e.fill(),e.stroke()}circle(e,t,i,s,n,r){e.beginPath(),e.arc(t+s/2,.9*(i+n/2),r,0,2*Math.PI,!0),e.closePath(),e.fill(),e.stroke()}}class Tc{constructor(e){this.icn3d=e,this.textSpriteCls=new Mc(e)}createLabelRepresentation(e){let t=this.icn3d;t.icn3dui;let i=t.oriMaxD/100;i<.4&&(i=.4);let s=3*i*t.labelScale;for(let i in e){let n=void 0!==e[i]?e[i]:[],r="black"!=t.opts.background?t.colorWhitebkgd:t.colorBlackbkgd;for(let e=0,a=n.length;e<a;++e){let a=n[e];0==a.size&&(a.size=void 0),0==a.color&&(a.color=void 0),0==a.background&&(a.background=void 0);let o=void 0!==a.size?a.size:t.LABELSIZE,l=void 0!==a.color?a.color:r;t.labelcolor&&(l=t.labelcolor);let d,c=void 0!==a.background?a.background:"#cccccc",h=void 0!==a.alpha?a.alpha:1;if(c=a.background,void 0!==l&&void 0!==c&&l.toLowerCase()===c.toString().toLowerCase()&&(l="#888888"),void 0!==a.bSchematic&&a.bSchematic)d=this.textSpriteCls.makeTextSprite(a.text,{fontsize:parseInt(o),textColor:l,borderColor:c,backgroundColor:c,alpha:h,bSchematic:1,factor:s});else if(1===a.text.length)d=this.textSpriteCls.makeTextSprite(a.text,{fontsize:parseInt(o),textColor:l,borderColor:c,backgroundColor:c,alpha:h,bSchematic:1,factor:s});else{let e=a.factor?s*a.factor:s;d=this.textSpriteCls.makeTextSprite(a.text,{fontsize:parseInt(o),textColor:l,borderColor:c,backgroundColor:c,alpha:h,bSchematic:0,factor:e})}let p="schematic"==i||"residue"==i?0:t.coilWidth;d.position.set(parseFloat(a.position.x)+p,parseFloat(a.position.y)+p,parseFloat(a.position.z)+p),t.mdl.add(d)}}}hideLabels(){let e=this.icn3d;if(e.icn3dui,void 0!==e.mdl)for(let t=0,i=e.mdl.children.length;t<i;++t){let i=e.mdl.children[t];void 0!==i&&"Sprite"===i.type&&e.mdl.remove(i)}}}class Ec{constructor(e){this.icn3d=e}buildAxes(e,t,i,s,n,r){let a=this.icn3d,o=a.icn3dui;if(o.bNode)return;new ji;let l=0,d=0,c=0;r?(l=t.x,d=t.y,c=t.z):(l-=.3*e,d-=.3*e);let h,p,u,m,f,g,b,C,v,_=new mt(l,d,c),y=e/10,S=e/100;m=f=g=y,r&&(h=i.clone().sub(t),p=s.clone().sub(t),u=n.clone().sub(t),m=h.length(),f=p.length(),g=u.length(),S=m/100,S<.4&&(S=.4)),r?(b=a.cylinderCls.createCylinder_base(t,i,S,o.parasCls.thr(16711680)),C=a.cylinderCls.createCylinder_base(t,s,S,o.parasCls.thr(65280)),v=a.cylinderCls.createCylinder_base(t,n,S,o.parasCls.thr(255))):(b=a.cylinderCls.createCylinder_base(new mt(l,d,c),new mt(l+m,d,c),S,o.parasCls.thr(16711680)),C=a.cylinderCls.createCylinder_base(new mt(l,d,c),new mt(l,d+f,c),S,o.parasCls.thr(65280)),v=a.cylinderCls.createCylinder_base(new mt(l,d,c),new mt(l,d,c+g),S,o.parasCls.thr(255))),a.mdl.add(b),a.mdl.add(C),a.mdl.add(v);let w=r?h.normalize():new mt(1,0,0),x=r?i:new mt(_.x+y,_.y,_.z),A=this.createArrow(w,x,m,16711680,4*S,4*S);a.mdl.add(A);let M=r?p.normalize():new mt(0,1,0),T=r?s:new mt(_.x,_.y+y,_.z),E=this.createArrow(M,T,f,65280,4*S,4*S);a.mdl.add(E);let R=r?u.normalize():new mt(0,0,1),k=r?n:new mt(_.x,_.y,_.z+y),O=this.createArrow(R,k,g,255,4*S,4*S);a.mdl.add(O)}buildAllAxes(e,t){let i=this.icn3d;if(!i.icn3dui.bNode&&i.pc1)for(let s=0,n=i.axes.length;s<n;++s){let n=i.axes[s][0],r=i.axes[s][1],a=i.axes[s][2],o=i.axes[s][3];this.buildAxes(e,n,r,a,o,t)}}createArrow(e,t,i,s,n,r,a){let o=this.icn3d;if(o.icn3dui.bNode)return;let l,d=new Kn(0,.5,1,32,1);d.translate(0,.5,0),l=new gr(a?{transparent:!0,opacity:.5,specular:o.frac,shininess:o.shininess,emissive:o.emissive,color:s}:{specular:o.frac,shininess:o.shininess,emissive:o.emissive,side:2,color:s});let c=new Hs(d,l),h=new ut;if(e.y>.99999)h.set(0,0,0,1);else if(e.y<-.99999)h.set(1,0,0,0);else{let t=new mt;t.set(e.z,0,-e.x).normalize();let i=Math.acos(e.y);h.setFromAxisAngle(t,i)}return c.applyQuaternion(h),c.scale.set(r,n,r),c.position.copy(t),c}setPc1Axes(e){let t=this.icn3d,i=t.icn3dui;if(i.bNode)return;let s=i.hashUtilsCls.intHash(t.hAtoms,t.dAtoms),n=[],r=Object.keys(s).length<100;for(let e in s){let i=t.atoms[e],s=i.structure+"_"+i.chain+"_"+i.resi;(r||""!=s)&&n.push(i.coord.clone())}let a=i.rmsdSuprCls.getEigenForSelection(n,n.length),o=new mt(a.h1[0],a.h1[1],a.h1[2]);if(0==a.k&&t.bRender)return void alert("Can't determine the first principal component. Please select a subset and try it again.");let l=t.applyCenterCls.centerAtoms(s),d=l.maxD,c=l.center,h=c.clone().add(o.normalize().multiplyScalar(.4*d)),p=o.normalize();if(i.htmlCls.clickMenuCls.setLogCmd("Principle X-Axis: "+p.x.toFixed(3)+" "+p.y.toFixed(3)+" "+p.z.toFixed(3),!1),e)return p;let u=new mt(a.h2[0],a.h2[1],a.h2[2]),m=c.clone().add(u.normalize().multiplyScalar(.3*d)),f=new mt(a.h3[0],a.h3[1],a.h3[2]),g=c.clone().add(f.normalize().multiplyScalar(.3*d));this.buildAxes(void 0,c,h,m,g,!0);let b=[c,h,m,g];return t.axes.push(b),t.drawCls.draw(),b}}class Rc{constructor(e){this.icn3d=e}showGlycans(){let e=this.icn3d,t=e.icn3dui;if(t.bNode)return;let i={},s=e.dAtoms;for(let n in s){let s=e.atoms[n];s.het&&-1!=t.parasCls.glycanHash.hasOwnProperty(s.resn)&&(void 0===i[s.resn]&&(i[s.resn]={}),"Misc"!=s.chain&&(i[s.resn][s.structure+"_"+s.chain+"_"+s.resi]=1))}let n=Object.keys(i);for(let s=0,r=n.length;s<r;++s){let r=n[s];if(!t.parasCls.glycanHash.hasOwnProperty(r))continue;let a=t.parasCls.glycanHash[r].s,o=new ls("#"+t.parasCls.glycanHash[r].c),l=Object.keys(i[r]);for(let t=0,i=l.length;t<i;++t){let i=e.applyCenterCls.centerAtoms(e.residues[l[t]]),s=i.center,n=.5*i.maxD*.6;if("cube"==a)e.boxCls.createBox_base(s,n,o,!1,!1,!0);else if("sphere"==a)e.sphereCls.createSphereBase(s,o,n,1,!1,!0);else if("cone"==a){let t=new mt(0,0,1),i=e.axesCls.createArrow(t,new mt(0,0,-1*n).add(s),0,o,2*n,2*n,!0);e.mdl.add(i),e.objects.push(i)}else if("cylinder"==a){let t=new mt(0,0,n).add(s),i=new mt(0,0,-1*n).add(s);e.cylinderCls.createCylinder(t,i,n,o,!1,o,!1,!0)}}}}}class kc{constructor(e){this.icn3d=e,this.ISDONE=2;this.edgeTable=new Uint32Array([0,0,0,0,0,0,0,2816,0,0,0,1792,0,3328,3584,3840,0,0,0,138,0,21,0,134,0,0,0,652,0,2067,3865,3600,0,0,0,42,0,0,0,294,0,0,21,28,0,3875,1049,3360,0,168,162,170,0,645,2475,2210,0,687,293,172,4010,3747,3497,3232,0,0,0,0,0,69,0,900,0,0,0,1792,138,131,1608,1920,0,81,0,2074,84,85,84,86,0,81,0,3676,330,1105,1881,1616,0,0,0,42,0,69,0,502,0,0,21,3580,138,2035,1273,1520,2816,104,2337,106,840,581,367,102,2816,3695,3429,3180,1898,1635,1385,1120,0,0,0,0,0,0,0,3910,0,0,69,588,42,2083,41,2880,0,0,0,1722,0,2293,4095,3830,0,255,757,764,2538,2291,3065,2800,0,0,81,338,0,3925,1119,3414,84,855,85,340,2130,2899,89,2384,1792,712,194,1162,4036,3781,3535,3270,708,719,197,204,3018,2755,2505,2240,0,0,0,0,168,420,168,1958,162,162,676,2988,170,163,680,928,3328,3096,3328,3642,52,53,1855,1590,2340,2111,2869,2620,298,51,825,560,3584,3584,3090,3482,1668,1941,1183,1430,146,2975,2069,2460,154,915,153,400,3840,3592,3329,3082,1796,1541,1295,1030,2818,2575,2309,2060,778,515,265,0]),this.triTable=[[],[],[],[],[],[],[],[11,9,8],[],[],[],[8,10,9],[],[10,8,11],[9,11,10],[8,10,9,8,11,10],[],[],[],[1,7,3],[],[4,2,0],[],[2,1,7],[],[],[],[2,7,3,2,9,7],[],[1,4,11,1,0,4],[3,8,0,11,9,4,11,10,9],[4,11,9,11,10,9],[],[],[],[5,3,1],[],[],[],[2,5,8,2,1,5],[],[],[2,4,0],[3,2,4],[],[0,9,1,8,10,5,8,11,10],[3,4,0,3,10,4],[5,8,10,8,11,10],[],[3,5,7],[7,1,5],[1,7,3,1,5,7],[],[9,2,0,9,7,2],[0,3,8,1,7,11,1,5,7],[11,1,7,1,5,7],[],[9,1,0,5,3,2,5,7,3],[8,2,5,8,0,2],[2,5,3,5,7,3],[3,9,1,3,8,9,7,11,10,7,10,5],[9,1,0,10,7,11,10,5,7],[3,8,0,7,10,5,7,11,10],[11,5,7,11,10,5],[],[],[],[],[],[0,6,2],[],[7,2,9,7,9,8],[],[],[],[8,10,9],[7,1,3],[7,1,0],[6,9,3,6,10,9],[7,10,8,10,9,8],[],[6,0,4],[],[11,1,4,11,3,1],[2,4,6],[2,0,4,2,4,6],[2,4,6],[1,4,2,4,6,2],[],[6,0,4],[],[2,11,3,6,9,4,6,10,9],[8,6,1,8,1,3],[10,0,6,0,4,6],[8,0,3,9,6,10,9,4,6],[10,4,6,10,9,4],[],[],[],[5,3,1],[],[0,6,2],[],[7,4,8,5,2,1,5,6,2],[],[],[2,4,0],[7,4,8,2,11,3,10,5,6],[7,1,3],[5,6,10,0,9,1,8,7,4],[5,6,10,7,0,3,7,4,0],[10,5,6,4,8,7],[9,11,8],[3,5,6],[0,5,11,0,11,8],[6,3,5,3,1,5],[3,9,6,3,8,9],[9,6,0,6,2,0],[0,3,8,2,5,6,2,1,5],[1,6,2,1,5,6],[9,11,8],[1,0,9,6,10,5,11,3,2],[6,10,5,2,8,0,2,11,8],[3,2,11,10,5,6],[10,5,6,9,3,8,9,1,3],[0,9,1,5,6,10],[8,0,3,10,5,6],[10,5,6],[],[],[],[],[],[],[],[1,10,2,9,11,6,9,8,11],[],[],[6,0,2],[3,6,9,3,2,6],[3,5,1],[0,5,1,0,11,5],[0,3,5],[6,9,11,9,8,11],[],[],[],[4,5,9,7,1,10,7,3,1],[],[11,6,7,2,4,5,2,0,4],[11,6,7,8,0,3,1,10,2,9,4,5],[6,7,11,1,10,2,9,4,5],[],[4,1,0,4,5,1,6,7,3,6,3,2],[9,4,5,0,6,7,0,2,6],[4,5,9,6,3,2,6,7,3],[6,7,11,5,3,8,5,1,3],[6,7,11,4,1,0,4,5,1],[4,5,9,3,8,0,11,6,7],[9,4,5,7,11,6],[],[],[0,6,4],[8,6,4,8,1,6],[],[0,10,2,0,9,10,4,8,11,4,11,6],[10,2,1,6,0,3,6,4,0],[10,2,1,11,4,8,11,6,4],[4,2,6],[1,0,9,2,4,8,2,6,4],[2,4,0,2,6,4],[8,2,4,2,6,4],[11,4,1,11,6,4],[0,9,1,4,11,6,4,8,11],[3,6,0,6,4,0],[8,6,4,8,11,6],[10,8,9],[6,3,9,6,7,3],[6,7,1],[10,7,1,7,3,1],[7,11,6,8,10,2,8,9,10],[11,6,7,10,0,9,10,2,0],[2,1,10,7,11,6,8,0,3],[1,10,2,6,7,11],[7,2,6,7,9,2],[1,0,9,3,6,7,3,2,6],[7,0,6,0,2,6],[2,7,3,2,6,7],[7,11,6,3,9,1,3,8,9],[9,1,0,11,6,7],[0,3,8,11,6,7],[11,6,7],[],[],[],[],[5,3,7],[8,5,2,8,7,5],[5,3,7],[1,10,2,5,8,7,5,9,8],[1,7,5],[1,7,5],[9,2,7,9,7,5],[11,3,2,8,5,9,8,7,5],[1,3,7,1,7,5],[0,7,1,7,5,1],[9,3,5,3,7,5],[9,7,5,9,8,7],[8,10,11],[3,4,10,3,10,11],[8,10,11],[5,9,4,1,11,3,1,10,11],[2,4,5],[5,2,4,2,0,4],[0,3,8,5,9,4,10,2,1],[2,1,10,9,4,5],[2,8,5,2,11,8],[3,2,11,1,4,5,1,0,4],[9,4,5,8,2,11,8,0,2],[11,3,2,9,4,5],[8,5,3,5,1,3],[5,0,4,5,1,0],[3,8,0,4,5,9],[9,4,5],[11,9,10],[11,9,10],[1,11,4,1,10,11],[8,7,4,11,1,10,11,3,1],[2,7,9,2,9,10],[4,8,7,0,10,2,0,9,10],[2,1,10,0,7,4,0,3,7],[10,2,1,8,7,4],[1,7,4],[3,2,11,4,8,7,9,1,0],[11,4,2,4,0,2],[2,11,3,7,4,8],[4,1,7,1,3,7],[1,0,9,8,7,4],[3,4,0,3,7,4],[8,7,4],[8,9,10,8,10,11],[3,9,11,9,10,11],[0,10,8,10,11,8],[10,3,1,10,11,3],[2,8,10,8,9,10],[9,2,0,9,10,2],[8,0,3,1,10,2],[10,2,1],[1,11,9,11,8,9],[11,3,2,0,9,1],[11,0,2,11,8,0],[11,3,2],[8,1,3,8,9,1],[9,1,0],[8,0,3],[]],this.edgeTable2=[0,265,515,778,2060,2309,2575,2822,1030,1295,1541,1804,3082,3331,3593,3840,400,153,915,666,2460,2197,2975,2710,1430,1183,1941,1692,3482,3219,3993,3728,560,825,51,314,2620,2869,2111,2358,1590,1855,1077,1340,3642,3891,3129,3376,928,681,419,170,2988,2725,2479,2214,1958,1711,1445,1196,4010,3747,3497,3232,2240,2505,2755,3018,204,453,719,966,3270,3535,3781,4044,1226,1475,1737,1984,2384,2137,2899,2650,348,85,863,598,3414,3167,3925,3676,1370,1107,1881,1616,2800,3065,2291,2554,764,1013,255,502,3830,4095,3317,3580,1786,2035,1273,1520,2912,2665,2403,2154,876,613,367,102,3942,3695,3429,3180,1898,1635,1385,1120,1120,1385,1635,1898,3180,3429,3695,3942,102,367,613,876,2154,2403,2665,2912,1520,1273,2035,1786,3580,3317,4095,3830,502,255,1013,764,2554,2291,3065,2800,1616,1881,1107,1370,3676,3925,3167,3414,598,863,85,348,2650,2899,2137,2384,1984,1737,1475,1226,4044,3781,3535,3270,966,719,453,204,3018,2755,2505,2240,3232,3497,3747,4010,1196,1445,1711,1958,2214,2479,2725,2988,170,419,681,928,3376,3129,3891,3642,1340,1077,1855,1590,2358,2111,2869,2620,314,51,825,560,3728,3993,3219,3482,1692,1941,1183,1430,2710,2975,2197,2460,666,915,153,400,3840,3593,3331,3082,1804,1541,1295,1030,2822,2575,2309,2060,778,515,265,0],this.triTable2=[[],[8,3,0],[9,0,1],[8,3,1,8,1,9],[11,2,3],[11,2,0,11,0,8],[11,2,3,0,1,9],[2,1,11,1,9,11,11,9,8],[10,1,2],[8,3,0,1,2,10],[9,0,2,9,2,10],[3,2,8,2,10,8,8,10,9],[10,1,3,10,3,11],[1,0,10,0,8,10,10,8,11],[0,3,9,3,11,9,9,11,10],[8,10,9,8,11,10],[8,4,7],[3,0,4,3,4,7],[1,9,0,8,4,7],[9,4,1,4,7,1,1,7,3],[2,3,11,7,8,4],[7,11,4,11,2,4,4,2,0],[3,11,2,4,7,8,9,0,1],[2,7,11,2,1,7,1,4,7,1,9,4],[10,1,2,8,4,7],[2,10,1,0,4,7,0,7,3],[4,7,8,0,2,10,0,10,9],[2,7,3,2,9,7,7,9,4,2,10,9],[8,4,7,11,10,1,11,1,3],[11,4,7,1,4,11,1,11,10,1,0,4],[3,8,0,7,11,4,11,9,4,11,10,9],[7,11,4,4,11,9,11,10,9],[9,5,4],[3,0,8,4,9,5],[5,4,0,5,0,1],[4,8,5,8,3,5,5,3,1],[11,2,3,9,5,4],[9,5,4,8,11,2,8,2,0],[3,11,2,1,5,4,1,4,0],[8,5,4,2,5,8,2,8,11,2,1,5],[2,10,1,9,5,4],[0,8,3,5,4,9,10,1,2],[10,5,2,5,4,2,2,4,0],[3,4,8,3,2,4,2,5,4,2,10,5],[5,4,9,1,3,11,1,11,10],[0,9,1,4,8,5,8,10,5,8,11,10],[3,4,0,3,10,4,4,10,5,3,11,10],[4,8,5,5,8,10,8,11,10],[9,5,7,9,7,8],[0,9,3,9,5,3,3,5,7],[8,0,7,0,1,7,7,1,5],[1,7,3,1,5,7],[11,2,3,8,9,5,8,5,7],[9,2,0,9,7,2,2,7,11,9,5,7],[0,3,8,2,1,11,1,7,11,1,5,7],[2,1,11,11,1,7,1,5,7],[1,2,10,5,7,8,5,8,9],[9,1,0,10,5,2,5,3,2,5,7,3],[5,2,10,8,2,5,8,5,7,8,0,2],[10,5,2,2,5,3,5,7,3],[3,9,1,3,8,9,7,11,10,7,10,5],[9,1,0,10,7,11,10,5,7],[3,8,0,7,10,5,7,11,10],[11,5,7,11,10,5],[11,7,6],[0,8,3,11,7,6],[9,0,1,11,7,6],[7,6,11,3,1,9,3,9,8],[2,3,7,2,7,6],[8,7,0,7,6,0,0,6,2],[1,9,0,3,7,6,3,6,2],[7,6,2,7,2,9,2,1,9,7,9,8],[1,2,10,6,11,7],[2,10,1,7,6,11,8,3,0],[11,7,6,10,9,0,10,0,2],[7,6,11,3,2,8,8,2,10,8,10,9],[6,10,7,10,1,7,7,1,3],[6,10,1,6,1,7,7,1,0,7,0,8],[9,0,3,6,9,3,6,10,9,6,3,7],[6,10,7,7,10,8,10,9,8],[8,4,6,8,6,11],[11,3,6,3,0,6,6,0,4],[0,1,9,4,6,11,4,11,8],[1,9,4,11,1,4,11,3,1,11,4,6],[3,8,2,8,4,2,2,4,6],[2,0,4,2,4,6],[1,9,0,3,8,2,2,8,4,2,4,6],[9,4,1,1,4,2,4,6,2],[10,1,2,11,8,4,11,4,6],[10,1,2,11,3,6,6,3,0,6,0,4],[0,2,10,0,10,9,4,11,8,4,6,11],[2,11,3,6,9,4,6,10,9],[8,4,6,8,6,1,6,10,1,8,1,3],[1,0,10,10,0,6,0,4,6],[8,0,3,9,6,10,9,4,6],[10,4,6,10,9,4],[9,5,4,7,6,11],[4,9,5,3,0,8,11,7,6],[6,11,7,4,0,1,4,1,5],[6,11,7,4,8,5,5,8,3,5,3,1],[4,9,5,6,2,3,6,3,7],[9,5,4,8,7,0,0,7,6,0,6,2],[4,0,1,4,1,5,6,3,7,6,2,3],[7,4,8,5,2,1,5,6,2],[6,11,7,1,2,10,9,5,4],[11,7,6,8,3,0,1,2,10,9,5,4],[11,7,6,10,5,2,2,5,4,2,4,0],[7,4,8,2,11,3,10,5,6],[4,9,5,6,10,7,7,10,1,7,1,3],[5,6,10,0,9,1,8,7,4],[5,6,10,7,0,3,7,4,0],[10,5,6,4,8,7],[5,6,9,6,11,9,9,11,8],[0,9,5,0,5,3,3,5,6,3,6,11],[0,1,5,0,5,11,5,6,11,0,11,8],[11,3,6,6,3,5,3,1,5],[9,5,6,3,9,6,3,8,9,3,6,2],[5,6,9,9,6,0,6,2,0],[0,3,8,2,5,6,2,1,5],[1,6,2,1,5,6],[1,2,10,5,6,9,9,6,11,9,11,8],[1,0,9,6,10,5,11,3,2],[6,10,5,2,8,0,2,11,8],[3,2,11,10,5,6],[10,5,6,9,3,8,9,1,3],[0,9,1,5,6,10],[8,0,3,10,5,6],[10,5,6],[10,6,5],[8,3,0,10,6,5],[0,1,9,5,10,6],[10,6,5,9,8,3,9,3,1],[3,11,2,10,6,5],[6,5,10,2,0,8,2,8,11],[1,9,0,6,5,10,11,2,3],[1,10,2,5,9,6,9,11,6,9,8,11],[1,2,6,1,6,5],[0,8,3,2,6,5,2,5,1],[5,9,6,9,0,6,6,0,2],[9,6,5,3,6,9,3,9,8,3,2,6],[11,6,3,6,5,3,3,5,1],[0,5,1,0,11,5,5,11,6,0,8,11],[0,5,9,0,3,5,3,6,5,3,11,6],[5,9,6,6,9,11,9,8,11],[10,6,5,4,7,8],[5,10,6,7,3,0,7,0,4],[5,10,6,0,1,9,8,4,7],[4,5,9,6,7,10,7,1,10,7,3,1],[7,8,4,2,3,11,10,6,5],[11,6,7,10,2,5,2,4,5,2,0,4],[11,6,7,8,0,3,1,10,2,9,4,5],[6,7,11,1,10,2,9,4,5],[7,8,4,5,1,2,5,2,6],[4,1,0,4,5,1,6,7,3,6,3,2],[9,4,5,8,0,7,0,6,7,0,2,6],[4,5,9,6,3,2,6,7,3],[6,7,11,4,5,8,5,3,8,5,1,3],[6,7,11,4,1,0,4,5,1],[4,5,9,3,8,0,11,6,7],[9,4,5,7,11,6],[10,6,4,10,4,9],[8,3,0,9,10,6,9,6,4],[1,10,0,10,6,0,0,6,4],[8,6,4,8,1,6,6,1,10,8,3,1],[2,3,11,6,4,9,6,9,10],[0,10,2,0,9,10,4,8,11,4,11,6],[10,2,1,11,6,3,6,0,3,6,4,0],[10,2,1,11,4,8,11,6,4],[9,1,4,1,2,4,4,2,6],[1,0,9,3,2,8,2,4,8,2,6,4],[2,4,0,2,6,4],[3,2,8,8,2,4,2,6,4],[1,4,9,11,4,1,11,1,3,11,6,4],[0,9,1,4,11,6,4,8,11],[11,6,3,3,6,0,6,4,0],[8,6,4,8,11,6],[6,7,10,7,8,10,10,8,9],[9,3,0,6,3,9,6,9,10,6,7,3],[6,1,10,6,7,1,7,0,1,7,8,0],[6,7,10,10,7,1,7,3,1],[7,11,6,3,8,2,8,10,2,8,9,10],[11,6,7,10,0,9,10,2,0],[2,1,10,7,11,6,8,0,3],[1,10,2,6,7,11],[7,2,6,7,9,2,2,9,1,7,8,9],[1,0,9,3,6,7,3,2,6],[8,0,7,7,0,6,0,2,6],[2,7,3,2,6,7],[7,11,6,3,9,1,3,8,9],[9,1,0,11,6,7],[0,3,8,11,6,7],[11,6,7],[11,7,5,11,5,10],[3,0,8,7,5,10,7,10,11],[9,0,1,10,11,7,10,7,5],[3,1,9,3,9,8,7,10,11,7,5,10],[10,2,5,2,3,5,5,3,7],[5,10,2,8,5,2,8,7,5,8,2,0],[9,0,1,10,2,5,5,2,3,5,3,7],[1,10,2,5,8,7,5,9,8],[2,11,1,11,7,1,1,7,5],[0,8,3,2,11,1,1,11,7,1,7,5],[9,0,2,9,2,7,2,11,7,9,7,5],[11,3,2,8,5,9,8,7,5],[1,3,7,1,7,5],[8,7,0,0,7,1,7,5,1],[0,3,9,9,3,5,3,7,5],[9,7,5,9,8,7],[4,5,8,5,10,8,8,10,11],[3,0,4,3,4,10,4,5,10,3,10,11],[0,1,9,4,5,8,8,5,10,8,10,11],[5,9,4,1,11,3,1,10,11],[3,8,4,3,4,2,2,4,5,2,5,10],[10,2,5,5,2,4,2,0,4],[0,3,8,5,9,4,10,2,1],[2,1,10,9,4,5],[8,4,5,2,8,5,2,11,8,2,5,1],[3,2,11,1,4,5,1,0,4],[9,4,5,8,2,11,8,0,2],[11,3,2,9,4,5],[4,5,8,8,5,3,5,1,3],[5,0,4,5,1,0],[3,8,0,4,5,9],[9,4,5],[7,4,11,4,9,11,11,9,10],[3,0,8,7,4,11,11,4,9,11,9,10],[11,7,4,1,11,4,1,10,11,1,4,0],[8,7,4,11,1,10,11,3,1],[2,3,7,2,7,9,7,4,9,2,9,10],[4,8,7,0,10,2,0,9,10],[2,1,10,0,7,4,0,3,7],[10,2,1,8,7,4],[2,11,7,2,7,1,1,7,4,1,4,9],[3,2,11,4,8,7,9,1,0],[7,4,11,11,4,2,4,0,2],[2,11,3,7,4,8],[9,1,4,4,1,7,1,3,7],[1,0,9,8,7,4],[3,4,0,3,7,4],[8,7,4],[8,9,10,8,10,11],[0,9,3,3,9,11,9,10,11],[1,10,0,0,10,8,10,11,8],[10,3,1,10,11,3],[3,8,2,2,8,10,8,9,10],[9,2,0,9,10,2],[8,0,3,1,10,2],[10,2,1],[2,11,1,1,11,9,11,8,9],[11,3,2,0,9,1],[11,0,2,11,8,0],[11,3,2],[8,1,3,8,9,1],[9,1,0],[8,0,3],[]]}}kc.prototype.march=function(e,t,i,s){let n=!!s.fulltable,r=s.hasOwnProperty("origin")&&s.origin.hasOwnProperty("x")?s.origin:{x:0,y:0,z:0},a=!!s.voxel,o=s.matrix,l=s.nX||0,d=s.nY||0,c=s.nZ||0,h=s.scale||1,p=null;p=s.unitCube?s.unitCube:{x:h,y:h,z:h};let u,m,f=new Int32Array(l*d*c);for(u=0,m=f.length;u<m;++u)f[u]=-1;let g=function(e,i,s,n,l,h){let u={x:0,y:0,z:0},m=l;!!!(n&1<<l)&&!!(n&1<<h)&&(m=h),1&m&&s++,2&m&&i++,4&m&&e++,o?(u=new mt(e,i,s),u=u.applyMatrix4(o),u={x:u.x,y:u.y,z:u.z}):(u.x=r.x+p.x*e,u.y=r.y+p.y*i,u.z=r.z+p.z*s);let g=(d*e+i)*c+s;return a?(t.push(u),t.length-1):(f[g]<0&&(f[g]=t.length,t.push(u)),f[g])},b=new Int32Array(12),C=n?this.edgeTable2:this.edgeTable,v=n?this.triTable2:this.triTable;for(u=0;u<l-1;++u)for(let s=0;s<d-1;++s)for(let n=0;n<c-1;++n){let r=0;for(let t=0;t<8;++t){r|=!!(e[(d*(u+((4&t)>>2))+s+((2&t)>>1))*c+n+(1&t)]&this.ISDONE)<<t}if(0===r||255===r)continue;let o=C[r];if(0===o)continue;let l=v[r];1&o&&(b[0]=g(u,s,n,r,0,1)),2&o&&(b[1]=g(u,s,n,r,1,3)),4&o&&(b[2]=g(u,s,n,r,3,2)),8&o&&(b[3]=g(u,s,n,r,2,0)),16&o&&(b[4]=g(u,s,n,r,4,5)),32&o&&(b[5]=g(u,s,n,r,5,7)),64&o&&(b[6]=g(u,s,n,r,7,6)),128&o&&(b[7]=g(u,s,n,r,6,4)),256&o&&(b[8]=g(u,s,n,r,0,4)),512&o&&(b[9]=g(u,s,n,r,1,5)),1024&o&&(b[10]=g(u,s,n,r,3,7)),2048&o&&(b[11]=g(u,s,n,r,2,6));for(let e=0;e<l.length;e+=3){let s=b[l[e]],n=b[l[e+1]],r=b[l[e+2]];a&&e>=3&&(t.push(t[s]),s=t.length-1,t.push(t[n]),n=t.length-1,t.push(t[r]),r=t.length-1),i.push(s),i.push(n),i.push(r)}}},kc.prototype.laplacianSmooth=function(e,t,i){let s,n,r,a,o,l=new Array(t.length);for(s=0,n=t.length;s<n;s++)l[s]={x:0,y:0,z:0};let d,c=new Array(20);for(s=0;s<20;s++)c[s]=new Array(t.length);for(s=0,n=t.length;s<n;s++)c[0][s]=0;for(s=0,n=i.length/3;s<n;s++){let e=3*s,t=3*s+1,n=3*s+2;for(d=!0,r=0,a=c[0][i[e]];r<a;r++)if(i[t]==c[r+1][i[e]]){d=!1;break}for(d&&(c[0][i[e]]++,c[c[0][i[e]]][i[e]]=i[t]),d=!0,r=0,a=c[0][i[e]];r<a;r++)if(i[n]==c[r+1][i[e]]){d=!1;break}for(d&&(c[0][i[e]]++,c[c[0][i[e]]][i[e]]=i[n]),d=!0,r=0,a=c[0][i[t]];r<a;r++)if(i[e]==c[r+1][i[t]]){d=!1;break}for(d&&(c[0][i[t]]++,c[c[0][i[t]]][i[t]]=i[e]),d=!0,r=0,a=c[0][i[t]];r<a;r++)if(i[n]==c[r+1][i[t]]){d=!1;break}for(d&&(c[0][i[t]]++,c[c[0][i[t]]][i[t]]=i[n]),d=!0,r=0;r<c[0][i[n]];r++)if(i[e]==c[r+1][i[n]]){d=!1;break}for(d&&(c[0][i[n]]++,c[c[0][i[n]]][i[n]]=i[e]),d=!0,r=0,a=c[0][i[n]];r<a;r++)if(i[t]==c[r+1][i[n]]){d=!1;break}d&&(c[0][i[n]]++,c[c[0][i[n]]][i[n]]=i[t])}let h=.5;for(o=0;o<e;o++){for(s=0,n=t.length;s<n;s++)if(c[0][s]<3)l[s].x=t[s].x,l[s].y=t[s].y,l[s].z=t[s].z;else if(3==c[0][s]||4==c[0][s]){for(l[s].x=0,l[s].y=0,l[s].z=0,r=0,a=c[0][s];r<a;r++)l[s].x+=t[c[r+1][s]].x,l[s].y+=t[c[r+1][s]].y,l[s].z+=t[c[r+1][s]].z;l[s].x+=h*t[s].x,l[s].y+=h*t[s].y,l[s].z+=h*t[s].z,l[s].x/=h+c[0][s],l[s].y/=h+c[0][s],l[s].z/=h+c[0][s]}else{for(l[s].x=0,l[s].y=0,l[s].z=0,r=0,a=c[0][s];r<a;r++)l[s].x+=t[c[r+1][s]].x,l[s].y+=t[c[r+1][s]].y,l[s].z+=t[c[r+1][s]].z;l[s].x+=1*t[s].x,l[s].y+=1*t[s].y,l[s].z+=1*t[s].z,l[s].x/=1+c[0][s],l[s].y/=1+c[0][s],l[s].z/=1+c[0][s]}for(s=0,n=t.length;s<n;s++)t[s].x=l[s].x,t[s].y=l[s].y,t[s].z=l[s].z}};class Oc{constructor(e,t){this.icn3d=e,this.threshbox=t,this.dataArray={},this.header,this.data=void 0,this.matrix=void 0,this.isovalue=void 0,this.loadPhiFrom=void 0,this.vpColor=null,this.vpPot=null,this.INOUT=1,this.ISDONE=2,this.ISBOUND=4,this.ptranx=0,this.ptrany=0,this.ptranz=0,this.probeRadius=1.4,this.defaultScaleFactor=2,this.scaleFactor=this.defaultScaleFactor,this.finalScaleFactor={},this.pHeight=0,this.pWidth=0,this.pLength=0,this.cutRadius=0,this.vpBits=null,this.vpDistance=null,this.vpAtomID=null,this.vertnumber=0,this.facenumber=0,this.pminx=0,this.pminy=0,this.pminz=0,this.pmaxx=0,this.pmaxy=0,this.pmaxz=0,this.bCalcArea=!1,this.atomsToShow={},this.vdwRadii={H:1.2,LI:1.82,Na:2.27,K:2.75,C:1.7,N:1.55,O:1.52,F:1.47,P:1.8,S:1.8,CL:1.75,BR:1.85,SE:1.9,ZN:1.39,CU:1.4,NI:1.63,X:2},this.depty={},this.widxz={},this.faces=void 0,this.verts=void 0,this.nb=[new Int32Array([1,0,0]),new Int32Array([-1,0,0]),new Int32Array([0,1,0]),new Int32Array([0,-1,0]),new Int32Array([0,0,1]),new Int32Array([0,0,-1]),new Int32Array([1,1,0]),new Int32Array([1,-1,0]),new Int32Array([-1,1,0]),new Int32Array([-1,-1,0]),new Int32Array([1,0,1]),new Int32Array([1,0,-1]),new Int32Array([-1,0,1]),new Int32Array([-1,0,-1]),new Int32Array([0,1,1]),new Int32Array([0,1,-1]),new Int32Array([0,-1,1]),new Int32Array([0,-1,-1]),new Int32Array([1,1,1]),new Int32Array([1,1,-1]),new Int32Array([1,-1,1]),new Int32Array([-1,1,1]),new Int32Array([1,-1,-1]),new Int32Array([-1,-1,1]),new Int32Array([-1,1,-1]),new Int32Array([-1,-1,-1])],this.origextent=void 0,this.marchingCube=new kc}}Oc.prototype.getVDWIndex=function(e){return e.elem&&void 0!==this.vdwRadii[e.elem.toUpperCase()]?e.elem:"X"},Oc.prototype.inOrigExtent=function(e,t,i){return!(e<this.origextent[0][0]||e>this.origextent[1][0])&&(!(t<this.origextent[0][1]||t>this.origextent[1][1])&&!(i<this.origextent[0][2]||i>this.origextent[1][2]))},Oc.prototype.getFacesAndVertices=function(){let e,t,i=this.verts;for(e=0,t=i.length;e<t;e++)i[e].x=i[e].x/this.scaleFactor-this.ptranx,i[e].y=i[e].y/this.scaleFactor-this.ptrany,i[e].z=i[e].z/this.scaleFactor-this.ptranz;let s=[];for(e=0,t=this.faces.length;e<t;e+=3){let t=this.faces[e],n=this.faces[e+1],r=this.faces[e+2],a=i[t].atomid,o=i[n].atomid,l=i[r].atomid;this.atomsToShow[a]&&this.atomsToShow[o]&&this.atomsToShow[l]&&(t!==n&&n!==r&&t!==r&&s.push({a:t,b:n,c:r}))}return this.vpBits=null,this.vpDistance=null,this.vpAtomID=null,this.vpColor=null,this.vpPot=null,{vertices:i,faces:s}},Oc.prototype.initparm=function(e,t,i,s,n,r,a,o,l){this.header=n,this.dataArray=r,this.matrix=a,this.isovalue=o,this.loadPhiFrom=l,this.bCalcArea=i;for(let e=0,t=s.length;e<t;e++)this.atomsToShow[s[e]]=1;let d=1/this.scaleFactor*5.5;this.origextent=e,this.pminx=e[0][0],this.pmaxx=e[1][0],this.pminy=e[0][1],this.pmaxy=e[1][1],this.pminz=e[0][2],this.pmaxz=e[1][2],t?(this.pminx-=this.probeRadius+d,this.pminy-=this.probeRadius+d,this.pminz-=this.probeRadius+d,this.pmaxx+=this.probeRadius+d,this.pmaxy+=this.probeRadius+d,this.pmaxz+=this.probeRadius+d):(this.pminx-=d,this.pminy-=d,this.pminz-=d,this.pmaxx+=d,this.pmaxy+=d,this.pmaxz+=d),this.pminx=Math.floor(this.pminx*this.scaleFactor)/this.scaleFactor,this.pminy=Math.floor(this.pminy*this.scaleFactor)/this.scaleFactor,this.pminz=Math.floor(this.pminz*this.scaleFactor)/this.scaleFactor,this.pmaxx=Math.ceil(this.pmaxx*this.scaleFactor)/this.scaleFactor,this.pmaxy=Math.ceil(this.pmaxy*this.scaleFactor)/this.scaleFactor,this.pmaxz=Math.ceil(this.pmaxz*this.scaleFactor)/this.scaleFactor,this.ptranx=-this.pminx,this.ptrany=-this.pminy,this.ptranz=-this.pminz;let c=129,h=this.pmaxx-this.pminx;this.pmaxy-this.pminy>h&&(h=this.pmaxy-this.pminy),this.pmaxz-this.pminz>h&&(h=this.pmaxz-this.pminz),this.scaleFactor=(c-1)/h,this.scaleFactor=this.defaultScaleFactor,this.defaultScaleFactor*h>this.threshbox&&(c=Math.floor(this.threshbox),this.scaleFactor=(this.threshbox-1)/h),this.bCalcArea&&(this.scaleFactor=this.defaultScaleFactor),this.pLength=Math.ceil(this.scaleFactor*(this.pmaxx-this.pminx))+1,this.pWidth=Math.ceil(this.scaleFactor*(this.pmaxy-this.pminy))+1,this.pHeight=Math.ceil(this.scaleFactor*(this.pmaxz-this.pminz))+1,this.boundingatom(t),this.cutRadius=this.probeRadius*this.scaleFactor,this.vpBits=new Uint8Array(this.pLength*this.pWidth*this.pHeight),this.vpDistance=new Float64Array(this.pLength*this.pWidth*this.pHeight),this.vpAtomID=new Int32Array(this.pLength*this.pWidth*this.pHeight),this.vpColor=[],this.vpPot=[]},Oc.prototype.boundingatom=function(e){let t,i,s,n,r=[];for(let a in this.vdwRadii){if(!this.vdwRadii.hasOwnProperty(a))continue;let o=this.vdwRadii[a];r[a]=e?(o+this.probeRadius)*this.scaleFactor+.5:o*this.scaleFactor+.5,s=r[a]*r[a],this.widxz[a]=Math.floor(r[a])+1,this.depty[a]=new Int32Array(this.widxz[a]*this.widxz[a]),n=0;for(let e=0;e<this.widxz[a];e++)for(let r=0;r<this.widxz[a];r++)t=e*e+r*r,t>s?this.depty[a][n]=-1:(i=Math.sqrt(s-t),this.depty[a][n]=Math.floor(i)),n++}},Oc.prototype.fillvoxels=function(e,t){let i,s,n,r;for(i=0,r=this.vpBits.length;i<r;i++)this.vpBits[i]=0,this.vpDistance[i]=-1,this.vpAtomID[i]=-1,this.vpColor[i]=new ls,this.vpPot[i]=0;for(i in t){let s=e[t[i]];void 0!==s&&"DUM"!==s.resn&&this.fillAtom(s,e)}if(this.dataArray){let e=0,t=this.header.xExtent-1,r=0,a=this.header.yExtent-1,o=0,l=this.header.zExtent-1,d=1,c=Math.floor(.5+d*(t-e))+1,h=Math.floor(.5+d*(a-r))+1,p=Math.floor(.5+d*(l-o))+1,u=h*p,m=p,f=new Float32Array(c*h*p);for(i=0;i<c;++i)for(s=0;s<h;++s)for(n=0;n<p;++n){let e,t=i*u+s*m+n;"phi"==this.header.filetype?e=n*u+s*m+i:"cube"==this.header.filetype&&(e=i*u+s*m+n),e<this.dataArray.length&&(f[t]=this.dataArray[e])}let g=this.pWidth*this.pHeight,b=this.pHeight;for(i=0;i<this.pLength;++i)for(s=0;s<this.pWidth;++s)for(n=0;n<this.pHeight;++n){let e=i/this.scaleFactor-this.ptranx,t=s/this.scaleFactor-this.ptrany,r=n/this.scaleFactor-this.ptranz,a=new mt(e,t,r);a.sub(this.header.ori).multiplyScalar(this.header.scale);let o=Math.floor(a.x),l=Math.ceil(a.x),d=Math.floor(a.y),C=Math.ceil(a.y),v=Math.floor(a.z),_=Math.ceil(a.z);l==o&&(l=o+1),C==d&&(C=d+1),_==v&&(_=v+1),l>c&&(l=c),C>h&&(C=h),_>p&&(_=p);let y,S=f[o*u+d*m+v],w=f[l*u+d*m+v],x=f[o*u+C*m+v],A=f[o*u+d*m+_],M=f[l*u+C*m+v],T=f[o*u+C*m+_],E=f[l*u+d*m+_],R=f[l*u+C*m+_],k=a.x-o,O=a.y-d,I=a.z-v,P=((S*(1-k)+w*k)*(1-O)+(x*(1-k)+M*k)*O)*(1-I)+((A*(1-k)+E*k)*(1-O)+(T*(1-k)+R*k)*O)*I,D=i*g+s*b+n;this.vpPot[D]=P,P>this.isovalue&&(P=this.isovalue),P<-this.isovalue&&(P=-this.isovalue),P>0?(P/=1*this.isovalue,y=new ls(1-P,1-P,1)):(P/=-1*this.isovalue,y=new ls(1,1-P,1-P)),this.vpColor[D]=y}}for(i=0,r=this.vpBits.length;i<r;i++)this.vpBits[i]&this.INOUT&&(this.vpBits[i]|=this.ISDONE)},Oc.prototype.fillAtom=function(e,t){let i,s,n,r,a,o,l,d,c,h,p,u,m,f,g,b,C,v,_;i=Math.floor(.5+this.scaleFactor*(e.coord.x+this.ptranx)),s=Math.floor(.5+this.scaleFactor*(e.coord.y+this.ptrany)),n=Math.floor(.5+this.scaleFactor*(e.coord.z+this.ptranz));let y=this.getVDWIndex(e),S=0,w=this.pWidth*this.pHeight;for(h=0,_=this.widxz[y];h<_;h++)for(p=0;p<_;p++){if(-1!=this.depty[y][S])for(b=-1;b<2;b++)for(C=-1;C<2;C++)for(v=-1;v<2;v++)if(0!==b&&0!==C&&0!==v)for(l=b*h,c=v*p,u=0;u<=this.depty[y][S];u++){if(d=u*C,m=i+l,f=s+d,g=n+c,m<0||f<0||g<0||m>=this.pLength||f>=this.pWidth||g>=this.pHeight)continue;let h=m*w+f*this.pHeight+g;if(this.vpBits[h]&this.INOUT){let p=t[this.vpAtomID[h]];p.serial!=e.serial&&(r=i+l-Math.floor(.5+this.scaleFactor*(p.x+this.ptranx)),a=s+d-Math.floor(.5+this.scaleFactor*(p.y+this.ptrany)),o=n+c-Math.floor(.5+this.scaleFactor*(p.z+this.ptranz)),l*l+d*d+c*c<r*r+a*a+o*o&&(this.vpAtomID[h]=e.serial))}else this.vpBits[h]|=this.INOUT,this.vpAtomID[h]=e.serial}S++}},Oc.prototype.fillvoxelswaals=function(e,t){let i,s;for(i=0,s=this.vpBits.length;i<s;i++)this.vpBits[i]&=~this.ISDONE;for(i in t){let s=e[t[i]];void 0!==s&&this.fillAtomWaals(s,e)}},Oc.prototype.fillAtomWaals=function(e,t){let i,s,n,r,a,o,l,d,c,h,p,u,m,f,g,b,C,v,_,y=0;i=Math.floor(.5+this.scaleFactor*(e.coord.x+this.ptranx)),s=Math.floor(.5+this.scaleFactor*(e.coord.y+this.ptrany)),n=Math.floor(.5+this.scaleFactor*(e.coord.z+this.ptranz));let S=this.getVDWIndex(e),w=this.pWidth*this.pHeight;for(m=0,_=this.widxz[S];m<_;m++)for(f=0;f<_;f++){if(-1!=this.depty[S][y])for(b=-1;b<2;b++)for(C=-1;C<2;C++)for(v=-1;v<2;v++)if(0!==b&&0!==C&&0!==v)for(l=b*m,c=v*f,g=0;g<=this.depty[S][y];g++){if(d=g*C,h=i+l,p=s+d,u=n+c,h<0||p<0||u<0||h>=this.pLength||p>=this.pWidth||u>=this.pHeight)continue;let m=h*w+p*this.pHeight+u;if(this.vpBits[m]&this.ISDONE){let h=t[this.vpAtomID[m]];h.serial!=e.serial&&(r=i+l-Math.floor(.5+this.scaleFactor*(h.x+this.ptranx)),a=s+d-Math.floor(.5+this.scaleFactor*(h.y+this.ptrany)),o=n+c-Math.floor(.5+this.scaleFactor*(h.z+this.ptranz)),l*l+d*d+c*c<r*r+a*a+o*o&&(this.vpAtomID[m]=e.serial))}else this.vpBits[m]|=this.ISDONE,this.vpAtomID[m]=e.serial}y++}},Oc.prototype.buildboundary=function(){let e=this.pWidth*this.pHeight;for(let t=0;t<this.pLength;t++)for(let i=0;i<this.pHeight;i++)for(let s=0;s<this.pWidth;s++){let n=t*e+s*this.pHeight+i;if(this.vpBits[n]&this.INOUT){let r=0;for(;r<26;){let a=t+this.nb[r][0],o=i+this.nb[r][2],l=s+this.nb[r][1];if(a>-1&&a<this.pLength&&l>-1&&l<this.pWidth&&o>-1&&o<this.pHeight&&!(this.vpBits[a*e+l*this.pHeight+o]&this.INOUT)){this.vpBits[n]|=this.ISBOUND;break}r++}}}},Oc.prototype.fastdistancemap=function(){let e,t,i,s,n,r=new function(e,t,i){let s=new Int32Array(e*t*i*3);this.set=function(e,n,r,a){let o=3*((e*t+n)*i+r);s[o]=a.ix,s[o+1]=a.iy,s[o+2]=a.iz},this.get=function(e,n,r){let a=3*((e*t+n)*i+r);return{ix:s[a],iy:s[a+1],iz:s[a+2]}}}(this.pLength,this.pWidth,this.pHeight),a=this.pWidth*this.pHeight,o=this.cutRadius*this.cutRadius,l=[],d=[];for(e=0;e<this.pLength;e++)for(t=0;t<this.pWidth;t++)for(i=0;i<this.pHeight;i++)if(n=e*a+t*this.pHeight+i,this.vpBits[n]&=~this.ISDONE,this.vpBits[n]&this.INOUT&&this.vpBits[n]&this.ISBOUND){let s={ix:e,iy:t,iz:i};r.set(e,t,i,s),l.push(s),this.vpDistance[n]=0,this.vpBits[n]|=this.ISDONE,this.vpBits[n]&=~this.ISBOUND}do{for(d=this.fastoneshell(l,r),l=[],e=0,s=d.length;e<s;e++)n=a*d[e].ix+this.pHeight*d[e].iy+d[e].iz,this.vpBits[n]&=~this.ISBOUND,this.vpDistance[n]<=1.0404*o&&l.push({ix:d[e].ix,iy:d[e].iy,iz:d[e].iz})}while(0!==l.length);l=[],d=[],r=null;let c=this.scaleFactor-.5;c<0&&(c=0);let h=o-.5/(.1+c);for(e=0;e<this.pLength;e++)for(t=0;t<this.pWidth;t++)for(i=0;i<this.pHeight;i++)n=e*a+t*this.pHeight+i,this.vpBits[n]&=~this.ISBOUND,this.vpBits[n]&this.INOUT&&(this.vpBits[n]&this.ISDONE&&!(this.vpBits[n]&this.ISDONE&&this.vpDistance[n]>=h)||(this.vpBits[n]|=this.ISBOUND))},Oc.prototype.fastoneshell=function(e,t){let i,s,n,r,a,o,l,d,c,h,p,u,m=[];if(0===e.length)return m;let f={ix:-1,iy:-1,iz:-1},g=this.pWidth*this.pHeight;for(l=0,c=e.length;l<c;l++)for(i=e[l].ix,s=e[l].iy,n=e[l].iz,p=t.get(i,s,n),d=0;d<6;d++)f.ix=i+this.nb[d][0],f.iy=s+this.nb[d][1],f.iz=n+this.nb[d][2],f.ix<this.pLength&&f.ix>-1&&f.iy<this.pWidth&&f.iy>-1&&f.iz<this.pHeight&&f.iz>-1&&(u=f.ix*g+this.pHeight*f.iy+f.iz,this.vpBits[u]&this.INOUT&&!(this.vpBits[u]&this.ISDONE)?(t.set(f.ix,f.iy,n+this.nb[d][2],p),r=f.ix-p.ix,a=f.iy-p.iy,o=f.iz-p.iz,h=r*r+a*a+o*o,this.vpDistance[u]=h,this.vpBits[u]|=this.ISDONE,this.vpBits[u]|=this.ISBOUND,m.push({ix:f.ix,iy:f.iy,iz:f.iz})):this.vpBits[u]&this.INOUT&&this.vpBits[u]&this.ISDONE&&(r=f.ix-p.ix,a=f.iy-p.iy,o=f.iz-p.iz,h=r*r+a*a+o*o,h<this.vpDistance[u]&&(t.set(f.ix,f.iy,f.iz,p),this.vpDistance[u]=h,this.vpBits[u]&this.ISBOUND||(this.vpBits[u]|=this.ISBOUND,m.push({ix:f.ix,iy:f.iy,iz:f.iz})))));for(l=0,c=e.length;l<c;l++)for(i=e[l].ix,s=e[l].iy,n=e[l].iz,p=t.get(i,s,n),d=6;d<18;d++)f.ix=i+this.nb[d][0],f.iy=s+this.nb[d][1],f.iz=n+this.nb[d][2],f.ix<this.pLength&&f.ix>-1&&f.iy<this.pWidth&&f.iy>-1&&f.iz<this.pHeight&&f.iz>-1&&(u=f.ix*g+this.pHeight*f.iy+f.iz,this.vpBits[u]&this.INOUT&&!(this.vpBits[u]&this.ISDONE)?(t.set(f.ix,f.iy,n+this.nb[d][2],p),r=f.ix-p.ix,a=f.iy-p.iy,o=f.iz-p.iz,h=r*r+a*a+o*o,this.vpDistance[u]=h,this.vpBits[u]|=this.ISDONE,this.vpBits[u]|=this.ISBOUND,m.push({ix:f.ix,iy:f.iy,iz:f.iz})):this.vpBits[u]&this.INOUT&&this.vpBits[u]&this.ISDONE&&(r=f.ix-p.ix,a=f.iy-p.iy,o=f.iz-p.iz,h=r*r+a*a+o*o,h<this.vpDistance[u]&&(t.set(f.ix,f.iy,f.iz,p),this.vpDistance[u]=h,this.vpBits[u]&this.ISBOUND||(this.vpBits[u]|=this.ISBOUND,m.push({ix:f.ix,iy:f.iy,iz:f.iz})))));for(l=0,c=e.length;l<c;l++)for(i=e[l].ix,s=e[l].iy,n=e[l].iz,p=t.get(i,s,n),d=18;d<26;d++)f.ix=i+this.nb[d][0],f.iy=s+this.nb[d][1],f.iz=n+this.nb[d][2],f.ix<this.pLength&&f.ix>-1&&f.iy<this.pWidth&&f.iy>-1&&f.iz<this.pHeight&&f.iz>-1&&(u=f.ix*g+this.pHeight*f.iy+f.iz,this.vpBits[u]&this.INOUT&&!(this.vpBits[u]&this.ISDONE)?(t.set(f.ix,f.iy,n+this.nb[d][2],p),r=f.ix-p.ix,a=f.iy-p.iy,o=f.iz-p.iz,h=r*r+a*a+o*o,this.vpDistance[u]=h,this.vpBits[u]|=this.ISDONE,this.vpBits[u]|=this.ISBOUND,m.push({ix:f.ix,iy:f.iy,iz:f.iz})):this.vpBits[u]&this.INOUT&&this.vpBits[u]&this.ISDONE&&(r=f.ix-p.ix,a=f.iy-p.iy,o=f.iz-p.iz,h=r*r+a*a+o*o,h<this.vpDistance[u]&&(t.set(f.ix,f.iy,f.iz,p),this.vpDistance[u]=h,this.vpBits[u]&this.ISBOUND||(this.vpBits[u]|=this.ISBOUND,m.push({ix:f.ix,iy:f.iy,iz:f.iz})))));return m},Oc.prototype.marchingcubeinit=function(e){for(let t=0,i=this.vpBits.length;t<i;t++)1==e?this.vpBits[t]&=~this.ISBOUND:4==e?(this.vpBits[t]&=~this.ISDONE,this.vpBits[t]&this.ISBOUND&&(this.vpBits[t]|=this.ISDONE),this.vpBits[t]&=~this.ISBOUND):2==e?this.vpBits[t]&this.ISBOUND&&this.vpBits[t]&this.ISDONE?this.vpBits[t]&=~this.ISBOUND:this.vpBits[t]&this.ISBOUND&&!(this.vpBits[t]&this.ISDONE)&&(this.vpBits[t]|=this.ISDONE):3==e&&(this.vpBits[t]&=~this.ISBOUND)},Oc.prototype.counter=function(){let e=Array(256);for(let t=0;t<256;t++)e[t]=[];this.incrementUsed=function(t,i){void 0===e[t][i]&&(e[t][i]={used:0,unused:0}),e[t][i].used++},this.incrementUnused=function(t,i){void 0===e[t][i]&&(e[t][i]={used:0,unused:0}),e[t][i].unused++};this.print=function(){let t=this.marchingCube.triTable,i=[];for(let s=0;s<t.length;s++){let n=[];for(let i=0;i<t[s].length;i+=3){let r=i/3;void 0!==e[s][r]&&e[s][r].unused||(n.push(t[s][i]),n.push(t[s][i+1]),n.push(t[s][i+2])),void 0===e[s][r]&&console.log("undef "+s+","+r)}i.push(n)}!function(e){let t="[";for(let i=0;i<e.length;i++){let s=0,n=e[i];for(let e=0;e<n.length;e++)s|=1<<n[e];t+="0x"+s.toString(16)+", "}t+="]"}(i)}},Oc.prototype.marchingcube=function(e){this.marchingcubeinit(e),this.verts=[],this.faces=[],this.marchingCube.march(this.vpBits,this.verts,this.faces,{smooth:1,nX:this.pLength,nY:this.pWidth,nZ:this.pHeight});let t=this.pWidth*this.pHeight;for(let e=0,i=this.verts.length;e<i;e++)this.verts[e].atomid=this.vpAtomID[this.verts[e].x*t+this.pHeight*this.verts[e].y+this.verts[e].z],this.dataArray&&(this.verts[e].color=this.vpColor[this.verts[e].x*t+this.pHeight*this.verts[e].y+this.verts[e].z]),this.dataArray&&(this.verts[e].pot=this.vpPot[this.verts[e].x*t+this.pHeight*this.verts[e].y+this.verts[e].z]);let i,s=0;if(this.bCalcArea){let e={};i={};for(let t=0,n=this.faces.length;t<n;t+=3){let n=this.faces[t],r=this.faces[t+1],a=this.faces[t+2];if(n==r||r==a||n==a)continue;let o=Math.min(n,r,a),l=Math.max(n,r,a),d=o+"_"+(n+r+a-o-l)+"_"+l;if(e.hasOwnProperty(d))continue;e[d]=1;let c=this.verts[n].atomid,h=this.verts[r].atomid,p=this.verts[a].atomid;if(!this.atomsToShow[c]||!this.atomsToShow[h]||!this.atomsToShow[p])continue;let u=this.verts[n],m=this.verts[r],f=this.verts[a],g=(u.x-m.x)*(u.x-m.x)+(u.y-m.y)*(u.y-m.y)+(u.z-m.z)*(u.z-m.z),b=(u.x-f.x)*(u.x-f.x)+(u.y-f.y)*(u.y-f.y)+(u.z-f.z)*(u.z-f.z),C=(f.x-m.x)*(f.x-m.x)+(f.y-m.y)*(f.y-m.y)+(f.z-m.z)*(f.z-m.z),v=Math.min(g,b,C),_=Math.max(g,b,C),y=g+b+C-v-_,S=0;S=0==parseInt(100*(_-v))?.433*v:0==parseInt(100*(y-v))?.5*v:.707*v;let w=S/3;void 0===i[c]?i[c]=w:i[c]+=w,void 0===i[h]?i[h]=w:i[h]+=w,void 0===i[p]?i[p]=w:i[p]+=w,s+=S}s=s/this.scaleFactor/this.scaleFactor}return this.bCalcArea||this.marchingCube.laplacianSmooth(1,this.verts,this.faces),{area:s,serial2area:i,scaleFactor:this.scaleFactor}};class Ic{constructor(e){this.icn3d=e,this.INOUT=1,this.ISDONE=2,this.ISBOUND=4,this.isovalue=1.5,this.dataArray={},this.matrix=void 0,this.center=void 0,this.maxdist=void 0,this.pmin=void 0,this.pmax=void 0,this.water=void 0,this.header=void 0,this.type=void 0,this.rmsd_supr=void 0,this.loadPhiFrom=void 0,this.ptranx=0,this.ptrany=0,this.ptranz=0,this.probeRadius=1.4,this.defaultScaleFactor=2,this.scaleFactor=this.defaultScaleFactor,this.pHeight=0,this.pWidth=0,this.pLength=0,this.cutRadius=0,this.vpBits=null,this.vpGridTrans=null,this.vpAtomID=null,this.vertnumber=0,this.facenumber=0,this.pminx=0,this.pminy=0,this.pminz=0,this.pmaxx=0,this.pmaxy=0,this.pmaxz=0,this.depty={},this.widxz={},this.faces=void 0,this.verts=void 0,this.nb=[new Int32Array([1,0,0]),new Int32Array([-1,0,0]),new Int32Array([0,1,0]),new Int32Array([0,-1,0]),new Int32Array([0,0,1]),new Int32Array([0,0,-1]),new Int32Array([1,1,0]),new Int32Array([1,-1,0]),new Int32Array([-1,1,0]),new Int32Array([-1,-1,0]),new Int32Array([1,0,1]),new Int32Array([1,0,-1]),new Int32Array([-1,0,1]),new Int32Array([-1,0,-1]),new Int32Array([0,1,1]),new Int32Array([0,1,-1]),new Int32Array([0,-1,1]),new Int32Array([0,-1,-1]),new Int32Array([1,1,1]),new Int32Array([1,1,-1]),new Int32Array([1,-1,1]),new Int32Array([-1,1,1]),new Int32Array([1,-1,-1]),new Int32Array([-1,-1,1]),new Int32Array([-1,1,-1]),new Int32Array([-1,-1,-1])],this.marchingCube=new kc}}Ic.prototype.getFacesAndVertices=function(e,t){let i,s,n={};for(i=0,s=t.length;i<s;i++)n[t[i]]=1;let r=this.verts,a={};for(i=0,s=r.length;i<s;i++){let e;if("phi"==this.type)e=new mt(r[i].x,r[i].y,r[i].z).multiplyScalar(1/this.header.scale).applyMatrix4(this.matrix);else{if(this.ccp4){let e,t=r[i].index;this.vpGridTrans[t]&&(e=t,r[i].x+=this.vpGridTrans[e][0]*this.header.xExtent*this.scaleFactor,r[i].y+=this.vpGridTrans[e][1]*this.header.xExtent*this.scaleFactor,r[i].z+=this.vpGridTrans[e][2]*this.header.xExtent*this.scaleFactor,a[e]=1)}e=new mt(r[i].x,r[i].y,r[i].z).applyMatrix4(this.matrix)}r[i].x=e.x,r[i].y=e.y,r[i].z=e.z}let o=[];for(i=0,s=this.faces.length;i<s;i+=3){let e=this.faces[i],t=this.faces[i+1],s=this.faces[i+2];e!==t&&t!==s&&e!==s&&(this.ccp4?a.hasOwnProperty(r[e].index)&&a.hasOwnProperty(r[t].index)&&a.hasOwnProperty(r[s].index)&&o.push({a:e,b:t,c:s}):o.push({a:e,b:t,c:s}))}return this.vpBits=null,this.vpGridTrans=null,this.vpAtomID=null,{vertices:r,faces:o}},Ic.prototype.initparm=function(e,t,i,s,n,r,a,o,l,d,c,h,p){this.header=e,this.loadPhiFrom=h,this.header&&void 0!==this.header.max?this.isovalue=this.header.min+(this.header.max-this.header.min)*s/100:this.header&&void 0!==this.header.mean?this.isovalue=this.header.mean+this.header.sigma*s:this.isovalue=s,this.dataArray=t,this.matrix=i,this.center=n,this.maxdist=r,this.pmin=a,this.pmax=o,this.water=l,this.type=d,this.rmsd_supr=c,this.pminx=0,this.pmaxx=this.header.xExtent-1,this.pminy=0,this.pmaxy=this.header.yExtent-1,this.pminz=0,this.pmaxz=this.header.zExtent-1,this.ptranx=-this.pminx,this.ptrany=-this.pminy,this.ptranz=-this.pminz;let u=this.pmaxx-this.pminx;this.pmaxy-this.pminy>u&&(u=this.pmaxy-this.pminy),this.pmaxz-this.pminz>u&&(u=this.pmaxz-this.pminz),this.scaleFactor=1,this.pLength=Math.floor(.5+this.scaleFactor*(this.pmaxx-this.pminx))+1,this.pWidth=Math.floor(.5+this.scaleFactor*(this.pmaxy-this.pminy))+1,this.pHeight=Math.floor(.5+this.scaleFactor*(this.pmaxz-this.pminz))+1,this.cutRadius=this.probeRadius*this.scaleFactor,this.vpBits=new Uint8Array(this.pLength*this.pWidth*this.pHeight),this.ccp4&&(this.vpGridTrans=new Array(this.pLength*this.pWidth*this.pHeight)),this.vpAtomID=new Uint8Array(this.pLength*this.pWidth*this.pHeight)},Ic.prototype.transformMemPro=function(e,t,i,s){let n=e.clone();n.sub(i);let r=n.x*t[0]+n.y*t[1]+n.z*t[2]+s.x,a=n.x*t[3]+n.y*t[4]+n.z*t[5]+s.y,o=n.x*t[6]+n.y*t[7]+n.z*t[8]+s.z;return n.x=r,n.y=a,n.z=o,n},Ic.prototype.fillvoxels=function(e,t){let i,s,n,r,a,o;for(i=0,r=this.vpBits.length;i<r;i++)this.vpBits[i]=0,this.vpAtomID[i]=0;let l=this.pWidth*this.pHeight,d=this.pHeight;if("phi"!=this.type||this.header.bSurface){let c=(new gi).copy(this.matrix).invert(),h=[];this.maxdist=parseInt(this.maxdist);let p,u,m,f=new Array(9);if(void 0!==this.rmsd_supr&&void 0!==this.rmsd_supr.rot){p=this.rmsd_supr.rot,u=this.rmsd_supr.trans1,m=this.rmsd_supr.trans2;let e=new bt,t=new bt;e.set(p[0],p[1],p[2],p[3],p[4],p[5],p[6],p[7],p[8]),t.copy(e).invert(),f[0]=t.elements[0],f[1]=t.elements[3],f[2]=t.elements[6],f[3]=t.elements[1],f[4]=t.elements[4],f[5]=t.elements[7],f[6]=t.elements[2],f[7]=t.elements[5],f[8]=t.elements[8]}if("phi"==this.type&&this.header.bSurface){let r=new Float32Array(this.pLength*this.pWidth*this.pHeight);for(i=0;i<this.pLength;++i)for(s=0;s<this.pWidth;++s)for(n=0;n<this.pHeight;++n){let e,t=i*l+s*d+n;"phi"==this.header.filetype?e=n*l+s*d+i:"cube"==this.header.filetype&&(e=i*l+s*d+n),e<this.dataArray.length&&(r[t]=this.dataArray[e])}for(let i in t){let s=e[t[i]];if("DUM"===s.resn)continue;let n=s.coord.clone();if("delphi"!=this.loadPhiFrom)if(void 0!==this.rmsd_supr&&void 0!==this.rmsd_supr.rot){n=this.transformMemPro(s.coord,f,m,u).applyMatrix4(c)}else n=s.coord.clone().applyMatrix4(c);n.sub(this.header.ori).multiplyScalar(this.header.scale);let a=Math.floor(n.x),o=Math.ceil(n.x),h=Math.floor(n.y),p=Math.ceil(n.y),g=Math.floor(n.z),b=Math.ceil(n.z);o==a&&(o=a+1),p==h&&(p=h+1),b==g&&(b=g+1),o>this.pLength&&(o=this.pLength),p>this.pWidth&&(p=this.pWidth),b>this.pHeight&&(b=this.pHeight);let C,v=r[a*l+h*d+g],_=r[o*l+h*d+g],y=r[a*l+p*d+g],S=r[a*l+h*d+b],w=r[o*l+p*d+g],x=r[a*l+p*d+b],A=r[o*l+h*d+b],M=r[o*l+p*d+b],T=n.x-a,E=n.y-h,R=n.z-g,k=((v*(1-T)+_*T)*(1-E)+(y*(1-T)+w*T)*E)*(1-R)+((S*(1-T)+A*T)*(1-E)+(x*(1-T)+M*T)*E)*R;k>this.isovalue&&(k=this.isovalue),k<-this.isovalue&&(k=-this.isovalue),k>0?(k/=1*this.isovalue,C=new ls(1-k,1-k,1)):(k/=-1*this.isovalue,C=new ls(1,1-k,1-k)),this.icn3d.atoms[t[i]].color=C,this.icn3d.atomPrevColors[t[i]]=C}}else{let p=this.maxdist;for(let g in t){let b,C=e[t[g]];if("DUM"!==C.resn){if(void 0!==this.rmsd_supr&&void 0!==this.rmsd_supr.rot){b=this.transformMemPro(C.coord,f,m,u).applyMatrix4(c)}else b=C.coord.clone().applyMatrix4(c);for(i=Math.floor(b.x)-p,r=Math.ceil(b.x)+p;i<=r;++i)if(!(i<0||i>this.header.xExtent*this.scaleFactor-1))for(s=Math.floor(b.y)-p,a=Math.ceil(b.y)+p;s<=a;++s)if(!(s<0||s>this.header.yExtent*this.scaleFactor-1))for(n=Math.floor(b.z)-p,o=Math.ceil(b.z)+p;n<=o;++n){if(n<0||n>this.header.zExtent*this.scaleFactor-1)continue;let e=i*l+s*d+n;h.push(e)}}}for(i=0,r=h.length;i<r;++i){let e=h[i];"2fofc"==this.type?this.vpBits[e]=this.dataArray[e]>=this.isovalue?1:0:"fofc"==this.type?(this.vpBits[e]=this.dataArray[e]>=this.isovalue||this.dataArray[e]<=-this.isovalue?1:0,this.vpAtomID[e]=this.dataArray[e]>=0?1:0):"em"==this.type&&(this.vpBits[e]=this.dataArray[e]>=this.isovalue?1:0)}}}else for(i=0;i<this.pLength;++i)for(s=0;s<this.pWidth;++s)for(n=0;n<this.pHeight;++n){let e,t=i*l+s*d+n;"phi"==this.header.filetype?e=n*l+s*d+i:"cube"==this.header.filetype&&(e=i*l+s*d+n),e<this.dataArray.length&&(this.vpBits[t]=this.dataArray[e]>=this.isovalue||this.dataArray[e]<=-this.isovalue?1:0,this.vpAtomID[t]=this.dataArray[e]>=0?1:0)}for(i=0,r=this.vpBits.length;i<r;i++)this.vpBits[i]&this.INOUT&&(this.vpBits[i]|=this.ISDONE)},Ic.prototype.buildboundary=function(){let e,t,i,s=this.pWidth*this.pHeight;for(e=0;e<this.pLength;e++)for(t=0;t<this.pHeight;t++)for(i=0;i<this.pWidth;i++){let n=e*s+i*this.pHeight+t;if(this.vpBits[n]&this.INOUT){let r=0;for(;r<26;){let a=e+this.nb[r][0],o=t+this.nb[r][2],l=i+this.nb[r][1];if(a>-1&&a<this.pLength&&l>-1&&l<this.pWidth&&o>-1&&o<this.pHeight&&!(this.vpBits[a*s+l*this.pHeight+o]&this.INOUT)){this.vpBits[n]|=this.ISBOUND;break}r++}}}},Ic.prototype.marchingcubeinit=function(e){for(let t=0,i=this.vpBits.length;t<i;t++)1==e?this.vpBits[t]&=~this.ISBOUND:4==e?(this.vpBits[t]&=~this.ISDONE,this.vpBits[t]&this.ISBOUND&&(this.vpBits[t]|=this.ISDONE),this.vpBits[t]&=~this.ISBOUND):2==e?this.vpBits[t]&this.ISBOUND&&this.vpBits[t]&this.ISDONE?this.vpBits[t]&=~this.ISBOUND:this.vpBits[t]&this.ISBOUND&&!(this.vpBits[t]&this.ISDONE)&&(this.vpBits[t]|=this.ISDONE):this.vpBits[t]&=~this.ISBOUND},Ic.prototype.counter=function(){let e=Array(256);for(let t=0;t<256;t++)e[t]=[];this.incrementUsed=function(t,i){void 0===e[t][i]&&(e[t][i]={used:0,unused:0}),e[t][i].used++},this.incrementUnused=function(t,i){void 0===e[t][i]&&(e[t][i]={used:0,unused:0}),e[t][i].unused++};this.print=function(){let t=this.marchingCube.triTable,i=[];for(let s=0;s<t.length;s++){let n=[];for(let i=0;i<t[s].length;i+=3){let r=i/3;void 0!==e[s][r]&&e[s][r].unused||(n.push(t[s][i]),n.push(t[s][i+1]),n.push(t[s][i+2])),void 0===e[s][r]&&console.log("undef "+s+","+r)}i.push(n)}!function(e){let t="[";for(let i=0;i<e.length;i++){let s=0,n=e[i];for(let e=0;e<n.length;e++)s|=1<<n[e];t+="0x"+s.toString(16)+", "}t+="]"}(i)}},Ic.prototype.marchingcube=function(e){this.marchingcubeinit(e),this.verts=[],this.faces=[],this.marchingCube.march(this.vpBits,this.verts,this.faces,{smooth:1,nX:this.pLength,nY:this.pWidth,nZ:this.pHeight});let t=this.pWidth*this.pHeight;for(let e=0,i=this.verts.length;e<i;e++)this.verts[e].atomid=this.vpAtomID[this.verts[e].x*t+this.pHeight*this.verts[e].y+this.verts[e].z];this.marchingCube.laplacianSmooth(1,this.verts,this.faces)};class Pc{constructor(e){this.icn3d=e}createSurfaceRepresentation(e,t,i,s){let n,r=this.icn3d,a=r.icn3dui,o=this;if(0==Object.keys(e).length)return;null==s&&(s=1),r.opacity=s;let l=r.contactCls.getExtent(e),d=[];if(r.bConsiderNeighbors){let t;t=a.hashUtilsCls.unionHash(t,e),t=a.hashUtilsCls.unionHash(t,r.contactCls.getAtomsWithinAtom(r.atoms,e,5)),d=Object.keys(t)}else d=Object.keys(e);let c;10==parseInt(10*s)||i||r.bInstanced&&(Object.keys(r.atoms).length,r.biomtMatrices.length,r.maxatomcnt);let h={allatoms:r.atoms,atomsToShow:Object.keys(e),extendedAtoms:d,water:r.water,center:r.center,maxdist:1,pmin:r.pmin,pmax:r.pmax,rmsd_supr:r.rmsd_supr};if(11==t){if(h.header=r.mapData.header2,h.data=r.mapData.data2,h.matrix=r.mapData.matrix2,h.isovalue=r.mapData.sigma2,h.type="2fofc",h.ccp4=r.mapData.ccp4,h.grid=r.mapData.grid2,h.unit_cell=r.mapData.unit_cell2,!h.header&&!h.ccp4)return;if(c=this.SetupMap(h),h.ccp4)return void(r.mapData={})}else if(12==t){if(h.header=r.mapData.header,h.data=r.mapData.data,h.matrix=r.mapData.matrix,h.isovalue=r.mapData.sigma,h.type="fofc",h.ccp4=r.mapData.ccp4,h.grid=r.mapData.grid,h.unit_cell=r.mapData.unit_cell,!h.header&&!h.ccp4)return;if(c=this.SetupMap(h),h.ccp4)return void(r.mapData={})}else if(13==t)h.maxdist=3,h.header=r.mapData.headerEm,h.data=r.mapData.dataEm,h.matrix=r.mapData.matrixEm,h.isovalue=r.mapData.sigmaEm,h.type="em",c=this.SetupMap(h);else if(14==t)h.header=r.mapData.headerPhi,h.data=r.mapData.dataPhi,h.matrix=r.mapData.matrixPhi,h.isovalue=r.mapData.contourPhi,h.type="phi",h.loadPhiFrom=r.loadPhiFrom,c=this.SetupMap(h);else{let i=a.hashUtilsCls.exclHash(e,r.water);d=a.hashUtilsCls.exclHash(d,r.water);let s=t;21==s?s=1:22==s?s=2:23==s&&(s=3),h={extent:l,allatoms:r.atoms,atomsToShow:Object.keys(i),extendedAtoms:d,type:s,threshbox:r.transparentRenderOrder?60:r.threshbox,bCalcArea:r.bCalcArea},h.header=r.mapData.headerPhi,h.data=r.mapData.dataPhi,h.matrix=r.mapData.matrixPhi,h.isovalue=r.mapData.contourPhi,h.loadPhiFrom=r.loadPhiFrom,c=this.SetupSurface(h)}if(r.bCalcArea){r.areavalue=c.area.toFixed(2);let e=c.serial2area,t=c.scaleFactor*c.scaleFactor;r.resid2area={};let i={},s={};for(let t in e){let n=r.atoms[t],a=n.structure+"_"+n.chain+"_"+n.resi+"_"+n.resn;i[n.structure]=1,s[n.structure+"_"+n.chain]=1,void 0===r.resid2area[a]?r.resid2area[a]=e[t]:r.resid2area[a]+=e[t]}let n='<table border="1" cellpadding="10" cellspacing="0">',o=Object.keys(i).length>1?"<th>Structure</th>":"",l=Object.keys(s).length>1?"<th>Chain</th>":"";n+="<tr>"+o+l+"<th>Residue</th><th>Number</th><th>SASA (&#8491;<sup>2</sup>)</th><th>Percent Out</th><th>In/Out</th></tr>";for(let e in r.resid2area){let d=e.lastIndexOf("_"),c=e.substr(d+1),h=a.utilsCls.getIdArray(e.substr(0,d));o=Object.keys(i).length>1?"<td>"+h[0]+"</td>":"",l=Object.keys(s).length>1?"<td>"+h[1]+"</td>":"";let p="",u="";r.resid2area[e]=(r.resid2area[e]/t).toFixed(2),a.parasCls.residueArea.hasOwnProperty(c)&&(u=parseInt(r.resid2area[e]/a.parasCls.residueArea[c]*100),u>100&&(u=100),u>=50&&(p="out"),u<20&&(p="in")),n+='<tr align="center">'+o+l+"<td>"+c+'</td><td align="right">'+h[2]+'</td><td align="right">'+r.resid2area[e]+'</td><td align="right">'+u+"%</td><td>"+p+"</td></tr>"}return n+="</table>",void(r.areahtml=n)}let p,u,m,f=c.vertices,g=c.faces,b=a.parasCls.thr("#00FFFF"),C=a.parasCls.thr("#00FF00"),v=a.parasCls.thr("#ff0000"),_=a.parasCls.thr("#00FFFF"),y=a.parasCls.thr("#0000FF"),S=a.parasCls.thr("#FF0000");11!=t&&12!=t&&13!=t&&14!=t||void 0===r.rmsd_supr||void 0===r.rmsd_supr.rot||(p=r.rmsd_supr.rot,u=r.rmsd_supr.trans1,m=r.rmsd_supr.trans2);let w=(11==t||12==t||13==t||14==t&&"delphi"!=r.loadPhiFrom)&&void 0!==r.rmsd_supr&&void 0!==r.rmsd_supr.rot;n=new Ts;let x,A=[],M=[],T=[],E=0;for(let e=0,i=f.length;e<i;++e,E+=3){let i=f[e],s=new mt(i.x,i.y,i.z);if(w&&(s=o.transformMemPro(s,p,u,m)),A[E]=s.x,A[E+1]=s.y,A[E+2]=s.z,11==t)x=b;else if(12==t)x=i.atomid?C:v;else if(13==t)x=_;else if(14==t)x=i.atomid?y:S;else if(21==t||22==t||23==t){x=i.color;let e=i.atomid;r.atoms[e].pot=i.pot}else{let e=i.atomid;x=r.atoms[e].color}M[E]=x.r,M[E+1]=x.g,M[E+2]=x.b}if(a.bNode)return;E=0;for(let e=0,t=g.length;e<t;++e,E+=3){let t=g[e];T[E]=t.a,T[E+1]=t.b,T[E+2]=t.c}if(n.setAttribute("position",new gs(new Float32Array(A),3)),n.setAttribute("color",new gs(new Float32Array(M),3)),n.setIndex(new gs(new Uint32Array(T),1)),n.computeVertexNormals(),n.type="Surface",r.transparentRenderOrder){let e={};for(let t=0,i=g.length;t<i;++t){let i=g[t].a,s=g[t].b,n=g[t].c;void 0===e[i]&&(e[i]=[]),e[i].push(s),e[i].push(n)}for(let n in e){this.geometry=new Ts;let o=[],l=[],d=[],c=0,h=0,p=0,u=e[n],m=new mt(0,0,0),g=3,b=0;for(let e=0,i=u.length;e<i;e+=2){let i=u[e],s=u[e+1];o[c++]=f[n].x,o[c++]=f[n].y,o[c++]=f[n].z,o[c++]=f[i].x,o[c++]=f[i].y,o[c++]=f[i].z,o[c++]=f[s].x,o[c++]=f[s].y,o[c++]=f[s].z,21==t||22==t||23==t?(l[h++]=f[n].color.r,l[h++]=f[n].color.g,l[h++]=f[n].color.b,l[h++]=f[i].color.r,l[h++]=f[i].color.g,l[h++]=f[i].color.b,l[h++]=f[s].color.r,l[h++]=f[s].color.g,l[h++]=f[s].color.b):(l[h++]=r.atoms[f[n].atomid].color.r,l[h++]=r.atoms[f[n].atomid].color.g,l[h++]=r.atoms[f[n].atomid].color.b,l[h++]=r.atoms[f[i].atomid].color.r,l[h++]=r.atoms[f[i].atomid].color.g,l[h++]=r.atoms[f[i].atomid].color.b,l[h++]=r.atoms[f[s].atomid].color.r,l[h++]=r.atoms[f[s].atomid].color.g,l[h++]=r.atoms[f[s].atomid].color.b);let a=e/2*3;d[p++]=a,d[p++]=a+1,d[p++]=a+2,m=m.add(new mt(f[a].x,f[a].y,f[a].z)),m=m.add(new mt(f[a+1].x,f[a+1].y,f[a+1].z)),m=m.add(new mt(f[a+2].x,f[a+2].y,f[a+2].z)),b+=3}this.geometry.setAttribute("position",new gs(new Float32Array(o),g)),this.geometry.setAttribute("color",new gs(new Float32Array(l),g)),this.geometry.setIndex(new gs(new Uint32Array(d),1)),this.geometry.computeVertexNormals(),this.geometry.type="Surface";let C,v=new Hs(this.geometry,new ps({specular:r.frac,shininess:0,emissive:r.emissive,vertexColors:!0,wireframe:i,opacity:s,transparent:!0,side:2}));C=r.bControlGl&&!a.bNode?m.multiplyScalar(1/b).sub(r.oriCenter).applyMatrix4(window.cam.matrixWorldInverse):m.multiplyScalar(1/b).sub(r.oriCenter).applyMatrix4(r.cam.matrixWorldInverse),v.renderOrder=r.cam_z>0?-parseInt(C.z):parseInt(C.z),v.onBeforeRender=function(e,t,i,s,n,o){let l,d=new mt(0,0,0),c=s.getAttribute("position").array;for(let e=0,t=c.length;e<t;e+=3)d=d.add(new mt(c[e],c[e+1],c[e+2]));l=r.bControlGl&&!a.bNode?d.multiplyScalar(3/c.length).sub(r.oriCenter).applyMatrix4(window.cam.matrixWorldInverse):d.multiplyScalar(3/c.length).sub(r.oriCenter).applyMatrix4(r.cam.matrixWorldInverse),this.renderOrder=r.cam_z>0?-parseInt(l.z):parseInt(l.z)},r.mdl.add(v),11==t||12==t?r.prevMaps.push(v):13==t?r.prevEmmaps.push(v):14==t?r.prevPhimaps.push(v):r.prevSurfaces.push(v)}}else{let e=new Hs(n,new gr({specular:r.frac,shininess:20,emissive:r.emissive,vertexColors:!0,wireframe:i,opacity:s,transparent:!0,depthWrite:10==parseInt(10*s),side:2}));e.renderOrder=-2,r.mdl.add(e),11==t||12==t?r.prevMaps.push(e):13==t?r.prevEmmaps.push(e):14==t?r.prevPhimaps.push(e):r.prevSurfaces.push(e)}c=null,f=null,g=null,n=null}transformMemPro(e,t,i,s,n){this.icn3d.icn3dui;let r=e.clone();r.sub(i),n&&console.log("sub coord: "+JSON.stringify(r));let a=r.x*t[0]+r.y*t[1]+r.z*t[2]+s.x,o=r.x*t[3]+r.y*t[4]+r.z*t[5]+s.y,l=r.x*t[6]+r.y*t[7]+r.z*t[8]+s.z;return r.x=a,r.y=o,r.z=l,n&&console.log("out coord: "+JSON.stringify(r)),r}SetupSurface(e){let t=this.icn3d;t.icn3dui;let i=e.threshbox,s=new Oc(t,i);s.initparm(e.extent,1!==e.type,e.bCalcArea,e.atomsToShow,e.header,e.data,e.matrix,e.isovalue,e.loadPhiFrom),s.fillvoxels(e.allatoms,e.extendedAtoms),s.buildboundary(),2===e.type&&(s.fastdistancemap(),s.boundingatom(!1),s.fillvoxelswaals(e.allatoms,e.extendedAtoms));let n=s.marchingcube();s.vpBits=null,s.vpDistance=null,s.vpAtomID=null;let r=s.getFacesAndVertices(e.atomsToShow);return r.area=n.area,r.serial2area=n.serial2area,r.scaleFactor=n.scaleFactor,s.faces=null,s.verts=null,r}SetupMap(e){let t=this.icn3d;if(t.icn3dui,!e.ccp4){let i,s=new Ic(t);return s.initparm(e.header,e.data,e.matrix,e.isovalue,e.center,e.maxdist,e.pmin,e.pmax,e.water,e.type,e.rmsd_supr,e.loadPhiFrom,e.icn3d),s.fillvoxels(e.allatoms,e.extendedAtoms),e.header.bSurface||s.buildboundary(),e.header.bSurface||s.marchingcube(),s.vpBits=null,s.vpAtomID=null,e.header.bSurface||(i=s.getFacesAndVertices(e.allatoms,e.atomsToShow)),s.faces=null,s.verts=null,i}{let i,s=10,n=t.center?[t.center.x,t.center.y,t.center.z]:[0,0,0];if("2fofc"==e.type){i="2fofc";let r=t.ccp4ParserCls.extract_block(e.grid,e.unit_cell,s,n,i),a=t.ccp4ParserCls.marchingCubes(r.size,r.values,r.points,e.isovalue,"marching cubes");t.ccp4ParserCls.makeChickenWire(a,i),r=null,a=null}else if("fofc"==e.type){i="fofc_neg";let r=t.ccp4ParserCls.extract_block(e.grid,e.unit_cell,s,n,i),a=t.ccp4ParserCls.marchingCubes(r.size,r.values,r.points,e.isovalue,"marching cubes");t.ccp4ParserCls.makeChickenWire(a,i),i="fofc_pos",r=t.ccp4ParserCls.extract_block(e.grid,e.unit_cell,s,n,i),a=t.ccp4ParserCls.marchingCubes(r.size,r.values,r.points,e.isovalue,"marching cubes"),t.ccp4ParserCls.makeChickenWire(a,i),r=null,a=null}}}}class Dc{constructor(e){this.icn3d=e}applyCenterOptions(e){let t,i=this.icn3d;switch(i.icn3dui,void 0===e&&(e=i.opts),e.rotationcenter.toLowerCase()){case"molecule center":void 0!==i.center&&this.setRotationCenter(i.center);break;case"pick center":void 0!==i.pAtom&&this.setRotationCenter(i.pAtom.coord);break;case"display center":t=this.centerAtoms(i.dAtoms).center,this.setRotationCenter(t);break;case"highlight center":t=this.centerAtoms(i.hAtoms).center,this.setRotationCenter(t)}}setRotationCenter(e){this.icn3d.icn3dui,this.setCenter(e)}setCenter(e){let t=this.icn3d;t.icn3dui,t.mdl.position.set(0,0,0),t.mdlImpostor.position.set(0,0,0),t.mdl_ghost.position.set(0,0,0),t.mdl.position.sub(e),t.mdlImpostor.position.sub(e),t.mdl_ghost.position.sub(e)}centerSelection(e,t){let i=this.icn3d,s=i.icn3dui;if(i.opts.rotationcenter="highlight center",void 0===e&&(e=s.hashUtilsCls.hash2Atoms(i.hAtoms,i.atoms)),t||(i._zoomFactor=1,i.mouseChange=new pt(0,0),i.quaternion=new ut(0,0,0,1)),Object.keys(e).length>1){let t=this.centerAtoms(e);i.center=t.center,this.setCenter(i.center),i.cameraCls.setCamera()}}centerAtoms(e){let t=this.icn3d;t.icn3dui;let i=new mt(9999,9999,9999),s=new mt(-9999,-9999,-9999),n=new mt;for(let r in e){let e=t.atoms[r].coord;n.add(e),i.min(e),s.max(e)}let r=t.ParserUtilsCls.getGeoCenter(i,s);return{center:r,maxD:t.ParserUtilsCls.getStructureSize(e,i,s,r),pmin:i,pmax:s}}setWidthHeight(e,t){let i=this.icn3d;i.icn3dui,void 0===i.scaleFactor&&(i.scaleFactor=1),i.renderer.setSize(e*i.scaleFactor,t*i.scaleFactor),i.renderer.domElement.style.width=e*i.scaleFactor+"px",i.renderer.domElement.style.height=t*i.scaleFactor+"px",i.renderer.domElement.width=e*i.scaleFactor,i.renderer.domElement.height=t*i.scaleFactor,i.container.whratio=e/t}}class Lc{constructor(e){this.icn3d=e}applyClbondsOptions(e){let t=this.icn3d,i=t.icn3dui;if(void 0===e&&(e=t.opts),t.bCalcCrossLink||(t.clbondpnts={},t.clbondResid2serial={},this.applyClbondsOptions_base("chemical"),this.applyClbondsOptions_base("all"),t.bCalcCrossLink=!0),"yes"===e.clbonds.toLowerCase()&&"nothing"!==e.chemicals){let e="#006400";if(i.parasCls.thr(25600),t.lines.clbond=[],t.residuesHashClbonds={},t.structures){let s=Object.keys(t.structures);for(let n=0,r=s.length;n<r;++n){let r=s[n];if(t.clbondpnts[r])for(let s=0,n=t.clbondpnts[r].length;s<n;s+=2){let n=t.clbondpnts[r][s],a=t.clbondpnts[r][s+1],o={};if(o.color=e,o.dashed=!1,o.radius=t.crosslinkRadius,o.serial1=t.clbondResid2serial[n+","+a],o.serial2=t.clbondResid2serial[a+","+n],!t.dAtoms.hasOwnProperty(o.serial1)||!t.dAtoms.hasOwnProperty(o.serial2))continue;o.position1=t.atoms[o.serial1].coord,o.position2=t.atoms[o.serial2].coord,t.lines.clbond.push(o);let l={};l=i.hashUtilsCls.unionHash(l,t.residues[n]),l=i.hashUtilsCls.unionHash(l,t.residues[a]);let d=i.hashUtilsCls.intHash(l,t.sidec);for(let e in d)t.atoms[e].style2="stick";t.residuesHashClbonds[n]=1,t.residuesHashClbonds[a]=1}}}}return t.residuesHashClbonds}applyClbondsOptions_base(e){let t=this.icn3d;t.icn3dui;for(let i in t.chemicals){let s=t.atoms[i],n=s.structure+"_"+s.chain+"_"+s.resi;for(let i in s.bonds){let r=t.atoms[s.bonds[i]];if(void 0!==r&&(r.chain!==s.chain||r.resi!==s.resi)){let i=r.structure+"_"+r.chain+"_"+r.resi;if("chemical"!=e||r.het){if("chemical"==e)continue;void 0===t.clbondpnts[s.structure]&&(t.clbondpnts[s.structure]=[]),t.clbondpnts[s.structure].push(n),t.clbondpnts[r.structure].push(i),t.clbondResid2serial[n+","+i]=s.serial,t.clbondResid2serial[i+","+n]=r.serial}}}}}}class Fc{constructor(e){this.icn3d=e}applyMissingResOptions(e){let t=this.icn3d;if(t.icn3dui,void 0===e&&(e=t.opts),t.bCalcMissingRes||(t.missingResPnts={},t.missingResResid2serial={},this.applyMissingResOptions_base(),t.bCalcMissingRes=!0),t.lines.missingres=[],t.structures){let e=Object.keys(t.structures);for(let i=0,s=e.length;i<s;++i){let s=e[i];if(t.missingResPnts[s])for(let e=0,i=t.missingResPnts[s].length;e<i;e+=2){let i=t.missingResPnts[s][e],n=t.missingResPnts[s][e+1],r={dashed:!0};r.serial1=t.missingResResid2serial[i+","+n],r.serial2=t.missingResResid2serial[n+","+i],r.color="#"+t.atoms[r.serial1].color.getHexString(),r.radius=t.coilWidth,t.dAtoms.hasOwnProperty(r.serial1)&&t.dAtoms.hasOwnProperty(r.serial2)&&(r.position1=t.atoms[r.serial1].coord,r.position2=t.atoms[r.serial2].coord,t.lines.missingres.push(r))}}}}applyMissingResOptions_base(e){let t=this.icn3d;t.icn3dui;let i=[];for(let e in t.chainsSeq){let s,n,r,a,o=!1,l=!1;for(let d=0,c=t.chainsSeq[e].length;d<c;++d)n=e+"_"+t.chainsSeq[e][d].resi,t.residues.hasOwnProperty(n)?(o=!0,a=!0):a=!1,!a&&l?s=r:o&&s&&a&&!l&&(i.push(s),i.push(n),s=void 0),l=a,r=n}for(let e=0,s=i.length;e<s;e+=2){let s=i[e],n=i[e+1],r=s.substr(0,s.indexOf("_"));s.substr(0,n.indexOf("_"));let a=t.firstAtomObjCls.getFirstCalphaAtomObj(t.residues[s]),o=t.firstAtomObjCls.getFirstCalphaAtomObj(t.residues[n]);a&&o&&(void 0===t.missingResPnts[r]&&(t.missingResPnts[r]=[]),t.missingResPnts[r].push(s),t.missingResPnts[r].push(n),t.missingResResid2serial[s+","+n]=a.serial,t.missingResResid2serial[n+","+s]=o.serial)}}}class Nc{constructor(e){this.icn3d=e}applyDisplayOptions(e,t,i){let s=this.icn3d,n=s.icn3dui;if(void 0===e&&(e=s.opts),!n.bNode&&""!=n.htmlCls.setHtmlCls.getCookie("lineRadius")){let e=parseFloat(n.htmlCls.setHtmlCls.getCookie("lineRadius")),t=parseFloat(n.htmlCls.setHtmlCls.getCookie("coilWidth")),i=parseFloat(n.htmlCls.setHtmlCls.getCookie("cylinderRadius")),r=n.htmlCls.setHtmlCls.getCookie("crosslinkRadius"),a=r&&!isNaN(r)?parseFloat(r):s.crosslinkRadius,o=parseFloat(n.htmlCls.setHtmlCls.getCookie("traceRadius")),l=parseFloat(n.htmlCls.setHtmlCls.getCookie("dotSphereScale")),d=parseFloat(n.htmlCls.setHtmlCls.getCookie("ribbonthickness")),c=parseFloat(n.htmlCls.setHtmlCls.getCookie("helixSheetWidth")),h=parseFloat(n.htmlCls.setHtmlCls.getCookie("nucleicAcidWidth"));s.bSetThicknessOnce||s.lineRadius==e&&s.coilWidth==t&&s.cylinderRadius==i&&s.crosslinkRadius==a&&s.traceRadius==o&&s.dotSphereScale==l&&s.ribbonthickness==d&&s.helixSheetWidth==c&&s.nucleicAcidWidth==h||(s.bSetThicknessOnce=!0,n.htmlCls.clickMenuCls.setLogCmd("set thickness | linerad "+e+" | coilrad "+t+" | stickrad "+i+" | crosslinkrad "+a+" | tracerad "+o+" | ribbonthick "+d+" | proteinwidth "+c+" | nucleotidewidth "+h+" | ballscale "+l,!0)),s.lineRadius=e,s.coilWidth=t,s.cylinderRadius=i,s.crosslinkRadius=a,s.traceRadius=o,s.dotSphereScale=l,s.ribbonthickness=d,s.helixSheetWidth=c,s.nucleicAcidWidth=h}let r,a={},o={},l={};if(1===i&&Object.keys(t).length<Object.keys(s.atoms).length){l=n.hashUtilsCls.hash2Atoms(t,s.atoms),a=s.firstAtomObjCls.getResiduesFromAtoms(t,s.atoms);for(let e in a){r=e;let t=e.lastIndexOf("_"),i=e.substr(0,t+1),s=e.substr(t+1);if(isNaN(s))continue;let n=parseInt(s),l=i+(n-1).toString();(n+1).toString(),a.hasOwnProperty(l)||a.hasOwnProperty(l)||(o[e]=1)}if(1===Object.keys(l).length&&Object.keys(s.residues[r]).length>1&&"sphere"!==l[Object.keys(l)[0]].style&&"dot"!==l[Object.keys(l)[0]].style){if(void 0===s.bCid||!s.bCid)for(let e in l){let t=l[e],n=1;s.boxCls.createBox(t,void 0,void 0,n,void 0,i)}}else for(let e in o){let r=s.firstAtomObjCls.getFirstCalphaAtomObj(s.residues[e]),a=s.firstAtomObjCls.getFirstAtomObj(s.selectionCls.getSideAtoms(s.residues[e])),o=r,l=o.structure+"_"+o.chain+"_"+(parseInt(o.resi)-1).toString(),d=o.structure+"_"+o.chain+"_"+(parseInt(o.resi)+1).toString();if("cylinder and plate"===o.style&&"helix"===o.ss)for(let t in s.residues[e]){let e=s.atoms[t],n=1;s.boxCls.createBox(e,void 0,void 0,n,void 0,i)}else if("ribbon"===o.style&&"coil"===o.ss||"strand"===o.style&&"coil"===o.ss||"o3 trace"===o.style||"schematic"===o.style||"c alpha trace"===o.style||"b factor tube"===o.style||"cylinder and plate"===o.style&&"helix"!==o.ss){if(void 0!==a&&void 0!==a.style2&&"nothing"!==a.style2)continue;let e=!1;if(!isNaN(o.resi)&&!e&&s.residues.hasOwnProperty(d)){let i=Object.keys(s.residues[d])[0],r=n.hashUtilsCls.hash2Atoms(s.residues[d],s.atoms)[i];if(o.style===r.style&&!r.ssbegin||r.ssbegin){let i=s.residues[d];if(t=n.hashUtilsCls.unionHash(t,i),e=!0,r.ssbegin)for(let e in i)s.atoms[e].notshow=!0}}if(!isNaN(o.resi)&&!e&&s.residues.hasOwnProperty(l)){let i=Object.keys(s.residues[l])[0],r=n.hashUtilsCls.hash2Atoms(s.residues[l],s.atoms)[i];o.style===r.style&&(t=n.hashUtilsCls.unionHash(t,s.residues[l]),e=!0)}}else if("ribbon"===o.style&&"coil"!==o.ss&&o.ssend||"strand"===o.style&&"coil"!==o.ss&&o.ssend){if(void 0!==a&&void 0!==a.style2&&"nothing"!==a.style2)continue;let e=!1;if(!isNaN(o.resi)&&!e&&s.residues.hasOwnProperty(d)){let i=Object.keys(s.residues[d])[0];n.hashUtilsCls.hash2Atoms(s.residues[d],s.atoms)[i],t=n.hashUtilsCls.unionHash(t,s.residues[d]),e=!0}}}l={}}if(s.bInitial&&void 0===s.bMembrane){if(""!=n.htmlCls.setHtmlCls.getCookie("membrane")){let e=parseInt(n.htmlCls.setHtmlCls.getCookie("membrane"));s.bMembrane!=e&&n.htmlCls.clickMenuCls.setLogCmd("set membrane "+e,!0),s.bMembrane=isNaN(e)?0:parseInt(e)}s.bMembrane?s.selectionCls.toggleMembrane(!0):s.selectionCls.toggleMembrane(!1)}s.setStyleCls.setStyle2Atoms(t);let d=.5*s.cylinderRadius;void 0!==s.labels&&delete s.labels.schematic;for(let e in s.style2atoms){let t=s.style2atoms[e],r=n.hashUtilsCls.intHash(t,s.nucleotides),a=n.utilsCls.isCalphaPhosOnly(n.hashUtilsCls.hash2Atoms(r,s.atoms));if("ribbon"===e)s.strandCls.createStrand(n.hashUtilsCls.hash2Atoms(t,s.atoms),2,void 0,!0,void 0,void 0,!1,s.ribbonthickness,i);else if("strand"===e)s.strandCls.createStrand(n.hashUtilsCls.hash2Atoms(t,s.atoms),null,null,null,null,null,!1,void 0,i);else if("cylinder and plate"===e)s.cylinderCls.createCylinderHelix(n.hashUtilsCls.hash2Atoms(t,s.atoms),s.cylinderHelixRadius,i);else if("nucleotide cartoon"===e)a?s.cylinderCls.createCylinderCurve(n.hashUtilsCls.hash2Atoms(t,s.atoms),["P"],s.traceRadius,!1,i):(s.cartoonNuclCls.drawCartoonNucleicAcid(n.hashUtilsCls.hash2Atoms(t,s.atoms),null,s.ribbonthickness,i),2!==i&&s.cartoonNuclCls.drawNucleicAcidStick(n.hashUtilsCls.hash2Atoms(t,s.atoms),i));else if("o3 trace"===e)a?s.cylinderCls.createCylinderCurve(n.hashUtilsCls.hash2Atoms(t,s.atoms),["P"],s.traceRadius,!1,i):s.cylinderCls.createCylinderCurve(n.hashUtilsCls.hash2Atoms(t,s.atoms),["O3'","O3*"],s.traceRadius,!1,i);else if("schematic"===e){let e=s.firstAtomObjCls.getFirstAtomObj(t);if(s.chemicals.hasOwnProperty(e.serial)){s.residueLabelsCls.addNonCarbonAtomLabels(n.hashUtilsCls.hash2Atoms(t,s.atoms));let e=!0;s.stickCls.createStickRepresentation(n.hashUtilsCls.hash2Atoms(t,s.atoms),d,d,void 0,i,e)}else s.residueLabelsCls.addResidueLabels(n.hashUtilsCls.hash2Atoms(t,s.atoms),!0),a?s.cylinderCls.createCylinderCurve(n.hashUtilsCls.hash2Atoms(t,s.atoms),["P"],s.traceRadius,!1,i):s.cylinderCls.createCylinderCurve(n.hashUtilsCls.hash2Atoms(t,s.atoms),["O3'","O3*"],s.traceRadius,!1,i),s.cylinderCls.createCylinderCurve(n.hashUtilsCls.hash2Atoms(t,s.atoms),["CA"],s.traceRadius,!1,i)}else"c alpha trace"===e?s.cylinderCls.createCylinderCurve(n.hashUtilsCls.hash2Atoms(t,s.atoms),["CA"],s.traceRadius,!1,i):"b factor tube"===e?s.tubeCls.createTube(n.hashUtilsCls.hash2Atoms(t,s.atoms),"CA",null,i,!1,!0):"custom tube"===e?s.tubeCls.createTube(n.hashUtilsCls.hash2Atoms(t,s.atoms),"CA",null,i,!0,!0):"lines"===e||"lines2"===e?(1===i?s.stickCls.createStickRepresentation(n.hashUtilsCls.hash2Atoms(t,s.atoms),s.hlLineRadius,s.hlLineRadius,void 0,i):s.lineCls.createLineRepresentation(n.hashUtilsCls.hash2Atoms(t,s.atoms),i),s.lineCls.createConnCalphSidechain(n.hashUtilsCls.hash2Atoms(t,s.atoms),e)):"stick"===e||"stick2"===e?(s.stickCls.createStickRepresentation(n.hashUtilsCls.hash2Atoms(t,s.atoms),s.cylinderRadius,s.cylinderRadius,void 0,i,void 0),s.lineCls.createConnCalphSidechain(n.hashUtilsCls.hash2Atoms(t,s.atoms),e)):"backbone"===e?(t=this.selectMainChainSubset(t),s.stickCls.createStickRepresentation(n.hashUtilsCls.hash2Atoms(t,s.atoms),s.cylinderRadius,s.cylinderRadius,void 0,i,void 0)):"ball and stick"===e||"ball and stick2"===e?(s.stickCls.createStickRepresentation(n.hashUtilsCls.hash2Atoms(t,s.atoms),s.cylinderRadius,.5*s.cylinderRadius,s.dotSphereScale,i,void 0),s.lineCls.createConnCalphSidechain(n.hashUtilsCls.hash2Atoms(t,s.atoms),e)):"sphere"===e||"sphere2"===e?s.sphereCls.createSphereRepresentation(n.hashUtilsCls.hash2Atoms(t,s.atoms),s.sphereRadius,void 0,void 0,i):"dot"===e&&s.sphereCls.createSphereRepresentation(n.hashUtilsCls.hash2Atoms(t,s.atoms),s.sphereRadius,!1,s.dotSphereScale,i)}if(s.cnt>s.maxmaxatomcnt&&s.init_base(),void 0!==s.labels&&Object.keys(s.labels).length>0){s.labelCls.hideLabels();for(let e in s.labels)"schematic"!=e&&this.changeLabelColor(s.labels[e]);s.labelCls.createLabelRepresentation(s.labels)}}changeLabelColor(e){let t=this.icn3d;if(t.icn3dui,e)for(let i=0,s=e.length;i<s;++i){let s=e[i];"black"!=t.opts.background&&s.color==t.colorBlackbkgd?s.color=t.colorWhitebkgd:"black"==t.opts.background&&s.color==t.colorWhitebkgd&&(s.color=t.colorBlackbkgd)}}selectMainChainSubset(e){let t=this.icn3d;t.icn3dui;let i=["C1'","C1*","C2'","C2*","C3'","C3*","C4'","C4*","C5'","C5*","O3'","O3*","O4'","O4*","O5'","O5*","P","OP1","O1P","OP2","O2P"],s={};for(let n in e)(t.proteins.hasOwnProperty(n)&&("N"===t.atoms[n].name||"C"===t.atoms[n].name||"O"===t.atoms[n].name||"CA"===t.atoms[n].name&&"C"===t.atoms[n].elem)||t.nucleotides.hasOwnProperty(n)&&-1!==i.indexOf(t.atoms[n].name))&&(s[n]=1);return s}}class Uc{constructor(e){this.icn3d=e}applyOtherOptions(e){let t=this.icn3d,i=t.icn3dui;if(void 0===e&&(e=t.opts),t.hBondCls.setHbondsContacts(e,"contact"),t.hBondCls.setHbondsContacts(e,"halogen"),t.hBondCls.setHbondsContacts(e,"pi-cation"),t.hBondCls.setHbondsContacts(e,"pi-stacking"),t.hBondCls.setHbondsContacts(e,"hbond"),t.hBondCls.setHbondsContacts(e,"saltbridge"),void 0!==t.pairArray&&t.pairArray.length>0){this.updateStabilizer();let e="#FFFFFF",i=t.stabilizerpnts;t.lines.stabilizer=[];for(let s=0,n=Math.floor(i.length/2);s<n;s++){let n={};n.position1=i[2*s],n.position2=i[2*s+1],n.color=e,n.dashed=!1,t.lines.stabilizer.push(n)}}if(t.lineCls.createLines(t.lines),t.distPnts&&t.distPnts.length>0)for(let e=0,i=t.distPnts.length;e<i;++e)t.boxCls.createBox_base(t.distPnts[e],t.originSize,t.hColor,!1);if(void 0!==t.prevMaps)for(let e=0,i=t.prevMaps.length;e<i;++e)t.mdl.add(t.prevMaps[e]);if(void 0!==t.prevEmmaps)for(let e=0,i=t.prevEmmaps.length;e<i;++e)t.mdl.add(t.prevEmmaps[e]);if(void 0!==t.prevPhimaps)for(let e=0,i=t.prevPhimaps.length;e<i;++e)t.mdl.add(t.prevPhimaps[e]);if(void 0!==t.prevSurfaces)for(let e=0,i=t.prevSurfaces.length;e<i;++e)t.mdl.add(t.prevSurfaces[e]);if(void 0!==t.symmetryHash&&void 0!==t.symmetrytitle&&t.applySymdCls.applySymmetry(t.symmetrytitle),void 0!==t.symdArray&&t.symdArray.length>0&&t.applySymdCls.applySymd(),void 0!==t.prevOtherMesh)for(let e=0,i=t.prevOtherMesh.length;e<i;++e)t.mdl.add(t.prevOtherMesh[e]);if(t.bInitial&&void 0===t.bGlycansCartoon&&""!=i.htmlCls.setHtmlCls.getCookie("glycan")){let e=parseInt(i.htmlCls.setHtmlCls.getCookie("glycan"));t.bGlycansCartoon!=e&&i.htmlCls.clickMenuCls.setLogCmd("set glycan "+e,!0),t.bGlycansCartoon=e}t.bGlycansCartoon&&!t.bAlternate&&t.glycanCls.showGlycans();for(let e in t.shapeCmdHash)"add cube"==e.substr(0,8)?t.applyCommandCls.addShape(e,"cube"):t.applyCommandCls.addShape(e,"sphere");switch(t.applyCenterCls.applyCenterOptions(e),t.axesCls.buildAllAxes(void 0,!0),e.axis.toLowerCase()){case"yes":t.axis=!0,t.axesCls.buildAxes(t.maxD/2);break;case"no":t.axis=!1}switch(e.pk.toLowerCase()){case"atom":t.pk=1;break;case"no":t.pk=0;break;case"residue":t.pk=2;break;case"strand":t.pk=3}}applyChemicalbindingOptions(e){let t=this.icn3d,i=t.icn3dui;if(void 0===e&&(e=t.opts),"show"===e.chemicalbinding){let e;void 0!==t.chemicals&&Object.keys(t.chemicals).length>0&&(e=i.hashUtilsCls.hash2Atoms(t.chemicals,t.atoms));let s=4;if(void 0!==e){let n=t.contactCls.getAtomsWithinAtom(t.atoms,e,s),r=3.5;t.opts.hbonds="yes",Object.keys(n).length>0&&t.hBondCls.calculateChemicalHbonds(e,n,parseFloat(r)),t.bSetFog||t.transformCls.zoominSelection(i.hashUtilsCls.unionHash(e,n))}}else"hide"===e.chemicalbinding&&(t.hBondCls.hideHbonds(),t.showInterCls.hideExtraBonds(),t.bSetFog||t.transformCls.zoominSelection(t.atoms))}updateStabilizer(){let e=this.icn3d;if(e.icn3dui,e.stabilizerpnts=[],void 0!==e.pairArray)for(let t=0,i=e.pairArray.length;t<i;t+=2){let i=this.getResidueRepPos(e.pairArray[t]),s=this.getResidueRepPos(e.pairArray[t+1]);e.stabilizerpnts.push(i),e.stabilizerpnts.push(s)}}getResidueRepPos(e){let t=this.icn3d;t.icn3dui;let i,s=t.atoms[e],n=s.structure+"_"+s.chain+"_"+s.resi;if(t.proteins.hasOwnProperty(e)||t.nucleotides.hasOwnProperty(e))for(let e in t.residues[n]){let s=t.atoms[e];if("N3"===s.name){i=t.atoms[e].coord;break}if("CA"===s.name&&"coil"==s.ss){i=t.atoms[e].coord;break}if("CA"===s.name&&("helix"==s.ss||"sheet"==s.ss)){i=void 0!==t.atoms[e].coord2?t.atoms[e].coord2:t.atoms[e].coord;break}}else i=s.coord;return void 0===i&&(i=s.coord),i}}class Hc{constructor(e){this.icn3d=e}applySsbondsOptions(e){let t=this.icn3d,i=t.icn3dui;if(void 0===e&&(e=t.opts),"yes"===e.ssbonds.toLowerCase()&&void 0!==t.ssbondpnts){let e,s,n="#FFFF00",r=i.parasCls.thr(16776960),a=Object.keys(t.structures);if(t.bAlternate){let i=a.length;e=t.ALTERNATE_STRUCTURE%i,s=t.ALTERNATE_STRUCTURE%i+1}else e=0,s=a.length;t.lines.ssbond=[];for(let o=e,l=s;o<l;++o){let e=a[o];if(t.ssbondpnts[e])for(let s=Math.floor(t.ssbondpnts[e].length/2)-1;s>=0;s--){let a=t.ssbondpnts[e][2*s],o=t.ssbondpnts[e][2*s+1],l={};l.color=n,l.dashed=!1;let d=[],c=[],h=[],p=[],u=!1,m=!1;for(let e in t.residues[a])"SG"===t.atoms[e].name&&(h.push(t.atoms[e].coord),d.push(t.atoms[e].serial),u=!0);if(!u)for(let e in t.residues[a])if("CA"===t.atoms[e].name){h.push(t.atoms[e].coord),d.push(t.atoms[e].serial),u=!0,m=!0;break}u=!1;for(let e in t.residues[o])"SG"===t.atoms[e].name&&(p.push(t.atoms[e].coord),c.push(t.atoms[e].serial),u=!0);if(!u)for(let e in t.residues[o])if("CA"===t.atoms[e].name){p.push(t.atoms[e].coord),c.push(t.atoms[e].serial),u=!0,m=!0;break}let f=m?7:3,g=!1;for(let e=0,t=h.length;e<t;++e)for(let t=0,i=p.length;t<i;++t)if(h[e].distanceTo(p[t])<f){g=!0,l.serial1=d[e],l.position1=h[e],l.serial2=c[t],l.position2=p[t];break}if(void 0!==l.serial1&&void 0!==l.serial2&&!t.dAtoms.hasOwnProperty(l.serial1)&&!t.dAtoms.hasOwnProperty(l.serial2))continue;if(!g){t.ssbondpnts[e].splice(2*s,2);continue}let b,C,v,_=t.atoms[l.serial1].bonds.indexOf(l.serial2);-1!=_&&(b=t.atoms[l.serial1].bonds.slice(0,_),C=t.atoms[l.serial1].bonds.slice(_+1),t.atoms[l.serial1].bonds=b.concat(C)),_=t.atoms[l.serial2].bonds.indexOf(l.serial1),-1!=_&&(b=t.atoms[l.serial2].bonds.slice(0,_),C=t.atoms[l.serial2].bonds.slice(_+1),t.atoms[l.serial2].bonds=b.concat(C)),t.lines.ssbond.push(l),v=i.hashUtilsCls.unionHash(v,t.residues[a]),v=i.hashUtilsCls.unionHash(v,t.residues[o]);let y=t.firstAtomObjCls.getFirstAtomObj(v),S="lines"==y.style?"lines":"stick";"lines"!=y.style&&t.cylinderCls.createCylinder(l.position1,l.position2,t.cylinderRadius,r);let w=i.hashUtilsCls.intHash(v,t.sidec);for(let e in w)t.atoms[e].style2=S}}}}}class Bc{constructor(e){this.icn3d=e}applySymd(){let e=this.icn3d;e.icn3dui;for(let t=0,i=e.symdArray.length;t<i;++t){let i=e.symdArray[t],s=Object.keys(i)[0];this.applySymmetry(s,!0,i[s])}}applySymmetry(e,t,i){let s=this.icn3d,n=s.icn3dui,r=t?i:s.symmetryHash[e];r||(r=[]);let a=e.substr(0,1),o=parseInt(e.substring(1,e.indexOf(" "))),l=1.5*s.cylinderRadius,d=1*s.cylinderRadius,c=[];for(let e=0,i=r.length;e<i;++e){let i=r[e][0],h=r[e][1],p=r[e][2],u=r[e][3],m=r[e][4],f=r[e][5];s.cylinderCls.createCylinder(i,h,l,p,0);let g=h.clone().sub(i).normalize();if(n.htmlCls.clickMenuCls.setLogCmd("Symmetry Axis: "+g.x.toFixed(3)+" "+g.y.toFixed(3)+" "+g.z.toFixed(3),!1),!s.bAxisOnly){if("C"==a||"D"==a&&m==o){let e={};Object.keys(s.chains).length;let r=!1,a={};if(t&&Object.keys(s.hAtoms).length<Object.keys(s.atoms).length){for(let e in s.hAtoms){let t=s.atoms[e];a[t.structure+"_"+t.chain]=1}Object.keys(a).length>1&&(r=!0)}if(t)if(r){let t=Object.keys(a)[0];e=s.chains[t]}else{0==Object.keys(s.hAtoms).length&&(s.hAtoms=n.hashUtilsCls.cloneHash(s.dAtoms));let t,i=parseInt(Object.keys(s.hAtoms).length/m),r=0;for(let n in s.hAtoms)if(e[n]=1,t=n,++r,r>i)break;let a=s.atoms[t].structure+"_"+s.atoms[t].chain+"_"+s.atoms[t].resi;e=n.hashUtilsCls.unionHash(e,s.residues[a])}else{let t=Object.keys(s.structures)[0]+"_"+f;if(s.chains.hasOwnProperty(t)||(t=Object.keys(s.structures)[0]+"_"+f.toLowerCase()),!s.chains.hasOwnProperty(t)){t=Object.keys(s.chains)[0];for(let e in s.chains){let i=Object.keys(s.chains[e])[0];if(s.proteins.hasOwnProperty(i)){t=e;break}}}e=s.chains[t]}let l=i.clone().add(h).multiplyScalar(.5),c=new mt,p=0,g=h.clone().sub(i).normalize(),b=new mt(0,0,1),C=new ut;C.setFromUnitVectors(g,b);let v=-9999;for(let t in e){let e=s.atoms[t].coord.clone();c.add(e),e.sub(l).applyQuaternion(C);let i=e.x*e.x+e.y*e.y;i>v&&(v=i),++p}let _=s.ParserUtilsCls.getMassCenter(c,p),y=new Xr(i,h),S=new mt;y.closestPointToPoint(_,!0,S);let w,x,A,M,T=Math.sqrt(v),E=_.clone().sub(S).normalize().multiplyScalar(T),R=l.clone().add(i.clone().sub(l).multiplyScalar(.83)).add(E),k=l.clone().add(h.clone().sub(l).multiplyScalar(.83)).add(E),O=2*Math.PI/o;for(let e=0;e<o;++e){let t=(.5+e)*O,n=R.clone().sub(i);n.applyAxisAngle(g,t).add(i);let r=k.clone().sub(i);r.applyAxisAngle(g,t).add(i),s.cylinderCls.createCylinder(n,r,d,u,0),s.sphereCls.createSphereBase(n,u,d,1,0),s.sphereCls.createSphereBase(r,u,d,1,0),0==e?(w=n,x=r):(s.cylinderCls.createCylinder(n,A,d,u,0),s.cylinderCls.createCylinder(r,M,d,u,0)),A=n,M=r}w&&A&&s.cylinderCls.createCylinder(w,A,d,u,0),x&&M&&s.cylinderCls.createCylinder(x,M,d,u,0)}else("T"==a&&3==m||"O"==a&&4==m||"I"==a&&5==m)&&(c.push(i),c.push(h));if("T"==a){let e=c[0];s.sphereCls.createSphereBase(e,u,d,1,0);let t,i,n,r=e.distanceTo(c[2]),a=e.distanceTo(c[3]);r<a?(t=r,i=c[3]):(t=a,i=c[2]),s.sphereCls.createSphereBase(i,u,d,1,0),s.cylinderCls.createCylinder(e,i,d,u,0);for(let r=4,a=c.length;r<a;++r){let a=c[r];e.distanceTo(a)>t&&(s.sphereCls.createSphereBase(a,u,d,1,0),s.cylinderCls.createCylinder(e,a,d,u,0),s.cylinderCls.createCylinder(i,a,d,u,0),void 0!==n&&s.cylinderCls.createCylinder(c[n],a,d,u,0),n=r)}}else if("O"==a)for(let e=0,t=c.length;e<t;e+=2){let t=c[e],i=c[e+1];s.sphereCls.createSphereBase(t,u,d,1,0),s.sphereCls.createSphereBase(i,u,d,1,0);for(let n=e+2,r=c.length;n<r;++n){let e=c[n];s.sphereCls.createSphereBase(e,u,d,1,0),s.cylinderCls.createCylinder(t,e,d,u,0),s.cylinderCls.createCylinder(i,e,d,u,0)}}else if("I"==a)for(let e=0,t=c.length;e<t;e+=2){let t=c[e],i=c[e+1];s.sphereCls.createSphereBase(t,u,d,1,0),s.sphereCls.createSphereBase(i,u,d,1,0);for(let n=e+2,r=c.length;n<r;n+=2){let e,r,a=c[n],o=c[n+1];t.distanceTo(a)<t.distanceTo(o)?(e=a,r=o):(e=o,r=a),s.sphereCls.createSphereBase(e,u,d,1,0),s.sphereCls.createSphereBase(r,u,d,1,0),s.cylinderCls.createCylinder(t,e,d,u,0),s.cylinderCls.createCylinder(i,r,d,u,0)}}}}}}class zc{constructor(e){this.icn3d=e}applySurfaceOptions(e){let t,i,s=this.icn3d,n=s.icn3dui;switch(void 0===e&&(e=s.opts),e.wireframe){case"yes":e.wireframe=!0;break;case"no":e.wireframe=!1}switch(e.opacity=parseFloat(e.opacity),t=n.hashUtilsCls.intHash(s.dAtoms,s.hAtoms),"nothing"===e.water&&(t=n.hashUtilsCls.exclHash(t,s.water)),i=n.hashUtilsCls.hash2Atoms(t,s.atoms),e.surface.toLowerCase()){case"van der waals surface":case"van der waals surface with context":s.surfaceCls.createSurfaceRepresentation(i,1,e.wireframe,e.opacity);break;case"solvent accessible surface":case"solvent accessible surface with context":s.surfaceCls.createSurfaceRepresentation(i,3,e.wireframe,e.opacity);break;case"molecular surface":case"molecular surface with context":s.surfaceCls.createSurfaceRepresentation(i,2,e.wireframe,e.opacity);break;case"nothing":this.removeSurfaces()}}applyMapOptions(e){let t,i,s=this.icn3d,n=s.icn3dui;switch(void 0===e&&(e=s.opts),e.mapwireframe){case"yes":e.mapwireframe=!0;break;case"no":e.mapwireframe=!1}switch(t=n.hashUtilsCls.intHash(s.dAtoms,s.hAtoms),i=n.hashUtilsCls.hash2Atoms(t,s.atoms),e.map.toLowerCase()){case"2fofc":s.surfaceCls.createSurfaceRepresentation(i,11,e.mapwireframe);break;case"fofc":s.surfaceCls.createSurfaceRepresentation(i,12,e.mapwireframe);break;case"nothing":this.removeMaps()}}applyEmmapOptions(e){let t,i,s=this.icn3d,n=s.icn3dui;switch(void 0===e&&(e=s.opts),e.emmapwireframe){case"yes":e.emmapwireframe=!0;break;case"no":e.emmapwireframe=!1}switch(t=n.hashUtilsCls.intHash(s.dAtoms,s.hAtoms),i=n.hashUtilsCls.hash2Atoms(t,s.atoms),e.emmap.toLowerCase()){case"em":s.surfaceCls.createSurfaceRepresentation(i,13,e.emmapwireframe);break;case"nothing":this.removeEmmaps()}}applyPhimapOptions(e){let t,i,s=this.icn3d,n=s.icn3dui;switch(void 0===e&&(e=s.opts),e.phimapwireframe){case"yes":e.phimapwireframe=!0;break;case"no":e.phimapwireframe=!1}switch(t=n.hashUtilsCls.intHash(s.dAtoms,s.hAtoms),i=n.hashUtilsCls.hash2Atoms(t,s.atoms),e.phimap.toLowerCase()){case"phi":s.surfaceCls.createSurfaceRepresentation(i,14,e.phimapwireframe);break;case"nothing":this.removePhimaps()}}applyphisurfaceOptions(e){let t,i,s=this.icn3d,n=s.icn3dui;switch(void 0===e&&(e=s.opts),s.phisurfwf){case"yes":e.phisurfwf=!0;break;case"no":e.phisurfwf=!1}switch(e.phisurfop=parseFloat(s.phisurfop),t=n.hashUtilsCls.intHash(s.dAtoms,s.hAtoms),"nothing"===e.water&&(t=n.hashUtilsCls.exclHash(t,s.water)),i=n.hashUtilsCls.hash2Atoms(t,s.atoms),e.phisurface.toLowerCase()){case"phi":s.surfaceCls.createSurfaceRepresentation(i,parseInt(s.phisurftype),e.phisurfwf,e.phisurfop);break;case"nothing":this.removeSurfaces()}}removeSurfaces(){let e=this.icn3d;e.icn3dui;for(let t=0,i=e.prevSurfaces.length;t<i;++t)e.mdl.remove(e.prevSurfaces[t]);e.prevSurfaces=[]}removeLastSurface(){let e=this.icn3d;e.icn3dui,e.prevSurfaces.length>0&&(e.mdl.remove(e.prevSurfaces[e.prevSurfaces.length-1]),e.prevSurfaces.slice(e.prevSurfaces.length-1,1))}removeMaps(){let e=this.icn3d;e.icn3dui;for(let t=0,i=e.prevMaps.length;t<i;++t)e.mdl.remove(e.prevMaps[t]);e.prevMaps=[]}removeEmmaps(){let e=this.icn3d;e.icn3dui;for(let t=0,i=e.prevEmmaps.length;t<i;++t)e.mdl.remove(e.prevEmmaps[t]);e.prevEmmaps=[]}removePhimaps(){let e=this.icn3d;e.icn3dui;for(let t=0,i=e.prevPhimaps.length;t<i;++t)e.mdl.remove(e.prevPhimaps[t]);e.prevPhimaps=[]}removeLastMap(){let e=this.icn3d;e.icn3dui,e.prevMaps.length>0&&(e.mdl.remove(e.prevMaps[e.prevMaps.length-1]),e.prevMaps.slice(e.prevMaps.length-1,1))}removeLastEmmap(){let e=this.icn3d;e.icn3dui,e.prevEmmaps.length>0&&(e.mdl.remove(e.prevEmmaps[e.prevEmmaps.length-1]),e.prevEmmaps.slice(e.prevEmmaps.length-1,1))}removeLastPhimap(){let e=this.icn3d;e.icn3dui,e.prevPhimaps.length>0&&(e.mdl.remove(e.prevPhimaps[e.prevPhimaps.length-1]),e.prevPhimaps.slice(e.prevPhimaps.length-1,1))}}class qc{constructor(e){this.icn3d=e}addResidueLabels(e,t,i,s,n){let r=this.icn3d,a=r.icn3dui;if(a.bNode)return;let o=a.hashUtilsCls.intHash(r.hAtoms,e);t?void 0===r.labels.schematic&&(r.labels.schematic=[]):void 0===r.labels.residue&&(r.labels.residue=[]);let l="";for(let e in o){let i=r.atoms[e],o={},d=i.structure+"_"+i.chain+"_"+i.resi;if(!i.het&&("CA"===i.name||"O3'"===i.name||"O3*"===i.name)||r.water.hasOwnProperty(i.serial)||r.ions.hasOwnProperty(i.serial)||r.chemicals.hasOwnProperty(i.serial)&&d!==l){if(o.position=i.coord,o.bSchematic=0,t&&(o.bSchematic=1),o.text=a.utilsCls.residueName2Abbr(i.resn),s)o.text+=i.resi;else if(n){let e=i.structure+"_"+i.chain+"_"+i.resi,t="";r.resid2refnum[e]&&(t=" "==r.resid2refnum[e].substr(0,1)?"":r.resid2refnum[e]),o.text=t}o.size=18,o.factor=.3;let e=i.color.getHexString().toUpperCase();o.color=s?"black"!=r.opts.background?r.colorWhitebkgd:r.colorBlackbkgd:n?"#00FFFF":"CCCCCC"===e||"C8C8C8"===e?"#888888":"#"+e,o.background="#FFFFFF",t?r.labels.schematic.push(o):r.labels.residue.push(o)}l=d}r.hlObjectsCls.removeHlObjects()}addIgLabels(e){let t=this.icn3d;if(t.icn3dui.bNode)return;t.labels.ig=[];let i=t.firstAtomObjCls.getChainsFromAtoms(e);for(let e in t.igLabel2Pos)if(i.hasOwnProperty(e))for(let i in t.igLabel2Pos[e]){let s={};s.position=t.igLabel2Pos[e][i],s.text=i,s.size=60,s.color="#00FFFF",t.labels.ig.push(s)}t.hlObjectsCls.removeHlObjects()}addNonCarbonAtomLabels(e){let t=this.icn3d,i=t.icn3dui;if(i.bNode)return;let s=i.hashUtilsCls.intHash(t.hAtoms,e);void 0===t.labels.schematic&&(t.labels.schematic=[]);for(let e in s){let i=t.atoms[e];if(!t.residues.hasOwnProperty(i.structure+"_"+i.chain+"_"+i.resi))continue;if("C"===i.elem)continue;let s={};s.position=i.coord,s.bSchematic=1,s.text=i.elem,s.size=18,s.color="black"!=t.opts.background?t.colorWhitebkgd:i.color.getHexString(),s.background="#FFFFFF",t.labels.schematic.push(s)}t.hlObjectsCls.removeHlObjects()}addAtomLabels(e,t){let i=this.icn3d,s=i.icn3dui;if(s.bNode)return;let n=s.hashUtilsCls.intHash(i.hAtoms,e);n=s.hashUtilsCls.intHash(i.dAtoms,n),void 0===i.labels.residue&&(i.labels.residue=[]);for(let e in n){let s=i.atoms[e],n={};n.position=s.coord,n.bSchematic=0,n.text=t?s.elem:s.name.padEnd(2," "),n.size=18,t&&(n.bSchematic=!0);let r=s.color.getHexString().toUpperCase();n.color="black"!=i.opts.background?i.colorWhitebkgd:i.colorBlackbkgd,t&&(n.color="CCCCCC"===r||"C8C8C8"===r?"#888888":"#"+r),n.background="#FFFFFF",i.labels.residue.push(n)}i.hlObjectsCls.removeHlObjects()}}class jc{constructor(e){this.icn3d=e}onBeforeRender(e,t,i,s,n,r){let a=n.uniforms,o=[];if(a.objectId&&(a.objectId.value=SupportsReadPixelsFloat?this.id:this.id/255,o.push("objectId")),(a.modelViewMatrixInverse||a.modelViewMatrixInverseTranspose||a.modelViewProjectionMatrix||a.modelViewProjectionMatrixInverse)&&this.modelViewMatrix.multiplyMatrices(i.matrixWorldInverse,this.matrixWorld),a.modelViewMatrixInverse&&(a.modelViewMatrixInverse.value.copy(this.modelViewMatrix).invert(),o.push("modelViewMatrixInverse")),a.modelViewMatrixInverseTranspose&&(a.modelViewMatrixInverse?a.modelViewMatrixInverseTranspose.value.copy(a.modelViewMatrixInverse.value).transpose():a.modelViewMatrixInverseTranspose.value.copy(this.modelViewMatrix).invert().transpose(),o.push("modelViewMatrixInverseTranspose")),a.modelViewProjectionMatrix&&(i.updateProjectionMatrix(),a.modelViewProjectionMatrix.value.multiplyMatrices(i.projectionMatrix,this.modelViewMatrix),o.push("modelViewProjectionMatrix")),a.modelViewProjectionMatrixInverse){let e=new gi;a.modelViewProjectionMatrix?(e.copy(a.modelViewProjectionMatrix.value),a.modelViewProjectionMatrixInverse.value.copy(e).invert()):(i.updateProjectionMatrix(),e.multiplyMatrices(i.projectionMatrix,this.modelViewMatrix),a.modelViewProjectionMatrixInverse.value.copy(e).invert()),o.push("modelViewProjectionMatrixInverse")}if(a.projectionMatrix&&(i.updateProjectionMatrix(),a.projectionMatrix.value.copy(i.projectionMatrix),o.push("projectionMatrix")),a.projectionMatrixInverse&&(i.updateProjectionMatrix(),a.projectionMatrixInverse.value.copy(i.projectionMatrix).invert(),o.push("projectionMatrixInverse")),o.length){let t=e.properties.get(n);if(t.program){let i=e.getContext(),s=t.program;i.useProgram(s.program);let n=s.getUniforms();o.forEach((function(e){n.setValue(i,e,a[e].value)}))}}}setParametersForShader(e){let t,i=this.icn3d,s=i.icn3dui.parasCls.backgroundColors[i.opts.background.toLowerCase()],n=2.5*i.maxD,r=4*i.maxD,a=void 0!==i.biomtMatrices&&i.biomtMatrices.length*i.cnt>i.maxatomcnt;"yes"===i.opts.slab?a?t=.1:void 0!==i.camMaxDFactorFog?(t=i.maxD*i.camMaxDFactorFog-10,n=2.5*i.maxD-t<0?0:2.5*i.maxD-t,r=4*i.maxD-t):t=i.maxD*i.camMaxDFactor:t=.1;let o=void 0!==e?e:1,l=i.shininess/100*.5;i.uniforms=$s.merge([Qr.common,{modelViewMatrix:{value:new gi},modelViewMatrixInverse:{value:new gi},modelViewMatrixInverseTranspose:{value:new gi},modelViewProjectionMatrix:{value:new gi},modelViewProjectionMatrixInverse:{value:new gi},projectionMatrix:{value:new gi},projectionMatrixInverse:{value:new gi},diffuse:{type:"v3",value:[1,1,1]},emissive:{type:"v3",value:[.06,.06,.06]},roughness:{type:"f",value:.5},metalness:{type:"f",value:l},opacity:{type:"f",value:o},nearClip:{type:"f",value:t},ortho:{type:"f",value:0},shrink:{type:"f",value:.13},fogColor:{type:"v3",value:[s.r,s.g,s.b]},fogNear:{type:"f",value:n},fogFar:{type:"f",value:r},fogDensity:{type:"f",value:2}},Qr.ambient,Qr.lights]),i.defines={USE_COLOR:1,NEAR_CLIP:1,CAP:1},"yes"!==i.opts.fog||a||(i.defines.USE_FOG=1,"orthographic"===i.opts.camera&&(i.defines.FOG_EXP2=1)),i.bExtFragDepth&&(i.defines.USE_LOGDEPTHBUF_EXT=1)}drawImpostorShader(){this.icn3d.icn3dui.bNode||(this.setParametersForShader(),this.createImpostorShaderSphere("SphereImpostor"),this.createImpostorShaderCylinder("CylinderImpostor"))}getShader(e){this.icn3d.icn3dui;let t=$NGL_shaderTextHash[e];return t=t.replace(/#include\s+(\S+)/gim,(function(e,t){let i;return Jr.hasOwnProperty(t)&&(i=Jr[t]),i||""})),t}createImpostorShaderBase(e,t,i,s,n,r,a,o,l){let d=this.icn3d;d.icn3dui;let c=new Vs({defines:d.defines,uniforms:d.uniforms,vertexShader:this.getShader(e+".vert"),fragmentShader:this.getShader(e+".frag"),depthTest:!0,depthWrite:!0,lights:!0});c.extensions.fragDepth=!0,"CylinderImpostor"==e?d.CylinderImpostorMaterial=c:"SphereImpostor"==e&&(d.SphereImpostorMaterial=c);let h,p,u=r*a,m=r*o,f=new(u>65535?Uint32Array:Uint16Array)(m);for(let e=0;e<r;e++){h=e*o,p=e*a,f.set(i,h);for(let e=0;e<o;++e)f[h+e]+=p}let g=new Ts;f&&(g.setIndex(new gs(f,1)),g.getIndex().setUsage(35048));let b={f:1,v2:2,v3:3,c:3};for(let e in n){let t,i=n[e];t=new Float32Array(u*b[i.type]),g.setAttribute(e,new gs(t,b[i.type]).setUsage(35048))}let C,v,_,y,S,w,x=g.attributes;for(let e in s){v=s[e],C=x[e],_=C.itemSize,y=C.array;for(let e=0;e<r;++e){m=e*_,S=m*a;for(let e=0;e<a;++e){w=S+_*e;for(let e=0;e<_;++e)y[w+e]=v[m+e]}}C.needsUpdate=!0}let A=g.attributes.mapping.array;for(let e=0;e<r;e++)A.set(t,e*l*a);let M=new Hs(g,c);M.frustumCulled=!1,M.scale.x=M.scale.y=M.scale.z=1,"CylinderImpostor"==e?M.type="Cylinder":"SphereImpostor"==e&&(M.type="Sphere"),M.onBeforeRender=this.onBeforeRender,d.mdlImpostor.add(M)}createImpostorShaderCylinder(e){let t=this.icn3d;t.icn3dui;let i=new Float32Array(t.posArray),s=new Float32Array(t.colorArray),n=new Float32Array(t.pos2Array),r=new Float32Array(t.color2Array),a=new Float32Array(t.radiusArray),o=new Float32Array([-1,1,-1,-1,-1,-1,1,1,-1,1,1,1,1,-1,-1,1,-1,1]),l=new Uint16Array([0,1,2,1,4,2,2,4,3,4,5,3]),d=i.length/3,c={position1:i,color:s,position2:n,color2:r,radius:a},h={position1:{type:"v3",value:null},color:{type:"v3",value:null},position2:{type:"v3",value:null},color2:{type:"v3",value:null},radius:{type:"f",value:null},mapping:{type:"v3",value:null}};this.createImpostorShaderBase(e,o,l,c,h,d,6,12,3),c=null,i=null,s=null,n=null,r=null,a=null,t.posArray=[],t.colorArray=[],t.pos2Array=[],t.color2Array=[],t.radiusArray=[]}createImpostorShaderSphere(e){let t=this.icn3d;t.icn3dui;let i=new Float32Array(t.posArraySphere),s=new Float32Array(t.colorArraySphere),n=new Float32Array(t.radiusArraySphere),r=new Float32Array([-1,1,-1,-1,1,1,1,-1]),a=new Uint16Array([0,1,2,1,3,2]),o=i.length/3,l={position:i,color:s,radius:n},d={position:{type:"v3",value:null},color:{type:"v3",value:null},radius:{type:"f",value:null},mapping:{type:"v2",value:null}};this.createImpostorShaderBase(e,r,a,l,d,o,4,6,2),l=null,i=null,s=null,n=null,t.posArraySphere=[],t.colorArraySphere=[],t.radiusArraySphere=[]}clearImpostors(){let e=this.icn3d;e.icn3dui,e.posArray=[],e.colorArray=[],e.pos2Array=[],e.color2Array=[],e.radiusArray=[],e.posArraySphere=[],e.colorArraySphere=[],e.radiusArraySphere=[]}}class Gc{constructor(e){this.icn3d=e}positionFromGeometry(e){this.icn3d.icn3dui;let t,i,s=e.geometry,n=s.vertices,r=e.position,a=e.scale,o=e.matrix,l=n.length,d=[];for(let e=0;e<l;e++)t=3*e,i="SphereGeometry"==s.type||"BoxGeometry"==s.type?n[e].clone().multiply(a).add(r):"CylinderGeometry"==s.type?n[e].clone().applyMatrix4(o):n[e],d[t+0]=i.x,d[t+1]=i.y,d[t+2]=i.z;return d}colorFromGeometry(e){let t=this.icn3d.icn3dui,i=e.geometry,s=t.parasCls.thr(1,1,1);"SphereGeometry"!=i.type&&"BoxGeometry"!=i.type&&"CylinderGeometry"!=i.type||void 0!==e.material&&(s=e.material.color);let n,r,a,o,l,d=i.faces;i.vertices.length,i.type;let c=d.length,h=[];for(let e=0;e<c;e++)r=d[e],"Surface"==i.type?(a=r.vertexColors[0],o=r.vertexColors[1],l=r.vertexColors[2]):"SphereGeometry"==i.type||"BoxGeometry"==i.type||"CylinderGeometry"==i.type?(a=s,o=s,l=s):(a=r.color,o=r.color,l=r.color),n=3*r.a,h[n+0]=a.r,h[n+1]=a.g,h[n+2]=a.b,n=3*r.b,h[n+0]=o.r,h[n+1]=o.g,h[n+2]=o.b,n=3*r.c,h[n+0]=l.r,h[n+1]=l.g,h[n+2]=l.b;return h}indexFromGeometry(e){this.icn3d.icn3dui;let t,i,s=e.geometry.faces,n=s.length,r=[];for(let e=0;e<n;e++)t=3*e,i=s[e],r[t+0]=i.a,r[t+1]=i.b,r[t+2]=i.c;return r}normalFromGeometry(e){this.icn3d.icn3dui;let t,i,s,n,r,a,o=e.geometry,l=o.faces;o.vertices.length;let d=l.length,c=[];for(let e=0;e<d;e++)i=l[e],s=i.vertexNormals,n=s[0],r=s[1],a=s[2],t=3*i.a,c[t+0]=n.x,c[t+1]=n.y,c[t+2]=n.z,t=3*i.b,c[t+0]=r.x,c[t+1]=r.y,c[t+2]=r.z,t=3*i.c,c[t+0]=a.x,c[t+1]=a.y,c[t+2]=a.z;return c}drawSymmetryMates(){let e=this.icn3d;e.icn3dui.bNode||(e.bInstanced?this.drawSymmetryMatesInstancing():this.drawSymmetryMatesNoInstancing())}applyMat(e,t,i){let s=this.icn3d;if(s.icn3dui,void 0===s.rmsd_supr)e.applyMatrix4(t);else{let i=s.rmsd_supr.rot,n=s.rmsd_supr.trans1,r=s.rmsd_supr.trans2,a=new gi;a.set(i[0],i[1],i[2],0,i[3],i[4],i[5],0,i[6],i[7],i[8],0,0,0,0,1);let o=new gi;o.copy(a).invert();let l=new gi;l.makeTranslation(-r.x,-r.y,-r.z),e.applyMatrix4(l),e.applyMatrix4(o),l.makeTranslation(n.x,n.y,n.z),e.applyMatrix4(l),e.applyMatrix4(t),l.makeTranslation(-n.x,-n.y,-n.z),e.applyMatrix4(l),e.applyMatrix4(a),l.makeTranslation(r.x,r.y,r.z),e.applyMatrix4(l)}}drawSymmetryMatesNoInstancing(){let e=this.icn3d;if(e.icn3dui,void 0===e.biomtMatrices||0==e.biomtMatrices.length)return;let t=1,i=e.center.clone(),s=new gi;s.identity();let n=new ji,r=new ji,a=new ji;for(let o=0;o<e.biomtMatrices.length&&1==Object.keys(e.structures).length;o++){let l,d=e.biomtMatrices[o];if(void 0===d)continue;if(d.equals(s))continue;if(void 0!==e.mdl&&(l=e.mdl.clone(),this.applyMat(l,d),n.add(l)),void 0!==e.mdlImpostor){l=e.mdlImpostor.clone(),this.applyMat(l,d);for(let t=l.children.length-1;t>=0;t--){let i=l.children[t];i.onBeforeRender=e.impostorCls.onBeforeRender,i.frustumCulled=!1}r.add(l)}void 0!==e.mdl_ghost&&(l=e.mdl_ghost.clone(),this.applyMat(l,d),a.add(l));let c=e.center.clone();this.applyMat(c,d,!0),i.add(c),++t}e.mdl.add(n),e.mdlImpostor.add(r),e.mdl_ghost.add(a),void 0!==e.bSetInstancing&&e.bSetInstancing?(e.maxD=e.maxDAssembly,e.center=e.centerAssembly.clone(),e.applyCenterCls.setCenter(e.center),e.cameraCls.setCamera()):(e.maxD*=Math.sqrt(t),e.center=e.ParserUtilsCls.getMassCenter(i,t),e.maxDAssembly=e.maxD,e.centerAssembly=e.center.clone(),e.applyCenterCls.setCenter(e.center),e.cameraCls.setCamera()),e.bSetInstancing=!0}createInstancedGeometry(e){let t=this.icn3d,i=t.icn3dui,s=e.geometry,n=new Ur,r=[],a=[],o=[],l=[],d=[],c=[],h=[],p=[];if(t.bImpo&&"Cylinder"==e.type){t.instancedMaterial=this.getInstancedMaterial("CylinderInstancing");let e=i.hashUtilsCls.hashvalue2array(s.attributes.position1.array),a=i.hashUtilsCls.hashvalue2array(s.attributes.color.array),u=i.hashUtilsCls.hashvalue2array(s.attributes.position2.array),m=i.hashUtilsCls.hashvalue2array(s.attributes.color2.array),f=i.hashUtilsCls.hashvalue2array(s.index.array),g=i.hashUtilsCls.hashvalue2array(s.attributes.radius.array),b=i.hashUtilsCls.hashvalue2array(s.attributes.mapping.array);r=r.concat(e),o=o.concat(a),h=h.concat(u),p=p.concat(m),l=l.concat(f),d=d.concat(g),c=c.concat(b),n.setAttribute("position1",new gs(new Float32Array(r),3)),n.setAttribute("color",new gs(new Float32Array(o),3)),n.setAttribute("position2",new gs(new Float32Array(h),3)),n.setAttribute("color2",new gs(new Float32Array(p),3)),n.setAttribute("radius",new gs(new Float32Array(d),1)),n.setAttribute("mapping",new gs(new Float32Array(c),3)),n.setIndex(new gs(new Uint32Array(l),1)),e=null,a=null,u=null,m=null,f=null,g=null,b=null}else if(t.bImpo&&"Sphere"==e.type){t.instancedMaterial=this.getInstancedMaterial("SphereInstancing");let e=i.hashUtilsCls.hashvalue2array(s.attributes.position.array),a=i.hashUtilsCls.hashvalue2array(s.attributes.color.array),h=i.hashUtilsCls.hashvalue2array(s.index.array),p=i.hashUtilsCls.hashvalue2array(s.attributes.radius.array),u=i.hashUtilsCls.hashvalue2array(s.attributes.mapping.array);r=r.concat(e),o=o.concat(a),l=l.concat(h),d=d.concat(p),c=c.concat(u),n.setAttribute("position",new gs(new Float32Array(r),3)),n.setAttribute("color",new gs(new Float32Array(o),3)),n.setAttribute("radius",new gs(new Float32Array(d),1)),n.setAttribute("mapping",new gs(new Float32Array(c),2)),n.setIndex(new gs(new Uint32Array(l),1)),e=null,a=null,h=null,p=null,u=null}else{t.instancedMaterial=this.getInstancedMaterial("Instancing");let e=s.attributes.position?i.hashUtilsCls.hashvalue2array(s.attributes.position.array):[],d=s.attributes.normal?i.hashUtilsCls.hashvalue2array(s.attributes.normal.array):[],c=s.attributes.color?i.hashUtilsCls.hashvalue2array(s.attributes.color.array):[],h=s.index?i.hashUtilsCls.hashvalue2array(s.index.array):[];r=r.concat(e),a=a.concat(d),o=o.concat(c),l=l.concat(h);let p=[],u="CylinderGeometry"==s.type?1:0;for(let e=0,t=r.length/3;e<t;++e)p.push(u);n.setAttribute("position",new gs(new Float32Array(r),3)),n.setAttribute("normal",new gs(new Float32Array(a),3)),n.setAttribute("color",new gs(new Float32Array(o),3)),n.setAttribute("cylinder",new gs(new Float32Array(p),1)),n.setIndex(new gs(new Uint32Array(l),1)),e=null,d=null,c=null,h=null}r=null,a=null,o=null,l=null,d=null,c=null,h=null,p=null;let u=new Tn(new Float32Array(t.matricesElements1),4),m=new Tn(new Float32Array(t.matricesElements2),4),f=new Tn(new Float32Array(t.matricesElements3),4),g=new Tn(new Float32Array(t.matricesElements4),4);return n.setAttribute("matrix1",u),n.setAttribute("matrix2",m),n.setAttribute("matrix3",f),n.setAttribute("matrix4",g),n}getInstancedMaterial(e){let t=this.icn3d;t.icn3dui;let i=new Vs({defines:t.defines,uniforms:t.uniforms,vertexShader:t.impostorCls.getShader(e+".vert"),fragmentShader:t.impostorCls.getShader(e+".frag"),depthTest:!0,depthWrite:!0,lights:!0});return i.extensions.fragDepth=!0,i.extensions.derivatives="#extension GL_OES_standard_derivatives : enable",i}createInstancedMesh(e){let t=this.icn3d;t.icn3dui;for(let i=0,s=e.children.length;i<s;++i){let s=e.children[i];if("Sprite"===s.type)continue;let n=this.createInstancedGeometry(s),r=new Hs(n,t.instancedMaterial);r.onBeforeRender=t.impostorCls.onBeforeRender,r.frustumCulled=!1,r.scale.x=r.scale.y=r.scale.z=1,r.type=s.type,n=null,e.add(r)}}drawSymmetryMatesInstancing(){let e=this.icn3d;if(e.icn3dui,void 0===e.biomtMatrices||0==e.biomtMatrices.length)return;let t=1,i=e.center.clone();if(e.impostorCls.setParametersForShader(),void 0===e.bSetInstancing||!e.bSetInstancing){e.matricesElements1=[],e.matricesElements2=[],e.matricesElements3=[],e.matricesElements4=[];let s=new gi;s.identity();for(let n=0;n<e.biomtMatrices.length&&1==Object.keys(e.structures).length;n++){let r=e.biomtMatrices[n];if(void 0===r)continue;let a=r.toArray();if(r.equals(s))continue;e.matricesElements1.push(a[0],a[1],a[2],a[3]),e.matricesElements2.push(a[4],a[5],a[6],a[7]),e.matricesElements3.push(a[8],a[9],a[10],a[11]),e.matricesElements4.push(a[12],a[13],a[14],a[15]);let o=e.center.clone();o.applyMatrix4(r),i.add(o),++t}}this.createInstancedMesh(e.mdl),this.createInstancedMesh(e.mdlImpostor),void 0!==e.bSetInstancing&&e.bSetInstancing?(e.maxD=e.maxDAssembly,e.center=e.centerAssembly.clone(),e.applyCenterCls.setCenter(e.center),e.cameraCls.setCamera()):(e.maxD*=Math.sqrt(t),e.center=e.ParserUtilsCls.getMassCenter(i,t),e.maxDAssembly=e.maxD,e.centerAssembly=e.center.clone(),e.applyCenterCls.setCenter(e.center),e.cameraCls.setCamera()),e.bSetInstancing=!0}}class $c{constructor(e){this.icn3d=e}async alternateStructures(){let e=this.icn3d,t=e.icn3dui;e.bAlternate=!0,-1==e.ALTERNATE_STRUCTURE&&(e.viewSelectionAtoms=t.hashUtilsCls.cloneHash(e.dAtoms));let i=Object.keys(e.viewSelectionAtoms).length,s=Object.keys(e.atoms).length,n={};for(let t in e.viewSelectionAtoms){n[e.atoms[t].structure]=1}let r=Object.keys(n);e.dAtoms={};let a=e.bScap;for(let i=0,s=r.length;i<s;++i){let n,o=r[i];if(e.bShift?(e.ALTERNATE_STRUCTURE<0&&(e.ALTERNATE_STRUCTURE=1),n=i==e.ALTERNATE_STRUCTURE%s-1||e.ALTERNATE_STRUCTURE%s===0&&i===s-1):n=i==e.ALTERNATE_STRUCTURE%s+1||e.ALTERNATE_STRUCTURE%s===s-1&&0===i,n){for(let i in e.structures[o]){let s=e.structures[o][i];e.dAtoms=t.hashUtilsCls.unionHash(e.dAtoms,e.chains[s])}e.bShift?--e.ALTERNATE_STRUCTURE:++e.ALTERNATE_STRUCTURE,e.ALTERNATE_STRUCTURE<0&&(e.ALTERNATE_STRUCTURE+=s);let n="";a&&(0==i?n="Wild Type ":1==i&&(n="Mutant ")),$("#"+e.pre+"title").html(n+o);break}}if(i<s){let i=t.hashUtilsCls.intHash(e.dAtoms,e.viewSelectionAtoms);Object.keys(i).length>0&&(e.dAtoms=t.hashUtilsCls.cloneHash(i)),e.bShowHighlight=!1}e.applyMapCls.removeSurfaces(),e.applyMapCls.applySurfaceOptions(),e.applyMapCls.removeMaps(),e.applyMapCls.applyMapOptions(),e.applyMapCls.removeEmmaps(),e.applyMapCls.applyEmmapOptions(),e.applyMapCls.removePhimaps(),e.applyMapCls.applyPhimapOptions(),e.applyMapCls.removeSurfaces(),e.applyMapCls.applyphisurfaceOptions(),e.axes=[],e.pc1&&e.axesCls.setPc1Axes(),e.opts.rotationcenter="highlight center",e.drawCls.draw(),e.bShowHighlight=!0}async alternateWrapper(){let e=this.icn3d;e.icn3dui,e.bAlternate=!0,await this.alternateStructures(),e.bAlternate=!1}}class Vc{constructor(e){this.icn3d=e}draw(e){let t=this.icn3d,i=t.icn3dui;if(t.impostorCls.clearImpostors(),!t.bRender||t.hAtoms&&0!=Object.keys(t.hAtoms)||(t.hAtoms=i.hashUtilsCls.cloneHash(t.atoms)),t.sceneCls.rebuildScene(),t.bImpo&&t.impostorCls.drawImpostorShader(),t.setColorCls.applyPrevColor(),void 0!==t.biomtMatrices&&t.biomtMatrices.length>1)if(t.bAssembly&&1==Object.keys(t.structures).length&&(void 0===i.cfg.mmdbid&&1==i.cfg.bu||void 0!==i.cfg.mmdbid&&1==i.cfg.bu&&Object.keys(t.atoms).length*t.biomtMatrices.length>t.maxatomcnt))t.instancingCls.drawSymmetryMates();else{let e=!0;t.applyCenterCls.centerSelection(void 0,e)}let s=void 0!==t.hAtoms?Object.keys(t.hAtoms).length:0;if(s>0&&s<Object.keys(t.dAtoms).length&&(t.hlObjectsCls.removeHlObjects(),(void 0===t.bShowHighlight||t.bShowHighlight)&&t.hlObjectsCls.addHlObjects()),!0===t.bRender&&((t.bInitial||$("#"+t.pre+"wait").is(":visible"))&&($("#"+t.pre+"wait")&&$("#"+t.pre+"wait").hide(),$("#"+t.pre+"canvas")&&$("#"+t.pre+"canvas").show(),$("#"+t.pre+"cmdlog")&&$("#"+t.pre+"cmdlog").show()),this.applyTransformation(t._zoomFactor,t.mouseChange,t.quaternion),this.render(e)),t.bOpm&&!i.cfg.chainalign){let e=i.utilsCls.getMemDesc();$("#"+t.pre+"dl_rmsd_html").html(e),i.cfg.bSidebyside||i.htmlCls.dialogCls.openDlg("dl_rmsd","Membranes")}}applyTransformation(e,t,i){let s=this.icn3d,n=s.icn3dui;if(n.bNode)return;let r={update:!1};r._zoomFactor=e,r.mouseChange=new pt,r.mouseChange.copy(t),r.quaternion=new ut,r.quaternion.copy(i),s.bControlGl&&!n.bNode?window.controls.update(r):s.controls.update(r)}render(e){let t=this.icn3d;t.icn3dui;let i=this;e?t.renderer.setAnimationLoop((function(){i.render_base()})):i.render_base()}handleController(e,t,i,s,n,r){let a=this.icn3d;a.icn3dui;try{let n=0;if(r&&(0!=r[0]&&0!=r[1]||0!=r[0]?n=r[0]:0!=r[1]&&(n=r[1])),void 0===n&&(n=0),i&&!s){let i=n/1e3*t;const s=5;if(0!=n){a.uistr+="dolly";const e=a.dolly.quaternion.clone();a.dummyCam.getWorldQuaternion(a.dolly.quaternion),a.dolly.translateZ(i*s),a.dolly.quaternion.copy(e)}else{e.children[0].scale.z=10,a.workingMatrix.identity().extractRotation(e.matrixWorld),a.raycasterVR.ray.origin.setFromMatrixPosition(e.matrixWorld),a.raycasterVR.ray.direction.set(0,0,-1).applyMatrix4(a.workingMatrix);const t=a.raycasterVR.intersectObjects(a.objects);if(t.length>0){e.children[0].scale.z=t[0].distance,t[0].point.sub(a.mdl.position);let i=a.rayThreshold,s=a.rayCls.getAtomsFromPosition(t[0].point,i);for(;!s&&i<10;)i+=.5,s=a.rayCls.getAtomsFromPosition(t[0].point,i);s&&(a.pAtomNum%2==0?a.pAtom=s:a.pAtom2=s,++a.pAtomNum,this.showPickingVr(a.pk,s))}}}}catch(e){}}showPickingVr(e,t){let i=this.icn3d;i.icn3dui,e||(e=2),i.hAtoms=i.pickingCls.getPickedAtomList(e,t),2===e?i.residueLabelsCls.addResidueLabels(i.hAtoms,void 0,void 0,!0):1===e&&i.residueLabelsCls.addAtomLabels(i.hAtoms),i.setOptionCls.setStyle("proteins",t.style)}render_base(){let e=this.icn3d,t=e.icn3dui,i=this;if(t.bNode)return;let s=e.bControlGl&&!t.bNode?window.cam:e.cam;if(e.directionalLight){let t=new ut;t.setFromUnitVectors(new mt(0,0,e.cam_z).normalize(),s.position.clone().normalize()),e.directionalLight.position.copy(e.lightPos.clone().applyQuaternion(t).normalize()),e.directionalLight2.position.copy(e.lightPos2.clone().applyQuaternion(t).normalize()),e.directionalLight3.position.copy(e.lightPos3.clone().applyQuaternion(t).normalize()),e.directionalLight.applyMatrix4(s.matrixWorld),e.directionalLight2.applyMatrix4(s.matrixWorld),e.directionalLight3.applyMatrix4(s.matrixWorld)}if(e.bVr||e.renderer.setPixelRatio(window.devicePixelRatio),e.bVr){let t=.04;if(e.controllers){let s=this.updateGamepadState();for(let n=0,r=e.controllers.length;n<r;++n){let r=e.controllers[n];r&&(t=n%2==0?t:-t,i.handleController(r,t,r.userData.selectPressed,r.userData.squeezePressed,s.xArray,s.yArray))}}e.renderer.xr.isPresenting&&(e.canvasUI&&e.canvasUI.update(),e.canvasUILog&&e.canvasUILog.update())}else e.bAr&&e.renderer.xr.isPresenting&&(e.gestures.update(),e.canvasUILog&&e.canvasUILog.update());e.scene&&(e.renderer.clear(),e.renderer.outputColorSpace=Be,"stereo"!=e.opts.effect||window.icn3duiHash?e.renderer.render(e.scene,s):e.effect.render(e.scene,s))}updateGamepadState(){let e=this.icn3d;e.icn3dui;let t=e.xAxisIndex?e.xAxisIndex:2,i=e.yAxisIndex?e.yAxisIndex:3;if(e.renderer.xr.isPresenting){const s=e.renderer.xr.getSession().inputSources;let n=[],r=[];return s.forEach((e=>{const s=e.gamepad.axes;let a=parseInt(1e3*s[t]),o=parseInt(-1e3*s[i]);n.push(a),r.push(o)})),{xArray:n,yArray:r}}return{xArray:[0,0],yArray:[0,0]}}}class Wc{constructor(e){this.icn3d=e}getAtomsWithinAtom(e,t,i,s,n,r,a){let o=this.icn3d,l=o.icn3dui,d=this.getNeighboringAtoms(e,t,i,a);s&&(o.resid2Residhash={});let c={};for(let e in t){let h=o.atoms[e];if(n&&"H"==h.elem)continue;let p,u,m=l.parasCls.vdwRadii[h.elem.toUpperCase()],f=h.structure+"_"+h.chain,g=h.structure+"_"+h.chain+"_"+h.resi;for(let e in o.residues[g])if(o.atoms[e]&&("CA"===o.atoms[e].name&&"C"===o.atoms[e].elem||"O3'"===o.atoms[e].name||"O3*"===o.atoms[e].name)){p=o.atoms[e];break}if(void 0===p&&(p=h),s){let e=0==h.name.indexOf("pi")&&h.ring?h.ring.join(","):h.serial;u=h.resn+" $"+h.structure+"."+h.chain+":"+h.resi+" "+e,void 0===o.resid2Residhash[u]&&(o.resid2Residhash[u]={})}let b=h.structure+"_"+h.chain+"_"+h.resi;for(let e in d){let g=d[e];if(n&&"H"==g.elem)continue;let C=l.parasCls.vdwRadii[g.elem.toUpperCase()],v=g.structure+"_"+g.chain;if(n&&!o.crossstrucinter&&h.structure!=g.structure)continue;if(!a&&g.serial in t)continue;if(o.bOpm&&"DUM"===g.resn)continue;let _=g.coord.distanceTo(h.coord);if(n&&_<m+C&&("N"===h.name||"C"===h.name||"O"===h.name||"CA"===h.name&&"C"===h.elem)&&("N"===g.name||"C"===g.name||"O"===g.name||"CA"===g.name&&"C"===g.elem)&&(o.chainid2clashedResidpair||(o.chainid2clashedResidpair={}),o.chainid2clashedResidpair[f+"_"+h.resi+"|"+v+"_"+g.resi]="0|0"),_<i){let e,t;c[g.serial]=g,n&&(c[h.serial]=h);let i=g.structure+"_"+g.chain+"_"+g.resi;for(let t in o.residues[i])if("CA"===o.atoms[t].name&&"C"===o.atoms[t].elem||"O3'"===o.atoms[t].name||"O3*"===o.atoms[t].name){e=o.atoms[t];break}if(void 0===e&&(e=g),n&&(o.contactpnts.push({serial:e.serial,coord:e.coord}),o.contactpnts.push({serial:p.serial,coord:p.coord})),s){let i=g.structure+"_"+g.chain+"_"+g.resi,s=0==g.name.indexOf("pi")&&g.ring?g.ring.join(","):g.serial;t=g.resn+" $"+g.structure+"."+g.chain+":"+g.resi+" "+s;let n=_.toFixed(1),a=e.coord.distanceTo(p.coord).toFixed(1),l=b+"_"+h.resn+","+i+"_"+g.resn,d=u+"|"+t;if((void 0===o.resids2interAll[l]||void 0===o.resids2interAll[l].contact||!o.resids2interAll[l].contact.hasOwnProperty(d)||void 0!==o.resids2interAll[l].hbond&&!o.resids2interAll[l].hbond.hasOwnProperty(d)||void 0!==o.resids2interAll[l].ionic&&!o.resids2interAll[l].ionic.hasOwnProperty(d)||void 0!==o.resids2interAll[l].halogen&&!o.resids2interAll[l].halogen.hasOwnProperty(d)||void 0!==o.resids2interAll[l]["pi-cation"]&&!o.resids2interAll[l]["pi-cation"].hasOwnProperty(d)||void 0!==o.resids2interAll[l]["pi-stacking"]&&!o.resids2interAll[l]["pi-stacking"].hasOwnProperty(d))&&(void 0===o.resid2Residhash[u][t]||n<o.resid2Residhash[u][t].split("_")[0])){let e=void 0===o.resid2Residhash[u][t]?1:parseInt(o.resid2Residhash[u][t].split("_")[4])+1;o.resid2Residhash[u][t]=n+"_"+a+"_"+h.name+"_"+g.name+"_"+e,r||(void 0===o.resids2inter[l]&&(o.resids2inter[l]={}),void 0===o.resids2inter[l].contact&&(o.resids2inter[l].contact={}),o.resids2inter[l].contact[u+"|"+t]=n+"_"+a+"_"+h.name+"_"+g.name+"_"+e),void 0===o.resids2interAll[l]&&(o.resids2interAll[l]={}),void 0===o.resids2interAll[l].contact&&(o.resids2interAll[l].contact={}),o.resids2interAll[l].contact[u+"|"+t]=n+"_"+a+"_"+h.name+"_"+g.name+"_"+e}}}}}return c}getNeighboringAtoms(e,t,i,s){let n=this.icn3d;n.icn3dui;let r=this.getExtent(t),a=(r[2][0]-r[0][0])*(r[2][0]-r[0][0])+(r[2][1]-r[0][1])*(r[2][1]-r[0][1])+(r[2][2]-r[0][2])*(r[2][2]-r[0][2]),o=(r[2][0]-r[1][0])*(r[2][0]-r[1][0])+(r[2][1]-r[1][1])*(r[2][1]-r[1][1])+(r[2][2]-r[1][2])*(r[2][2]-r[1][2]),l=a>o?a:o,d=Math.sqrt(l),c=(d+i)*(d+i),h={};for(let a in e){let e=n.atoms[a];!s&&t.hasOwnProperty(e.serial)||(this.bOpm&&"DUM"===e.resn||e.coord.x<r[0][0]-i||e.coord.x>r[1][0]+i||e.coord.y<r[0][1]-i||e.coord.y>r[1][1]+i||e.coord.z<r[0][2]-i||e.coord.z>r[1][2]+i||(e.coord.x-r[2][0])*(e.coord.x-r[2][0])+(e.coord.y-r[2][1])*(e.coord.y-r[2][1])+(e.coord.z-r[2][2])*(e.coord.z-r[2][2])<c&&(h[e.serial]=e))}return h}getExtent(e){let t,i,s,n,r,a,o,l,d,c,h,p=this.icn3d;for(h in p.icn3dui,t=i=s=9999,n=r=a=-9999,o=l=d=c=0,e){let e=p.atoms[h];c++,o+=e.coord.x,l+=e.coord.y,d+=e.coord.z,t=t<e.coord.x?t:e.coord.x,i=i<e.coord.y?i:e.coord.y,s=s<e.coord.z?s:e.coord.z,n=n>e.coord.x?n:e.coord.x,r=r>e.coord.y?r:e.coord.y,a=a>e.coord.z?a:e.coord.z}return[[t,i,s],[n,r,a],[o/c,l/c,d/c]]}hideContact(){let e=this.icn3d;e.icn3dui,e.opts.contact="no",void 0===e.lines&&(e.lines={}),e.lines.contact=[],e.contactpnts=[]}}class Xc{constructor(e){this.icn3d=e}isHbondDonorAcceptor(e){let t=this.icn3d;if(t.icn3dui,"N"==e.name&&!e.het||"N"==e.elem&&"Arg"==e.resn||"N"==e.elem&&"Asn"==e.resn||"N"==e.elem&&"Gln"==e.resn||"N"==e.elem&&"Lys"==e.resn||"N"==e.elem&&"Trp"==e.resn)return"donor";if("O"==e.name&&!e.het||"S"==e.elem&&"Met"==e.resn||"O"==e.elem&&"Asn"==e.resn||"O"==e.elem&&"Asp"==e.resn||"O"==e.elem&&"Gln"==e.resn||"O"==e.elem&&"Glu"==e.resn)return"acceptor";if("S"==e.elem&&"Cys"==e.resn||"N"==e.elem&&"His"==e.resn||"O"==e.elem&&"Ser"==e.resn||"O"==e.elem&&"Thr"==e.resn||"O"==e.elem&&"Tyr"==e.resn)return"both";if("Pro"==e.resn)return"none";if("N"==e.elem){if("Asn"==e.resn||"Gln"==e.resn)return"both";let i=0,s=0;for(let s=0,n=e.bonds.length;s<n;++s)"H"==t.atoms[e.bonds[s]].elem&&++i;if(2==i)return"donor";i=0;for(let n=0,r=e.bonds.length;n<r;++n){let r=t.atoms[e.bonds[n]];if("H"!=r.elem){++i;for(let e=0,i=r.bonds.length;e<i;++e)"N"==t.atoms[r.bonds[e]].elem&&++s}}return 1==i?"donor":2==i?s>1?"ring":"donor":"none"}if("O"==e.elem&&1==e.bonds.length){if("Asn"==e.resn||"Gln"==e.resn)return"both";for(let i=0,s=e.bonds.length;i<s;++i)if("H"==t.atoms[e.bonds[i]].elem)return"donor";let i=t.atoms[e.bonds[0]],s=0;for(let e=0,n=i.bonds.length;e<n;++e)"O"!=t.atoms[i.bonds[e]].elem&&"N"!=t.atoms[i.bonds[e]].elem&&"S"!=t.atoms[i.bonds[e]].elem||++s;return s>=2?"acceptor":"both"}if("O"==e.elem&&2==e.bonds.length){for(let i=0,s=e.bonds.length;i<s;++i)if("H"==t.atoms[e.bonds[i]].elem)return"donor";return"acceptor"}return"both"}calcAngles(e,t){let i=this.icn3d;i.icn3dui;let s=[],n=new mt,r=new mt;n.subVectors(t.coord,e.coord);for(let t=0,a=e.bonds.length;t<a;++t)"H"!=i.atoms[e.bonds[t]].elem&&(r.subVectors(i.atoms[e.bonds[t]].coord,e.coord),s.push(n.angleTo(r)));return s}calcPlaneAngle(e,t){let i=this.icn3d;i.icn3dui;let s=e,n=new mt;n.subVectors(t.coord,e.coord);let r=[new mt,new mt],a=0;for(let t=0,n=e.bonds.length;t<n&&!(a>1);++t)"H"!=i.atoms[e.bonds[t]].elem&&(s=i.atoms[e.bonds[t]],r[a++].subVectors(i.atoms[e.bonds[t]].coord,e.coord));if(1===a)for(let t=0,n=s.bonds.length;t<n&&!(a>1);++t)"H"!=i.atoms[s.bonds[t]].elem&&i.atoms[s.bonds[t]].serial!=e.serial&&r[a++].subVectors(i.atoms[s.bonds[t]].coord,e.coord);if(2!==a)return;let o=r[0].cross(r[1]);return Math.abs(Math.PI/2-o.angleTo(n))}isValidHbond(e,t,i){let s=this.icn3d;s.icn3dui;let n,r,a=this.isHbondDonorAcceptor(e),o=this.isHbondDonorAcceptor(t),l=50*Math.PI/180,d=50*Math.PI/180,c=90*Math.PI/180,h=30*Math.PI/180;if("donor"==a&&("acceptor"==o||"both"==o||"ring"==o)||"acceptor"==o&&("donor"==a||"both"==a||"ring"==a))n=e,r=t;else if("acceptor"==a&&("donor"==o||"both"==o||"ring"==o)||"donor"==o&&("acceptor"==a||"both"==a||"ring"==a))r=e,n=t;else{if("both"!=a&&"ring"!=a||"both"!=o&&"ring"!=o)return!1;n=e,r=t,s.nucleotides.hasOwnProperty(e.serial)&&s.nucleotides.hasOwnProperty(t.serial)&&("ring"==a||"ring"==o)||(e.het||t.het)&&"ring"==a&&"ring"==o||(h=90*Math.PI/180)}let p=this.calcAngles(n,r),u=90*Math.PI/180;for(let e=0,t=p.length;e<t;++e)if(Math.abs(u-p[e])>d)return!1;let m=this.calcPlaneAngle(n,r);if(void 0!==m&&m>h)return!1;let f=this.calcAngles(r,n),g=90*Math.PI/180;for(let e=0,t=f.length;e<t;++e)if(Math.abs(g-f[e])>l)return!1;let b=this.calcPlaneAngle(r,n);return!(void 0!==b&&b>c)}calculateChemicalHbonds(e,t,i,s,n,r){let a=this.icn3d,o=a.icn3dui;if(0===Object.keys(e).length||0===Object.keys(t).length)return;a.resid2Residhash={};let l,d,c={},h=i*i;for(let t in e){let i=e[t],n=s?"LYS"===i.resn&&"N"===i.elem&&"N"!==i.name||"ARG"===i.resn&&("NH1"===i.name||"NH2"===i.name)||("GLU"===i.resn||"ASP"===i.resn)&&"O"===i.elem&&"O"!==i.name||i.het&&("N"===i.elem||"O"===i.elem||"S"===i.elem):"N"===i.elem||"O"===i.elem||"S"===i.elem&&(i.het||"Cys"===i.resn||"Met"===i.resn);n=a.bOpm?n&&"DUM"!==i.resn:n,n&&(l=i.structure+"_"+i.chain+"_"+i.resi,d=l+"_"+i.name,c[d]=i)}let p={},u={},m=.5,f=-27.888,g={};for(let e in t){let b=t[e],C=s?"LYS"===b.resn&&"N"===b.elem&&"N"!==b.name||"ARG"===b.resn&&("NH1"===b.name||"NH2"===b.name)||("GLU"===b.resn||"ASP"===b.resn)&&"O"===b.elem&&"O"!==b.name||b.het&&("N"===b.elem||"O"===b.elem||"S"===b.elem):"N"===b.elem||"O"===b.elem||"S"===b.elem&&(b.het||"Cys"===b.resn||"Met"===b.resn);if(C=a.bOpm?C&&"DUM"!==b.resn:C,C){l=b.structure+"_"+b.chain+"_"+b.resi,d=l+"_"+b.name;let e=0==b.name.indexOf("pi")&&b.ring?b.ring.join(","):b.serial,t=b.resn+" $"+b.structure+"."+b.chain+":"+b.resi+"@"+b.name+" "+e;void 0===a.resid2Residhash[t]&&(a.resid2Residhash[t]={});for(let e in c){if(s&&!(("LYS"!==b.resn&&"ARG"!==b.resn||"LYS"!==c[e].resn&&"ARG"!==c[e].resn)&&("GLU"!==b.resn&&"ASP"!==b.resn||"GLU"!==c[e].resn&&"ASP"!==c[e].resn)))continue;if(!a.crossstrucinter&&b.structure!=c[e].structure)continue;if(l==e.substr(0,e.lastIndexOf("_")))continue;let d=Math.abs(b.coord.x-c[e].coord.x);if(d>i)continue;let C=Math.abs(b.coord.y-c[e].coord.y);if(C>i)continue;let v=Math.abs(b.coord.z-c[e].coord.z);if(v>i)continue;let _=d*d+C*C+v*v;if(_>h)continue;if(!a.proteins.hasOwnProperty(b.serial)||!a.proteins.hasOwnProperty(c[e].serial)||"N"!==b.name&&"O"!==b.name||"O"!==c[e].name&&"N"!==c[e].name){if(!this.isValidHbond(b,c[e],i))continue}else{if(b.name===c[e].name)continue;if(b.structure==c[e].structure&&b.chain==c[e].chain&&Math.abs(b.resi-c[e].resi)<=1)continue;let t,s="N"===b.name?b:c[e],n="O"===b.name?b:c[e];if("Pro"===s.resn)continue;if(void 0===s.hcoord){if(!this.isValidHbond(b,c[e],i))continue}else{let i,r=s.hcoord,o=s.coord,l=n.structure+"_"+n.chain+"_"+n.resi;for(let e in a.residues[l])if("C"===a.atoms[e].name){i=a.atoms[e];break}if(!i)continue;let d=i.coord,h=n.coord,p=r.distanceTo(h),u=r.distanceTo(d),g=o.distanceTo(d),C=o.distanceTo(h);t=p<m||u<m||g<m||C<m?-9.9:f/p-f/u+f/g-f/C,"helix"==b.ss&&c[e].ss}}if(g[b.serial]>2||g[c[e].serial]>2)continue;void 0===g[b.serial]?g[b.serial]=1:++g[b.serial],void 0===g[c[e].serial]?g[c[e].serial]=1:++g[c[e].serial],"graph"!==n&&(s?(a.saltbridgepnts.push({serial:b.serial,coord:b.coord}),a.saltbridgepnts.push({serial:c[e].serial,coord:c[e].coord})):(a.hbondpnts.push({serial:b.serial,coord:b.coord}),a.hbondpnts.push({serial:c[e].serial,coord:c[e].coord})));let y=c[e].structure+"_"+c[e].chain+"_"+c[e].resi;p=o.hashUtilsCls.unionHash(p,a.residues[l]),p=o.hashUtilsCls.unionHash(p,a.residues[y]),u[l]=1,u[y]=1;let S=0==c[e].name.indexOf("pi")&&c[e].ring?c[e].ring.join(","):c[e].serial,w=c[e].resn+" $"+c[e].structure+"."+c[e].chain+":"+c[e].resi+"@"+c[e].name+" "+S,x=l+"_"+b.resn+","+y+"_"+c[e].resn;void 0!==a.resids2interAll[x]&&void 0!==a.resids2interAll[x].ionic&&a.resids2interAll[x].ionic.hasOwnProperty(t+"|"+w)||(a.resid2Residhash[t][w]=_.toFixed(1),r||(void 0===a.resids2inter[x]&&(a.resids2inter[x]={}),void 0===a.resids2inter[x].hbond&&(a.resids2inter[x].hbond={}),a.resids2inter[x].hbond[t+"|"+w]=_.toFixed(1)),void 0===a.resids2interAll[x]&&(a.resids2interAll[x]={}),void 0===a.resids2interAll[x].hbond&&(a.resids2interAll[x].hbond={}),a.resids2interAll[x].hbond[t+"|"+w]=_.toFixed(1))}}}let b=Object.keys(u);if("graph"!==n)for(let e=0,t=b.length;e<t;++e)for(let t in a.residues[b[e]])a.atoms[t].style2="stick";return p}setHbondsContacts(e,t){let i=this.icn3d;i.icn3dui;let s=t,n="hbond"==t?"hbonds":t;if(i.lines[s]=[],"yes"===e[n].toLowerCase()){let e,n;"hbond"==t?(n=i.hbondpnts,e="#0F0"):"saltbridge"==t?(n=i.saltbridgepnts,e="#0FF"):"contact"==t?(n=i.contactpnts,e="#888"):"halogen"==t?(n=i.halogenpnts,e="#F0F"):"pi-cation"==t?(n=i.picationpnts,e="#F00"):"pi-stacking"==t&&(n=i.pistackingpnts,e="#00F");for(let t=0,r=Math.floor(n.length/2);t<r;t++){let r={};r.position1=n[2*t].coord,r.serial1=n[2*t].serial,r.position2=n[2*t+1].coord,r.serial2=n[2*t+1].serial,r.color=e,r.dashed=!0,(void 0===r.serial1||void 0===r.serial2||i.dAtoms.hasOwnProperty(r.serial1)||i.dAtoms.hasOwnProperty(r.serial2))&&i.lines[s].push(r)}}}hideHbonds(){let e=this.icn3d;e.icn3dui,e.opts.hbonds="no",void 0===e.lines&&(e.lines={}),e.lines.hbond=[],e.hbondpnts=[]}}class Yc{constructor(e){this.icn3d=e}calculateHalogenPiInteractions(e,t,i,s,n,r){let a=this.icn3d,o=a.icn3dui;if(0===Object.keys(e).length||0===Object.keys(t).length)return;let l={},d={},c={},h={};if("halogen"==n){for(let t in e){let i=e[t];l=o.hashUtilsCls.unionHash(l,this.getHalogenDonar(i)),c=o.hashUtilsCls.unionHash(c,this.getHalogenAcceptor(i))}for(let e in t){let i=t[e];h=o.hashUtilsCls.unionHash(h,this.getHalogenDonar(i)),d=o.hashUtilsCls.unionHash(d,this.getHalogenAcceptor(i))}}else if("pi-cation"==n){a.processedRes={};for(let t in e){let i=e[t];l=o.hashUtilsCls.unionHash(l,this.getPi(i,!1)),c=o.hashUtilsCls.unionHash(c,this.getCation(i))}a.processedRes={};for(let e in t){let i=t[e];h=o.hashUtilsCls.unionHash(h,this.getPi(i,!1)),d=o.hashUtilsCls.unionHash(d,this.getCation(i))}}else if("pi-stacking"==n){a.processedRes={};for(let t in e){let i=e[t];l=o.hashUtilsCls.unionHash(l,this.getPi(i,!0))}a.processedRes={};for(let e in t){let i=t[e];d=o.hashUtilsCls.unionHash(d,this.getPi(i,!0))}}let p={},u={};a.resid2Residhash={};let m=i*i;for(let e in l){let t=l[e],c=0==t.name.indexOf("pi")&&t.ring?t.ring.join(","):t.serial,h=t.resn+" $"+t.structure+"."+t.chain+":"+t.resi+"@"+t.name+" "+c;void 0===a.resid2Residhash[h]&&(a.resid2Residhash[h]={});for(let l in d){let c=d[l];if((a.crossstrucinter||t.structure==c.structure)&&e.substr(0,e.lastIndexOf("_"))!=l.substr(0,l.lastIndexOf("_"))){if("pi-cation"==n&&"ARG"===c.resn&&"NH1"===c.name){let e=c.structure+"_"+c.chain+"_"+c.resi,t=a.firstAtomObjCls.getFirstAtomObjByName(a.residues[e],"NH2"),i=c.coord.clone().add(t.coord).multiplyScalar(.5);c=o.hashUtilsCls.cloneHash(c),c.coord=i}"pi-stacking"==n&&void 0!==t.normal&&void 0!==c.normal&&Math.abs(t.normal.dot(c.normal)),this.getHalogenPiInteractions(t,c,s,n,i,m,h,r)&&(p=o.hashUtilsCls.unionHash(p,a.residues[t.structure+"_"+t.chain+"_"+t.resi]),p=o.hashUtilsCls.unionHash(p,a.residues[c.structure+"_"+c.chain+"_"+c.resi]),u[t.structure+"_"+t.chain+"_"+t.resi]=1,u[c.structure+"_"+c.chain+"_"+c.resi]=1)}}}for(let e in c){let t=c[e],l=0==t.name.indexOf("pi")&&t.ring?t.ring.join(","):t.serial,d=t.resn+" $"+t.structure+"."+t.chain+":"+t.resi+"@"+t.name+" "+l;if(void 0===a.resid2Residhash[d]&&(a.resid2Residhash[d]={}),"pi-cation"==n&&"ARG"===t.resn&&"NH1"===t.name){let e=t.structure+"_"+t.chain+"_"+t.resi,i=a.firstAtomObjCls.getFirstAtomObjByName(a.residues[e],"NH2"),s=t.coord.clone().add(i.coord).multiplyScalar(.5);t=o.hashUtilsCls.cloneHash(t),t.coord=s}for(let l in h){let c=h[l];(a.crossstrucinter||t.structure==c.structure)&&(e.substr(0,e.lastIndexOf("_"))!=l.substr(0,l.lastIndexOf("_"))&&this.getHalogenPiInteractions(t,c,s,n,i,m,d,r)&&(p=o.hashUtilsCls.unionHash(p,a.residues[t.structure+"_"+t.chain+"_"+t.resi]),p=o.hashUtilsCls.unionHash(p,a.residues[c.structure+"_"+c.chain+"_"+c.resi]),u[t.structure+"_"+t.chain+"_"+t.resi]=1,u[c.structure+"_"+c.chain+"_"+c.resi]=1))}}let f=Object.keys(u);if("graph"!==s)for(let e=0,t=f.length;e<t;++e)for(let t in a.residues[f[e]])a.atoms[t].style2="stick",a.ions.hasOwnProperty(t)&&(a.atoms[t].style2="sphere");return p}getHalogenDonar(e){this.icn3d.icn3dui;let t={};if("CL"===e.elem||"BR"===e.elem||"I"===e.elem){t[e.structure+"_"+e.chain+"_"+e.resi+"_"+e.name]=e}return t}getHalogenAcceptor(e){let t=this.icn3d;t.icn3dui;let i={},s="N"===e.elem||"O"===e.elem||"S"===e.elem;if(s=t.bOpm?s&&"DUM"!==e.resn:s,s){i[e.structure+"_"+e.chain+"_"+e.resi+"_"+e.name]=e}return i}getPi(e,t){let i=this.icn3d,s=i.icn3dui,n={},r=e.structure+"_"+e.chain+"_"+e.resi,a=e.het||i.nucleotides.hasOwnProperty(e.serial)||"PHE"===e.resn||"TYR"===e.resn||"TRP"===e.resn;if(t&&(a=a||"HIS"===e.resn),a&&!i.processedRes.hasOwnProperty(r)){if(e.het){let e=this.getAromaticPisLigand(r);n=s.hashUtilsCls.unionHash(n,e)}else{let t,s,a;a=i.nucleotides.hasOwnProperty(e.serial)?this.getAromaticRings(e.resn,r,"nucleotide"):this.getAromaticRings(e.resn,r,"protein"),void 0!==a&&(t=a.piPosArray,s=a.normalArray);for(let i=0,a=t.length;i<a;++i)n[r+"_pi"+i]={resn:e.resn,name:"pi"+i,coord:t[i],serial:e.serial,structure:e.structure,chain:e.chain,resi:e.resi,normal:s[i]}}i.processedRes[r]=1}return n}getCation(e){let t=this.icn3d,i=t.icn3dui,s={};if("ARG"===e.resn&&"NH2"===e.name)return;let n="LYS"===e.resn&&"N"===e.elem&&"N"!==e.name||"ARG"===e.resn&&("NH1"===e.name||"NH2"===e.name)||e.het&&-1!==i.parasCls.cationsTrimArray.indexOf(e.elem)||e.het&&"N"===e.elem&&(1==e.bonds.length||4==e.bonds.length);if(n=t.bOpm?n&&"DUM"!==e.resn:n,n){s[e.structure+"_"+e.chain+"_"+e.resi+"_"+e.name]=e}return s}getHalogenPiInteractions(e,t,i,s,n,r,a,o){let l=this.icn3d;l.icn3dui;let d=Math.abs(e.coord.x-t.coord.x);if(d>n)return!1;let c=Math.abs(e.coord.y-t.coord.y);if(c>n)return!1;let h=Math.abs(e.coord.z-t.coord.z);if(h>n)return!1;let p=d*d+c*c+h*h;if(p>r)return!1;"graph"!==i&&("halogen"==s?(l.halogenpnts.push({serial:e.serial,coord:e.coord}),l.halogenpnts.push({serial:t.serial,coord:t.coord})):"pi-cation"==s?(l.picationpnts.push({serial:e.serial,coord:e.coord}),l.picationpnts.push({serial:t.serial,coord:t.coord})):"pi-stacking"==s&&(l.pistackingpnts.push({serial:e.serial,coord:e.coord}),l.pistackingpnts.push({serial:t.serial,coord:t.coord})));let u=0==t.name.indexOf("pi")&&t.ring?t.ring.join(","):t.serial,m=t.resn+" $"+t.structure+"."+t.chain+":"+t.resi+"@"+t.name+" "+u;l.resid2Residhash[a][m]=p.toFixed(1);let f=e.structure+"_"+e.chain+"_"+e.resi+"_"+e.resn+","+t.structure+"_"+t.chain+"_"+t.resi+"_"+t.resn;return o||(void 0===l.resids2inter[f]&&(l.resids2inter[f]={}),void 0===l.resids2inter[f][s]&&(l.resids2inter[f][s]={}),l.resids2inter[f][s][a+"|"+m]=p.toFixed(1)),void 0===l.resids2interAll[f]&&(l.resids2interAll[f]={}),void 0===l.resids2interAll[f][s]&&(l.resids2interAll[f][s]={}),l.resids2interAll[f][s][a+"|"+m]=p.toFixed(1),!0}getRingNormal(e){if(this.icn3d.icn3dui,e.length<3)return;let t=e[0].clone().sub(e[1]),i=e[1].clone().sub(e[2]);return t.cross(i).normalize()}getAromaticRings(e,t,i){let s=this.icn3d;s.icn3dui;let n=[],r=[],a=[],o=[];if("nucleotide"==i){let i=new mt,l=new mt;if("A"==e.trim().toUpperCase()||"DA"==e.trim().toUpperCase()||"G"==e.trim().toUpperCase()||"DG"==e.trim().toUpperCase()){for(let e in s.residues[t]){let t=s.atoms[e];"N1"==t.name||"C2"==t.name||"N3"==t.name||"C6"==t.name?(i.add(t.coord),a.push(t.coord)):"C4"==t.name||"C5"==t.name?(i.add(t.coord),l.add(t.coord),a.push(t.coord),o.push(t.coord)):"N7"!=t.name&&"C8"!=t.name&&"N9"!=t.name||(l.add(t.coord),o.push(t.coord))}6==a.length&&(i.multiplyScalar(1/6),n.push(i),r.push(this.getRingNormal(a))),5==o.length&&(l.multiplyScalar(.2),n.push(l),r.push(this.getRingNormal(o)))}else if("C"==e.trim().toUpperCase()||"DC"==e.trim().toUpperCase()||"T"==e.trim().toUpperCase()||"DT"==e.trim().toUpperCase()||"U"==e.trim().toUpperCase()||"DU"==e.trim().toUpperCase()){for(let e in s.residues[t]){let t=s.atoms[e];"N1"==t.name||"C2"==t.name||"N3"==t.name||"C6"==t.name?(i.add(t.coord),a.push(t.coord)):"C4"!=t.name&&"C5"!=t.name||(i.add(t.coord),a.push(t.coord))}6==a.length&&(i.multiplyScalar(1/6),n.push(i),r.push(this.getRingNormal(a)))}}else if("protein"==i){let i=new mt,l=new mt;if("PHE"==e.toUpperCase()||"TYR"==e.toUpperCase()){for(let e in s.residues[t]){let t=s.atoms[e];"CG"!=t.name&&"CD1"!=t.name&&"CE1"!=t.name&&"CZ"!=t.name&&"CE2"!=t.name&&"CD2"!=t.name||(i.add(t.coord),a.push(t.coord))}6==a.length&&(i.multiplyScalar(1/6),n.push(i),r.push(this.getRingNormal(a)))}else if("HIS"==e.toUpperCase()){for(let e in s.residues[t]){let t=s.atoms[e];"CG"!=t.name&&"ND1"!=t.name&&"CE1"!=t.name&&"NE2"!=t.name&&"CD2"!=t.name||(i.add(t.coord),a.push(t.coord))}5==a.length&&(i.multiplyScalar(.2),n.push(i),r.push(this.getRingNormal(a)))}else if("TRP"==e.toUpperCase()){for(let e in s.residues[t]){let t=s.atoms[e];"CZ2"==t.name||"CH2"==t.name||"CZ3"==t.name||"CE3"==t.name?(i.add(t.coord),a.push(t.coord)):"CD2"==t.name||"CE2"==t.name?(i.add(t.coord),l.add(t.coord),a.push(t.coord),o.push(t.coord)):"CG"!=t.name&&"CD1"!=t.name&&"NE1"!=t.name||(l.add(t.coord),o.push(t.coord))}6==a.length&&(i.multiplyScalar(1/6),n.push(i),r.push(this.getRingNormal(a))),5==o.length&&(l.multiplyScalar(.2),n.push(l),r.push(this.getRingNormal(o)))}}return{piPosArray:n,normalArray:r}}dfs_cycle(e,t,i){let s=this.icn3d;if(s.icn3dui,2==s.ring_color[e])return i;if(1==s.ring_color[e]){i++;let n=t;for(s.ring_mark[n]=i;n!=e;)n=s.ring_par[n],s.ring_mark[n]=i;return i}if(s.ring_par[e]=t,s.ring_color[e]=1,void 0!==s.atoms[e])for(let t=0,n=s.atoms[e].bonds.length;t<n;++t){let n=s.atoms[e].bonds[t];n!=s.ring_par[e]&&(i=this.dfs_cycle(n,e,i))}return s.ring_color[e]=2,i}getAromaticPisLigand(e){let t=this.icn3d;t.icn3dui;let i={},s=Object.keys(t.residues[e]),n=s.length;t.ring_color={},t.ring_par={},t.ring_mark={};let r=0;r=this.dfs_cycle(s[1],s[0],r);let a={};for(let e=0;e<n;e++){let i=s[e];t.ring_mark[i]&&(void 0===a[t.ring_mark[i]]&&(a[t.ring_mark[i]]=[]),a[t.ring_mark[i]].push(i))}for(let s=1;s<=r;s++){let n,r=new mt,o=0,l=[],d=[];if(a.hasOwnProperty(s))for(let e=0,i=a[s].length;e<i;++e)n=a[s][e],r.add(t.atoms[n].coord),l.push(t.atoms[n].coord),d.push(n),++o;if(o>=3&&o<=6&&l[0]&&l[1]&&l[2]&&l[3]){let s=l[0].clone().sub(l[1]).normalize(),a=l[1].clone().sub(l[2]).normalize(),c=l[2].clone().sub(l[3]).normalize(),h=s.cross(a).normalize(),p=h.dot(c);if(Math.abs(p)<.052){r.multiplyScalar(1/o);let s=t.atoms[n];i[e+"_pi"+n]={resn:s.resn,name:"pi"+n,coord:r,serial:s.serial,structure:s.structure,chain:s.chain,resi:s.resi,normal:h,ring:d}}}}return i}hideHalogenPi(){let e=this.icn3d;e.icn3dui,e.opts.halogen="no",e.opts["pi-cation"]="no",e.opts["pi-stacking"]="no",void 0===e.lines&&(e.lines={}),e.lines.halogen=[],e.lines["pi-cation"]=[],e.lines["pi-stacking"]=[],e.halogenpnts=[],e.picationpnts=[],e.pistackingpnts=[]}}class Kc{constructor(e){this.icn3d=e}calculateIonicInteractions(e,t,i,s,n,r){let a=this.icn3d,o=a.icn3dui;if(0===Object.keys(e).length||0===Object.keys(t).length)return;a.resid2Residhash={};let l,d,c={},h={},p=i*i;for(let t in e){let i=e[t];if("ARG"===i.resn&&"NH2"===i.name||"GLU"===i.resn&&"OE2"===i.name||"ASP"===i.resn&&"OD2"===i.name)continue;let s=("LYS"===i.resn||"HIS"===i.resn)&&"N"===i.elem&&"N"!==i.name||"ARG"===i.resn&&("NH1"===i.name||"NH2"===i.name)||i.het&&-1!==o.parasCls.cationsTrimArray.indexOf(i.elem)||i.het&&"N"===i.elem&&1==i.bonds.length,n=this.isAnion(i);s=a.bOpm?s&&"DUM"!==i.resn:s,n=a.bOpm?n&&"DUM"!==i.resn:n,(s||n)&&(l=i.structure+"_"+i.chain+"_"+i.resi,d=l+"_"+i.name,s&&(c[d]=i),n&&(h[d]=i))}let u={},m={};for(let e in t){let s=t[e];if("ARG"===s.resn&&"NH2"===s.name||"GLU"===s.resn&&"OE2"===s.name||"ASP"===s.resn&&"OD2"===s.name)continue;let f=("LYS"===s.resn||"HIS"===s.resn)&&"N"===s.elem&&"N"!==s.name||"ARG"===s.resn&&("NH1"===s.name||"NH2"===s.name)||s.het&&-1!==o.parasCls.cationsTrimArray.indexOf(s.elem),g=this.isAnion(s);if(f=a.bOpm?f&&"DUM"!==s.resn:f,g=a.bOpm?g&&"DUM"!==s.resn:g,f||g){l=s.structure+"_"+s.chain+"_"+s.resi,d=l+"_"+s.name;let e=0==s.name.indexOf("pi")&&s.ring?s.ring.join(","):s.serial,t=s.resn+" $"+s.structure+"."+s.chain+":"+s.resi+"@"+s.name+" "+e;void 0===a.resid2Residhash[t]&&(a.resid2Residhash[t]={});let b={};f?b=h:g&&(b=c);let C,v=s.structure+"_"+s.chain+"_"+s.resi;f&&"ARG"===s.resn&&"NH1"===s.name?C=a.firstAtomObjCls.getFirstAtomObjByName(a.residues[v],"NH2"):g&&"GLU"===s.resn&&"OE1"===s.name?C=a.firstAtomObjCls.getFirstAtomObjByName(a.residues[v],"OE2"):g&&"ASP"===s.resn&&"OD1"===s.name&&(C=a.firstAtomObjCls.getFirstAtomObjByName(a.residues[v],"OD2"));let _=void 0===C?s.coord:s.coord.clone().add(C.coord).multiplyScalar(.5);for(let e in b){if(l==e.substr(0,e.lastIndexOf("_")))continue;if(!a.crossstrucinter&&s.structure!=b[e].structure)continue;let d,c=b[e].structure+"_"+b[e].chain+"_"+b[e].resi;g&&"ARG"===b[e].resn&&"NH1"===b[e].name?d=a.firstAtomObjCls.getFirstAtomObjByName(a.residues[c],"NH2"):f&&"GLU"===b[e].resn&&"OE1"===b[e].name?d=a.firstAtomObjCls.getFirstAtomObjByName(a.residues[c],"OE2"):f&&"ASP"===b[e].resn&&"OD1"===b[e].name&&(d=a.firstAtomObjCls.getFirstAtomObjByName(a.residues[c],"OD2"));let h=void 0===d?b[e].coord:b[e].coord.clone().add(d.coord).multiplyScalar(.5),C=Math.abs(_.x-h.x);if(C>i)continue;let v=Math.abs(_.y-h.y);if(v>i)continue;let y=Math.abs(_.z-h.z);if(y>i)continue;let S=C*C+v*v+y*y;if(S>p)continue;"graph"!==n&&(a.saltbridgepnts.push({serial:s.serial,coord:_}),a.saltbridgepnts.push({serial:b[e].serial,coord:h}));let w=b[e].structure+"_"+b[e].chain+"_"+b[e].resi;u=o.hashUtilsCls.unionHash(u,a.residues[l]),u=o.hashUtilsCls.unionHash(u,a.residues[w]),m[l]=1,m[w]=1;let x=0==b[e].name.indexOf("pi")&&b[e].ring?b[e].ring.join(","):b[e].serial,A=b[e].resn+" $"+b[e].structure+"."+b[e].chain+":"+b[e].resi+"@"+b[e].name+" "+x;a.resid2Residhash[t][A]=S.toFixed(1);let M=l+"_"+s.resn+","+w+"_"+b[e].resn;r||(void 0===a.resids2inter[M]&&(a.resids2inter[M]={}),void 0===a.resids2inter[M].ionic&&(a.resids2inter[M].ionic={}),a.resids2inter[M].ionic[t+"|"+A]=S.toFixed(1)),void 0===a.resids2interAll[M]&&(a.resids2interAll[M]={}),void 0===a.resids2interAll[M].ionic&&(a.resids2interAll[M].ionic={}),a.resids2interAll[M].ionic[t+"|"+A]=S.toFixed(1)}}}let f=Object.keys(m);if("graph"!==n)for(let e=0,t=f.length;e<t;++e)for(let t in a.residues[f[e]])a.atoms[t].style2="stick",a.ions.hasOwnProperty(t)&&(a.atoms[t].style2="sphere");return u}isAnion(e){let t,i=this.icn3d,s=i.icn3dui;if(e.het&&"O"===e.elem&&1==e.bonds.length){let s=i.atoms[e.bonds[0]];for(let n=0;n<s.bonds.length;++n){let r=s.bonds[n];if("O"==i.atoms[r].elem&&r!=e.serial){t=!0;break}}}if("O"===e.elem&&1==e.bonds.length){let s=i.atoms[e.bonds[0]];"P"!=s.elem&&"S"!=s.elem||(t=!0)}return"GLU"===e.resn&&("OE1"===e.name||"OE2"===e.name)||"ASP"===e.resn&&("OD1"===e.name||"OD2"===e.name)||i.nucleotides.hasOwnProperty(e.serial)&&("OP1"===e.name||"OP2"===e.name||"O1P"===e.name||"O2P"===e.name)||e.het&&-1!==s.parasCls.anionsTrimArray.indexOf(e.elem)||t}hideSaltbridge(){let e=this.icn3d;e.icn3dui,e.opts.saltbridge="no",void 0===e.lines&&(e.lines={}),e.lines.saltbridge=[],e.saltbridgepnts=[]}}class Zc{constructor(e){this.icn3d=e}setStyle2Atoms(e){let t=this.icn3d;t.icn3dui,t.style2atoms={};for(let i in e)void 0===t.style2atoms[t.atoms[i].style]&&(t.style2atoms[t.atoms[i].style]={}),t.style2atoms[t.atoms[i].style][i]=1,void 0!==t.atoms[i].style2&&"nothing"!==t.atoms[i].style2&&(void 0===t.style2atoms[t.atoms[i].style2]&&(t.style2atoms[t.atoms[i].style2]={}),t.style2atoms[t.atoms[i].style2][i]=1)}setAtomStyleByOptions(e){let t,i=this.icn3d,s=i.icn3dui;if(void 0===e&&(e=i.opts),void 0!==e.proteins){t=s.hashUtilsCls.intHash(i.hAtoms,i.proteins);for(let s in t)i.atoms[s].style=e.proteins.toLowerCase()}if(void 0!==e.sidec&&"nothing"!==e.sidec){t=s.hashUtilsCls.intHash(i.hAtoms,i.sidec);for(let s in t)i.atoms[s].style2=e.sidec.toLowerCase()}if(void 0!==e.ntbase&&"nothing"!==e.ntbase){t=s.hashUtilsCls.intHash(i.hAtoms,i.ntbase);for(let s in t)i.atoms[s].style2=e.ntbase.toLowerCase()}if(void 0!==e.chemicals){t=s.hashUtilsCls.intHash(i.hAtoms,i.chemicals);for(let s in t)i.atoms[s].style=e.chemicals.toLowerCase()}if(void 0!==e.ions){t=s.hashUtilsCls.intHash(i.hAtoms,i.ions);for(let s in t)i.atoms[s].style=e.ions.toLowerCase()}if(void 0!==e.water){t=s.hashUtilsCls.intHash(i.hAtoms,i.water);for(let s in t)i.atoms[s].style=e.water.toLowerCase()}if(void 0!==e.nucleotides){t=s.hashUtilsCls.intHash(i.hAtoms,i.nucleotides);for(let s in t)i.atoms[s].style=e.nucleotides.toLowerCase()}}setBackground(e){var t=this.icn3d,i=t.icn3dui;t.setOptionCls.setOption("background",e),i.htmlCls.clickMenuCls.setLogCmd("set background "+e,!0);let s="black"==e?i.htmlCls.GREYD:"black";$("#"+t.pre+"title").css("color",s),$("#"+t.pre+"titlelink").css("color",s)}saveCommandsToSession(){var e=this.icn3d;e.icn3dui;let t=e.commands.join("\n"),i=decodeURIComponent(t);sessionStorage.setItem("commands",i)}getCommandsBeforeCrash(){var e=this.icn3d,t=e.icn3dui;window.addEventListener("load",(function(){sessionStorage.setItem("good_exit","pending")})),window.addEventListener("beforeunload",(function(){sessionStorage.setItem("good_exit","true")})),sessionStorage.getItem("good_exit")&&"pending"===sessionStorage.getItem("good_exit")&&(t.utilsCls.isMac()||(e.bCrashed=!0),e.commandsBeforeCrash=sessionStorage.getItem("commands"),e.commandsBeforeCrash||(e.commandsBeforeCrash=""))}handleContextLost(){var e=this.icn3d;e.icn3dui;let t=$("#"+e.pre+"canvas")[0];t.addEventListener("webglcontextlost",(function(e){e.preventDefault()}),!1),t.addEventListener("webglcontextrestored",(function(t){console.log("WebGL context was lost. Reset WebGLRenderer and launch iCn3D again."),e.renderer=new Pl({canvas:e.oriContainer.get(0),antialias:!0,preserveDrawingBuffer:!0,sortObjects:!1,alpha:!0}),e.renderer.xr.enabled=!0,e.drawCls.draw()}),!1)}adjustIcon(){var e=this.icn3d;e.icn3dui,1===e.STATENUMBER?$("#"+e.pre+"back").hasClass("icn3d-middleIcon")&&($("#"+e.pre+"back").toggleClass("icn3d-middleIcon"),$("#"+e.pre+"back").toggleClass("icn3d-endIcon")):$("#"+e.pre+"back").hasClass("icn3d-endIcon")&&($("#"+e.pre+"back").toggleClass("icn3d-middleIcon"),$("#"+e.pre+"back").toggleClass("icn3d-endIcon")),e.STATENUMBER===e.commands.length?$("#"+e.pre+"forward").hasClass("icn3d-middleIcon")&&($("#"+e.pre+"forward").toggleClass("icn3d-middleIcon"),$("#"+e.pre+"forward").toggleClass("icn3d-endIcon")):$("#"+e.pre+"forward").hasClass("icn3d-endIcon")&&($("#"+e.pre+"forward").toggleClass("icn3d-middleIcon"),$("#"+e.pre+"forward").toggleClass("icn3d-endIcon"))}}class Jc{constructor(e){this.icn3d=e}colorSpectrum(e){let t=this.icn3d,i=t.icn3dui,s=0,n=0;e=i.hashUtilsCls.intHash(e,t.hAtoms);for(let i in e)t.atoms[i],++n;let r=n>1?1/(n-1):1;for(let n in e){let e=t.atoms[n];e.color=i.parasCls.thr().setHSL(3/4*(1-s++*r),1,.45),t.atomPrevColors[n]=e.color}}colorRainbow(e){let t=this.icn3d,i=t.icn3dui,s=0,n=0;e=i.hashUtilsCls.intHash(e,t.hAtoms);for(let i in e)t.atoms[i],++n;let r=n>1?1/(n-1):1;for(let n in e){let e=t.atoms[n];e.color=i.parasCls.thr().setHSL(3/4*s++*r,1,.45),t.atomPrevColors[n]=e.color}}setColorAcrossSets(e,t){let i=this.icn3d,s=i.icn3dui,n=0,r=e.length,a=r>1?1/(r-1):1;for(let r=0,o=e.length;r<o;++r){let o=i.definedSetsCls.getAtomsFromNameArray([e[r]]);for(let e in o){let r=i.atoms[e];r.color=t?s.parasCls.thr().setHSL(3/4*(1-n*a),1,.45):s.parasCls.thr().setHSL(3/4*n*a,1,.45),i.atomPrevColors[e]=r.color}++n}i.drawCls.draw()}setColorBySets(e,t){let i=this.icn3d;i.icn3dui;for(let s=0,n=e.length;s<n;++s){let n=i.definedSetsCls.getAtomsFromNameArray([e[s]]);t?this.colorSpectrum(n):this.colorRainbow(n)}i.drawCls.draw()}setColorByOptions(e,t,i){let s=this.icn3d,n=s.icn3dui;if(void 0!==e)if(i)for(let e in t){let t=s.atoms[e];s.atomPrevColors[e]=t.color}else if(0===e.color.indexOf("#"))for(let i in t){let t=s.atoms[i];t.color=n.parasCls.thr().setStyle(e.color.toLowerCase()),s.atomPrevColors[i]=t.color}else{let i,r,a,o,l;switch("confidence"==e.color.toLowerCase()?$("#"+n.pre+"legend").show():$("#"+n.pre+"legend").hide(),e.color.toLowerCase()){case"rainbow":this.colorRainbow(t);break;case"rainbow for chains":for(let e in s.chains)this.colorRainbow(s.chains[e]);break;case"spectrum":this.colorSpectrum(t);break;case"spectrum for chains":for(let e in s.chains)this.colorSpectrum(s.chains[e]);break;case"structure":let d=s.bAfMem?[n.parasCls.thr(16711935),n.parasCls.thr(65280)]:n.parasCls.stdChainColors,c=-1,h="",p=d.length;for(let e in t){let t=s.atoms[e];t.structure!=h&&(++c,c%=p),t.het?(t.color=n.parasCls.atomColors[t.elem],s.atomPrevColors[e]=t.color):(t.color=d[c],s.atomPrevColors[e]=t.color),h=t.structure}break;case"chain":if(void 0!==s.chainsColor&&Object.keys(s.chainsColor).length>0)this.setMmdbChainColor();else{let e=-1,i="",r=n.parasCls.stdChainColors.length;for(let a in t){let t=s.atoms[a];t.chain!=i&&(++e,e%=r),t.het?(t.color=n.parasCls.atomColors[t.elem],s.atomPrevColors[a]=t.color):(t.color=n.parasCls.stdChainColors[e],Object.keys(s.chainsColor).length>0&&this.updateChainsColor(t),s.atomPrevColors[a]=t.color),i=t.chain}}break;case"domain":i=0,r=0;let u=Object.keys(s.tddomains);r=u.length,a=r>1?1/(r-1):1;for(let e=0,t=u.length;e<t;++e){let t=n.parasCls.thr().setHSL(3/4*(1-i++*a),1,.45);for(let i in s.tddomains[u[e]])for(let e in s.residues[i]){let i=s.atoms[e];i.color=t,s.atomPrevColors[e]=i.color}}break;case"defined sets":if(i=0,s.nameArray&&0!=s.nameArray.length){r=s.nameArray.length,a=r>1?1/(r-1):1;for(let e=0;e<r;++e){let t=s.nameArray[e],r=s.definedSetsCls.getAtomsFromNameArray([t]),o=n.parasCls.thr().setHSL(3/4*i++*a,1,.45);for(let e in r){let t=s.atoms[e];t.color=o,s.atomPrevColors[e]=t.color}}}else alert('Please first select sets in "Analysis > Defined Sets", and try it again.');break;case"secondary structure green":case"secondary structure":s.sheetcolor="green";for(let e in t){let t=s.atoms[e];t.color=t.het?n.parasCls.atomColors[t.elem]||n.parasCls.defaultAtomColor:n.parasCls.ssColors[t.ss]||n.parasCls.thr(16711935),s.atomPrevColors[e]=t.color}break;case"secondary structure yellow":s.sheetcolor="yellow";for(let e in t){let t=s.atoms[e];t.color=t.het?n.parasCls.atomColors[t.elem]||n.parasCls.defaultAtomColor:n.parasCls.ssColors2[t.ss]||n.parasCls.thr(16711935),s.atomPrevColors[e]=t.color}break;case"secondary structure spectrum":i=0,r=0;let m,f,g=[],b=-9999;for(let e in t){if(!s.proteins.hasOwnProperty(e))continue;let t=s.atoms[e];-9999==b&&(m=parseInt(e)),-9999!=b&&(t.ss!=f.ss||Math.abs(t.resi-f.resi)>1||t.ssbegin&&f.ssend)&&("coil"==f.ss||g.push([m,b]),m=e),b=parseInt(e),f=t}"coil"==f.ss||g.push([m,b]),r=g.length,a=r>1?1/(r-1):1;for(let e=0,t=g.length;e<t;++e){let t=n.parasCls.thr().setHSL(3/4*(1-i++*a),1,.45);for(let i=g[e][0];i<=g[e][1];++i){let e=s.atoms[i];e.color=t,s.atomPrevColors[i]=e.color}}break;case"residue":for(let e in t){let t=s.atoms[e];t.color=t.het?n.parasCls.atomColors[t.elem]||n.parasCls.defaultAtomColor:n.parasCls.residueColors[t.resn]||n.parasCls.defaultResidueColor,s.atomPrevColors[e]=t.color}break;case"ig strand":if(s.bShowRefnum){let e,i=s.firstAtomObjCls.getResiduesFromAtoms(t);for(let t in i){if(s.resid2refnum[t]){let i=s.resid2refnum[t],r=s.refnumCls.rmStrandFromRefnumlabel(i),a=i.replace(new RegExp(r,"g"),"");e=s.annoIgCls.getRefnumColor(a),s.residIgLoop.hasOwnProperty(t)&&(e=n.parasCls.thr(n.htmlCls.GREYB))}else e=n.parasCls.thr("#00FFFF");for(let i in s.residues[t]){let t=s.atoms[i];t.color=n.parasCls.thr(e),s.atomPrevColors[i]=t.color}}}break;case"ig protodomain":if(s.bShowRefnum){let e,i=s.firstAtomObjCls.getResiduesFromAtoms(t);for(let t in i){if(s.resid2refnum[t]){let i=s.resid2refnum[t];if(i){let r=s.refnumCls.rmStrandFromRefnumlabel(i),a=i.replace(new RegExp(r,"g"),"");e=s.annoIgCls.getProtodomainColor(a),s.residIgLoop.hasOwnProperty(t)&&(e=n.parasCls.thr(n.htmlCls.GREYB))}else e=n.parasCls.thr(n.htmlCls.GREYB)}else e=n.parasCls.thr("#00FFFF");for(let i in s.residues[t]){let t=s.atoms[i];t.color=n.parasCls.thr(e),s.atomPrevColors[i]=t.color}}}break;case"residue custom":for(let e in t){let t=s.atoms[e];t.color=t.het?n.parasCls.atomColors[t.elem]||n.parasCls.defaultAtomColor:s.customResidueColors[t.resn]||n.parasCls.defaultResidueColor,s.atomPrevColors[e]=t.color}break;case"align custom":s.middB=50,s.spanBinv1=.02,s.spanBinv2=.02;for(let e in t){let t,i=s.atoms[e].structure+"_"+s.atoms[e].chain;if(void 0===s.queryresi2score||!s.queryresi2score.hasOwnProperty(i))continue;let r=s.atoms[e].resi;if(s.queryresi2score[i].hasOwnProperty(r)){let e=s.queryresi2score[i][r];e>100&&(e=100);let a=(s.middB-e)*s.spanBinv1,o=(e-s.middB)*s.spanBinv2;e<s.middB?"blue"==s.startColor?t="white"==s.midColor?n.parasCls.thr().setRGB(1-a,1-a,1):n.parasCls.thr().setRGB(0,0,a):"red"==s.startColor?t="white"==s.midColor?n.parasCls.thr().setRGB(1,1-a,1-a):n.parasCls.thr().setRGB(a,0,0):"green"==s.startColor&&(t="white"==s.midColor?n.parasCls.thr().setRGB(1-a,1,1-a):n.parasCls.thr().setRGB(0,a,0)):"red"==s.endColor?t="white"==s.midColor?n.parasCls.thr().setRGB(1,1-o,1-o):n.parasCls.thr().setRGB(o,0,0):"green"==s.endColor?t="white"==s.midColor?n.parasCls.thr().setRGB(1-o,1,1-o):n.parasCls.thr().setRGB(0,o,0):"blue"==s.endColor&&(t="white"==s.midColor?n.parasCls.thr().setRGB(1-o,1-o,1):n.parasCls.thr().setRGB(0,0,o))}else t=n.parasCls.defaultAtomColor;s.atoms[e].color=t,s.atomPrevColors[e]=t}break;case"charge":for(let e in t){let t=s.atoms[e];t.color=t.het?n.parasCls.defaultAtomColor:n.parasCls.chargeColors[t.resn]||n.parasCls.defaultResidueColor,s.atomPrevColors[e]=t.color}break;case"hydrophobic":for(let e in t){let t=s.atoms[e];t.color=t.het?n.parasCls.defaultAtomColor:n.parasCls.hydrophobicColors[t.resn]||n.parasCls.defaultResidueColor,s.atomPrevColors[e]=t.color}break;case"normalized hydrophobic":for(let e in t){let t=s.atoms[e];t.color=t.het?n.parasCls.defaultAtomColor:n.parasCls.normalizedHPColors[t.resn]||n.parasCls.defaultResidueColor,s.atomPrevColors[e]=t.color}break;case"atom":for(let e in t){let t=s.atoms[e];t.color=n.parasCls.atomColors[t.elem]||n.parasCls.defaultAtomColor,s.atomPrevColors[e]=t.color}break;case"confidence":for(let e in t){let t=s.atoms[e];if(void 0===t.b||isNaN(t.b)||0==parseInt(1e3*t.b))t.color=n.parasCls.thr().setRGB(0,1,0);else{let e=t.b;e=t.structure.substr(0,4)!=s.defaultPdbId&&t.structure.length<6?100-e:e,e>=90?t.color=n.parasCls.thr().setRGB(0,.325,.839):e>=70&&e<90?t.color=n.parasCls.thr().setRGB(.396,.572,.953):e>=50&&e<70?t.color=n.parasCls.thr().setRGB(1,.859,.075):e<50&&(t.color=n.parasCls.thr().setRGB(1,.49,.271))}s.atomPrevColors[e]=t.color}break;case"b factor":s.middB=50,s.spanBinv1=.02,s.spanBinv2=.02;for(let e in t){let t=s.atoms[e];if(void 0===t.b||isNaN(t.b)||0==parseInt(1e3*t.b))t.color=n.parasCls.thr().setRGB(0,1,0);else{let e=t.b;e>100&&(e=100),e=t.structure.substr(0,4)!=s.defaultPdbId&&t.structure.length>5?100-e:e;let i=(s.middB-e)*s.spanBinv1,r=(e-s.middB)*s.spanBinv2;t.color=e<s.middB?n.parasCls.thr().setRGB(1-i,1-i,1):n.parasCls.thr().setRGB(1,1-r,1-r)}s.bOpm&&"DUM"==t.resn&&(t.color=n.parasCls.atomColors[t.elem]),s.atomPrevColors[e]=t.color}break;case"b factor percentile":if(o=1e3,l=-1e3,!s.bfactorArray){s.bfactorArray=[];for(let e in s.atoms){let t=s.atoms[e];o>t.b&&(o=t.b),l<t.b&&(l=t.b),s.bfactorArray.push(t.b)}s.bfactorArray.sort((function(e,t){return e-t}))}let C=s.bfactorArray.length;for(let e in t){let t=s.atoms[e];if(void 0===t.b||isNaN(t.b)||0==parseInt(1e3*t.b)||0==s.bfactorArray.length)t.color=n.parasCls.thr().setRGB(0,1,0);else{let e=t.structure>5?100-t.b:t.b,i=s.bfactorArray.indexOf(e)/C;t.color=i<.5?n.parasCls.thr().setRGB(2*i,2*i,1):n.parasCls.thr().setRGB(1,2*(1-i),2*(1-i))}s.atomPrevColors[e]=t.color}break;case"area":if(void 0===s.resid2area){let e=n.hashUtilsCls.cloneHash(s.hAtoms);s.hAtoms=n.hashUtilsCls.cloneHash(s.atoms),s.bCalcArea=!0,s.opts.surface="solvent accessible surface",s.applyMapCls.applySurfaceOptions(),s.bCalcArea=!1,s.hAtoms=n.hashUtilsCls.cloneHash(e)}let v=void 0!==s.midpercent?s.midpercent:35;s.spanBinv1=.02,s.spanBinv2=.02;for(let e in t){let t=s.atoms[e],i=t.structure+"_"+t.chain+"_"+t.resi+"_"+t.resn,r=n.parasCls.residueArea.hasOwnProperty(t.resn)?s.resid2area[i]/n.parasCls.residueArea[t.resn]*100:v;r>100&&(r=100);let a=(v-r)*s.spanBinv1,o=(r-v)*s.spanBinv2;t.color=r<v?n.parasCls.thr().setRGB(1-a,1-a,1):n.parasCls.thr().setRGB(1,1-o,1-o),s.bOpm&&"DUM"==t.resn&&(t.color=n.parasCls.atomColors[t.elem]),s.atomPrevColors[e]=t.color}break;case"identity":case"conserved":this.setConservationColor(t,!0);break;case"conservation":this.setConservationColor(t,!1);break;case"white":this.setAtmClr(t,16777215);break;case"grey":this.setAtmClr(t,8947848);break;case"red":this.setAtmClr(t,16711680);break;case"green":this.setAtmClr(t,65280);break;case"blue":this.setAtmClr(t,255);break;case"magenta":this.setAtmClr(t,16711935);break;case"yellow":this.setAtmClr(t,16776960);break;case"cyan":this.setAtmClr(t,65535);break;case"custom":break;default:for(let i in t){let t=s.atoms[i];t.color=n.parasCls.thr().setStyle("#"+e.color.toLowerCase()),s.atomPrevColors[i]=t.color}}s.legendTableCls.showColorLegend(e.color.toLowerCase())}}setAtmClr(e,t){let i=this.icn3d,s=i.icn3dui;for(let n in e){let e=i.atoms[n];e.color=s.parasCls.thr().setHex(t),i.atomPrevColors[n]=e.color}}updateChainsColor(e){let t=this.icn3d;t.icn3dui;let i=e.structure+"_"+e.chain;void 0!==t.chainsColor[i]&&(t.chainsColor[i]=e.color)}setMmdbChainColor(e){let t,i=this.icn3d,s=i.icn3dui,n=void 0===e?i.hAtoms:e;this.applyOriginalColor(s.hashUtilsCls.hash2Atoms(n,i.atoms)),t=s.hashUtilsCls.unionHash(t,i.chemicals),t=s.hashUtilsCls.unionHash(t,i.ions);for(let e in t){let t=i.atoms[e];t.color=s.parasCls.atomColors[t.elem]||s.parasCls.defaultAtomColor,i.atomPrevColors[e]=t.color}}setConservationColor(e,t){let i=this.icn3d,s=i.icn3dui;this.setMmdbChainColor(e);for(let n in i.alnChainsSeq){let r=i.alnChainsSeq[n];for(let a=0,o=r.length;a<o;++a){let o=n+"_"+r[a].resi;for(let n in i.residues[o])if(e.hasOwnProperty(n)){let e=t?s.parasCls.thr(r[a].color):s.parasCls.thr(r[a].color2);i.atoms[n].color=e,i.atomPrevColors[n]=e}}}}applyOriginalColor(e){let t=this.icn3d,i=t.icn3dui;void 0===e&&(e=t.atoms);for(let s in e){let n=e[s],r=n.structure+"_"+n.chain;t.chainsColor.hasOwnProperty(r)?n.color=t.chainsColor[r]:n.color=i.parasCls.atomColors[n.elem],t.atomPrevColors[s]=n.color}}applyPrevColor(){let e=this.icn3d;e.icn3dui;for(let t in e.atoms){e.atoms[t].color=e.atomPrevColors[t]}}setOutlineColor(e){this.icn3d.icn3dui;let t={outline:{vertex_shader:["uniform float offset;","void main() {","vec4 pos = modelViewMatrix * vec4( position + normal * offset, 1.0 );","gl_Position = projectionMatrix * pos;","}"].join("\n"),fragment_shader:["void main(){","gl_FragColor = vec4( 1.0, 1.0, 0.0, 1.0 );","}"].join("\n")}};"yellow"===e?t.outline.fragment_shader=["void main(){","gl_FragColor = vec4( 1.0, 1.0, 0.0, 1.0 );","}"].join("\n"):"green"===e?t.outline.fragment_shader=["void main(){","gl_FragColor = vec4( 0.0, 1.0, 0.0, 1.0 );","}"].join("\n"):"red"===e&&(t.outline.fragment_shader=["void main(){","gl_FragColor = vec4( 1.0, 0.0, 0.0, 1.0 );","}"].join("\n"));let i=t.outline;return new Vs({uniforms:{offset:{type:"f",value:.5}},vertexShader:i.vertex_shader,fragmentShader:i.fragment_shader,depthTest:!1,depthWrite:!1})}}class Qc{constructor(e){this.icn3d=e}setOption(e,t){var i=this.icn3d;i.icn3dui,i.opts[e]=t,i.selectionCls.saveSelectionIfSelected(),"color"===e?(i.setColorCls.setColorByOptions(i.opts,i.hAtoms),i.drawCls.draw(),i.hlUpdateCls.updateHlAll(),i.getGraphCls.updateGraphColor()):"surface"===e||"opacity"===e||"wireframe"===e?("opacity"!==e&&"wireframe"!==e||i.applyMapCls.removeLastSurface(),i.applyMapCls.applySurfaceOptions(),i.drawCls.draw()):"map"===e||"mapwireframe"===e?("mapwireframe"===e&&i.applyMapCls.removeLastMap(),i.applyMapCls.applyMapOptions(),i.drawCls.draw()):"emmap"===e||"emmapwireframe"===e?("emmapwireframe"===e&&i.applyMapCls.removeLastEmmap(),i.applyMapCls.applyEmmapOptions(),i.drawCls.draw()):"phimap"===e||"phimapwireframe"===e?("phimapwireframe"===e&&i.applyMapCls.removeLastPhimap(),i.applyMapCls.applyPhimapOptions(),i.drawCls.draw()):"phisurface"===e?(i.applyMapCls.applyphisurfaceOptions(),i.drawCls.draw()):"chemicalbinding"===e?(i.bSkipChemicalbinding=!1,i.drawCls.draw()):i.drawCls.draw()}setStyle(e,t){var i=this.icn3d,s=i.icn3dui;let n={};switch(e){case"proteins":if(n=s.hashUtilsCls.intHash(i.hAtoms,i.proteins),Object.keys(i.hAtoms).length,Object.keys(i.proteins).length,"nothing"==t){i.opts.ssbonds="no",i.lines.ssbond=[];for(let e in n)i.atoms[e].style2="nothing"}else i.opts.ssbonds="yes";break;case"sidec":n=s.hashUtilsCls.intHash(i.hAtoms,i.sidec);break;case"nucleotides":n=s.hashUtilsCls.intHash(i.hAtoms,i.nucleotides),Object.keys(i.hAtoms).length,Object.keys(i.nucleotides).length;break;case"ntbase":n=s.hashUtilsCls.intHash(i.hAtoms,i.ntbase);break;case"chemicals":n=s.hashUtilsCls.intHash(i.hAtoms,i.chemicals);break;case"ions":n=s.hashUtilsCls.intHash(i.hAtoms,i.ions);break;case"water":n=s.hashUtilsCls.intHash(i.hAtoms,i.water)}if("sidec"===e||"ntbase"===e)for(let e in n)i.atoms[e].style2=t;else for(let e in n)i.atoms[e].style=t;i.opts[e]=t,i.selectionCls.saveSelectionIfSelected(),i.drawCls.draw()}saveStyle(){var e=this.icn3d;e.icn3dui;for(let t in e.atoms){let i=e.atoms[t];i.styleSave=i.style,void 0!==i.style2&&(i.style2Save=i.style2)}}applySavedStyle(){var e=this.icn3d;e.icn3dui;for(let t in e.atoms){let i=e.atoms[t];void 0!==i.styleSave&&(i.style=i.styleSave),void 0!==i.style2Save&&(i.style2=i.style2Save)}e.drawCls.draw()}saveColor(){var e=this.icn3d;e.icn3dui;for(let t in e.atoms){let i=e.atoms[t];i.colorSave=i.color.clone()}}applySavedColor(){var e=this.icn3d;e.icn3dui;for(let t in e.atoms){let i=e.atoms[t];void 0!==i.colorSave&&(i.color=i.colorSave.clone(),e.atomPrevColors[t]=i.color)}e.hlUpdateCls.changeSeqColor(Object.keys(e.residues)),e.drawCls.draw()}}class eh{constructor(e){this.icn3d=e}showColorLegend(e){let t=this.icn3d,i=t.icn3dui,s=e.substr(0,1).toUpperCase()+e.substr(1);"confidence"==e?s="pLDDT":"normalized hydrophobic"==e?s="Normalized Hydrophobicity":"hydrophobic"==e?s="Hydrophobicity":"ig strand"==e?s="Ig Strand":"ig protodomain"==e?s="Ig Protodomain":"exon"==e&&(s="Exon");let n="Color by <b>"+s+"</b><br><br>";if("atom"==e){let e=["proteins","nucleotides","chemicals","ions","water"];for(let s=0,r=e.length;s<r;++s){let r=e[s],a=i.hashUtilsCls.intHash(t[r],t.hAtoms);n+=this.getColorLegendForElem(r,a)}}else if("residue"==e)n+=this.getColorLegendForResidue(t.hAtoms);else if("charge"==e)n+=this.getColorLegendForCharge(t.hAtoms);else if("ig strand"==e)n+=this.getColorLegendForIgstrand(t.hAtoms);else if("ig protodomain"==e)n+=this.getColorLegendForIgproto(t.hAtoms);else if("normalized hydrophobic"==e||"hydrophobic"==e){let s=!0,o=this.getRes2color(t.hAtoms,s);var r=Object.keys(o).map((e=>[e,i.parasCls.hydrophobicValues[e]]));r.sort(((e,t)=>parseFloat(e[1])-parseFloat(t[1])));var a=r.map((e=>[e[0],Object.keys(o[e[0]])[0]]));n+="<div>","normalized hydrophobic"==e?(n+="Dark green (W, F, L, I, Y, M, V, C): Hydrophobic<br>",n+="Light green (P, T, S, A, Q, N, G): Polar<br>",n+="Grey: Charged, not hydrophobic<br><br>"):(n+="Green (W, F, L, I, Y, M, V, C): Hydrophobic<br>",n+="Yellow (P, T, S, A, Q, N, G): Polar<br>",n+="Red: Negatively Charged<br>",n+="Blue: Positively Charged<br><br>");let l=0;for(let e of a)i.parasCls.residueAbbrev[e[0]]&&(n+="<div style='display:inline-block; width:100px'>",n+="<div style='width: 10px; height: 10px; background-color:#"+e[1]+"; border: 0px;display:inline-block;' ></div> ",n+=i.parasCls.residueAbbrev[e[0]]+"</div>",l%4==3&&(n+="<br>"),++l);n+="</div>"}else"b factor"==e?(n+="<div style='width:450px'>B factor quantitates the uncertainty for each atom. A high B factor reflects that the position is less certain.</div><br>",n+=i.htmlCls.clickMenuCls.setLegendHtml()):"confidence"==e?n+=i.htmlCls.clickMenuCls.setLegendHtml(!0):"exon"==e?(t.startColor="red",t.midColor="white",t.endColor="blue",t.startValue="Start",t.midValue="Middle",t.endValue="End",n+=i.htmlCls.clickMenuCls.setLegendHtml()):n="";n?($("#"+i.pre+"dl_legend_html").html(n),i.htmlCls.dialogCls.openDlg("dl_legend","Color Legend")):$("#"+i.pre+"dl_legend").hasClass("ui-dialog-content")&&$("#"+i.pre+"dl_legend").dialog("isOpen")&&$("#"+i.pre+"dl_legend").dialog("close")}getColorLegendForElem(e,t){let i=this.icn3d,s=i.icn3dui,n="",r={};for(let e in t){let t=i.atoms[e],s=void 0===t||void 0===t.color||"FFFFFF"===t.color.getHexString().toUpperCase()?"DDDDDD":t.color.getHexString();void 0===r[t.elem]&&(r[t.elem]={}),r[t.elem][s]=1}if(Object.keys(r).length>0){n+="<b>"+e+"</b><br>";let t=Object.keys(r).sort();for(let e=0,i=t.length;e<i;++e){let i=t[e];n+="<span>";for(let e in r[i])n+="<div style='width: 10px; height: 10px; background-color:#"+e+"; border: 0px;display:inline-block;' ></div> ";n+=s.parasCls.atomnames[i.toUpperCase()]+"</span><br>"}n+="<br>"}return n}getRes2color(e,t){let i=this.icn3d,s=i.icn3dui,n={},r=i.firstAtomObjCls.getResiduesFromAtoms(e);for(let e in r){let r=i.residues[e],a=i.firstAtomObjCls.getFirstAtomObj(r),o=t?a.resn:s.parasCls.residueAbbrev[a.resn],l=void 0===a||void 0===a.color||"FFFFFF"===a.color.getHexString().toUpperCase()?"DDDDDD":a.color.getHexString();null!=o&&(void 0===n[o]&&(n[o]={}),n[o][l]=1)}return n}getColorLegendForResidue(e){this.icn3d.icn3dui;let t="",i=this.getRes2color(e);if(Object.keys(i).length>0){t+="<div>";let e=Object.keys(i).sort(),s="",n=0;for(let r=0,a=e.length;r<a;++r){let a="",o=e[r];a+="<div style='display:inline-block; width:100px'>";for(let e in i[o])a+="<div style='width: 10px; height: 10px; background-color:#"+e+"; border: 0px;display:inline-block;' ></div> ";a+=o+"</div>",n%4==3&&(a+="<br>"),-1!=o.indexOf("(")?(t+=a,++n):s+=a}s&&(t+="<br>"+s),t+="</div>"}return t}getColorLegendForCharge(e){let t=this.icn3d;t.icn3dui;let i="",s=t.firstAtomObjCls.getResiduesFromAtoms(e),n={};for(let e in s){let i=t.residues[e],s=t.firstAtomObjCls.getFirstAtomObj(i);"ARG"==s.resn||"LYS"==s.resn?n.Positive=1:"HIS"==s.resn?n["Partial-Positive"]=1:"ASP"==s.resn||"GLU"==s.resn||t.nucleotides[s.serial]?n.Negative=1:n.Neutral=1}const r={Positive:"0000ff","Partial-Positive":"8080ff",Negative:"ff0000",Neutral:"888888"};let a=["Positive","Partial-Positive","Negative","Neutral"];i+="<div>";for(let e=0,t=a.length;e<t;++e){let t=a[e];n[t]&&(i+="<span>",i+="<div style='width: 10px; height: 10px; background-color:#"+r[t]+"; border: 0px;display:inline-block;' ></div> ",i+=t,i+="</span><br>")}return i+="<br>(Charges are at pH 7)",i+="</div>",i}getColorLegendForIgstrand(e){this.icn3d.icn3dui;let t="";const i={"A Strand":"9400D3","B Strand":"ba55d3","C Strand":"0000FF","C' Strand":"6495ED","C'' Strand":"006400","D Strand":"00FF00","E Strand":"FFD700","F Strand":"FF8C00","G Strand":"FF0000",Loop:"CCCCCC"};t+="<div>";for(let e in i){t+="<span>",t+="<div style='width: 10px; height: 10px; background-color:#"+i[e]+"; border: 0px;display:inline-block;' ></div> ",t+=e,t+="</span><br>"}return t+="</div>",t}getColorLegendForIgproto(e){this.icn3d.icn3dui;let t="";const i={"<b>Protodomain 1</b>":"","A Strand":"0000FF","B Strand":"006400","C Strand":"FFD700","C' Strand":"FF8C00","<br><b>Linker</b>":"","C'' Strand":"FF0000","<br><b>Protodomain 2</b>":"","D Strand":"0000FF","E Strand":"006400","F Strand":"FFD700","G Strand":"FF8C00","":"",Loop:"CCCCCC"};t+="<div>A protodomain is a supersecondary structure <br>that by its duplication, symmetry operations <br>can generate a structural domain.<br><br>";for(let e in i){let s=i[e];t+="<span>",s&&(t+="<div style='width: 10px; height: 10px; background-color:#"+s+"; border: 0px;display:inline-block;' ></div> "),t+=e,t+="</span><br>"}return t+="</div>",t}}class th{constructor(e){this.icn3d=e}async showCddSiteAll(){let e=this.icn3d,t=e.icn3dui,i=this;e.chainid2pssmid={};let s=$.map(e.protein_chainid,(function(e){return e})),n=Object.keys(e.protein_chainid),r="https://www.ncbi.nlm.nih.gov/Structure/cdannots/cdannots.fcgi?fmt&frclive&live=lcl&queries="+s;if(1==Object.keys(e.structures).length&&!t.cfg.afid&&(t.cfg.mmtfid||t.cfg.pdbid||t.cfg.opmid||t.cfg.mmdbid||t.cfg.gi||t.cfg.uniprotid||t.cfg.blast_rep_id||t.cfg.cid||t.cfg.mmcifid)||2==Object.keys(e.structures).length&&t.cfg.align){let e={};try{t.bNode?e=await t.getAjaxPromise(r,"jsonp"):e.value=await t.getAjaxPromise(r,"jsonp"),i.parseCddData([e],n)}catch(e){return void i.getNoCdd(s)}}else{let s=[];for(let i=0,a=n.length;i<a;++i){let a=Array.isArray(e.giSeq[n[i]])?e.giSeq[n[i]].join("").toUpperCase():e.giSeq[n[i]].toUpperCase();a=a.replace(/O/g,""),r="https://www.ncbi.nlm.nih.gov/Structure/cdannots/cdannots.fcgi?fmt&frclive&live=lcl&queries="+a;let o=t.getAjaxPromise(r,"jsonp");s.push(o)}let a=Promise.allSettled(s);try{let e=await a;i.parseCddData(e,n,!0)}catch(e){}}}parseCddData(e,t,i){let s=this.icn3d,n=s.icn3dui,r=this,a={};n.bNode&&(s.resid2cdd||(s.resid2cdd={}),s.resid2site||(s.resid2site={}),s.chainid2cdd||(s.chainid2cdd={}));for(let o=0,l=e.length;o<l;++o){let l=n.bNode?e[o]:e[o].value;if(l)for(let e=0,d=l.data.length;e<d;++e){let d=l.data[e];d._id;let c=i?t[o]:t[e];a[c]=1;let h='<div id="'+s.pre+c+'_cddseq_sequence" class="icn3d-cdd icn3d-dl_sequence">',p=h,u=h,m=d.doms;n.bNode&&!s.resid2cdd[c]&&(s.resid2cdd[c]=[]),n.bNode&&!s.chainid2cdd[c]&&(s.chainid2cdd[c]=[]);let f=r.setDomainFeature(m,c,"domain",h,p,u);s.chainid2pssmid[c]={pssmid2name:f.pssmid2name,pssmid2fromArray:f.pssmid2fromArray,pssmid2toArray:f.pssmid2toArray};let g=f.acc2domain;h=f.html+"</div>",p=f.html2+"</div>",u=f.html3+"</div>",$("#"+s.pre+"dt_cdd_"+c).html(h),$("#"+s.pre+"ov_cdd_"+c).html(p),$("#"+s.pre+"tt_cdd_"+c).html(u),h='<div id="'+s.pre+c+'_siteseq_sequence" class="icn3d-dl_sequence">',p=h,u=h;let b=d.motifs;n.bNode&&!s.resid2site[c]&&(s.resid2site[c]=[]),f=r.setDomainFeature(b,c,"feat",h,p,u,g),h=f.html,p=f.html2,u=f.html3;let C=l.data[e].sites,v=void 0!==C?C.length:0;for(let e=0;e<v;++e){C[e].srcdom,C[e].type;let t=C[e].sz,i="site: "+C[e].title;i.length>17&&(i=i.substr(0,17)+"...");let r,a=C[e].title,o=[];for(let t=0,i=C[e].locs.length;t<i;++t){r=C[e].locs[t].coords;for(let e=0,t=r.length;e<t;++e)o.push(s.ParserUtilsCls.getResi(c,Math.round(r[e])))}let l=!1;for(let e=0,t=o.length;e<t;++e){let t=c+"_"+o[e];if(s.residues.hasOwnProperty(t)){l=!0;break}}let d='<div class="icn3d-seqTitle '+(l?"icn3d-link icn3d-blue":"")+'" site="site" posarray="'+r.toString()+'" shorttitle="'+i+'" setname="'+c+"_site_"+e+'" anno="sequence" chain="'+c+'" title="'+a+'">'+i+" </div>",m='<span class="icn3d-residueNum" title="residue count">'+t.toString()+" Res</span>",f='<span class="icn3d-seqLine">';u+=d+m+"<br>",h+=d+m+f,p+=d+m+f;let g="site"+e.toString(),b=0,v=0,_=1;s.seqStartLen&&s.seqStartLen[c]&&(p+=s.showSeqCls.insertMulGapOverview(c,s.seqStartLen[c])),s.seqStartLen&&s.seqStartLen[c]&&(h+=s.showSeqCls.insertMulGap(s.seqStartLen[c],"-"));for(let t=0,i=s.giSeq[c].length;t<i;++t)if(h+=s.showSeqCls.insertGap(c,t,"-"),-1!=r.indexOf(t)){let i=s.giSeq[c][t],r=i;i.length>1&&(r=i[0]+"..");let a=s.ParserUtilsCls.getResi(c,t);if(h+='<span id="'+g+"_"+s.pre+c+"_"+a+'" title="'+r+a+'" class="icn3d-residue">'+i+"</span>",n.bNode){let t={};t[c+"_"+a]="site: "+C[e].title,s.resid2site[c].push(t)}p+=s.showSeqCls.insertGapOverview(c,t);let o=n.cfg.blast_rep_id==c?Math.round(s.seqAnnWidth*t/(s.maxAnnoLength+s.nTotalGap)-b-v):Math.round(s.seqAnnWidth*t/s.maxAnnoLength-b-v);o>=0&&(p+='<div style="display:inline-block; width:'+o+'px;">&nbsp;</div>',p+='<div style="display:inline-block; background-color:#000; width:'+_+'px;" title="'+r+a+'">&nbsp;</div>',b+=o,v+=_)}else h+="<span>-</span>";s.seqStartLen&&s.seqStartLen[c]&&(h+=s.showSeqCls.insertMulGap(s.seqEndLen[c],"-")),f='<span class="icn3d-residueNum" title="residue count">&nbsp;'+t.toString()+" Residues</span>",f+="</span>",f+="<br>",h+=f,p+=f}h+="</div>",p+="</div>",u+="</div>",$("#"+s.pre+"dt_site_"+c).html(h),$("#"+s.pre+"ov_site_"+c).html(p),$("#"+s.pre+"tt_site_"+c).html(u)}}for(let e in s.protein_chainid)a.hasOwnProperty(e)||($("#"+s.pre+"dt_cdd_"+e).html(""),$("#"+s.pre+"ov_cdd_"+e).html(""),$("#"+s.pre+"tt_cdd_"+e).html(""),$("#"+s.pre+"dt_site_"+e).html(""),$("#"+s.pre+"ov_site_"+e).html(""),$("#"+s.pre+"tt_site_"+e).html(""));s.showAnnoCls.enableHlSeq(),s.bAjaxCddSite=!0}getNoCdd(e){let t=this.icn3d;t.icn3dui,console.log("No CDD data were found for the protein "+e+"...");for(let e in t.protein_chainid)$("#"+t.pre+"dt_cdd_"+e).html(""),$("#"+t.pre+"ov_cdd_"+e).html(""),$("#"+t.pre+"tt_cdd_"+e).html(""),$("#"+t.pre+"dt_site_"+e).html(""),$("#"+t.pre+"ov_site_"+e).html(""),$("#"+t.pre+"tt_site_"+e).html("");t.showAnnoCls.enableHlSeq(),t.bAjaxCddSite=!0}getResiArrayStr(e,t){let i=this.icn3d;i.icn3dui;let s="";for(let n=0,r=e.length;n<r;++n){let r=t+"_"+(e[n]+1),a=i.ncbi2resid[r];a||(a=r),n>0&&(s+=","),s+=a.split("_")[2]}return s}setDomainFeature(e,t,i,s,n,r,a,o,l){let d,c,h,p=this.icn3d,u=p.icn3dui,m="domain"!=i&&"feat"!=i;"domain"==i&&(a={},d={},c={},h={}),void 0===e&&(e=[]);let f=e.length,g="domain"==i?14:19,b="domain"==i?100:120;e.sort((function(e,t){let s=e.locs,n="domain"==i||"ig"==i?s[0].segs:[s[0]],r=Math.round(n[0].from);return s=t.locs,n="domain"==i||"ig"==i?s[0].segs:[s[0]],r-Math.round(n[0].from)}));for(let C=0;C<f;++C){let f="domain"==i?e[C].pssmid:0,v="domain"==i?e[C].acc:"feat"==i?e[C].srcdom:"",_="domain"==i?e[C].title.split(":")[0]:"feat"==i?e[C].title:o[C];_=_.replace(/\"/g,"``"),_=_.replace(/'/g,"`"),"domain"==i&&(a[v]=_);let y="domain"==i?e[C].defline:"",S=m?o[C]:i+": "+_;S.length>g&&(S=S.substr(0,g)+"...");let w=m?l[C]:i+": "+_;"domain"==i&&(d[f]=_);let x=e[C].locs;if(x)for(let e=0,a=x.length;e<a;++e){let a=[],l=[],d={},m=0,g="domain"==i||"ig"==i?x[e].segs:[x[e]];for(let e=0,t=g.length;e<t;++e){let t=Math.round(g[e].from),i=Math.round(g[e].to);a.push(t),l.push(i);for(let e=t;e<=i;++e)d[e]=1;m+=i-t+1}let A=t+"_"+_;"domain"!=i&&(A=t+"_"+C+"_"+e+"_"+_),A=A.replace(/\s+/g,""),"domain"==i&&(c[f]=a),"domain"==i&&(h[f]=l);let M=!1;for(let e=0,i=a.length;e<i;++e){let i=parseInt(a[e]),s=parseInt(l[e]);for(let e=i;e<=s;++e){let i=t+"_"+p.ParserUtilsCls.getResi(t,e);if(p.residues.hasOwnProperty(i)){M=!0;break}}if(M)break}let T=M?"icn3d-link icn3d-blue":"",E='<div class="icn3d-seqTitle '+T+'" '+i+'="'+v+'" from="'+a+'" to="'+l+'" shorttitle="'+S+'" setname="'+A+'" anno="sequence" chain="'+t+'" title="'+w+'">'+S+" </div>",R='<span class="icn3d-residueNum" title="residue count">'+m.toString()+" Res</span>";r+=E+R+"<br>";let k='<span class="icn3d-seqLine">';s+=E+R+k,"domain"==i&&(n+='<div style="width:20px; display:inline-block;"><span id="'+p.pre+t+"_"+v+"_"+e+'_cddseq_expand" class="ui-icon ui-icon-plus icn3d-expand icn3d-link" style="width:15px;" title="Expand"></span><span id="'+p.pre+t+"_"+v+"_"+e+'_cddseq_shrink" class="ui-icon ui-icon-minus icn3d-shrink icn3d-link" style="display:none; width:15px;" title="Shrink"></span></div>'),n+='<div style="width:'+b+'px!important;" class="icn3d-seqTitle '+T+'" '+i+'="'+v+'" from="'+a+'" to="'+l+'" shorttitle="'+S+'" index="'+C+'" setname="'+A+'" anno="sequence" chain="'+t+'" title="'+w+'">'+S+" </div>",n+=R+k;let O=i+C.toString();if(p.seqStartLen&&p.seqStartLen[t]&&(s+=p.showSeqCls.insertMulGap(p.seqStartLen[t],"-")),u.bNode&&"domain"==i){let e=this.getResiArrayStr(a,t),i=this.getResiArrayStr(l,t);p.chainid2cdd[t].push(w+"_from_"+e+"_to_"+i)}for(let e=0,n=p.giSeq[t].length;e<n;++e)if(s+=p.showSeqCls.insertGap(t,e,"-"),d.hasOwnProperty(e)){let n=p.giSeq[t][e],r=n;n.length>1&&(r=n[0]+"..");let a=p.ParserUtilsCls.getResi(t,e);if(s+='<span id="'+O+"_"+p.pre+t+"_"+a+'" title="'+r+a+'" class="icn3d-residue">'+n+"</span>",u.bNode){let e={};e[t+"_"+a]=w,"domain"==i?p.resid2cdd[t].push(e):p.resid2site[t].push(e)}}else s+="<span>-</span>";if(p.seqStartLen&&p.seqStartLen[t]&&(s+=p.showSeqCls.insertMulGap(p.seqEndLen[t],"-")),p.seqStartLen&&p.seqStartLen[t]&&(n+=p.showSeqCls.insertMulGapOverview(t,p.seqStartLen[t])),u.cfg.blast_rep_id!=t){let s;for(let r=0,d=a.length;r<d;++r){let d;0==r&&(s=this.getColorFromPos(t,a[r],o)),d=0==r?Math.round(p.seqAnnWidth*a[r]/p.maxAnnoLength):Math.round(p.seqAnnWidth*(a[r]-l[r-1]-1)/p.maxAnnoLength),n+='<div style="display:inline-block; width:'+d+'px;">&nbsp;</div>',n+='<div style="display:inline-block; color:white!important; font-weight:bold; background-color:#'+s+"; width:"+Math.round(p.seqAnnWidth*(l[r]-a[r]+1)/p.maxAnnoLength)+'px;" class="icn3d-seqTitle '+T+'" '+i+'="'+(C+1).toString()+'" from="'+a+'" to="'+l+'" shorttitle="'+S+'" index="'+C+'" setname="'+A+'" id="'+t+"_domain_"+C+"_"+e+'" anno="sequence" chain="'+t+'" title="'+w+'">'+_+" </div>"}}else{let s=[],r=[];for(let e=0,t=a.length;e<t;++e){s.push(a[e]);for(let t=parseInt(a[e]);t<=parseInt(l[e]);++t)void 0!==p.targetGapHash&&p.targetGapHash.hasOwnProperty(t)&&(r.push(t-1),s.push(t));r.push(l[e])}for(let a=0,l=s.length;a<l;++a){let l=this.getColorFromPos(t,s[a],o);n+=p.showSeqCls.insertGapOverview(t,s[a]),n+='<div style="display:inline-block; width:'+(0==a?Math.round(p.seqAnnWidth*(s[a]-p.baseResi[t]-1)/(p.maxAnnoLength+p.nTotalGap)):Math.round(p.seqAnnWidth*(s[a]-r[a-1]-1)/(p.maxAnnoLength+p.nTotalGap)))+'px;">&nbsp;</div>',n+='<div style="display:inline-block; color:white!important; font-weight:bold; background-color:#'+l+"; width:"+Math.round(p.seqAnnWidth*(r[a]-s[a]+1)/(p.maxAnnoLength+p.nTotalGap))+'px;" class="icn3d-seqTitle '+T+'" '+i+'="'+(C+1).toString()+'" from="'+s+'" to="'+r+'" shorttitle="'+S+'" index="'+C+'" setname="'+A+'" id="'+t+"_domain_"+C+"_"+e+'" anno="sequence" chain="'+t+'" title="'+w+'">'+_+" </div>"}}k='<span class="icn3d-residueNum" title="residue count">&nbsp;'+m.toString()+" Residues</span>",k+="</span>",k+="<br>",s+=k,n+=k,"domain"==i&&(n+='<div id="'+p.pre+t+"_"+v+"_"+e+'_cddseq" style="display:none; white-space:normal;" class="icn3d-box">'+y+'(<a href="'+u.htmlCls.baseUrl+"cdd/cddsrv.cgi?uid="+v+'" target="_blank" class="icn3d-blue">open details view...</a>)</div>')}}return{html:s,html2:n,html3:r,acc2domain:a,pssmid2name:d,pssmid2fromArray:c,pssmid2toArray:h}}getColorFromPos(e,t,i){let s,n=this.icn3d;n.icn3dui;let r=e+"_"+n.ParserUtilsCls.getResi(e,t),a=n.firstAtomObjCls.getFirstAtomObj(n.residues[r]),o=a&&void 0!==a.color&&"FFFFFF"!==a.color.getHexString()?a.color.getHexString():"DDDDDD";return s=a&&void 0!==a.color?o:"CCCCCC",s}showAnnoType(e,t,i,s,n,r){let a=this.icn3d,o=a.icn3dui,l='<div id="'+a.pre+e+"_"+i+'seq_sequence" class="icn3d-dl_sequence">',d=l,c=l;if(0==n.length)return $("#"+a.pre+"dt_"+i+"_"+e).html(""),$("#"+a.pre+"ov_"+i+"_"+e).html(""),void $("#"+a.pre+"tt_"+i+"_"+e).html("");let h=s;s.length>17&&(s=s.substr(0,17)+"...");let p=[];for(let e=0,t=n.length;e<t;++e){let t=n[e].substr(n[e].lastIndexOf("_")+1);p.push(t)}let u=p.length,m=i,f='<div class="icn3d-seqTitle icn3d-link icn3d-blue" '+i+'="" posarray="'+p.toString()+'" shorttitle="'+s+'" setname="'+e+"_"+m+'" anno="sequence" chain="'+e+'" title="'+h+'">'+s+" </div>",g='<span class="icn3d-residueNum" title="residue count">'+u.toString()+" Res</span>";c+=f+g+"<br>";let b='<span class="icn3d-seqLine">';l+=f+g+b,d+=f+g+b;let C=i,v=0,_=0;a.seqStartLen&&a.seqStartLen[e]&&(d+=a.showSeqCls.insertMulGapOverview(e,a.seqStartLen[e])),a.seqStartLen&&a.seqStartLen[e]&&(l+=a.showSeqCls.insertMulGap(a.seqStartLen[e],"-"));for(let t=0,s=a.giSeq[e].length;t<s;++t){l+=a.showSeqCls.insertGap(e,t,"-");let s=a.ParserUtilsCls.getResi(e,t);if(-1!=p.indexOf(s)){let n=a.giSeq[e][t],c=n;n.length>1&&(c=n[0]+"..");let h=s,p=e+"_"+s,u=n+s;if("ssbond"==i){u="Residue "+p+" has disulfide bond with";let t="";if(void 0!==r[p])for(let e=0,i=r[p].length;e<i;++e)t+=" residue "+r[p][e];if(u+=t,o.bNode){let i={};i[p]="disulfide bond with"+t,a.resid2ssbond[e].push(i)}}else if("crosslink"==i){u="Residue "+p+" has cross-linkage with";let t="";if(void 0!==r[p])for(let e=0,i=r[p].length;e<i;++e)t+=" residue "+r[p][e];if(u+=t,o.bNode){let i={};i[p]="cross-linkage with"+t,a.resid2crosslink[e].push(i)}}else{u="Residue "+p+" has connection with";let e="";if(r&&void 0!==r[p])for(let t=0,i=r[p].length;t<i;++t)e+=" residue "+r[p][t];u+=e}l+='<span id="'+C+"_"+a.pre+e+"_"+h+'" title="'+u+'" class="icn3d-residue">'+c+"</span>",d+=a.showSeqCls.insertGapOverview(e,t);let m=o.cfg.blast_rep_id==e?Math.round(a.seqAnnWidth*t/(a.maxAnnoLength+a.nTotalGap)-v-_):Math.round(a.seqAnnWidth*t/a.maxAnnoLength-v-_);m>=0&&(d+='<div style="display:inline-block; width:'+m+'px;">&nbsp;</div>',d+='<div style="display:inline-block; background-color:#000; width:1px;" title="'+u+'">&nbsp;</div>',v+=m,_+=1)}else l+="<span>-</span>"}a.seqStartLen&&a.seqStartLen[e]&&(l+=a.showSeqCls.insertMulGap(a.seqEndLen[e],"-")),b='<span class="icn3d-residueNum" title="residue count">&nbsp;'+u.toString()+" Residues</span>",b+="</span>",b+="<br>",l+=b,d+=b,l+="</div>",d+="</div>",c+="</div>",$("#"+a.pre+"dt_"+i+"_"+e).html(l),$("#"+a.pre+"ov_"+i+"_"+e).html(d),$("#"+a.pre+"tt_"+i+"_"+e).html(c)}setToolTip(){let e=this.icn3d;e.icn3dui,$("[id^="+e.pre+"snp]").add("[id^="+e.pre+"clinvar]").add("[id^="+e.pre+"ssbond]").add("[id^="+e.pre+"crosslink]").tooltip({content:function(){return $(this).prop("title")},show:null,close:function(e,t){t.tooltip.hover((function(){$(this).stop(!0).fadeTo(400,1)}),(function(){$(this).fadeOut("400",(function(){$(this).remove()}))}))}})}}class ih{constructor(e){this.icn3d=e}showInteraction(e,t){this.icn3d.icn3dui,this.showInteraction_base(e,t)}showInteraction_base(e,t){let i=this.icn3d,s=i.icn3dui;s.bNode&&(i.resid2contact||(i.resid2contact={}),i.resid2contact[e]||(i.resid2contact[e]=[])),void 0===i.chainname2residues&&(i.chainname2residues={});let n=Object.keys(i.chains),r=e,a=Math.round(r.indexOf("_"));if(i.firstAtomObjCls.getFirstCalphaAtomObj(i.chains[r]),void 0===i.chainname2residues[r]){i.chainname2residues[r]={};let t=n.length;if(t>100&&void 0===s.cfg.mmdbid&&void 0===s.cfg.gi&&void 0===s.cfg.blast_rep_id&&void 0===s.cfg.align&&void 0===s.cfg.chainalign)return $("#"+i.pre+"dt_interaction_"+e).html(""),void $("#"+i.pre+"ov_interaction_"+e).html("");for(let e=0;e<t;++e){let t=n[e];if(t===r)continue;if(t.substr(0,t.indexOf("_"))!==r.substr(0,r.indexOf("_")))continue;if(a=Math.round(r.indexOf("_")),a>4)continue;let o,l=i.firstAtomObjCls.getFirstCalphaAtomObj(i.chains[t]);i.chemicals.hasOwnProperty(l.serial)?o="chemical":i.nucleotides.hasOwnProperty(l.serial)?o="nucleotide":i.ions.hasOwnProperty(l.serial)?o="ion":i.proteins.hasOwnProperty(l.serial)?o="protein":i.water.hasOwnProperty(l.serial)&&(o="water");let d=i.contactCls.getAtomsWithinAtom(s.hashUtilsCls.hash2Atoms(i.chains[r],i.atoms),s.hashUtilsCls.hash2Atoms(i.chains[t],i.atoms),4);if(0==Object.keys(d).length)continue;let c={};for(let e in d){let t=i.atoms[e];c[t.structure+"_"+t.chain+"_"+t.resi]=1}let h=t.substr(t.indexOf("_")+1)+"("+o+")";i.chainname2residues[r][h]=Object.keys(c)}}let o='<div id="'+i.pre+e+'_interseq_sequence" class="icn3d-dl_sequence">',l=o,d=o,c=0;for(let t in i.chainname2residues[e]){let n=i.chainname2residues[e][t];if(!n)continue;let r="Interact ."+t;r.length>17&&(r=r.substr(0,17)+"...");let a="Interact ."+t,h=[];for(let e=0,t=n.length;e<t;++e){let t=n[e],s=t.substr(n[e].lastIndexOf("_")+1);if(i.residues[t]){let e=Object.keys(i.residues[t])[0];(i.proteins.hasOwnProperty(e)||i.nucleotides.hasOwnProperty(e))&&h.push(s)}}let p=h.length;if(0==p)continue;let u=t.replace(/\s/g,""),m='<div class="icn3d-seqTitle icn3d-link icn3d-blue" interaction="'+(c+1).toString()+'" posarray="'+h.toString()+'" shorttitle="'+r+'" setname="'+e+"_"+u+'" anno="sequence" chain="'+e+'" title="'+a+'">'+r+" </div>",f='<span class="icn3d-residueNum" title="residue count">'+p.toString()+" Res</span>";d+=m+f+"<br>";let g='<span class="icn3d-seqLine">';o+=m+f+g,l+=m+f+g;let b="inter"+c.toString(),C=0,v=0,_=1;i.seqStartLen&&i.seqStartLen[e]&&(l+=i.showSeqCls.insertMulGapOverview(e,i.seqStartLen[e])),i.seqStartLen&&i.seqStartLen[e]&&(o+=i.showSeqCls.insertMulGap(i.seqStartLen[e],"-"));for(let t=0,n=i.giSeq[e].length;t<n;++t){o+=i.showSeqCls.insertGap(e,t,"-");let n=i.ParserUtilsCls.getResi(e,t);if(-1!=h.indexOf(n)){let r=i.giSeq[e][t],d=r;r.length>1&&(d=r[0]+"..");let c=n;if(o+='<span id="'+b+"_"+i.pre+e+"_"+c+'" title="'+r+c+'" class="icn3d-residue">'+d+"</span>",s.bNode){let t={};t[e+"_"+c]=a,i.resid2contact[e].push(t)}l+=i.showSeqCls.insertGapOverview(e,t);let h=s.cfg.blast_rep_id==e?Math.round(i.seqAnnWidth*t/(i.maxAnnoLength+i.nTotalGap)-C-v):Math.round(i.seqAnnWidth*t/i.maxAnnoLength-C-v);h>=0&&(l+='<div style="display:inline-block; width:'+h+'px;">&nbsp;</div>',l+='<div style="display:inline-block; background-color:#000; width:'+_+'px;" title="'+d+c+'">&nbsp;</div>',C+=h,v+=_)}else o+="<span>-</span>"}i.seqStartLen&&i.seqStartLen[e]&&(o+=i.showSeqCls.insertMulGap(i.seqEndLen[e],"-")),g='<span class="icn3d-residueNum" title="residue count">&nbsp;'+p.toString()+" Residues</span>",g+="</span>",g+="<br>",o+=g,l+=g,++c}o+="</div>",l+="</div>",d+="</div>",$("#"+i.pre+"dt_interaction_"+e).html(o),$("#"+i.pre+"ov_interaction_"+e).html(l),$("#"+i.pre+"tt_interaction_"+e).html(d),s.utilsCls.isMobile()?(i.hlSeqCls.selectSequenceMobile(),i.hlSeqCls.selectChainMobile()):i.hlSeqCls.selectSequenceNonMobile()}}class sh{constructor(e){this.icn3d=e}async showPTM(e,t,i,s,n){let r=this.icn3d,a=r.icn3dui,o=this,l=e.substr(0,e.indexOf("_")),d=e.substr(e.indexOf("_")+1);if("afmem"==i){let t={Transmembrane:[{begin:s,end:n}]};this.setAnnoPtmTransmem("transmem",t,e)}else if(l.length>5){let t,s="https://www.ebi.ac.uk/proteins/api/features/"+l;try{t=await a.getAjaxPromise(s,"json"),o.parsePTM(t,e,i)}catch{return void o.getNoPTM(e,i)}}else{let t,s=l.substr(0,4).toLowerCase(),n="https://www.ebi.ac.uk/pdbe/api/mappings/uniprot/"+s;try{t=await a.getAjaxPromise(n,"json");let l="";r.UPResi2ResiPosPerChain||(r.UPResi2ResiPosPerChain={}),r.UPResi2ResiPosPerChain[e]={};let c=t[s].UniProt,h=!1;for(let t in c){let i=c[t].mappings;for(let s=0,n=i.length;s<n;++s){let n=i[s];if(n.chain_id==d){let i=n.unp_start,s=n.unp_end,a=n.start.residue_number;n.end.residue_number-a!=s-i&&console.log("There might be some issues in the PDB to UniProt residue mapping.");for(let t=0;t<=s-i;++t)r.UPResi2ResiPosPerChain[e][t+i]=t+a-1;""!=l&&6==l.length||(l=t),h=!0}}}if(r.annoPtmData||(r.annoPtmData={}),""==l)o.getNoPTM(e,i);else if(r.annoPtmData.hasOwnProperty(l))o.parsePTM(r.annoPtmData[l],e,i);else{let t,s="https://www.ebi.ac.uk/proteins/api/features/"+l;try{t=await a.getAjaxPromise(s,"json"),r.annoPtmData[l]=t,o.parsePTM(t,e,i)}catch(t){return void o.getNoPTM(e,i)}}}catch(t){return void o.getNoPTM(e,i)}}}parsePTM(e,t,i){let s=this.icn3d;s.icn3dui.bNode&&("ptm"==i?(s.resid2ptm={},s.resid2ptm[t]=[]):(s.resid2transmem={},s.resid2transmem[t]=[]));let n={},r={};for(let t=0,s=e.features.length;t<s;++t){let s=e.features[t];if("ptm"==i&&"PTM"==s.category&&"DISULFID"!=s.type&&"CROSSLNK"!=s.type){let e="";e="CARBOHYD"==s.type?"Glycosylation":"LIPID"==s.type?"Lipidation, "+s.description:0==s.description.indexOf("Phospho")?"Phosphorylation":s.description?s.description:s.type,n[e]||(n[e]=[]),n[e].push(s)}else if("transmem"==i&&"TOPOLOGY"==s.category&&"TRANSMEM"==s.type){let e="Transmembrane";r[e]||(r[e]=[]),r[e].push(s)}}"ptm"==i?this.setAnnoPtmTransmem("ptm",n,t):this.setAnnoPtmTransmem("transmem",r,t),s.showAnnoCls.enableHlSeq(),s.bAjaxPTM=!0}setAnnoPtmTransmem(e,t,i){let s=this.icn3d,n=s.icn3dui,r=0,a="",o="",l="";a+='<div id="'+s.pre+i+"_"+e+'seq_sequence" class="icn3d-cdd icn3d-dl_sequence">',o+=a,l+=a,i.substr(0,i.indexOf("_"));for(let d in t){let c=t[d],h=[],p=!1;for(let e=0,t=c.length;e<t;++e){let t=parseInt(c[e].begin),n=parseInt(c[e].end);for(let e=t;e<=n;++e)stucture.length>5?h.push(e-1):s.UPResi2ResiPosPerChain&&s.UPResi2ResiPosPerChain[i][e]&&h.push(s.UPResi2ResiPosPerChain[i][e]),!p&&s.residues.hasOwnProperty(i+"_"+e)&&(p=!0)}if(0==h.length)continue;let u=h.length,m="ptm"==e?"PTM: "+d:"Transmembrane";m.length>17&&(m=m.substr(0,17)+"...");let f=d,g='<div class="icn3d-seqTitle '+(p?"icn3d-link icn3d-blue":"")+'" '+e+'="'+e+'" posarray="'+h.toString()+'" shorttitle="'+m+'" setname="'+i+"_"+e+"_"+r+'" anno="sequence" chain="'+i+'" title="'+f+'">'+m+" </div>",b='<span class="icn3d-residueNum" title="residue count">'+u.toString()+" Res</span>",C='<span class="icn3d-seqLine">';l+=g+b+"<br>",a+=g+b+C,o+=g+b+C;let v=e+r.toString(),_=0,y=0,S=1;s.seqStartLen&&s.seqStartLen[i]&&(o+=s.showSeqCls.insertMulGapOverview(i,s.seqStartLen[i])),s.seqStartLen&&s.seqStartLen[i]&&(a+=s.showSeqCls.insertMulGap(s.seqStartLen[i],"-"));for(let e=0,t=s.giSeq[i].length;e<t;++e)if(a+=s.showSeqCls.insertGap(i,e,"-"),-1!=h.indexOf(e)){let t=s.giSeq[i][e],r=t;t.length>1&&(r=t[0]+"..");let l=s.ParserUtilsCls.getResi(i,e);if(a+='<span id="'+v+"_"+s.pre+i+"_"+l+'" title="'+r+l+'" class="icn3d-residue">'+t+"</span>",n.bNode){let e={};e[i+"_"+l]=m,s.resid2ptm[i].push(e)}o+=s.showSeqCls.insertGapOverview(i,e);let d=n.cfg.blast_rep_id==i?Math.round(s.seqAnnWidth*e/(s.maxAnnoLength+s.nTotalGap)-_-y):Math.round(s.seqAnnWidth*e/s.maxAnnoLength-_-y);d>=0&&(o+='<div style="display:inline-block; width:'+d+'px;">&nbsp;</div>',o+='<div style="display:inline-block; background-color:#000; width:'+S+'px;" title="'+r+l+'">&nbsp;</div>',_+=d,y+=S)}else a+="<span>-</span>";s.seqStartLen&&s.seqStartLen[i]&&(a+=s.showSeqCls.insertMulGap(s.seqEndLen[i],"-")),C='<span class="icn3d-residueNum" title="residue count">&nbsp;'+u.toString()+" Residues</span>",C+="</span>",C+="<br>",a+=C,o+=C,++r}a+="</div>",o+="</div>",l+="</div>",$("#"+s.pre+"dt_"+e+"_"+i).html(a),$("#"+s.pre+"ov_"+e+"_"+i).html(o),$("#"+s.pre+"tt_"+e+"_"+i).html(l)}getNoPTM(e,t){let i=this.icn3d;i.icn3dui,console.log("No PTM data were found for the chain "+e+"...");let s="ptm"==t?"ptm":"transmem";$("#"+i.pre+"dt_"+s+"_"+e).html(""),$("#"+i.pre+"ov_"+s+"_"+e).html(""),$("#"+i.pre+"tt_"+s+"_"+e).html(""),i.showAnnoCls.enableHlSeq(),i.bAjaxPTM=!0}}class nh{constructor(e){this.icn3d=e}async showIg(e,t){let i=this.icn3d;i.icn3dui,i.bRunRefnumAgain&&await i.refnumCls.showIgRefNum(t);let s="",n="",r="";if(i.bShowRefnum&&i.chainid2refpdbname.hasOwnProperty(e)&&i.chainid2refpdbname[e].length>0){let t=i.showSeqCls.getSeq(e),a=i.annoIgCls.showAllRefNum(t,e);s+=a.html,n+=a.html2,r+=a.html3}$("#"+i.pre+"dt_"+"ig_"+e).html(s),$("#"+i.pre+"ov_"+"ig_"+e).html(n),$("#"+i.pre+"tt_"+"ig_"+e).html(r)}showAllRefNum(e,t){let i=this.icn3d;i.icn3dui;let s="",n="",r="",a=!1;for(let s=0,n=e.length;s<n;++s){let e=t+"_"+i.ParserUtilsCls.getResi(t,s),n=i.resid2domainid[e];if(i.domainid2ig2kabat[n]&&Object.keys(i.domainid2ig2kabat[n]).length>0){a=!0;break}}let o=!1;for(let s=0,n=e.length;s<n;++s){let e=t+"_"+i.ParserUtilsCls.getResi(t,s),n=i.resid2domainid[e];if(i.domainid2ig2imgt[n]&&Object.keys(i.domainid2ig2imgt[n]).length>0){o=!0;break}}let l=this.showRefNum(e,t);s+=l.html,n+=l.html2,r+=l.html3;let d=1;return a&&(l=this.showRefNum(e,t,d),s+=l.html,n+=l.html2,r+=l.html3),d=2,o&&(l=this.showRefNum(e,t,d),s+=l.html,n+=l.html2,r+=l.html3),{html:s,html2:n,html3:r}}showRefNum(e,t,i,s){let n=this.icn3d;if(n.icn3dui,n.chainid2igtrack){if(!n.chainid2igtrack[t])return{html:"",html2:"",html3:""}}let r=this.getIgAnnoHtml(t,e,s,i);return n.bShowRefnum&&(n.opts.color="ig strand",n.setColorCls.setColorByOptions(n.opts,n.chains[t])),r}setChain2igArray(e,t,i){let s,n=this.icn3d;n.icn3dui;let r={};for(let a=0,o=t.length;a<o;++a){let t=e+"_"+n.ParserUtilsCls.getResi(e,a),o=i?0:n.resid2domainid[t];s=n.resid2refnum[t],s&&(r[o]||(r[o]=[]),r[o].push(a))}for(let t in r){let i,s,a=r[t],o=[],l=[];for(let e=0,t=a.length;e<t;++e)i=a[e],0==e&&o.push(i),e>0&&i!=s+1&&(l.push(s),o.push(i)),s=i;l.push(i);let d={};d.domainid=t,d.startPosArray=o,d.endPosArray=l,n.chain2igArray[e].push(d)}}getIgAnnoHtml(e,t,i,s){let n=this.icn3d,r=n.icn3dui,a="",o="",l="";n.chain2igArray||(n.chain2igArray={});let d,c,h,p=!1,u="";n.chain2igArray[e]=[],this.setChain2igArray(e,t,i);let m=n.chain2igArray[e];for(let t=0,i=m.length;t<i;++t){let i=m[t].domainid;if(!n.domainid2info)continue;if(!n.domainid2info[i])continue;let s=!1,r=!1,a=!1,o=!1,l={};for(let i=0,d=m[t].startPosArray.length;i<d;++i){let d=m[t].startPosArray[i],c=m[t].endPosArray[i];for(let t=d;t<=c;++t){const i=e+"_"+n.chainsSeq[e][t].resi;l[i]=1;let d=n.resid2refnum[i];d&&(-1!=d.indexOf("B2550")&&(s=!0),-1!=d.indexOf("C3550")&&(r=!0),-1!=d.indexOf("E7550")&&(a=!0),-1!=d.indexOf("F8550")&&(o=!0))}}if(!(s&&r&&a&&o)){for(let e in l)delete n.resid2refnum[e],delete n.residIgLoop[e],delete n.resid2domainid[e];let t=Object.keys(l),i=n.setSeqAlignCls.getPosFromResi(e,t[t.length-1].split("_")[2]);for(let t=i+1,s=n.chainsSeq[e].length;t<s;++t){let i=e+"_"+n.chainsSeq[e][t].resi;if(!n.residIgLoop.hasOwnProperty(i))break;delete n.resid2refnum[i],delete n.residIgLoop[i],delete n.resid2domainid[i]}n.setSeqAlignCls.getPosFromResi(e,t[0].split("_")[2]);for(let t=i-1;t>=0;--t){let i=e+"_"+n.chainsSeq[e][t].resi;if(!n.residIgLoop.hasOwnProperty(i))break;delete n.resid2refnum[i],delete n.residIgLoop[i],delete n.resid2domainid[i]}}}n.chain2igArray[e]=[],this.setChain2igArray(e,t,i);let f="";for(let r=0,a=t.length;r<a;++r){f+=n.showSeqCls.insertGap(e,r,"-");let t=e+"_"+n.ParserUtilsCls.getResi(e,r),a=i?0:n.resid2domainid[t];d=i?n.chainsMapping[e][t]:n.resid2refnum[t];let o=!1;if(d)if(c=n.refnumCls.rmStrandFromRefnumlabel(d),u=d.replace(new RegExp(c,"g"),""),c.substr(0,1),h=i?d:1==s?n.domainid2ig2kabat[a]?n.domainid2ig2kabat[a][c]:void 0:2==s?n.domainid2ig2imgt[a]?n.domainid2ig2imgt[a][c]:void 0:c,i)if(h){f+=parseInt(h)%2==0?'<span title="'+h+'">'+h+"</span>":'<span title="'+h+'">&nbsp;</span>'}else f+="<span></span>";else if(1==s||2==s)if(h){let e=parseInt(h).toString(),t='style="color:'+this.getRefnumColor(u,!0)+'"';f+=parseInt(e.substr(e.length-2,2))%2==0?"<span "+t+' title="'+h+'">'+h+"</span>":"<span "+t+' title="'+h+'">&nbsp;</span>'}else f+="<span></span>";else" "!=u?(p=n.residIgLoop[t],f+=this.getRefnumHtml(t,h,c,d,u,p,o)):f+="<span></span>";else f+="<span></span>"}if(r.bNode)return{html:a,html2:o,html3:l};let g="icn3d-link icn3d-blue",b="IgStRAnD Ref. No.",C=n.chain2igArray[e].length,v=[],_=[],y={};n.igLabel2Pos||(n.igLabel2Pos={}),n.igLabel2Pos[e]={};for(let t=0;t<C;++t){let i=n.chain2igArray[e][t];v=v.concat(i.startPosArray),_=_.concat(i.endPosArray);for(let e=0,s=i.startPosArray.length;e<s;++e){y[i.startPosArray[e]]=t}let s=e+"_"+n.ParserUtilsCls.getResi(e,i.startPosArray[0]),r=n.firstAtomObjCls.getFirstCalphaAtomObj(n.residues[s]),a=e+"_"+n.ParserUtilsCls.getResi(e,i.endPosArray[i.endPosArray.length-1]),o=n.firstAtomObjCls.getFirstCalphaAtomObj(n.residues[a]),l=e.substr(e.lastIndexOf("_")+1)+"-Ig"+(t+1).toString();n.igLabel2Pos[e][l]=r.coord.clone().add(o.coord).multiplyScalar(.5)}let S='<div style="display:inline-block" class="icn3d-residueNum" title="Ig domain count">'+C.toString()+" Ig(s)</div>",w='<div id="'+n.pre+e+'_igseq_sequence" class="icn3d-ig icn3d-dl_sequence">';i&&(w='<div class="icn3d-dl_sequence">');let x='<div style="width:120px!important;" class="icn3d-seqTitle '+g+'" ig="0" from="'+v+'" to="'+_+'" shorttitle="'+b+'" index="0" setname="'+e+'_Igs" anno="sequence" chain="'+e+'" title="IgStRAnD Reference Numbers">'+b+" </div>";if(w+='<div class="icn3d-residueLine" style="white-space:nowrap;">',i?(w+='<div class="icn3d-annoTitle" anno="0" title="Custom Reference Numbers">Custom Ref. No.</div>',w+='<span class="icn3d-residueNum"></span>'):1==s?(w+='<div class="icn3d-annoTitle" anno="0" title="Kabat Reference Numbers">Kabat Ref. No.</div>',w+='<span class="icn3d-residueNum"></span>'):2==s?(w+='<div class="icn3d-annoTitle" anno="0" title="IMGT Reference Numbers">IMGT Ref. No.</div>',w+='<span class="icn3d-residueNum"></span>'):(w+=x,w+=S),l+=w+"<br>",a+=w+'<span class="icn3d-seqLine">',n.seqStartLen&&n.seqStartLen[e]&&(a+=n.showSeqCls.insertMulGap(n.seqStartLen[e],"-")),a+=f,n.seqStartLen&&n.seqStartLen[e]&&(a+=n.showSeqCls.insertMulGap(n.seqEndLen[e],"-")),i||(a+=S),a+="</span>",a+="<br>",a+="</div>",a+="</div>",m=n.chain2igArray[e],0==m.length)return{html:a,html2:o,html3:l};let A=[],M=[],T=[],E=[],R=e.substr(e.lastIndexOf("_")+1);for(let e=0,t=m.length;e<t;++e){let t=m[e].domainid;if(!n.domainid2info)continue;let i=n.domainid2info[t];if(!i)continue;let s=i.score,r=parseFloat(s)<n.refnumCls.TMThresholdIgType?"Ig":n.ref2igtype[i.refpdbname];M.push(r+" (TM:"+parseFloat(s).toFixed(2)+")"),T.push(r+" (TM:"+parseFloat(s).toFixed(2)+"), template: "+i.refpdbname+", type: "+n.ref2igtype[i.refpdbname]+", Seq. identity: "+parseFloat(i.seqid).toFixed(2)+", aligned residues: "+i.nresAlign+", label in 3D: "+R+"-Ig"+(e+1).toString()),E.push(r);let a=[];for(let t=0,i=m[e].startPosArray.length;t<i;++t)a.push({from:m[e].startPosArray[t],to:m[e].endPosArray[t]});let o={};o.locs=[{segs:a}],A.push(o)}if(0==A.length)return{html:a,html2:o,html3:l};if(!s&&!i){let t,i;o+=x,o+=S+'<span class="icn3d-seqLine">',n.seqStartLen&&n.seqStartLen[e]&&(o+=n.showSeqCls.insertMulGapOverview(e,n.seqStartLen[e]));for(let s=0,r=v.length;s<r;++s){let r=e+"_"+n.ParserUtilsCls.getResi(e,v[s]),a=y[v[s]];if(a!=t){let e=n.firstAtomObjCls.getFirstAtomObj(n.residues[r]),t=e&&void 0!==e.color&&"FFFFFF"!==e.color.getHexString()?e.color.getHexString():"DDDDDD";i=e&&void 0!==e.color?t:"CCCCCC"}o+='<div style="display:inline-block; width:'+(0==s?Math.round(n.seqAnnWidth*v[s]/n.maxAnnoLength):Math.round(n.seqAnnWidth*(v[s]-_[s-1]-1)/n.maxAnnoLength))+'px;">&nbsp;</div>',o+='<div style="display:inline-block; color:white!important; font-weight:bold; background-color:#'+i+"; width:"+Math.round(n.seqAnnWidth*(_[s]-v[s]+1)/n.maxAnnoLength)+'px;" class="icn3d-seqTitle '+g+'" ig="0" from="'+v+'" to="'+_+'" shorttitle="'+E[a]+'" index="0" setname="'+e+'_igs" id="'+e+'_igs" anno="sequence" chain="'+e+'" title="'+E[a]+'">'+E[a]+" </div>",t=a}o+=S,o+="</div></div>",l+="</div></div>",w='<div id="'+n.pre+e+'_igseq_sequence" class="icn3d-ig icn3d-dl_sequence">';let s=w,r=w,d=n.annoCddSiteCls.setDomainFeature(A,e,"ig",w,s,r,void 0,M,T);a+=d.html+"</div>",o+=d.html2+"</div>",l+=d.html3+"</div>"}return{html:a,html2:o,html3:l}}getRefnumHtml(e,t,i,s,n,r,a){let o=this.icn3d,l=o.icn3dui,d=parseInt(t).toString(),c=(d-1e3*parseInt(d/1e3)).toString(),h=parseInt(d.toString().substr(0,2)),p="5"!=c.substr(0,1)&&"18"!=h,u=this.getRefnumColor(n,!0),m=r?'style="color:'+u+'"':'style="color:'+u+'; text-decoration: underline overline;"',f=d.substr(d.length-2,2),g=parseInt(f);parseInt(d.substr(d.length-3,3));let b="";return!s||50!=g||p||r?s&&g%2==0&&52!=g&&!a?(f=isNaN(t)?f+t.substr(t.length-1,1):f,b+="<span "+m+' title="'+s+'">'+f+"</span>"):b+="<span "+m+' title="'+s+'">&nbsp;</span>':(o.hAtomsRefnum=l.hashUtilsCls.unionHash(o.hAtomsRefnum,o.residues[e]),b+="<span "+m+' title="'+s+'"><b>'+s.substr(0,1)+"</b>"+s.substr(1)+"</span>"),b}getRefnumColor(e,t){let i=this.icn3d.icn3dui,s=e?e.substr(0,1):"";return"C"==e?"#0000FF":"C'"==e?"#6495ED":"C''"==e?"#006400":"A"==s?"#9400D3":"B"==s?"#ba55d3":"D"==s?"#00FF00":"E"==s?"#FFD700":"F"==s?"#FF8C00":"G"==s?"#FF0000":i.htmlCls.GREYB}getProtodomainColor(e){let t=this.icn3d.icn3dui,i=e?e.substr(0,1):"";return"A"==i||"D"==i?"#0000FF":"B"==i||"E"==i?"#006400":"C"==e||"F"==i?"#FFD700":"C'"==e||"G"==i?"#FF8C00":"C''"==e?"#FF0000":t.htmlCls.GREYB}}class rh{constructor(e){this.icn3d=e}showCrosslink(e,t){let i=this.icn3d;i.icn3dui;let s=this;void 0===i.clbondpnts?setTimeout((function(){s.showCrosslink_base(e,t)}),1e3):this.showCrosslink_base(e,t)}showCrosslink_base(e,t){let i=this.icn3d;i.icn3dui.bNode&&(i.resid2crosslink||(i.resid2crosslink={}),i.resid2crosslink[e]||(i.resid2crosslink[e]=[]));let s=t,n={},r=s.substr(0,s.indexOf("_")),a=i.clbondpnts[r];if(void 0===a)return $("#"+i.pre+"dt_crosslink_"+e).html(""),$("#"+i.pre+"ov_crosslink_"+e).html(""),void $("#"+i.pre+"tt_crosslink_"+e).html("");for(let e=0,t=a.length;e<t;e+=2){let t=a[e],i=a[e+1];t.substr(0,t.lastIndexOf("_")),s===i.substr(0,i.lastIndexOf("_"))&&(void 0===n[i]&&(n[i]=[]),n[i].push(t))}let o=Object.keys(n);i.annoCddSiteCls.showAnnoType(e,t,"crosslink","Cross-Linkages",o,n)}}class ah{constructor(e){this.icn3d=e}showDomainPerStructure(e,t){let i=this.icn3d;i.icn3dui;let s=this,n=Object.keys(i.structures)[e],r={domains:{}};for(let e in i.chains){if(n==e.substr(0,e.indexOf("_"))){r.domains[e]={},r.domains[e].domains=[];let t=i.chains[e],s=i.domain3dCls.c2b_NewSplitChain(t).subdomains;for(let t=0,i=s.length;t<i;++t){let i={intervals:[]};for(let e=0,n=s[t].length;e<n;e+=2)i.intervals.push([s[t][e],s[t][e+1]]);r.domains[e].domains.push(i)}}}i.mmdb_dataArray[e]=r;for(let r in i.chains)-1!==r.indexOf(n)&&s.showDomainWithData(r,i.mmdb_dataArray[e],t);i.bAjax3ddomain=!0,i.bAjaxDoneArray[e]=!0}showDomainAll(e){let t=this.icn3d;t.icn3dui;let i=Object.keys(t.structures);t.mmdb_dataArray=[],t.bAjaxDoneArray=[];for(let e=0,s=i.length;e<s;++e)t.bAjaxDoneArray[e]=!1;for(let t=0,s=i.length;t<s;++t)this.showDomainPerStructure(t,e)}getResiFromNnbiresid(e){let t=this.icn3d;t.icn3dui;let i=t.ncbi2resid[e]?t.ncbi2resid[e]:e;return i.substr(i.lastIndexOf("_")+1)}getNcbiresiFromResid(e){let t=this.icn3d;t.icn3dui;let i=t.resid2ncbi[e]?t.resid2ncbi[e]:e;return i.substr(i.lastIndexOf("_")+1)}showDomainWithData(e,t,i){let s,n,r=this.icn3d,a=r.icn3dui,o='<div id="'+r.pre+e+'_domainseq_sequence" class="icn3d-dl_sequence">',l=o,d=o,c=e.indexOf("_"),h=e.substr(c+1);h.length>1&&"1"==h.substr(h.length-1)&&(h=h.substr(0,h.length-1)),n=e,s=t.domains[e]?t.domains[e].domains:[];for(let t=0,c=s.length;t<c;++t){let c="3D domain "+(t+1).toString()+" of "+n,h=c.length>17?c.substr(0,17)+"...":c,p=s[t].intervals,u=[],m=[],f={},g=0;for(let t=0,i=p.length;t<i;++t){let i=parseInt(p[t][0]),s=parseInt(p[t][1]);u.push(i),m.push(s),g+=s-i+1;for(let t=i;t<=s;++t){f[this.getResiFromNnbiresid(e+"_"+t)]=1}}if(r.chainid2clashedResidpair)for(let t in r.chainid2clashedResidpair){let i=t.split("|"),s=r.chainid2clashedResidpair[t].split("|");for(let n=0,a=i.length;n<a;++n){if(i[n][0]+"_"+i[n][1]==e){let e=i[n][3];f.hasOwnProperty(e)&&(r.chainid2clashedResidpair[t]=0==n?g+"|"+s[1]:s[1]+"|"+g)}}}if(a.bNode){let i="3D domain "+(t+1).toString();r.resid2domain||(r.resid2domain={}),r.resid2domain[e]||(r.resid2domain[e]=[]);for(let t=0,s=u.length;t<s;++t){let s=u[t],n=m[t];for(let t=s;t<=n;++t){let s={};s[r.ncbi2resid[e+"_"+t]]=i,r.resid2domain[e].push(s)}}}if(i)continue;let b='<div class="icn3d-seqTitle icn3d-link icn3d-blue" 3ddomain="'+(t+1).toString()+'" from="'+u+'" to="'+m+'" shorttitle="'+h+'" index="'+t+'" setname="'+e+"_3d_domain_"+(t+1).toString()+'" anno="sequence" chain="'+e+'" title="'+c+'">'+h+" </div>",C='<span class="icn3d-residueNum" title="residue count">'+g.toString()+" Res</span>";d+=b+C+"<br>";let v='<span class="icn3d-seqLine">';o+=b+C+v,l+=b+C+v;let _="domain3d"+t.toString();r.seqStartLen&&r.seqStartLen[e]&&(o+=r.showSeqCls.insertMulGap(r.seqStartLen[e],"-"));for(let t=0,i=r.giSeq[e].length;t<i;++t){o+=r.showSeqCls.insertGap(e,t,"-");let i=r.ParserUtilsCls.getResi(e,t);if(f.hasOwnProperty(i)){let s=r.giSeq[e][t],n=s;s.length>1&&(n=s[0]+"..");let a=i;o+='<span id="'+_+"_"+r.pre+e+"_"+a+'" title="'+n+a+'" class="icn3d-residue">'+s+"</span>"}else o+="<span>-</span>"}r.seqStartLen&&r.seqStartLen[e]&&(o+=r.showSeqCls.insertMulGap(r.seqEndLen[e],"-"));let y=r.firstAtomObjCls.getFirstCalphaAtomObj(r.chains[e]),S=void 0===y.color||"FFFFFF"===y.color.getHexString()?"DDDDDD":y.color.getHexString(),w=void 0!==y.color?S:"CCCCCC";if(r.seqStartLen&&r.seqStartLen[e]&&(l+=r.showSeqCls.insertMulGapOverview(e,r.seqStartLen[e])),a.cfg.blast_rep_id!=e)for(let i=0,s=u.length;i<s;++i){l+='<div style="display:inline-block; width:'+(0==i?Math.round(r.seqAnnWidth*u[i]/r.maxAnnoLength):Math.round(r.seqAnnWidth*(u[i]-m[i-1]-1)/r.maxAnnoLength))+'px;">&nbsp;</div>',l+='<div style="display:inline-block; color:white!important; font-weight:bold; background-color:#'+w+"; width:"+Math.round(r.seqAnnWidth*(m[i]-u[i]+1)/r.maxAnnoLength)+'px;" class="icn3d-seqTitle icn3d-link icn3d-blue" 3ddomain="'+(t+1).toString()+'" from="'+u+'" to="'+m+'" shorttitle="'+h+'" index="'+t+'" setname="'+e+"_3d_domain_"+(t+1).toString()+'" id="'+e+"_3d_domain_"+t+'" anno="sequence" chain="'+e+'" title="'+c+'">3D domain '+(t+1).toString()+"</div>"}else{let i=[],s=[];for(let e=0,t=u.length;e<t;++e){i.push(u[e]);for(let t=parseInt(u[e]);t<=parseInt(m[e]);++t)void 0!==r.targetGapHash&&r.targetGapHash.hasOwnProperty(t)&&(s.push(t-1),i.push(t));s.push(m[e])}for(let n=0,a=i.length;n<a;++n){l+=r.showSeqCls.insertGapOverview(e,i[n]),l+='<div style="display:inline-block; width:'+(0==n?Math.round(r.seqAnnWidth*(i[n]-r.baseResi[e]-1)/(r.maxAnnoLength+r.nTotalGap)):Math.round(r.seqAnnWidth*(i[n]-s[n-1]-1)/(r.maxAnnoLength+r.nTotalGap)))+'px;">&nbsp;</div>',l+='<div style="display:inline-block; color:white!important; font-weight:bold; background-color:#'+w+"; width:"+Math.round(r.seqAnnWidth*(s[n]-i[n]+1)/(r.maxAnnoLength+r.nTotalGap))+'px;" class="icn3d-seqTitle icn3d-link icn3d-blue" 3ddomain="'+(t+1).toString()+'" from="'+i+'" to="'+s+'" shorttitle="'+h+'" index="'+t+'" setname="'+e+"_3d_domain_"+(t+1).toString()+'" id="'+e+"_3d_domain_"+t+'" anno="sequence" chain="'+e+'" title="'+c+'">3D domain '+(t+1).toString()+"</div>"}}v='<span class="icn3d-residueNum" title="residue count">&nbsp;'+g.toString()+" Residues</span>",v+="</span>",v+="<br>",o+=v,l+=v}if(i||(o+="</div>",l+="</div>",d+="</div>",$("#"+r.pre+"dt_domain_"+e).html(o),$("#"+r.pre+"ov_domain_"+e).html(l),$("#"+r.pre+"tt_domain_"+e).html(d)),i&&r.chainid2clashedResidpair){r.clashedResidHash={};for(let e in r.chainid2clashedResidpair){let t=e.split("|"),i=r.chainid2clashedResidpair[e].split("|");parseInt(i[0])<parseInt(i[1])?r.clashedResidHash[t[0]]=1:r.clashedResidHash[t[1]]=1}let e={},t={};for(let i in r.clashedResidHash){let s=i.lastIndexOf("_"),n=parseInt(i.substr(s+1)),o=i.substr(0,s);"coil"==r.firstAtomObjCls.getFirstAtomObj(r.residues[i]).ss?(t=this.getMoreResidues(n,o,1,"not coil"),e=a.hashUtilsCls.unionHash(e,t),t=this.getMoreResidues(n,o,-1,"not coil"),e=a.hashUtilsCls.unionHash(e,t)):(t=this.getMoreResidues(n,o,1,"ssbegin"),e=a.hashUtilsCls.unionHash(e,t),t=this.getMoreResidues(n,o,-1,"ssend"),e=a.hashUtilsCls.unionHash(e,t))}r.clashedResidHash=a.hashUtilsCls.unionHash(r.clashedResidHash,e)}}showHideClashedResidues(){let e=this.icn3d,t=e.icn3dui;if(e.clashedResidHash&&Object.keys(e.clashedResidHash).length>0){let i={};for(let s in e.clashedResidHash)i=t.hashUtilsCls.unionHash(i,e.residues[s]);e.bHideClashed?e.hAtoms=t.hashUtilsCls.exclHash(e.hAtoms,i):e.hAtoms=t.hashUtilsCls.unionHash(e.hAtoms,i),e.dAtoms=t.hashUtilsCls.cloneHash(e.hAtoms)}}getMoreResidues(e,t,i,s){let n=this.icn3d;n.icn3dui;let r={};for(let a=1;a<100;++a){let o=t+"_"+(e+i*a).toString(),l=n.firstAtomObjCls.getFirstAtomObj(n.residues[o]);if(l){let e=!1;if("not coil"==s?e="coil"!=l.ss:"ssbegin"==s?e=l.ssbegin:"ssend"==s&&(e=l.ssend),e)break;r[o]=1}}return r}}class oh{constructor(e){this.icn3d=e}async showSnp(e,t){this.icn3d.icn3dui,await this.showSnpClinvar(e,t,!0)}async showClinvar(e,t){this.icn3d.icn3dui,await this.showSnpClinvar(e,t,!1)}async showSnpClinvar(e,t,i){let s=this.icn3d.icn3dui,n=this,r=s.htmlCls.baseUrl+"vastdyn/vastdyn.cgi?chainid="+t;try{let a=await s.getAjaxPromise(r,"jsonp"),o=a.snpgi,l=a.gi;if(i)await n.showSnpPart2(e,t,o);else{let i=o;[6137708,1942289,224510717,2624886,253723219,2554905,75765331,3660278,312207882,319443632,342350956,1827805,109157826,1065265,40889086,6730307,163931185,494469,163931091,60594093,55669745,18655489,17942684,6980537,166235465,6435586,4139398,4389047,364506122,78101667,262118402,20664221,2624640,158430173,494395,28948777,34810587,13399647,3660342,261278854,342350965,384482350,378792570,15988303,213424334,4558333,2098365,10835631,3318817,374074330,332639529,122919696,4389286,319443573,2781341,67464020,194709238,210061039,364506106,28949044,40889076,161172338,17943181,4557976,62738484,365813173,6137343,350610552,17942703,576308,223674070,15826518,1310997,93279697,4139395,255311799,157837067,361132363,357380836,146387678,383280379,1127268,299856826,13786789,1311054,46015217,3402130,381353319,30750059,218766885,340707375,27065817,355333104,2624634,62738384,241913553,304446010].includes(l)&&(i=l),await n.showClinvarPart2(e,t,i)}}catch(t){return void(i?n.processNoSnp(e):n.processNoClinvar(e))}}navClinVar(e){let t=this.icn3d;t.icn3dui;let i=this;t.currClin[e]=-1,$(document).on("click","#"+t.pre+e+"_prevclin",(function(t){let s=i.icn3d;t.stopImmediatePropagation();let n=void 0!==s.resi2disease_nonempty[e]?Object.keys(s.resi2disease_nonempty[e]).length:0;--s.currClin[e],s.currClin[e]<0&&(s.currClin[e]=n-1),i.showClinVarLabelOn3D(e)})),$(document).on("click","#"+t.pre+e+"_nextclin",(function(t){let s=i.icn3d;t.stopImmediatePropagation();let n=void 0!==s.resi2disease_nonempty[e]?Object.keys(s.resi2disease_nonempty[e]).length:0;++s.currClin[e],s.currClin[e]>n-1&&(s.currClin[e]=0),i.showClinVarLabelOn3D(e)}))}showClinVarLabelOn3D(e){let t,i,s=this.icn3d,n=s.icn3dui,r=Object.keys(s.resi2disease_nonempty[e]);t=e,i=t+"_"+(parseInt(r[s.currClin[e]])+s.baseResi[e]).toString();let a="",o=s.resi2disease_nonempty[e][r[s.currClin[e]]];for(let e=0,t=o.length;e<t;++e)if(""!=o[e]&&"not specified"!=o[e]&&"not provided"!=o[e]){a=o[e];break}""==a&&(a=o.length>0?o[0]:"N/A");let l=s.applyCenterCls.centerAtoms(n.hashUtilsCls.hash2Atoms(s.residues[i],s.atoms));a.length>30&&(a=a.substr(0,30)+"..."),s.selectionCls.removeSelection(),null==s.labels&&(s.labels={}),s.labels.clinvar=[];let d=s.LABELSIZE,c="black"!=s.opts.background?s.colorWhitebkgd:s.colorBlackbkgd;s.analysisCls.addLabel(a,l.center.x+1,l.center.y+1,l.center.z+1,d,c,void 0,"clinvar"),s.hAtoms={};for(let e in s.residues[i])s.hAtoms[e]=1;$("#clinvar_"+s.pre+i).addClass("icn3d-highlightSeq"),void 0===$("#"+s.pre+"modeswitch")[0]||$("#"+s.pre+"modeswitch")[0].checked||s.definedSetsCls.setMode("selection"),s.drawCls.draw()}getSnpLine(e,t,i,s,n,r,a,o,l,d,c,h,p,u,m,f){let g=this.icn3d,b=g.icn3dui,C="",v=u?"clinvar":"snp",_=!1;for(let e in s){for(let t=0,i=s[e].length;t<i;++t)if(0==s[e][t]){_=!0;break}if(_)break}if(c){let e="ClinVar",t="SNP",i="",s="";_||void 0===g.organism||"human"===g.organism.toLowerCase()||"homo sapiens"===g.organism.toLowerCase()||(i=" <span style='color:#FFA500'>(from human)</span>",s=" <span style='color:#FFA500'>(based on human sequences and mapped to this structure by sequence similarity)</span>"),C+=u?'<div class="icn3d-seqTitle icn3d-link icn3d-blue icn3d-clinvar-path" clinvar="clinvar" posarray="'+d+'" shorttitle="'+e+'" setname="'+h+"_"+e+'" anno="sequence" chain="'+h+'" title="'+e+s+'">'+e+i+"</div>":'<div class="icn3d-seqTitle icn3d-link icn3d-blue" clinvar="clinvar" posarray="'+l+'" shorttitle="'+t+'" setname="'+h+"_"+t+'" anno="sequence" chain="'+h+'" title="'+t+s+'">'+t+i+"</div>"}else if(2==e&&u){let e=b.utilsCls.isMobile()?"none":"button";C+='<div id="'+g.pre+h+'_prevclin" style="display:inline-block; font-size:11px; font-weight:bold; width:60px!important;"><button class="link" style="-webkit-appearance:'+e+'; height:18px; width:55px;"><span style="white-space:nowrap; margin-left:-40px;" title="Show the previous ClinVar on structure">&lt; ClinVar</span></button></div>',C+='<div id="'+g.pre+h+'_nextclin" style="display:inline-block; font-size:11px; font-weight:bold; width:60px!important;"><button class="link" style="-webkit-appearance:'+e+'; height:18px; width:55px;"><span style="white-space:nowrap; margin-left:-40px;" title="Show the next ClinVar on structure">ClinVar &gt;</span></button></div>'}else C+='<div class="icn3d-seqTitle"></div>';let y=v,S=0,w=0,x={},A=g.firstAtomObjCls.getResiduesFromAtoms(g.chains[h]);for(let t in A){let s=t.split("_")[2];if(void 0!==a[s]){++S;let t="";for(let n=0,a=i[s].length;n<a&&!f;++n){let i=r[s][n].split("; "),a=o[s][n].split("; "),l="";for(let e=0,t=i.length;e<t;++e)l+=i[e],""!=a[e]&&(l+="("+a[e]+")"),l+="; ";""!=l&&(x[s]="icn3d-clinvar",n==e-2&&l.indexOf("Pathogenic")),t+=l+" | "}-1!=t.indexOf("Pathogenic")&&(x[s]="icn3d-clinvar-path"),"icn3d-clinvar"!=x[s]&&"icn3d-clinvar-path"!=x[s]||++w}}if(0==S&&!u)return $("#"+g.pre+"dt_clinvar_"+h).html(""),$("#"+g.pre+"ov_clinvar_"+h).html(""),$("#"+g.pre+"tt_clinvar_"+h).html(""),$("#"+g.pre+"dt_snp_"+h).html(""),$("#"+g.pre+"ov_snp_"+h).html(""),$("#"+g.pre+"tt_snp_"+h).html(""),"";if(0==w&&u)return $("#"+g.pre+"dt_clinvar_"+h).html(""),$("#"+g.pre+"ov_clinvar_"+h).html(""),$("#"+g.pre+"tt_clinvar_"+h).html(""),"";let M=u?w:S;if(C+=1==e?'<span class="icn3d-residueNum" title="residue count">'+M+" Res</span>":'<span class="icn3d-residueNum"></span>',m)return C+"<br>";C+='<span class="icn3d-seqLine">';let T="",E=0,R=0;p?g.seqStartLen&&g.seqStartLen[h]&&(C+=g.showSeqCls.insertMulGapOverview(h,g.seqStartLen[h])):g.seqStartLen&&g.seqStartLen[h]&&(C+=g.showSeqCls.insertMulGap(g.seqStartLen[h],"-"));for(let t=1,l=g.giSeq[h].length;t<=l;++t){let l=g.ParserUtilsCls.getResi(h,t-1),d=l;if(p){if(void 0!==a[d]){let e=g.giSeq[h][t-1],s=e;e.length>1&&(s=e[0]+"..");let n=l+s+">";for(let e=0,t=i[d].length;e<t;++e)if(n+=i[d][e],!f){let t=r[d][e].split("; "),i=o[d][e].split("; "),s="";for(let e=0,n=t.length;e<n;++e)s+=t[e],""!=i[e]&&(s+="("+i[e]+")"),s+="; "}C+=g.showSeqCls.insertGapOverview(h,t-1);let a=Math.round(g.seqAnnWidth*(t-1)/(g.maxAnnoLength+g.nTotalGap)-E-R);u?a>=0&&(C+='<div style="display:inline-block; width:'+a+'px;">&nbsp;</div>',C+='<div style="display:inline-block; background-color:#000; width:1px;" title="'+n+'">&nbsp;</div>',E+=a,R+=1):a>0&&(C+='<div style="display:inline-block; width:'+a+'px;">&nbsp;</div>',C+='<div style="display:inline-block; background-color:#000; width:1px;" title="'+n+'">&nbsp;</div>',E+=a,R+=1)}}else if(C+=g.showSeqCls.insertGap(h,t-1,"-"),void 0!==a[d])if(u||1!=e){let a=g.giSeq[h][t-1],c=a;a.length>1&&(c=a[0]+"..");let p,m="",v="<div class='snptip'>",_=i[d].length,S=0,w=0;if(2==e&&(S=0,w=_),u){p=1;let t=0;for(let e=S;e<_&&e<w;++e){let a=h+"_"+l+"_"+i[d][e],u=b.utilsCls.isMobile()?"none":"button",f=!0;g.residues.hasOwnProperty(h+"_"+l)||(f=!1);let C=r[d][e].split("; "),y=o[d][e].split("; "),S="",w=0;for(let t=0,i=C.length;t<i;++t)w>0?S+="; ":0!==e&&1!==e||(T='disease="'+C[t]+'"'),S+=C[t],""!=y[t]&&(S+="("+y[t]+")"),++w;t<p&&(m+=i[d][e]),v+=l+c+">"+i[d][e],v+=": "+S,f&&!b.cfg.hidelicense&&(v+="<br>"+g.showAnnoCls.addSnpButton(a,"snpin3d","3D with scap","SNP in 3D with scap",70,u)+"&nbsp;&nbsp;",v+=g.showAnnoCls.addSnpButton(a,"snpinter","Interactions","SNP Interactions in 3D",70,u)+"&nbsp;&nbsp;",v+=g.showAnnoCls.addSnpButton(a,"snppdb","PDB","Download SNP PDB",35,u)),v+="<br>Links: <a href='https://www.ncbi.nlm.nih.gov/clinvar/?term="+n[d][e]+"[AlleleID]' style='color:blue' target='_blank'>ClinVar</a>",0!=s[d][e]&&(v+=", <a href='https://www.ncbi.nlm.nih.gov/snp/?term="+s[d][e]+"' style='color:blue' target='_blank'>dbSNP(rs"+s[d][e]+")</a>"),e<_-1&&(v+="<br><br>"),++t}t>p&&2==e&&(m+="..")}else{p=1;for(let e=S;e<_&&e<w;++e){let t=h+"_"+l+"_"+i[d][e],a=b.utilsCls.isMobile()?"none":"button",u=!0;if(g.residues.hasOwnProperty(h+"_"+l)||(u=!1),e<p&&(m+=i[d][e]),v+=l+c+">"+i[d][e],f)u&&!b.cfg.hidelicense&&(v+="<br>"+g.showAnnoCls.addSnpButton(t,"snpin3d","3D with scap","SNP in 3D with scap",70,a)+"&nbsp;&nbsp;",v+=g.showAnnoCls.addSnpButton(t,"snpinter","Interactions","SNP Interactions in 3D",70,a)+"&nbsp;&nbsp;",v+=g.showAnnoCls.addSnpButton(t,"snppdb","PDB","Download SNP PDB",35,a)),0!=s[d][e]&&(v+="<br>Link: <a href='https://www.ncbi.nlm.nih.gov/snp/?term="+s[d][e]+"' target='_blank'>dbSNP(rs"+s[d][e]+")</a>"),e<_-1&&(v+="<br><br>");else{let i=r[d][e].split("; "),l=o[d][e].split("; "),c="",h=0;for(let t=0,s=i.length;t<s;++t)h>0?c+="; ":0!==e&&1!==e||(T='disease="'+i[t]+'"'),c+=i[t],""!=l[t]&&(c+="("+l[t]+")"),++h;""!=c?(v+=": "+c,u&&!b.cfg.hidelicense&&(v+="<br>"+g.showAnnoCls.addSnpButton(t,"snpin3d","3D with scap","SNP in 3D with scap",70,a)+"&nbsp;&nbsp;",v+=g.showAnnoCls.addSnpButton(t,"snpinter","Interactions","SNP Interactions in 3D",70,a)+"&nbsp;&nbsp;",v+=g.showAnnoCls.addSnpButton(t,"snppdb","PDB","Download SNP PDB",35,a)),v+="<br>Links: <a href='https://www.ncbi.nlm.nih.gov/clinvar/?term="+n[d][e]+"[AlleleID]' style='color:blue' target='_blank'>ClinVar</a>, <a href='https://www.ncbi.nlm.nih.gov/snp/?term="+s[d][e]+"' style='color:blue' target='_blank'>dbSNP(rs"+s[d][e]+")</a>"):(u&&!b.cfg.hidelicense&&(v+="<br>"+g.showAnnoCls.addSnpButton(t,"snpin3d","3D with scap","SNP in 3D with scap",70,a)+"&nbsp;&nbsp;",v+=g.showAnnoCls.addSnpButton(t,"snpinter","Interactions","SNP Interactions in 3D",70,a)+"&nbsp;&nbsp;",v+=g.showAnnoCls.addSnpButton(t,"snppdb","PDB","Download SNP PDB",35,a)),v+="<br>Link: <a href='https://www.ncbi.nlm.nih.gov/snp/?term="+s[d][e]+"' target='_blank'>dbSNP(rs"+s[d][e]+")</a>"),e<_-1&&(v+="<br><br>")}}_>p&&2==e&&(m+="..")}v+="</div>",C+=u?1==e?"<span>&dArr;</span>":""==m||" "==m?"<span>-</span>":'<span id="'+y+"_"+g.pre+h+"_"+l+'" label title="'+v+'" '+T+' class="icn3d-tooltip icn3d-residue '+x[d]+'">'+m+"</span>":""==m||" "==m?"<span>-</span>":f?'<span id="'+y+"_"+g.pre+h+"_"+l+'" label title="'+v+'" class="icn3d-tooltip icn3d-residue '+x[d]+'">'+m+"</span>":'<span id="'+y+"_"+g.pre+h+"_"+l+'" label title="'+v+'" '+T+' class="icn3d-tooltip icn3d-residue '+x[d]+'">'+m+"</span>"}else C+="<span>&dArr;</span>";else C+="<span>-</span>"}return p||g.seqStartLen&&g.seqStartLen[h]&&(C+=g.showSeqCls.insertMulGap(g.seqEndLen[h],"-")),C+=1==e?'<span class="icn3d-residueNum" title="residue count">&nbsp;'+M+" Residues</span>":'<span class="icn3d-residueNum"></span>',C+="</span>",C+="<br>",C}processSnpClinvar(e,t,i,s,n){let r=this.icn3d,a=r.icn3dui,o='<div id="'+r.pre+t+'_snpseq_sequence" class="icn3d-dl_sequence">',l=o,d=o,c='<div id="'+r.pre+t+'_clinvarseq_sequence" class="icn3d-dl_sequence">',h=c,p=c,u=!s||n?e.data:e.split("\n"),m={},f={},g={};void 0===r.resi2disease_nonempty[t]&&(r.resi2disease_nonempty[t]={});let b={},C={},v={},_={},y={},S="";a.bNode&&(s?(r.resid2snp||(r.resid2snp={}),r.resid2snp[t]||(r.resid2snp[t]=[])):(r.resid2clinvar||(r.resid2clinvar={}),r.resid2clinvar[t]||(r.resid2clinvar[t]=[])));let w={};for(let e=0,i=u.length;e<i;++e)if(""!=u[e]){let i=!s||n?u[e]:u[e].split("\t"),o=i[3],l=i[4],d=!1;if(s?i.length>5&&(d=parseInt(i[5])):i.length>8&&(d=parseInt(i[8])),o==S)continue;S=o;let c=o.indexOf(">"),h=o.substr(0,c-1),p=Math.round(h),x=d?p:r.ParserUtilsCls.getResi(t,p-1),A=x+o.substr(c-1);if(w.hasOwnProperty(A))continue;w[A]=1;let M=o.substr(c-1,1),T=r.firstAtomObjCls.getFirstAtomObj(r.residues[t+"_"+x]),E=T?a.utilsCls.residueName2Abbr(T.resn.substr(0,3)):"";if(d||(E=r.chainsSeq[t][p-1].name),M!=E)continue;if(a.bNode){let e={};e[t+"_"+x]=A,s?r.resid2snp[t].push(e):r.resid2clinvar[t].push(e)}let R=A.substr(A.indexOf(">")+1),k=s?"":i[5],O=s?"":i[6],I=s?"":i[7];_[x]=1,""!=O&&(y[x]=1),f[x]=e+1,void 0===m[x]&&(m[x]=[]),m[x].push(R),void 0===C[x]&&(C[x]=[]),C[x].push(l),void 0===v[x]&&(v[x]=[]),v[x].push(k),void 0===g[x]&&(g[x]=[]),g[x].push(O),""!=O&&(void 0===r.resi2disease_nonempty[t][x]&&(r.resi2disease_nonempty[t][x]=[]),r.resi2disease_nonempty[t][x].push(O)),void 0===b[x]&&(b[x]=[]),b[x].push(I)}let x=Object.keys(_),A=Object.keys(y);if(s){let e=!1;o+=this.getSnpLine(1,2,m,C,v,g,f,b,x,A,1,t,!1,e,void 0,s),o+=this.getSnpLine(2,2,m,C,v,g,f,b,x,A,0,t,!1,e,void 0,s),d+=this.getSnpLine(1,2,m,C,v,g,f,b,x,A,1,t,!1,e,!0,s),d+=this.getSnpLine(2,2,m,C,v,g,f,b,x,A,0,t,!1,e,!0,s),l+=this.getSnpLine(1,2,m,C,v,g,f,b,x,A,1,t,!0,e,void 0,s),o+="</div>",l+="</div>",d+="</div>",$("#"+r.pre+"dt_snp_"+t).html(o),$("#"+r.pre+"ov_snp_"+t).html(l),$("#"+r.pre+"tt_snp_"+t).html(d)}else{let e=!0;c+=this.getSnpLine(1,2,m,C,v,g,f,b,x,A,1,t,!1,e,void 0,s),c+=this.getSnpLine(2,2,m,C,v,g,f,b,x,A,0,t,!1,e,void 0,s),p+=this.getSnpLine(1,2,m,C,v,g,f,b,x,A,1,t,!1,e,!0,s),p+=this.getSnpLine(2,2,m,C,v,g,f,b,x,A,0,t,!1,e,!0,s),h+=this.getSnpLine(1,2,m,C,v,g,f,b,x,A,1,t,!0,e,void 0,s),c+="</div>",h+="</div>",p+="</div>",$("#"+r.pre+"dt_clinvar_"+t).html(c),$("#"+r.pre+"ov_clinvar_"+t).html(h),$("#"+r.pre+"tt_clinvar_"+t).html(p),this.navClinVar(t,i)}r.showAnnoCls.enableHlSeq(),s?r.bAjaxSnp=!0:r.bAjaxClinvar=!0}async showClinvarPart2(e,t,i){let s=this.icn3d,n=s.icn3dui,r=this;s.chainid2uniport||await this.getUniprotForAllStructures();let a=n.htmlCls.baseUrl+"vastdyn/vastdyn.cgi?chainid_clinvar="+t+"&uniprot="+s.chainid2uniport[t];s.chainsGene[e]&&s.chainsGene[e].geneSymbol&&(a+="&gene="+s.chainsGene[e].geneSymbol);try{let i=await n.getAjaxPromise(a,"jsonp");if(i&&i.data&&i.data.length>0){let s=!1,n=i;r.processSnpClinvar(n,e,t,s)}else r.processNoClinvar(e)}catch(t){return void r.processNoClinvar(e)}}async getUniprotForAllStructures(){let e=this.icn3d,t=e.icn3dui;e.chainid2uniport={};for(let i in e.structures)if(i.length>5){let t=e.structures[i];for(let s=0,n=t.length;s<n;++s)e.chainid2uniport[t[s]]=i}else{let s=i.toLowerCase(),n="https://www.ebi.ac.uk/pdbe/api/mappings/uniprot/"+s,r=(await t.getAjaxPromise(n,"json"))[s].UniProt;for(let t in r){let s=r[t].mappings;for(let n=0,r=s.length;n<r;++n){let r=s[n].chain_id;e.chainid2uniport[i+"_"+r]=t}}}}async showSnpPart2(e,t,i){let s=this.icn3d,n=s.icn3dui,r=this;if(s.chainid2uniport||await this.getUniprotForAllStructures(),void 0!==i){let i=n.htmlCls.baseUrl+"vastdyn/vastdyn.cgi?chainid_snp="+t+"&uniprot="+s.chainid2uniport[t];s.chainsGene[e]&&s.chainsGene[e].geneSymbol&&(i+="&gene="+s.chainsGene[e].geneSymbol);try{let s=await n.getAjaxPromise(i,"jsonp");if(s&&s.data&&s.data.length>0){let i=!0,n=!0;r.processSnpClinvar(s,e,t,i,n)}else r.processNoSnp(e)}catch(t){return void r.processNoSnp(e)}}else this.processNoSnp(e),console.log("No gi was found for the chain "+t+"...")}processNoClinvar(e){let t=this.icn3d;t.icn3dui,console.log("No ClinVar data were found for the protein "+e+"..."),$("#"+t.pre+"dt_clinvar_"+e).html(""),$("#"+t.pre+"ov_clinvar_"+e).html(""),t.showAnnoCls.enableHlSeq(),t.bAjaxClinvar=!0}processNoSnp(e){let t=this.icn3d;t.icn3dui,console.log("No SNP data were found for the protein "+e+"..."),$("#"+t.pre+"dt_snp_"+e).html(""),$("#"+t.pre+"ov_snp_"+e).html(""),t.showAnnoCls.enableHlSeq(),t.bAjaxSnp=!0}}class lh{constructor(e){this.icn3d=e}showSsbond(e,t){let i=this.icn3d;i.icn3dui;let s=this;void 0===i.ssbondpnts?setTimeout((function(){s.showSsbond_base(e,t)}),1e3):this.showSsbond_base(e,t)}showSsbond_base(e,t){let i=this.icn3d;i.icn3dui.bNode&&(i.resid2ssbond||(i.resid2ssbond={}),i.resid2ssbond[e]||(i.resid2ssbond[e]=[]));let s=t,n={},r=s.substr(0,s.indexOf("_")),a=i.ssbondpnts[r];if(void 0===a)return $("#"+i.pre+"dt_ssbond_"+e).html(""),$("#"+i.pre+"ov_ssbond_"+e).html(""),void $("#"+i.pre+"tt_ssbond_"+e).html("");for(let e=0,t=a.length;e<t;e+=2){let t=a[e],i=a[e+1],r=t.substr(0,t.lastIndexOf("_")),o=i.substr(0,i.lastIndexOf("_"));s===r&&(void 0===n[t]&&(n[t]=[]),n[t].push(i)),s===o&&(void 0===n[i]&&(n[i]=[]),n[i].push(t))}let o=Object.keys(n);i.annoCddSiteCls.showAnnoType(e,t,"ssbond","Disulfide Bonds",o,n)}}class dh{constructor(e){this.icn3d=e}showTransmem(e,t){let i=this.icn3d;i.icn3dui;let s=this;void 0===i.ssbondpnts?setTimeout((function(){s.showTransmem_base(e,t)}),1e3):this.showTransmem_base(e,t)}showTransmem_base(e,t){let i=this.icn3d;i.icn3dui;let s={};for(let e in i.chains[t]){let t=i.atoms[e];if(t.coord.z<i.halfBilayerSize&&t.coord.z>-i.halfBilayerSize){s[t.structure+"_"+t.chain+"_"+t.resi]=1}}let n=Object.keys(s);i.annoCddSiteCls.showAnnoType(e,t,"transmem","Transmembrane",n)}}class ch{constructor(e){this.icn3d=e,this.init3ddomain()}init3ddomain(){this.icn3d.icn3dui,this.dcut=8,this.min_contacts=2,this.MAX_SSE=512,this.ctc_cnt=[];for(let e=0;e<this.MAX_SSE;++e)this.ctc_cnt[e]=[];this.elt_size=[],this.elt_size.length=this.MAX_SSE,this.group_num=[],this.group_num.length=this.MAX_SSE,this.split_ratio=.25,this.min_size=25,this.min_sse=3,this.max_csz=4,this.mean_cts=0,this.c_delta=3,this.nc_fact=0,this.elements=[],this.elements.length=2*this.MAX_SSE,this.stack=[],this.stack.length=this.MAX_SSE,this.top=0,this.curr_prt0=[],this.curr_prt0.length=this.MAX_SSE,this.curr_prt1=[],this.curr_prt1.length=this.MAX_SSE,this.curr_ne0=0,this.curr_ne1=0,this.curr_ratio=0,this.curr_msize=0,this.parts=[],this.parts.length=2*this.MAX_SSE,this.np=0,this.n_doms=0,this.save_ratios=[],this.save_ratios.length=this.MAX_SSE,this.saved=0}update_partition(e,t,i){this.icn3d.icn3dui;let s,n,r,a,o,l,d,c,h,p,u,m,f,g,b=[],C=[],v=[],_=[];for(v.length=this.MAX_SSE,_.length=this.MAX_SSE,s=this.stack[this.top-1],n=this.elements.length;s<n;++s)b.push(this.elements[s]);let y=!0;for(C=v,s=c=h=p=0,a=-1;s<t;s++){for(r=a+1;r<=e[s];r++)C[c++]=b[r];a=e[s],y?(h=c,C=_,c=p,y=!1):(p=c,C=v,c=h,y=!0)}for(r=a+1;r<i;r++)C[c++]=b[r];if(y?h=c:p=c,h<this.min_sse&&p<this.min_sse)return e;for(s=0;s<h;s++)for(a=this.group_num[v[s]],r=0;r<p;r++)if(a==this.group_num[_[r]])return e;for(s=u=0;s<h;s++)u+=this.elt_size[v[s]];for(s=m=0;s<p;s++)m+=this.elt_size[_[s]];for(s=o=0;s<h;s++)for(r=s;r<h;r++)o+=this.ctc_cnt[v[s]][v[r]];for(s=l=0;s<p;s++)for(r=s;r<p;r++)l+=this.ctc_cnt[_[s]][_[r]];if(1*o/u<this.mean_cts||1*l/m<this.mean_cts)return e;for(o=Math.max(o,this.nc_fact*u),l=Math.max(l,this.nc_fact*m),s=d=0;s<h;s++)for(a=v[s],r=0;r<p;r++)d+=this.ctc_cnt[a][_[r]];if(f=Math.min(o,l),g=1*d/(f+1),g>=this.curr_ratio+.01||g>this.split_ratio)return e;if(g>this.curr_ratio-.01&&Math.min(u,m)<this.curr_msize)return e;for(s=0;s<h;s++)this.curr_prt0[s]=v[s];for(s=0;s<p;s++)this.curr_prt1[s]=_[s];return this.curr_ne0=h,this.curr_ne1=p,this.curr_ratio=g,this.curr_msize=Math.min(u,m),e}cut_size(e,t){this.icn3d.icn3dui;let i,s,n,r=[];for(r.length=this.MAX_SSE,i=0;i<e;i++)r[i]=i;for(;;){for(i=n=1;i<e;i++)if(r[i]-r[i-1]<=this.c_delta){n=0;break}for(n&&r[e-1]<t-1&&(r=this.update_partition(r,e,t)),s=e-1;s>=0&&r[s]==t-e+s;s--);if(s<0)break;for(r[s]++,i=s+1;i<e;i++)r[i]=r[i-1]+1}}process_set(){this.icn3d.icn3dui;let e,t,i,s,n,r,a=[];for(e=this.stack[this.top-1],t=this.elements.length;e<t;++e)a.push(this.elements[e]);for(s=0;s<a.length&&a[s]>-1;s++);for(r=Math.min(s-1,this.max_csz),this.curr_ne0=this.curr_ne1=0,this.curr_ratio=100,i=1;i<=r;i++)this.cut_size(i,s);if(this.top--,0==this.curr_ne0){for(n=this.stack[this.top],e=n;e<this.elements.length&&this.elements[e]>-1;e++)this.parts[this.np++]=this.elements[e];this.parts[this.np++]=-1,this.n_doms++}else{if(this.save_ratios[this.saved++]=this.curr_ratio,this.curr_ne0>this.min_sse){for(n=this.stack[this.top],e=0;e<this.curr_ne0;e++)this.elements[n++]=this.curr_prt0[e];this.elements[n++]=-1,this.stack[++this.top]=n}else{for(e=0;e<this.curr_ne0;e++)this.parts[this.np++]=this.curr_prt0[e];this.parts[this.np++]=-1,this.n_doms++}if(this.curr_ne1>this.min_sse){for(n=this.stack[this.top],e=0;e<this.curr_ne1;e++)this.elements[n++]=this.curr_prt1[e];this.elements[n++]=-1,this.stack[++this.top]=n}else{for(e=0;e<this.curr_ne1;e++)this.parts[this.np++]=this.curr_prt1[e];this.parts[this.np++]=-1,this.n_doms++}}}process_all(e){let t;for(this.icn3d.icn3dui,this.top=1,this.stack[0]=this.np=this.n_doms=0,this.saved=0,t=0;t<e;t++)this.elements[t]=t;for(this.elements[e]=-1;this.top>0;)this.process_set()}output(e){let t,i;this.icn3d.icn3dui;let s=[];for(t=0;t<2*e;t++)s.push(0);for(t=i=0;i<this.n_doms;t++)s[t]=this.parts[t]+1,this.parts[t]<0&&i++;return s}new_split_chain(e,t,i,s,n,r,a,o,l,d,c){let h;for(this.icn3d.icn3dui,this.split_ratio=t,this.min_size=i,this.min_sse=s,this.max_csz=n,this.mean_cts=r,this.c_delta=a,this.nc_fact=o,this.process_all(e),this.parts=this.output(e),d=this.saved,h=0;h<this.saved;h++)c[h]=this.save_ratios[h];return d}c2b_AlphaContacts(e,t,i,s,n,r){this.icn3d.icn3dui,n||(n=this.dcut);let a=[],o=[];for(let n=0;n<e;n++){if(!t[n]||!i[n]||!s[n])continue;let e={};e.rnum=r[n],e.x=t[n],e.y=i[n],e.z=s[n],o.push(e)}o.sort((function(e,t){return e.x-t.x}));let l,d,c=o.length;for(l=0;l<c;++l){let e=o[l],t=e.x,i=e.y,s=e.z;for(d=l+1;d<c;++d){let r=o[d];if(parseInt(e.rnum)-parseInt(r.rnum)<=3&&parseInt(r.rnum)-parseInt(e.rnum)<=3)continue;let l=r.x,c=r.y,h=r.z;if(l>t+n)break;let p=(t-l)*(t-l);p+=(i-c)*(i-c),p+=(s-h)*(s-h);let u=Math.sqrt(p);if(u>n)continue;let m={},f={};parseInt(e.rnum)<parseInt(r.rnum)?(f.first=e.rnum,f.second=r.rnum):(f.first=r.rnum,f.second=e.rnum),m.first=f,m.second=u,a.push(m)}}return a}c2b_ContactTable(e,t){this.icn3d.icn3dui;let i={},s=e.length;if(s!=t.length)return i;for(let n=0;n<s;n++){let s=e[n]+"_"+t[n];i[s]?i[s]++:i[s]=1}return i}countUtil(e,t,i){this.visited[e]=!0,this.groupnum2sheet[i]||(this.groupnum2sheet[i]=[]),this.groupnum2sheet[i].push(parseInt(e));for(let s in t[e])this.visited[s]||this.countUtil(s,t,i)}c2b_NewSplitChain(e,t){let i=this.icn3d;i.icn3dui,this.init3ddomain();let s=[],n=[],r=[],a=[],o=[],l=[],d=[],c=i.firstAtomObjCls.getResiduesFromAtoms(e),h=Object.keys(c),p=h[0].substr(0,h[0].lastIndexOf("_"));i.posid2resid||(i.posid2resid={});let u={},m={};for(let e=0;e<h.length;++e){let t=h[e],l=t.substr(t.lastIndexOf("_")+1),d=i.firstAtomObjCls.getFirstCalphaAtomObj(i.residues[t]);d&&(s.push(d.coord.x),n.push(d.coord.y),r.push(d.coord.z),a.push(e+1),m[e]=l,d.ssend&&(u.To=e+1,u.x2=d.coord.x,u.y2=d.coord.y,u.z2=d.coord.z,u.Sheet="sheet"==d.ss,o.push(u),u={}),d.ssbegin&&(u.From=e+1,u.x1=d.coord.x,u.y1=d.coord.y,u.z1=d.coord.z))}let f=o.length;if(f<=3)return o=this.standardizeSubstruct(p,o,m),{subdomains:l,substruct:o};if(f>this.MAX_SSE)return o=this.standardizeSubstruct(p,o,m),{subdomains:l,substruct:o};let g=h.length,b=g,C=this.c2b_AlphaContacts(g,s,n,r,t,a),v=[];for(let e=0;e<g;e++)v.push(0);let _=!1;for(let e=0;e<o.length;e++){let t=o[e],i=t.From,s=t.To;this.elt_size[e]=s-i+1;for(let t=i;t<=s;t++)v[t-1]=e+1;t.Sheet&&(_=!0)}let y=[],S=[],w=[],x=[];for(let e=0,t=C.length;e<t;++e){let t=C[e].first,i=v[t.first-1],s=v[t.second-1];i<=0||s<=0||!i||!s||(y.push(i),S.push(s),i!=s&&(w.push(i),x.push(s)))}for(let e=0;e<w.length;e++)y.push(x[e]),S.push(w[e]);for(let e=0;e<f;e++)y.push(e+1),S.push(e+1);let A=this.c2b_ContactTable(y,S),M={};for(let e in A){let t=e.split("_"),i=parseInt(t[0]),s=parseInt(t[1]);A[e]<this.min_contacts&&(A[e]=0),o[i-1].Sheet&&o[s-1].Sheet&&A[e]>=this.min_contacts&&(M[i]||(M[i]={}),M[s]||(M[s]={}),M[i][s]=1,M[s][i]=1)}let T=0,E={};this.groupnum2sheet={},this.visited={};for(let e in M)this.visited[e]=!1;for(let e in M)0==this.visited[e]&&(T++,this.countUtil(e,M,T));for(let e in this.groupnum2sheet){let t=this.groupnum2sheet[e].sort((function(e,t){return e-t}));for(let e=0,i=t.length;e<i;++e)E[t[e]]=t[0]}let R={};for(let e=0;e<f;e++)if(o[e].Sheet){let t={};E[e+1]?(t.sheet_num=E[e+1],t.adj_strand2=1,t.sse=e+1):(t.sheet_num=0,t.adj_strand2=0,t.sse=e+1,R[t.sse]=1),d.push(t)}for(let e=0;e<f;e++)for(let t=0;t<f;t++){let i=(e+1).toString()+"_"+(t+1).toString();if(A[i]){let s=A[i];e==t&&s--,this.ctc_cnt[e][t]=s,this.ctc_cnt[t][e]=s}else this.ctc_cnt[e][t]=0}if(_){let e=0;for(let t=0;t<d.length;t++){let i=d[t];i.sheet_num>0&&this.elt_size[i.sse-1]>=6&&0!=i.adj_strand2&&e++}for(let e=0;e<f;e++)this.group_num[e]=e+1;if(e>0)for(let e=0;e<d.length;e++){let t=d[e];0!=t.sheet_num&&(this.group_num[t.sse-1]=t.sheet_num)}}else for(let e=0;e<f;e++)this.group_num[e]=e+1;this.parts=[],this.parts.length=2*this.MAX_SSE;let k=[];k.length=this.MAX_SSE;let O=0;for(let e=0;e<f;e++)this.parts[2*e]=this.parts[2*e+1]=0,k[e]=0;O=this.new_split_chain(f,.25,25,3,4,0,3,0,this.parts,O,k);let I=[];if(O>0){let e=0;for(let t=0;t<=O;t++){let t=[];for(;e<2*f;){let i=this.parts[e++];if(0==i){I.push(t);break}t.push(i)}}}I.sort((function(e,t){return e[0]-t[0]}));let P=[];for(let e=0,t=I.length;e<t;++e){let t=[];for(let i=0,s=I[e].length;i<s;++i){let s=I[e][i];R.hasOwnProperty(s)||t.push(s)}t.length>=this.min_sse&&P.push(I[e])}if(I=P,0==I.length){let e={},t={},i=0;for(let s=0,n=this.group_num.length;s<n;++s){let n=this.group_num[s],r=s+1;n&&n!=s+1&&(t[n]||(t[n]=[]),t[n].push(r),e[n]?(++e[n],e[n]>=3&&(i=n)):e[n]=1)}if(0!=i){let e=[i].concat(t[i]);I.push(e)}}for(let e=0,t=I.length;e<t;++e){let t=I[e],i={};if(t.length<=2)continue;for(let e=0;e<g;e++)i[e+1]=0;for(let e=0;e<t.length;e++){let s=t[e]-1;if(s<0||s>=o.length)return o=this.standardizeSubstruct(p,o,m),{subdomains:l,substruct:o};let n=o[s],r=n.From,a=n.To;for(let e=r;e<=a;e++)i[e]=1;if(0==s&&r>1)for(let e=1;e<r;e++)r-e<=10&&(i[e]=1);if(s==o.length-1&&a<parseInt(b))for(let e=a+1;e<=parseInt(b);e++)e-a<=10&&(i[e]=1);if(s>0){let e=o[s-1].To,t=parseInt(.5*(r-e-1));if(t>0)for(let e=r-t;e<=r-1;e++)i[e]=1}if(s<o.length-1){let e=o[s+1].From,t=parseInt(.5*(e-a-1)+.5);if(t>0)for(let e=a+1;e<=a+t;e++)i[e]=1}}let s,n=!1,r=[];for(let e=0;e<g;e++){let t=i[e+1];if(n||1!=t){if(n&&0==t){let t=this.getNcbiresiRangeFromPos(p,s,e,m);r=r.concat(t),n=!1}}else s=e+1,n=!0}if(n){let e=this.getNcbiresiRangeFromPos(p,s,b,m);r=r.concat(e)}l.push(r)}i.tddomains||(i.tddomains={});for(let e=0,t=l.length;e<t;++e){let t="domain3d-"+Object.keys(i.tddomains).length;i.tddomains[t]={};for(let s=0,n=l[e].length;s<n;s+=2)for(let n=l[e][s];n<=l[e][s+1];++n){let e=p+"_"+n;i.tddomains[t][e]=1}}return o=this.standardizeSubstruct(p,o,m),{subdomains:l,substruct:o}}standardizeSubstruct(e,t,i){let s=this.icn3d;s.icn3dui;for(let n=0;n<t.length;n++){let r=t[n],a=r.From,o=r.To,l=i[a-1],d=i[o-1],c=s.annoDomainCls.getNcbiresiFromResid(e+"_"+l),h=s.annoDomainCls.getNcbiresiFromResid(e+"_"+d);t[n].From=c.substr(c.lastIndexOf("_")+1),t[n].To=h.substr(h.lastIndexOf("_")+1),t[n].From=parseInt(t[n].From),t[n].To=parseInt(t[n].To)}return t}getNcbiresiRangeFromPos(e,t,i,s){let n=this.icn3d;n.icn3dui;let r=[];for(let a=t;a<=i;++a){let t=s[a-1],i=n.resid2ncbi[e+"_"+t]?n.resid2ncbi[e+"_"+t]:e+"_"+t,o=i.substr(i.lastIndexOf("_")+1);r.push(parseInt(o))}return n.resid2specCls.resi2range(r)}getDomainJsonForAlign(e){let t=this.icn3d,i=t.icn3dui,s='{"data": [',n=t.firstAtomObjCls.getResiduesFromAtoms(e),r=Object.keys(n);if(0==r.length)return s+"]}";let a=r[0].substr(0,r[0].lastIndexOf("_")),o=[],l={},d={},c=999,h=-999;for(let e=0;e<r.length;++e){let i=r[e],s=t.firstAtomObjCls.getFirstCalphaAtomObj(t.residues[i]),n=i.substr(i.lastIndexOf("_")+1);d[e]=n;let a=t.resid2ncbi[i]?t.resid2ncbi[i]:i,p=parseInt(a.substr(a.lastIndexOf("_")+1));p<c&&(c=p),p>h&&(h=p),s.ssend&&(l.To=e+1,l.x2=s.coord.x,l.y2=s.coord.y,l.z2=s.coord.z,l.Sheet="sheet"==s.ss,o.push(l),l={}),s.ssbegin&&(l.From=e+1,l.x1=s.coord.x,l.y1=s.coord.y,l.z1=s.coord.z)}o=this.standardizeSubstruct(a,o,d),s+='{"ss": [';let p=0;for(let e=0,i=o.length;e<i;++e){let i=o[e].Sheet?2:1,n=o[e].From,r=o[e].To,l=t.ncbi2resid[a+"_"+n],d=t.firstAtomObjCls.getFirstCalphaAtomObj(t.residues[l]);if(!d||!t.hAtoms.hasOwnProperty(d.serial))continue;let c=t.ncbi2resid[a+"_"+r],h=t.firstAtomObjCls.getFirstCalphaAtomObj(t.residues[c]);h&&t.hAtoms.hasOwnProperty(h.serial)&&(p>0&&(s+=", "),s+="["+i+","+n+","+r+","+o[e].x1.toFixed(2)+","+o[e].y1.toFixed(2)+",",s+=o[e].z1.toFixed(2)+","+o[e].x2.toFixed(2)+","+o[e].y2.toFixed(2)+","+o[e].z2.toFixed(2)+"]",++p)}s+="]",s+=', "domain": [';let u=0;for(let e=c;e<=h;++e){let r=a+"_"+e,o=t.ncbi2resid[r];o.split("_")[2];let l=e;if(u>0&&(s+=", "),n.hasOwnProperty(o)){let e=t.firstAtomObjCls.getFirstCalphaAtomObj(t.residues[o]);s+="["+l+","+(i.parasCls.resn2restype[e.resn]?i.parasCls.resn2restype[e.resn]:0)+","+e.coord.x.toFixed(2)+","+e.coord.y.toFixed(2)+","+e.coord.z.toFixed(2)+"]"}else s+="["+l+",0,0,0,0]";++u}return s+="]}",s+="]}",s}}class hh{constructor(e){this.icn3d=e}clickAddTrackButton(){let e=this.icn3d,t=e.icn3dui,i=this;t.myEventCls.onIds("#"+e.pre+"addtrack_button1","click",(async function(e){let s=i.icn3d;e.stopImmediatePropagation(),dialog.dialog("close");let n=$("#"+s.pre+"track_chainid").val(),r=$("#"+s.pre+"track_gi").val(),a=isNaN(r)?"Acc "+r:"gi "+r,o=t.htmlCls.baseUrl+"pwaln/pwaln.fcgi?from=track",l={targets:n,queries:r},d=await t.getAjaxPostPromise(o,l);i.alignSequenceToStructure(n,d,a)})),t.myEventCls.onIds("#"+e.pre+"addtrack_button2","click",(async function(e){let s=i.icn3d;e.stopImmediatePropagation(),dialog.dialog("close");let n=$("#"+s.pre+"track_chainid").val(),r=$("#"+s.pre+"track_fasta").val(),a=$("#"+s.pre+"fasta_title").val(),o=n.substr(0,n.indexOf("_")),l=n;if(5==o.length)l=l.substr(0,4);else if(o.length>5){l="";for(let e=0,t=s.chainsSeq[n].length;e<t;++e)l+=s.chainsSeq[n][e].name}let d=t.htmlCls.baseUrl+"pwaln/pwaln.fcgi?from=track",c={targets:l,queries:r},h=await t.getAjaxPostPromise(d,c);i.alignSequenceToStructure(n,h,a)})),t.myEventCls.onIds("#"+e.pre+"addtrack_button2b","click",(async function(e){let t=i.icn3d;e.stopImmediatePropagation(),dialog.dialog("close");let s=$("#"+t.pre+"track_chainid").val(),n=$("#"+t.pre+"fasta_startpos").val();n||(n=1);let r="identity"==$("#"+t.pre+"colorseqby").val()?"identity":"custom",a=$("#"+t.pre+"track_fastaalign").val();a&&await i.addMsaTracks(s,n,r,a)})),t.myEventCls.onIds("#"+e.pre+"exons_table","click",(async function(e){let t=i.icn3d;e.stopImmediatePropagation();let s=$("#"+t.pre+"track_geneid").val().trim();window.open("https://www.ncbi.nlm.nih.gov/gene/"+s+"?report=gene_table","_blank")})),t.myEventCls.onIds("#"+e.pre+"addtrack_button2c","click",(async function(e){i.icn3d,e.stopImmediatePropagation(),dialog.dialog("close"),await i.addExonTracksWrap()})),t.myEventCls.onIds("#"+e.pre+"addtrack_button3","click",(function(e){let s=i.icn3d;e.stopImmediatePropagation(),dialog.dialog("close");let n=$("#"+s.pre+"track_chainid").val(),r=$("#"+s.pre+"track_bed")[0].files[0];if(r){window.File&&window.FileReader&&window.FileList&&window.Blob||alert("The File APIs are not fully supported in this browser.");let e=new FileReader;e.onload=function(e){let r,a=e.target.result.split("\n"),o=!1,l=!1;for(let e=0,d=a.length;e<d;++e)if("browser"!=a[e].substr(0,7))if("track"==a[e].substr(0,5)){if(-1!=a[e].toLowerCase().indexOf("itemrgb")&&(o=!0),-1!=a[e].toLowerCase().indexOf("colorbystrand=")){l=!0;let t=a[e].toLowerCase().indexOf("colorbystrand="),i=a[e].substr(t),s=i.indexOf('"');if(-1!=s){let e=i.substr(s+1),t=e.indexOf('"');if(-1!=s){r=e.substr(0,t).split(" ")}}}}else{if(""==a[e])continue;let d=a[e].replace(/\s+/g," ").split(" ");(d.length>8||d.length<6)&&(l=!1),d.length<9&&(o=!1),d[0];let c,h,p=d[1],u=d[2],m=d[3];d.length>4&&d[4],d.length>5&&(c=d[5]),d.length>6&&d[6],d.length>7&&d[7],d.length>8&&(h=d[8]),d.length>9&&d[9],d.length>10&&d[10],d.length>11&&d[11];let f=m,g="51,51,51";o?g=h:l&&("+"==c&&r.length>0?g=r[0]:"-"==c&&r.length>1?g=r[1]:"."==c&&r.length>2&&(g=r[2]));let b="",C=[];for(let e=0,t=u;e<t;++e)e<p?(b+="-",C.push("")):(b+=s.giSeq[n][e],C.push("rgb("+g+")"));i.showNewTrack(n,f,b,C,void 0,void 0,g),t.htmlCls.clickMenuCls.setLogCmd("add track | chainid "+n+" | title "+f+" | text "+i.simplifyText(b)+" | type bed | color "+g,!0)}},e.readAsText(r)}else alert("Please select a file...")})),t.myEventCls.onIds("#"+e.pre+"addtrack_button4","click",(function(e){let s=i.icn3d;e.stopImmediatePropagation(),dialog.dialog("close");let n=$("#"+s.pre+"track_chainid").val(),r=$("#"+s.pre+"track_title").val(),a=$("#"+s.pre+"track_text").val(),o=i.getFullText(a);i.showNewTrack(n,r,o.text,void 0,void 0,"custom",void 0,void 0,o.fromArray,o.toArray),t.htmlCls.clickMenuCls.setLogCmd("add track | chainid "+n+" | title "+r+" | text "+i.simplifyText(a)+" | type custom",!0)})),t.myEventCls.onIds("#"+e.pre+"addtrack_button5","click",(function(e){let s=i.icn3d;e.stopImmediatePropagation(),dialog.dialog("close");let n=$("#"+s.pre+"track_chainid").val(),r=$("#"+s.pre+"track_selection").val(),a="",o=t.hashUtilsCls.intHash(s.hAtoms,s.chains[n]),l=s.firstAtomObjCls.getResiduesFromCalphaAtoms(o),d=[];for(let e=0,t=s.giSeq[n].length;e<t;++e){let t=s.giSeq[n][e],i=t;t.length>1&&(i=t[0]);let r=s.ParserUtilsCls.getResi(n,e);if(l.hasOwnProperty(n+"_"+r)){let e=s.firstAtomObjCls.getFirstCalphaAtomObj(s.residues[n+"_"+r]),t=void 0===e.color||"FFFFFF"===e.color.getHexString().toUpperCase()?"DDDDDD":e.color.getHexString(),o=void 0!==e.color?t:"CCCCCC";a+=i,d.push("#"+o)}else a+="-",d.push("")}i.showNewTrack(n,r,a,d,void 0,"selection",void 0),t.htmlCls.clickMenuCls.setLogCmd("add track | chainid "+n+" | title "+r+" | text "+i.simplifyText(a)+" | type selection",!0)}))}showNewTrack(e,t,i,s,n,r,a,o,l,d,c,h,p){let u=this.icn3d,m=u.icn3dui,f=!1;"cannot be aligned"==i&&(f=!0);let g=i.replace(/-/g,"").length;if(!o)if(i.length>u.giSeq[e].length)i=i.substr(0,u.giSeq[e].length);else if(i.length<u.giSeq[e].length&&!f){let t="";for(let s=0,n=u.giSeq[e].length-i.length;s<n;++s)t+="-";i+=t}let b=t.replace(/\s/g,"_").replace(/\./g,"dot").replace(/\W/g,"");b.length>20&&(b=b.substr(0,20));let C=m.htmlCls.RESIDUE_WIDTH*i.length+200;$("#"+u.pre+"dt_custom_"+e).append("<div id='"+u.pre+"dt_custom_"+e+"_"+b+"'></div>"),$("#"+u.pre+"dt_custom_"+e+"_"+b).width(C),$("#"+u.pre+"ov_custom_"+e).append("<div id='"+u.pre+"ov_custom_"+e+"_"+b+"'></div>"),$("#"+u.pre+"ov_custom_"+e+"_"+b).width(C),$("#"+u.pre+"tt_custom_"+e).append("<div id='"+u.pre+"tt_custom_"+e+"_"+b+"'></div>"),$("#"+u.pre+"tt_custom_"+e+"_"+b).width(C);let v='<div class="icn3d-dl_sequence">',_=v,y=v,S=v,w=v,x=parseInt(10*Math.random()),A='<div class="icn3d-seqTitle icn3d-link icn3d-blue" custom="'+(x+1).toString()+'" from="'+l+'" to="'+d+'" shorttitle="'+b+'" index="'+x+'" setname="'+e+"_custom_"+(x+1).toString()+'" anno="sequence" chain="'+e+'" title="'+t+'">'+b+" </div>",M='<div class="icn3d-seqTitle" chain="'+e+'" title="Exons of '+t+'">Exons </div>',T='<span class="icn3d-residueNum" title="residue count">'+g.toString()+" Pos</span>";S+=A+T+"<br>",w+=M+T+"<br>";let E='<span class="icn3d-seqLine">';v+=A+T+E,_+=M+T+E,y+=A+T+E;let R=e.indexOf("_"),k="cst"+e.substr(R+1),O=0,I=0,P=(void 0===r||"seq"===r||"custom"===r)&&-1==i.indexOf("cannot-be-aligned")&&-1==i.indexOf("cannot be aligned"),D="identity"===r&&-1==i.indexOf("cannot-be-aligned")&&-1==i.indexOf("cannot be aligned"),L={},F=0;A="";let N={},U={},H={},B=0;if(h)for(let e=0,t=h.length;e<t;++e){let t=h[e].resStart,i=h[e].resEnd,s=parseInt(h[e].genomeRange.split("-")[0]);for(let n=0,r=i-t+1;n<r;++n){let r=this.getExonColor(t,i,B);N[B]=r,U[B]=s+u.exonOrder*n*3+"-"+(s+u.exonOrder*n*3+2*u.exonOrder),H[B]=e,++B}}B=0;for(let t=0,l=i.length;t<l;++t){let l=t-F-(u.seqStartLen&&u.seqStartLen[e]?u.seqStartLen[e]:0);o?u.targetGapHash.hasOwnProperty(l)&&!L.hasOwnProperty(l)&&(F+=u.targetGapHash[l].to-u.targetGapHash[l].from+1,L[l]=1):v+=u.showSeqCls.insertGap(e,t,"-");let d=i.charAt(t);if(" "!=d&&"-"!=d){let i,o=u.chainsSeq[e][l]?u.chainsSeq[e][l].name:" ",c=u.showAnnoCls.getColorhexFromBlosum62(d,o),p=d==o?"FF0000":"0000FF",f=u.baseResi[e]+(t+1)-(u.seqStartLen&&u.seqStartLen[e]?u.seqStartLen[e]:0);if(void 0!==n&&(f=u.baseResi[e]+n[t]+1),void 0!==s&&""!=s[t])i='style="color:'+s[t]+'"';else if(a)i='style="color:rgb('+a+')"';else if(P||"seq"==r){if(i='style="color:#'+c+'"',"seq"==r)for(let t in u.residues[e+"_"+f]){let e=m.parasCls.thr("#"+c);u.atoms[t].color=e,u.atomPrevColors[t]=e}}else i=D?'style="color:#'+p+'"':"";if(v+='<span id="'+k+"_"+u.pre+e+"_"+f+'" title="'+d+f+'" class="icn3d-residue" '+i+">"+d+"</span>",h){let t='style="background-color:'+N[B]+'"';_+='<span id="'+k+"_"+u.pre+e+"_"+f+'" title="'+d+f+", Exon "+(H[B]+1)+": "+U[B]+'" class="icn3d-residue" '+t+">&nbsp;</span>";for(let t in u.residues[e+"_"+f]){let e=u.atoms[t];e.color=m.parasCls.thr(N[B]),u.atomPrevColors[t]=e.color}}A+=u.showSeqCls.insertGapOverview(e,t);let g=Math.round(u.seqAnnWidth*t/(u.maxAnnoLength+u.nTotalGap)-O-I);g<0&&(g=0),A+='<div style="display:inline-block; width:'+g+'px;">&nbsp;</div>',i=void 0!==s&&""!=s[t]?s[t]:a?"rgb("+a+")":P?"#"+c:"#333",A+='<div style="display:inline-block; background-color:'+i+'; width:1px;" title="'+d+(t+1).toString()+'">&nbsp;</div>',O+=g,I+=1,++B}else f?v+="<span>"+d+"</span>":(v+="<span>-</span>",_+="<span></span>")}if(void 0!==l){A="";let i=[],s=[],n=[];for(let e=0,t=l.length;e<t;++e){i.push(l[e]),n.push(p[e]);for(let t=parseInt(l[e]);t<=parseInt(d[e]);++t)void 0!==u.targetGapHash&&u.targetGapHash.hasOwnProperty(t)&&(s.push(t-1),i.push(t),n.push(p[e]));s.push(d[e])}u.nTotalGap=0;for(let e in u.targetGapHash)u.nTotalGap+=u.targetGapHash[e].to-u.targetGapHash[e].from+1;let r,a=u.firstAtomObjCls.getFirstCalphaAtomObj(u.chains[e]),o=void 0===a.color||"FFFFFF"===a.color.getHexString()?"DDDDDD":a.color.getHexString(),m=void 0!==a.color?o:"CCCCCC",f=0;for(let a=0,o=i.length;a<o;++a){A+=u.showSeqCls.insertGapOverview(e,i[a]);let o=c?i[a]:i[a]-u.baseResi[e]-1,p=0==a?Math.round(u.seqAnnWidth*o/(u.maxAnnoLength+u.nTotalGap)):Math.round(u.seqAnnWidth*(i[a]-s[a-1]-1)/(u.maxAnnoLength+u.nTotalGap));if(p<0&&(p=0),A+='<div style="display:inline-block; width:'+p+'px;">&nbsp;</div>',h){let t,i,s=n[a];r=d[a]-l[a]+1;let o,c,p,u=f,m=f+r-1;f+=r;for(let e=0,s=h.length;e<s;++e){let s=h[e].resStart,n=h[e].resEnd;u>=s&&u<=n&&(t={exonIndex:e,rangeStart:s,rangeEnd:n,from:u,genomeRange:h[e].genomeRange}),m>=s&&m<=n&&(i={exonIndex:e,rangeStart:s,rangeEnd:n,to:m,genomeRange:h[e].genomeRange})}if(t&&i&&t.exonIndex==i.exonIndex)o=this.getExonColor(t.rangeStart,t.rangeEnd,u),c=this.getExonColor(t.rangeStart,t.rangeEnd,m),p=o+" 0%, #FFF 50%, "+c+" 100%",A+=this.getExonHtml(t.exonIndex,p,t.from,i.to,t.genomeRange,e,b,s);else if(t&&(o=this.getExonColor(t.rangeStart,t.rangeEnd,u),p=o+" 0%, #FFF 50%, #00F 100%",A+=this.getExonHtml(t.exonIndex,p,t.from,t.rangeEnd,t.genomeRange,e,b,s)),t&&i){for(let n=t.exonIndex+1;n<i.exonIndex;++n)p="#F00 0%, #FFF 50%, #00F 100%",A+=this.getExonHtml(n,p,h[n].resStart,h[n].resEnd,h[n].genomeRange,e,b,s);c=this.getExonColor(i.rangeStart,i.rangeEnd,m),p="#F00 0%, #FFF 50%, "+c+" 100%",A+=this.getExonHtml(i.exonIndex,p,i.rangeStart,i.to,i.genomeRange,e,b,s)}}else A+='<div style="display:inline-block; color:white!important; font-weight:bold; background-color:#'+m+"; width:"+Math.round(u.seqAnnWidth*(s[a]-i[a]+1)/(u.maxAnnoLength+u.nTotalGap))+'px;" class="icn3d-seqTitle icn3d-link icn3d-blue" custom="'+(x+1).toString()+'" from="'+i+'" to="'+s+'" shorttitle="'+b+'" index="'+x+'" setname="'+e+"_custom_"+(x+1).toString()+'" id="'+e+"_custom_"+x+'" anno="sequence" chain="'+e+'" title="'+t+'">'+t+"</div>"}}E='<span class="icn3d-residueNum" title="residue count">'+g.toString()+" Pos</span>",E+="</span>",E+="<br>",E+="</div>",v+=E,y+=A+E,_+=E,S+="</div>",w+="</div>",h?($("#"+u.pre+"dt_custom_"+e+"_"+b).html(_+v),$("#"+u.pre+"ov_custom_"+e+"_"+b).html(y),$("#"+u.pre+"tt_custom_"+e+"_"+b).html(w+S)):($("#"+u.pre+"dt_custom_"+e+"_"+b).html(v),$("#"+u.pre+"ov_custom_"+e+"_"+b).html(y),$("#"+u.pre+"tt_custom_"+e+"_"+b).html(S))}getExonHtml(e,t,i,s,n,r,a,o){let l=this.icn3d;return l.icn3dui,'<div style="display:inline-block; color:white!important; width:'+Math.round(l.seqAnnWidth*(s-i+1)/(l.maxAnnoLength+l.nTotalGap))+'px;" class="icn3d-seqTitle icn3d-link icn3d-blue" domain="'+(e+1)+'" from="'+(i+o)+'" to="'+(s+o)+'" setname="'+a+", "+(e+1)+'" title="Exon: '+n+' genomic interval" anno="sequence" chain="'+r+'"><div style="height: 12px; border: 1px solid #000; background: linear-gradient(to right, '+t+');"></div></div>'}getExonColor(e,t,i){this.icn3d.icn3dui;let s=.5*(e+t);if(i<s){let t=parseInt((i-e)/(s-e)*255);return"rgb(255, "+t+", "+t+")"}{let e=parseInt((t-i)/(t-s)*255);return"rgb("+e+", "+e+", 255)"}}alignSequenceToStructure(e,t,i){let s,n,r,a=this.icn3d,o=a.icn3dui;void 0!==t.data&&(s=t.data[0].query,r=Object.keys(t.data[0].targets)[0],n=t.data[0].targets[r],n=n.hsps[0]);let l="",d=[],c={};if(void 0!==s&&void 0!==n){let h=n.scores.e_value.toPrecision(2);h>1e-200&&(h=parseFloat(h).toExponential()),n.scores.bit_score;let p=t.targets[r].seqdata,u=s.seqdata,m=n.segs;for(let e=0,t=m.length;e<t;++e){let t=m[e];for(let e=0;e<=t.orito-t.orifrom;++e)c[e+t.orifrom]=e+t.from}for(let t=0,i=p.length;t<i;++t)if(c.hasOwnProperty(t)){l+=u[c[t]];let i=a.showAnnoCls.getColorhexFromBlosum62(p[t],u[c[t]]);d.push("#"+i);let s=a.ParserUtilsCls.getResi(e,t);for(let t in a.residues[e+"_"+s]){let e=o.parasCls.thr("#"+i);a.atoms[t].color=e,a.atomPrevColors[t]=e}}else l+="-",d.push("");i+=", E: "+h}else l+="cannot be aligned";this.showNewTrack(e,i,l,d,c,"seq"),a.hlUpdateCls.updateHlAll(),a.drawCls.draw(),o.htmlCls.clickMenuCls.setLogCmd("add track | chainid "+e+" | title "+i+" | text "+this.simplifyText(l)+" | type seq",!0)}defineSecondary(e,t){let i=this.icn3d,s=i.icn3dui;$("#"+i.pre+"dl_definedsets").hasClass("ui-dialog-content")&&$("#"+i.pre+"dl_definedsets").dialog("isOpen")||(s.htmlCls.dialogCls.openDlg("dl_definedsets","Select sets"),$("#"+i.pre+"atomsCustom").resizable());let n,r,a={},o=!1,l=!0,d=0,c=0,h=e+"_C(Nterm";i.hAtoms={};for(let s=0,p=i.chainsSeq[e].length;s<p;++s){let p=e+"_"+i.chainsSeq[e][s].resi;if(i.residues.hasOwnProperty(p)){let s=i.firstAtomObjCls.getFirstCalphaAtomObj(i.residues[p]),u=i.secondaries[p];"H"==u?(s.ssbegin&&(++d,Object.keys(a).length>0&&(r=n+"H"+d.toString().padStart(2,"0")+")","coil"==t&&(i.selectionCls.selectResidueList(a,r,r,o,l),o||(o=!0)),a={})),n=e+"_H"+d.toString().padStart(2,"0"),a[p]=1,s.ssend&&(h=e+"_C(H"+d.toString().padStart(2,"0"),"helix"==t&&(i.selectionCls.selectResidueList(a,n,n,o,l),o||(o=!0)),a={})):"E"==u?(s.ssbegin&&(++c,Object.keys(a).length>0&&(r=n+"S"+c.toString().padStart(2,"0")+")","coil"==t&&(i.selectionCls.selectResidueList(a,r,r,o,l),o||(o=!0)),a={})),n=e+"_S"+c.toString().padStart(2,"0"),a[p]=1,s.ssend&&(h=e+"_C(S"+c.toString().padStart(2,"0"),"sheet"==t&&(i.selectionCls.selectResidueList(a,n,n,o,l),o||(o=!0)),a={})):(n=h+"-",a[p]=1)}}Object.keys(a).length>0&&(r=n+"Cterm)","coil"==t&&i.selectionCls.selectResidueList(a,r,r,o,l))}defineIgstrand(e,t){let i=this.icn3d,s=i.icn3dui;$("#"+i.pre+"dl_definedsets").hasClass("ui-dialog-content")&&$("#"+i.pre+"dl_definedsets").dialog("isOpen")||(s.htmlCls.dialogCls.openDlg("dl_definedsets","Select sets"),$("#"+i.pre+"atomsCustom").resizable());let n={},r=!1,a=!0;if(i.hAtoms={},"igdomain"==t){let t=i.chain2igArray[e];if(t&&t.length>0)for(let s=0,o=t.length;s<o;++s){let o=t[s].startPos,l=t[s].endPos,d=t[s].domainid;n={};for(let t=parseInt(o);t<=parseInt(l);++t){n[e+"_"+i.chainsSeq[e][t].resi]=1}let c=d;i.selectionCls.selectResidueList(n,c,c,r,a)}}else{let s,o,l,d,c,h=0,p=0,u="NT",m=!1;for(let f=0,g=i.chainsSeq[e].length;f<g;++f){let g,b,C,v=e+"_"+i.chainsSeq[e][f].resi;i.residues.hasOwnProperty(v)&&(g=i.resid2refnum[v],g&&(b=i.refnumCls.rmStrandFromRefnumlabel(g),o=g.replace(b,""),C=parseInt(b),"iganchor"==t?C>1e3&&"50"==b.substr(b.length-2,2)&&(n[v]=1):(d=i.residIgLoop.hasOwnProperty(v)?"igloop":"igstrand",m&&d!=c&&Object.keys(n).length>0&&("igstrand"==c?(++h,s="Strand-"+l+"-"+e+"-"+h.toString().padStart(3,"0"),s=s.replace(/'/g,"`"),"igstrand"==t&&(i.selectionCls.selectResidueList(n,s,s,r,a),r||(r=!0)),u=l):"igloop"==c&&(++p,s="Loop-"+u+"_"+o+"-"+e+"-"+p.toString().padStart(3,"0"),s=s.replace(/'/g,"`"),"igloop"==t&&(i.selectionCls.selectResidueList(n,s,s,r,a),r||(r=!0))),n={}),n[v]=1,l=o,c=d,m=!0)))}"iganchor"==t?(s="Anchor-"+e,i.selectionCls.selectResidueList(n,s,s,r,a)):"igstrand"==c?(++h,s="Strand-"+l+"-"+e+"-"+h.toString().padStart(3,"0"),s=s.replace(/'/g,"`"),"igstrand"==t&&i.selectionCls.selectResidueList(n,s,s,r,a)):"igloop"==c&&(++p,o="CT",s="Loop-"+u+"_"+o+"-"+e+"-"+p.toString().padStart(3,"0"),s=s.replace(/'/g,"`"),"igloop"==t&&i.selectionCls.selectResidueList(n,s,s,r,a))}}simplifyText(e){this.icn3d.icn3dui;let t,i,s="",n=!1,r=-1;for(t=0,i=(e=e.replace(/undefined/g," ")).length;t<i;++t)"-"==e[t]||" "==e[t]?(n&&t!==r&&(s+=r+1==t-1?(r+1+1).toString()+" "+e.substr(r+1,t-1-r)+", ":(r+1+1).toString()+"-"+(t-1+1).toString()+" "+e.substr(r+1,t-1-r)+", ",n=!1),r=t):n=!0;return n&&t==i&&(s+=r+1==t-1?(r+1+1).toString()+" "+e.substr(r+1,t-1-r)+", ":(r+1+1).toString()+"-"+(t-1+1).toString()+" "+e.substr(r+1,t-1-r)+", "),s}checkGiSeq(e,t,i,s,n,r,a){let o=this.icn3d;o.icn3dui;let l=this;if(a>20)return!1;if(void 0!==o.giSeq&&void 0!==o.giSeq[e]){let a=this.getFullText(i);return i=a.text,this.showNewTrack(e,t,i,void 0,void 0,s,n,r),!1}setTimeout((function(){l.checkGiSeq(e,t,i,s,n,r,a+1)}),100)}getFullText(e){this.icn3d.icn3dui;let t="",i=[],s=[],n=e.split(","),r=-1;for(let e=0,a=n.length;e<a;++e){let a=n[e].trim();if(0==a.length)continue;let o=a.split(" ");if(2!==o.length)continue;let l,d,c=o[1],h=o[0].split("-");if(2==h.length)l=h[0]-1,d=h[1]-1;else{if(1!=h.length)continue;l=h[0]-1,d=l}i.push(l),s.push(d);for(let e=0;e<l-r-1;++e)t+="-";let p=d-l+1;c.length>p?t+=c.substr(0,p):t+=c;for(let e=0;e<p-c.length;++e)t+="-";r=d}return{text:t,fromArray:i,toArray:s}}setCustomFile(e,t,i,s){var n=this.icn3d,r=n.icn3dui;let a=this,o=$("#"+n.pre+"customcolor_chainid").val(),l=$("#"+n.pre+"cstcolorfile")[0].files[0];if(l){r.utilsCls.checkFileAPI();let n=new FileReader;n.onload=function(n){let l=a.icn3d,d=n.target.result.split("\n");void 0===l.queryresi2score&&(l.queryresi2score={}),l.queryresi2score[o]={};for(let e=0,t=d.length;e<t;++e)if(""!==d[e].trim()){let t=d[e].split(/\s+/);l.queryresi2score[o][t[0]]=t[1]}let c=Object.keys(l.queryresi2score[o]),h=Math.min.apply(null,c),p=Math.max.apply(null,c),u="";for(let e=h;e<=p;++e)l.queryresi2score[o].hasOwnProperty(e)?u+=Math.round(l.queryresi2score[o][e]/11):u+="_";if("color"==e){l.opts.color="align custom",l.setColorCls.setColorByOptions(l.opts,l.hAtoms),l.hlUpdateCls.updateHlAll(),r.htmlCls.clickMenuCls.setLogCmd("color align custom | "+o+" | range "+h+"_"+p+" | "+u+" | colorrange "+t+" "+i+" "+s,!0);let e=r.htmlCls.clickMenuCls.setLegendHtml();$("#"+r.pre+"dl_legend_html").html(e),r.htmlCls.dialogCls.openDlg("dl_legend","Color range")}else"tube"==e&&(l.setOptionCls.setStyle("proteins","custom tube"),r.htmlCls.clickMenuCls.setLogCmd("color tube | "+o+" | range "+h+"_"+p+" | "+u,!0));l.drawCls.draw()},n.readAsText(l)}else alert("Please select a file before clicking 'Load'")}async getMsa(e,t,i){let s=this.icn3d,n=s.icn3dui,r=[t],a=[],o=n.htmlCls.baseUrl+"/vastdyn/vastdyn.cgi?chainlist="+e,l=await n.getAjaxPromise(o,"jsonp"),d=0,c=0,h=0;for(let e in l){let t=l[e],i=e.indexOf(".");-1!=i&&(e=e.substr(0,i)),r.push(e),t.length>d&&(d=t.length,c=h),++h}o=n.htmlCls.baseUrl+"pwaln/pwaln.fcgi?from=msa";let p=e.split(","),u={};u[t]=0;for(let e=0,t=p.length;e<t;++e)u[p[e]]=e+1;let m=p[c];p.splice(c,1);let f=i||t;p.length>0&&(f+=","+p.join(","));let g={targets:m,queries:f},b=await n.getAjaxPostPromise(o,g);if(!b.data)return void console.log("The protein accessions "+m+","+f+" can not be aligned...");let C=[];s.qt_start_end={};let v=[],_=[],y=Object.keys(b.targets)[0],S=b.targets[y].seqdata;p.splice(0,0,t);for(let e=0,i=p.length;e<i;++e){let i,n,r;if(!b.data[e])continue;i=b.data[e].query,r=i.acc.length<=5?i.acc.substr(0,4)+"_"+i.acc.substr(4,1):i.acc,0==e&&(r=t),v.push(r),y=Object.keys(b.data[e].targets)[0],n=b.data[e].targets[y],n=n.hsps[0],_.push(i.seqdata);let a=100*n.scores.num_ident+i.sz;s.qt_start_end[e]=[];let o=n.segs;for(let t=0,i=o.length;t<i;++t){let i=o[t],n={t_start:i.orifrom,t_end:i.orito,q_start:i.from,q_end:i.to};s.qt_start_end[e].push(n)}C.push({index:e,alignLen:a})}p=v,C.sort((function(e,t){return t.alignLen-e.alignLen}));let w=9999,x=-1;for(let e=0,t=p.length;e<t;++e)if(s.qt_start_end[e])for(let t=0,i=s.qt_start_end[e].length;t<i;++t){let i,n;i=s.qt_start_end[e][t].t_start,n=s.qt_start_end[e][t].t_end;for(let e=i;e<=n;++e)e<w&&(w=e),e>x&&(x=e)}let A=w,M=S.length-(x+1),T=[],E=[];for(let e=0,t=p.length;e<t;++e){if(!s.qt_start_end[e])continue;let t=s.qt_start_end[e][0].q_start;T.push(t),A<t&&(A=t);let i=s.qt_start_end[e].length-1;t=s.qt_start_end[e][i].q_end,E.push(t);let n=_[e].length-(t+1);M<n&&(M=n)}s.msaSeq={},s.msaSeq[m]="";for(let e=w;e<=x;++e)s.msaSeq[m]+=S[e];let R=[0];for(let e=0,t=C.length;e<t;++e){let t=C[e].index;R.push(t),s.msaSeq[p[t]]="",_[t]&&s.setSeqAlignCls.mergeTwoSeqForAllSimple(m,p,t,R,w,x,_)}let k,O="";for(let e=0;e<A-w;++e)O+="-";for(let e=0;e<w;++e)O+=S[e];s.msaSeq[m]=O+s.msaSeq[m];for(let e=0,t=p.length;e<t;++e){O="";for(let t=0;t<A-T[e];++t)O+="-";for(let t=0;t<T[e];++t)O+=_[e][t];s.msaSeq[p[e]]=O+s.msaSeq[p[e]]}for(let e=x+1;e<S.length;++e)s.msaSeq[m]+=S[e];k=S.length-(x+1);for(let e=0;e<M-k;++e)s.msaSeq[m]+="-";for(let e=0,t=p.length;e<t;++e){for(let t=E[e]+1;t<_[e].length;++t)s.msaSeq[p[e]]+=_[e][t];k=_[e].length-(E[e]+1);for(let t=0;t<M-k;++t)s.msaSeq[p[e]]+="-"}for(let e in s.msaSeq){let t=u[e];a[t]=s.msaSeq[e],r[t]=e}let I=[],P=[];for(let e=0,t=a.length;e<t;++e)a[e]&&(P.push(a[e]),I.push(r[e]));let D=P[0];return P.splice(0,1),I.splice(0,1),{trackTitleArray:I,trackSeqArray:P,seqFirst:D}}async getIsoformMsa(e,t){let i=this.icn3d,s=i.icn3dui,n=[],r=[],a=s.htmlCls.baseUrl+"/vastdyn/vastdyn.cgi?chainlist="+e,o=await s.getAjaxPromise(a,"jsonp"),l=0,d=0,c=0,h=[],p=[];for(let e in o){let t=o[e];p.push(t);let i=e.indexOf(".");-1!=i&&(e=e.substr(0,i)),h.push(e),t.length>l&&(l=t.length,d=c),++c}i.qt_start_end={};let u="genomeRes",m={};for(let e=0,s=h.length;e<s;++e){let s=h[e];m[s]=e,i.qt_start_end[e]=[];let n=t[s];for(let t=0,s=n.length;t<s;++t){let s=n[t],r={t_start:i.exonOrder*s.genResStart,t_end:i.exonOrder*s.genResEnd,q_start:s.resStart,q_end:s.resEnd};i.qt_start_end[e].push(r)}}let f=999999999,g=-999999999;for(let e=0,t=h.length;e<t;++e)if(i.qt_start_end[e])for(let t=0,s=i.qt_start_end[e].length;t<s;++t){let s,n;s=i.qt_start_end[e][t].t_start,n=i.qt_start_end[e][t].t_end;for(let e=s;e<=n;++e)e<f&&(f=e),e>g&&(g=e)}for(let e=0,t=h.length;e<t;++e){let t=i.qt_start_end[e];for(let e=0,i=t.length;e<i;++e){let i=t[e];i.t_start-=f,i.t_end-=f}}i.msaSeq={},i.msaSeq[u]="";let b=g-f;for(let e=0;e<=b;++e)i.msaSeq[u]+="X";let C=[0];for(let e=0,t=h.length;e<t;++e)C.push(e),i.msaSeq[h[e]]="",p[e]&&i.setSeqAlignCls.mergeTwoSeqForAllSimple(u,h,e,C,0,b,p);for(let e in i.msaSeq){let t=m[e];void 0!==t&&(r[t]=i.msaSeq[e],n[t]=e)}let v=[];for(let e=0,t=r.length;e<t;++e)v[e]="";if(r[d])for(let e=0,t=r[d].length;e<t;++e){let t="-"!=r[d][e];if(!t)for(let i=0,s=r.length;i<s;++i)if("-"!=r[i][e]){t=!0;break}if(t)for(let t=0,i=r.length;t<i;++t)v[t]+=r[t][e]}return{trackTitleArray:n,trackSeqArray:v,maxIndex:d}}async showMsaTracks(e,t,i,s,n,r,a){let o=this.icn3d;o.icn3dui;for(let t=0,i=o.chainsSeq[e].length;t<i;++t){o.ParserUtilsCls.getResi(e,t)==n&&(o.startposGiSeq=t)}if(void 0===o.startposGiSeq)return void alert('Please double check the start position before clicking "Add Track"');o.targetGapHash={};let l,d,c="-",h=0,p=0,u=0,m=!1,f=0,g=0,b=t.length;o.seqStartLen||(o.seqStartLen={}),o.seqEndLen||(o.seqEndLen={});for(let i=0,s=t.length;i<s;++i)"-"==t[i]&&t[i]!=c&&(l=p,u=0),"-"==c&&t[i]!=c&&p>0&&(d=h,o.targetGapHash[l+o.startposGiSeq]={from:l+o.startposGiSeq,to:d+u-1+o.startposGiSeq}),c=t[i],h=p,"-"!=t[i]?(++p,g=i,o.seqEndLen[e]=b-1-g,m||(f=i,o.seqStartLen[e]=f,m=!0)):++u;o.maxAnnoLength<o.maxAnnoLengthOri+o.seqStartLen[e]+o.seqEndLen[e]&&(o.maxAnnoLength=o.maxAnnoLengthOri+o.seqStartLen[e]+o.seqEndLen[e]),await o.showAnnoCls.processSeqData(o.chainid_seq);let C="",v=0;for(let e in o.targetGapHash)v>0&&(C+=" "),C+=e+"_"+o.targetGapHash[e].from+"_"+o.targetGapHash[e].to,++v;let _={};for(let l=0,d=s.length;l<d;++l){let d=n,c="";for(let e=0;e<o.startposGiSeq;++e){if(o.targetGapHash.hasOwnProperty(e))for(let t=0;t<o.targetGapHash[e].to-o.targetGapHash[e].from+1;++t)c+="-";c+="-"}let h,p="-",u=[],m=[],f=!1,g=0,C=0,v=[];for(let i=0;i<b;++i)0==l&&(_[d]=0),h=s[l][i],"-"!=h&&(f||(g=i,f=!0,C=o.startposGiSeq-o.seqStartLen[e]+g)),"-"==p&&"-"!=h&&(u.push(i),v.push(C)),"-"!=p&&"-"==h&&m.push(i-1),i>=o.seqStartLen[e]&&("-"==t[i]&&C--,"-"==h&&C++),c+=h,"-"!=t[i]&&(t[i]==s[l][i]&&++_[d],++d),p=h;"-"!=p&&m.push(b-1);let y=i[l].length<20?i[l]:i[l].substr(0,20)+"...",S=!0,w=a?a[i[l]]:void 0;this.showNewTrack(e,y,c,void 0,void 0,r,void 0,S,u,m,g,w,v)}o.opts.color="exon",o.legendTableCls.showColorLegend(o.opts.color),o.hlUpdateCls.updateHlAll(),o.drawCls.draw()}processAccList(e){this.icn3d.icn3dui;let t=e.split(","),i={},s="";for(let e=0,n=t.length;e<n;++e){let n=t[e];if(i.hasOwnProperty(n))continue;i[n]=1;let r=n.indexOf(".");s+=-1!=r?n.substr(0,r):n,e<t.length-1&&(s+=",")}return s}async addExonTracksWrap(){let e=this.icn3d;e.icn3dui;let t=$("#"+e.pre+"track_chainid").val(),i=$("#"+e.pre+"track_geneid").val();if(!i)return void alert("Please fill in the Gene ID...");let s=$("#"+e.pre+"fasta_startpos2").val();s||(s=1);await this.addExonTracks(t,i,s,"identity")}async addExonTracks(e,t,i,s){let n,r=this.icn3d,a=r.icn3dui,o=[],l=[],d=a.htmlCls.baseUrl+"/vastdyn/vastdyn.cgi?geneid2isoforms="+t,c=await a.getAjaxPromise(d,"jsonp"),h=c.acclist,p=c.exons,u={},m="";r.exonOrder=1;for(let e=0,t=h.length;e<t;++e){let i=h[e],s=i.indexOf("."),n=-1!=s?i.substr(0,s):i,a=0,o=0,l=[];for(let e=0,t=p[i].length;e<t;++e){let s=p[i][e].split("-");s[0]=parseInt(s[0]),s[1]=parseInt(s[1]),s[2]=parseInt(s[2]),r.exonOrder=s[0]<s[1]?1:-1;let n=s[0]+"-"+s[1];a+=e==t-1?s[2]-3:s[2];let d=parseInt((o+2)/3),c=parseInt((a+2)/3)-1,h=parseInt((s[1]+2)/3),u=h-r.exonOrder*(c-d);l.push({genomeRange:n,genResStart:u,genResEnd:h,resStart:d,resEnd:c}),o=a}u[n]=l,m+=n,e<t-1&&(m+=",")}let f=await this.getIsoformMsa(m,u);o=f.trackTitleArray,l=f.trackSeqArray;let g,b=f.maxIndex,C=o[b],v=e.substr(0,e.indexOf("_"));if(v.length>5?(r.uniprot2acc&&r.uniprot2acc[v]&&(v=r.uniprot2acc[v]),g=v):g=e,v.length>5){let e="";for(let t=0,i=r.chainsSeq.length;t<i;++t)e+=r.chainsSeq[t].resn;f=await this.getMsa(C,g,e)}else f=await this.getMsa(C,g);f.trackTitleArray;let _=f.trackSeqArray;n=f.seqFirst;let y=l[b],S=_[0],w=0,x=0,A=l.length;for(;y&&S&&w<y.length&&x<S.length;){if(y[w]!=S[x])if("-"==y[w])S=S.substr(0,x)+"-"+S.substr(x),n=n.substr(0,x)+"-"+n.substr(x);else for(let e=0;e<A;++e)l[e]=l[e].substr(0,w)+"-"+l[e].substr(w);++w,++x}await this.showMsaTracks(e,n,o,l,i,s,u),a.htmlCls.clickMenuCls.setLogCmd("add exon track | chainid "+e+" | geneid "+t+" | startpos "+i+" | type "+s,!0),a.htmlCls.clickMenuCls.setLogCmd("set annotation custom",!0)}async addMsaTracks(e,t,i,s){let n,r=this.icn3d.icn3dui,a=[],o=[],l=s.split(">"),d=l[1].indexOf("\n");n=l[1].substr(d+1).replace(/\n/g,"");for(let e=2,t=l.length;e<t;++e){let t=l[e].indexOf("\n"),i=l[e].substr(0,t);-1!=i.indexOf("|")&&(i=i.split("|")[1]),a.push(i);let s=l[e].substr(t+1).replace(/\n/g,"");o.push(s)}await this.showMsaTracks(e,n,a,o,t,i),r.htmlCls.clickMenuCls.setLogCmd("add msa track | chainid "+e+" | startpos "+t+" | type "+i+" | fastaList "+s,!0)}}class ph{constructor(e){this.icn3d=e}hideAllAnno(){let e=this.icn3d;e.icn3dui,this.setAnnoSeqBase(!1),$("[id^="+e.pre+"custom]").hide()}setAnnoSeqBase(e){let t=this.icn3d;t.icn3dui;let i=["cdd","clinvar","snp","site","ptm","ssbond","crosslink","transmem","domain","interaction","ig"];for(let s in i){let n=i[s];e?$("[id^="+t.pre+n+"]").show():$("[id^="+t.pre+n+"]").hide()}}setAnnoTabBase(e){let t=this.icn3d;t.icn3dui;let i=["all","cdd","clinvar","snp","binding","ptm","ssbond","crosslink","transmem","3dd","custom","interact","ig"];for(let s in i){let n=i[s];$("#"+t.pre+"anno_"+n).length&&($("#"+t.pre+"anno_"+n)[0].checked=e)}}async setAnnoTabAll(){let e=this.icn3d;e.icn3dui,this.setAnnoTabBase(!0),this.setAnnoSeqBase(!0),await this.updateClinvar(),await this.updateSnp(),this.updateDomain(),await this.updatePTM(),this.updateSsbond(),this.updateCrosslink(),await this.updateTransmem(),e.bRunRefnumAgain=!0,await this.updateIg(),e.bRunRefnumAgain=!1,this.updateInteraction()}hideAnnoTabAll(){this.icn3d.icn3dui,this.setAnnoTabBase(!1),this.hideAllAnno()}async resetAnnoAll(){let e=this.icn3d;e.icn3dui,$("[id^="+e.pre+"dt_]").html(""),$("[id^="+e.pre+"tt_]").html(""),$("[id^="+e.pre+"ov_]").html(""),await e.showAnnoCls.processSeqData(e.chainid_seq),this.setAnnoViewAndDisplay("detailed view"),await this.resetAnnoTabAll()}async resetAnnoTabAll(){let e=this.icn3d;e.icn3dui,$("#"+e.pre+"anno_binding").length&&$("#"+e.pre+"anno_binding")[0].checked&&$("[id^="+e.pre+"site]").show(),$("#"+e.pre+"anno_snp").length&&$("#"+e.pre+"anno_snp")[0].checked&&(e.bSnpShown=!1,await this.updateSnp(),$("[id^="+e.pre+"snp]").show()),$("#"+e.pre+"anno_clinvar").length&&$("#"+e.pre+"anno_clinvar")[0].checked&&(e.bClinvarShown=!1,await this.updateClinvar(),$("[id^="+e.pre+"clinvar]").show()),$("#"+e.pre+"anno_cdd").length&&$("#"+e.pre+"anno_cdd")[0].checked&&$("[id^="+e.pre+"cdd]").show(),$("#"+e.pre+"anno_3dd").length&&$("#"+e.pre+"anno_3dd")[0].checked&&($("[id^="+e.pre+"domain]").show(),e.bDomainShown=!1,this.updateDomain()),$("#"+e.pre+"anno_interact").length&&$("#"+e.pre+"anno_interact")[0].checked&&($("[id^="+e.pre+"interaction]").show(),e.bInteractionShown=!1,this.updateInteraction()),$("#"+e.pre+"anno_ptm").length&&$("#"+e.pre+"anno_ptm")[0].checked&&(e.bPTMShown=!1,await this.updatePTM(),$("[id^="+e.pre+"ptm]").show()),$("#"+e.pre+"anno_custom").length&&$("#"+e.pre+"anno_custom")[0].checked&&$("[id^="+e.pre+"custom]").show(),$("#"+e.pre+"anno_ssbond").length&&$("#"+e.pre+"anno_ssbond")[0].checked&&($("[id^="+e.pre+"ssbond]").show(),e.bSSbondShown=!1,this.updateSsbond()),$("#"+e.pre+"anno_crosslink").length&&$("#"+e.pre+"anno_crosslink")[0].checked&&($("[id^="+e.pre+"crosslink]").show(),e.bCrosslinkShown=!1,this.updateCrosslink()),$("#"+e.pre+"anno_transmem").length&&$("#"+e.pre+"anno_transmem")[0].checked&&(e.bTranememShown=!1,await this.updateTransmem(),$("[id^="+e.pre+"transmem]").show()),($("#"+e.pre+"anno_ig").length&&$("#"+e.pre+"anno_ig")[0].checked||e.bShowRefnum)&&(e.bRunRefnumAgain=!1,await this.updateIg(),$("[id^="+e.pre+"ig]").show())}setAnnoTabCustom(){let e=this.icn3d;e.icn3dui,$("[id^="+e.pre+"custom]").show(),$("#"+e.pre+"anno_custom").length&&($("#"+e.pre+"anno_custom")[0].checked=!0)}hideAnnoTabCustom(){let e=this.icn3d;e.icn3dui,$("[id^="+e.pre+"custom]").hide(),$("#"+e.pre+"anno_custom").length&&($("#"+e.pre+"anno_custom")[0].checked=!1)}async setAnnoTabClinvar(){let e=this.icn3d;e.icn3dui,await this.updateClinvar(),$("[id^="+e.pre+"clinvar]").show(),$("#"+e.pre+"anno_clinvar").length&&($("#"+e.pre+"anno_clinvar")[0].checked=!0)}hideAnnoTabClinvar(){let e=this.icn3d;e.icn3dui,$("[id^="+e.pre+"clinvar]").hide(),$("#"+e.pre+"anno_clinvar").length&&($("#"+e.pre+"anno_clinvar")[0].checked=!1)}async setAnnoTabSnp(){let e=this.icn3d;e.icn3dui,await this.updateSnp(),$("[id^="+e.pre+"snp]").show(),$("#"+e.pre+"anno_snp").length&&($("#"+e.pre+"anno_snp")[0].checked=!0)}hideAnnoTabSnp(){let e=this.icn3d;e.icn3dui,$("[id^="+e.pre+"snp]").hide(),$("#"+e.pre+"anno_snp").length&&($("#"+e.pre+"anno_snp")[0].checked=!1)}setAnnoTabCdd(){let e=this.icn3d;e.icn3dui,$("[id^="+e.pre+"cdd]").show(),$("#"+e.pre+"anno_cdd").length&&($("#"+e.pre+"anno_cdd")[0].checked=!0)}hideAnnoTabCdd(){let e=this.icn3d;e.icn3dui,$("[id^="+e.pre+"cdd]").hide(),$("#"+e.pre+"anno_cdd").length&&($("#"+e.pre+"anno_cdd")[0].checked=!1)}setAnnoTab3ddomain(){let e=this.icn3d;e.icn3dui,this.updateDomain(),$("[id^="+e.pre+"domain]").show(),$("#"+e.pre+"anno_3dd").length&&($("#"+e.pre+"anno_3dd")[0].checked=!0)}hideAnnoTab3ddomain(){let e=this.icn3d;e.icn3dui,$("[id^="+e.pre+"domain]").hide(),$("#"+e.pre+"anno_3dd").length&&($("#"+e.pre+"anno_3dd")[0].checked=!1)}setAnnoTabSite(){let e=this.icn3d;e.icn3dui,$("[id^="+e.pre+"site]").show(),$("[id^="+e.pre+"feat]").show(),$("#"+e.pre+"anno_binding").length&&($("#"+e.pre+"anno_binding")[0].checked=!0)}hideAnnoTabSite(){let e=this.icn3d;e.icn3dui,$("[id^="+e.pre+"site]").hide(),$("[id^="+e.pre+"feat]").hide(),$("#"+e.pre+"anno_binding").length&&($("#"+e.pre+"anno_binding")[0].checked=!1)}setAnnoTabInteraction(){let e=this.icn3d;e.icn3dui,$("[id^="+e.pre+"interaction]").show(),$("#"+e.pre+"anno_interact").length&&($("#"+e.pre+"anno_interact")[0].checked=!0),this.updateInteraction()}hideAnnoTabInteraction(){let e=this.icn3d;e.icn3dui,$("[id^="+e.pre+"interaction]").hide(),$("#"+e.pre+"anno_interact").length&&($("#"+e.pre+"anno_interact")[0].checked=!1)}async setAnnoTabPTM(){let e=this.icn3d;e.icn3dui,await this.updatePTM(),$("[id^="+e.pre+"ptm]").show(),$("#"+e.pre+"anno_ptm").length&&($("#"+e.pre+"anno_ptm")[0].checked=!0)}hideAnnoTabPTM(){let e=this.icn3d;e.icn3dui,$("[id^="+e.pre+"ptm]").hide(),$("#"+e.pre+"anno_ptm").length&&($("#"+e.pre+"anno_ptm")[0].checked=!1)}setAnnoTabSsbond(){let e=this.icn3d;e.icn3dui,$("[id^="+e.pre+"ssbond]").show(),$("#"+e.pre+"anno_ssbond").length&&($("#"+e.pre+"anno_ssbond")[0].checked=!0),this.updateSsbond()}hideAnnoTabSsbond(){let e=this.icn3d;e.icn3dui,$("[id^="+e.pre+"ssbond]").hide(),$("#"+e.pre+"anno_ssbond").length&&($("#"+e.pre+"anno_ssbond")[0].checked=!1)}setAnnoTabCrosslink(){let e=this.icn3d;e.icn3dui,$("[id^="+e.pre+"crosslink]").show(),$("#"+e.pre+"anno_crosslink").length&&($("#"+e.pre+"anno_crosslink")[0].checked=!0),this.updateCrosslink()}hideAnnoTabCrosslink(){let e=this.icn3d;e.icn3dui,$("[id^="+e.pre+"crosslink]").hide(),$("#"+e.pre+"anno_crosslink").length&&($("#"+e.pre+"anno_crosslink")[0].checked=!1)}async setAnnoTabTransmem(){let e=this.icn3d;e.icn3dui,await this.updateTransmem(),$("[id^="+e.pre+"transmem]").show(),$("#"+e.pre+"anno_transmem").length&&($("#"+e.pre+"anno_transmem")[0].checked=!0)}hideAnnoTabTransmem(){let e=this.icn3d;e.icn3dui,$("[id^="+e.pre+"transmem]").hide(),$("#"+e.pre+"anno_transmem").length&&($("#"+e.pre+"anno_transmem")[0].checked=!1)}async setAnnoTabIg(e,t){let i=this.icn3d;i.icn3dui,await this.updateIg(e,t),$("[id^="+i.pre+"ig]").show(),$("#"+i.pre+"anno_ig").length&&($("#"+i.pre+"anno_ig")[0].checked=!0)}hideAnnoTabIg(){let e=this.icn3d;e.icn3dui,$("[id^="+e.pre+"ig]").hide(),$("#"+e.pre+"anno_ig").length&&($("#"+e.pre+"anno_ig")[0].checked=!1)}setTabs(){let e=this.icn3d,t=e.icn3dui,i=this;$("#"+e.pre+"dl_addtrack_tabs").tabs(),$("#"+e.pre+"dl_anno_view_tabs").tabs(),t.myEventCls.onIds("#"+e.pre+"anno_all","click",(async function(s){$("#"+e.pre+"anno_all")[0].checked?(await i.setAnnoTabAll(),t.htmlCls.clickMenuCls.setLogCmd("set annotation all",!0)):(i.hideAnnoTabAll(),t.htmlCls.clickMenuCls.setLogCmd("hide annotation all",!0))})),t.myEventCls.onIds("#"+e.pre+"anno_binding","click",(function(s){$("#"+e.pre+"anno_binding")[0].checked?(i.setAnnoTabSite(),t.htmlCls.clickMenuCls.setLogCmd("set annotation site",!0)):(i.hideAnnoTabSite(),t.htmlCls.clickMenuCls.setLogCmd("hide annotation site",!0))})),t.myEventCls.onIds("#"+e.pre+"anno_snp","click",(async function(s){$("#"+e.pre+"anno_snp")[0].checked?(await i.setAnnoTabSnp(),t.htmlCls.clickMenuCls.setLogCmd("set annotation snp",!0)):(i.hideAnnoTabSnp(),t.htmlCls.clickMenuCls.setLogCmd("hide annotation snp",!0))})),t.myEventCls.onIds("#"+e.pre+"anno_clinvar","click",(async function(s){$("#"+e.pre+"anno_clinvar")[0].checked?(await i.setAnnoTabClinvar(),t.htmlCls.clickMenuCls.setLogCmd("set annotation clinvar",!0)):(i.hideAnnoTabClinvar(),t.htmlCls.clickMenuCls.setLogCmd("hide annotation clinvar",!0))})),t.myEventCls.onIds("#"+e.pre+"anno_cdd","click",(function(e){i.clickCdd()})),t.myEventCls.onIds("#"+e.pre+"anno_3dd","click",(function(s){$("#"+e.pre+"anno_3dd")[0].checked?(i.setAnnoTab3ddomain(),t.htmlCls.clickMenuCls.setLogCmd("set annotation 3ddomain",!0)):(i.hideAnnoTab3ddomain(),t.htmlCls.clickMenuCls.setLogCmd("hide annotation 3ddomain",!0))})),t.myEventCls.onIds("#"+e.pre+"anno_interact","click",(function(s){$("#"+e.pre+"anno_interact")[0].checked?(i.setAnnoTabInteraction(),t.htmlCls.clickMenuCls.setLogCmd("set annotation interaction",!0)):(i.hideAnnoTabInteraction(),t.htmlCls.clickMenuCls.setLogCmd("hide annotation interaction",!0))})),t.myEventCls.onIds("#"+e.pre+"anno_ptm","click",(async function(s){$("#"+e.pre+"anno_ptm")[0].checked?(await i.setAnnoTabPTM(),t.htmlCls.clickMenuCls.setLogCmd("set annotation ptm",!0)):(i.hideAnnoTabPTM(),t.htmlCls.clickMenuCls.setLogCmd("hide annotation ptm",!0))})),t.myEventCls.onIds("#"+e.pre+"anno_custom","click",(function(s){$("#"+e.pre+"anno_custom")[0].checked?(i.setAnnoTabCustom(),t.htmlCls.clickMenuCls.setLogCmd("set annotation custom",!0)):(i.hideAnnoTabCustom(),t.htmlCls.clickMenuCls.setLogCmd("hide annotation custom",!0))})),t.myEventCls.onIds("#"+e.pre+"anno_ssbond","click",(function(s){$("#"+e.pre+"anno_ssbond")[0].checked?(i.setAnnoTabSsbond(),t.htmlCls.clickMenuCls.setLogCmd("set annotation ssbond",!0)):(i.hideAnnoTabSsbond(),t.htmlCls.clickMenuCls.setLogCmd("hide annotation ssbond",!0))})),t.myEventCls.onIds("#"+e.pre+"anno_crosslink","click",(function(s){$("#"+e.pre+"anno_crosslink")[0].checked?(i.setAnnoTabCrosslink(),t.htmlCls.clickMenuCls.setLogCmd("set annotation crosslink",!0)):(i.hideAnnoTabCrosslink(),t.htmlCls.clickMenuCls.setLogCmd("hide annotation crosslink",!0))})),t.myEventCls.onIds("#"+e.pre+"anno_transmem","click",(async function(s){$("#"+e.pre+"anno_transmem").length&&$("#"+e.pre+"anno_transmem")[0].checked?(await i.setAnnoTabTransmem(),t.htmlCls.clickMenuCls.setLogCmd("set annotation transmembrane",!0)):(i.hideAnnoTabTransmem(),t.htmlCls.clickMenuCls.setLogCmd("hide annotation transmembrane",!0))})),t.myEventCls.onIds("#"+e.pre+"anno_ig","click",(async function(s){$("#"+e.pre+"anno_ig").length&&$("#"+e.pre+"anno_ig")[0].checked?(e.bRunRefnumAgain=!0,await i.setAnnoTabIg(),t.htmlCls.clickMenuCls.setLogCmd("set annotation ig",!0),e.bRunRefnumAgain=!1):(i.hideAnnoTabIg(),t.htmlCls.clickMenuCls.setLogCmd("hide annotation ig",!0))}))}clickCdd(){let e=this.icn3d,t=e.icn3dui;$("[id^="+e.pre+"cdd]").length>0&&($("#"+e.pre+"anno_cdd")[0].checked?(this.setAnnoTabCdd(),t.htmlCls.clickMenuCls.setLogCmd("set annotation cdd",!0)):(this.hideAnnoTabCdd(),t.htmlCls.clickMenuCls.setLogCmd("hide annotation cdd",!0)))}showAnnoSelectedChains(){let e=this.icn3d,t=e.icn3dui,i={};for(let t in e.hAtoms){let s=e.atoms[t];i[s.structure+"_"+s.chain]=1}$("#"+e.pre+"dl_annotations > .icn3d-annotation").hide();for(let s in i){$("#"+e.pre+"anno_"+s).length&&$("#"+e.pre+"anno_"+s).show();let i=e.firstAtomObjCls.getFirstCalphaAtomObj(e.chains[s]);if(i&&void 0!==i.resn){let s=t.utilsCls.residueName2Abbr(i.resn.substr(0,3));$("#"+e.pre+"anno_"+s).show()}}}showAnnoAllChains(){let e=this.icn3d;e.icn3dui,$("#"+e.pre+"dl_annotations > .icn3d-annotation").show()}setAnnoView(e){let t=this.icn3d;t.icn3dui.bNode||("detailed view"===e?(t.view="detailed view",$("#"+t.pre+"dl_anno_view_tabs").tabs("option","active",1)):(t.view="overview",$("#"+t.pre+"dl_anno_view_tabs").tabs("option","active",0)))}setAnnoDisplay(e,t){let i=this.icn3d;i.icn3dui;let s=["giseq","custom","site","ptm","snp","clinvar","cdd","domain","interaction","ssbond","crosslink","transmem","ig"];for(let n in s){let r=s[n];$("[id^="+i.pre+t+"_"+r+"]").attr("style",e)}}showFixedTitle(){this.icn3d.icn3dui;this.setAnnoDisplay("display:block;","tt")}hideFixedTitle(){this.icn3d.icn3dui;this.setAnnoDisplay("display:none!important;","tt")}setAnnoViewAndDisplay(e){let t=this.icn3d;if(t.icn3dui,"detailed view"===e){this.setAnnoView("detailed view");let e="display:block;";this.setAnnoDisplay(e,"dt"),$("#"+t.pre+"seqguide_wrapper").attr("style",e),e="display:none;",this.setAnnoDisplay(e,"ov")}else{this.setAnnoView("overview"),this.hideFixedTitle();let e="display:none;";this.setAnnoDisplay(e,"dt"),$("#"+t.pre+"seqguide_wrapper").attr("style",e),e="display:block;",this.setAnnoDisplay(e,"ov")}}async updateClinvar(){let e=this.icn3d;if(e.icn3dui,void 0===e.bClinvarShown||!e.bClinvarShown)for(let t in e.protein_chainid){let i=e.protein_chainid[t];await e.annoSnpClinVarCls.showClinvar(t,i)}e.bClinvarShown=!0}async updateSnp(){let e=this.icn3d;if(e.icn3dui,void 0===e.bSnpShown||!e.bSnpShown)for(let t in e.protein_chainid){let i=e.protein_chainid[t];await e.annoSnpClinVarCls.showSnp(t,i)}e.bSnpShown=!0}updateDomain(){let e=this.icn3d;e.icn3dui,void 0!==e.bDomainShown&&e.bDomainShown||e.annoDomainCls.showDomainAll(),e.bDomainShown=!0}updateInteraction(){let e=this.icn3d;if(e.icn3dui,void 0===e.bInteractionShown||!e.bInteractionShown)for(let t in e.interactChainbase){let i=e.interactChainbase[t];e.annoContactCls.showInteraction(t,i)}e.bInteractionShown=!0}async updatePTM(){let e=this.icn3d;if(e.icn3dui,void 0===e.bPTMShown||!e.bPTMShown)for(let t in e.PTMChainbase){let i=e.PTMChainbase[t];await e.annoPTMCls.showPTM(t,i,"ptm")}e.bPTMShown=!0}updateSsbond(){let e=this.icn3d;if(e.icn3dui,void 0===e.bSSbondShown||!e.bSSbondShown)for(let t in e.ssbondChainbase){let i=e.ssbondChainbase[t];e.annoSsbondCls.showSsbond(t,i)}e.bSSbondShown=!0}updateCrosslink(){let e=this.icn3d;if(e.icn3dui,void 0===e.bCrosslinkShown||!e.bCrosslinkShown)for(let t in e.crosslinkChainbase){let i=e.crosslinkChainbase[t];e.annoCrossLinkCls.showCrosslink(t,i)}e.bCrosslinkShown=!0}async updateTransmem(){let e=this.icn3d,t=e.icn3dui;if(void 0===e.bTranememShown||!e.bTranememShown)for(let i in e.protein_chainid){let s=e.protein_chainid[i];if(void 0!==t.cfg.opmid)e.annoTransMemCls.showTransmem(i,s);else if(e.bAfMem&&e.afmem_start_end){let t=e.afmem_start_end[0],n=e.afmem_start_end[1];await e.annoPTMCls.showPTM(i,s,"afmem",t,n)}else await e.annoPTMCls.showPTM(i,s,"transmem")}e.bTranememShown=!0}async updateIg(e,t){let i=this.icn3d,s=i.icn3dui;if(i.opts.color="ig strand",!e){i.hAtoms={};for(let e in i.protein_chainid)i.hAtoms=s.hashUtilsCls.unionHash(i.hAtoms,i.chains[e])}let n=i.firstAtomObjCls.getResiduesFromAtoms(i.hAtoms);for(let e in n)i.resid2refnum&&delete i.resid2refnum[e],i.residIgLoop&&delete i.residIgLoop[e],i.resid2domainid&&delete i.resid2domainid[e];i.bRunRefnumAgain=!0;let r=e?i.firstAtomObjCls.getChainsFromAtoms(i.hAtoms):i.protein_chainid;for(let e in r)await i.annoIgCls.showIg(e,t),i.bRunRefnumAgain=!1;i.bShowRefnum&&(i.hlUpdateCls.updateHlAll(),i.drawCls.draw())}}class uh{constructor(e){this.icn3d=e}showAnnotations_part1(e){let t=this.icn3d,i=t.icn3dui;if(i.htmlCls.dialogCls.openDlg("dl_selectannotations","Sequences and Annotations"),(void 0===t.bAssemblyNote||!t.bAssemblyNote)&&void 0!==t.asuCnt){let e="     <br><div id='"+t.pre+"assembly_note' style='margin-left:5px;'><span class='icn3d-annoLargeTitle'>Assembly Tips:</span> Only the asymmetric unit is shown in the sequence window.<br>Click \"Assembly\" in the menu \"View\" to switch between asymmetric unit and biological assembly(<b>"+t.asuCnt+"</b> asymmetric unit).</div>";$("#"+t.pre+"dl_annotations_tabs").append(e),t.bAssemblyNote=!0}t.bResetAnno&&(t.giSeq={},t.currClin={},t.resi2disease_nonempty={},t.baseResi={},t.matchedPos={},$("#"+i.pre+"dl_annotations").empty(),t.annotationCls.setAnnoView("overview"));let s={},n={},r={};if(void 0===t.bAnnoShown||!t.bAnnoShown||t.bResetAnno){t.protein_chainid={};let a,o=Object.keys(t.chains);if(e){let i=t.resid2specCls.atoms2structureArray(e);o=[];for(let e=0,s=i.length;e<s;++e)o=o.concat(t.structures[i[e]])}void 0===t.giSeq&&(t.giSeq={}),void 0===t.currClin&&(t.currClin={}),void 0===t.resi2disease_nonempty&&(t.resi2disease_nonempty={}),void 0===t.baseResi&&(t.baseResi={}),void 0===t.matchedPos&&(t.matchedPos={}),a=i.bNode?500:i.cfg.notebook?i.htmlCls.WIDTH/2:$("#"+t.pre+"dl_selectannotations").dialog("option","width"),t.seqAnnWidth=a-120-60-50;for(let e=0,a=o.length;e<a;++e){Math.round(o[e].indexOf("_"));let a=t.firstAtomObjCls.getMiddleAtomObj(t.chains[o[e]],100);if(void 0===a&&(a=t.firstAtomObjCls.getFirstAtomObj(t.chains[o[e]])),void 0===a)continue;let l,d=o[e].substr(o[e].indexOf("_")+1);if(-1!==d.indexOf("_")?(d=d.substr(0,d.indexOf("_")),l=o[e].substr(0,o[e].indexOf("_"))+"_"+d):d.length>1&&"1"==d.substr(d.length-1)?(d=d.substr(0,d.length-1),l=o[e].substr(0,o[e].indexOf("_"))+"_"+d):l=o[e],t.proteins.hasOwnProperty(a.serial)&&t.chainsSeq[o[e]].length>1)t.protein_chainid[o[e]]=l;else if(t.nucleotides.hasOwnProperty(a.serial)&&t.chainsSeq[o[e]].length>1)s[o[e]]=l;else if(t.chainsSeq[o[e]].length>1)n[o[e]]=l;else{let i=t.chainsSeq[o[e]][0].name,s=o[e]+"_"+t.chainsSeq[o[e]][0].resi;void 0===r[i]&&(r[i]=[]),r[i].push(s)}if((void 0!==i.cfg.pdbid||void 0!==i.cfg.opmid||void 0!==i.cfg.mmcifid||void 0!==i.cfg.mmtfid)&&(t.proteins.hasOwnProperty(a.serial)||t.nucleotides.hasOwnProperty(a.serial)))for(let i=0,s=t.chainsSeq[o[e]].length;i<s;++i){let s=t.chainsSeq[o[e]][i];if(""!==s.name&&"-"!==s.name&&s.name==s.name.toUpperCase()){let i=o[e]+"_"+s.resi,n=t.firstAtomObjCls.getFirstCalphaAtomObj(t.residues[i]);if(void 0===n&&(n=t.firstAtomObjCls.getFirstAtomObj(t.chains[o[e]])),t.proteins.hasOwnProperty(n.serial)||t.nucleotides.hasOwnProperty(n.serial))continue;{let e=s.name.trim();void 0===r[e]&&(r[e]=[]),r[e].push(i)}}}}t.maxAnnoLengthOri=1;for(let e in t.chainsSeq)t.chainsSeq[e].length>t.maxAnnoLengthOri&&(t.protein_chainid.hasOwnProperty(e)||s.hasOwnProperty(e))&&(t.maxAnnoLengthOri=t.chainsSeq[e].length);t.maxAnnoLength=t.maxAnnoLengthOri}return{nucleotide_chainid:s,chemical_chainid:n,chemical_set:r}}async showAnnotations(e){let t=this.icn3d,i=t.icn3dui,s=this,n=this.showAnnotations_part1(e),r=n.nucleotide_chainid,a=n.chemical_chainid,o=n.chemical_set;if(!t.bAnnoShown||t.bResetAnno)if(t.bAnnoShown=!0,void 0===i.cfg.blast_rep_id){if(t.bFullUi){if(void 0!==i.cfg.mmtfid){let e=Object.keys(t.structures)[0];await t.mmcifParserCls.downloadMmcifSymmetry(e,"mmtfid")}await this.showAnnoSeqData(r,a,o)}}else if(void 0===i.cfg.blast_rep_id||t.bSmithwm||t.bLocalSmithwm){if(void 0!==i.cfg.blast_rep_id&&(t.bSmithwm||t.bLocalSmithwm)){let e,n,l=[i.cfg.blast_rep_id];if(-1!=i.cfg.query_id.indexOf(">")?n=i.cfg.query_id.substr(i.cfg.query_id.indexOf("\n")+1):!/\d/.test(i.cfg.query_id)||i.cfg.query_id.length>50?n=i.cfg.query_id:l.push(i.cfg.query_id),t.blastAcxn){let s=i.cfg.afid+"_A",n="";for(let e=0,i=t.chainsSeq[s].length;e<i;++e)n+=t.chainsSeq[s][e].name;e=n}else{let t=i.htmlCls.baseUrl+"/vastdyn/vastdyn.cgi?chainlist="+l,s=await i.getAjaxPromise(t,"jsonp",!1,"Can not retrieve the sequence of the accession(s) "+l.join(", "));for(let t in s)e=s[t]}let d=1,c=-1,h=-1,p=-1,u=!!t.bLocalSmithwm;t.seqStructAlignDataLocalSmithwm=t.alignSWCls.alignSW(e,n,d,c,h,p,u),await s.showAnnoSeqData(r,a,o)}}else{let e=i.htmlCls.baseUrl+"pwaln/pwaln.fcgi?from=querytarget",n={targets:i.cfg.blast_rep_id,queries:i.cfg.query_id};if(void 0!==i.cfg.query_from_to){let e=i.cfg.query_from_to.split(":");for(let t=0,i=e.length;t<i;++t)e[t]=parseInt(e[t])-1;n.queries=i.cfg.query_id+":"+e.join(":")}if(void 0!==i.cfg.target_from_to){let e=i.cfg.target_from_to.split(":");for(let t=0,i=e.length;t<i;++t)e[t]=parseInt(e[t])-1;n.targets=i.cfg.blast_rep_id+":"+e.join(":")}if(t.blastAcxn){let e=i.cfg.afid+"_A",s="";for(let i=0,n=t.chainsSeq[e].length;i<n;++i)s+=t.chainsSeq[e][i].name;n.targets=s}let l=await i.getAjaxPostPromise(e,n);t.seqStructAlignData=l,await s.showAnnoSeqData(r,a,o)}$("#"+t.pre+"anno_ig").length&&$("#"+t.pre+"anno_ig")[0].checked&&(t.bRunRefnumAgain=!0,await t.annotationCls.setAnnoTabIg(),t.bRunRefnumAgain=!1)}async showAnnoSeqData(e,t,i){let s=this.icn3d,n=s.icn3dui;n.bNode||await this.getAnnotationData();let r=0;for(let t in e)this.getSequenceData(t,e[t],"nucleotide",r),++r;s.interactChainbase=n.hashUtilsCls.unionHash(s.interactChainbase,s.protein_chainid),s.interactChainbase=n.hashUtilsCls.unionHash(s.interactChainbase,e),r=0;for(let e in t)this.getSequenceData(e,t[e],"chemical",r),++r;s.interactChainbase=n.hashUtilsCls.unionHash(s.interactChainbase,t),s.PTMChainbase=n.hashUtilsCls.unionHash(s.PTMChainbase,s.protein_chainid),s.ssbondChainbase=n.hashUtilsCls.unionHash(s.ssbondChainbase,s.protein_chainid),s.ssbondChainbase=n.hashUtilsCls.unionHash(s.ssbondChainbase,t),s.crosslinkChainbase=n.hashUtilsCls.unionHash(s.crosslinkChainbase,s.protein_chainid),s.crosslinkChainbase=n.hashUtilsCls.unionHash(s.crosslinkChainbase,e),s.crosslinkChainbase=n.hashUtilsCls.unionHash(s.crosslinkChainbase,t);for(let e in i)this.getCombinedSequenceData(e,i[e],r),++r;n.bNode||(this.enableHlSeq(),s.annotationCls.hideAllAnno(),s.annotationCls.clickCdd())}async getAnnotationData(){let e=this.icn3d,t=e.icn3dui,i=this,s=$.map(e.protein_chainid,(function(e){return e})),n=0;e.chainsGene||(e.chainsGene={});for(let i in e.protein_chainid){let s=i.substr(0,i.indexOf("_"));if(s.length>5){let n;e.uniprot2acc&&e.uniprot2acc[s]?e.uniprot2acc[s]:e.uniprot2acc={},n="https://rest.uniprot.org/uniprotkb/search?format=json&fields=xref_geneid,gene_names&query="+s;let r=await t.getAjaxPromise(n,"json"),a=r.results[0]&&r.results[0].uniProtKBCrossReferences&&r.results[0].uniProtKBCrossReferences[0]?r.results[0].uniProtKBCrossReferences[0].id:void 0,o=r.results[0]&&r.results[0].genes&&r.results[0].genes[0]&&r.results[0].genes[0].geneName?r.results[0].genes[0].geneName.value:"ID "+a;e.chainsGene[i]={geneId:a,geneSymbol:o}}}for(let i in e.protein_chainid){let s=t.utilsCls.isMobile()?"none":"button",r=e.showSeqCls.getProteinName(i),a=r,o=0==n?"<span class='icn3d-annoLargeTitle'><b>Proteins</b>: </span><br><br>":"",l=e.chainsGene[i]&&e.chainsGene[i].geneId&&e.chainsGene[i].geneDesc?"(Gene: <a href='https://www.ncbi.nlm.nih.gov/gene/"+e.chainsGene[i].geneId+"?report=gene_table' target='_blank' title='"+e.chainsGene[i].geneDesc+"'>"+e.chainsGene[i].geneSymbol+"</a>)":"",d=i.substr(0,i.indexOf("_")),c=d.length>5?'<a href="https://alphafold.ebi.ac.uk/entry/'+d+'" target="_blank">'+i+"</a>":i,h="<div id='"+e.pre+"anno_"+i+"' class='icn3d-annotation'>"+o+"<span style='font-weight:bold;'>Annotations of "+c+"</span>: <a class='icn3d-blue' href='https://www.ncbi.nlm.nih.gov/protein?term="+i+"' target='_blank' title='"+r+"'>"+a+"</a>"+l+"&nbsp;&nbsp;&nbsp;"+this.addButton(i,"icn3d-addtrack","Add Track","Add a custom track",60,s)+"&nbsp;&nbsp;&nbsp;";h+=this.addButton(i,"icn3d-customcolor","Custom Color/Tube","Use a custom file to define the colors or tubes in 3D structure",110,s)+"&nbsp;&nbsp;&nbsp;",h+=this.addButton(i,"icn3d-helixsets","Helix Sets",'Define sets for each helix in this chain and add them to the menu of "Defined Sets"',60,s)+"&nbsp;"+this.addButton(i,"icn3d-sheetsets","Sheet Sets",'Define sets for each sheet in this chain and add them to the menu of "Defined Sets"',60,s)+"&nbsp;"+this.addButton(i,"icn3d-coilsets","Coil Sets",'Define sets for each coil in this chain and add them to the menu of "Defined Sets"',60,s),h+="&nbsp;&nbsp;&nbsp;"+this.addButton(i,"icn3d-iganchorsets","Ig Anchor Set",'Define the set for all Ig anchors in this chain and add them to the menu of "Defined Sets"',80,s)+"&nbsp;"+this.addButton(i,"icn3d-igstrandsets","Ig Strand Sets",'Define sets for each Ig strand in this chain and add them to the menu of "Defined Sets"',80,s)+"&nbsp;"+this.addButton(i,"icn3d-igloopsets","Ig Loop Sets",'Define sets for each Ig loop in this chain and add them to the menu of "Defined Sets"',80,s)+"&nbsp;"+this.addButton(i,"icn3d-igdomainsets","Ig Domain Sets",'Define sets for each Ig domain in this chain and add them to the menu of "Defined Sets"',80,s),$("#"+e.pre+"dl_annotations").append(h);let p=["giseq","cdd","clinvar","snp","site","ptm","ssbond","crosslink","transmem","domain","custom","interaction","ig"];for(let t in p){let s=p[t];$("#"+e.pre+"anno_"+i).append(this.getAnDiv(i,s))}$("#"+e.pre+"anno_"+i).append("<br><hr><br>"),++n}if(t.bNode||e.annoCddSiteCls.setToolTip(),void 0!==e.chainid_seq)await this.processSeqData(e.chainid_seq);else try{let n=[],r=[];for(let e=0,t=s.length;e<t;++e){s[e].substr(0,s.indexOf("_")).length>=6?r.push(s[e]):n.push(s[e])}if(n.length>0){let i=t.htmlCls.baseUrl+"/vastdyn/vastdyn.cgi?chainlist="+n;e.chainid_seq=await t.getAjaxPromise(i,"jsonp")}else e.chainid_seq={};for(let t=0,i=r.length;t<i;++t){let i=r[t],s="";for(let t=0,n=e.chainsSeq[i].length;t<n;++t)s+=e.chainsSeq[i][t].name;e.chainid_seq[i]=s}await i.processSeqData(e.chainid_seq)}catch(n){i.enableHlSeq(),t.bNode||console.log("No sequence data were found for the protein "+s+"...");for(let t in e.protein_chainid){let i=e.protein_chainid[t];e.showSeqCls.setAlternativeSeq(t,i),e.showSeqCls.showSeq(t,i)}return void await e.annoCddSiteCls.showCddSiteAll()}}getSequenceData(e,t,i,s){let n=this.icn3d;n.icn3dui;let r=n.showSeqCls.getProteinName(e),a=r;a.length>40&&(a=a.substr(0,40)+"...");let o="";0==s&&("protein"==i?o="<span class='icn3d-annoLargeTitle'><b>Proteins</b>: </span><br><br>":"nucleotide"==i?o="<span class='icn3d-annoLargeTitle'><b>Nucleotides</b>: </span><br><br>":"chemical"==i&&(o="<span class='icn3d-annoLargeTitle'><b>Chemicals/Ions/Water</b>: </span><br><br>")),$("#"+n.pre+"dl_annotations").append("<div id='"+n.pre+"anno_"+e+"' class='icn3d-annotation'>"+o+"<b>"+e+"</b>: <span title='"+r+"'>"+a+"</span> </div>"),$("#"+n.pre+"anno_"+e).append(this.getAnDiv(e,"giseq")),$("#"+n.pre+"anno_"+e).append(this.getAnDiv(e,"interaction")),$("#"+n.pre+"anno_"+e).append("<br><hr><br>"),n.giSeq[e]=[];for(let t=0;t<n.chainsSeq[e].length;++t){let i=n.chainsSeq[e][t].name;n.giSeq[e][t]=i}n.matchedPos[e]=0,n.baseResi[e]=n.chainsSeq[e][0].resi-n.matchedPos[e]-1,n.showSeqCls.showSeq(e,t,i)}getCombinedSequenceData(e,t,i){let s,n=this.icn3d,r=n.icn3dui,a=0==i?"<span class='icn3d-annoLargeTitle'><b>Chemicals/Ions/Water</b>: </span><br><br>":"",o=t[0].lastIndexOf("_"),l=t[0].substr(0,o),d=void 0!==r.cfg.mmdbid&&void 0!==n.chainid2sid?n.chainid2sid[l]:void 0;s=void 0!==d?"<b>"+e+" <a class='icn3d-blue' href='https://pubchem.ncbi.nlm.nih.gov/substance/"+d+"#section=2D-Structure' target='_blank'><img src='https://pubchem.ncbi.nlm.nih.gov/image/imgsrv.fcgi?sid="+d+"'></a></b>":"<b>"+e+"</b>",$("#"+n.pre+"dl_annotations").append("<div id='"+n.pre+"anno_"+e+"' class='icn3d-annotation'>"+a+s+"</div>"),$("#"+n.pre+"anno_"+e).append("<div id='"+n.pre+"giseq_"+e+"'><div id='"+n.pre+"dt_giseq_"+e+"' style='display:none'></div><div id='"+n.pre+"ov_giseq_"+e+"'></div></div>"),$("#"+n.pre+"anno_"+e).append("<br><hr><br>");let c='<div class="icn3d-dl_sequence">';c+='<div class="icn3d-seqTitle icn3d-link icn3d-blue" anno="sequence" gi="'+e+'" resn="'+e+'"><span style="white-space:nowrap;" title="Chemical '+e+'">Chem. '+e+"</span></div>",c+='<span class="icn3d-residueNum" style="width:60px!important;" title="starting protein sequence number">Count: '+t.length+"</span>",c+='<span class="icn3d-seqLine">';let h=c,p=c;for(let i=0,s=t.length;i<s;++i){let s=e,r=s;s.length>3&&(r=s.substr(0,3)),i<t.length-1&&(r+=",");let a=t[i],o=a.substr(a.lastIndexOf("_")+1);h+='<span id="giseq_'+n.pre+a+'" title="'+s+o+'" class="icn3d-residue icn3d-chemical">'+r+"</span>"}let u=r.htmlCls.GREY8,m=Math.round(n.seqAnnWidth*t.length/n.maxAnnoLength);m<1&&(m=1),p+='<div class="icn3d-seqTitle" style="display:inline-block; color:white; font-weight:bold; background-color:'+u+"; width:"+m+'px;">&nbsp;</div>',c="</span>",c+="<br>",c+="</div>",h+=c,p+=c,$("#"+n.pre+"dt_giseq_"+e).html(h),$("#"+n.pre+"ov_giseq_"+e).html(p)}async processSeqData(e){let t=this.icn3d,i=t.icn3dui;t.bAnnoShown=!0;for(let s in t.protein_chainid){let n=t.protein_chainid[s];if(e.hasOwnProperty(n)){let i=e[n];t.giSeq[s]=i;let r="";for(let e=0;e<10&&e<t.chainsSeq[s].length;++e)r+=t.chainsSeq[s][e].name.substr(0,1);let a=i.toLowerCase().indexOf(r.toLowerCase());-1==a?(console.log("The gi sequence didn't match the protein sequence. The start of 3D protein sequence: "+r+". The gi sequence: "+i.substr(0,10)+"."),t.showSeqCls.setAlternativeSeq(s,n)):(t.matchedPos[s]=a,t.baseResi[s]=t.chainsSeq[s][0].resi-t.matchedPos[s]-1)}else i.bNode||console.log("No sequence data were found for the chain "+s+"..."),t.showSeqCls.setAlternativeSeq(s,n);if(i.cfg.blast_rep_id!=s)t.showSeqCls.showSeq(s,n);else if(i.cfg.blast_rep_id==s&&void 0===t.seqStructAlignData&&void 0===t.seqStructAlignDataSmithwm){let e,r,a,o=i.cfg.oriQuery_id?i.cfg.oriQuery_id:i.cfg.query_id;e=o.length>14?"Query: "+o.substr(0,6)+"...":isNaN(i.cfg.query_id)?"Query: "+o:"Query: gi "+o;let l="cannot be aligned";t.queryStart="",t.queryEnd="",t.bRender&&alert("The sequence can NOT be aligned to the structure"),t.showSeqCls.showSeq(s,n,void 0,e,r,l,a)}else if(i.cfg.blast_rep_id==s&&(void 0!==t.seqStructAlignData||void 0!==t.seqStructAlignDataSmithwm)){let e,r,a,o,l,d=i.cfg.oriQuery_id?i.cfg.oriQuery_id:i.cfg.query_id;if(e=d.length>14?"Query: "+d.substr(0,6)+"...":isNaN(i.cfg.query_id)?"Query: "+d:"Query: gi "+d,void 0!==t.seqStructAlignData){let e,i,s=t.seqStructAlignData;if(void 0!==s.data){e=s.data[0].query;let t=Object.keys(s.data[0].targets);i=s.data[0].targets[t[0]],i=void 0!==i&&i.hsps.length>0?i.hsps[0]:void 0}if(void 0!==e&&void 0!==i){r=i.scores.e_value.toPrecision(2),r>1e-200&&(r=parseFloat(r).toExponential()),i.scores.bit_score;let t=Object.keys(s.targets);a=s.targets[t[0]].seqdata,o=e.seqdata,l=i.segs}}else{let e=t.seqStructAlignDataSmithwm;r=e.score,a=e.target.replace(/-/g,""),o=e.query.replace(/-/g,""),l=[];let i=-1,s=-1,n=!1,d={};for(let t=0,r=e.target.length;t<r;++t)"-"!=e.target[t]&&++i,"-"!=e.query[t]&&++s,n||"-"==e.target[t]||"-"==e.query[t]?!n||"-"!=e.target[t]&&"-"!=e.query[t]||(n=!1,d.orito="-"==e.target[t]?i:i-1,d.to="-"==e.query[t]?s:s-1,l.push(d),d={}):(n=!0,d.orifrom=i,d.from=s);"-"!=e.target[e.target.length-1]&&"-"!=e.query[e.target.length-1]&&(d.orito=i,d.to=s,l.push(d))}let c="",h="";if(t.queryStart="",t.queryEnd="",void 0!==l){let e={};void 0===t.targetGapHash&&(t.targetGapHash={}),t.fullpos2ConsTargetpos={},t.consrvResPosArray=[];let n=0,r=0;t.nTotalGap=0,t.queryStart=l[0].from+1,t.queryEnd=l[l.length-1].to+1;for(let i=0,s=l.length;i<s;++i){let s=l[i];if(i>0)if(s.orifrom-n<s.from-r)t.targetGapHash[s.orifrom]={from:r+1,to:s.from-1},t.nTotalGap+=t.targetGapHash[s.orifrom].to-t.targetGapHash[s.orifrom].from+1;else if(s.orifrom-n>s.from-r)for(let t=n+1;t<s.orifrom;++t)e[t]=-1;for(let t=0;t<=s.orito-s.orifrom;++t)e[t+s.orifrom]=t+s.from;n=s.orito,r=s.to}let d=0;t.alnChainsSeq[s]=[];for(let n=0,r=a.length;n<r;++n){if(t.targetGapHash.hasOwnProperty(n))for(let e=t.targetGapHash[n].from;e<=t.targetGapHash[n].to;++e)c+=o[e];h+=t.showSeqCls.insertGap(s,n,"-",!0),t.targetGapHash.hasOwnProperty(n)&&(d+=t.targetGapHash[n].to-t.targetGapHash[n].from+1);let r=t.bUsePdbNum?t.ParserUtilsCls.getResi(s,n):n+1;if(e.hasOwnProperty(n)&&-1!==e[n]){c+=o[e[n]];let l=this.getColorhexFromBlosum62(a[n],o[e[n]]);a[n]==o[e[n]]?(h+=a[n],t.fullpos2ConsTargetpos[n+d]={same:1,pos:r,res:a[n],color:l},t.consrvResPosArray.push(r),t.alnChainsSeq[s].push({resi:r,color:"#FF0000",color2:"#"+l})):this.conservativeReplacement(a[n],o[e[n]])?(h+="+",t.fullpos2ConsTargetpos[n+d]={same:0,pos:r,res:a[n],color:l},t.consrvResPosArray.push(r),t.alnChainsSeq[s].push({resi:r,color:"#0000FF",color2:"#"+l})):(h+=" ",t.fullpos2ConsTargetpos[n+d]={same:-1,pos:r,res:a[n],color:l},t.alnChainsSeq[s].push({resi:r,color:i.htmlCls.GREYC,color2:"#"+l}))}else c+="-",h+=" "}}else c+="cannot be aligned",t.bRender&&alert("The sequence can NOT be aligned to the structure");let p=void 0!==t.seqStructAlignData?"BLAST, E: "+r:"Score: "+r;t.showSeqCls.showSeq(s,n,void 0,e,p,c,h);let u,m={};if(void 0!==t.consrvResPosArray)for(let e=0,i=t.consrvResPosArray.length;e<i;++e)u=n+"_"+t.consrvResPosArray[e],m[u]=1;let f=i.hashUtilsCls.cloneHash(t.hAtoms);t.selectionCls.selectResidueList(m,"protein_aligned",p,!1),t.hAtoms=i.hashUtilsCls.cloneHash(f)}}i.bNode||(this.enableHlSeq(),await t.annoCddSiteCls.showCddSiteAll())}enableHlSeq(){let e=this.icn3d;e.icn3dui.utilsCls.isMobile()?(e.hlSeqCls.selectSequenceMobile(),e.hlSeqCls.selectChainMobile()):e.hlSeqCls.selectSequenceNonMobile(),Object.keys(e.hAtoms).length<Object.keys(e.dAtoms).length&&e.hlUpdateCls.updateHlSeq()}getAnDiv(e,t){let i=this.icn3d;i.icn3dui;let s="Loading "+t+"...";return"custom"==t?s="":"domain"==t&&(s="Loading 3D "+t+"..."),"<div id='"+i.pre+t+"_"+e+"'><div id='"+i.pre+"tt_"+t+"_"+e+"' class='icn3d-fixed-pos' style='display:none!important'></div><div id='"+i.pre+"dt_"+t+"_"+e+"' style='display:none'>"+s+"</div><div id='"+i.pre+"ov_"+t+"_"+e+"'>"+s+"</div></div>"}addButton(e,t,i,s,n,r){return this.icn3d.icn3dui,"<div class='"+t+"' chainid='"+e+"' style='display:inline-block; font-size:11px; font-weight:bold; width:"+n+"px!important;'><button style='-webkit-appearance:"+r+"; height:18px; width:"+n+"px;'><span style='white-space:nowrap; margin-left:-3px;' title='"+s+"'>"+i+"</span></button></div>"}addSnpButton(e,t,i,s,n,r){let a=this.icn3d;return a.icn3dui,"<div class='"+a.pre+t+"' snp='"+e+"' style='margin:3px 0 3px 0; display:inline-block; font-size:11px; font-weight:bold; width:"+n+"px!important;'><button style='-webkit-appearance:"+r+"; height:18px; width:"+n+"px;'><span style='white-space:nowrap; margin-left:-3px;' title='"+s+"'>"+i+"</span></button></div>"}conservativeReplacement(e,t){let i=this.icn3d.icn3dui,s=-1!==i.parasCls.b62ResArray.indexOf(e)?i.parasCls.b62ResArray.indexOf(e):i.parasCls.b62ResArray.length-1,n=-1!==i.parasCls.b62ResArray.indexOf(t)?i.parasCls.b62ResArray.indexOf(t):i.parasCls.b62ResArray.length-1;return i.parasCls.b62Matrix[s][n]>0}getColorhexFromBlosum62(e,t){let i=this.icn3d.icn3dui,s="333333";if(!e||!t)return s;e=e.toUpperCase(),t=t.toUpperCase();let n=-1!==i.parasCls.b62ResArray.indexOf(e)?i.parasCls.b62ResArray.indexOf(e):i.parasCls.b62ResArray.length-1,r=-1!==i.parasCls.b62ResArray.indexOf(t)?i.parasCls.b62ResArray.indexOf(t):i.parasCls.b62ResArray.length-1,a=i.parasCls.b62Matrix[n][r];if(void 0===a)return"333333";if(a>0){let e=221-parseInt(a/11*221),t=e<10?"0"+e.toString(16):e.toString(16);s="DD"+t+t}else{let e=221-parseInt(-1*a/4*221),t=e<10?"0"+e.toString(16):e.toString(16);s=t+t+"DD"}return s}}class mh{constructor(e){this.icn3d=e}getSeq(e){let t,i=this.icn3d,s=i.icn3dui;if(void 0===s.cfg.mmdbid&&void 0===s.cfg.gi&&void 0===s.cfg.blast_rep_id&&void 0===s.cfg.align&&void 0===s.cfg.chainalign&&void 0===s.cfg.mmdbafid){t=[];for(let s=0;s<i.chainsSeq[e].length;++s)t.push(i.chainsSeq[e][s])}else t=i.giSeq[e];if(!t)return[];let n=[];for(let e=0,i=t.length;e<i;++e)t[e]&&n.push(t[e]);return t=n,t}showSeq(e,t,i,s,n,r,a){let o=this.icn3d,l=o.icn3dui,d=this.getSeq(e),c=!1;void 0===l.cfg.mmdbid&&void 0===l.cfg.gi&&void 0===l.cfg.blast_rep_id&&void 0===l.cfg.align&&void 0===l.cfg.chainalign&&void 0===l.cfg.mmdbafid&&(c=!0);let h=l.htmlCls.RESIDUE_WIDTH*(d.length+o.nTotalGap)+200,p=["giseq","cddsite","clinvar","snp","ptm","ssbond","crosslink","transmem","domain","custom","interaction","ig"];for(let t in p){let i=p[t];$("#"+o.pre+i+"_"+e).length&&$("#"+o.pre+i+"_"+e).width(h)}let u,m="",f="",g="";if(m+='<div class="icn3d-dl_sequence">',g+='<div class="icn3d-dl_sequence">',d.length>10){u='<div class="icn3d-residueLine" style="white-space:nowrap;">';let t=o.firstAtomObjCls.getFirstCalphaAtomObj(o.chains[e]);void 0===l.cfg.mmdbid&&void 0===l.cfg.gi&&void 0===l.cfg.blast_rep_id&&void 0===l.cfg.align&&void 0===l.cfg.chainalign&&void 0===l.cfg.mmdbafid||void 0===t.resi_ori||t.resi_ori==t.resi||-1!=e.indexOf("Misc")?u+='<div class="icn3d-annoTitle" anno="0"></div>':u+='<div class="icn3d-annoTitle" anno="0" title="NCBI Residue Numbers">NCBI Residue Numbers</div>',u+='<span class="icn3d-residueNum"></span>',g+=u+"<br>",m+=u+'<span class="icn3d-seqLine">';let i=0,s=0,n="";o.seqStartLen&&o.seqStartLen[e]&&(m+=this.insertMulGap(o.seqStartLen[e]," "));for(let t=0,r=d.length;t<r;++t){let r;m+=this.insertGap(e,t,"-"),r=o.ParserUtilsCls.getResi(e,t),m+="<span>",r%10==0&&(m+=r);let a=e+"_"+r,l=r%10!=0&&r%10!=1&&r%10!=9;if(o.residues.hasOwnProperty(a)){let e=o.firstAtomObjCls.getFirstCalphaAtomObj(o.residues[a]);"H"==o.secondaries[a]&&e.ssbegin?(++i,n='<span class="icn3d-helix-color">H'+i+"</span>",l&&(m+=n,n="")):"E"==o.secondaries[a]&&e.ssbegin?(++s,"green"==o.sheetcolor?n='<span class="icn3d-sheet-color">S'+s+"</span>":"yellow"==o.sheetcolor&&(n='<span class="icn3d-sheet-colory">S'+s+"</span>"),l&&(m+=n,n="")):e.ssend&&(n=""),""!=n&&l&&(m+=n,n="")}m+="</span>"}o.seqStartLen&&o.seqStartLen[e]&&(m+=this.insertMulGap(o.seqEndLen[e]," ")),m+='<span class="icn3d-residueNum"></span>',m+="</span>",m+="<br>",m+="</div>",g+="</div>"}u='<div class="icn3d-residueLine" style="white-space:nowrap;">',u+='<div class="icn3d-annoTitle" anno="0"></div>',u+='<span class="icn3d-residueNum"></span>',g+=u+"<br>",m+=u+'<span class="icn3d-seqLine">',o.seqStartLen&&o.seqStartLen[e]&&(m+=this.insertMulGap(o.seqStartLen[e],"-"));for(let t=0,i=d.length;t<i;++t){m+=this.insertGap(e,t,"-");let i=e+"_"+o.ParserUtilsCls.getResi(e,t);if(o.residues.hasOwnProperty(i))if("H"==o.secondaries[i])m+=t%2==0?'<span class="icn3d-helix">':'<span class="icn3d-helix2">',m+="&nbsp;</span>";else if("E"==o.secondaries[i]){o.firstAtomObjCls.getFirstCalphaAtomObj(o.residues[i]).ssend?"green"==o.sheetcolor?m+='<span class="icn3d-sheet2">':"yellow"==o.sheetcolor&&(m+='<span class="icn3d-sheet2y">'):"green"==o.sheetcolor?m+='<span class="icn3d-sheet">':"yellow"==o.sheetcolor&&(m+='<span class="icn3d-sheety">'),m+="&nbsp;</span>"}else"c"==o.secondaries[i]?m+='<span class="icn3d-coil">&nbsp;</span>':"o"==o.secondaries[i]&&(m+='<span class="icn3d-other">&nbsp;</span>');else m+="<span>-</span>"}o.seqStartLen&&o.seqStartLen[e]&&(m+=this.insertMulGap(o.seqEndLen[e],"-")),m+='<span class="icn3d-residueNum"></span>',m+="</span>",m+="<br>",m+="</div>",m+="</div>",g+="</div></div>",u=l.cfg.blast_rep_id===e?'<div class="icn3d-dl_sequence" style="border: solid 1px #000">':'<div class="icn3d-dl_sequence">';let b="Protein",C="Protein";void 0!==i&&("nucleotide"==i?(b="Nucl.",C="Nucleotide"):"chemical"==i&&(b="Chem.",C="Chemical")),u+='<div class="icn3d-seqTitle icn3d-link icn3d-blue" gi="'+e+'" anno="sequence" chain="'+e+'"><span style="white-space:nowrap;" title="'+C+" "+e+'">'+b+" "+e+"</span></div>",u+='<span class="icn3d-residueNum" title="starting protein sequence number">'+(o.baseResi[e]+1).toString()+"</span>",g+=u+"<br>";let v='<span class="icn3d-seqLine">';m+=u+v,f+=u+v;let _,y=0;o.seqStartLen&&o.seqStartLen[e]&&(m+=this.insertMulGap(o.seqStartLen[e],"-"));for(let t=0,i=d.length;t<i;++t){m+=this.insertGap(e,t,"-"),void 0!==o.targetGapHash&&o.targetGapHash.hasOwnProperty(t)&&(y+=o.targetGapHash[t].to-o.targetGapHash[t].from+1);let i=c?d[t].name:d[t],s=i;if(i.length>1&&(s=i[0]+".."),_=o.ParserUtilsCls.getResi(e,t),o.residues.hasOwnProperty(e+"_"+_)){let n="333333";if(l.cfg.blast_rep_id==e&&void 0!==o.fullpos2ConsTargetpos&&void 0!==o.fullpos2ConsTargetpos[t+y])n=o.fullpos2ConsTargetpos[t+y].color;else{let t=o.firstAtomObjCls.getFirstCalphaAtomObj(o.residues[e+"_"+_]),i=void 0===t.color||"FFFFFF"===t.color.getHexString().toUpperCase()||"FFF"===t.color.getHexString().toUpperCase()?"DDDDDD":t.color.getHexString();n=void 0!==t.color?i:"CCCCCC"}m+='<span id="giseq_'+o.pre+e+"_"+_+'" title="'+i+_+'" class="icn3d-residue" style="color:#'+n+'">'+s+"</span>"}else s=s.toLowerCase(),m+='<span title="'+i+_+'" class="icn3d-residue">'+s+"</span>"}o.seqStartLen&&o.seqStartLen[e]&&(m+=this.insertMulGap(o.seqEndLen[e],"-")),l.cfg.blast_rep_id==e&&(o.opts.color=o.blastAcxn?"confidence":"conservation",o.setColorCls.setColorByOptions(o.opts,o.atoms));let S=o.firstAtomObjCls.getFirstCalphaAtomObj(o.chains[e]),w=S.color?S.color.getHexString():"CCCCCC",x=Math.round(o.seqAnnWidth*d.length/(o.maxAnnoLength+o.nTotalGap));if(x<1&&(x=1),o.seqStartLen&&o.seqStartLen[e]&&(f+=this.insertMulGapOverview(e,o.seqStartLen[e])),l.cfg.blast_rep_id!=e)f+='<div id="giseq_summary_'+o.pre+e+'" class="icn3d-seqTitle icn3d-link" gi chain="'+e+'" style="display:inline-block; color:white; font-weight:bold; background-color:#'+w+"; width:"+x+'px;">'+e+"</div>";else{let t=[],i=[];t.push(0);for(let e=0,s=d.length;e<s;++e)void 0!==o.targetGapHash&&o.targetGapHash.hasOwnProperty(e)&&(i.push(e-1),t.push(e));i.push(d.length-1),f+='<div id="giseq_summary_'+o.pre+e+'" class="icn3d-seqTitle icn3d-link" gi chain="'+e+'" style="width:'+x+'px;">';for(let s=0,n=t.length;s<n;++s)f+=this.insertGapOverview(e,t[s]),f+='<div style="display:inline-block; color:white!important; font-weight:bold; background-color:#'+w+"; width:"+Math.round(o.seqAnnWidth*(i[s]-t[s]+1)/(o.maxAnnoLength+o.nTotalGap))+'px;" class="icn3d-seqTitle icn3d-link icn3d-blue" anno="sequence" gi chain="'+e+'" title="'+e+'">'+e+"</div>";f+="</div>"}if(u='<span class="icn3d-residueNum" title="ending protein sequence number">'+_+"</span>",u+="</span>",u+="<br>",m+=u,f+=u,l.cfg.blast_rep_id==e){if(void 0!==a&&""!==a){u='<div class="icn3d-seqTitle icn3d-link icn3d-blue" blast="" posarray="'+o.consrvResPosArray.toString()+'" title="'+n+'" setname="'+e+'_blast" anno="sequence" chain="'+e+'"><span style="white-space:nowrap;" title="'+n+'">'+n+"</span></div>",u+='<span class="icn3d-residueNum"></span>',g+=u+"<br>";let t='<span class="icn3d-seqLine">';m+=u+t,f+=u+t;let i=0,s=0,r=1;o.queryStart;for(let t=0,n=a.length;t<n;++t){let n=a[t];if("-"==n)m+="<span>-</span>";else if(" "==n)m+="<span> </span>";else{let a=o.fullpos2ConsTargetpos[t].pos;if(o.residues.hasOwnProperty(e+"_"+a)){let i=o.fullpos2ConsTargetpos[t].color;m+='<span id="giseq_'+o.pre+e+"_"+a+'" title="'+o.fullpos2ConsTargetpos[t].res+a+'" class="icn3d-residue" style="color:#'+i+'">'+n+"</span>"}else n=n.toLowerCase(),m+='<span class="icn3d-residue">'+n+"</span>";f+=this.insertGapOverview(e,t);let l=Math.round(o.seqAnnWidth*t/(o.maxAnnoLength+o.nTotalGap)-i-s);l>=0&&(f+='<div style="display:inline-block; width:'+l+'px;">&nbsp;</div>',f+='<div style="display:inline-block; background-color:#F00; width:'+r+'px;" title="'+n+a+'">&nbsp;</div>',i+=l,s+=r)}}u='<span class="icn3d-residueNum"></span>',u+="</span>",u+="<br>",m+=u,f+=u}u='<div class="icn3d-annoTitle" anno="sequence" chain="'+e+'"><span style="white-space:nowrap;" title="'+s+'">'+s+"</span></div>",u+='<span class="icn3d-residueNum" title="starting protein sequence number">'+o.queryStart+"</span>",g+=u+"<br>";let t='<span class="icn3d-seqLine" style="font-weight: bold;">';m+=u+t,f+=u+t;let i=o.queryStart;for(let t=0,s=r.length;t<s;++t){let s=r[t];" "==s||"-"==s?m+="<span>-</span>":(void 0===o.fullpos2ConsTargetpos||void 0===o.fullpos2ConsTargetpos[t]||o.residues.hasOwnProperty(e+"_"+o.fullpos2ConsTargetpos[t].pos)||(s=s.toLowerCase()),m+='<span title="'+s+i+'" class="icn3d-residue">'+s+"</span>",++i)}let l=o.firstAtomObjCls.getFirstCalphaAtomObj(o.chains[e]),d=void 0===l.color||"FFFFFF"===l.color.getHexString()?"DDDDDD":l.color.getHexString(),c=void 0!==l.color?d:"CCCCCC",h=[],p=[],b="-";for(let e=0,t=r.length;e<t;++e){let t=r[e];"-"!=t&&"-"==b?h.push(e):"-"==t&&"-"!=b&&p.push(e-1),b=t}"-"!=b&&p.push(r.length-1);for(let t=0,i=h.length;t<i;++t){f+='<div style="display:inline-block; width:'+(0==t?Math.round(o.seqAnnWidth*(h[t]-o.baseResi[e]-1)/(o.maxAnnoLength+o.nTotalGap)):Math.round(o.seqAnnWidth*(h[t]-p[t-1]-1)/(o.maxAnnoLength+o.nTotalGap)))+'px;">&nbsp;</div>',f+='<div style="display:inline-block; color:white!important; font-weight:bold; background-color:#'+c+"; width:"+Math.round(o.seqAnnWidth*(p[t]-h[t]+1)/(o.maxAnnoLength+o.nTotalGap))+'px;" anno="sequence" chain="'+e+'" title="'+s+'">'+s+"</div>"}u='<span class="icn3d-residueNum" title="ending protein sequence number">'+o.queryEnd+"</span>",u+="</span>",u+="<br>",m+=u,f+=u}if(m+="</div>",f+="</div>",g+="</div>",d.length>10){let t=o.firstAtomObjCls.getFirstCalphaAtomObj(o.chains[e]);if((void 0!==l.cfg.mmdbid||void 0!==l.cfg.gi||void 0!==l.cfg.blast_rep_id||void 0!==l.cfg.align||void 0!==l.cfg.chainalign||void 0!==l.cfg.mmdbafid)&&void 0!==t.resi_ori&&t.resi_ori!=t.resi&&-1==e.indexOf("Misc")){u='<div class="icn3d-dl_sequence">',u+='<div class="icn3d-residueLine" style="white-space:nowrap;">',u+='<div class="icn3d-annoTitle" anno="0" title="PDB Residue Numbers">PDB Residue Numbers</div>',u+='<span class="icn3d-residueNum"></span>',g+=u+"<br>",m+=u+'<span class="icn3d-seqLine">',o.seqStartLen&&o.seqStartLen[e]&&(m+=this.insertMulGap(o.seqStartLen[e],"-"));for(let t=0,i=d.length;t<i;++t){m+=this.insertGap(e,t,"-");let i=e+"_"+o.ParserUtilsCls.getResi(e,t);if(o.residues.hasOwnProperty(i)){let e=o.firstAtomObjCls.getFirstCalphaAtomObj(o.residues[i]).resi_ori;m+="<span>",e%10==0&&(m+=e+" "),m+="</span>"}else m+="<span></span>"}o.seqStartLen&&o.seqStartLen[e]&&(m+=this.insertMulGap(o.seqEndLen[e],"-")),m+='<span class="icn3d-residueNum"></span>',m+="</span>",m+="<br>",m+="</div>",m+="</div>",g+="</div></div>"}if(o.bShowCustomRefnum&&o.chainsMapping.hasOwnProperty(e)){let t=!0,i=o.annoIgCls.showRefNum(d,e,void 0,t);m+=i.html,g+=i.html3}}o.bShowRefnum&&o.hlUpdateCls.updateHlAll(),$("#"+o.pre+"dt_giseq_"+e).html(m),$("#"+o.pre+"ov_giseq_"+e).html(f),$("#"+o.pre+"tt_giseq_"+e).html(g)}insertGap(e,t,i,s){let n=this.icn3d;n.icn3dui;let r="";return void 0!==n.targetGapHash&&n.targetGapHash.hasOwnProperty(t)&&(r+=this.insertMulGap(n.targetGapHash[t].to-n.targetGapHash[t].from+1,i,s)),r}insertMulGap(e,t,i){this.icn3d.icn3dui;let s="";for(let n=0;n<e;++n)s+=i?t:"<span>"+t+"</span>";return s}insertGapOverview(e,t){let i=this.icn3d;i.icn3dui;let s="";return void 0!==i.targetGapHash&&i.targetGapHash.hasOwnProperty(t)&&(s+=this.insertMulGapOverview(e,i.targetGapHash[t].to-i.targetGapHash[t].from+1)),s}insertMulGapOverview(e,t){let i=this.icn3d;i.icn3dui;let s="",n=i.seqAnnWidth*t/(i.maxAnnoLength+i.nTotalGap);return n=parseInt(n),s+='<div style="display:inline-block; width:'+n+'px;">&nbsp;</div>',s}setAlternativeSeq(e,t){let i=this.icn3d;i.icn3dui;let s=i.chainsSeq[e];i.giSeq[e]=[];for(let t=0,n=s.length;t<n;++t){let n=s[t].name;i.giSeq[e][t]=n}i.matchedPos[e]=0,i.baseResi[e]=i.chainsSeq[e][0].resi-i.matchedPos[e]-1}getProteinName(e){let t=this.icn3d,i=t.icn3dui,s="";if(void 0===i.cfg.mmdbid&&void 0===i.cfg.gi&&void 0===i.cfg.blast_rep_id||void 0===t.mmdb_data)(void 0!==i.cfg.align||void 0!==i.cfg.chainalign||void 0!==i.cfg.mmdbafid||t.bRealign||t.bSymd)&&void 0!==t.chainid2title&&void 0!==t.chainid2title[e]&&(s=t.chainid2title[e]);else{let i=t.mmdb_data.moleculeInfor,n=e.substr(e.indexOf("_")+1);for(let e in i)if(i[e].chain==n){s=i[e].name.replace(/\'/g,"&prime;");break}}return s}}class fh{constructor(e){this.icn3d=e}selectSequenceNonMobile(){let e=this.icn3d;if(e.icn3dui.bNode)return;let t=this;$("#"+e.pre+"dl_sequence2").add("[id^="+e.pre+"dt_giseq]").add("[id^="+e.pre+"dt_custom]").add("[id^="+e.pre+"dt_site]").add("[id^="+e.pre+"dt_ptm]").add("[id^="+e.pre+"dt_snp]").add("[id^="+e.pre+"dt_clinvar]").add("[id^="+e.pre+"dt_cdd]").add("[id^="+e.pre+"dt_domain]").add("[id^="+e.pre+"dt_interaction]").add("[id^="+e.pre+"dt_ssbond]").add("[id^="+e.pre+"dt_crosslink]").add("[id^="+e.pre+"dt_transmem]").add("[id^="+e.pre+"dt_ig]").add("[id^="+e.pre+"tt_giseq]").add("[id^="+e.pre+"tt_custom]").add("[id^="+e.pre+"tt_site]").add("[id^="+e.pre+"tt_ptm]").add("[id^="+e.pre+"tt_snp]").add("[id^="+e.pre+"tt_clinvar]").add("[id^="+e.pre+"tt_cdd]").add("[id^="+e.pre+"tt_domain]").add("[id^="+e.pre+"tt_interaction]").add("[id^="+e.pre+"tt_ssbond]").add("[id^="+e.pre+"tt_crosslink]").add("[id^="+e.pre+"tt_transmem]").add("[id^="+e.pre+"tt_ig]").selectable({distance:1,stop:function(){let e=t.icn3d;$(this).attr("id")===e.pre+"dl_sequence2"?(e.bAlignSeq=!0,e.bAnnotations=!1):(e.bAlignSeq=!1,e.bAnnotations=!0),!1!==e.bSelectResidue||e.bShift||e.bCtrl||e.selectionCls.removeSelection(),$("span.ui-selected",this).each((function(){let e=$(this).attr("id");void 0!==e&&t.selectResidues(e,this)})),e.selectionCls.saveSelectionPrep(!0),e.selectionCls.saveSelection(void 0,void 0,!1),e.hlObjectsCls.addHlObjects();let i={};for(let t in e.selectedResidues){let e=t.lastIndexOf("_");i[t.substr(0,e)]=1}let s=Object.keys(i);e.hlUpdateCls.updateHl2D(s),$("div.ui-selected",this).each((function(){void 0!==$(this).attr("chain")&&t.selectTitle(this)}))}}),$("[id^="+e.pre+"ov_giseq]").add("[id^="+e.pre+"ov_custom]").add("[id^="+e.pre+"ov_site]").add("[id^="+e.pre+"ov_ptm]").add("[id^="+e.pre+"ov_snp]").add("[id^="+e.pre+"ov_clinvar]").add("[id^="+e.pre+"ov_cdd]").add("[id^="+e.pre+"ov_domain]").add("[id^="+e.pre+"ov_interaction]").add("[id^="+e.pre+"ov_ssbond]").add("[id^="+e.pre+"ov_crosslink]").add("[id^="+e.pre+"ov_transmem]").add("[id^="+e.pre+"ov_ig]").add("[id^="+e.pre+"tt_giseq]").add("[id^="+e.pre+"tt_custom]").add("[id^="+e.pre+"tt_site]").add("[id^="+e.pre+"tt_ptm]").add("[id^="+e.pre+"tt_snp]").add("[id^="+e.pre+"tt_clinvar]").add("[id^="+e.pre+"tt_cdd]").add("[id^="+e.pre+"tt_domain]").add("[id^="+e.pre+"tt_interaction]").add("[id^="+e.pre+"tt_ssbond]").add("[id^="+e.pre+"tt_crosslink]").add("[id^="+e.pre+"tt_transmem]").add("[id^="+e.pre+"tt_ig]").add("#"+e.pre+"dl_sequence2").add("[id^="+e.pre+"dt_giseq]").add("[id^="+e.pre+"dt_custom]").add("[id^="+e.pre+"dt_site]").add("[id^="+e.pre+"dt_ptm]").add("[id^="+e.pre+"dt_snp]").add("[id^="+e.pre+"dt_clinvar]").add("[id^="+e.pre+"dt_cdd]").add("[id^="+e.pre+"dt_domain]").add("[id^="+e.pre+"dt_interaction]").add("[id^="+e.pre+"dt_ssbond]").add("[id^="+e.pre+"dt_crosslink]").add("[id^="+e.pre+"dt_transmem]").add("[id^="+e.pre+"dt_ig]").add("[id^="+e.pre+"tt_giseq]").add("[id^="+e.pre+"tt_custom]").add("[id^="+e.pre+"tt_site]").add("[id^="+e.pre+"tt_ptm]").add("[id^="+e.pre+"tt_snp]").add("[id^="+e.pre+"tt_clinvar]").add("[id^="+e.pre+"tt_cdd]").add("[id^="+e.pre+"tt_domain]").add("[id^="+e.pre+"tt_interaction]").add("[id^="+e.pre+"tt_ssbond]").add("[id^="+e.pre+"tt_crosslink]").add("[id^="+e.pre+"tt_transmem]").add("[id^="+e.pre+"tt_ig]").on("click",".icn3d-seqTitle",(function(e){let i=t.icn3d;e.stopImmediatePropagation(),$(this).parents("div").attr("id")===i.pre+"dl_sequence2"?(i.bAlignSeq=!0,i.bAnnotations=!1):(i.bAlignSeq=!1,i.bAnnotations=!0),t.selectTitle(this),i.hlUpdateCls.hlSummaryDomain3ddomain(this)}))}selectSequenceMobile(){let e=this.icn3d;if(e.icn3dui.bNode)return;let t=this;$("#"+e.pre+"dl_sequence2").add("[id^="+e.pre+"giseq]").add("[id^="+e.pre+"custom]").add("[id^="+e.pre+"site]").add("[id^="+e.pre+"ptm]").add("[id^="+e.pre+"clinvar]").add("[id^="+e.pre+"snp]").add("[id^="+e.pre+"cdd]").add("[id^="+e.pre+"domain]").add("[id^="+e.pre+"interaction]").add("[id^="+e.pre+"ssbond]").add("[id^="+e.pre+"crosslink]").add("[id^="+e.pre+"transmem]").add("[id^="+e.pre+"ig]").on("click",".icn3d-residue",(function(e){let i=t.icn3d;e.stopImmediatePropagation();let s=$(this).attr("id");void 0!==s&&(t.selectResidues(s,this),i.selectionCls.saveSelectionPrep(!0),i.selectionCls.saveSelection(void 0,void 0,!1)),i.hlObjectsCls.addHlObjects();let n={};for(let e in i.selectedResidues){let t=e.lastIndexOf("_");n[e.substr(0,t)]=1}i.hlUpdateCls.removeHl2D();let r=Object.keys(n);i.hlUpdateCls.updateHl2D(r)}))}selectChainMobile(){let e=this.icn3d;if(e.icn3dui.bNode)return;let t=this;$("#"+e.pre+"dl_sequence2").add("[id^="+e.pre+"giseq]").add("[id^="+e.pre+"custom]").add("[id^="+e.pre+"site]").add("[id^="+e.pre+"ptm]").add("[id^="+e.pre+"feat]").add("[id^="+e.pre+"clinvar]").add("[id^="+e.pre+"snp]").add("[id^="+e.pre+"cdd]").add("[id^="+e.pre+"domain]").add("[id^="+e.pre+"interaction]").add("[id^="+e.pre+"ssbond]").add("[id^="+e.pre+"crosslink]").add("[id^="+e.pre+"transmem]").add("[id^="+e.pre+"ig]").on("click",".icn3d-seqTitle",(function(e){let i=t.icn3d;e.stopImmediatePropagation(),$(this).parents("div").attr("id")===i.pre+"dl_sequence2"?(i.bAlignSeq=!0,i.bAnnotations=!1):(i.bAlignSeq=!1,i.bAnnotations=!0),t.selectTitle(this),i.hlUpdateCls.hlSummaryDomain3ddomain(this)}))}selectTitle(e){let t=this.icn3d,i=t.icn3dui;if(!i.bNode&&$(e).hasClass("icn3d-seqTitle")){let s,n,r,a=$(e).attr("chain"),o=$(e).attr("resn");if(t.bAlignSeq?t.bSelectAlignResidue=!1:t.bSelectResidue=!1,t.bAnnotations||t.hlUpdateCls.removeSeqChainBkgd(a),t.bCtrl||t.bShift||(t.hlUpdateCls.removeSeqResidueBkgd(),t.hlUpdateCls.removeSeqChainBkgd(),t.currSelectedSets=[]),$(e).toggleClass("icn3d-highlightSeq"),o?s=o:t.bAnnotations?(s=$(e).attr("setname"),n=$(e).attr("title")):s=t.bAlignSeq?"align_"+a:a,$(e).hasClass("icn3d-highlightSeq"))if(t.bAnnotations){if($(e).hasClass("icn3d-highlightSeq"))if(t.hlUpdateCls.removeHl2D(),void 0!==$(e).attr("gi")){if(t.bCtrl||t.bShift)if(t.currSelectedSets.push(a),o){let e=i.hashUtilsCls.cloneHash(t.hAtoms),n=!0;t.selByCommCls.selectBySpec("select :3"+o,s,s,!1,n),t.hAtoms=i.hashUtilsCls.unionHash(t.hAtoms,e),t.hlUpdateCls.updateHlAll(o,void 0,!0,!0)}else t.selectionCls.selectAChain(a,a,!1,!0);else if(t.currSelectedSets=[a],o){let e=!0;t.selByCommCls.selectBySpec("select :3"+o,s,s,!1,e),t.hlUpdateCls.updateHlAll(o,void 0,!0,!0)}else t.selectionCls.selectAChain(a,a,!1);o?i.htmlCls.clickMenuCls.setLogCmd("select :3"+o,!0):i.htmlCls.clickMenuCls.setLogCmd("select chain "+a,!0);let e=t.currSelectedSets.join(" or ");t.currSelectedSets.length>1&&i.htmlCls.clickMenuCls.setLogCmd("select sets "+e,!0)}else{let o={};if(void 0!==$(e).attr("domain")||void 0!==$(e).attr("feat")||void 0!==$(e).attr("3ddomain")||void 0!==$(e).attr("custom")||void 0!==$(e).attr("ig")){t.hlUpdateCls.hlSummaryDomain3ddomain(e);let l,d,c,h=$(e).attr("from").split(","),p=$(e).attr("to").split(",");a.substr(0,a.indexOf("_"));for(let i=0,s=h.length;i<s;++i){d=parseInt(h[i]),c=parseInt(p[i]);for(let i=d;i<=c;++i){if(void 0!==$(e).attr("domain")||void 0!==$(e).attr("feat")||void 0!==$(e).attr("ig")){let e=a+"_"+(i+1).toString();l=t.ncbi2resid[e]}else l=void 0!==$(e).attr("3ddomain")?t.ncbi2resid[a+"_"+i]:a+"_"+(i+1).toString();o[l]=1}}t.bCtrl||t.bShift?t.selectionCls.selectResidueList(o,s,n,!0):t.selectionCls.selectResidueList(o,s,n,!1),l=a+"_"+parseInt((d+c)/2).toString(),r=t.applyCenterCls.centerAtoms(i.hashUtilsCls.hash2Atoms(t.residues[l],t.atoms))}else if(void 0!==$(e).attr("posarray")){let l,d=$(e).attr("posarray").split(",");a.substr(0,a.indexOf("_"));for(let i=0,s=d.length;i<s;++i){if(void 0!==$(e).attr("site")||void 0!==$(e).attr("ptm")){let e=a+"_"+(parseInt(d[i])+1).toString();l=t.ncbi2resid[e]}else l=a+"_"+d[i];o[l]=1}t.bCtrl||t.bShift?t.selectionCls.selectResidueList(o,s,n,!0):t.selectionCls.selectResidueList(o,s,n,!1),l=a+"_"+d[parseInt((0+d.length)/2)].toString(),r=t.applyCenterCls.centerAtoms(i.hashUtilsCls.hash2Atoms(t.residues[l],t.atoms))}for(let e in t.labels)"schematic"!==e&&"distance"!==e&&(t.labels[e]=[]);let l=t.LABELSIZE,d="black"!=t.opts.background?t.colorWhitebkgd:t.colorBlackbkgd;void 0!==r&&t.analysisCls.addLabel(n,r.center.x,r.center.y,r.center.z,l,d,void 0,"custom"),t.drawCls.draw(),i.htmlCls.clickMenuCls.setLogCmd("select "+t.resid2specCls.residueids2spec(Object.keys(o))+" | name "+s,!0),t.bCtrl||t.bShift?t.currSelectedSets.push(s):t.currSelectedSets=[s];let c=t.currSelectedSets.join(" or ");t.currSelectedSets.length>1&&i.htmlCls.clickMenuCls.setLogCmd("select sets "+c,!0)}}else{t.bCtrl||t.bShift?(t.currSelectedSets.push(s),t.selectionCls.selectAChain(a,s,!0,!0)):(t.currSelectedSets=[s],t.selectionCls.selectAChain(a,s,t.bAlignSeq)),t.bAlignSeq?i.htmlCls.clickMenuCls.setLogCmd("select alignChain "+a,!0):i.htmlCls.clickMenuCls.setLogCmd("select chain "+a,!0);let e=t.currSelectedSets.join(" or ");t.currSelectedSets.length>1&&i.htmlCls.clickMenuCls.setLogCmd("select sets "+e,!0)}else t.hlObjectsCls.removeHlObjects(),t.hlUpdateCls.removeHl2D(),$("#"+t.pre+"atomsCustom").val("")}}selectResidues(e,t){let i=this.icn3d,s=i.icn3dui;if(!s.bNode&&(!1!==i.bSelectResidue||i.bShift||i.bCtrl||i.selectionCls.removeSelection(),void 0!==e&&""!==e)){e=e.substr(e.indexOf("_")+1),i.bSelectResidue=!0,$(t).toggleClass("icn3d-highlightSeq");let n=e.substr(e.indexOf("_")+1);if(i.residues.hasOwnProperty(n))if($(t).hasClass("icn3d-highlightSeq")){for(let e in i.residues[n])i.hAtoms[e]=1;if(i.selectedResidues[n]=1,i.bAnnotations&&void 0!==$(t).attr("disease")){let e=$(t).attr("disease"),r=i.applyCenterCls.centerAtoms(s.hashUtilsCls.hash2Atoms(i.residues[n],i.atoms)),a=15;e.length>a&&(e=e.substr(0,a)+"...");let o=i.LABELSIZE,l=s.htmlCls.GREYD;i.analysisCls.addLabel(e,r.center.x,r.center.y,r.center.z,o,l,void 0,"custom")}}else{for(let e in i.residues[n])delete i.hAtoms[e];delete i.selectedResidues[n],i.hlObjectsCls.removeHlObjects()}}}}class gh{constructor(e){this.icn3d=e}update2DdgmContent(){let e=this.icn3d,t=e.icn3dui,i="";void 0!==t.cfg.mmdbid||void 0!==t.cfg.gi?(i+=e.diagram2dCls.draw2Ddgm(e.interactionData,e.inputid,void 0,!0),i+=e.diagram2dCls.set2DdgmNote(),$("#"+e.pre+"dl_2ddgm_html").html(i)):e.mmdbidArray&&(void 0!==t.cfg.align||void 0!==t.cfg.chainalign||e.bRealign)&&(i+=e.diagram2dCls.draw2Ddgm(e.interactionData1,e.mmdbidArray[0].toUpperCase(),0,!0),void 0!==e.mmdbid_q&&e.mmdbid_q===e.mmdbid_t?i+=e.diagram2dCls.draw2Ddgm(e.interactionData2,e.mmdbidArray[0].toUpperCase(),1,!0):i+=e.diagram2dCls.draw2Ddgm(e.interactionData2,e.mmdbidArray[1].toUpperCase(),1,!0),i+=e.diagram2dCls.set2DdgmNote(!0),$("#"+e.pre+"dl_2ddgm_html").html(i))}changeSeqColor(e){let t=this.icn3d,i=t.icn3dui;for(let s=0,n=e.length;s<n;++s){let n=e[s],r=t.firstAtomObjCls.getFirstCalphaAtomObj(t.residues[n]);if(!r)continue;let a=void 0===r.color||"FFFFFF"===r.color.getHexString().toUpperCase()?"DDDDDD":r.color.getHexString(),o=void 0!==r.color?a:"CCCCCC";$("[id=giseq_"+t.pre+n+"]").attr("style","color:#"+o),$("[id=align_"+t.pre+n+"]").attr("style","color:#"+o),(void 0!==i.cfg.align||void 0!==i.cfg.chainalign||t.bRealign||t.bSymd)&&$("[id=align_"+t.pre+n+"]").attr("style","color:#"+o)}}removeHlAll(){this.icn3d.icn3dui,this.removeHlObjects(),this.removeHlSeq(),this.removeHl2D(),this.removeHlMenus()}removeHlObjects(){let e=this.icn3d;e.icn3dui,e.hlObjectsCls.removeHlObjects()}removeHlSeq(){this.icn3d.icn3dui,this.removeSeqResidueBkgd()}removeHl2D(e){let t=this.icn3d;t.icn3dui,$("#"+t.pre+"dl_2ddgm rect").attr("stroke","#000000"),$("#"+t.pre+"dl_2ddgm circle").attr("stroke","#000000"),$("#"+t.pre+"dl_2ddgm polygon").attr("stroke","#000000"),$("#"+t.pre+"dl_2ddgm rect").attr("stroke-width",1),$("#"+t.pre+"dl_2ddgm circle").attr("stroke-width",1),$("#"+t.pre+"dl_2ddgm polygon").attr("stroke-width",1),$("#"+t.pre+"dl_2ddgm circle").length>0&&($("#"+t.pre+"dl_2ddgm svg line").attr("stroke","#000000"),$("#"+t.pre+"dl_2ddgm line").attr("stroke-width",1)),e||($("#"+t.pre+"dl_linegraph circle").attr("stroke","#000000"),$("#"+t.pre+"dl_linegraph circle").attr("stroke-width",1),$("#"+t.pre+"dl_scatterplot rect").attr("stroke","#000000"),$("#"+t.pre+"dl_scatterplot circle").attr("stroke","#000000"),$("#"+t.pre+"dl_scatterplot rect").attr("stroke-width",1),$("#"+t.pre+"dl_scatterplot circle").attr("stroke-width",1))}removeHlMenus(){let e=this.icn3d;e.icn3dui,$("#"+e.pre+"atomsCustom").val(""),$("#"+e.pre+"atomsCustom")[0].blur()}updateHlAll(e,t,i,s){let n=this.icn3d,r=n.icn3dui;n.prevHighlightAtoms=r.hashUtilsCls.cloneHash(n.hAtoms),this.updateHlObjects(s),void 0!==e?this.updateHlSeqInChain(e,i):this.updateHlSeq(void 0,void 0,i),this.updateHl2D(),(void 0===t||t)&&this.updateHlMenus(e)}updateHlObjects(e){let t=this.icn3d;t.icn3dui,t.hlObjectsCls.removeHlObjects(),(t.hAtoms&&t.atoms&&Object.keys(t.hAtoms).length<Object.keys(t.dAtoms).length||e)&&((void 0===t.bShowHighlight||t.bShowHighlight)&&t.hlObjectsCls.addHlObjects(),t.definedSetsCls.setMode("selection"))}updateHlSeq(e,t,i){let s=this.icn3d;s.icn3dui,void 0!==i&&i||this.removeHlSeq(),void 0===t&&(t=s.firstAtomObjCls.getResiduesFromCalphaAtoms(s.hAtoms)),s.hAtoms&&s.atoms&&Object.keys(s.hAtoms).length<Object.keys(s.atoms).length&&this.hlSequence(Object.keys(t)),this.changeSeqColor(Object.keys(t))}updateHlSeqInChain(e,t){let i=this.icn3d;if(i.icn3dui,void 0!==t&&t||this.removeHlSeq(),!i.hAtoms||!i.atoms||Object.keys(i.hAtoms).length!=Object.keys(i.atoms).length)for(let t=0,s=e.length;t<s;++t){let s=e[t];if(-1!==Object.keys(i.chains).indexOf(s))this.hlSeqInChain(s);else{let e=[];void 0!==i.defNames2Residues[s]&&i.defNames2Residues[s].length>0&&(e=i.defNames2Residues[s]);let t={};if(void 0!==i.defNames2Atoms[s]&&i.defNames2Atoms[s].length>0){for(let e=0,n=i.defNames2Atoms[s].length;e<n;++e){let n=i.defNames2Atoms[s][e],r=i.atoms[n];t[r.structure+"_"+r.chain+"_"+r.resi]=1}e=e.concat(Object.keys(t))}this.hlSequence(e)}}}updateHl2D(e){let t=this.icn3d,i=t.icn3dui;if(this.removeHl2D(!0),!t.hAtoms||!t.atoms||Object.keys(t.hAtoms).length!=Object.keys(t.atoms).length){if(void 0===e){let i=t.firstAtomObjCls.getChainsFromAtoms(t.hAtoms);e=Object.keys(i)}if(void 0!==e)for(let s=0,n=e.length;s<n;++s){let n=i.hashUtilsCls.intHash(t.chains[e[s]],t.hAtoms);if(!t.chains[e[s]])continue;let r=1*Object.keys(n).length/Object.keys(t.chains[e[s]]).length,a=t.firstAtomObjCls.getFirstCalphaAtomObj(n);if(void 0!==t.alnChains[e[s]]){let r=i.hashUtilsCls.intHash(t.alnChains[e[s]],n);Object.keys(r).length>0&&(a=t.firstAtomObjCls.getFirstCalphaAtomObj(r))}let o=void 0!==a&&void 0!==a.color?"#"+a.color.getHexString():"#FFFFFF",l=$("#"+t.pre+"dl_2ddgm g[chainid="+e[s]+"] rect[class='icn3d-hlnode']"),d=$("#"+t.pre+"dl_2ddgm g[chainid="+e[s]+"] rect[class='icn3d-basenode']");void 0!==l&&(t.diagram2dCls.highlightNode("rect",l,d,r),$(l).attr("fill",o)),l=$("#"+t.pre+"dl_2ddgm g[chainid="+e[s]+"] circle[class='icn3d-hlnode']"),d=$("#"+t.pre+"dl_2ddgm g[chainid="+e[s]+"] circle[class='icn3d-basenode']"),void 0!==l&&(t.diagram2dCls.highlightNode("circle",l,d,r),$(l).attr("fill",o)),l=$("#"+t.pre+"dl_2ddgm g[chainid="+e[s]+"] ellipse[class='icn3d-hlnode']"),void 0!==l&&t.diagram2dCls.highlightNode("ellipse",l,void 0,r),l=$("#"+t.pre+"dl_2ddgm g[chainid="+e[s]+"] polygon[class='icn3d-hlnode']"),d=$("#"+t.pre+"dl_2ddgm g[chainid="+e[s]+"] polygon[class='icn3d-basenode']"),void 0!==l&&(t.diagram2dCls.highlightNode("polygon",l,d,r),$(l).attr("fill",o))}if(void 0!==t.lineArray2d)for(let e=0,s=t.lineArray2d.length;e<s;e+=2)$("#"+t.pre+"dl_2ddgm g[chainid1="+t.lineArray2d[e]+"][chainid2="+t.lineArray2d[e+1]+"] line").attr("stroke",i.htmlCls.ORANGE);t.prevHighlightAtoms=i.hashUtilsCls.cloneHash(t.hAtoms),t.definedSetsCls.setMode("selection")}}updateHlMenus(e){let t=this.icn3d;t.icn3dui,void 0===e&&(e=[]);let i=t.definedSetsCls.setAtomMenu(e);$("#"+t.pre+"atomsCustom").length&&($("#"+t.pre+"atomsCustom").html(i),$("#"+t.pre+"atomsCustom")[0].blur())}hlSequence(e){let t=this.icn3d;t.icn3dui;let i={};for(let s=0,n=e.length;s<n;++s){let n=e[s].trim(),r=$("[id=giseq_"+t.pre+n+"]");0!==r.length&&r.addClass("icn3d-highlightSeq"),r=$("[id=align_"+t.pre+n+"]"),0!==r.length&&r.addClass("icn3d-highlightSeq");let a=n.lastIndexOf("_");i[n.substr(0,a)]=1}for(let e in i)0!==$("#giseq_summary_"+t.pre+e).length&&$("#giseq_summary_"+t.pre+e).addClass("icn3d-highlightSeqBox")}hlSeqInChain(e){let t=this.icn3d;t.icn3dui;for(let i=0,s=t.chainsSeq[e].length;i<s;++i){let s=e+"_"+t.chainsSeq[e][i].resi;0!==$("#giseq_"+t.pre+s).length&&$("#giseq_"+t.pre+s).addClass("icn3d-highlightSeq"),0!==$("#align_"+t.pre+s).length&&$("#align_"+t.pre+s).addClass("icn3d-highlightSeq")}0!==$("#giseq_summary_"+t.pre+e).length&&$("#giseq_summary_"+t.pre+e).addClass("icn3d-highlightSeqBox")}toggleHighlight(){let e=this.icn3d;e.icn3dui,e.bShowHighlight?(this.clearHighlight(),e.bShowHighlight=!1):(this.showHighlight(),e.bShowHighlight=!0)}clearHighlight(){let e=this.icn3d;e.icn3dui,e.labels.picking=[],e.drawCls.draw(),e.hlObjectsCls.removeHlObjects(),this.removeHl2D(),e.bRender&&e.drawCls.render(),this.removeSeqChainBkgd(),this.removeSeqResidueBkgd(),e.bSelectResidue=!1}showHighlight(){let e=this.icn3d;e.icn3dui,e.hlObjectsCls.addHlObjects(),this.updateHlAll()}highlightChains(e){let t=this.icn3d;t.icn3dui,t.hlObjectsCls.removeHlObjects(),this.removeHl2D(),t.hlObjectsCls.addHlObjects(),this.updateHl2D(e);let i={};for(let s=0,n=e.length;s<n;++s){let n=e[s];for(let e in t.chainsSeq[n]){let s=t.chainsSeq[n][e],r=n+"_"+s.resi;""!==s.name&&"-"!==s.name&&(i[r]=1)}}this.hlSequence(Object.keys(i))}hlSummaryDomain3ddomain(e){if(this.icn3d.icn3dui,void 0!==$(e).attr("domain")){let t=$(e).attr("index"),i=$(e).attr("chain");0!==$("[id^="+i+"_domain_"+t+"]").length&&$("[id^="+i+"_domain_"+t+"]").addClass("icn3d-highlightSeqBox")}if(void 0!==$(e).attr("3ddomain")){let t=$(e).attr("index"),i=$(e).attr("chain");0!==$("[id^="+i+"_3d_domain_"+t+"]").length&&$("[id^="+i+"_3d_domain_"+t+"]").addClass("icn3d-highlightSeqBox")}}removeSeqChainBkgd(e){void 0===e?$(".icn3d-seqTitle").each((function(e){$(this).removeClass("icn3d-highlightSeq"),$(this).removeClass("icn3d-highlightSeqBox")})):$(".icn3d-seqTitle").each((function(t){$(this).attr("chain")!==e&&($(this).removeClass("icn3d-highlightSeq"),$(this).removeClass("icn3d-highlightSeqBox"))}))}removeSeqResidueBkgd(){$(".icn3d-residue").each((function(e){$(this).removeClass("icn3d-highlightSeq")}))}}class bh{constructor(e){this.icn3d=e}addHlObjects(e,t,i){let s=this.icn3d,n=s.icn3dui;void 0===e&&(e=s.hColor);let r=i?n.hashUtilsCls.intHash(i,s.dAtoms):n.hashUtilsCls.intHash(s.hAtoms,s.dAtoms);s.applyDisplayCls.applyDisplayOptions(s.opts,r,s.bHighlight),(t||s.bRender)&&s.drawCls.render()}removeHlObjects(){let e=this.icn3d;e.icn3dui;for(let t in e.prevHighlightObjects)e.mdl&&e.mdl.remove(e.prevHighlightObjects[t]);e.prevHighlightObjects=[];for(let t in e.prevHighlightObjects_ghost)e.mdl&&e.mdl.remove(e.prevHighlightObjects_ghost[t]);e.prevHighlightObjects_ghost=[]}}class Ch{constructor(e){this.icn3d=e}drawLineGraph(e,t){let i,s=this.icn3d,n=s.icn3dui,r=JSON.parse(e),a=[],o=[],l=[],d={};for(let e=0,t=r.nodes.length;e<t;++e){let t=r.nodes[e];d[t.id]=t}let c={};for(let e=0,t=r.links.length;e<t;++e){let t=r.links[e];t.v!=n.htmlCls.hbondValue&&t.v!=n.htmlCls.ionicValue&&t.v!=n.htmlCls.halogenValue&&t.v!=n.htmlCls.picationValue&&t.v!=n.htmlCls.pistackingValue&&t.v!=n.htmlCls.contactValue||(a.push(t),c[t.source]=1,c[t.target]=1)}let h=s.getGraphCls.getNodeTopBottom(c,d);o=h.nodeArray1,l=h.nodeArray2,s.lineGraphStr="{\n";let p=Object.keys(s.structures);if(p.length>1){let e={},r=[],o=[],l=[],c=[],h=[],u=[],m=[],f=[],g=[],b=[],C=[],v=[],_={},y={},S={};for(let t=0,i=p.length;t<i;++t)r[t]=[],o[t]=[],l[t]=[],c[t]={},h[t]=[],u[t]=[],m[t]=[],f[t]={},g[t]=[],b[t]=[],C[t]=[],v[t]={},e[p[t]]=t;for(let t=0,i=a.length;t<i;++t){let i=a[t],n=d[i.source],r=d[i.target];if(!(n&&r&&n.r&&r.r))continue;let o=this.getIdArrayFromNode(n),h=this.getIdArrayFromNode(r),u=e[o[2]];if(o[2]==p[u]&&h[2]==p[u]){l[u].push(i),c[u][i.source]=1,c[u][i.target]=1;let e,t,r=o[2]+"_"+o[3],a=h[2]+"_"+h[3],d=r+"_"+o[4],p=a+"_"+h[4];if(s.chainsMapping[r]&&s.chainsMapping[r][d]&&s.chainsMapping[a]&&s.chainsMapping[a][p]){e="a"==n.s?s.chainsMapping[r][d]:s.chainsMapping[a][p],t="a"==n.s?s.chainsMapping[a][p]:s.chainsMapping[r][d];let o=e+"_"+t+"_"+i.c;_.hasOwnProperty(o)?(++_[o],y[o]+=i.n,S[o]=y[o]/i.n==_[o]?0:1):(_[o]=1,y[o]=i.n)}}}let w="=>",x="==>",A="-",M="--";for(let t=0,i=a.length;t<i;++t){let i=a[t],r=d[i.source],o=d[i.target];if(!(r&&o&&r.r&&o.r))continue;let h=this.getIdArrayFromNode(r),u=this.getIdArrayFromNode(o),g=e[h[2]];if(h[2]==p[g]&&u[2]==p[g]){l[g].push(i),c[g][i.source]=1,c[g][i.target]=1;let e,t,a=h[2]+"_"+h[3],o=u[2]+"_"+u[3],d=a+"_"+h[4],b=o+"_"+u[4];if(s.chainsMapping[a]&&s.chainsMapping[a][d]&&s.chainsMapping[o]&&s.chainsMapping[o][b]){e="a"==r.s?s.chainsMapping[a][d]:s.chainsMapping[o][b],t="a"==r.s?s.chainsMapping[o][b]:s.chainsMapping[a][d];let l=e.length>4&&!isNaN(parseInt(e.substr(-4,4)))||t.length>4&&!isNaN(parseInt(t.substr(-4,4))),c=e+"_"+t+"_"+i.c,h=n.hashUtilsCls.cloneHash(i);h.source+=w+s.chainsMapping[a][d],h.target+=w+s.chainsMapping[o][b];let u=n.hashUtilsCls.cloneHash(i);u.source+=x+s.chainsMapping[a][d],u.target+=x+s.chainsMapping[o][b],_[c]!=p.length||!l&&0!=S[c]?C[g].push(u):m[g].push(h),f[g][i.source]=s.chainsMapping[a][d],f[g][i.target]=s.chainsMapping[o][b],v[g][i.source]=s.chainsMapping[a][d],v[g][i.target]=s.chainsMapping[o][b]}else{let e=n.hashUtilsCls.cloneHash(i);e.source+=s.chainsMapping[a]&&s.chainsMapping[a][d]?x+s.chainsMapping[a][d]:x+M,e.target+=s.chainsMapping[o]&&s.chainsMapping[o][b]?x+s.chainsMapping[o][b]:x+M,C[g].push(e),f[g][i.source]=s.chainsMapping[a]&&s.chainsMapping[a][d]?s.chainsMapping[a][d]:A,f[g][i.target]=s.chainsMapping[o]&&s.chainsMapping[o][b]?s.chainsMapping[o][b]:A,v[g][i.source]=s.chainsMapping[a]&&s.chainsMapping[a][d]?s.chainsMapping[a][d]:M,v[g][i.target]=s.chainsMapping[o]&&s.chainsMapping[o][b]?s.chainsMapping[o][b]:M}}}let T=[],E=[],R=0,k=[],O=1;for(let e=0,t=p.length;e<t;++e){let t=s.getGraphCls.getNodeTopBottom(c[e],d);r[e]=t.nodeArray1,o[e]=t.nodeArray2,Object.keys(s.chainsMapping).length>0&&(O=1,t=s.getGraphCls.getNodeTopBottom(c[e],d,void 0,O,f[e]),h[e]=t.nodeArray1,u[e]=t.nodeArray2,d=n.hashUtilsCls.unionHash(d,t.name2node),O=2,t=s.getGraphCls.getNodeTopBottom(c[e],d,void 0,O,v[e]),g[e]=t.nodeArray1,b[e]=t.nodeArray2,d=n.hashUtilsCls.unionHash(d,t.name2node)),T[e]=r[e].length,E[e]=o[e].length,R=Math.max(R,E[e]),k.push(p[e])}let I,P,D,L,F,N=1,U=3*N,H=7*N,B=10,z=10,q=30,j=20;t?(D=(n.utilsCls.sumArray(T)+2*k.length)*(U+H)+4*z+2*q+j*k.length,P=(R+2)*(U+H)+2*B+q):(I=110+j,D=I*k.length,P=(R+2)*(U+H)+2*B,P+=20),Object.keys(s.chainsMapping).length>0&&(D*=3),t?(s.scatterplotWidth=2*P,F=s.scatterplotWidth,L=n.scatterplotid):(s.linegraphWidth=2*P,F=s.linegraphWidth,L=n.linegraphid),i=0==k.length?"No interactions found for each structure<br><br>":"2D integration graph for "+k.length+" structure(s) <b>"+k+'</b>. There are three sections: "Interactions", "Common interactions", and "Different interactions". Each section has '+k.length+" graphs.<br><br>",i+="<svg id='"+L+"' viewBox='0,0,"+P+","+D+"' width='"+F+"px'>";let G,$=0;O=0,G=this.drawGraphPerType(O,p,t,r,o,l,d,$,I,j,T,U,H,z),$=G.heightFinal,i+=G.html,Object.keys(s.chainsMapping).length>0&&(O=1,G=this.drawGraphPerType(O,p,t,h,u,m,d,$,I,j,T,U,H,z),$=G.heightFinal,i+=G.html,O=2,G=this.drawGraphPerType(O,p,t,g,b,C,d,$,I,j,T,U,H,z),$=G.heightFinal,i+=G.html),i+="</svg>"}else if(t){let e,t,r,c,h=p[0],u=1,m=3*u,f=7*u,g=30;t=(o.length+2)*(m+f)+2*10+g,e=(l.length+2)*(m+f)+2*10+g,s.scatterplotWidth=2*e,c=s.scatterplotWidth,r=n.scatterplotid,i=a.length>0?"":"No interactions found for these two sets<br><br>",i+="<svg id='"+r+"' viewBox='0,0,"+e+","+t+"' width='"+c+"px'>",i+=this.drawScatterplot_base(o,l,a,d,0),s.lineGraphStr+=s.getGraphCls.updateGraphJson(h,1,o,l,a),i+="</svg>"}else{let e=p[0],t=o.length,r=l.length,c=1,h=3*c,u=7*c,m=110,f=10,g=t>r?t*(h+u)+2*f:r*(h+u)+2*f;s.linegraphWidth=2*g,i=a.length>0?"":"No interactions found for these two sets<br><br>",i+="<svg id='"+n.linegraphid+"' viewBox='0,0,"+g+","+m+"' width='"+s.linegraphWidth+"px'>",i+=this.drawLineGraph_base(o,l,a,d,0),s.lineGraphStr+=s.getGraphCls.updateGraphJson(e,1,o,l,a),i+="</svg>"}return s.lineGraphStr+="}\n",s.scatterplotStr=s.lineGraphStr,t?$("#"+s.pre+"scatterplotDiv").html(i):$("#"+s.pre+"linegraphDiv").html(i),i}drawGraphPerType(e,t,i,s,n,r,a,o,l,d,c,h,p,u){let m=this.icn3d;m.icn3dui;let f,g,b="",C=2==t.length&&"2"==t[1].replace(t[0],"");0==e?(f="Interactions in ",g=""):1==e?(f="Common interactions in ",g="_common"):2==e&&(f="Different interactions in ",g="_diff");for(let v=0,_=t.length;v<_;++v){let _=f;C&&(0==v?_+="Wild Type ":1==v&&(_+="Mutant ")),i?(b+=this.drawScatterplot_base(s[v],n[v],r[v],a,o,void 0,_+t[v],d),l=(c[v]+1)*(h+p)+2*u+d):b+=this.drawLineGraph_base(s[v],n[v],r[v],a,o,_+t[v],d),o+=l,e?v>0&&(m.lineGraphStr+=", \n"):m.lineGraphStr+=", \n",m.lineGraphStr+=m.getGraphCls.updateGraphJson(t[v],v+g,s[v],n[v],r[v])}return{heightFinal:o,html:b}}getIdArrayFromNode(e){let t=this.icn3d.icn3dui,i=[];i.push(""),i.push("");let s=e.r.substr(4);return i=i.concat(t.utilsCls.getIdArray(s)),i}drawLineGraph_base(e,t,i,s,n,r,a){let o,l,d=this.icn3d,c=d.icn3dui,h="",p=e.length,u=t.length;p>u?(o=10,l=10*Math.abs(p-u)*.5+10):(l=10,o=10*Math.abs(p-u)*.5+10),r&&(h+="<text x='10' y='"+(n+=a)+"' style='font-size:8px; font-weight:bold'>"+r+"</text>");let m=30+n,f=80+n,g="",b={},C={};for(let t=0;t<p;++t)g+=d.getGraphCls.drawResNode(e[t],t,3,7,o,m,"a"),b[e[t].id]={x:o+10*t,y:m};for(let e=0;e<u;++e)g+=d.getGraphCls.drawResNode(t[e],e,3,7,l,f,"b"),C[t[e].id]={x:l+10*e,y:f};for(let e=0,t=i.length;e<t;++e){let t=i[e],n=s[t.source],r=s[t.target];if(void 0===n||void 0===r)continue;let a,o=n.r.substr(4),l=r.r.substr(4),d=b[n.id],p=C[r.id];if(void 0===d||void 0===p)continue;a=t.v==c.htmlCls.contactValue?1:1==t.n?2:4;let u=this.getStrokecolor(t.v);h+="<g class='icn3d-interaction' resid1='"+o+"' resid2='"+l+"' >";let m=1==t.n?"Interaction":t.n+" interactions";t.n>1&&(h+="<title>"+m+" of residue "+n.id+" with residue "+r.id+"</title>"),h+="<line x1='"+d.x+"' y1='"+d.y+"' x2='"+p.x+"' y2='"+p.y+"' stroke='"+u+"' stroke-width='"+a+"'/></g>"}return h+=g,h}drawScatterplot_base(e,t,i,s,n,r,a,o,l){let d=this.icn3d;d.icn3dui;let c="",h=e.length,p=t.length,u=r?3:7,m=(h+1)*(3+u)+30+40;a&&(c+="<text x='10' y='"+((n+=o)+15).toString()+"' style='font-size:8px; font-weight:bold'>"+a+"</text>");let f=n+m-(50+(3+u)),g=40+(3+u),b="",C={},v={};for(let t=0;t<h;++t)b+=d.getGraphCls.drawResNode(e[t],t,3,u,f,40,"a",!0,void 0,l),C[e[t].id]={x:40,y:f-t*(3+u)};let _=n+m-50;for(let e=0;e<p;++e)b+=d.getGraphCls.drawResNode(t[e],e,3,u,g,_,"b",!1,r,l),v[t[e].id]={x:g+e*(3+u),y:_};for(let e=0,t=i.length;e<t;++e){let t=i[e],n=s[t.source],a=s[t.target];n&&a&&(c+=this.drawOnePairNode(t,n,a,C,v,r,l),r&&!l&&(c+=this.drawOnePairNode(t,a,n,C,v,r,l)))}return c+=b,c}getStrokecolor(e,t){let i=this.icn3d.icn3dui,s="#000";return e&&(e==i.htmlCls.hbondValue?s="#"+i.htmlCls.hbondColor:e==i.htmlCls.ionicValue?s="#"+i.htmlCls.ionicColor:e==i.htmlCls.halogenValue?s="#"+i.htmlCls.halogenColor:e==i.htmlCls.picationValue?s="#"+i.htmlCls.picationColor:e==i.htmlCls.pistackingValue?s="#"+i.htmlCls.pistackingColor:e==i.htmlCls.contactValue&&(s="#"+i.htmlCls.contactColor)),t&&("hbond"==t?s="#"+i.htmlCls.hbondColor:"ionic"==t?s="#"+i.htmlCls.ionicColor:"halogen"==t?s="#"+i.htmlCls.halogenColor:"pi-cation"==t?s="#"+i.htmlCls.picationColor:"pi-stacking"==t?s="#"+i.htmlCls.pistackingColor:"contact"==t&&(s="#"+i.htmlCls.contactColor)),s}drawOnePairNode(e,t,i,s,n,r,a){let o=this.icn3d,l=o.icn3dui,d="",c=r?6:4.5,h=.5*c,p=t.r.substr(4),u=i.r.substr(4),m=s[t.id],f=n[i.id];if(void 0===m||void 0===f)return d;let g,b=this.getStrokecolor(e.v);if(r&&(b="#"+e.c),g=e.v==l.htmlCls.contactValue?1:1==e.n?2:4,a&&o.hex2skip[e.c]);else if(a&&o.hex2id[e.c])o.hex2id[e.c],d+="<rect class='icn3d-interaction' resid1='"+p+"' resid2='"+u+"' x='"+(f.x-h).toString()+"' y='"+(m.y-h).toString()+"' width='"+c+"' height='"+c+"' fill='"+b+"' stroke-width='"+g+"' stroke='"+b+"' />";else{d+="<g class='icn3d-interaction' resid1='"+p+"' resid2='"+u+"' >";let s=1==e.n?"Interaction":e.n+" interactions";e.n>1&&(d+="<title>"+s+" of residue "+t.id+" with residue "+i.id+"</title>"),d+=r?"<rect x='"+(f.x-h).toString()+"' y='"+(m.y-h).toString()+"' width='"+c+"' height='"+c+"' fill='"+b+"' stroke-width='"+g+"' stroke='"+b+"' />":"<rect x='"+(f.x-h).toString()+"' y='"+(m.y-h).toString()+"' width='"+c+"' height='"+c+"' fill='"+b+"' fill-opacity='0.6' stroke-width='"+g+"' stroke='"+b+"' />",d+="</g>"}return d}copyStylesInline(e,t){this.icn3d.icn3dui;let i=["svg","g"];for(let s=0;s<e.childNodes.length;s++){let n=e.childNodes[s];if(-1!=i.indexOf(n.tagName)){this.copyStylesInline(n,t.childNodes[s]);continue}let r=t.childNodes[s].currentStyle||window.getComputedStyle(t.childNodes[s]);if("undefined"!=r&&null!=r)for(let e=0;e<r.length;e++)n.style.setProperty(r[e],r.getPropertyValue(r[e]))}}}class vh{constructor(e){this.icn3d=e}getGraphData(e,t,i,s,n,r,a){let o=this.icn3d,l=o.icn3dui,d="",c="",h=[],p=[],u=this.getNodesLinksForSet(e,r,"a",a),m=this.getNodesLinksForSet(t,r,"b",a);h=u.node.concat(m.node);let f=[],g={},b=0;for(let e=0,t=h.length;e<t;++e){let t=h[e],i=JSON.parse(t);if(g.hasOwnProperty(i.id)){f[g[i.id]].s="ab"}else f.push(i),g[i.id]=b,++b}let C=[];for(let e=0,t=f.length;e<t;++e){let t=f[e];C.push(JSON.stringify(t))}d=C.join(", "),p=u.link.concat(m.link),c=p.join(", ");let v=l.hashUtilsCls.unionHash(l.hashUtilsCls.cloneHash(t),e),_="",y="",S="",w="",x="",A="";1==i.length&&1==s.length&&i[0]==s[0]||(_+=this.getHbondLinksForSet(e,r),_+=this.getHbondLinksForSet(t,r)),1==i.length&&1==s.length&&i[0]==s[0]||(y+=this.getIonicLinksForSet(e,r),y+=this.getIonicLinksForSet(t,r)),1==i.length&&1==s.length&&i[0]==s[0]||(S+=this.getHalogenPiLinksForSet(e,r),S+=this.getHalogenPiLinksForSet(t,r)),1==i.length&&1==s.length&&i[0]==s[0]||(w+=this.getContactLinksForSet(e,r),w+=this.getContactLinksForSet(t,r));for(let e in o.ssbondpnts)for(let t=0,i=o.ssbondpnts[e].length;t<i;t+=2){let i=o.ssbondpnts[e][t],s=o.ssbondpnts[e][t+1],n=o.firstAtomObjCls.getFirstAtomObj(o.residues[i]),a=o.firstAtomObjCls.getFirstAtomObj(o.residues[s]);if(v.hasOwnProperty(n.serial)&&v.hasOwnProperty(a.serial)){let e=l.utilsCls.residueName2Abbr(n.resn)+n.resi;"chain"!=r&&"structure"!=r||(e+="."+n.chain),"structure"==r&&(e+="."+n.structure);let t=l.utilsCls.residueName2Abbr(a.resn)+a.resi;"chain"!=r&&"structure"!=r||(t+="."+a.chain),"structure"==r&&(t+="."+a.structure),x+=', {"source": "'+e+'", "target": "'+t+'", "v": '+l.htmlCls.ssbondValue+', "c": "'+l.htmlCls.ssbondColor+'"}'}}for(let e in o.clbondpnts)for(let t=0,i=o.clbondpnts[e].length;t<i;t+=2){let i=o.clbondpnts[e][t],s=o.clbondpnts[e][t+1],n=o.firstAtomObjCls.getFirstAtomObj(o.residues[i]),a=o.firstAtomObjCls.getFirstAtomObj(o.residues[s]);if(v.hasOwnProperty(n.serial)&&v.hasOwnProperty(a.serial)){let e=l.utilsCls.residueName2Abbr(n.resn)+n.resi;"chain"!=r&&"structure"!=r||(e+="."+n.chain),"structure"==r&&(e+="."+n.structure);let t=l.utilsCls.residueName2Abbr(a.resn)+a.resi;"chain"!=r&&"structure"!=r||(t+="."+a.chain),"structure"==r&&(t+="."+a.structure),A+=', {"source": "'+e+'", "target": "'+t+'", "v": '+l.htmlCls.clbondValue+', "c": "'+l.htmlCls.clbondColor+'"}'}}let M='{"nodes": ['+d+'], "links": [';return M+=""==c?c+n.substr(1)+x+A+w+_+y+S:c+n+x+A+w+_+y+S,M+="]}",M}drawResNode(e,t,i,s,n,r,a,o,l,d){let c=this.icn3d;c.icn3dui;let h,p=e.r.substr(4);h=o?n-t*(i+s):n+t*(i+s),c.firstAtomObjCls.getFirstAtomObj(c.residues[p]);let u="#"+e.c.toUpperCase();c.hColor.getHexString().toUpperCase();let m=e.id.indexOf("."),f=-1==m?e.id:e.id.substr(0,m),g="a"==a?-7:10;if(t%2==1&&(g="a"==a?g-7:g+7),l&&(f=f.substr(1),o||(g+=4*i)),c.bShownRefnum&&c.resid2refnum[p]){let e=c.resid2refnum[p],t=c.refnumCls.rmStrandFromRefnumlabel(e);f=c.residueId2Name[p]+t}let b="#000",C="#000",v="<g class='icn3d-node' resid='"+p+"' >",_=e.id;return c.resid2refnum[p]&&(_+="=>"+c.resid2refnum[p]),v+="<title>"+_+"</title>",o?(v+="<circle cx='"+r+"' cy='"+h+"' r='"+i+"' fill='"+u+"' stroke-width='1' stroke='"+b+"' resid='"+p+"' />",v+="<text x='"+(r-20).toString()+"' y='"+(h+2).toString()+"' fill='"+C+"' stroke='none' style='font-size:6px; text-anchor:middle' >"+f+"</text>"):(v+="<circle cx='"+h+"' cy='"+r+"' r='"+i+"' fill='"+u+"' stroke-width='1' stroke='"+b+"' resid='"+p+"' />",v+="<text x='"+(h+0).toString()+"' y='"+(r+g).toString()+"' fill='"+C+"' stroke='none' style='font-size:6px; text-anchor:middle' >"+f+"</text>"),v+="</g>",v}getNodeTopBottom(e,t,i,s,n){let r=this.icn3d.icn3dui,a=this,o=[],l=[],d={};for(let i in e){let e=t[i];if(e){if(1==s||2==s){if(e=r.hashUtilsCls.cloneHash(e),1==s){let t=n[i]?n[i]:"-";e.id+="=>"+t}else{let t=n[i]?n[i]:"--";e.id+="==>"+t}d[e.id]=e}"a"==e.s?o.push(e):"b"==e.s?l.push(e):"ab"==e.s&&(o.push(e),l.push(e))}}return o.sort((function(e,t){return a.compNode(e,t)})),l.sort((function(e,t){return a.compNode(e,t,i)})),{nodeArray1:o,nodeArray2:l,name2node:d}}updateGraphJson(e,t,i,s,n){let r=this.icn3d.icn3dui,a="";return a+='"structure'+t+'": {"id": "'+e+'", "nodes1":[',a+=r.utilsCls.getJSONFromArray(i),a+='], \n"nodes2":[',a+=r.utilsCls.getJSONFromArray(s),a+='], \n"links":[',a+=r.utilsCls.getJSONFromArray(n),a+="]}",a}updateGraphColor(){this.icn3d.icn3dui}handleForce(){let e=this.icn3d;0==e.icn3dui.htmlCls.force&&void 0!==e.simulation?(e.simulation.stop(),e.simulation.force("charge",null),e.simulation.force("x",null),e.simulation.force("y",null),e.simulation.force("r",null),e.simulation.force("link",null)):e.drawGraphCls.drawGraph(e.graphStr,e.pre+"dl_graph")}getNodesLinksForSet(e,t,i,s){let n=this.icn3d,r=n.icn3dui,a=[],o=[],l=0,d=r.htmlCls.coilValue,c="",h="",p=0,u={};for(let m in e){let e=n.atoms[m];if("DUM"!=e.chain&&(s||e.het||"CA"==e.name&&"C"==e.elem||"O3'"==e.name||"O3*"==e.name||"P"==e.name)){let s=e.structure+"_"+e.chain+"_"+e.resi;if(u.hasOwnProperty(s))continue;u[s]=1;let m=r.utilsCls.residueName2Abbr(e.resn)+e.resi;"chain"!=t&&"structure"!=t||(m+="."+e.chain),"structure"==t&&(m+="."+e.structure);let f="1_1_"+s,g=e.color?e.color.getHexString().toUpperCase():"000";a.push('{"id": "'+m+'", "r": "'+f+'", "s": "'+i+'", "x": '+e.coord.x.toFixed(0)+', "y": '+e.coord.y.toFixed(0)+', "c": "'+g+'"}'),l>0&&c==e.chain&&(n.resid2ncbi[e.resi]==n.resid2ncbi[p]+1||n.resid2ncbi[e.resi]==n.resid2ncbi[p])&&(o.push('{"source": "'+h+'", "target": "'+m+'", "v": '+d+', "c": "'+g+'"}'),e.ssbegin&&(d=r.htmlCls.ssValue),e.ssend&&(d=r.htmlCls.coilValue)),c=e.chain,h=m,p=e.resi,++l}}return{node:a,link:o}}getHbondLinksForSet(e,t){let i=this.icn3d,s=i.icn3dui,n={},r=parseFloat($("#"+i.pre+"hbondthreshold").val()),a=e,o=a;if(Object.keys(o).length>0&&Object.keys(a).length>0){let e=!1;i.hBondCls.calculateChemicalHbonds(s.hashUtilsCls.hash2Atoms(o,i.atoms),s.hashUtilsCls.hash2Atoms(a,i.atoms),parseFloat(r),e,"graph",!0),n=s.hashUtilsCls.cloneHash(i.resid2Residhash)}return this.getGraphLinks(n,n,s.htmlCls.hbondInsideColor,t,s.htmlCls.hbondInsideValue)}getIonicLinksForSet(e,t){let i=this.icn3d,s=i.icn3dui,n={},r=parseFloat($("#"+i.pre+"saltbridgethreshold").val()),a=e,o=a;if(Object.keys(o).length>0&&Object.keys(a).length>0){let e=!1;i.saltbridgeCls.calculateIonicInteractions(s.hashUtilsCls.hash2Atoms(o,i.atoms),s.hashUtilsCls.hash2Atoms(a,i.atoms),parseFloat(r),e,"graph",!0),n=s.hashUtilsCls.cloneHash(i.resid2Residhash)}return this.getGraphLinks(n,n,s.htmlCls.ionicInsideColor,t,s.htmlCls.ionicInsideValue)}getHalogenPiLinksForSet(e,t){let i,s=this.icn3d,n=s.icn3dui,r={},a=e,o=a,l="";return i=parseFloat($("#"+s.pre+"halogenthreshold").val()),Object.keys(o).length>0&&Object.keys(a).length>0&&(s.piHalogenCls.calculateHalogenPiInteractions(n.hashUtilsCls.hash2Atoms(a,s.atoms),n.hashUtilsCls.hash2Atoms(o,s.atoms),parseFloat(i),"graph","halogen",!0),r=n.hashUtilsCls.cloneHash(s.resid2Residhash)),l+=this.getGraphLinks(r,r,n.htmlCls.halogenInsideColor,t,n.htmlCls.halogenInsideValue),i=parseFloat($("#"+s.pre+"picationthreshold").val()),Object.keys(o).length>0&&Object.keys(a).length>0&&(s.piHalogenCls.calculateHalogenPiInteractions(n.hashUtilsCls.hash2Atoms(a,s.atoms),n.hashUtilsCls.hash2Atoms(o,s.atoms),parseFloat(i),"graph","pi-cation",!0),r=n.hashUtilsCls.cloneHash(s.resid2Residhash)),l+=this.getGraphLinks(r,r,n.htmlCls.picationInsideColor,t,n.htmlCls.picationInsideValue),i=parseFloat($("#"+s.pre+"pistackingthreshold").val()),Object.keys(o).length>0&&Object.keys(a).length>0&&(s.piHalogenCls.calculateHalogenPiInteractions(n.hashUtilsCls.hash2Atoms(a,s.atoms),n.hashUtilsCls.hash2Atoms(o,s.atoms),parseFloat(i),"graph","pi-stacking",!0),r=n.hashUtilsCls.cloneHash(s.resid2Residhash)),l+=this.getGraphLinks(r,r,n.htmlCls.pistackingInsideColor,t,n.htmlCls.pistackingInsideValue),l}getContactLinksForSet(e,t,i){let s=this.icn3d;s.icn3dui;let n=[],r="",a="",o={};for(let t in e){let e=s.atoms[t];e.ss==r&&e.chain==a||(Object.keys(o).length>0&&n.push(o),o={}),o[e.serial]=1,r=e.ss,a=e.chain}Object.keys(o).length>0&&n.push(o);let l=n.length,d="";for(let e=0;e<l;++e)for(let s=e+1;s<l;++s)d+=this.getContactLinks(n[e],n[s],t,!0,i);return d}getContactLinks(e,t,i,s,n){let r=this.icn3d,a=r.icn3dui,o=parseFloat($("#"+r.pre+"contactthreshold").val());r.contactCls.getAtomsWithinAtom(t,e,parseFloat(o),!0,!1,s);let l=a.hashUtilsCls.cloneHash(r.resid2Residhash);return this.getGraphLinks(l,l,a.htmlCls.contactInsideColor,i,a.htmlCls.contactInsideValue,n)}compNode(e,t,i){let s=this.icn3d.icn3dui,n=e.r.substr(4),r=t.r.substr(4),a=s.utilsCls.getIdArray(n),o=s.utilsCls.getIdArray(r),l=a[0]+"_"+a[1],d=o[0]+"_"+o[1],c=parseInt(a[2]),h=parseInt(o[2]);return l>d?i?-1:1:l<d?i?1:-1:l==d?c>h?1:c<h?-1:0:void 0}getGraphLinks(e,t,i,s,n,r){var a=this.icn3d,o=a.icn3dui;let l="";n=void 0===n?1:n;let d={};for(let l in e){let e=l.trim(),c=e.split(" ");3==c.length&&(l=c[0]+" "+c[1]);let h=l.indexOf(" "),p=l.indexOf(":"),u=l.indexOf("@"),m=-1!==u?u:l.length,f=l.indexOf("."),g=l.indexOf("$"),b=o.utilsCls.residueName2Abbr(l.substr(0,h))+l.substr(p+1,m-p-1);"chain"!=s&&"structure"!=s||(b+="."+l.substr(f+1,p-f-1)),"structure"==s&&(b+="."+l.substr(g+1,f-g-1));for(let l in t[e]){let e=l.trim().split(" ");3==e.length&&(l=e[0]+" "+e[1]);let t=l.indexOf(" "),c=l.indexOf(":"),h=l.indexOf("@"),p=-1!==h?h:l.length,u=l.indexOf("."),m=l.indexOf("$"),f=o.utilsCls.residueName2Abbr(l.substr(0,t))+l.substr(c+1,p-c-1);if(l.substr(u+1,c-u-1),"chain"!=s&&"structure"!=s||(f+="."+l.substr(u+1,c-u-1)),"structure"==s&&(f+="."+l.substr(m+1,u-m-1)),r&&(b=a.resi2resirange[b],f=a.resi2resirange[f]),void 0!==b&&void 0!==f){let e='"source": "'+b+'", "target": "'+f+'", "v": '+n+', "c": "'+i+'"';d.hasOwnProperty(e)?++d[e]:d[e]=1}}}for(let e in d){l+=", {"+e+', "n": '+(n==o.htmlCls.contactInsideValue||n==o.htmlCls.contactValue?1:d[e])+"}"}return l}convertLabel2Resid(e){this.icn3d.icn3dui;let t=e.split(" ");(e=2==t.length?e:e.substr(0,e.lastIndexOf(" "))).indexOf(" ");let i=e.indexOf("@"),s=-1!==i?i:e.length,n=e.indexOf("$"),r=e.indexOf("."),a=e.indexOf(":");return e.substr(n+1,r-n-1)+"_"+e.substr(r+1,a-r-1)+"_"+e.substr(a+1,s-a-1)}}class _h{constructor(e){this.icn3d=e}async showInteractions(e){let t,i,s=this.icn3d,n=s.icn3dui,r=$("#"+s.pre+"atomsCustomHbond").val(),a=$("#"+s.pre+"atomsCustomHbond2").val();if(t=s.definedSetsCls.getAtomsFromNameArray(r),i=s.definedSetsCls.getAtomsFromNameArray(a),s.dAtoms=n.hashUtilsCls.unionHash(s.dAtoms,t),s.dAtoms=n.hashUtilsCls.unionHash(s.dAtoms,i),"ligplot"==e){let e=s.firstAtomObjCls.getResiduesFromAtoms(t),n=s.firstAtomObjCls.getResiduesFromAtoms(i);if(Object.keys(e).length>1&&Object.keys(n).length>1)return void alert("Please select one ligand or residue as one of the interaction sets...");Object.keys(e).length<Object.keys(n).length&&(a=$("#"+s.pre+"atomsCustomHbond").val(),r=$("#"+s.pre+"atomsCustomHbond2").val(),t=s.definedSetsCls.getAtomsFromNameArray(r),i=s.definedSetsCls.getAtomsFromNameArray(a))}if(0==a.length)alert("Please select the first set");else{s.definedSetsCls.setMode("selection");let t=$("#"+s.pre+"analysis_hbond")[0].checked,i=$("#"+s.pre+"analysis_saltbridge")[0].checked,o=$("#"+s.pre+"analysis_contact")[0].checked,l=$("#"+s.pre+"analysis_halogen")[0].checked,d=$("#"+s.pre+"analysis_pication")[0].checked,c=$("#"+s.pre+"analysis_pistacking")[0].checked,h="threshold "+$("#"+s.pre+"hbondthreshold").val()+" "+$("#"+s.pre+"saltbridgethreshold").val()+" "+$("#"+s.pre+"contactthreshold").val()+" "+$("#"+s.pre+"halogenthreshold").val()+" "+$("#"+s.pre+"picationthreshold").val()+" "+$("#"+s.pre+"pistackingthreshold").val(),p=(await s.viewInterPairsCls.viewInteractionPairs(a,r,s.bHbondCalc,e,t,i,o,l,d,c)).interactionTypes,u=s.bHbondCalc?"true":"false",m=a+" "+r+" | "+p+" | "+u+" | "+h;if("3d"==e)n.htmlCls.clickMenuCls.setLogCmd("display interaction 3d | "+m,!0);else if("view"==e)n.htmlCls.clickMenuCls.setLogCmd("view interaction pairs | "+m,!0);else if("save1"==e)n.htmlCls.clickMenuCls.setLogCmd("save1 interaction pairs | "+m,!0);else if("save2"==e)n.htmlCls.clickMenuCls.setLogCmd("save2 interaction pairs | "+m,!0);else if("linegraph"==e)n.htmlCls.clickMenuCls.setLogCmd("line graph interaction pairs | "+m,!0);else if("scatterplot"==e)n.htmlCls.clickMenuCls.setLogCmd("scatterplot interaction pairs | "+m,!0);else if("ligplot"==e)n.htmlCls.clickMenuCls.setLogCmd("ligplot interaction pairs | "+m,!0);else if("graph"==e){let e=parseInt($("#"+s.pre+"dist_ss").val()),t=parseInt($("#"+s.pre+"dist_coil").val()),i=parseInt($("#"+s.pre+"dist_hbond").val()),o=parseInt($("#"+s.pre+"dist_inter").val()),l=parseInt($("#"+s.pre+"dist_ssbond").val()),d=parseInt($("#"+s.pre+"dist_ionic").val()),c=parseInt($("#"+s.pre+"dist_halogen").val()),m=parseInt($("#"+s.pre+"dist_pication").val()),f=parseInt($("#"+s.pre+"dist_pistacking").val());n.htmlCls.clickMenuCls.setLogCmd("graph interaction pairs | "+a+" "+r+" | "+p+" | "+u+" | "+h+" | "+e+" "+t+" "+i+" "+o+" "+l+" "+d+" "+c+" "+m+" "+f,!0)}s.bHbondCalc=!0}}showHbonds(e,t,i,s,n,r){let a,o,l,d,c=this.icn3d,h=c.icn3dui;if(!s&&(n?(a="saltbridge",o="salt bridge "+e+" | sets "+t+" "+i+" | "+s):(a="hbonds",o="hbonds "+e+" | sets "+t+" "+i+" | "+s),c.opts[a]="yes",c.opts.water="dot",l=c.definedSetsCls.getAtomsFromNameArray(t),d=c.definedSetsCls.getAtomsFromNameArray(i),Object.keys(d).length>0&&Object.keys(l).length>0)){let t,i=c.hBondCls.calculateChemicalHbonds(h.hashUtilsCls.hash2Atoms(d,c.atoms),h.hashUtilsCls.hash2Atoms(l,c.atoms),parseFloat(e),n);n?(c.resid2ResidhashSaltbridge=h.hashUtilsCls.cloneHash(c.resid2Residhash),t="all atoms that have salt bridges with the selected atoms"):(c.resid2ResidhashHbond=h.hashUtilsCls.cloneHash(c.resid2Residhash),t="all atoms that are hydrogen-bonded with the selected atoms");let s={};for(let e in i){s[c.atoms[e].structure+"_"+c.atoms[e].chain+"_"+c.atoms[e].resi]=1}c.hAtoms={};for(let e in s)for(let t in c.residues[e])c.hAtoms[t]=1,c.atoms[t].style2="stick";let r=a+"_auto";c.selectionCls.addCustomSelection(Object.keys(s),r,t,o,!0),c.selectionCls.saveSelectionIfSelected(),c.drawCls.draw()}}showHydrogens(){let e=this.icn3d;if(void 0!==e.icn3dui.cfg.cid)for(let t in e.hAtoms){let i=e.atoms[t];if("H"!==i.elem.substr(0,1)){e.atoms[i.serial].bonds=e.atoms[i.serial].bonds2.concat(),e.atoms[i.serial].bondOrder=e.atoms[i.serial].bondOrder2.concat();for(let t=0,s=e.atoms[i.serial].bonds.length;t<s;++t){let s=e.atoms[i.serial].bonds[t];"H"===e.atoms[s].elem.substr(0,1)&&(e.dAtoms[s]=1,e.hAtoms[s]=1)}}}else for(let t in e.atoms){let i=e.atoms[t];if("H"===i.elem.substr(0,1)){if(e.atoms[t].bonds.length>0){let s=e.atoms[t].bonds[0];e.atoms[s].bonds.push(i.serial),e.atoms[s].bondOrder&&e.atoms[s].bondOrder.push(1)}e.dAtoms[t]=1}}
//!!!ic.bShowHighlight = false;
}hideHydrogens(){let e=this.icn3d;e.icn3dui;for(let t in e.hAtoms){let i=e.atoms[t];if("H"===i.elem.substr(0,1)){if(e.atoms[i.serial].bonds.length>0){let t=e.atoms[i.serial].bonds[0],s=e.atoms[t].bonds?e.atoms[t].bonds.indexOf(i.serial):-1;-1!==s&&(e.atoms[t].bonds.splice(s,1),e.atoms[t].bondOrder&&e.atoms[t].bondOrder.splice(s,1))}delete e.dAtoms[i.serial],delete e.hAtoms[i.serial]}}}hideExtraBonds(){let e=this.icn3d;e.icn3dui;for(let t in e.atoms)e.atoms[t].style2="nothing";for(let t in e.sidec)e.hAtoms.hasOwnProperty(t)&&(e.atoms[t].style2=e.opts.sidec);for(let t in e.water)e.hAtoms.hasOwnProperty(t)&&(e.atoms[t].style=e.opts.water)}hideHbondsContacts(){let e=this.icn3d,t=e.icn3dui,i="set hbonds off";t.htmlCls.clickMenuCls.setLogCmd(i,!0),e.hBondCls.hideHbonds(),i="set salt bridge off",t.htmlCls.clickMenuCls.setLogCmd(i,!0),e.saltbridgeCls.hideSaltbridge(),i="set contact off",t.htmlCls.clickMenuCls.setLogCmd(i,!0),e.contactCls.hideContact(),i="set halogen pi off",t.htmlCls.clickMenuCls.setLogCmd(i,!0),e.piHalogenCls.hideHalogenPi(),this.hideExtraBonds()}showIonicInteractions(e,t,i,s,n,r){let a,o,l,d,c=this.icn3d,h=c.icn3dui;if(!s&&(a="saltbridge",o="salt bridge "+e+" | sets "+t+" "+i+" | "+s,c.opts[a]="yes",l=c.definedSetsCls.getAtomsFromNameArray(t),d=c.definedSetsCls.getAtomsFromNameArray(i),c.firstAtomObjCls.getFirstAtomObj(l),Object.keys(d).length>0&&Object.keys(l).length>0)){let t,i=c.saltbridgeCls.calculateIonicInteractions(h.hashUtilsCls.hash2Atoms(d,c.atoms),h.hashUtilsCls.hash2Atoms(l,c.atoms),parseFloat(e),n);c.resid2ResidhashSaltbridge=h.hashUtilsCls.cloneHash(c.resid2Residhash),t="all atoms that have ionic interactions with the selected atoms";let s={};for(let e in i){s[c.atoms[e].structure+"_"+c.atoms[e].chain+"_"+c.atoms[e].resi]=1}c.hAtoms={};for(let e in s)for(let t in c.residues[e])c.hAtoms[t]=1,c.atoms[t].style2="stick",c.ions.hasOwnProperty(t)&&(c.atoms[t].style2="sphere");let r=a+"_auto";c.selectionCls.addCustomSelection(Object.keys(s),r,t,o,!0),c.selectionCls.saveSelectionIfSelected(),c.drawCls.draw()}}showHalogenPi(e,t,i,s,n,r){let a=this.icn3d,o=a.icn3dui;if(s)return;let l,d,c=r+" "+e+" | sets "+t+" "+i+" | "+s;if(a.opts[r]="yes",l=a.definedSetsCls.getAtomsFromNameArray(t),d=a.definedSetsCls.getAtomsFromNameArray(i),a.firstAtomObjCls.getFirstAtomObj(l),Object.keys(d).length>0&&Object.keys(l).length>0){let t,i=a.piHalogenCls.calculateHalogenPiInteractions(o.hashUtilsCls.hash2Atoms(l,a.atoms),o.hashUtilsCls.hash2Atoms(d,a.atoms),parseFloat(e),n,r);"halogen"==r?(a.resid2ResidhashHalogen=o.hashUtilsCls.cloneHash(a.resid2Residhash),t="all atoms that have halogen bonds with the selected atoms"):"pi-cation"==r?(a.resid2ResidhashPication=o.hashUtilsCls.cloneHash(a.resid2Residhash),t="all atoms that have pi-cation interactions with the selected atoms"):"pi-stacking"==r&&(a.resid2ResidhashPistacking=o.hashUtilsCls.cloneHash(a.resid2Residhash),t="all atoms that have pi-stacking with the selected atoms");let s={};for(let e in i){s[a.atoms[e].structure+"_"+a.atoms[e].chain+"_"+a.atoms[e].resi]=1}a.hAtoms={};for(let e in s)for(let t in a.residues[e])a.hAtoms[t]=1,a.atoms[t].style2="stick",a.ions.hasOwnProperty(t)&&(a.atoms[t].style2="sphere");let h=r+"_auto";a.selectionCls.addCustomSelection(Object.keys(s),h,t,c,!0),a.selectionCls.saveSelectionIfSelected(),a.drawCls.draw()}}showClbonds(){let e=this.icn3d,t=e.icn3dui;e.opts.clbonds="yes";let i=e.applyClbondsCls.applyClbondsOptions();for(let s in i)e.hAtoms=t.hashUtilsCls.unionHash(e.hAtoms,e.residues[s]);if(Object.keys(i).length>0){let t="clbonds",s="all atoms that have cross-linkages";e.selectionCls.addCustomSelection(Object.keys(i),t,s,"cross linkage",!0),e.selectionCls.saveSelectionIfSelected(),e.drawCls.draw()}}showSsbonds(){let e=this.icn3d,t=e.icn3dui;e.opts.ssbonds="yes";let i={},s=Object.keys(e.structures);for(let n=0,r=s.length;n<r;++n){let r=s[n];if(void 0!==e.ssbondpnts[r])for(let s=0,n=Math.floor(e.ssbondpnts[r].length/2);s<n;s++){let n=e.ssbondpnts[r][2*s],a=e.ssbondpnts[r][2*s+1];i[n]=1,i[a]=1,e.hAtoms=t.hashUtilsCls.unionHash(e.hAtoms,e.residues[n]),e.hAtoms=t.hashUtilsCls.unionHash(e.hAtoms,e.residues[a])}}if(Object.keys(i).length>0){let t="ssbonds",s="all atoms that have disulfide bonds";e.selectionCls.addCustomSelection(Object.keys(i),t,s,"disulfide bonds",!0),e.selectionCls.saveSelectionIfSelected(),e.drawCls.draw()}}pickCustomSphere(e,t,i,s,n,r){let a=this.icn3d,o=a.icn3dui;if(s)return;let l,d,c="select zone cutoff "+e+" | sets "+t+" "+i+" | "+s;n&&(c="interactions "+e+" | sets "+t+" "+i+" | "+s,a.opts.contact="yes"),l=a.definedSetsCls.getAtomsFromNameArray(t),d=a.definedSetsCls.getAtomsFromNameArray(i);let h,p,u,m=this.pickCustomSphere_base(e,l,d,s,n,r,c,!0),f=Object.keys(m.residues);a.hAtoms={};for(let e=0,t=f.length;e<t;++e){let t=f[e];for(let e in a.residues[t])a.hAtoms[e]=1}let g=a.firstAtomObjCls.getFirstAtomObj(l);void 0!==g&&(h="sphere."+g.chain+":"+o.utilsCls.residueName2Abbr(g.resn.substr(0,3)).trim()+g.resi+"-"+e+"A",u="sphere-"+e+"A",n&&(h="interactions."+g.chain+":"+o.utilsCls.residueName2Abbr(g.resn.substr(0,3)).trim()+g.resi+"-"+$("#"+a.pre+"contactthreshold").val()+"A",u="interactions-"+$("#"+a.pre+"contactthreshold").val()+"A"),p=h,a.selectionCls.addCustomSelection(f,h,p,c,!0),a.selectionCls.addCustomSelection(f,u,p,c,!0)),a.selectionCls.saveSelectionIfSelected(),a.drawCls.draw()}pickCustomSphere_base(e,t,i,s,n,r,a,o,l){let d,c=this.icn3d,h=c.icn3dui;n?(d=c.contactCls.getAtomsWithinAtom(h.hashUtilsCls.hash2Atoms(i,c.atoms),h.hashUtilsCls.hash2Atoms(t,c.atoms),parseFloat(e),o,n,void 0,l),c.resid2ResidhashInteractions=h.hashUtilsCls.cloneHash(c.resid2Residhash)):(d=c.contactCls.getAtomsWithinAtom(i,t,parseFloat(e),o,n),c.resid2ResidhashSphere=h.hashUtilsCls.cloneHash(c.resid2Residhash));let p={};for(let e in d){let t=d[e];c.bOpm&&"DUM"===t.resn||(p[t.structure+"_"+t.chain+"_"+t.resi]=1)}return{residues:p,resid2Residhash:c.resid2Residhash}}}class yh{constructor(e){this.icn3d=e}async viewInteractionPairs(e,t,i,s,n,r,a,o,l,d,c){let h,p=this.icn3d,u=p.icn3dui;i||(p.hbondpnts=[],p.saltbridgepnts=[],p.contactpnts=[],p.halogenpnts=[],p.picationpnts=[],p.pistackingpnts=[]),p.bRender=!1;let m,f={},g=u.hashUtilsCls.cloneHash(p.hAtoms),b="calpha"==s||"cbeta"==s||"heavyatoms"==s,C={},v={};if(b)for(let e in p.hAtoms){let t=p.atoms[e];"HOH"!=t.resn&&"WAT"!=t.resn&&"SOL"!=t.resn&&(("calpha"==s&&(t.het||"CA"==t.name||"O3'"==t.name||"O3*"==t.name)||"cbeta"==s&&(t.het||"CB"==t.name||"O3'"==t.name||"O3*"==t.name)||"heavyatoms"==s&&"H"!=t.elem)&&(C[e]=t,v[e]=t))}else C=p.definedSetsCls.getAtomsFromNameArray(e),v=p.definedSetsCls.getAtomsFromNameArray(t);let _=0,y=0;for(let e in p.structures){for(let t=0,i=p.structures[e].length;t<i;++t){let i=p.structures[e][t];for(let e in p.chains[i])if(C.hasOwnProperty(e)||v.hasOwnProperty(e)){++_;break}}++y}m=y>1?"structure":_>1?"chain":"residue";let S=[];if(n&&S.push("hbonds"),r&&S.push("salt bridge"),a&&S.push("interactions"),o&&S.push("halogen"),l&&S.push("pi-cation"),d&&S.push("pi-stacking"),i||(p.resids2inter={},p.resids2interAll={}),r){let n=parseFloat($("#"+p.pre+"saltbridgethreshold").val());n&&!isNaN(n)||(n=p.tsIonic),i||(p.hAtoms=u.hashUtilsCls.cloneHash(g),p.showInterCls.showIonicInteractions(n,e,t,i,!0,s)),f=u.hashUtilsCls.unionHash(f,p.hAtoms)}if(n){let n=parseFloat($("#"+p.pre+"hbondthreshold").val());n&&!isNaN(n)||(n=p.tsHbond),i||(p.hAtoms=u.hashUtilsCls.cloneHash(g),p.showInterCls.showHbonds(n,e,t,i,void 0,s)),f=u.hashUtilsCls.unionHash(f,p.hAtoms)}let w,x,A,M,T="";if(n&&(T+=this.exportHbondPairs(s,m)),r&&(T+=this.exportSaltbridgePairs(s,m)),o){let n=parseFloat($("#"+p.pre+"halogenthreshold").val());n&&!isNaN(n)||(n=p.tsHalogen),i||(p.hAtoms=u.hashUtilsCls.cloneHash(g),p.showInterCls.showHalogenPi(n,e,t,i,s,"halogen")),f=u.hashUtilsCls.unionHash(f,p.hAtoms),T+=this.exportHalogenPiPairs(s,m,"halogen")}if(l){let n=parseFloat($("#"+p.pre+"picationthreshold").val());n&&!isNaN(n)||(n=p.tsPication),i||(p.hAtoms=u.hashUtilsCls.cloneHash(g),p.showInterCls.showHalogenPi(n,e,t,i,s,"pi-cation")),f=u.hashUtilsCls.unionHash(f,p.hAtoms),T+=this.exportHalogenPiPairs(s,m,"pi-cation")}if(d){let n=parseFloat($("#"+p.pre+"pistackingthreshold").val());n&&!isNaN(n)||(n=p.tsPistacking),i||(p.hAtoms=u.hashUtilsCls.cloneHash(g),p.showInterCls.showHalogenPi(n,e,t,i,s,"pi-stacking")),f=u.hashUtilsCls.unionHash(f,p.hAtoms),T+=this.exportHalogenPiPairs(s,m,"pi-stacking")}if(a){let n=b?c:parseFloat($("#"+p.pre+"contactthreshold").val());if(n&&!isNaN(n)||(n=p.tsContact),1!=e.length||1!=t.length||e[0]!=t[0])i||(p.hAtoms=u.hashUtilsCls.cloneHash(g),p.showInterCls.pickCustomSphere(n,e,t,i,!0,s)),f=u.hashUtilsCls.unionHash(f,p.hAtoms),T+=this.exportSpherePairs(!0,s,m);else{if(!i){let r={},o={};if(b){let e=!0,t=p.showInterCls.pickCustomSphere_base(n,C,v,i,!0,void 0,void 0,!0,e);r=u.hashUtilsCls.unionHash(r,t.residues);for(let e in t.resid2Residhash)o[e]=u.hashUtilsCls.unionHash(o[e],t.resid2Residhash[e])}else{let a=[],l="",d="",c={};for(let e in C){let t=p.atoms[e];t.ss==l&&t.chain==d||(Object.keys(c).length>0&&a.push(c),c={}),c[t.serial]=1,l=t.ss,d=t.chain}Object.keys(c).length>0&&a.push(c);let h=a.length,m="interactions "+n+" | sets "+e+" "+t+" | true";p.opts.contact="yes";for(let e=0;e<h;++e)for(let t=e+1;t<h;++t){p.hAtoms=u.hashUtilsCls.cloneHash(g);let l=p.showInterCls.pickCustomSphere_base(n,a[e],a[t],i,!0,s,m,!0);r=u.hashUtilsCls.unionHash(r,l.residues);for(let e in l.resid2Residhash)o[e]=u.hashUtilsCls.unionHash(o[e],l.resid2Residhash[e])}}p.resid2ResidhashInteractions=o;let l,d,c=Object.keys(r);p.hAtoms={};for(let e=0,t=c.length;e<t;++e){let t=c[e];for(let e in p.residues[t])p.hAtoms[e]=1}let h=p.firstAtomObjCls.getFirstAtomObj(r);void 0!==h&&(l="sphere."+h.chain+":"+u.utilsCls.residueName2Abbr(h.resn.substr(0,3)).trim()+h.resi+"-"+radius+"A",a&&(l="interactions."+h.chain+":"+u.utilsCls.residueName2Abbr(h.resn.substr(0,3)).trim()+h.resi+"-"+$("#"+p.pre+"contactthreshold").val()+"A"),d=l,p.selectionCls.addCustomSelection(c,l,d,x,!0)),p.selectionCls.saveSelectionIfSelected(),p.drawCls.draw()}f=u.hashUtilsCls.unionHash(f,p.hAtoms),T+=this.exportSpherePairs(!0,s,m)}}p.hAtoms=u.hashUtilsCls.cloneHash(f),p.bRender=!0,p.drawCls.draw(),w=p.firstAtomObjCls.getResiduesFromAtoms(f),x="select "+p.resid2specCls.residueids2spec(Object.keys(w)),A="interface_all",M=A,p.selectionCls.addCustomSelection(Object.keys(w),A,M,x,!0);let E=u.hashUtilsCls.intHash(f,C);w=p.firstAtomObjCls.getResiduesFromAtoms(E),x="select "+p.resid2specCls.residueids2spec(Object.keys(w)),A="interface_1",M=A,p.selectionCls.addCustomSelection(Object.keys(w),A,M,x,!0);let R=u.hashUtilsCls.intHash(f,v);w=p.firstAtomObjCls.getResiduesFromAtoms(R),x="select "+p.resid2specCls.residueids2spec(Object.keys(w)),A="interface_2",M=A,p.selectionCls.addCustomSelection(Object.keys(w),A,M,x,!0);let k='<div style="text-align:center"><b>'+S.join(", ")+" between Two Sets:</b><br>",O=p.resid2specCls.atoms2residues(Object.keys(C)),I=p.resid2specCls.atoms2residues(Object.keys(v)),P="select "+p.resid2specCls.residueids2spec(O),D="select "+p.resid2specCls.residueids2spec(I);k+="Set 1: "+e+' <button class="'+p.pre+'selset" cmd="'+P+'">Highlight in 3D</button><br>',k+="Set 2: "+t+' <button class="'+p.pre+'selset" cmd="'+D+'">Highlight in 3D</button><br><br></div>',k+='<div style="text-align:center"><b>The interfaces are:</b><br>';let L=p.resid2specCls.atoms2residues(Object.keys(E)),F=p.resid2specCls.atoms2residues(Object.keys(R)),N="select "+p.resid2specCls.residueids2spec(L),U="select "+p.resid2specCls.residueids2spec(F);k+='interface_1 <button class="'+p.pre+'selset" cmd="'+N+'">Highlight in 3D</button><br>',k+='interface_2 <button class="'+p.pre+'selset" cmd="'+U+'">Highlight in 3D</button><br><br></div>',k+='<div><b>Note</b>: Each checkbox below selects the corresponding residue. You can click "Save Selection" in the "Select" menu to save the selection and click on "Highlight" button to clear the checkboxes.</div><br>';let H=k;if(("graph"==s||"linegraph"==s||"scatterplot"==s||b)&&(k=""),k+=T,"save1"==s||"save2"==s){k=H;let e="";"save1"==s?e="Set 1":"save2"==s&&(e="Set 2"),k+='<div style="text-align:center"><br><b>Interactions Sorted on '+e+'</b>: <button class="'+p.pre+'showintercntonly" style="margin-left:20px">Show Count Only</button><button class="'+p.pre+'showinterdetails" style="margin-left:20px">Show Details</button></div>';let t=this.getAllInteractionTable(s);k+=t.html,h=t.bondCnt,$("#"+p.pre+"dl_interactionsorted_html").html(k),u.htmlCls.dialogCls.openDlg("dl_interactionsorted","Show sorted interactions")}else if("view"==s)$("#"+p.pre+"dl_allinteraction_html").html(k),u.htmlCls.dialogCls.openDlg("dl_allinteraction","Show interactions");else if("linegraph"==s){u.htmlCls.dialogCls.openDlg("dl_linegraph","Show interactions between two lines of residue nodes"),p.graphStr=p.getGraphCls.getGraphData(C,v,e,t,k,m),p.bLinegraph=!0;let i=p.lineGraphCls.drawLineGraph(p.graphStr);$("#"+p.pre+"linegraphDiv").html(i)}else if("scatterplot"==s){u.htmlCls.dialogCls.openDlg("dl_scatterplot","Show interactions as scatterplot"),p.graphStr=p.getGraphCls.getGraphData(C,v,e,t,k,m),p.bScatterplot=!0;let i=p.lineGraphCls.drawLineGraph(p.graphStr,!0);$("#"+p.pre+"scatterplotDiv").html(i)}else if("ligplot"==s)await p.ligplotCls.drawLigplot(C);else if(b){u.htmlCls.dialogCls.openDlg("dl_contactmap","Show contact map");let i=!0,s=p.getGraphCls.getGraphData(C,v,e,t,k,m,i);p.bContactMap=!0;let n=p.contactMapCls.drawContactMap(s);$("#"+p.pre+"contactmapDiv").html(n)}else if("graph"==s){if(p.graphStr=p.getGraphCls.getGraphData(C,v,e,t,k,m),p.bGraph=!0,Object.keys(v).length+Object.keys(C).length>Object.keys(p.dAtoms).length&&(p.graphStr=p.selectionCls.getGraphDataForDisplayed()),void 0===p.bD3){let e="./script/d3v4-force-all.min.js";await u.getAjaxPromise(e,"script"),p.bD3=!0}$("#"+u.svgid).empty(),u.htmlCls.dialogCls.openDlg("dl_graph","Force-directed graph"),p.drawGraphCls.drawGraph(p.graphStr,p.pre+"dl_graph")}return{interactionTypes:S.toString(),bondCnt:h}}clearInteractions(){let e=this.icn3d;e.icn3dui,e.lines.hbond=[],e.hbondpnts=[],e.lines.saltbridge=[],e.saltbridgepnts=[],e.lines.contact=[],e.contactpnts=[],e.lines.halogen=[],e.lines["pi-cation"]=[],e.lines["pi-stacking"]=[],e.halogenpnts=[],e.picationpnts=[],e.pistackingpnts=[]}resetInteractionPairs(){let e=this.icn3d;e.icn3dui,e.bHbondCalc=!1,e.showInterCls.hideHbondsContacts(),e.hlUpdateCls.clearHighlight(),e.resids2inter={},e.resids2interAll={}}async retrieveInteractionData(){let e=this.icn3d,t=e.icn3dui;if(!e.b2DShown)if(void 0!==t.cfg.align){let i=Object.keys(e.structures);if(2==t.cfg.atype){let t=!0;await e.alignParserCls.downloadAlignment(i[0]+","+i[1],t)}await e.ParserUtilsCls.set2DDiagramsForAlign(i[0].toUpperCase(),i[1].toUpperCase())}else void 0!==t.cfg.chainalign?(Object.keys(e.structures),await e.ParserUtilsCls.set2DDiagramsForChainalign(e.chainidArray)):e.ParserUtilsCls.download2Ddgm(e.inputid.toUpperCase())}getAllInteractionTable(e,t,i,s,n,r){let a=this.icn3d,o=a.icn3dui,l="",d="",c=[],h=Object.keys(a.resids2inter);("save1"==e||"save2"==e)&&h.sort((function(t,i){return o.utilsCls.compResid(t,i,e)}));let p,u,m="",f="",g="",b="",C="",v="",_="",y="",S="",w=0,x=0,A=0,M=0,T=0,E=0,R="";for(let o=0,k=h.length;o<k;++o){let k=h[o],O=k.split(",");p="save1"==e?O[0]:O[1],u="save1"==e?O[1]:O[0];let I,P,D=p.split("_");o>0&&p!=f&&(c.push({res1:f,res2:R,cntHbond:w,cntIonic:x,cntContact:A,cntHalegen:M,cntPication:T,cntPistacking:E}),m+=this.getInteractionPerResidue(g,b,C,v,_,y,S,w,x,A,M,T,E),b="",C="",v="",_="",y="",S="",w=0,x=0,A=0,M=0,T=0,E=0,R=""),I=a.resids2inter[k].hbond,P=this.getInteractionPairDetails(I,e,"hbond",t,i,s,n,r),b+=P.html,w+=P.cnt,l+=P.svgHtmlNode,d+=P.svgHtmlLine,P.cnt>0&&(R+=u+":hbond_"+P.cnt+":type_"+P.mainside+" "),I=a.resids2inter[k].ionic,P=this.getInteractionPairDetails(I,e,"ionic",t,i,s,n,r),C+=P.html,x+=P.cnt,l+=P.svgHtmlNode,d+=P.svgHtmlLine,P.cnt>0&&(R+=u+":ionic_"+P.cnt+":type_"+P.mainside+" "),I=a.resids2inter[k].halogen,P=this.getInteractionPairDetails(I,e,"halogen",t,i,s,n,r),_+=P.html,M+=P.cnt,l+=P.svgHtmlNode,d+=P.svgHtmlLine,P.cnt>0&&(R+=u+":halogen_"+P.cnt+":type_"+P.mainside+" "),I=a.resids2inter[k]["pi-cation"],P=this.getInteractionPairDetails(I,e,"pi-cation",t,i,s,n,r),y+=P.html,T+=P.cnt,l+=P.svgHtmlNode,d+=P.svgHtmlLine,P.cnt>0&&(R+=u+":pi-cation_"+P.cnt+":type_"+P.mainside+" "),I=a.resids2inter[k]["pi-stacking"],P=this.getInteractionPairDetails(I,e,"pi-stacking",t,i,s,n,r),S+=P.html,E+=P.cnt,l+=P.svgHtmlNode,d+=P.svgHtmlLine,P.cnt>0&&(R+=u+":pi-stacking_"+P.cnt+":type_"+P.mainside+" "),I=a.resids2inter[k].contact,P=this.getContactPairDetails(I,e,"contact",t,i,s,n,r),v+=P.html,A+=P.cnt,l+=P.svgHtmlNode,d+=P.svgHtmlLine,P.cnt>0&&(R+=u+":contact_"+P.cnt+" "),f=p,g=D}c.push({res1:f,res2:R,cntHbond:w,cntIonic:x,cntContact:A,cntHalegen:M,cntPication:T,cntPistacking:E}),m+=this.getInteractionPerResidue(g,b,C,v,_,y,S,w,x,A,M,T,E);let k="";if(h.length>0){k+='<br><table class="icn3d-sticky" align=center border=1 cellpadding=10 cellspacing=0><thead>',k+="<tr><th rowspan=2>Residue</th><th rowspan=2># Hydrogen<br>Bond</th><th rowspan=2># Salt Bridge<br>/Ionic Interaction</th><th rowspan=2># Contact</th>",k+="<th rowspan=2># Halogen<br>Bond</th><th rowspan=2># &pi;-Cation</th><th rowspan=2># &pi;-Stacking</th>",k+="<th>Hydrogen Bond (backbone atoms: @CA, @N, @C, @O)</th><th>Salt Bridge/Ionic Interaction</th><th>Contact</th>",k+="<th>Halogen Bond</th><th>&pi;-Cation</th><th>&pi;-Stacking</th></tr>",k+="<tr>";let e='<td><table width="100%" class="icn3d-border"><tr><td>Atom1</td><td>Atom2</td><td>Distance(&#8491;)</td><td>Highlight in 3D</td></tr></table></td>';k+=e,k+=e,k+='<td><table width="100%" class="icn3d-border"><tr><td>Atom1</td><td>Atom2</td><td># Contacts</td><td>Min Distance(&#8491;)</td><td>C-alpha Distance(&#8491;)</td><td>Highlight in 3D</td></tr></table></td>',k+=e,k+=e,k+=e,k+="</tr>",k+="</thead><tbody>",k+=m,k+="</tbody></table><br/>"}return{html:k,bondCnt:c,svgHtmlNode:l,svgHtmlLine:d}}getInteractionPerResidue(e,t,i,s,n,r,a,o,l,d,c,h,p){this.icn3d.icn3dui;let u="";u+='<tr align="center"><th>'+e[3]+e[2]+"</th><td>"+o+"</td><td>"+l+"</td><td>"+d+"</td><td>"+c+"</td><td>"+h+"</td><td>"+p+"</td>";let m=[t,i,s,n,r,a];for(let e in m){u+='<td valign="top"><table width="100%" class="icn3d-border">'+m[e]+"</table></td>"}return u+="</tr>",u}getInteractionPairDetails(e,t,i,s,n,r,a,o){let l=this.icn3d;l.icn3dui;let d="",c="",h="",p=0,u="",m=' <span style="background-color:#',f='">&nbsp;&nbsp;&nbsp;</span>';if(void 0!==e){l.resid2cnt||(l.resid2cnt={}),l.resid2ToXy||(l.resid2ToXy={}),l.nodeid2lineid||(l.nodeid2lineid={});for(let g in e){let b=g.split("|"),C="save1"==t?b[0]:b[1],v="save1"==t?b[1]:b[0],_=C.lastIndexOf(" "),y=v.lastIndexOf(" "),S=C.substr(0,_),w=v.substr(0,y),x=S.substr(S.indexOf("@")+1);w.substr(w.indexOf("@")+1);let A="N"===x||"C"===x||"O"===x||"CA"===x?"main":"side";u&&(u+=";"),u+=A+","+A;let M=l.getGraphCls.convertLabel2Resid(S),T=l.firstAtomObjCls.getFirstAtomObj(l.residues[M]),E=T.color?T.color.getHexString():"",R=l.getGraphCls.convertLabel2Resid(w),k=l.firstAtomObjCls.getFirstAtomObj(l.residues[R]),O=k.color?k.color.getHexString():"",I=Math.sqrt(e[g]).toFixed(1);if(h+='<tr><td><span style="white-space:nowrap"><input type="checkbox" class="'+l.pre+'seloneres" id="'+l.pre+i+"2_"+p+'a" resid="'+S+'"/> '+S+m+E+f+'</span></td><td><span style="white-space:nowrap"><input type="checkbox" class="'+l.pre+'seloneres" id="'+l.pre+i+"2_"+p+'b" resid="'+w+'"/> '+w+m+O+f+'</span></td><td align="center">'+I+"</td>",h+='<td align="center"><button class="'+l.pre+'selres" resid="'+S+"|"+w+'">Highlight</button></td>',h+="</tr>",++p,s){let e=C.substr(_+1).split(","),t=l.ligplotCls.getSvgPerPair(e,S,w,i,s,n,r,a,o,I);d+=t.node,c+=t.line}}}return{html:h,cnt:p,svgHtmlNode:d,svgHtmlLine:c,mainside:u}}getContactPairDetails(e,t,i,s,n,r,a,o){let l=this.icn3d;l.icn3dui;let d="",c="",h="",p=0,u=' <span style="background-color:#',m='">&nbsp;&nbsp;&nbsp;</span>';if(void 0!==e){let f={};l.resid2cnt||(l.resid2cnt={}),l.resid2ToXy||(l.resid2ToXy={}),l.nodeid2lineid||(l.nodeid2lineid={});for(let i in e){let n=i.split("|"),r="save1"==t?n[0]:n[1],a="save1"==t?n[1]:n[0],o=r.lastIndexOf(" "),d=a.lastIndexOf(" "),c=r.substr(o+1).split(","),h=r.substr(0,o);s&&(h+="@"+l.atoms[c[0]].name);let p=a.substr(0,d),u=h+"|"+p,m=l.getGraphCls.convertLabel2Resid(h);l.firstAtomObjCls.getFirstAtomObj(l.residues[m]);let g=l.getGraphCls.convertLabel2Resid(p);l.firstAtomObjCls.getFirstAtomObj(l.residues[g]);let b=e[i].split("_"),C=parseFloat(b[0]),v=parseInt(b[4]);f.hasOwnProperty(u)?(f[u].cnt+=v,C<f[u].dist1&&(f[u].dist1=C,f[u].dist1_dist2_atom1_atom2=b,f[u].serialArray1=c)):f[u]={dist1:C,dist1_dist2_atom1_atom2:b,cnt:v,serialArray1:c}}let g={};for(let e in f){let t=e.split("|"),i=t[0],s=t[1];g.hasOwnProperty(s)?g[s].push(i):g[s]=[i];let n=l.getGraphCls.convertLabel2Resid(i),r=l.firstAtomObjCls.getFirstAtomObj(l.residues[n]),a=r.color?r.color.getHexString():"",o=l.getGraphCls.convertLabel2Resid(s),d=l.firstAtomObjCls.getFirstAtomObj(l.residues[o]),c=d.color?d.color.getHexString():"",b=f[e].dist1_dist2_atom1_atom2,C=b[0],v=b[1],_=b[2],y=b[3],S=1;h+='<tr><td><span style="white-space:nowrap"><input type="checkbox" class="'+l.pre+'seloneres" id="'+l.pre+"inter2_"+p+'a" resid="'+i+'"/> '+i+"@"+_+u+a+m+'</span></td><td><span style="white-space:nowrap"><input type="checkbox" class="'+l.pre+'seloneres" id="'+l.pre+"inter2_"+p+'b" resid="'+s+'"/> '+s+"@"+y+u+c+m+'</span></td><td align="center">'+S+'</td><td align="center">'+C+'</td><td align="center">'+v+"</td>",h+='<td align="center"><button class="'+l.pre+'selres" resid="'+i+"|"+s+'">Highlight</button></td>',h+="</tr>",p+=parseInt(S)}if(s)for(let e in g){let t,h,p=g[e];for(let u=0,m=p.length;u<m;++u){let m=p[u],g=m+"|"+e,b=f[g].serialArray1,C=f[g].dist1_dist2_atom1_atom2,v=C[0];C[1];let _=0!=u,y=l.ligplotCls.getSvgPerPair(b,m,e,i,s,n,r,a,o,v,_,t,h);d+=y.node,c+=y.line,t=y.x2,h=y.y2}}}return{html:h,cnt:p,svgHtmlNode:d,svgHtmlLine:c}}exportInteractions(){var e=this.icn3d,t=e.icn3dui;let i='<html><body><div style="text-align:center"><br><b>Interacting residues</b>:<br/><table align=center border=1 cellpadding=10 cellspacing=0><tr><th>Base Chain: Residues</th><th>Interacting Chain</th></tr>';for(let t in e.chainname2residues)for(let s in e.chainname2residues[t]){let n=t.substr(0,t.indexOf("_"))+"_"+s.substr(0,s.indexOf(" "));i+="<tr><td>"+t+": ",i+=e.resid2specCls.residueids2spec(e.chainname2residues[t][s]),i+="</td><td>"+n+"</td></tr>"}i+="</table><br/></div></body></html>";let s=Object.keys(t.utilsCls.getHlStructures()).join(",");e.saveFileCls.saveFile(s+"_interactions.html","html",i)}exportSsbondPairs(){var e=this.icn3d,t=e.icn3dui;let i="",s=0;for(let t in e.structures){let n=e.ssbondpnts[t];if(void 0===n)break;for(let e=0,t=n.length;e<t;e+=2){i+="<tr><td>"+n[e]+" Cys</td><td>"+n[e+1]+" Cys</td></tr>",++s}}let n='<html><body><div style="text-align:center"><br><b>'+s+" disulfide pairs</b>:<br><br><table align=center border=1 cellpadding=10 cellspacing=0><tr><th>Residue ID 1</th><th>Residue ID 2</th></tr>";n+=i,n+="</table><br/></div></body></html>";let r=Object.keys(t.utilsCls.getHlStructures()).join(",");e.saveFileCls.saveFile(r+"_disulfide_pairs.html","html",n)}exportClbondPairs(){var e=this.icn3d,t=e.icn3dui;let i="",s=0,n={};for(let t in e.structures){let r=e.clbondpnts[t];if(void 0===r)break;for(let t=0,a=r.length;t<a;t+=2){let a=r[t],o=r[t+1];if(!n.hasOwnProperty(a+"_"+o)){let t=e.firstAtomObjCls.getFirstAtomObj(e.residues[a]),n=e.firstAtomObjCls.getFirstAtomObj(e.residues[o]);i+="<tr><td>"+a+" "+t.resn+"</td><td>"+o+" "+n.resn+"</td></tr>",++s}n[a+"_"+o]=1,n[o+"_"+a]=1}}let r='<html><body><div style="text-align:center"><br><b>'+s+" cross-linkage pairs</b>:<br><br><table align=center border=1 cellpadding=10 cellspacing=0><tr><th>Residue ID 1</th><th>Residue ID 2</th></tr>";r+=i,r+="</table><br/></div></body></html>";let a=Object.keys(t.utilsCls.getHlStructures()).join(",");e.saveFileCls.saveFile(a+"_crosslinkage_pairs.html","html",r)}exportHbondPairs(e,t){var i=this.icn3d,s=i.icn3dui;let n="",r=0,a=' <span style="background-color:#',o='">&nbsp;&nbsp;&nbsp;</span>';for(let t in i.resid2ResidhashHbond){let s=i.getGraphCls.convertLabel2Resid(t),l=i.firstAtomObjCls.getFirstAtomObj(i.residues[s]),d=l.color?l.color.getHexString():"";for(let s in i.resid2ResidhashHbond[t]){let l=i.getGraphCls.convertLabel2Resid(s),c=i.firstAtomObjCls.getFirstAtomObj(i.residues[l]),h=c.color?c.color.getHexString():"",p=Math.sqrt(i.resid2ResidhashHbond[t][s]).toFixed(1);n+='<tr><td><input type="checkbox" class="'+i.pre+'seloneres" id="'+i.pre+"hbond_"+r+'a" resid="'+t+'"/> '+t+a+d+o+'</td><td><input type="checkbox" class="'+i.pre+'seloneres" id="'+i.pre+"hbond_"+r+'b" resid="'+s+'"/> '+s+a+h+o+'</td><td align="center">'+p+"</td>","view"==e&&(n+='<td align="center"><button class="'+i.pre+'selres" resid="'+t+"|"+s+'">Highlight</button></td>'),n+="</tr>",++r}}let l='<div style="text-align:center"><br><b>'+r+" hydrogen bond pairs</b> (backbone atoms: @CA, @N, @C, @O):</div><br>";if(r>0&&(l+="<br><table align=center border=1 cellpadding=10 cellspacing=0><tr><th>Atom 1</th><th>Atom 2</th><th>Distance(&#8491;)</th>","view"==e&&(l+='<th align="center">Highlight in 3D</th>'),l+="</tr>",l+=n,l+="</table><br/>"),"graph"==e||"linegraph"==e||"scatterplot"==e){return i.getGraphCls.getGraphLinks(i.resid2ResidhashHbond,i.resid2ResidhashHbond,s.htmlCls.hbondColor,t,s.htmlCls.hbondValue)}return l}exportSaltbridgePairs(e,t){var i=this.icn3d,s=i.icn3dui;let n="",r=0,a=' <span style="background-color:#',o='">&nbsp;&nbsp;&nbsp;</span>';for(let t in i.resid2ResidhashSaltbridge){let s=i.getGraphCls.convertLabel2Resid(t),l=i.firstAtomObjCls.getFirstAtomObj(i.residues[s]),d=l.color?l.color.getHexString():"";for(let s in i.resid2ResidhashSaltbridge[t]){let l=i.getGraphCls.convertLabel2Resid(s),c=i.firstAtomObjCls.getFirstAtomObj(i.residues[l]),h=c.color?c.color.getHexString():"",p=Math.sqrt(i.resid2ResidhashSaltbridge[t][s]).toFixed(1);n+='<tr><td><input type="checkbox" class="'+i.pre+'seloneres" id="'+i.pre+"saltb_"+r+'a" resid="'+t+'"/> '+t+a+d+o+'</td><td><input type="checkbox" class="'+i.pre+'seloneres" id="'+i.pre+"saltb_"+r+'b" resid="'+s+'"/> '+s+a+h+o+'</td><td align="center">'+p+"</td>","view"==e&&(n+='<td align="center"><button class="'+i.pre+'selres" resid="'+t+"|"+s+'">Highlight</button></td>'),n+="</tr>",++r}}let l='<div style="text-align:center"><br><b>'+r+" salt bridge/ionic interaction pairs</b>:</div><br>";if(r>0&&(l+="<br><table align=center border=1 cellpadding=10 cellspacing=0><tr><th>Atom 1</th><th>Atom 2</th><th>Distance(&#8491;)</th>","view"==e&&(l+='<th align="center">Highlight in 3D</th>'),l+="</tr>",l+=n,l+="</table><br/>"),"graph"==e||"linegraph"==e||"scatterplot"==e){return i.getGraphCls.getGraphLinks(i.resid2ResidhashSaltbridge,i.resid2ResidhashSaltbridge,s.htmlCls.ionicColor,t,s.htmlCls.ionicValue)}return l}exportHalogenPiPairs(e,t,i){var s=this.icn3d,n=s.icn3dui;let r,a,o,l="",d=0,c=' <span style="background-color:#',h='">&nbsp;&nbsp;&nbsp;</span>';"halogen"==i?(r=s.resid2ResidhashHalogen,a=n.htmlCls.halogenColor,o=n.htmlCls.halogenValue):"pi-cation"==i?(r=s.resid2ResidhashPication,a=n.htmlCls.picationColor,o=n.htmlCls.picationValue):"pi-stacking"==i&&(r=s.resid2ResidhashPistacking,a=n.htmlCls.pistackingColor,o=n.htmlCls.pistackingValue);for(let t in r){let n=s.getGraphCls.convertLabel2Resid(t),a=s.firstAtomObjCls.getFirstAtomObj(s.residues[n]),o=a.color?a.color.getHexString():"";for(let n in r[t]){let a=s.getGraphCls.convertLabel2Resid(n),p=s.firstAtomObjCls.getFirstAtomObj(s.residues[a]),u=p.color?p.color.getHexString():"",m=Math.sqrt(r[t][n]).toFixed(1);l+='<tr><td><input type="checkbox" class="'+s.pre+'seloneres" id="'+s.pre+i+"_"+d+'a" resid="'+t+'"/> '+t+c+o+h+'</td><td><input type="checkbox" class="'+s.pre+'seloneres" id="'+s.pre+i+"_"+d+'b" resid="'+n+'"/> '+n+c+u+h+'</td><td align="center">'+m+"</td>","view"==e&&(l+='<td align="center"><button class="'+s.pre+'selres" resid="'+t+"|"+n+'">Highlight</button></td>'),l+="</tr>",++d}}let p='<div style="text-align:center"><br><b>'+d+" "+i+" pairs</b>:</div><br>";if(d>0&&(p+="<br><table align=center border=1 cellpadding=10 cellspacing=0><tr><th>Atom 1</th><th>Atom 2</th><th>Distance(&#8491;)</th>","view"==e&&(p+='<th align="center">Highlight in 3D</th>'),p+="</tr>",p+=l,p+="</table><br/>"),"graph"==e||"linegraph"==e||"scatterplot"==e){return s.getGraphCls.getGraphLinks(r,r,a,t,o)}return p}exportSpherePairs(e,t,i){var s=this.icn3d,n=s.icn3dui;let r="",a=0,o=e?s.resid2ResidhashInteractions:s.resid2ResidhashSphere,l=' <span style="background-color:#',d='">&nbsp;&nbsp;&nbsp;</span>';for(let i in o){let n=s.getGraphCls.convertLabel2Resid(i),c=s.firstAtomObjCls.getFirstAtomObj(s.residues[n]),h=c.color?c.color.getHexString():"";for(let n in o[i]){let p=s.getGraphCls.convertLabel2Resid(n),u=s.firstAtomObjCls.getFirstAtomObj(s.residues[p]),m=u.color?u.color.getHexString():"",f=o[i][n].split("_"),g=f[0],b=f[1];c=f[2],u=f[3];let C=f[4];e?(r+='<tr><td><input type="checkbox" class="'+s.pre+'seloneres" id="'+s.pre+"inter_"+a+'a" resid="'+i+'"/> '+i+"@"+c+l+h+d+'</td><td><input type="checkbox" class="'+s.pre+'seloneres" id="'+s.pre+"inter_"+a+'b" resid="'+n+'"/> '+n+"@"+u+l+m+d+'</td><td align="center">'+C+'</td><td align="center">'+g+'</td><td align="center">'+b+"</td>","view"==t&&(r+='<td align="center"><button class="'+s.pre+'selres" resid="'+i+"|"+n+'">Highlight</button></td>'),r+="</tr>"):r+="<tr><td>"+i+"</td><td>"+n+'</td><td align="center">'+C+'</td><td align="center">'+g+'</td><td align="center">'+b+"</td></tr>",++a}}let c='<div style="text-align:center"><br><b>'+a+" residue pairs in "+(e?"the contacts":"sphere")+"</b>:</div><br>";if(a>0&&(e?(c+='<br><table align=center border=1 cellpadding=10 cellspacing=0><tr><th>Residue 1</th><th>Residue 2</th><th align="center">Num Contacts</th><th align="center">Min Distance(&#8491;)</th><th align="center">C-alpha Distance(&#8491;)</th>',"view"==t&&(c+='<th align="center">Highlight in 3D</th>'),c+="</tr>"):c+='<br><table align=center border=1 cellpadding=10 cellspacing=0><tr><th>Residue 1</th><th>Residue 2</th><th align="center">Num Contacts</th><th align="center">Min Distance(&#8491;)</th><th align="center">C-alpha Distance(&#8491;)</th></tr>',c+=r,c+="</table><br/>"),"graph"==t||"linegraph"==t||"scatterplot"==t||"calpha"==t||"cbeta"==t||"heavyatoms"==t){return s.getGraphCls.getGraphLinks(o,o,n.htmlCls.contactColor,i,n.htmlCls.contactValue)}return c}}class Sh{constructor(e){this.icn3d=e}drawGraph(e,t){var i=this.icn3d,s=i.icn3dui;if(void 0===n)var n=d3;var r=JSON.parse(e),a=$("#"+t).width(),o=$("#"+t).height(),l=isNaN(a)?300:1*a,d=isNaN(o)?300:1*o,c=a,h=o,p=d3.select("#"+s.svgid).attr("width",a).attr("height",o).attr("viewBox","0,0,"+l+","+d);p.selectAll(".g-main").remove();var u=p.append("g").classed("g-main",!0),m=u.append("rect").attr("width",c).attr("height",h).style("fill","#FFF"),f=u.append("g"),g=n.zoom().on("zoom",(function(){f.attr("transform",n.event.transform)}));if(u.call(g),r.links){for(var b=[],C={},v=0,_=r.nodes.length;v<_;++v){C[(E=r.nodes[v]).id]=1}var y=!1;for(v=0,_=r.links.length;v<_;++v){var S=r.links[v];C.hasOwnProperty(S.source)&&C.hasOwnProperty(S.target)?b.push(S):(C.hasOwnProperty(S.source)||console.log("The node "+S.source+" is not found... "),C.hasOwnProperty(S.target)||console.log("The node "+S.target+" is not found... "),y=!0)}y&&console.log(JSON.stringify(r)),r.links=b;var w={};for(v=0;v<r.nodes.length;v++)s.htmlCls.force||(r.nodes[v].x*=10,r.nodes[v].y*=10),w[r.nodes[v].id]=r.nodes[v],r.nodes[v].weight=1.01;if(s.htmlCls.hideedges&&!s.htmlCls.force){var x=[];for(v=0;v<r.links.length;v++)"FFF"!=r.links[v].c&&x.push(r.links[v]);r.links=x}var A=f.append("g"),M=null,T=(S=f.append("g").attr("class","link").selectAll("line").data(r.links).enter().append("line").attr("stroke",(function(e){return e.v==s.htmlCls.contactInsideValue?"#"+s.htmlCls.contactInsideColor:e.v==s.htmlCls.hbondInsideValue?"#"+s.htmlCls.hbondInsideColor:e.v==s.htmlCls.ionicInsideValue?"#"+s.htmlCls.ionicInsideColor:e.v==s.htmlCls.halogenInsideValue?"#"+s.htmlCls.halogenInsideColor:e.v==s.htmlCls.picationInsideValue?"#"+s.htmlCls.picationInsideColor:e.v==s.htmlCls.pistackingInsideValue?"#"+s.htmlCls.pistackingInsideColor:"#"+e.c})).attr("stroke-width",(function(e){return e.v==s.htmlCls.contactValue||e.v==s.htmlCls.contactInsideValue||e.v==s.htmlCls.hbondInsideValue||e.v==s.htmlCls.ionicInsideValue||e.v==s.htmlCls.halogenInsideValue||e.v==s.htmlCls.picationInsideValue||e.v==s.htmlCls.pistackingInsideValue?"1px":e.v==s.htmlCls.hbondValue||e.v==s.htmlCls.ionicValue||e.v==s.htmlCls.halogenValue||e.v==s.htmlCls.picationValue||e.v==s.htmlCls.pistackingValue?"2px":e.v==s.htmlCls.ssbondValue||e.v==s.htmlCls.clbondValue?"3px":e.v+"px"})),f.append("g").attr("class","node")),E=T.selectAll("circle").data(r.nodes).enter().append("circle").attr("r",3).attr("fill",(function(e){return"#"+e.c})).attr("stroke",(function(e){return"#"+e.c})).attr("res",(function(e){return e.r})).attr("class","icn3d-node").call(n.drag().on("start",(function(e){n.event.active||s.htmlCls.simulation.alphaTarget(.9).restart();e.selected||H||E.classed("selected",(function(e){return e.selected=e.previouslySelected=!1}));n.select(this).classed("selected",(function(t){return e.previouslySelected=e.selected,e.selected=!0})),E.filter((function(e){return e.selected})).each((function(e){e.fx=e.x,e.fy=e.y}))})).on("drag",(function(e){E.filter((function(e){return e.selected})).each((function(e){e.fx+=n.event.dx,e.fy-=n.event.dy}))})).on("end",(function(e){n.event.active||s.htmlCls.simulation.alphaTarget(0);e.fx=null,e.fy=null,E.filter((function(e){return e.selected})).each((function(e){e.fx=null,e.fy=null}))}))),R=T.selectAll("text").data(r.nodes).enter().append("text").text((function(e){var t=e.id,i=t.indexOf(".");return-1!==i&&(t=t.substr(0,i)),t})).attr("fill",(function(e){return"#"+e.c})).attr("stroke","none").attr("class","icn3d-node-text8");E.append("title").text((function(e){return e.id}));var k=parseInt($("#"+i.pre+"dist_ss").val()),O=parseInt($("#"+i.pre+"dist_coil").val()),I=parseInt($("#"+i.pre+"dist_hbond").val()),P=parseInt($("#"+i.pre+"dist_inter").val()),D=parseInt($("#"+i.pre+"dist_ssbond").val()),L=parseInt($("#"+i.pre+"dist_ionic").val()),F=parseInt($("#"+i.pre+"dist_halogen").val()),N=parseInt($("#"+i.pre+"dist_pication").val()),U=parseInt($("#"+i.pre+"dist_pistacking").val());s.htmlCls.simulation=n.forceSimulation().force("link",n.forceLink().id((function(e){return e.id})).distance((function(e){return 30})).strength((function(e){return s.htmlCls.force?e.v==s.htmlCls.ssValue?isNaN(k)?1:k/100:e.v==s.htmlCls.coilValue||e.v==s.htmlCls.clbondValue?isNaN(O)?.5:O/100:e.v==s.htmlCls.hbondValue||e.v==s.htmlCls.hbondInsideValue?isNaN(I)?.5:I/100:e.v==s.htmlCls.contactValue||e.v==s.htmlCls.contactInsideValue?isNaN(P)?.25:P/100:e.v==s.htmlCls.ssbondValue?isNaN(D)?.5:D/100:e.v==s.htmlCls.ionicValue||e.v==s.htmlCls.ionicInsideValue?isNaN(L)?.5:L/100:e.v==s.htmlCls.halogenValue||e.v==s.htmlCls.halogenInsideValue?isNaN(F)?.5:F/100:e.v==s.htmlCls.picationValue||e.v==s.htmlCls.picationInsideValue?isNaN(N)?.5:N/100:e.v==s.htmlCls.pistackingValue||e.v==s.htmlCls.pistackingInsideValue?isNaN(U)?.5:U/100:0:0}))).force("center",n.forceCenter(c/2,h/2)),s.htmlCls.force&&s.htmlCls.simulation.force("charge",n.forceManyBody()),1==s.htmlCls.force?s.htmlCls.simulation.force("x",n.forceX((function(e){return"a"==e.s?c/4:.75*c})).strength((function(e){return.4}))).force("y",n.forceY(h/2).strength((function(e){return.02}))):2==s.htmlCls.force?s.htmlCls.simulation.force("y",n.forceY((function(e){return"a"==e.s?.75*h:h/4})).strength((function(e){return.4}))).force("x",n.forceX(c/2).strength((function(e){return.02}))):3==s.htmlCls.force?s.htmlCls.simulation.force("r",n.forceRadial((function(e){return"a"==e.s?200:100}),c/2,h/2).strength((function(e){return.8}))):s.htmlCls.force,s.htmlCls.simulation.nodes(r.nodes).on("tick",(function(){S.attr("x1",(function(e){var t=e.source.x;return isNaN(t)?0:t})).attr("y1",(function(e){var t=h-e.source.y;return isNaN(t)?0:t})).attr("x2",(function(e){var t=e.target.x;return isNaN(t)?0:t})).attr("y2",(function(e){var t=h-e.target.y;return isNaN(t)?0:t})),E.attr("cx",(function(e){var t=e.x;return isNaN(t)?0:t})).attr("cy",(function(e){var t=h-e.y;return isNaN(t)?0:t})),R.attr("x",(function(e){var t=e.x+6;return isNaN(t)?0:t})).attr("y",(function(e){var t=h-(e.y+3);return isNaN(t)?0:t}))})),s.htmlCls.simulation.force("link").links(r.links);var H,B=!1,z=!1,q=n.brush().on("start",(function(){z=!0,E.each((function(e){e.previouslySelected=H&&e.selected}))})).on("brush",(function(){if(!n.event.sourceEvent)return;if(!n.event.selection)return;var e=n.event.selection;E.classed("selected",(function(t){return t.selected=t.previouslySelected^(e[0][0]<=t.x&&t.x<e[1][0]&&e[0][1]<=h-t.y&&h-t.y<e[1][1])}))})).on("end",(function(){if(!n.event.sourceEvent)return;if(!n.event.selection)return;if(!M)return;M.call(q.move,null),B||(M.remove(),M=null);z=!1}));return m.on("click",(function(){E.each((function(e){e.selected=!1,e.previouslySelected=!1})),E.classed("selected",!1)})),n.select("body").on("keydown",(function(){if(H=n.event.ctrlKey){if(M)return;B=!0,M||(M=A.append("g")).call(q)}})),n.select("body").on("keyup",(function(){if(H=!1,B=!1,!M)return;z||(M.remove(),M=null)})),r}console.log("Graph is missing links")}}class wh{constructor(e){this.icn3d=e}async contactMap(e,t){let i=this.icn3d;i.icn3dui;let s=["selected"],n=["selected"];if(0==n.length)alert("Please select the first set");else{i.definedSetsCls.setMode("selection");let r=!1,a=!1,o=!0,l=!1,d=!1,c=!1;await i.viewInterPairsCls.viewInteractionPairs(n,s,!1,t,r,a,o,l,d,c,e)}}async afErrorMap(e,t){let i=this.icn3d,s=i.icn3dui;s.htmlCls.dialogCls.openDlg("dl_alignerrormap","Show Predicted Aligned Error (PAE) map");let n="https://alphafold.ebi.ac.uk/files/AF-"+e+"-F1-predicted_aligned_error_"+i.AFUniprotVersion+".json",r=await s.getAjaxPromise(n,"json",!1,"There are some problems in loading the PAE file...");this.processAfErrorMap(r,t)}processAfErrorMap(e,t){let i=this.icn3d,s=i.icn3dui,n=e[0]?e[0]:e,r=n.predicted_aligned_error||n.pae,a=n.max_predicted_aligned_error||n.max_pae;if(!r||!a)return void alert("The PAE file didn't have the right format...");let o,l='"nodes": [',d='"links": [',c=!1,h=!1;i.chains&&0!=Object.keys(i.chains).length?o=!0:(o=!1,i.init_base());let p=r.length,u=0,m={};for(let e in i.chains)for(let t=0,s=i.chainsSeq[e].length;t<s;++t)m[u]=i.chainsSeq[e][t],m[u].chainid=e,++u;u=0;for(let e=0;e<p;++e){let n=o?m[e].resi:e+1,f=o?m[e].name:"*",g=o?m[e].chainid:"stru_A",b=g+"_"+n,C=i.residues[b]?i.firstAtomObjCls.getFirstAtomObj(i.residues[b]):{color:s.parasCls.thr(8947848)},v=g.substr(g.indexOf("_")+1),_=C.color.getHexString();c&&(l+=", ");let y=f+n+"."+v;l+='{"id":"'+y+'","r":"1_1_'+b+'","s":"a","c":"'+_+'"}\n',l+=', {"id":"'+y+'.","r":"1_1_'+b+'","s":"b","c":"'+_+'"}',c=!0;for(let i=t?0:e;i<p;++i){u=e*p+i;let t=o?m[i].resi:i+1,s=o?m[i].name:"*",n=o?m[i].chainid:"stru_A",l=s+t+"."+n.substr(n.indexOf("_")+1),c=r[e][i]?r[e][i]/a:0,f=parseInt(255*c).toString(16),g=parseInt(255*(.698*c+.302)).toString(16),b=1==f.length?"0"+f:f;h&&(d+=", "),d+='{"source": "'+y+'", "target": "'+l+'.", "v": 11, "c": "'+(b+(1==g.length?"0"+g:g)+b)+'", "pae": '+parseInt(r[e][i])+"}\n",h=!0}}e={};let f="{"+l+"], "+d+"]}";this.drawContactMap(f,!0,a)}drawContactMap(e,t,i){let s,n=this.icn3d,r=n.icn3dui,a=JSON.parse(e),o=a.links,l=[],d=[],c={};for(let e=0,t=a.nodes.length;e<t;++e){let t=a.nodes[e];t&&(c[t.id]=t,"a"==t.s?l.push(t):"b"==t.s?d.push(t):"ab"==t.s&&(l.push(t),d.push(t)))}l.sort((function(e,t){return n.getGraphCls.compNode(e,t)})),d.sort((function(e,t){return n.getGraphCls.compNode(e,t)}));let h,p,u,m,f="{\n",g=Object.keys(n.structures).length>0?n.structures[0]:n.defaultPdbId;p=10*(l.length+2)+20+30,h=10*(d.length+2)+20+30,t?(n.alignerrormapWidth=2*h,m=n.alignerrormapWidth,u=r.alignerrormapid):(n.contactmapWidth=2*h,m=n.contactmapWidth,u=r.contactmapid),s=o.length>0?"":"No interactions found for these two sets<br><br>",s+="<svg xmlns='http://www.w3.org/2000/svg' id='"+u+"' viewBox='0,0,"+h+","+p+"' width='"+m+"px'>";if(t){n.hex2id={};let e=29/i;n.hex2skip={};let t=1e3;for(let i=0;i<t;++i){let s=1*i/t,a=parseInt(255*s).toString(16),o=parseInt(255*(.698*s+.302)).toString(16),l=1==a.length?"0"+a:a,d=l+(1==o.length?"0"+o:o)+l,c=r.pre+"afmap_"+i;n.hex2id[d]=c,s>e&&(n.hex2skip[d]=c)}}if(s+=n.lineGraphCls.drawScatterplot_base(l,d,o,c,0,!0,void 0,void 0,t),f+=n.getGraphCls.updateGraphJson(g,1,l,d,o),s+="</svg>",f+="}\n",t){n.alignerrormapStr=f,$("#"+n.pre+"alignerrormapDiv").html(s);let e=$("#"+r.alignerrormapid+"_scale").val();$("#"+r.alignerrormapid).attr("width",(n.alignerrormapWidth*parseFloat(e)).toString()+"px")}else n.contactmapStr=f,$("#"+n.pre+"contactmapDiv").html(s);return s}}class xh{constructor(e){this.icn3d=e}async downloadAlignment(e,t){let i=this.icn3d,s=i.icn3dui,n=this;i.opts.proteins="c alpha trace";let r=e.split(","),a="ids="+e,o=s.htmlCls.baseUrl+"vastplus/vastplus.cgi?v=3&cmd=c&b=1&s=1&w3d&"+a;void 0!==s.cfg.inpara&&(o+=s.cfg.inpara),i.pdbid_chain2title={},void 0===i.chainids2resids&&(i.chainids2resids={});let l={},d="These two MMDB IDs "+r+' do not have 3D alignment data in the VAST+ database. You can try the VAST alignment by visiting the VAST+ page https://www.ncbi.nlm.nih.gov/Structure/vastplus/vastplus.cgi?uid=[PDB ID] (e.g., uid=1KQ2), and clicking "Original VAST"',c=await s.getAjaxPromise(o,"jsonp",!0,d);if(l=c.seqalign,void 0===l)return alert(d),!1;i.pdbid_molid2chain={},i.chainsColor={};for(let e=0,t=2;e<t;++e){let t=c.alignedStructures[0][e],n=void 0!==t.pdbId?t.pdbId:t.mmdbId,r={};for(let e=0,a=t.molecules.length;e<a;++e){let a=t.molecules[e],o=a.moleculeId,l=a.chain.trim().replace(/_/g,"");void 0===r[l]?r[l]=1:++r[l];let d=1===r[l]?l:l+r[l].toString();i.pdbid_molid2chain[n+"_"+o]=d,"p"!==a.kind&&"n"!==a.kind||(i.chainsColor[n+"_"+d]=s.parasCls.thr(s.htmlCls.GREY8))}}i.mmdbidArray=[];for(let e=0,t=2;e<t;++e){let t=c.alignedStructures[0][e],s=t.pdbId;i.mmdbidArray.push(s);let n=t.molecules;for(let e in n){let t=n[e].chain;i.pdbid_chain2title[s+"_"+t]=n[e].name}}i.alignmolid2color=[],s.parasCls.stdChainColors.length;for(let e=0,t=l.length;e<t;++e){let t=l[e][0].moleculeId,s=l[e][1].moleculeId,n={};n[t]=(e+1).toString(),i.alignmolid2color.push(n),n={},n[s]=(e+1).toString(),i.alignmolid2color.push(n)}if(!t){let e=s.htmlCls.baseUrl+"mmdb/mmdb_strview.cgi?v=2&program=icn3d&b=1&s=1&ft=1&bu="+s.cfg.bu+"&uid="+i.mmdbidArray[0],t=s.htmlCls.baseUrl+"mmdb/mmdb_strview.cgi?v=2&program=icn3d&b=1&s=1&ft=1&bu="+s.cfg.bu+"&uid="+i.mmdbidArray[1],r=s.getAjaxPromise(e,"jsonp",!0),a=s.getAjaxPromise(t,"jsonp",!0),o=Promise.allSettled([r,a]),d=await o,h=c,p=d[0].value,u=d[1].value;if(void 0===p.atoms||void 0===u.atoms)return alert("invalid atoms data."),!1;{i.ParserUtilsCls.setYourNote((i.mmdbidArray[0]+","+i.mmdbidArray[1]).toUpperCase()+"(VAST+) in iCn3D");let e=1,t=h.transform.translate.master,s=new mt(t[0]/e,t[1]/e,t[2]/e),r=h.transform.translate.slave,a=new mt(r[0]/e,r[1]/e,r[2]/e),o=h.transform.rotate,d=[];for(let t=0,i=o.length;t<i;++t)d.push(o[t]/e);i.chainid2seq={};for(let e in p.sequences){let t=i.mmdbidArray[0]+"_"+e;i.chainid2seq[t]=p.sequences[e]}for(let e in u.sequences){let t=i.mmdbidArray[1]+"_"+e;i.chainid2seq[t]=u.sequences[e]}let c=p.atoms,m=u.atoms,f=p.atomCount,g=u.atomCount;for(let e=0,t=h.alignedStructures[0].length;e<t;++e){let t=h.alignedStructures[0][e];t.serialInterval=[],0==e?(t.serialInterval.push(1),t.serialInterval.push(f)):1==e&&(t.serialInterval.push(f+1),t.serialInterval.push(f+g))}let b={};for(let e in c){let t=c[e];t.coord=new mt(t.coord[0],t.coord[1],t.coord[2]),t.coord.add(s);let i=t.coord.x*d[0]+t.coord.y*d[1]+t.coord.z*d[2],n=t.coord.x*d[3]+t.coord.y*d[4]+t.coord.z*d[5],r=t.coord.x*d[6]+t.coord.y*d[7]+t.coord.z*d[8];t.coord.x=i,t.coord.y=n,t.coord.z=r,b[e]=t}for(let e in m){let t=m[e];t.coord=new mt(t.coord[0],t.coord[1],t.coord[2]),t.coord.add(a);for(let e=0,i=t.bonds.length;e<i;++e)t.bonds[e]+=f;b[(parseInt(e)+f).toString()]=t}let C={};C.alignedStructures=h.alignedStructures,C.alignment=h.alignment,C.atoms=b,await n.loadOpmDataForAlign(C,l,i.mmdbidArray)}}}async downloadAlignmentPart2(e,t,i){let s=this.icn3d,n=s.icn3dui;s.loadAtomDataCls.loadAtomDataIn(e,void 0,"align",t),void 0===n.cfg.align&&1==Object.keys(s.structures).length&&$("#"+s.pre+"alternateWrapper").hide();let r={};for(let e in s.atoms)r[e]=1;s.dAtoms=r,s.hAtoms=r,s.setStyleCls.setAtomStyleByOptions(s.opts),s.setColorCls.setColorByOptions(s.opts,s.atoms),void 0!==i&&s.ParserUtilsCls.transformToOpmOriForAlign(s.selectedPdbid,i,!0),await s.ParserUtilsCls.renderStructure(),void 0!==n.cfg.rotate&&s.resizeCanvasCls.rotStruc(n.cfg.rotate,!0),s.html2ddgm="",n.cfg.showalignseq&&n.htmlCls.dialogCls.openDlg("dl_alignment","Select residues in aligned sequences"),n.cfg.show2d&&s.bFullUi&&await s.ParserUtilsCls.set2DDiagramsForAlign(s.mmdbidArray[0].toUpperCase(),s.mmdbidArray[1].toUpperCase())}async loadOpmDataForAlign(e,t,i){let s=this.icn3d,n=s.icn3dui,r=this;try{let a="https://opm-assets.storage.googleapis.com/pdb/"+i[0].toLowerCase()+".pdb",o=n.getAjaxPromise(a,"text"),l="https://opm-assets.storage.googleapis.com/pdb/"+i[1].toLowerCase()+".pdb",d=n.getAjaxPromise(l,"text"),c=Promise.allSettled([o,d]),h=await c,p=!1;for(let n=0,a=h.length;n<a;++n){let a=h[n].value;if(!a)continue;s.selectedPdbid=i[n],s.bOpm=!0;let o=!0,l=s.loadPDBCls.loadPDB(a,i[n],s.bOpm,o);$("#"+s.pre+"selectplane_z1").val(s.halfBilayerSize),$("#"+s.pre+"selectplane_z2").val(-s.halfBilayerSize),$("#"+s.pre+"extra_mem_z").val(s.halfBilayerSize),$("#"+s.pre+"intra_mem_z").val(-s.halfBilayerSize),s.init(),await r.downloadAlignmentPart2(e,t,l),p=!0;break}p||(s.init(),await r.downloadAlignmentPart2(e,t))}catch(i){return s.init(),void await r.downloadAlignmentPart2(e,t)}}}class Ah{constructor(e){this.icn3d=e}async downloadChainalignmentPart2(e,t,i,s){let n,r,a=this.icn3d,o=a.icn3dui,l=this,d={},c={};n=s[0].substr(0,s[0].indexOf("_"));let h=!1;if(n.length>5){let t=!1,i=!0;d=await a.pdbParserCls.loadPdbData(e,n,!1,t,"target",h,i)}else{let t=!0;d=await a.mmdbParserCls.parseMmdbData(e,"target",s[0],0,h,t)}for(let e=0,i=t.length;e<i;++e){if(e==t.length-1&&(h=!0),r=s[e+1].substr(0,s[e+1].indexOf("_")),r.length>5){let i=!0,s=!0;c=await a.pdbParserCls.loadPdbData(t[e],r,!1,i,"query",h,s)}else{let i=!0;c=await a.mmdbParserCls.parseMmdbData(t[e],"query",s[e+1],e,h,i)}d=o.hashUtilsCls.unionHash(d,c)}if(o.cfg.resnum)await a.realignParserCls.realignChainOnSeqAlign(i,s);else if(o.cfg.resdef)await a.realignParserCls.realignChainOnSeqAlign(i,s,void 0,!0);else{await a.pdbParserCls.applyCommandDssp(!0);
//!!!
let e=[],t=[],c=[],h=o.htmlCls.baseUrl+"vastdyn/vastdyn.cgi",p=o.htmlCls.baseUrl+"tmalign/tmalign.cgi",u=o.cfg.resrange?decodeURIComponent(o.cfg.resrange).split(" | "):[],m=o.cfg.resrange?a.realignParserCls.getSeqCoorResid([u[0]],s[0],!0).hAtoms:a.chains[s[0]];for(let i=1,n=s.length;i<n;++i){let n,l=o.cfg.resrange?a.realignParserCls.getSeqCoorResid([u[i]],s[i],!0).hAtoms:a.chains[s[i]];if("tmalign"!=o.cfg.aligntool){let e={domains1:a.domain3dCls.getDomainJsonForAlign(l),domains2:a.domain3dCls.getDomainJsonForAlign(m)};n=o.getAjaxPostPromise(h,e)}else{let e={pdb_query:a.saveFileCls.getAtomPDB(l),pdb_target:a.saveFileCls.getAtomPDB(m)};n=o.getAjaxPostPromise(p,e)}e.push(n),t.push(i-1),r=s[i].substr(0,s[i].indexOf("_")),c.push(r)}let f=Promise.allSettled(e),g=await f;await l.downloadChainalignmentPart2b(i,s,d,g,t,n,c)}}async downloadChainalignmentPart2b(e,t,i,s,n,r,a){let o=this.icn3d,l=o.icn3dui;for(let e=0,t=s.length;e<t;++e){let t=s[e].value,i=a[e],o=n[e],d=i.substr(0,4)==r.substr(0,4),c=!1,h={};l.htmlCls.clickMenuCls.setLogCmd("Align "+r+" with "+i,!1),this.processAlign(t,o,h,d,c)}for(let e=0,t=s.length;e<t;++e){let t=a[e],i=n[e];this.transformStructure(t,i,"query")}let d={};!o.bFullUi||void 0===o.q_rotation||l.cfg.resnum||l.cfg.resdef||(d=this.setMsa(t)),o.hAtoms=l.hashUtilsCls.cloneHash(d),o.transformCls.zoominSelection(),await this.downloadChainalignmentPart3(e,t,o.hAtoms)}setMsa(e,t,i){let s=this.icn3d,n=s.icn3dui,r=[];for(let t=1,i=e.length;t<i;++t){let e=0;if(s.qt_start_end&&s.qt_start_end[t-1])for(let i=0,n=s.qt_start_end[t-1].length;i<n;++i)e+=parseInt(s.qt_start_end[t-1][i].q_end)-parseInt(s.qt_start_end[t-1][i].q_start)+1;r.push({index:t,alignLen:e})}r.sort((function(e,t){return t.alignLen-e.alignLen}));let a=s.setSeqAlignCls.setSeqAlignChainForAll(e,r,i);t&&(s.opts.color="identity",s.setColorCls.setColorByOptions(s.opts,a));let o=n.htmlCls.alignSeqCls.getAlignSequencesAnnotations(Object.keys(s.alnChains),void 0,void 0,!1,void 0,!1),l=$("#"+s.pre+"dl_sequence2").html();return $("#"+s.pre+"dl_sequence2").html(l+o.sequencesHtml),$("#"+s.pre+"dl_sequence2").width(n.htmlCls.RESIDUE_WIDTH*o.maxSeqCnt+200),n.htmlCls.dialogCls.openDlg("dl_alignment","Select residues in aligned sequences"),a}async downloadChainalignmentPart2bRealign(e,t,i){let s=this.icn3d,n=s.icn3dui;s.t_trans_add=[],s.q_trans_sub=[],"tmalign"==n.cfg.aligntool&&(s.q_trans_add=[]),s.q_rotation=[],s.qt_start_end=[];let r={},a={},o=!1;for(let i=0,s=e.length;i<s;++i){let s=e[i].value,l=!1,d=!1,c={},h=t[i].split(","),p=h[0].substr(0,h[0].indexOf("_")),u=h[1].substr(0,h[1].indexOf("_"));if(a.hasOwnProperty(p+"_"+u))continue;n.htmlCls.clickMenuCls.setLogCmd("Align "+p+" with "+u,!1);let m=!0;this.processAlign(s,i,c,l,d,m)&&(o=!0,r[p]=void 0===r[p]?1:++r[p],r[u]=void 0===r[u]?1:++r[u],a[p+"_"+u]=h+","+i)}if(!o){if(i)return"tmalign"==n.cfg.aligntool?void(s.bRender&&alert("These structures can NOT be aligned...")):(console.log("These structures can NOT be aligned with VAST. Realign the chains with TM-align."),n.cfg.aligntool="tmalign",void await s.realignParserCls.realignOnStructAlign());{let e=!0;return void s.realignParserCls.realignOnStructAlign(!0,e)}}let l,d,c=0;for(let e in a){let t=e.split("_");r[t[0]]>c&&(c=r[t[0]],l=t[0]),r[t[1]]>c&&(c=r[t[1]],l=t[1])}let h={},p={},u={},m={};for(let e in a){let t,i,s=e.split("_"),n=a[e].split(","),r=n[2];if(l==s[0]?(t=s[0],i=s[1]):l==s[1]?(t=s[1],i=s[0]):(t=s[0],i=s[1]),u[t]=1,u.hasOwnProperty(i))continue;u[i]=1,m[e]=a[e],d="target";let o=!0;this.transformStructure(t,r,d,o),d="query",this.transformStructure(i,r,d,o),h[n[0]]=1,h[n[1]]=1}for(let e in m)if(void 0!==s.q_rotation){let t=m[e].split(","),i=[t[1],t[0],t[2]],r=s.setSeqAlignCls.setSeqAlignChain(void 0,void 0,i);p=n.hashUtilsCls.unionHash(p,r);let a=!1,o=n.htmlCls.alignSeqCls.getAlignSequencesAnnotations(Object.keys(s.alnChains),void 0,void 0,!1,void 0,a),l=$("#"+s.pre+"dl_sequence2").html();$("#"+s.pre+"dl_sequence2").html(l+o.sequencesHtml),$("#"+s.pre+"dl_sequence2").width(n.htmlCls.RESIDUE_WIDTH*o.maxSeqCnt+200)}s.dAtoms=n.hashUtilsCls.cloneHash(p),s.hAtoms=n.hashUtilsCls.cloneHash(p);let f="protein_aligned";s.selectionCls.saveSelection(f,f),s.opts.color="identity",s.setColorCls.setColorByOptions(s.opts,s.hAtoms),n.htmlCls.dialogCls.openDlg("dl_alignment","Select residues in aligned sequences"),s.drawCls.draw(),s.transformCls.zoominSelection(),s.hlUpdateCls.updateHlAll()}transformStructure(e,t,i,s){let n=this.icn3d,r=n.icn3dui,a=n.structures[e];for(let e=0,o=a.length;e<o;++e)for(let o in n.chains[a[e]]){let e=n.atoms[o];void 0===n.q_rotation||!s&&(r.cfg.resnum||r.cfg.resdef)||(e=this.transformAtom(e,t,i))}}transformAtom(e,t,i){let s=this.icn3d,n=s.icn3dui;if("target"===i);else if("query"===i){"tmalign"!=n.cfg.aligntool&&(e.coord.x-=s.q_trans_sub[t].x,e.coord.y-=s.q_trans_sub[t].y,e.coord.z-=s.q_trans_sub[t].z);let i=e.coord.x*s.q_rotation[t].x1+e.coord.y*s.q_rotation[t].y1+e.coord.z*s.q_rotation[t].z1,r=e.coord.x*s.q_rotation[t].x2+e.coord.y*s.q_rotation[t].y2+e.coord.z*s.q_rotation[t].z2,a=e.coord.x*s.q_rotation[t].x3+e.coord.y*s.q_rotation[t].y3+e.coord.z*s.q_rotation[t].z3;"tmalign"!=n.cfg.aligntool?(i-=s.t_trans_add[t].x,r-=s.t_trans_add[t].y,a-=s.t_trans_add[t].z):(i+=s.q_trans_add[t].x,r+=s.q_trans_add[t].y,a+=s.q_trans_add[t].z),e.coord.x=i,e.coord.y=r,e.coord.z=a}return e}async downloadChainalignmentPart3(e,t,i){let s=this.icn3d,n=s.icn3dui,r={};for(let e in s.atoms)r[e]=1;if(s.dAtoms=r,s.hAtoms=r,s.setStyleCls.setAtomStyleByOptions(s.opts),s.opts.color="identity",s.setColorCls.setColorByOptions(s.opts,s.atoms),void 0!==e&&s.ParserUtilsCls.transformToOpmOriForAlign(s.selectedPdbid,e,!0),s.hAtoms=n.hashUtilsCls.cloneHash(i),s.dAtoms=n.hashUtilsCls.cloneHash(i),await s.ParserUtilsCls.renderStructure(),t.length>2){let e=s.firstAtomObjCls.getResiduesFromAtoms(i),t="protein_aligned",n="protein aligned",r="select "+s.resid2specCls.residueids2spec(Object.keys(e));s.selectionCls.addCustomSelection(Object.keys(e),t,n,r,!0)}s.hlUpdateCls.updateHlAll(),n.htmlCls.dialogCls.openDlg("dl_alignment","Select residues in aligned sequences"),void 0!==n.cfg.rotate&&s.resizeCanvasCls.rotStruc(n.cfg.rotate,!0),s.html2ddgm="",n.cfg.show2d&&s.bFullUi&&(n.htmlCls.dialogCls.openDlg("dl_2ddgm","Interactions"),s.bFullUi&&(s.bChainAlign?await s.ParserUtilsCls.set2DDiagramsForChainalign(t):s.ParserUtilsCls.download2Ddgm(s.inputid.toUpperCase())))}addPostfixForChainids(e){this.icn3d.icn3dui;let t={};for(let i=0,s=e.length;i<s;++i){let s=e[i],n=s.indexOf("_"),r=s.substr(0,n);t.hasOwnProperty(r)?++t[r]:t[r]=1,r=1==t[r]?r:r+t[r],e[i]=r+s.substr(n)}return e}addPostfixForStructureids(e){this.icn3d.icn3dui;let t={};for(let i=0,s=e.length;i<s;++i){let s=e[i].toUpperCase();t.hasOwnProperty(s)?++t[s]:t[s]=1,s=1==t[s]?s:s+t[s],e[i]=s}return e}async downloadChainalignment(e){let t=this.icn3d,i=t.icn3dui;t.opts.proteins="c alpha trace";let s=e.split(","),n=i.cfg.domainids?i.cfg.domainids.split(","):[];n.length<s.length&&(n=[]),t.chainidArray=this.addPostfixForChainids(s);let r=s[0].indexOf("_");t.mmdbid_t=s[0].substr(0,r).toUpperCase(),t.chain_t=s[0].substr(r+1);let a,o,l=[];t.mmdbid_t.length>5?(o="https://alphafold.ebi.ac.uk/files/AF-"+t.mmdbid_t+"-F1-model_"+t.AFUniprotVersion+".pdb",a=i.getAjaxPromise(o,"text")):(o=i.htmlCls.baseUrl+"mmdb/mmdb_strview.cgi?v=2&program=icn3d&b=1&s=1&ft=1&bu="+i.cfg.bu+"&uid="+t.mmdbid_t,void 0!==i.cfg.inpara&&(o+=i.cfg.inpara),a=i.getAjaxPromise(o,"jsonp")),l.push(a),t.ParserUtilsCls.setYourNote(e.toUpperCase()+" in iCn3D"),t.pdbid_chain2title={},void 0===t.chainids2resids&&(t.chainids2resids={}),t.afChainIndexHash={},t.pdbChainIndexHash={};for(let e=1,n=s.length;e<n;++e){let n,r,a=s[e].indexOf("_"),o=s[e].substr(0,a).toUpperCase();t.mmdbid_q=5==o.length?o.substr(0,4):o,t.chain_q=s[e].substr(a+1),t.mmdbid_q.length>5?(n="https://alphafold.ebi.ac.uk/files/AF-"+t.mmdbid_q+"-F1-model_"+t.AFUniprotVersion+".pdb",r=i.getAjaxPromise(n,"text")):(n=i.htmlCls.baseUrl+"mmdb/mmdb_strview.cgi?v=2&program=icn3d&b=1&s=1&ft=1&bu="+i.cfg.bu+"&uid="+t.mmdbid_q,void 0!==i.cfg.inpara&&(n+=i.cfg.inpara),r=i.getAjaxPromise(n,"jsonp")),l.push(r)}for(let e=1,r=s.length;e<r;++e){let r=s[e].indexOf("_"),a=s[e].substr(0,r).toUpperCase();if(t.mmdbid_q=5==a.length?a.substr(0,4):a,t.chain_q=s[e].substr(r+1),!i.cfg.resnum&&!i.cfg.resdef){let s=t.mmdbid_q+"_"+t.chain_q+","+t.mmdbid_t+"_"+t.chain_t,r=n.length>0?n[e]+","+n[0]:void 0;if("tmalign"!=i.cfg.aligntool&&4==t.mmdbid_t.length&&4==t.mmdbid_q.length){let o;o=n.length>0?i.htmlCls.baseUrl+"vastdyn/vastdyn.cgi?domainpairs="+r:i.htmlCls.baseUrl+"vastdyn/vastdyn.cgi?chainpairs="+s;let d=i.getAjaxPromise(o,"jsonp");l.push(d),t.pdbChainIndexHash[e]=a+"_"+t.chain_q+"_"+t.mmdbid_t+"_"+t.chain_t}else t.afChainIndexHash[e]=t.mmdbid_q+"_"+t.chain_q+"_"+t.mmdbid_t+"_"+t.chain_t}}let d=Promise.allSettled(l),c=await d;await this.parseChainAlignData(c,s,t.mmdbid_t,t.chain_t)}async parseChainAlignData(e,t,i,s){let n=this.icn3d,r=n.icn3dui,a=e[0].value,o="HEADER                                                        "+i+"\n";isNaN(i)&&i.length>5&&(a=o+a),n.t_trans_add=[],n.q_trans_sub=[],"tmalign"==r.cfg.aligntool&&(n.q_trans_add=[]),n.q_rotation=[],n.qt_start_end=[],n.mmdbidArray=[],n.mmdbidArray.push(i);let l=[];for(let i=1,s=t.length;i<s;++i){let s=e[i].value,r=t[i].indexOf("_"),a=t[i].substr(0,r).toUpperCase(),o="HEADER                                                        "+a+"\n";if(isNaN(a)&&a.length>5&&(s=o+s),void 0===s||-1!==JSON.stringify(s).indexOf("Oops there was a problem"))return void alert("The coordinate data can NOT be retrieved for the structure "+a+"...");n.mmdbidArray.push(a.substr(0,4)),l.push(s)}let d=0;for(let a=1,o=t.length;a<o;++a){let o=l[a-1],c=t[a].indexOf("_"),h=t[a].substr(0,c).toUpperCase(),p=t[a].substr(c+1);if(!r.cfg.resnum&&!r.cfg.resdef){let l=t.length+a-1;if(n.afChainIndexHash.hasOwnProperty(a))++d,"tmalign"==r.cfg.aligntool?n.q_trans_add[a-1]={x:0,y:0,z:0}:(n.t_trans_add[a-1]={x:0,y:0,z:0},n.q_trans_sub[a-1]={x:0,y:0,z:0}),n.q_rotation[a-1]={x1:1,y1:0,z1:0,x2:0,y2:1,z2:0,x3:0,y3:0,z3:1},n.qt_start_end[a-1]=void 0;else{let t=e[l-d].value,n=h.substr(0,4)==i.substr(0,4),c=p==s;r.htmlCls.clickMenuCls.setLogCmd("Align "+i+" with "+h,!1),this.processAlign(t,a-1,o,n,c)}}}n.mmdb_data_q=l,await this.loadOpmDataForChainalign(a,l,t,n.mmdbidArray)}processAlign(e,t,i,s,n,r){let a=this.icn3d,o=a.icn3dui,l=!1;if(!(e&&0!=e.length||r)){let e="tmalign"==o.cfg.aligntool?"TM-align":"VAST";return a.bRender&&alert("These chains can not be aligned by "+e+"."),l}if(void 0!==i&&-1===JSON.stringify(i).indexOf("Oops there was a problem")&&void 0!==e&&-1===JSON.stringify(e).indexOf("Oops there was a problem"))if(("error"===e||void 0===e||0==e.length)&&s&&n)a.t_trans_add[t]={x:0,y:0,z:0},a.q_trans_sub[t]={x:0,y:0,z:0},a.q_rotation[t]={x1:1,y1:0,z1:0,x2:0,y2:1,z2:0,x3:0,y3:0,z3:1},a.qt_start_end[t]=void 0;else if("error"===e||void 0===e||0==e.length)o.cfg.command||r||alert('These two chains can not align to each other. Please select sequences from these two chains in the "Sequences & Annotations" window, and click "Realign Selection" in the "File" menu to align your selection.'),a.t_trans_add[t]={x:0,y:0,z:0},a.q_trans_sub[t]={x:0,y:0,z:0},a.q_rotation[t]={x1:1,y1:0,z1:0,x2:0,y2:1,z2:0,x3:0,y3:0,z3:1},a.qt_start_end[t]=void 0,o.cfg.showanno=1,o.cfg.showalignseq=0;else{"tmalign"==o.cfg.aligntool?a.q_trans_add[t]=e[0].q_trans_add:(a.t_trans_add[t]=e[0].t_trans_add,a.q_trans_sub[t]=e[0].q_trans_sub),a.q_rotation[t]=e[0].q_rotation,a.qt_start_end[t]=e[0].segs;let i=e[0].super_rmsd,s=i?i.toPrecision(4):i,n=e[0].score?e[0].score.toPrecision(4):e[0].score,r="alignment RMSD: "+s;"tmalign"==o.cfg.aligntool&&(r+="; TM-score: "+n),o.htmlCls.clickMenuCls.setLogCmd(r,!1);let d="<br><b>Alignment RMSD</b>: "+s+" &#8491;<br>";"tmalign"==o.cfg.aligntool&&(d+="<b>TM-score</b>: "+n+"<br><br>",a.tmscore=n),$("#"+a.pre+"dl_rmsd_html").html(d),o.cfg.bSidebyside||o.htmlCls.dialogCls.openDlg("dl_rmsd","RMSD of alignment"),l=!0}return l}async loadOpmDataForChainalign(e,t,i,s){let n=this.icn3d,r=n.icn3dui,a=this;if(r.cfg.resnum||r.cfg.resdef||r.cfg.resrange)n.bCommandLoad||n.init(),await this.downloadChainalignmentPart2(e,t,void 0,i);else{let o=r.htmlCls.baseUrl+"vastdyn/vastdyn.cgi?mmdbids2opm="+s.join("','"),l=await r.getAjaxPromise(o,"jsonp");if(l&&l.mmdbid){let s=l.mmdbid;n.selectedPdbid=s;let o="https://opm-assets.storage.googleapis.com/pdb/"+s.toLowerCase()+".pdb",d=await r.getAjaxPromise(o,"text");n.bOpm=!0;let c=!0,h=n.loadPDBCls.loadPDB(d,s,n.bOpm,c);$("#"+n.pre+"selectplane_z1").val(n.halfBilayerSize),$("#"+n.pre+"selectplane_z2").val(-n.halfBilayerSize),$("#"+n.pre+"extra_mem_z").val(n.halfBilayerSize),$("#"+n.pre+"intra_mem_z").val(-n.halfBilayerSize),n.bCommandLoad||n.init(),await a.downloadChainalignmentPart2(e,t,h,i)}else n.bCommandLoad||n.init(),await a.downloadChainalignmentPart2(e,t,void 0,i)}}async downloadMmdbAf(e,t,i,s){let n=this.icn3d,r=n.icn3dui;n.structArray=n.structures?Object.keys(n.structures):[],0==n.structArray.length?n.init():(n.bResetAnno=!0,n.bResetSets=!0);let a=e.split(","),o=[];if(s)for(let e=0,t=a.length;e<t;++e){let t=a[e].toUpperCase();n.structures.hasOwnProperty(t)||o.push(a[e])}else o=this.addPostfixForStructureids(a);if(0==o.length)return;n.structArray=n.structArray.concat(o);let l=[];for(let e=0,t=o.length;e<t;++e){let t,i,s=o[e];if(isNaN(s)&&s.length>5)t="https://alphafold.ebi.ac.uk/files/AF-"+s+"-F1-model_"+n.AFUniprotVersion+".pdb",i=r.getAjaxPromise(t,"text");else{let e=s;5==s.length&&(e=s.substr(0,4)),t=r.htmlCls.baseUrl+"mmdb/mmdb_strview.cgi?v=2&program=icn3d&b=1&s=1&ft=1&bu="+r.cfg.bu+"&uid="+e,void 0!==r.cfg.inpara&&(t+=r.cfg.inpara),i=r.getAjaxPromise(t,"jsonp")}l.push(i)}n.ParserUtilsCls.setYourNote(n.structArray+" in iCn3D"),n.ParserUtilsCls.showLoading();let d=Promise.allSettled(l),c=await d;await this.parseMMdbAfData(c,o,t,i),void 0===i&&n.ParserUtilsCls.hideLoading()}async parseMMdbAfData(e,t,i,s){let n=this.icn3d,r=n.icn3dui,a=[];for(let i=0,s=t.length;i<s;++i){let s=e[i].value,n="HEADER                                                        "+t[i]+"\n";if(isNaN(t[i])&&t[i].length>5&&(s=n+s),void 0===s||-1!==JSON.stringify(s).indexOf("Oops there was a problem"))return void alert("The coordinate data can NOT be retrieved for the structure "+t[i]+"...");a.push(s)}let o=!1;for(let e=0,s=t.length;e<s;++e){let s,r;if(e==t.length-1&&(o=!0),0!=e||i||n.structArray.length!=t.length?(s="query",r=!0):(s="target",r=!1),isNaN(t[e])&&t[e].length>5){let i=!1;await n.pdbParserCls.loadPdbData(a[e],t[e],!1,r,s,o,i)}else{let i=!0,r=t[e];await n.mmdbParserCls.parseMmdbData(a[e],s,void 0,void 0,o,i,r)}}let l=Object.keys(n.structures);if(n.opts.color=l.length>1?"structure":l[0].length>5?"confidence":"chain",n.setColorCls.setColorByOptions(n.opts,{}),await n.ParserUtilsCls.renderStructure(),n.bAnnoShown&&(await n.showAnnoCls.showAnnotations(),n.annotationCls.resetAnnoTabAll()),void 0!==r.cfg.rotate&&n.resizeCanvasCls.rotStruc(r.cfg.rotate,!0),i&&r.cfg.matchedchains){n.hAtoms=n.definedSetsCls.getAtomsFromNameArray(n.chainidArray);let e=!0;await n.realignParserCls.realignOnStructAlign(void 0,e),$("#"+n.pre+"dl_annotations").html(""),n.bAnnoShown=!1,$("#"+r.pre+"dl_selectannotations").hasClass("ui-dialog-content")&&$("#"+n.pre+"dl_selectannotations").dialog("isOpen")&&$("#"+n.pre+"dl_selectannotations").dialog("close")}else if(void 0!==s){let e=Object.keys(n.structures);2==s&&(r.cfg.aligntool="tmalign"),await n.vastplusCls.vastplusAlign(e,s)}}}class Mh{constructor(e){this.icn3d=e}async dsn6Parser(e,t,i){this.icn3d.icn3dui;let s="https://edmaps.rcsb.org/maps/"+e.toLowerCase()+"_"+t+".dsn6";await this.dsn6ParserBase(s,t,i,"url",!0)}async dsn6ParserBase(e,t,i,s,n){let r=this.icn3d,a=r.icn3dui,o=this;if("2fofc"==t&&r.bAjax2fofc)r.mapData.sigma2=i,r.setOptionCls.setOption("map",t);else if("fofc"==t&&r.bAjaxfofc)r.mapData.sigma=i,r.setOptionCls.setOption("map",t);else{let l=await a.getXMLHttpRqstPromise(e,"GET","arraybuffer","rcsbEdmaps");i=o.loadDsn6Data(l,t,i,s,n),"2fofc"==t?r.bAjax2fofc=!0:"fofc"==t&&(r.bAjaxfofc=!0),r.setOptionCls.setOption("map",t)}return i}loadDsn6Data(e,t,i,s,n){let r,a,o=this.icn3d,l=o.icn3dui,d={},c=e.buffer&&e.buffer instanceof ArrayBuffer?e.buffer:e,h=new Int16Array(c),p=new Uint8Array(c),u=String.fromCharCode.apply(null,p.subarray(0,512));if(0==u.indexOf(":-)"))d.xStart=parseInt(u.substr(10,5)),d.yStart=parseInt(u.substr(15,5)),d.zStart=parseInt(u.substr(20,5)),d.xExtent=parseInt(u.substr(32,5)),d.yExtent=parseInt(u.substr(38,5)),d.zExtent=parseInt(u.substr(42,5)),d.xRate=parseInt(u.substr(52,5)),d.yRate=parseInt(u.substr(58,5)),d.zRate=parseInt(u.substr(62,5)),d.xlen=1*parseFloat(u.substr(73,10)),d.ylen=1*parseFloat(u.substr(83,10)),d.zlen=1*parseFloat(u.substr(93,10)),d.alpha=parseFloat(u.substr(103,10)),d.beta=parseFloat(u.substr(113,10)),d.gamma=parseFloat(u.substr(123,10)),r=parseFloat(u.substr(138,12))/100,a=parseInt(u.substr(155,8)),d.sigma=100*parseFloat(u.substr(170,12));else{if(100!==h[18])for(let e=0,t=h.length;e<t;++e){let t=h[e];h[e]=(255&t)<<8|t>>8&255}d.xStart=h[0],d.yStart=h[1],d.zStart=h[2],d.xExtent=h[3],d.yExtent=h[4],d.zExtent=h[5],d.xRate=h[6],d.yRate=h[7],d.zRate=h[8];let e=1/h[17],t=1*e;d.xlen=h[9]*t,d.ylen=h[10]*t,d.zlen=h[11]*t,d.alpha=h[12]*e,d.beta=h[13]*e,d.gamma=h[14]*e,r=h[15]/h[18],a=h[16]}l.bNode||console.log("header: "+JSON.stringify(d));let m=new Float32Array(d.xExtent*d.yExtent*d.zExtent),f=512,g=Math.ceil(d.xExtent/8),b=Math.ceil(d.yExtent/8),C=Math.ceil(d.zExtent/8),v=-999;for(let e=0;e<C;++e)for(let t=0;t<b;++t)for(let i=0;i<g;++i)for(let s=0;s<8;++s){let n=8*e+s;for(let e=0;e<8;++e){let s=8*t+e;for(let e=0;e<8;++e){let t=8*i+e;if(!(t<d.xExtent&&s<d.yExtent&&n<d.zExtent)){f+=8-e;break}{let e=(t*d.yExtent+s)*d.zExtent+n;m[e]=(p[f]-a)/r,m[e]>v&&(v=m[e]),++f}}}}return n||(i=this.setSigma(v,s,t,i)),"2fofc"==t?(o.mapData.header2=d,o.mapData.data2=m,o.mapData.matrix2=this.getMatrix(d),o.mapData.type2=t,o.mapData.sigma2=i):(o.mapData.header=d,o.mapData.data=m,o.mapData.matrix=this.getMatrix(d),o.mapData.type=t,o.mapData.sigma=i),i}setSigma(e,t,i,s){let n,r=this.icn3d.icn3dui;"file"==t?n="dsn6sigma"+i:"url"==t&&(n="dsn6sigmaurl"+i);return n&&($("#"+r.pre+n).val()?s=$("#"+r.pre+n).val():(s=(.2*e).toFixed(2),$("#"+r.pre+n).val(s))),s}getMatrix(e){this.icn3d.icn3dui;let t=e,i=[t.xlen,0,0],s=[t.ylen*Math.cos(Math.PI/180*t.gamma),t.ylen*Math.sin(Math.PI/180*t.gamma),0],n=[t.zlen*Math.cos(Math.PI/180*t.beta),t.zlen*(Math.cos(Math.PI/180*t.alpha)-Math.cos(Math.PI/180*t.gamma)*Math.cos(Math.PI/180*t.beta))/Math.sin(Math.PI/180*t.gamma),0];n[2]=Math.sqrt(t.zlen*t.zlen*Math.sin(Math.PI/180*t.beta)*Math.sin(Math.PI/180*t.beta)-n[1]*n[1]);let r=[[],i,s,n],a=[0,t.xRate,t.yRate,t.zRate],o=[0,1,2,3],l=new gi;return l.set(r[o[1]][0]/a[o[1]],r[o[2]][0]/a[o[2]],r[o[3]][0]/a[o[3]],0,r[o[1]][1]/a[o[1]],r[o[2]][1]/a[o[2]],r[o[3]][1]/a[o[3]],0,r[o[1]][2]/a[o[1]],r[o[2]][2]/a[o[2]],r[o[3]][2]/a[o[3]],0,0,0,0,1),l.multiply((new gi).makeTranslation(t.xStart,t.yStart,t.zStart)),l}loadDsn6File(e){var t=this.icn3d,i=t.icn3dui;let s=this,n=$("#"+t.pre+"dsn6file"+e)[0].files[0],r=$("#"+t.pre+"dsn6sigma"+e).val();if(n){i.utilsCls.checkFileAPI();let t=new FileReader;t.onload=function(t){let n=s.icn3d,a=t.target.result;r=s.loadDsn6Data(a,e,r,"file"),"2fofc"==e?n.bAjax2fofc=!0:"fofc"==e&&(n.bAjaxfofc=!0),n.setOptionCls.setOption("map",e),i.htmlCls.clickMenuCls.setLogCmd("load map file "+$("#"+n.pre+"dsn6file"+e).val()+" with sigma "+r,!1)},t.readAsArrayBuffer(n)}else alert("Please select a file before clicking 'Load'")}loadDsn6FileUrl(e){var t=this.icn3d,i=t.icn3dui;let s=$("#"+t.pre+"dsn6fileurl"+e).val(),n=$("#"+t.pre+"dsn6sigmaurl"+e).val();s?(n=this.dsn6ParserBase(s,e,n,"url"),i.htmlCls.clickMenuCls.setLogCmd("set map "+e+" sigma "+n+" file dsn6 | "+encodeURIComponent(s),!0)):alert("Please input the file URL before clicking 'Load'")}}class Th{constructor(e){this.icn3d=e}async ccp4ParserBase(e,t,i,s){let n=this.icn3d,r=n.icn3dui,a=await r.getXMLHttpRqstPromise(e,"GET","arraybuffer","");return i=this.load_map_from_buffer(a,t,i,s,!0),n.setOptionCls.setOption("map",t),i}load_map_from_buffer(e,t,i,s,n){let r=this.icn3d;if(r.icn3dui,e.byteLength<1024)throw Error("File shorter than 1024 bytes.");const a=new Int32Array(e,0,256);if(542130509!==a[52])throw Error("not a CCP4 map");const o=[a[0],a[1],a[2]],l=a[3];let d;if(2===l)d=4;else{if(0!==l)throw Error("Only Mode 2 and Mode 0 of CCP4 map is supported.");d=1}const c=[a[4],a[5],a[6]],h=[a[7],a[8],a[9]],p=a[23];if(1024+p+d*o[0]*o[1]*o[2]!==e.byteLength)throw Error("ccp4 file too short or too long");const u=new Float32Array(e,0,e.byteLength/4),m=new Rh(h),f=new Eh(u[10],u[11],u[12],u[13],u[14],u[15]),g=[a[16],a[17],a[18]],b=g.indexOf(1),C=g.indexOf(2),v=g.indexOf(3),_=u[19],y=u[20];if(p%4!=0)throw Error("CCP4 map with NSYMBT not divisible by 4 is not supported.");let S;S=2===l?u:new Int8Array(e);let w=(1024+p)/d|0,x=1,A=0;0===l&&-128===a[39]&&127===a[40]&&(x=(y-_)/255,A=.5*(_+y+x));const M=[c[0]+o[0],c[1]+o[1],c[2]+o[2]];let T=[0,0,0],E=-999;for(T[2]=c[2];T[2]<M[2];T[2]++)for(T[1]=c[1];T[1]<M[1];T[1]++)for(T[0]=c[0];T[0]<M[0];T[0]++){let e=x*S[w]+A;m.set_grid_value(T[b],T[C],T[v],e),e>E&&(E=e),w++}return n||(i=r.dsn6ParserCls.setSigma(E,s,t,i)),"2fofc"==t?(r.mapData.ccp4=1,r.mapData.grid2=m,r.mapData.unit_cell2=f,r.mapData.type2=t,r.mapData.sigma2=i):(r.mapData.ccp4=1,r.mapData.grid=m,r.mapData.unit_cell=f,r.mapData.type=t,r.mapData.sigma=i),i}load_maps_from_mtz_buffer(e,t,i,s,n,r){let a=this.icn3d;a.icn3dui;let o="fofc"==t,l=e.calculate_map(o),d=e.cell;const c=new Eh(d.a,d.b,d.c,d.alpha,d.beta,d.gamma);let h=-999;for(let e=0,t=l.length;e<t;++e)l[e]>h&&(h=l[e]);if(n||(i=a.dsn6ParserCls.setSigma(h,s,t,i)),r){a.mapData.ccp4=0;let s={xExtent:e.nx,yExtent:e.ny,zExtent:e.nz,mean:void 0,sigma:i,ccp4:1,xStart:0,yStart:0,zStart:0};s.xRate=e.nx,s.yRate=e.ny,s.zRate=e.nz,s.xlen=d.a,s.ylen=d.b,s.zlen=d.c,s.alpha=d.alpha,s.beta=d.beta,s.gamma=d.gamma,"2fofc"==t?(a.mapData.header2=s,a.mapData.data2=l,a.mapData.matrix2=a.dsn6ParserCls.getMatrix(s),a.mapData.type2=t,a.mapData.sigma2=i):(a.mapData.header=s,a.mapData.data=l,a.mapData.matrix=a.dsn6ParserCls.getMatrix(s),a.mapData.type=t,a.mapData.sigma=i)}else{const s=new Rh([e.nx,e.ny,e.nz]);s.values.set(l),"2fofc"==t?(a.mapData.ccp4=1,a.mapData.grid2=s,a.mapData.unit_cell2=c,a.mapData.type2=t,a.mapData.sigma2=i):(a.mapData.ccp4=1,a.mapData.grid=s,a.mapData.unit_cell=c,a.mapData.type=t,a.mapData.sigma=i)}return e.delete(),i}parse_symop(e){const t=e.toLowerCase().replace(/\s+/g,"").split(",");if(3!==t.length)throw Error("Unexpected symop: "+e);let i=[];for(let s=0;s<3;s++){const n=t[s].split(/(?=[+-])/);let r=[0,0,0,0];for(let t=0;t<n.length;t++){const i="-"===n[t][0]?-1:1;let s=n[t].match(/^[+-]?([xyz])$/);if(s){r[{x:0,y:1,z:2}[s[1]]]=i}else{if(s=n[t].match(/^[+-]?(\d)\/(\d)$/),!s)throw Error("What is "+n[t]+" in "+e);r[3]=i*Number(s[1])/Number(s[2])}}i.push(r)}return i}loadCcp4File(e){let t=this.icn3d,i=t.icn3dui,s=this,n=$("#"+t.pre+"dsn6file"+e)[0].files[0],r=$("#"+t.pre+"dsn6sigma"+e).val();if(n){i.utilsCls.checkFileAPI();let t=new FileReader;t.onload=function(t){let n=s.icn3d,a=t.target.result;r=s.load_map_from_buffer(a,e,r,"file"),n.setOptionCls.setOption("map",e),i.htmlCls.clickMenuCls.setLogCmd("load map file "+$("#"+n.pre+"dsn6file"+e).val()+" with sigma "+r,!1)},t.readAsArrayBuffer(n)}else alert("Please select a file before clicking 'Load'")}async loadCcp4FileUrl(e){let t=this.icn3d,i=t.icn3dui,s=$("#"+t.pre+"dsn6fileurl"+e).val(),n=$("#"+t.pre+"dsn6sigmaurl"+e).val();s?(n=await this.ccp4ParserBase(s,e,n,"file"),i.htmlCls.clickMenuCls.setLogCmd("set map "+e+" sigma "+n+" file ccp4 | "+encodeURIComponent(s),!0)):alert("Please input the file URL before clicking 'Load'")}extract_block(e,t,i,s,n){let r=this.icn3d;if(r.icn3dui,null==e||null==t)return;let a=t.fractionalize(s),o=[i/t.parameters[0],i/t.parameters[1],i/t.parameters[2]],l=e.frac2grid([a[0]-o[0],a[1]-o[1],a[2]-o[2]]),d=e.frac2grid([a[0]+o[0],a[1]+o[1],a[2]+o[2]]),c=[d[0]-l[0]+1,d[1]-l[1]+1,d[2]-l[2]+1],h=[],p=[],u=r.hAtoms&&Object.keys(r.hAtoms).length>0;for(let i=l[0];i<=d[0];i++)for(let s=l[1];s<=d[1];s++)for(let a=l[2];a<=d[2];a++){let o=e.grid2frac(i,s,a),l=t.orthogonalize(o);h.push(l);let d=new mt(l[0],l[1],l[2]),c=r.rayCls.getAtomsFromPosition(d,1,r.hAtoms)||!u?e.get_grid_value(i,s,a):0;"fofc_pos"==n&&c<0&&(c=0),"fofc_neg"==n&&(c=c>0?0:-c),p.push(c)}return{size:c,values:p,points:h}}marchingCubes(e,t,i,s,n){this.icn3d.icn3dui;const r=new Int32Array([0,0,514,770,1030,1030,1540,1796,2052,2053,2566,2566,3082,3331,3592,3840,144,152,658,658,1174,1182,1684,1684,2196,2196,2710,2710,3226,3218,3729,3728,560,560,51,314,1590,1590,1076,1084,2612,2613,2103,2358,3642,3890,3121,3376,672,680,163,170,1702,1711,1444,1196,2724,2724,2470,2214,4010,3747,3233,3232,1120,1120,1634,1890,102,102,613,868,3172,3173,3686,3686,2154,2147,2665,2656,1264,1272,1778,1778,246,254,757,764,3316,3316,3830,3830,2298,2291,2809,2800,1616,1616,1107,1362,598,598,84,340,3668,3924,3159,3414,2650,2898,2137,2384,1984,1729,1474,1218,966,718,197,196,4036,3781,3526,3270,3018,2754,2241,2240,2240,2240,2754,3010,3270,3270,3780,4044,196,197,710,966,1218,1474,1729,1984,2384,2137,2898,2650,3414,3159,3668,3676,340,84,606,598,1362,1107,1624,1616,2800,2800,2291,2298,3830,3830,3316,3324,756,1013,255,502,1778,1779,1273,1520,2656,2665,2147,2154,3686,3687,3429,3180,868,613,358,102,1898,1635,1120,1120,3232,3232,3746,4002,2214,2214,2724,2980,1196,1444,1710,1958,170,163,680,672,3376,3121,3890,3642,2358,2103,2869,2612,1084,1076,1854,1590,314,51,825,560,3728,3728,3218,3226,2710,2710,2196,2204,1684,1685,1183,1174,658,914,152,144,3840,3592,3331,3082,2566,2574,2053,2052,1796,1540,1286,1030,770,514,0,0]),a="snapped MC"===n,o=[[],[],[1,9],[1,8,1,9],[2,10,10,1],[2,10,10,1],[9,2,2,10,10,9],[2,8,2,10,10,8,10,9],[11,2],[0,11,11,2],[1,9,11,2],[1,11,11,2,1,9,9,11],[3,10,10,1,11,10],[0,10,10,1,8,10,11,10],[3,9,11,9,11,10,10,9],[8,10,10,9,11,10],[4,7],[4,3,4,7],[1,9,4,7],[4,1,1,9,4,7,7,1],[2,10,10,1,4,7],[3,4,4,7,2,10,10,1],[9,2,2,10,10,9,4,7],[2,10,10,9,9,2,9,7,7,2,4,7],[4,7,11,2],[11,4,4,7,11,2,2,4],[1,9,4,7,11,2],[4,7,11,4,11,9,11,2,2,9,1,9],[3,10,10,1,11,10,4,7],[1,11,11,10,10,1,1,4,4,11,4,7],[4,7,0,11,11,9,11,10,10,9],[4,7,11,4,11,9,11,10,10,9],[9,5,5,4],[9,5,5,4],[0,5,5,4,1,5],[8,5,5,4,3,5,1,5],[2,10,10,1,9,5,5,4],[2,10,10,1,9,5,5,4],[5,2,2,10,10,5,5,4,4,2],[2,10,10,5,5,2,5,3,5,4,4,3],[9,5,5,4,11,2],[0,11,11,2,9,5,5,4],[0,5,5,4,1,5,11,2],[1,5,5,2,5,8,8,2,11,2,5,4],[10,3,11,10,10,1,9,5,5,4],[9,5,5,4,8,1,8,10,10,1,11,10],[5,4,0,5,0,11,11,5,11,10,10,5],[5,4,8,5,8,10,10,5,11,10],[9,7,5,7,9,5],[9,3,9,5,5,3,5,7],[0,7,1,7,1,5,5,7],[1,5,5,3,5,7],[9,7,9,5,5,7,10,1,2,10],[10,1,2,10,9,5,5,0,5,3,5,7],[2,8,2,5,5,8,5,7,10,5,2,10],[2,10,10,5,5,2,5,3,5,7],[7,9,9,5,5,7,11,2],[9,5,5,7,7,9,7,2,2,9,11,2],[11,2,1,8,1,7,1,5,5,7],[11,2,1,11,1,7,1,5,5,7],[9,5,5,8,5,7,10,1,3,10,11,10],[5,7,7,0,0,5,9,5,11,0,0,10,10,1,11,10],[11,10,10,0,0,11,10,5,5,0,0,7,5,7],[11,10,10,5,5,11,5,7],[10,6,6,5,5,10],[5,10,10,6,6,5],[1,9,5,10,10,6,6,5],[1,8,1,9,5,10,10,6,6,5],[1,6,6,5,5,1,2,6],[1,6,6,5,5,1,2,6],[9,6,6,5,5,9,0,6,2,6],[5,9,8,5,8,2,2,5,2,6,6,5],[11,2,10,6,6,5,5,10],[11,0,11,2,10,6,6,5,5,10],[1,9,11,2,5,10,10,6,6,5],[5,10,10,6,6,5,1,9,9,2,9,11,11,2],[6,3,11,6,6,5,5,3,5,1],[11,0,11,5,5,0,5,1,11,6,6,5],[11,6,6,3,6,0,6,5,5,0,5,9],[6,5,5,9,9,6,9,11,11,6],[5,10,10,6,6,5,4,7],[4,3,4,7,6,5,5,10,10,6],[1,9,5,10,10,6,6,5,4,7],[10,6,6,5,5,10,1,9,9,7,7,1,4,7],[6,1,2,6,6,5,5,1,4,7],[2,5,5,1,2,6,6,5,4,3,4,7],[4,7,0,5,5,9,0,6,6,5,2,6],[3,9,9,7,4,7,2,9,5,9,9,6,6,5,2,6],[11,2,4,7,10,6,6,5,5,10],[5,10,10,6,6,5,4,7,7,2,2,4,11,2],[1,9,4,7,11,2,5,10,10,6,6,5],[9,2,1,9,9,11,11,2,4,11,4,7,5,10,10,6,6,5],[4,7,11,5,5,3,5,1,11,6,6,5],[5,1,1,11,11,5,11,6,6,5,0,11,11,4,4,7],[0,5,5,9,0,6,6,5,3,6,11,6,4,7],[6,5,5,9,9,6,9,11,11,6,4,7,7,9],[10,4,9,10,6,4,10,6],[4,10,10,6,6,4,9,10],[10,0,1,10,10,6,6,0,6,4],[1,8,1,6,6,8,6,4,1,10,10,6],[1,4,9,1,2,4,2,6,6,4],[2,9,9,1,2,4,2,6,6,4],[2,4,2,6,6,4],[2,8,2,4,2,6,6,4],[10,4,9,10,10,6,6,4,11,2],[8,2,11,2,9,10,10,4,10,6,6,4],[11,2,1,6,6,0,6,4,1,10,10,6],[6,4,4,1,1,6,1,10,10,6,8,1,1,11,11,2],[9,6,6,4,9,3,3,6,9,1,11,6],[11,1,1,8,11,6,6,1,9,1,1,4,6,4],[11,6,6,3,6,0,6,4],[6,4,8,6,11,6],[7,10,10,6,6,7,8,10,9,10],[0,7,0,10,10,7,9,10,6,7,10,6],[10,6,6,7,7,10,1,10,7,1,8,1],[10,6,6,7,7,10,7,1,1,10],[2,6,6,1,6,8,8,1,9,1,6,7],[2,6,6,9,9,2,9,1,6,7,7,9,9,3],[0,7,0,6,6,7,2,6],[2,7,6,7,2,6],[11,2,10,6,6,8,8,10,9,10,6,7],[0,7,7,2,11,2,9,7,6,7,7,10,10,6,9,10],[1,8,1,7,1,10,10,7,6,7,10,6,11,2],[11,2,1,11,1,7,10,6,6,1,1,10,6,7],[9,6,6,8,6,7,9,1,1,6,11,6,6,3],[9,1,11,6,6,7],[0,7,0,6,6,7,11,0,11,6],[11,6,6,7],[7,6,6,11],[7,6,6,11],[1,9,7,6,6,11],[8,1,1,9,7,6,6,11],[10,1,2,10,6,11,7,6],[2,10,10,1,6,11,7,6],[2,9,2,10,10,9,6,11,7,6],[6,11,7,6,2,10,10,3,10,8,10,9],[7,2,6,2,7,6],[7,0,7,6,6,0,6,2],[2,7,7,6,6,2,1,9],[1,6,6,2,1,8,8,6,1,9,7,6],[10,7,7,6,6,10,10,1,1,7],[10,7,7,6,6,10,1,7,10,1,1,8],[7,0,7,10,10,0,10,9,6,10,7,6],[7,6,6,10,10,7,10,8,10,9],[6,8,4,6,6,11],[3,6,6,11,0,6,4,6],[8,6,6,11,4,6,1,9],[4,6,6,9,6,3,3,9,1,9,6,11],[6,8,4,6,6,11,2,10,10,1],[2,10,10,1,0,11,0,6,6,11,4,6],[4,11,4,6,6,11,2,9,2,10,10,9],[10,9,9,3,3,10,2,10,4,3,3,6,6,11,4,6],[8,2,4,2,4,6,6,2],[4,2,4,6,6,2],[1,9,3,4,4,2,4,6,6,2],[1,9,4,1,4,2,4,6,6,2],[8,1,8,6,6,1,4,6,6,10,10,1],[10,1,0,10,0,6,6,10,4,6],[4,6,6,3,3,4,6,10,10,3,3,9,10,9],[10,9,4,10,6,10,4,6],[9,5,5,4,7,6,6,11],[9,5,5,4,7,6,6,11],[5,0,1,5,5,4,7,6,6,11],[7,6,6,11,3,4,3,5,5,4,1,5],[9,5,5,4,10,1,2,10,7,6,6,11],[6,11,7,6,2,10,10,1,9,5,5,4],[7,6,6,11,5,4,4,10,10,5,4,2,2,10],[3,4,3,5,5,4,2,5,10,5,2,10,7,6,6,11],[7,2,7,6,6,2,5,4,9,5],[9,5,5,4,8,6,6,0,6,2,7,6],[3,6,6,2,7,6,1,5,5,0,5,4],[6,2,2,8,8,6,7,6,1,8,8,5,5,4,1,5],[9,5,5,4,10,1,1,6,6,10,1,7,7,6],[1,6,6,10,10,1,1,7,7,6,0,7,9,5,5,4],[0,10,10,4,10,5,5,4,3,10,6,10,10,7,7,6],[7,6,6,10,10,7,10,8,5,4,4,10,10,5],[6,9,9,5,5,6,6,11,11,9],[3,6,6,11,0,6,0,5,5,6,9,5],[0,11,0,5,5,11,1,5,5,6,6,11],[6,11,3,6,3,5,5,6,1,5],[2,10,10,1,9,5,5,11,11,9,5,6,6,11],[0,11,0,6,6,11,9,6,5,6,9,5,2,10,10,1],[8,5,5,11,5,6,6,11,0,5,10,5,5,2,2,10],[6,11,3,6,3,5,5,6,2,10,10,3,10,5],[5,8,9,5,5,2,2,8,5,6,6,2],[9,5,5,6,6,9,6,0,6,2],[1,5,5,8,8,1,5,6,6,8,8,2,6,2],[1,5,5,6,6,1,6,2],[3,6,6,1,6,10,10,1,8,6,5,6,6,9,9,5],[10,1,0,10,0,6,6,10,9,5,5,0,5,6],[5,6,6,10,10,5],[10,5,5,6,6,10],[11,5,5,10,10,11,7,5],[11,5,5,10,10,11,7,5],[5,11,7,5,5,10,10,11,1,9],[10,7,7,5,5,10,10,11,8,1,1,9],[11,1,2,11,7,1,7,5,5,1],[2,7,7,1,7,5,5,1,2,11],[9,7,7,5,5,9,9,2,2,7,2,11],[7,5,5,2,2,7,2,11,5,9,9,2,2,8],[2,5,5,10,10,2,3,5,7,5],[8,2,8,5,5,2,7,5,10,2,5,10],[1,9,5,10,10,3,3,5,7,5,10,2],[8,2,2,9,1,9,7,2,10,2,2,5,5,10,7,5],[3,5,5,1,7,5],[7,0,7,1,7,5,5,1],[3,9,3,5,5,9,7,5],[7,9,5,9,7,5],[5,8,4,5,5,10,10,8,10,11],[5,0,4,5,5,11,11,0,5,10,10,11],[1,9,4,10,10,8,10,11,4,5,5,10],[10,11,11,4,4,10,4,5,5,10,3,4,4,1,1,9],[2,5,5,1,2,8,8,5,2,11,4,5],[4,11,11,0,4,5,5,11,2,11,11,1,5,1],[2,5,5,0,5,9,2,11,11,5,4,5,5,8],[4,5,5,9,2,11],[2,5,5,10,10,2,3,5,3,4,4,5],[5,10,10,2,2,5,2,4,4,5],[3,10,10,2,3,5,5,10,8,5,4,5,1,9],[5,10,10,2,2,5,2,4,4,5,1,9,9,2],[4,5,5,8,5,3,5,1],[4,5,5,0,5,1],[4,5,5,8,5,3,0,5,5,9],[4,5,5,9],[4,11,7,4,9,11,9,10,10,11],[9,7,7,4,9,11,9,10,10,11],[1,10,10,11,11,1,11,4,4,1,7,4],[1,4,4,3,1,10,10,4,7,4,4,11,10,11],[4,11,7,4,9,11,9,2,2,11,9,1],[9,7,7,4,9,11,9,1,1,11,2,11],[7,4,4,11,4,2,2,11],[7,4,4,11,4,2,2,11,3,4],[2,9,9,10,10,2,2,7,7,9,7,4],[9,10,10,7,7,9,7,4,10,2,2,7,7,0],[7,10,10,3,10,2,7,4,4,10,1,10,10,0],[1,10,10,2,7,4],[9,1,1,4,1,7,7,4],[9,1,1,4,1,7,7,4,8,1],[3,4,7,4],[7,4],[9,10,10,8,10,11],[9,3,9,11,9,10,10,11],[1,10,10,0,10,8,10,11],[1,10,10,3,10,11],[2,11,11,1,11,9,9,1],[9,3,9,11,2,9,9,1,2,11],[2,11,11,0],[2,11],[8,2,8,10,10,2,9,10],[9,10,10,2,2,9],[8,2,8,10,10,2,1,8,1,10],[1,10,10,2],[8,1,9,1],[9,1],[],[]];let l=new Array(12);const d=this.calculateVertOffsets(e),c=[[0,1],[1,2],[2,3],[3,0],[4,5],[5,6],[6,7],[7,4],[0,4],[1,5],[2,6],[3,7]];let h=new Float32Array(8),p=[0,0,0],u=[p,p,p,p,p,p,p,p];const m=e[0],f=e[1],g=e[2];if(null==t||null==i)return;let b=[],C=[],v=0;for(let e=0;e<m-1;e++)for(let n=0;n<f-1;n++)for(let p=0;p<g-1;p++){const m=p+g*(n+f*e);let _,y,S=0;for(_=0;_<8;++_)y=m+d[_],S|=t[y]<s?1<<_:0;if(0===S||255===S)continue;for(_=0;_<8;++_)y=m+d[_],h[_]=t[y],u[_]=i[y];const w=r[S];for(_=0;_<12;++_)if(w&1<<_){const e=c[_];let t=(s-h[e[0]])/(h[e[1]]-h[e[0]]);!0===a&&(t>.85?t=1:t<.15&&(t=0));const i=u[e[0]],n=u[e[1]];b.push(i[0]+(n[0]-i[0])*t,i[1]+(n[1]-i[1])*t,i[2]+(n[2]-i[2])*t),l[_]=v++}const x=o[S];for(_=0;_<x.length;_++)C.push(l[x[_]])}return{vertices:b,segments:C}}calculateVertOffsets(e){this.icn3d.icn3dui;let t=[];const i=[[0,0,0],[1,0,0],[1,1,0],[0,1,0],[0,0,1],[1,0,1],[1,1,1],[0,1,1]];for(let s=0;s<8;++s){const n=i[s];t.push(n[0]+e[2]*(n[1]+e[1]*n[2]))}return t}makeChickenWire(e,t){let i=this.icn3d,s=i.icn3dui,n=new Ts,r=new Float32Array(e.vertices);n.setAttribute("position",new gs(r,3));let a=e.vertices.length<196608?new Uint16Array(e.segments):new Uint32Array(e.segments);n.setIndex(new gs(a,1));let o=s.parasCls.thr("#00FFFF"),l=s.parasCls.thr("#00FF00"),d=s.parasCls.thr("#ff0000"),c=new Ln({linewidth:1,color:"2fofc"==t?o:"fofc_pos"==t?l:d}),h=new Wn(n,c);i.mdl.add(h),i.prevMaps.push(h)}}class Eh{constructor(e,t,i,s,n,r){if(e<=0||t<=0||i<=0||s<=0||n<=0||r<=0)throw Error("Zero or negative unit cell parameter(s).");this.parameters=[e,t,i,s,n,r];const a=Math.PI/180,o=Math.cos(a*s),l=Math.cos(a*n),d=Math.cos(a*r),c=Math.sin(a*s),h=Math.sin(a*n),p=Math.sin(a*r);if(0===c||0===h||0===p)throw Error("Impossible angle - N*180deg.");const u=(l*d-o)/p,m=u/h,f=Math.sqrt(1-m*m);this.orth=[e,t*d,i*l,0,t*p,-i*u,0,0,i*h*f],this.frac=[1/e,-d/(p*e),-(d*u+l*p)/(h*f*p*e),0,1/(p*t),m/(f*p*t),0,0,1/(h*f*i)]}multiply(e,t){return[t[0]*e[0]+t[1]*e[1]+t[2]*e[2],+t[4]*e[1]+t[5]*e[2],+t[8]*e[2]]}fractionalize(e){return this.multiply(e,this.frac)}orthogonalize(e){return this.multiply(e,this.orth)}}class Rh{constructor(e){this.dim=e,this.values=new Float32Array(e[0]*e[1]*e[2])}modulo(e,t){const i=e%t;return i>=0?i:i+t}grid2index(e,t,i){return e=this.modulo(e,this.dim[0]),t=this.modulo(t,this.dim[1]),i=this.modulo(i,this.dim[2]),this.dim[2]*(this.dim[1]*e+t)+i}grid2index_unchecked(e,t,i){return this.dim[2]*(this.dim[1]*e+t)+i}grid2frac(e,t,i){return[e/this.dim[0],t/this.dim[1],i/this.dim[2]]}frac2grid(e){return[0|Math.floor(e[0]*this.dim[0]),0|Math.floor(e[1]*this.dim[1]),0|Math.floor(e[2]*this.dim[2])]}set_grid_value(e,t,i,s){const n=this.grid2index(e,t,i);this.values[n]=s}get_grid_value(e,t,i){const s=this.grid2index(e,t,i);return this.values[s]}}class kh{constructor(e){this.icn3d=e}async mtzParserBase(e,t,i,s,n,r){let a=this.icn3d,o=a.icn3dui,l=await o.getXMLHttpRqstPromise(e,"GET","arraybuffer","");return i=await this.loadMtzFileBase(l,t,i,s,n,e,r),a.setOptionCls.setOption("map",t),i}loadMtzFile(e,t){var i=this.icn3d,s=i.icn3dui;let n=this,r=$("#"+i.pre+"dsn6file"+e)[0].files[0],a=$("#"+i.pre+"dsn6sigma"+e).val();if(r){s.utilsCls.checkFileAPI();let i=new FileReader;i.onload=async function(i){let r=n.icn3d;a=await n.loadMtzFileBase(i.target.result,e,a,"file",void 0,void 0,t),s.htmlCls.clickMenuCls.setLogCmd("load map file "+$("#"+r.pre+"dsn6file"+e).val()+" with sigma "+a,!1)},i.readAsArrayBuffer(r)}else alert("Please select a file before clicking 'Load'")}async loadMtzFileBase(e,t,i,s,n,r,a){var o=this.icn3d,l=o.icn3dui;if(void 0===o.bMtz){let e="./script/mtz.js";await l.getAjaxPromise(e,"script"),o.bMtz=!0}GemmiMtz().then((function(d){let c=d.readMtz(e);i=o.ccp4ParserCls.load_maps_from_mtz_buffer(c,t,i,s,n,a),o.setOptionCls.setOption("map",t);let h=a?"rcsbmtz":"mtz";return r&&l.htmlCls.clickMenuCls.setLogCmd("set map "+t+" sigma "+i+" file "+h+" | "+encodeURIComponent(r),!0),i}))}async loadMtzFileUrl(e,t){var i=this.icn3d;i.icn3dui;let s=$("#"+i.pre+"dsn6fileurl"+e).val(),n=$("#"+i.pre+"dsn6sigmaurl"+e).val();s?n=await this.mtzParserBase(s,e,n,"url",void 0,t):alert("Please input the file URL before clicking 'Load'")}}class Oh{constructor(e){this.icn3d=e}async downloadMmcif(e){let t=this.icn3d,i=t.icn3dui;t.ParserUtilsCls.setYourNote(e.toUpperCase()+"(MMCIF) in iCn3D");let s="https://files.rcsb.org/download/"+e+".cif",n=await i.getAjaxPromise(s,"text",!0);await t.opmParserCls.loadOpmData(n,e,void 0,"mmcif",void 0,!0)}async downloadMmcifSymmetry(e,t){let i=this.icn3d,s=i.icn3dui;try{let n="https://models.rcsb.org/"+e+".bcif",r=await s.getXMLHttpRqstPromise(n,"GET","arraybuffer","bcif"),a=!1,o=!0,l=i.bcifParserCls.getBcifJson(r,e,a,o),d=JSON.parse(l);if(void 0!==d.emd&&(i.emd=d.emd),void 0!==d.organism&&(i.organism=d.organism),i.bAssemblyUseAsu){for(let e=0,t=d.assembly.length;e<t;++e){let t=new gi;t.fromArray(d.assembly[e]),i.biomtMatrices[e]=t}i.asuCnt=i.biomtMatrices.length,1==s.cfg.bu&&Object.keys(i.atoms).length*i.asuCnt>i.maxatomcnt&&(i.bAssembly=!0)}if("mmtfid"===t&&void 0!==d.missingseq){let t=0,n="";for(let r=0,a=d.missingseq.length;r<a;++r){let a=d.missingseq[r].resn,o=d.missingseq[r].chain,l=d.missingseq[r].resi,c=e+"_"+o;void 0===i.chainMissingResidueArray[c]&&(i.chainMissingResidueArray[c]=[]);let h={};h.resi=l,h.name=s.utilsCls.residueName2Abbr(a).toLowerCase(),o!=n&&(t=0),!isNaN(l)&&(""==n||o!=n||o==n&&l>t)&&(i.chainMissingResidueArray[c].push(h),t=l,n=o)}i.loadPDBCls.adjustSeq(i.chainMissingResidueArray)}}catch(e){return void(s.bNode||console.log("mmcifparser.cgi issues: "+e))}}async loadMmcifData(e,t){let i=this.icn3d;if(i.icn3dui,t||(t=e.mmcif),t||(t=i.defaultPdbId),void 0===e.atoms)return!1;i.init(),void 0!==e.emd&&(i.emd=e.emd),void 0!==e.organism&&(i.organism=e.organism),await i.opmParserCls.loadOpmData(e,t,void 0,"mmcif"),i.opmParserCls.modifyUIMapAssembly()}async loadMultipleMmcifData(e,t,i){let s=this.icn3d;s.icn3dui;s.loadCIFCls.loadCIF(e,t,!0,i),Object.keys(s.structures).length>1&&(s.opts.color="structure"),s.opmParserCls.modifyUIMapAssembly(),s.pdbParserCls.addSecondary(i)}}class Ih{constructor(e){this.icn3d=e}async downloadMmdb(e,t){let i,s=this.icn3d,n=s.icn3dui;try{if(i=await this.loadMmdbPrms(e,t),!i||i.error)return void this.getNoData(e,t)}catch(i){return void this.getNoData(e,t)}if(0!=Object.keys(i.atoms).length)if(n.utilsCls.isCalphaPhosOnly(i.atoms)||i.atomCount<=s.maxatomcnt)await this.parseMmdbData(i);else{let i;try{i=await this.loadMmdbPrms(e,t,!0)}catch(i){return void this.getNoData(e,t)}await this.parseMmdbData(i)}else{let e=i.pdbId;await s.bcifParserCls.downloadBcif(e)}}async downloadGi(e){let t=this.icn3d;t.icn3dui,t.bCid=void 0;await this.downloadMmdb(e,!0)}async downloadBlast_rep_id(e){let t=this.icn3d,i=t.icn3dui,s=e.split(",");i.cfg.query_id=s[0],i.cfg.blast_rep_id=s[1];let n=i.cfg.blast_rep_id.split("_")[0];4==n.length?await this.downloadMmdb(n):(t.blastAcxn=i.cfg.blast_rep_id.split(".")[0],await this.downloadRefseq(t.blastAcxn,!0))}async downloadRefseq(e,t){let i=this.icn3d,s=i.icn3dui,n=s.htmlCls.baseUrl+"vastdyn/vastdyn.cgi?refseq2uniprot="+e;s.cfg.refseqid=e;let r=await s.getAjaxPromise(n,"jsonp",!1,"The protein accession "+e+" can not be mapped to AlphaFold UniProt ID...");if(!r||!r.uniprot)return void alert("The accession "+e+" can not be mapped to AlphaFold UniProt ID. It will be treated as a UniProt ID instead.");s.cfg.afid=r.uniprot,i.uniprot2acc||(i.uniprot2acc={}),i.uniprot2acc[r.uniprot]=e,t&&(s.cfg.blast_rep_id=s.cfg.afid+"_A");await i.pdbParserCls.downloadPdb(s.cfg.afid,!0)}async downloadProteinname(e){let t=this.icn3d,i=t.icn3dui;i.icn3d.bCid=void 0;let s=i.htmlCls.baseUrl+"vastdyn/vastdyn.cgi?protein2acc="+e,n=(await i.getAjaxPromise(s,"jsonp")).acc;if(0==n.length)return void(i.bNode||alert("The protein/gene name "+e+" can not be mapped to RefSeq proteins..."));let r=[];for(let e=0,t=n.length;e<t;++e){let t=n[e];s=i.htmlCls.baseUrl+"vastdyn/vastdyn.cgi?refseq2uniprot="+t;let a=i.getAjaxPromise(s,"jsonp");r.push(a)}let a=Promise.allSettled(r),o=await a;r=[];let l=[];for(let e=0,n=o.length;e<n;++e){let n=o[e].value;if(n&&n.uniprot){let e=n.uniprot;s="https://alphafold.ebi.ac.uk/files/AF-"+e+"-F1-model_"+t.AFUniprotVersion+".pdb",t.ParserUtilsCls.setYourNote(i.cfg.protein+"(NCBI Protein/Gene) in iCn3D");let a=i.getAjaxPromise(s,"text",!0);r.push(a),l.push(e)}}a=Promise.allSettled(r),o=await a;for(let e=0,s=o.length;e<s;++e){let s=o[e].value;if(i.cfg.afid=l[e],s){s="HEADER                                                        "+i.cfg.afid+"\n"+s,await t.opmParserCls.parseAtomData(s,i.cfg.afid,void 0,"pdb",void 0);break}}i.cfg.afid||i.bNode||alert("The protein/gene name "+e+" can not be mapped to AlphaFold structures...")}getNoData(e,t){let i=this.icn3d.icn3dui;t?alert("This gi "+e+" has no corresponding 3D structure..."):alert("This mmdbid "+e+" with the parameters "+i.cfg.inpara+" may not have 3D structure data. Please visit the summary page for details: "+i.htmlCls.baseUrl+"pdb/"+e)}async parseMmdbData(e,t,i,s,n,r,a){let o,l=this.icn3d,d=l.icn3dui,c=void 0!==e.pdbId?e.pdbId:e.mmdbId;if(a&&(c=a),this.parseMmdbDataPart1(e,t),void 0===t?(void 0!==e.opm&&void 0!==e.opm.rot&&(l.bOpm=!0,l.opmParserCls.setOpmData(e)),o=l.loadAtomDataCls.loadAtomDataIn(e,c,"mmdbid",void 0,t)):(i&&(c=i.substr(0,i.indexOf("_"))),o=l.loadAtomDataCls.loadAtomDataIn(e,c,"mmdbid",void 0,t,i,s,n,r)),d.cfg.ligand)for(let e in l.chainid2sid)if(l.chainid2sid[e]==d.cfg.ligand.substr(3)){let t=l.firstAtomObjCls.getResiduesFromAtoms(l.chains[e]),i=Object.keys(t)[0].split("_"),s="."+i[1]+":"+i[2];await l.selByCommCls.selectByCommand(s,d.cfg.ligand,d.cfg.ligand);break}l.hAtoms=o;let h=e.pdbId;void 0===t&&l.ParserUtilsCls.setYourNote(h.toUpperCase()+"(MMDB) in iCn3D");for(let t in e.domains){let i=e.domains[t].chain,s=h+"_"+i,n=e.domains[t].domains;for(let e=0,t=n.length;e<t;++e){let t=h+"_"+i+"_3d_domain_"+(e+1).toString();l.tddomains[t]={};let r=n[e].intervals,a={},o={};for(let e=0,i=r.length;e<i;++e){let i=Math.round(r[e][0])-1,n=Math.round(r[e][1])-1;if(!a.hasOwnProperty(i)&&!o.hasOwnProperty(n)){a[i]=1,o[n]=1;for(let e=i;e<=n;++e){let i,n=s+"_"+(e+1).toString();i=l.ncbi2resid[n],i&&(l.tddomains[t][i]=1)}}}}}return l.bAssemblyUseAsu=void 0!==e.asuAtomCount,void 0!==t?l.bAssemblyUseAsu=!1:await l.mmcifParserCls.downloadMmcifSymmetry(c),l.bAssemblyUseAsu&&$("#"+l.pre+"assemblyWrapper").show(),void 0!==l.emd?($("#"+l.pre+"mapWrapper1").hide(),$("#"+l.pre+"mapWrapper2").hide(),$("#"+l.pre+"mapWrapper3").hide()):($("#"+l.pre+"emmapWrapper1").hide(),$("#"+l.pre+"emmapWrapper2").hide(),$("#"+l.pre+"emmapWrapper3").hide()),l.setStyleCls.setAtomStyleByOptions(l.opts),void 0!==d.cfg.blast_rep_id?l.setColorCls.setColorByOptions(l.opts,l.atoms):l.setColorCls.setColorByOptions(l.opts,l.atoms,!0),void 0===t&&(await l.ParserUtilsCls.renderStructure(),void 0!==d.cfg.rotate&&l.resizeCanvasCls.rotStruc(d.cfg.rotate,!0),l.html2ddgm="",d.cfg.show2d&&(d.htmlCls.dialogCls.openDlg("dl_2ddgm","Interactions"),l.bFullUi&&l.ParserUtilsCls.download2Ddgm(l.inputid.toUpperCase()))),void 0!==d.cfg.align&&void 0!==d.cfg.chainalign&&void 0!==d.cfg.mmdbafid||1!=Object.keys(l.structures).length||null!==$("#"+l.pre+"alternateWrapper")&&$("#"+l.pre+"alternateWrapper").hide(),o}parseMmdbDataPart1(e,t){let i=this.icn3d,s=i.icn3dui;if(void 0===e.atoms&&void 0===e.molid2rescount)return alert("invalid MMDB data."),!1;if(void 0===t||"target"===t){let e=!!i.bCommandLoad;i.bStatefile||i.init(e),i.chainsColor={},i.chainsGene={}}"query"===t||(i.interactionData={moleculeInfor:e.moleculeInfor,intrac:e.intrac,intracResidues:e.intracResidues}),"query"===t||(i.mmdb_data=e);let n=void 0!==e.pdbId?e.pdbId:e.mmdbId;"query"===t?i.inputid2=n:i.inputid=n;let r=e.moleculeInfor,a={},o={};for(let e in r){if(0===Object.keys(r[e]).length)continue;let l=void 0===r[e].color?"#CCCCCC":"#"+("000000"+r[e].color.toString(16)).slice(-6),d=void 0===r[e].chain?"":r[e].chain.trim();d=d.replace(/_/g,""),void 0===o[d]?o[d]=1:++o[d];let c=n+"_"+(1===o[d]?d:d+o[d].toString());a[e]=c,(void 0===t||s.cfg.mmdbafid)&&(i.chainsColor[c]=s.parasCls.thr(l));let h=void 0===r[e].geneId?"":r[e].geneId,p=void 0===r[e].geneSymbol?"":r[e].geneSymbol,u=void 0===r[e].geneDesc?"":r[e].geneDesc;i.chainsGene[c]={geneId:h,geneSymbol:p,geneDesc:u}}i.molid2chain=a,$("#"+i.pre+"accordion5").show()}loadMmdbPrms(e,t,i){let s,n=this.icn3d,r=n.icn3dui;return s=t?r.htmlCls.baseUrl+"mmdb/mmdb_strview.cgi?v=2&program=icn3d&b=1&s=1&ft=1&bu="+r.cfg.bu+"&simple=1&gi="+e:r.htmlCls.baseUrl+"mmdb/mmdb_strview.cgi?v=2&program=icn3d&b=1&s=1&ft=1&bu="+r.cfg.bu+"&simple=1&uid="+e,void 0!==r.cfg.blast_rep_id&&(s+="&bu=0"),void 0!==r.cfg.inpara&&(s+=r.cfg.inpara),i&&(s+="&complexity=2"),void 0===n.chainids2resids&&(n.chainids2resids={}),r.getAjaxPromise(s,"jsonp",!0)}}class Ph{constructor(e){this.icn3d=e,this.mElem2Radius={},this.mElem2Radius.H=.31,this.mElem2Radius.HE=.28,this.mElem2Radius.LI=1.28,this.mElem2Radius.BE=.96,this.mElem2Radius.B=.84,this.mElem2Radius.C=.76,this.mElem2Radius.N=.71,this.mElem2Radius.O=.66,this.mElem2Radius.F=.57,this.mElem2Radius.NE=.58,this.mElem2Radius.NA=1.66,this.mElem2Radius.MG=1.41,this.mElem2Radius.AL=1.21,this.mElem2Radius.SI=1.11,this.mElem2Radius.P=1.07,this.mElem2Radius.S=1.05,this.mElem2Radius.CL=1.02,this.mElem2Radius.AR=1.06,this.mElem2Radius.K=2.03,this.mElem2Radius.CA=1.76,this.mElem2Radius.SC=1.7,this.mElem2Radius.TI=1.6,this.mElem2Radius.V=1.53,this.mElem2Radius.CR=1.39,this.mElem2Radius.MN=1.39,this.mElem2Radius.FE=1.32,this.mElem2Radius.CO=1.26,this.mElem2Radius.NI=1.24,this.mElem2Radius.CU=1.32,this.mElem2Radius.ZN=1.22,this.mElem2Radius.GA=1.22,this.mElem2Radius.GE=1.2,this.mElem2Radius.AS=1.19,this.mElem2Radius.SE=1.2,this.mElem2Radius.BR=1.2,this.mElem2Radius.KR=1.16,this.mElem2Radius.RB=2.2,this.mElem2Radius.SR=1.95,this.mElem2Radius.Y=1.9,this.mElem2Radius.ZR=1.75,this.mElem2Radius.NB=1.64,this.mElem2Radius.MO=1.54,this.mElem2Radius.TC=1.47,this.mElem2Radius.RU=1.46,this.mElem2Radius.RH=1.42,this.mElem2Radius.PD=1.39,this.mElem2Radius.AG=1.45,this.mElem2Radius.CD=1.44,this.mElem2Radius.IN=1.42,this.mElem2Radius.SN=1.39,this.mElem2Radius.SB=1.39,this.mElem2Radius.TE=1.38,this.mElem2Radius.I=1.39,this.mElem2Radius.XE=1.4,this.mElem2Radius.CS=2.44,this.mElem2Radius.BA=2.15,this.mElem2Radius.LA=2.07,this.mElem2Radius.CE=2.04,this.mElem2Radius.PR=2.03,this.mElem2Radius.ND=2.01,this.mElem2Radius.PM=1.99,this.mElem2Radius.SM=1.98,this.mElem2Radius.EU=1.98,this.mElem2Radius.GD=1.96,this.mElem2Radius.TB=1.94,this.mElem2Radius.DY=1.92,this.mElem2Radius.HO=1.92,this.mElem2Radius.ER=1.89,this.mElem2Radius.TM=1.9,this.mElem2Radius.YB=1.87,this.mElem2Radius.LU=1.87,this.mElem2Radius.HF=1.75,this.mElem2Radius.TA=1.7,this.mElem2Radius.W=1.62,this.mElem2Radius.RE=1.51,this.mElem2Radius.OS=1.44,this.mElem2Radius.IR=1.41,this.mElem2Radius.PT=1.36,this.mElem2Radius.AU=1.36,this.mElem2Radius.HG=1.32,this.mElem2Radius.TL=1.45,this.mElem2Radius.PB=1.46,this.mElem2Radius.BI=1.48,this.mElem2Radius.PO=1.4,this.mElem2Radius.AT=1.5,this.mElem2Radius.RN=1.5,this.mElem2Radius.FR=2.6,this.mElem2Radius.RA=2.21,this.mElem2Radius.AC=2.15,this.mElem2Radius.TH=2.06,this.mElem2Radius.PA=2,this.mElem2Radius.U=1.96,this.mElem2Radius.NP=1.9,this.mElem2Radius.PU=1.87,this.mElem2Radius.AM=1.8,this.mElem2Radius.CM=1.69}async downloadBcif(e){let t=this.icn3d,i=t.icn3dui;t.ParserUtilsCls.setYourNote(e.toUpperCase()+"(BCIF) in iCn3D");let s="https://models.rcsb.org/"+e+".bcif",n=await i.getXMLHttpRqstPromise(s,"GET","arraybuffer","bcif");if(0==n.length)return void alert("This PDB structure is not found at RCSB...");await t.opmParserCls.loadOpmData(n,e,void 0,"bcif",void 0,!1)}getBcifJson(e,t,i,s){let n=this.icn3d,r=n.icn3dui,a="",o="",l="",d="",c="",h="",p=i?CIFTools.Text.parse(e):CIFTools.Binary.parse(e);if(p.isError)return void alert("The Binary CIF data can NOT be parsed: "+p.toString());let u=p.result.dataBlocks[0];t||(u.getCategory("_entry")&&(t=u.getCategory("_entry").getColumn("id").getString(0)),""==t&&(t="stru")),u.getCategory("_citation")&&(o=u.getCategory("_citation").getColumn("pdbx_database_id_PubMed").getString(0)),u.getCategory("_struct")&&(l=u.getCategory("_struct").getColumn("title").getString(0),l=l.replace(/"/,"'")),u.getCategory("_struct_keywords")&&(d=u.getCategory("_struct_keywords").getColumn("pdbx_keywords").getString(0)),u.getCategory("_entity_src_gen")&&(h=u.getCategory("_entity_src_gen").getColumn("gene_src_common_name").getString(0));let m={},f={},g={};if(u.getCategory("_database_2")){let e=u.getCategory("_database_2"),t=e.rowCount;for(let i=0;i<t;++i){let t=e.getColumn("database_id").getString(i),s=e.getColumn("database_code").getString(i);if("EMDB"==t){c=s;break}}}if(u.getCategory("_struct_conf")){let e=u.getCategory("_struct_conf"),t=e.getColumn("conf_type_id"),i=e.getColumn("beg_auth_asym_id"),s=e.getColumn("beg_auth_seq_id"),n=e.getColumn("end_auth_asym_id"),r=e.getColumn("end_auth_seq_id"),a=e.rowCount;for(let e=0;e<a;++e){let a,o=t.getString(e),l=i.getString(e),d=s.getString(e),c=l+"_"+d,h=n.getString(e),p=r.getString(e),u=h+"_"+p;if("HELX"==o.substr(0,4)?(a="helix",m[c]=1,f[u]=1):"STRN"==o.substr(0,4)&&(a="sheet",m[c]=1,f[u]=1),"helix"==a||"sheet"==a)for(let e=parseInt(d);e<=parseInt(p);++e){g[l+"_"+e]=a}}t=i=s=n=r=[]}if(u.getCategory("_struct_sheet_range")){let e=u.getCategory("_struct_sheet_range"),t=e.getColumn("beg_auth_asym_id"),i=e.getColumn("beg_auth_seq_id"),s=e.getColumn("end_auth_asym_id"),n=e.getColumn("end_auth_seq_id"),r=e.rowCount;for(let e=0;e<r;++e){let r=t.getString(e),a=i.getString(e);m[r+"_"+a]=1;let o=s.getString(e),l=n.getString(e);f[o+"_"+l]=1;let d="sheet";for(let e=parseInt(a);e<=parseInt(l);++e){g[r+"_"+e]=d}}t=i=s=n=[]}let b={},C=[],v=[];if(u.getCategory("_struct_conn")){let e=u.getCategory("_struct_conn"),i=e.getColumn("conn_type_id"),s=e.getColumn("ptnr1_auth_asym_id"),n=e.getColumn("ptnr1_label_atom_id"),r=e.getColumn("ptnr1_label_seq_id"),a=e.getColumn("ptnr2_auth_asym_id"),o=e.getColumn("ptnr2_label_atom_id"),l=e.getColumn("ptnr2_label_seq_id"),d=e.rowCount;for(let e=0;e<d;++e){let d=i.getString(e),c=s.getString(e),h=n.getString(e),p=r.getString(e),u=c+"_"+p+"_"+h,m=a.getString(e),f=o.getString(e),g=l.getString(e),b=m+"_"+g+"_"+f;"covale"==d?(C.push(u),C.push(b)):"disulf"==d&&(v.push(t+"_"+c+"_"+p),v.push(t+"_"+m+"_"+g))}i=s=n=r=a=o=l=[]}let _,y,S,w,x,A,M,T,E,R,k,O,I,P,D,L=u.getCategory("_atom_site"),F={},N={id:""},U="",H={},B={},z="",q=L.rowCount,j=1,G=!(10*q>n.maxatomcnt);if(!s){y=L.getColumn("group_PDB"),S=L.getColumn("label_comp_id"),w=L.getColumn("type_symbol"),x=L.getColumn("label_atom_id"),A=L.getColumn("auth_asym_id"),M=L.getColumn("label_seq_id"),T=L.getColumn("auth_seq_id"),E=L.getColumn("label_alt_id"),R=L.getColumn("B_iso_or_equiv"),k=L.getColumn("Cartn_x"),O=L.getColumn("Cartn_y"),I=L.getColumn("Cartn_z"),P=L.getColumn("label_asym_id"),D=L.getColumn("pdbx_PDB_model_num");let e={},t="";for(let i=0;i<q;++i){let s,n=y.getString(i),a=S.getString(i),o=w.getString(i),l=x.getString(i),d=A.getString(i),c=M.getString(i),h=T.getString(i),p=E.getString(i),u=P.getString(i);if(c=h,"ATOM"==n?s=3==a.length?"protein":"nucleotide":"WAT"==a||"HOH"==a?(s="solvent",d="Misc"):(s="ligand",d=a),!G&&("protein"==s&&("C"!=o||"CA"!=l)||"nucleotide"==s&&"P"!=l))continue;if("B"==p)continue;if(B[d]=1,"?"!=c&&"."!=c&&"0"!=c||(c=h),"solvent"==s||"ligand"==s){let i={};e.hasOwnProperty(d)||(e[d]=[]),3!=a.length||"HOH"==a||"WAT"==a?3==a.length&&("O"!=o||"HOH"!=a&&"WAT"!=a)||(i.resi=c,i.name=r.utilsCls.residueName2Abbr(a),e[d].push(i)):d+"_"+a==z&&t==u||(i.resi=c,i.name=r.utilsCls.residueName2Abbr(a),e[d].push(i))}let m=k.getFloat(i),f=O.getFloat(i),g=I.getFloat(i),C=j.toString();F[d+"_"+c+"_"+l]=C;let v={};v.id=C,v.elem=o,v.x=m,v.y=f,v.z=g,v.alt=p,_=d+"_"+c;let R=1.3;if(_!=U||t!=u)H={},H[_]={},H[_][v.id]=v;else{for(let e in H[_])this.hasCovalentBond(v,H[_][e],R)&&(b.hasOwnProperty(v.id)||(b[v.id]={}),b.hasOwnProperty(H[_][e].id)||(b[H[_][e].id]={}),b[v.id][H[_][e].id]=1,b[H[_][e].id][v.id]=1);H[_][v.id]=v}"N"==l&&""!=N.id&&this.hasCovalentBond(v,N,R)&&(b.hasOwnProperty(v.id)||(b[v.id]={}),b.hasOwnProperty(N.id)||(b[N.id]={}),b[v.id][N.id]=1,b[N.id][v.id]=1),"C"==l&&(N=v),U=_,z=d+"_"+a,t=u,++j}for(let e=0;e<C.length;e+=2){let t=F[C[e]],i=F[C[e+1]];b.hasOwnProperty(t)||(b[t]={}),b.hasOwnProperty(i)||(b[i]={}),b[t][i]=1,b[i][t]=1}}if(a+='{"bcif":"'+t+'", '+(""!=c?'"emd":"'+c+'",':"")+(""!=h?'"organism":"'+h+'",':"")+'"pubmedid":"'+o+'", "descr": {"name": "'+l+'", "class": "'+d+'"}',!s){a+=', "atoms":[\n',z="",j=1;let e=t;for(let i=0;i<q;++i){let s=D.getString(i);"1"!=s&&""!=s&&(e=t+s);let n,r=y.getString(i),o=S.getString(i),l=w.getString(i),d=x.getString(i),c=A.getString(i),h=M.getString(i),p=T.getString(i),u=E.getString(i),C=P.getString(i);if(h=p,"ATOM"==r?n=3==o.length?"protein":"nucleotide":"WAT"==o||"HOH"==o?(n="solvent",c="Misc"):(n="ligand",c=o),!G&&("protein"==n&&("C"!=l||"CA"!=d)||"nucleotide"==n&&"P"!=d))continue;if("B"==u)continue;"?"!=h&&"."!=h&&"0"!=h||(h=p);let v=R.getString(i),_=k.getFloat(i),L=O.getFloat(i),F=I.getFloat(i),N=j.toString(),U=c+"_"+h;a+="{",a+='"het":'+("HETATM"==r?"1":"0")+", ",a+='"serial":'+j+", ",a+='"name":"'+d+'", ',a+='"resn":"'+o+'", ',a+='"structure":"'+e+'", ',a+='"chain":"'+c+'", ',a+='"resi":'+h+", ",a+='"coord":{"x":'+_+', "y":'+L+', "z":'+F+"}, ",a+='"b":"'+v+'", ',a+='"elem":"'+l+'", ',a+='"bonds":[';let H={};b.hasOwnProperty(N)&&(H=b[N]);let B=Object.keys(H);for(let e=0,t=B.length;e<t;++e)"undefined"!==B[e]&&(a+=B[e],a+=", ");if(B.length>0&&(a=a.substr(0,a.length-2)),a+="], ",g.hasOwnProperty(U)){a+='"ss":"'+g[U]+'", '}else a+='"ss":"coil", ';m.hasOwnProperty(U)?a+='"ssbegin":1, ':a+='"ssbegin":0, ',f.hasOwnProperty(U)?a+='"ssend":1, ':a+='"ssend":0, ',a+='"mt":"'+n+'"',a+="}",a+=",\n",z=c+"_"+o,prevAutochain=C,++j}j>1&&(a=a.substr(0,a.length-2)),a+="]"}y=S=w=x=A=M=T=E=R=k=O=I=P=[];let $={};if(u.getCategory("_pdbx_poly_seq_scheme")){let e=u.getCategory("_pdbx_poly_seq_scheme"),t=e.getColumn("seq_id"),i=e.getColumn("pdb_seq_num"),s=e.getColumn("mon_id"),n=e.getColumn("pdb_strand_id"),r=e.rowCount,a="",o="";for(let e=0;e<r;++e){t.getString(e);let l=i.getString(e),d=s.getString(e),c=n.getString(e);c!=a&&(0==e||(o=o.substr(0,o.length-2),o+="]",$[a]=o),o="["),o+="["+l+', "'+d+'"]',e<r-1&&(o+=", "),a=c}o+="]",$[a]=o,t=i=s=n=[]}a+=', "sequences":{';let V=!1;for(let e in B){let t;t=ligSeqHash.hasOwnProperty(e)?"["+ligSeqHash[e]+"]":$[e],""!==t&&void 0!==t&&(a+='"'+e+'": '+t+", ",V=!0)}if(V&&(a=a.substr(0,a.length-2)),a+="}",u.getCategory("_pdbx_struct_oper_list")){let e=u.getCategory("_pdbx_struct_oper_list");a+=', "assembly":[';let t=', "pmatrix":',i=!1,s=e.rowCount;for(let n=0;n<s;++n){let r=e.getColumn("id").getString(n);if("X0"==r)continue;let o=e.getColumn("matrix[1][1]").getFloat(n),l=e.getColumn("matrix[1][2]").getFloat(n),d=e.getColumn("matrix[1][3]").getFloat(n),c=e.getColumn("vector[1]").getFloat(n),h=e.getColumn("matrix[2][1]").getFloat(n),p=e.getColumn("matrix[2][2]").getFloat(n),u=e.getColumn("matrix[2][3]").getFloat(n),m=e.getColumn("vector[2]").getFloat(n),f="["+o+","+h+","+e.getColumn("matrix[3][1]").getFloat(n)+", 0, "+l+","+p+","+e.getColumn("matrix[3][2]").getFloat(n)+", 0, "+d+","+u+","+e.getColumn("matrix[3][3]").getFloat(n)+", 0, "+c+","+m+","+e.getColumn("vector[3]").getFloat(n)+", 1]";"P"==r?(t+=f,i=!0):(a+=f,n<s-1&&(a+=", "))}a+="]",i&&(a+=t)}if(v.length>0){a+=', "disulfides":[';for(let e=0;e<v.length;e+=2)a+="[",a+='"'+v[e]+'", "'+v[e+1]+'"',a+="]",e<v.length-2&&(a+=", ");a+="]"}return a+="}",a}hasCovalentBond(e,t,i){this.icn3d.icn3dui;let s=this.mElem2Radius[e.elem]+this.mElem2Radius[t.elem],n=e.x-t.x,r=e.y-t.y,a=e.z-t.z;return n*n+r*r+a*a<i*s*s}}class Dh{constructor(e){this.icn3d=e}async loadMol2Data(e){let t=this.icn3d,i=t.icn3dui,s=this.loadMol2AtomData(e);void 0===i.cfg.align&&1==Object.keys(t.structures).length&&$("#"+t.pre+"alternateWrapper").hide(),s?(t.setStyleCls.setAtomStyleByOptions(t.opts),t.setColorCls.setColorByOptions(t.opts,t.atoms),await t.ParserUtilsCls.renderStructure(),void 0!==i.cfg.rotate&&t.resizeCanvasCls.rotStruc(i.cfg.rotate,!0)):alert("The Mol2 file has the wrong format...")}loadMol2AtomData(e){let t=this.icn3d;t.icn3dui;let i=e.split(/\r?\n|\r/);if(i.length<4)return!1;t.init();let s,n,r="LIG",a={},o="1_A",l="1_A_1",d=0,c=0,h=1,p=!1,u=!1,m={},f={};for(let e=0,o=i.length;e<o;++e){let o=i[e].trim();if(""!==o&&"#"!==o.substr(0,1)){if("@<TRIPOS>MOLECULE"==o){t.molTitle=i[e+1].trim();let r=i[e+2].trim().replace(/\s+/g," ").split(" ");s=r[0],n=r[1],e+=4}else"@<TRIPOS>ATOM"==o?(h=1,p=!0,++e):"@<TRIPOS>BOND"==o?(u=!0,p=!1,++e):"@<TRIPOS>SUBSTRUCTURE"==o&&(u=!1,++e);if(o=i[e].trim(),""!==o&&"#"!==o.substr(0,1)){if(p&&d<s){let e=o.replace(/\s+/g," ").split(" "),i=parseInt(e[0]);m[i]=h;let s,n=e[1],l=parseFloat(e[2]),c=parseFloat(e[3]),p=parseFloat(e[4]),u=new mt(l,c,p),g=e[5],b=g.indexOf(".");if(s=-1===b?g:g.substr(0,b),"H"===s&&s===g)f[i]=1;else{let e={het:!0,serial:h,name:n,resn:r,structure:1,chain:"A",resi:1,coord:u,b:0,elem:s,bonds:[],ss:"coil",ssbegin:!1,ssend:!1,bondOrder:[]};t.atoms[h]=e,a[h]=1,++h}++d}if(u&&c<n){let e=o.replace(/\s+/g," ").split(" "),i=parseInt(e[1]),s=parseInt(e[2]),n=e[3],r=n;if("am"===n&&(r="1"),"ar"===n&&(r="1.5"),!(f.hasOwnProperty(i)||f.hasOwnProperty(s)||"1"!==r&&"2"!==r&&"3"!==r&&"1.5"!==r)){let e=r,n=m[i],a=m[s];t.atoms[n].bonds.push(a),t.atoms[n].bondOrder.push(e),t.atoms[a].bonds.push(n),t.atoms[a].bondOrder.push(e),"2"==e?(t.doublebonds[n+"_"+a]=1,t.doublebonds[a+"_"+n]=1):"3"==e?(t.triplebonds[n+"_"+a]=1,t.triplebonds[a+"_"+n]=1):"1.5"==e&&(t.aromaticbonds[n+"_"+a]=1,t.aromaticbonds[a+"_"+n]=1)}++c}}}}t.dAtoms=a,t.hAtoms=a,t.structures[1]=[o],t.chains[o]=a,t.residues[l]=a,t.residueId2Name[l]=r,void 0===t.chainsSeq[o]&&(t.chainsSeq[o]=[]);let g={resi:1};return g.name=r,t.chainsSeq[o].push(g),t.ParserUtilsCls.setMaxD(),t.saveFileCls.showTitle(),!0}}class Lh{constructor(e){this.icn3d=e}async downloadOpm(e){let t=this.icn3d,i=t.icn3dui;t.ParserUtilsCls.setYourNote(e.toUpperCase()+"(OPM) in iCn3D"),t.bStopRotate=!0;let s="https://opm-assets.storage.googleapis.com/pdb/"+e.toLowerCase()+".pdb",n=await i.getAjaxPromise(s,"text",!0,"This is probably not a transmembrane protein. It has no data in Orientations of Proteins in Membranes(OPM) database.");t.bOpm=!0,await t.pdbParserCls.loadPdbData(n,e,t.bOpm),$("#"+t.pre+"selectplane_z1").val(t.halfBilayerSize),$("#"+t.pre+"selectplane_z2").val(-t.halfBilayerSize),$("#"+t.pre+"extra_mem_z").val(t.halfBilayerSize),$("#"+t.pre+"intra_mem_z").val(-t.halfBilayerSize)}async loadOpmData(e,t,i,s,n,r){let a=this.icn3d,o=a.icn3dui;try{t||(t=a.defaultPdbId);let l=o.htmlCls.baseUrl+"mmdb/mmdb_strview.cgi?v=2&program=icn3d&opm&uid="+t.toLowerCase(),d=await o.getAjaxPromise(l,"jsonp",!1);this.setOpmData(d),await this.parseAtomData(e,t,i,s,n,r)}catch(a){await this.parseAtomData(e,t,i,s,n,r)}}setOpmData(e){let t=this.icn3d;t.icn3dui,void 0!==e.opm&&void 0!==e.opm.rot?(t.bOpm=!0,t.halfBilayerSize=e.opm.thickness,t.rmsd_supr={},t.rmsd_supr.rot=e.opm.rot,t.rmsd_supr.trans1=new mt(e.opm.trans1[0],e.opm.trans1[1],e.opm.trans1[2]),t.rmsd_supr.trans2=new mt(e.opm.trans2[0],e.opm.trans2[1],e.opm.trans2[2]),t.rmsd_supr.rmsd=e.opm.rmsd,$("#"+t.pre+"selectplane_z1").val(t.halfBilayerSize),$("#"+t.pre+"selectplane_z2").val(-t.halfBilayerSize),$("#"+t.pre+"extra_mem_z").val(t.halfBilayerSize),$("#"+t.pre+"intra_mem_z").val(-t.halfBilayerSize)):t.bOpm=!1}modifyUIMapAssembly(){let e=this.icn3d;e.icn3dui.bNode||(void 0!==e.emd?($("#"+e.pre+"mapWrapper1").hide(),$("#"+e.pre+"mapWrapper2").hide(),$("#"+e.pre+"mapWrapper3").hide()):($("#"+e.pre+"emmapWrapper1").hide(),$("#"+e.pre+"emmapWrapper2").hide(),$("#"+e.pre+"emmapWrapper3").hide()),1==Object.keys(e.structures).length&&$("#"+e.pre+"alternateWrapper").hide(),void 0!==e.biomtMatrices&&e.biomtMatrices.length>1&&($("#"+e.pre+"assemblyWrapper").show(),e.asuCnt=e.biomtMatrices.length))}async parseAtomData(e,t,i,s,n,r){let a=this.icn3d,o=a.icn3dui;"mmcif"===s||"bcif"===s?(a.loadCIFCls.loadCIF(e,t,r),this.modifyUIMapAssembly(),a.setStyleCls.setAtomStyleByOptions(a.opts),a.setColorCls.setColorByOptions(a.opts,a.atoms),await a.ParserUtilsCls.renderStructure(),void 0!==o.cfg.rotate&&a.resizeCanvasCls.rotStruc(o.cfg.rotate,!0)):"pdb"===s?await a.pdbParserCls.loadPdbData(e,t):"align"===s&&(a.bOpm?await a.alignParserCls.downloadAlignmentPart2(t):void 0!==n?await this.loadOpmData(e,n,i,s):await a.alignParserCls.downloadAlignmentPart2(t))}}class Fh{constructor(e){this.icn3d=e}async downloadPdb(e,t){let i,s=this.icn3d,n=s.icn3dui;t?(i="https://alphafold.ebi.ac.uk/files/AF-"+e+"-F1-model_"+s.AFUniprotVersion+".pdb",n.cfg.refseqid?s.ParserUtilsCls.setYourNote(n.cfg.refseqid.toUpperCase()+"(NCBI Protein Acc.) in iCn3D"):n.cfg.protein?s.ParserUtilsCls.setYourNote(n.cfg.protein+"(NCBI Protein/Gene) in iCn3D"):s.ParserUtilsCls.setYourNote(e.toUpperCase()+"(AlphaFold) in iCn3D")):(i="https://files.rcsb.org/download/"+e+".pdb",e=e.toUpperCase(),s.ParserUtilsCls.setYourNote(e+"(PDB) in iCn3D"));let r=await n.getAjaxPromise(i,"text",!0,"The ID "+e+" can not be found in the server "+i+"...");if(t){r="HEADER                                                        "+e+"\n"+r,await s.opmParserCls.parseAtomData(r,e,void 0,"pdb",void 0)}else await s.opmParserCls.loadOpmData(r,e,void 0,"pdb")}async downloadUrl(e,t,i,s){let n=this.icn3d,r=n.icn3dui,a=e.lastIndexOf("/");if(-1!=a){let t=e.lastIndexOf(".");n.filename=e.substr(a+1,t-a-1)}else{let t=e.lastIndexOf(".");n.filename=e.substr(0,t)}let o=await r.getAjaxPromise(e,"text",!0);if(n.InputfileData=n.InputfileData?n.InputfileData+"\nENDMDL\n"+o:o,n.InputfileType=t,n.hAtoms={},n.dAtoms={},n.resetConfig(),n.bResetAnno=!0,n.bResetSets=!0,"pdb"===t){let e=!0,t=s?s.replace(/_/g,"").substr(0,4):void 0;await this.loadPdbData(o,t,void 0,e)}else if("mmcif"===t){let e=!0;await n.opmParserCls.loadOpmData(o,void 0,void 0,"mmcif",void 0,e)}else if("mol2"===t)await n.mol2ParserCls.loadMol2Data(o);else if("sdf"===t)await n.sdfParserCls.loadSdfData(o);else if("xyz"===t)await n.xyzParserCls.loadXyzData(o);else if("mmcif"===t)await n.mmcifParserCls.loadMmcifData(o);else if("icn3dpng"===t)await r.htmlCls.setHtmlCls.loadPng(o,i,!0);else if("pae"===t){r.htmlCls.dialogCls.openDlg("dl_alignerrormap","Show Predicted Aligned Error (PAE) map");let e=!0;n.contactMapCls.processAfErrorMap(JSON.parse(o),e)}n.bSetChainsAdvancedMenu&&n.definedSetsCls.showSets(),n.bResetAnno=!0,n.bAnnoShown&&(await n.showAnnoCls.showAnnotations(),n.annotationCls.resetAnnoTabAll())}async loadPdbData(e,t,i,s,n,r,a,o){let l=this.icn3d,d=l.icn3dui;if(!s&&(void 0===n||"target"===n)){let e=!!l.bCommandLoad;l.bStatefile||l.init(e)}let c=await l.loadPDBCls.loadPDB(e,t,i,void 0,void 0,s,n,o);return void 0===d.cfg.opmid&&l.ParserUtilsCls.transformToOpmOri(t),void 0!==l.biomtMatrices&&l.biomtMatrices.length>1&&(d.bNode||$("#"+l.pre+"assemblyWrapper").show(),l.asuCnt=l.biomtMatrices.length),d.bNode||(void 0!==l.emd?($("#"+l.pre+"mapWrapper1").hide(),$("#"+l.pre+"mapWrapper2").hide(),$("#"+l.pre+"mapWrapper3").hide()):($("#"+l.pre+"emmapWrapper1").hide(),$("#"+l.pre+"emmapWrapper2").hide(),$("#"+l.pre+"emmapWrapper3").hide())),await this.addSecondary(s,a),c}async addSecondary(e,t){let i=this.icn3d,s=i.icn3dui,n=!1;i.bSecondaryStructure&&1==Object.keys(i.structures).length?n=!1:s.cfg.mmtfid||s.cfg.pdbid||s.cfg.opmid||s.cfg.mmdbid||s.cfg.gi||s.cfg.uniprotid||s.cfg.blast_rep_id||s.cfg.cid||s.cfg.mmcifid||s.cfg.align||s.cfg.chainalign||(n=!0),(!i.bSecondaryStructure||n)&&Object.keys(i.proteins).length>0&&!t?await this.applyCommandDssp(e):(await this.loadPdbDataRender(e),s.bNode||await i.ParserUtilsCls.checkMemProteinAndRotate())}async applyCommandDssp(e){let t=this.icn3d,i=t.icn3dui,s=i.utilsCls.isCalphaPhosOnly(i.hashUtilsCls.hash2Atoms(t.proteins,t.atoms));await t.dsspCls.applyDssp(s,e)}async loadPdbDataRender(e){let t=this.icn3d,i=t.icn3dui;if(void 0===i.cfg.align&&1==Object.keys(t.structures).length&&$("#"+t.pre+"alternateWrapper").hide(),(i.cfg.afid&&!t.bAfMem||t.bEsmfold)&&(t.opts.color="confidence"),t.setStyleCls.setAtomStyleByOptions(t.opts),t.setColorCls.setColorByOptions(t.opts,t.hAtoms),await t.ParserUtilsCls.renderStructure(),t.saveFileCls.showTitle(),void 0!==i.cfg.rotate&&t.resizeCanvasCls.rotStruc(i.cfg.rotate,!0),e&&!i.bNode&&t.definedSetsCls.setModeAndDisplay("all"),t.struct_statefile)for(let e=0,i=t.struct_statefile.length;e<i;++e)await this.execStatefile(t.struct_statefile[e].structure,t.struct_statefile[e].statefile)}async execStatefile(e,t){let i=this.icn3d,s=i.icn3dui;if(!t)return;let n=t.trim().split("\n");n=["select $"+e].concat(n),i.STATENUMBER=n.length,i.CURRENTNUMBER=0;let r=s.hashUtilsCls.cloneHash(i.hAtoms),a=i.commands;i.hAtoms={},i.commands=n,await i.loadScriptCls.execCommands(i.CURRENTNUMBER,i.STATENUMBER-1,i.STATENUMBER,!0),i.hAtoms=s.hashUtilsCls.cloneHash(r),i.commands=a.concat(i.commands)}}class Nh{constructor(e){this.icn3d=e}async downloadCid(e){let t=this.icn3d,i=t.icn3dui;t.ParserUtilsCls.setYourNote("PubChem CID "+e+" in iCn3D"),t.bCid=!0;let s="https://pubchem.ncbi.nlm.nih.gov/rest/pug/compound/cid/"+t.inputid+"/cids/JSONP?cids_type=parent",n="https://pubchem.ncbi.nlm.nih.gov/rest/pug/compound/cid/"+(await i.getAjaxPromise(s,"jsonp",!0,"Can not retrieve the parent CID...")).IdentifierList.CID[0]+"/record/SDF/?record_type=3d&response_type=display",r=await i.getAjaxPromise(n,"text",!0,"This CID may not have 3D structure..."),a=this.loadSdfAtomData(r,e);void 0===i.cfg.align&&1==Object.keys(t.structures).length&&$("#"+t.pre+"alternateWrapper").hide(),a?(t.setStyleCls.setAtomStyleByOptions(t.opts),t.setColorCls.setColorByOptions(t.opts,t.atoms),await t.ParserUtilsCls.renderStructure(),void 0!==i.cfg.rotate&&t.resizeCanvasCls.rotStruc(i.cfg.rotate,!0)):alert("The SDF of CID "+e+" has the wrong format...")}async downloadSmiles(e){let t=this.icn3d,i=t.icn3dui,s=i.htmlCls.baseUrl+"openbabel/openbabel.cgi?smiles2sdf="+e,n=await i.getAjaxPromise(s,"text");t.init(),t.InputfileData=t.InputfileData?t.InputfileData+"\nENDMDL\n"+n:n,t.InputfileType="sdf",await t.sdfParserCls.loadSdfData(n)}async loadSdfData(e){let t=this.icn3d,i=t.icn3dui,s=this.loadSdfAtomData(e);void 0===i.cfg.align&&1==Object.keys(t.structures).length&&$("#"+t.pre+"alternateWrapper").hide(),s?(t.setStyleCls.setAtomStyleByOptions(t.opts),t.setColorCls.setColorByOptions(t.opts,t.atoms),await t.ParserUtilsCls.renderStructure(),void 0!==i.cfg.rotate&&t.resizeCanvasCls.rotStruc(i.cfg.rotate,!0)):alert("The SDF file has the wrong format...")}loadSdfAtomData(e,t){let i=this.icn3d;i.icn3dui;let s=e.split(/\r?\n|\r/);if(s.length<4)return!1;i.init();let n=t||1,r="LIG",a=n,o=n+"_A",l=o+"_1",d=parseInt(s[3].substr(0,3));if(isNaN(d)||d<=0)return!1;let c=parseInt(s[3].substr(3,3)),h=4;if(s.length<h+d+c)return!1;let p,u,m=d,f={},g={},b={},C=1;for(p=0;p<m;p++){u=s[h],h++;let e=u.substr(31,3).trim(),t=parseFloat(u.substr(0,10)),a=parseFloat(u.substr(10,10)),o=parseFloat(u.substr(20,10)),l={het:!0,serial:C,name:e,resn:r,structure:n,chain:"A",resi:1,coord:new mt(t,a,o),b:0,elem:e,bonds:[],ss:"coil",ssbegin:!1,ssend:!1,bondOrder:[]};i.atoms[C]=l,b[C]=1,f[p]=C,++C,"H"==e&&(g[p]=1)}i.dAtoms=b,i.hAtoms=b,i.structures[a]=[o],i.chains[o]=b,i.residues[l]=b,i.residueId2Name[l]=r,void 0===i.chainsSeq[o]&&(i.chainsSeq[o]=[]);let v={resi:1};for(v.name=r,i.chainsSeq[o].push(v),p=0;p<c;p++){u=s[h],h++;let e=parseInt(u.substr(0,3))-1+0,t=parseInt(u.substr(3,3))-1+0,n=u.substr(6,3).trim(),r=f[e],a=f[t];i.atoms[r].bonds.push(a),i.atoms[r].bondOrder.push(n),i.atoms[a].bonds.push(r),i.atoms[a].bondOrder.push(n),g.hasOwnProperty(e)||g.hasOwnProperty(t)||("2"==n?(i.doublebonds[r+"_"+a]=1,i.doublebonds[a+"_"+r]=1):"3"==n&&(i.triplebonds[r+"_"+a]=1,i.triplebonds[a+"_"+r]=1))}let _=!1;for(let e=s.length;h<e;++h)if(-1!=s[h].indexOf("PARTIAL_CHARGES")){_=!0;break}if(_){++h;let e=parseInt(s[h]);for(++h,p=0;p<e;++p,++h){u=s[h];let e=u.split(" "),t=parseInt(e[0]),n=parseFloat(e[1]);i.atoms[t].crg=n}}for(p in i.atoms)"H"!==i.atoms[p].name&&(i.atoms[p].bonds2=i.atoms[p].bonds.concat(),i.atoms[p].bondOrder2=i.atoms[p].bondOrder.concat());return i.ParserUtilsCls.setMaxD(),i.saveFileCls.showTitle(),!0}}class Uh{constructor(e){this.icn3d=e}async loadXyzData(e){let t=this.icn3d,i=t.icn3dui,s=this.loadXyzAtomData(e);void 0===i.cfg.align&&1==Object.keys(t.structures).length&&$("#"+t.pre+"alternateWrapper").hide(),s?(t.setStyleCls.setAtomStyleByOptions(t.opts),t.setColorCls.setColorByOptions(t.opts,t.atoms),await t.ParserUtilsCls.renderStructure(),void 0!==i.cfg.rotate&&t.resizeCanvasCls.rotStruc(i.cfg.rotate,!0)):alert("The XYZ file has the wrong format...")}setXyzAtomSeq(e,t,i,s){let n=this.icn3d,r=n.icn3dui;n.dAtoms=r.hashUtilsCls.unionHash(n.dAtoms,e),n.hAtoms=r.hashUtilsCls.unionHash(n.hAtoms,e),n.structures[t]=[i],n.chains[i]=e,n.residues[s]=e,n.residueId2Name[s]="LIG",void 0===n.chainsSeq[i]&&(n.chainsSeq[i]=[]);let a={resi:1,name:"LIG"};n.chainsSeq[i].push(a);let o=Object.keys(e);for(let e=0,t=o.length;e<t;++e){let t=n.atoms[o[e]];for(let i=e+1,s=o.length;i<s;++i){let s=n.atoms[o[i]],a=1.2*(r.parasCls.covalentRadii[t.elem.toUpperCase()]+r.parasCls.covalentRadii[s.elem.toUpperCase()]);Math.abs(t.coord.x-s.coord.x)>a||(Math.abs(t.coord.y-s.coord.y)>a||Math.abs(t.coord.z-s.coord.z)>a||r.utilsCls.hasCovalentBond(t,s)&&(n.atoms[o[e]].bonds.push(o[i]),n.atoms[o[i]].bonds.push(o[e])))}}}loadXyzAtomData(e){let t=this.icn3d;t.icn3dui;let i=e.split(/\r?\n|\r/);if(i.length<3)return!1;t.init();let s,n,r,a={},o=0,l=1;t.molTitle="";for(let e=0,d=i.length;e<d;++e){let d=i[e].trim();if(""===d)continue;if(""===d||isNaN(d)||(0!==e&&this.setXyzAtomSeq(a,o,s,n),++o,a={},r=o,s=r+"_A",n=s+"_1",o>1&&(t.molTitle+="; "),t.molTitle+=i[e+1].trim(),e+=2),d=i[e].trim(),""===d)continue;let c=d.replace(/,/," ").replace(/\s+/g," ").split(" "),h=c[0],p=parseFloat(c[1]),u=parseFloat(c[2]),m=parseFloat(c[3]),f={het:!0,serial:l,name:h,resn:"LIG",structure:r,chain:"A",resi:1,coord:new mt(p,u,m),b:0,elem:h,bonds:[],ss:"coil",ssbegin:!1,ssend:!1,bondOrder:[]};t.atoms[l]=f,a[l]=1,++l}return this.setXyzAtomSeq(a,o,s,n),t.ParserUtilsCls.setMaxD(),t.saveFileCls.showTitle(),!0}}class Hh{constructor(e){this.icn3d=e}async loadMsaData(e,t){let i=this.icn3d,s=i.icn3dui,n=await this.loadMsaSeqData(e,t);void 0===s.cfg.align&&1==Object.keys(i.structures).length&&$("#"+i.pre+"alternateWrapper").hide();let r=t.toUpperCase();if(n){s.cfg.bu=0,await i.chainalignParserCls.downloadMmdbAf(i.struArray.join(",")),s.htmlCls.clickMenuCls.setLogCmd("load mmdbaf0 "+i.struArray.join(","),!0);let e=[];for(let t=0,s=i.inputChainidArray.length;t<s;++t){let s=i.inputChainidArray[t],n=i.inputSeqArray[t].replace(/-/g,""),r="";for(let e=0,t=i.chainsSeq[s].length;e<t;++e)r+=i.chainsSeq[s][e].name;let a=r.toUpperCase().indexOf(n.substr(0,20).toUpperCase());-1==a&&(console.log("The sequence of the aligned chain "+s+" ("+n.toUpperCase()+") is different from the sequence from the structure ("+r.toUpperCase()+"), and is thus not aligned correctly..."),a=0),e.push(a)}let t="",n=i.inputChainidArray[0],r=i.inputSeqArray[0],a=e[0];for(let s=1,o=i.inputChainidArray.length;s<o;++s){let l=i.inputChainidArray[s],d=i.inputSeqArray[s],c=a,h=e[s],p=[],u=[];for(let e=0,t=d.length;e<t;++e){if("-"!=r[e]&&"-"!=d[e]&&i.chainsSeq[n][c]&&i.chainsSeq[l][h]){let e=i.chainsSeq[n][c].resi,t=i.chainsSeq[l][h].resi;i.residues[n+"_"+e]&&i.residues[l+"_"+t]&&(p.push(i.chainsSeq[n][c].resi),u.push(i.chainsSeq[l][h].resi))}"-"!=r[e]&&++c,"-"!=d[e]&&++h}t+=i.resid2specCls.resi2range(p,!0)+" | "+i.resid2specCls.resi2range(u,!0),s<o-1&&(t+=": ")}let o=i.inputChainidArray.join(",");if(t&&o.split(",").length-1!=t.split(": ").length)return void alert("Please make sure the number of chains and the lines of predefined residues are the same...");s.cfg.resdef=t.replace(/:/gi,";");let l=!0,d=!0,c=o.split(",");await i.realignParserCls.realignChainOnSeqAlign(void 0,c,l,d),s.htmlCls.clickMenuCls.setLogCmd("realign predefined "+o+" "+t,!0),i.opts.color="identity",i.setColorCls.setColorByOptions(i.opts,i.hAtoms),s.htmlCls.clickMenuCls.setLogCmd("color identity",!0),i.selectionCls.showSelection(),s.htmlCls.clickMenuCls.setLogCmd("show selection",!0)}else alert("The "+r+" file has the wrong format...")}async loadMsaSeqData(e,t){let i=this.icn3d;i.icn3dui;let s=e.split(/\r?\n|\r/);if(s.length<2)return!1;i.init(),i.molTitle="";let n={},r=!1,a=!1,o="",l="",d=!1;if("clustalw"==t&&"CLUSTAL"!=s[0].substr(0,7))return!1;for(let e="clustalw"==t?1:0,i=s.length;e<i;++e){let i=s[e].trim();if(""!==i){if(!r){if("fasta"==t&&">"!=i.substr(0,1))return!1;r=!0}if("clustalw"==t){if(" "!=i.substr(0,1)&&"\t"!=i.substr(0,1)){let e=i.split(/\s+/),t=e[0].split("|"),s=this.getChainid(t,r&&!a);d=s.bFound,o=s.chainid,d&&(n.hasOwnProperty(o)?n[o]+=e[1]:n[o]=e[1])}}else if("fasta"==t)if(">"==i.substr(0,1)){o&&l&&d&&(n[o]=l),o="",l="";let e=i.indexOf(" "),t=i.substr(1,e).split("|");if(1==t.length)o=t[0];else{let e=this.getChainid(t,!0);d=e.bFound,o=e.chainid}}else l+=i}else r&&(a=!0),r=!1}"fasta"==t&&o&&l&&d&&(n[o]=l),i.inputChainidArray=[],i.inputSeqArray=[],i.struArray=[];let c="";for(let e in n){if("-"!=n[e].substr(0,1)){c=e,await this.processOneChain(e,n);break}}c||(c=Object.keys(n)[0]);for(let e in n)e!=c&&await this.processOneChain(e,n);return!0}async processOneChain(e,t){let i=this.icn3d,s=i.icn3dui;if(i.inputSeqArray.push(t[e]),2==e.lastIndexOf("_")){let t=s.htmlCls.baseUrl+"vastdyn/vastdyn.cgi?refseq2uniprot="+e,n=await s.getAjaxPromise(t,"jsonp",!1,"The protein accession "+e+" can not be mapped to AlphaFold UniProt ID...");if(n&&n.uniprot){i.uniprot2acc||(i.uniprot2acc={});let t=n.uniprot;i.uniprot2acc[t]=e,i.struArray.push(t),i.inputChainidArray.push(t+"_A")}else console.log("The accession "+refseqid+" can not be mapped to AlphaFold UniProt ID. It will be treated as a UniProt ID instead."),i.struArray.push(e),i.inputChainidArray.push(e+"_A")}else if(-1!=e.indexOf("_")){let t=e.substr(0,e.indexOf("_")).substr(0,4);i.struArray.push(t),i.inputChainidArray.push(e)}else e.length>5&&(i.struArray.push(e),i.inputChainidArray.push(e+"_A"))}getChainid(e,t){this.icn3d.icn3dui;let i=!1,s=e[0];for(let t=0,n=e.length;t<n;++t){if("pdb"==e[t]){s=e[t+1]+"_"+e[t+2],i=!0;break}if("ref"==e[t]){s=e[t+1].split(".")[0],i=!0;break}if("sp"==e[t]||"tr"==e[t]){s=e[t+1],i=!0;break}}return!i&&t&&alert("The sequence ID "+e.join("|")+" does not have the correctly formatted PDB, UniProt or RefSeq ID..."),{chainid:s,bFound:i}}}class Bh{constructor(e){this.icn3d=e}realign(){let e=this.icn3d,t=e.icn3dui;e.selectionCls.saveSelectionPrep();let i="alseq_"+(Object.keys(e.defNames2Atoms).length+Object.keys(e.defNames2Residues).length+1);e.selectionCls.saveSelection(i,i),t.htmlCls.clickMenuCls.setLogCmd("realign",!0);let s={},n={};e.realignResid={};let r="";for(let i in e.hAtoms){let a=e.atoms[i],o=a.structure+"_"+a.chain;if(e.proteins.hasOwnProperty(i)&&"CA"==a.name||e.nucleotides.hasOwnProperty(i)&&("O3'"==a.name||"O3*"==a.name)){if(a.structure+"_"+a.resi==r)continue;s.hasOwnProperty(a.structure)||(s[a.structure]=[]),s[a.structure].push(a.coord.clone()),e.realignResid.hasOwnProperty(o)||(e.realignResid[o]=[]),e.realignResid[o].push({resid:o+"_"+a.resi,resn:t.utilsCls.residueName2Abbr(a.resn.substr(0,3)).substr(0,1)}),n[a.structure]=a.structure+"_"+a.chain,r=a.structure+"_"+a.resi}}let a=Object.keys(s),o=a[0],l=[];e.qt_start_end=[],l.push(n[o]);for(let t=1,i=a.length;t<i;++t){let i=a[t],r=s[i],d=s[o],c=!0;e.ParserUtilsCls.alignCoords(r,d,i,c,n[o],n[i]),l.push(n[i])}e.hAtoms=e.chainalignParserCls.setMsa(l),i="protein_aligned",e.selectionCls.saveSelection(i,i),e.transformCls.zoominSelection(),e.hlUpdateCls.updateHlAll()}async parseChainRealignPredefined(e,t,i,s){let n,r=this.icn3d,a=r.icn3dui,o=e[0].substr(0,e[0].indexOf("_")),l={};r.realignResid={},r.opts.color="grey",r.setColorCls.setColorByOptions(r.opts,r.dAtoms),r.qt_start_end=[];let d={};for(let c=0,h=e.length-1;c<h;++c){let h=e[c+1].substr(0,e[c+1].indexOf("_")),p=o+e[0].substr(e[0].indexOf("_")),u=h+e[c+1].substr(e[c+1].indexOf("_"));d[p]=1,d[u]=1,e[0]=p,e[c+1]=u;let m=p+","+u;if(!t[m])continue;let f=t[m][o],g=t[m][h],b=i[m][o],C=i[m][h],v=s[m][o],_=s[m][h];r.realignResid[p]=[],r.realignResid[u]=[];for(let e=0,t=f.length;e<t;++e)r.realignResid[p].push({resid:v[e],resn:f[e]}),r.realignResid[u].push({resid:_[e],resn:g[e]});let y=!0,S=r.ParserUtilsCls.alignCoords(C,b,h,void 0,p,u,c+1,y);l=a.hashUtilsCls.unionHash(l,S.hAtoms),n=parseFloat(S.rmsd)}if(!a.cfg.usepdbnum&&a.cfg.resdef&&n>5&&a.cfg.chainalign){console.log("RMSD from VAST is larger than 5. Realign the chains with TM-align.");let e=Object.keys(d);e.length>0&&(r.hAtoms=r.definedSetsCls.getAtomsFromNameArray(e)),a.cfg.aligntool="tmalign",await r.realignParserCls.realignOnStructAlign()}else r.hAtoms=r.chainalignParserCls.setMsa(e),r.transformCls.zoominSelection(),await r.chainalignParserCls.downloadChainalignmentPart3(void 0,e,r.hAtoms)}async parseChainRealignData(e,t,i,s,n,r,a){let o=this.icn3d,l=o.icn3dui,d=i[0].substr(0,i[0].indexOf("_"));a||(d=d.toUpperCase());let c={};o.realignResid={},o.opts.color="grey",o.setColorCls.setColorByOptions(o.opts,o.dAtoms),o.qt_start_end=[];for(let t=0,h=e.length;t<h;++t){let h=e[t].value;if(!h)continue;let p=i[t+1].substr(0,i[t+1].indexOf("_"));a||(p=p.toUpperCase());let u=d+i[0].substr(i[0].indexOf("_")),m=p+i[t+1].substr(i[t+1].indexOf("_"));i[0]=u,i[t+1]=m;let f,g,b=s[u],C=s[m],v=n[u],_=n[m],y=r[u],S=r[m];if(void 0!==h.data){f=h.data[0].query;let e=Object.keys(h.data[0].targets)[0];g=h.data[0].targets[e],g=g.hsps[0]}if(void 0!==f&&void 0!==g){let e=[],i=[],s="",n="";o.realignResid[u]=[],o.realignResid[m]=[];let r=g.segs;for(let t=0,a=r.length;t<a;++t){let a=r[t],l="",d="";for(let t=0;t<=a.orito-a.orifrom;++t){let r=y[t+a.orifrom].substr(0,y[t+a.orifrom].lastIndexOf("_")),c=S[t+a.from].substr(0,S[t+a.from].lastIndexOf("_"));v[t+a.orifrom]&&_[t+a.from]&&(e.push(v[t+a.orifrom]),i.push(_[t+a.from]),s+=b[t+a.orifrom],n+=C[t+a.from],(0==t||l==r&&d==c||l!=r&&d!=c)&&(o.realignResid[u].push({resid:y[t+a.orifrom],resn:b[t+a.orifrom]}),o.realignResid[m].push({resid:S[t+a.from],resn:C[t+a.from]})),l=r,d=c)}}let a,h=!0;a=o.bAfMem?o.ParserUtilsCls.alignCoords(i,e,d,void 0,u,m,t+1,h):o.ParserUtilsCls.alignCoords(i,e,p,void 0,u,m,t+1,h),c=l.hashUtilsCls.unionHash(c,a.hAtoms)}else void 0!==p||l.cfg.command?b&&C&&((b.length<6||C.length<6)&&!l.cfg.command?o.bRender&&alert("These sequences are too short for alignment"):b.length>=6&&C.length>=6&&!l.cfg.command&&o.bRender&&alert("These sequences can not be aligned to each other")):o.bRender&&alert("Please do not align residues in the same structure")}if(a){o.hAtoms=o.chainalignParserCls.setMsa(i);let e="protein_aligned";if(o.selectionCls.saveSelection(e,e),o.bAfMem?(o.selectionCls.selectAll_base(),o.opts.chemicals="stick",o.opts.color="confidence",o.setColorCls.setColorByOptions(o.opts,o.atoms)):(o.transformCls.zoominSelection(),o.dAtoms=l.hashUtilsCls.cloneHash(o.hAtoms),o.opts.color="identity",o.setColorCls.setColorByOptions(o.opts,o.hAtoms)),o.drawCls.draw(),o.hlUpdateCls.updateHlAll(),o.bAfMem){let e=new mt(1,0,0),t=-.5*Math.PI;o.transformCls.setRotation(e,t)}}else o.hAtoms=o.chainalignParserCls.setMsa(i),o.transformCls.zoominSelection(),await o.chainalignParserCls.downloadChainalignmentPart3(t,i,o.hAtoms)}async realignOnSeqAlign(e){let t=this.icn3d;t.icn3dui;let i=t.firstAtomObjCls.getChainsFromAtoms(t.hAtoms),s=Object.keys(i),n=[],r="";for(let e=0,t=s.length;e<t;++e)s[e]!=r&&n.push(s[e]),r=s[e];t.qt_start_end=[],await this.realignChainOnSeqAlign(void 0,n,!0)}async realignOnStructAlign(e,t){let i=this.icn3d,s=i.icn3dui,n="tmalign"!=s.cfg.aligntool?3:0,r=[],a=[],o=s.htmlCls.baseUrl+"vastdyn/vastdyn.cgi",l=s.htmlCls.baseUrl+"tmalign/tmalign.cgi",d={};if(t&&s.cfg.resrange){let e=decodeURIComponent(s.cfg.resrange).split(" | "),t=i.realignParserCls.getSeqCoorResid([e[0]],i.chainidArray[0],!0).hAtoms;for(let n=1,d=i.chainidArray.length;n<d;++n){let d,c=i.realignParserCls.getSeqCoorResid([e[n]],i.chainidArray[n],!0).hAtoms;if("tmalign"!=s.cfg.aligntool){let e={domains1:i.domain3dCls.getDomainJsonForAlign(c),domains2:i.domain3dCls.getDomainJsonForAlign(t)};d=s.getAjaxPostPromise(o,e)}else{let e={pdb_query:i.saveFileCls.getAtomPDB(c),pdb_target:i.saveFileCls.getAtomPDB(t)};d=s.getAjaxPostPromise(l,e)}r.push(d),a.push(i.chainidArray[0]+","+i.chainidArray[n])}}else{for(let e in i.structures){d[e]={};let t=i.structures[e];for(let r=0,a=t.length;r<a;++r){let a=t[r],o=s.hashUtilsCls.intHash(i.hAtoms,i.chains[a]),l=0;for(let t in o)if(i.atoms[t].ssbegin&&++l,l>n){d[e][a]=o;break}}}let t=Object.keys(d);e&&(t=t.reverse());for(let e=0,n=t.length;e<n;++e){let n=t[e],c=Object.keys(d[n]);if(0!=c.length)for(let h=0,p=c.length;h<p;++h){let p=c[h],u=i.domain3dCls.getDomainJsonForAlign(d[n][p]);for(let c=e+1,h=t.length;c<h;++c){let e=t[c],h=Object.keys(d[e]);if(0!=h.length)for(let t=0,c=h.length;t<c;++t){let c,m=h[t];if("tmalign"!=s.cfg.aligntool){let t={domains1:i.domain3dCls.getDomainJsonForAlign(d[e][m]),domains2:u};c=s.getAjaxPostPromise(o,t)}else{let t=i.saveFileCls.getAtomPDB(d[n][p],void 0,void 0,void 0,void 0,n),r={pdb_query:i.saveFileCls.getAtomPDB(d[e][m],void 0,void 0,void 0,void 0,e),pdb_target:t};c=s.getAjaxPostPromise(l,r)}r.push(c),a.push(p+","+m)}}}}}let c=Promise.allSettled(r),h=await c;i.qt_start_end=[],await i.chainalignParserCls.downloadChainalignmentPart2bRealign(h,a,e)}async realignOnStructAlignMsa(e){let t=this.icn3d,i=t.icn3dui,s="tmalign"!=i.cfg.aligntool?3:0,n={};for(let r=0,a=e.length;r<a;++r){let a=e[r],o=i.hashUtilsCls.intHash(t.hAtoms,t.chains[a]),l=0;for(let e in o)if(t.atoms[e].ssbegin&&++l,l>s){n[a]=o;break}}let r=[],a=[],o=[],l=i.htmlCls.baseUrl+"vastdyn/vastdyn.cgi",d=i.htmlCls.baseUrl+"tmalign/tmalign.cgi",c=e[0],h=c.substr(0,c.indexOf("_")),p=t.domain3dCls.getDomainJsonForAlign(n[c]);for(let s=1,u=e.length;s<u;++s){let u,m=e[s],f=m.substr(0,m.indexOf("_"));if("tmalign"!=i.cfg.aligntool){let e={domains1:t.domain3dCls.getDomainJsonForAlign(n[m]),domains2:p};u=i.getAjaxPostPromise(l,e)}else{let e=t.saveFileCls.getAtomPDB(t.chains[c],void 0,void 0,void 0,void 0,h),s={pdb_query:t.saveFileCls.getAtomPDB(t.chains[m],void 0,void 0,void 0,void 0,f),pdb_target:e};u=i.getAjaxPostPromise(d,s)}r.push(u),a.push(s-1),o.push(f)}let u=Promise.allSettled(r),m=await u;t.t_trans_add=[],t.q_trans_sub=[],"tmalign"==i.cfg.aligntool&&(t.q_trans_add=[]),t.q_rotation=[],t.qt_start_end=[],await t.chainalignParserCls.downloadChainalignmentPart2b(void 0,e,void 0,m,a,h,o)}async realignChainOnSeqAlign(e,t,i,s){let n=this.icn3d,r=n.icn3dui,a=this;r.cfg.aligntool="seqalign";let o,l,d,c,h,p,u={},m={},f={},g=[],b=r.htmlCls.baseUrl+"pwaln/pwaln.fcgi?from=chainalign";if(s&&(d=decodeURIComponent(r.cfg.resdef).trim().replace(/\+/gi," ").split("; "),d.length!=t.length-1))alert("Please make sure the number of chains and the lines of predefined residues are the same...");else{for(let e=0,v=t.length;e<v;++e){let v=t[e].indexOf("_"),_=t[e].substr(0,v);0==e&&(o=_);let y=_+t[e].substr(v);if(0==e&&(l=y),n.chainsSeq&&n.chainsSeq[y])if(u.hasOwnProperty(y)||s||(u[y]="",m[y]=[],f[y]=[]),s)if(0==e);else{let t={};c=d[e-1].split(" | ");let i=l+","+y;u[i]||(u[i]={}),m[i]||(m[i]={}),f[i]||(f[i]={}),p=c[0].split(","),h=a.getSeqCoorResid(p,l),t=r.hashUtilsCls.unionHash(t,h.hAtoms),u[i][o]||(u[i][o]=""),m[i][o]||(m[i][o]=[]),f[i][o]||(f[i][o]=[]),u[i][o]+=h.seq,m[i][o]=m[i][o].concat(h.coor),f[i][o]=f[i][o].concat(h.resid),p=c[1].split(","),h=a.getSeqCoorResid(p,y),t=r.hashUtilsCls.unionHash(t,h.hAtoms),u[i][_]||(u[i][_]=""),m[i][_]||(m[i][_]=[]),f[i][_]||(f[i][_]=[]),u[i][_]+=h.seq,m[i][_]=m[i][_].concat(h.coor),f[i][_]=f[i][_].concat(h.resid)}else if(0==e){if(p=[],i){let e=n.firstAtomObjCls.getResiduesFromAtoms(n.hAtoms);for(var C in e){let e=C.substr(C.lastIndexOf("_")+1);C.substr(0,C.lastIndexOf("_"))==y&&p.push(e)}}else r.cfg.resnum&&(p=r.cfg.resnum.split(","));h=a.getSeqCoorResid(p,y),u[y]+=h.seq,m[y]=m[y].concat(h.coor),f[y]=f[y].concat(h.resid)}else{let e=!1;if(i){let t=n.firstAtomObjCls.getResiduesFromAtoms(n.hAtoms);for(var C in t){if(C.substr(0,C.lastIndexOf("_"))==y){e=!0;let t=n.firstAtomObjCls.getFirstAtomObj(n.residues[C]).resn;u[y]+=r.utilsCls.residueName2Abbr(t),m[y]=m[y].concat(this.getResCoorArray(C)),f[y].push(C)}}}if(!e)for(let e=0,t=n.chainsSeq[y].length;e<t;++e){u[y]+=n.chainsSeq[y][e].name;let t=y+"_"+n.chainsSeq[y][e].resi;m[y]=m[y].concat(this.getResCoorArray(t)),f[y].push(t)}let t={targets:u[l],queries:u[y]},s=r.getAjaxPostPromise(b,t);g.push(s)}}if(s)await a.parseChainRealignPredefined(t,u,m,f);else{let s=Promise.allSettled(g);try{let n=await s;await a.parseChainRealignData(n,e,t,u,m,f,i)}catch(e){return void alert("The realignment did not work...")}}}}getSeqCoorResid(e,t,i){let s=this.icn3d,n=s.icn3dui,r="",a=[],o=[],l={};for(let l=0,d=e.length;l<d;++l)if(-1!=e[l].indexOf("-")){let d=e[l].split("-");for(let e=parseInt(d[0]);e<=parseInt(d[1]);++e){let l=i?e:s.setSeqAlignCls.getPosFromResi(t,e);if(!s.chainsSeq[t]||!s.chainsSeq[t][l]||-1==n.parasCls.b62ResArray.indexOf(s.chainsSeq[t][l].name.toUpperCase()))continue;r+=s.chainsSeq[t][l].name.toUpperCase();let d=i?s.ncbi2resid[t+"_"+e]:t+"_"+e;a=a.concat(this.getResCoorArray(d)),o.push(d)}}else if(0==e[l]){let e=s.firstAtomObjCls.getResiduesFromAtoms(s.chains[t]);o=Object.keys(e)}else{let n=e[l],d=i?n:s.setSeqAlignCls.getPosFromResi(t,n);if(!s.chainsSeq[t][d])continue;let c=i?s.ncbi2resid[t+"_"+n]:t+"_"+n,h=this.getResCoorArray(c);r+=s.chainsSeq[t][d].name.toUpperCase(),a=a.concat(h),o.push(c)}for(let e=0,t=o.length;e<t;++e)l=n.hashUtilsCls.unionHash(l,s.residues[o[e]]);return{seq:r,coor:a,resid:o,hAtoms:l}}getResCoorArray(e){let t=this.icn3d;t.icn3dui;let i=[],s=!1;for(let n in t.residues[e]){let e=t.atoms[n];if("CA"==e.name&&"C"==e.elem||("O3'"==e.name||"O3*"==e.name)&&"O"==e.elem){i.push(e.coord.clone()),s=!0;break}}return s||i.push(void 0),i}}class zh{constructor(e){this.icn3d=e}async densityCifParser(e,t,i,s,n){let r,a=this.icn3d,o=a.icn3dui,l=this,d=o.utilsCls.isMobile()||o.cfg.notebook?0:4;if("2fofc"==t||"fofc"==t){let t=a.contactCls.getExtent(a.atoms);r="https://www.ebi.ac.uk/pdbe/volume-server/x-ray/"+e.toLowerCase()+"/box/"+t[0][0]+","+t[0][1]+","+t[0][2]+"/"+t[1][0]+","+t[1][1]+","+t[1][2]+"?detail="+d}else"em"==t&&(d=o.utilsCls.isMobile()||o.cfg.notebook?0:5,r="https://www.ebi.ac.uk/pdbe/densities/emd/"+s.toLowerCase()+"/cell?detail="+d);if("2fofc"==t&&a.bAjax2fofc)a.mapData.sigma2=i,a.setOptionCls.setOption("map",t);else if("fofc"==t&&a.bAjaxfofc)a.mapData.sigma=i,a.setOptionCls.setOption("map",t);else if("em"==t&&a.bAjaxEm)a.mapData.sigmaEm=i,a.setOptionCls.setOption("emmap",t);else{let e=await o.getXMLHttpRqstPromise(r,"GET","arraybuffer",t);l.parseChannels(e,t,i),"2fofc"==t||"fofc"==t?(a.bAjax2fofc=!0,a.bAjaxfofc=!0,a.setOptionCls.setOption("map",t)):"em"==t&&(a.bAjaxEm=!0,a.setOptionCls.setOption("emmap",t))}}async densityCifParserBase(e,t,i,s,n){let r=this.icn3d,a=r.icn3dui,o=this;if("2fofc"==t&&r.bAjax2fofc)r.mapData.sigma2=i,r.setOptionCls.setOption("map",t);else if("fofc"==t&&r.bAjaxfofc)r.mapData.sigma=i,r.setOptionCls.setOption("map",t);else{let s=await a.getXMLHttpRqstPromise(e,"GET","arraybuffer",t);o.parseChannels(s,t,i),"2fofc"==t||"fofc"==t?(r.bAjax2fofc=!0,r.bAjaxfofc=!0,r.setOptionCls.setOption("map",t)):"em"==t&&(r.bAjaxEm=!0,r.setOptionCls.setOption("emmap",t))}}setMatrix(e){this.icn3d.icn3dui;let t=e.box.sampleCount,i={xExtent:t[0],yExtent:t[1],zExtent:t[2],mean:e.valuesInfo.mean,sigma:e.valuesInfo.sigma,max:e.valuesInfo.max,min:e.valuesInfo.min};for(let t=0;t<e.data.length;++t)e.data[t];let s=e.box.origin,n=e.box.dimensions,r=e.spacegroup.basis,a=(new gi).makeScale(n[0]/t[0],n[1]/t[1],n[2]/t[2]),o=(new gi).makeTranslation(s[0],s[1],s[2]);return{matrix:(new gi).set(r.x[0],r.y[0],r.z[0],0,0,r.y[1],r.z[1],0,0,0,r.z[2],0,0,0,0,1).multiply(o).multiply(a),header:i}}parseChannels(e,t,i){let s=this.icn3d;s.icn3dui;let n=this.BinaryParse(e);if("2fofc"==t||"fofc"==t){let e=this.getChannel(n,"2FO-FC"),r=this.getChannel(n,"FO-FC"),a=e,o=this.setMatrix(a);s.mapData.matrix2=o.matrix,s.mapData.header2=o.header,s.mapData.data2=a.data,s.mapData.type2=t,s.mapData.sigma2=i,a=r,o=this.setMatrix(a),s.mapData.matrix=o.matrix,s.mapData.header=o.header,s.mapData.data=a.data,s.mapData.type=t,s.mapData.sigma=i}else if("em"==t){let e=this.getChannel(n,"EM"),r=this.setMatrix(e);s.mapData.matrixEm=r.matrix,s.mapData.headerEm=r.header,s.mapData.dataEm=e.data,s.mapData.typeEm=t,s.mapData.sigmaEm=i}}getChannel(e,t){this.icn3d.icn3dui;let i,s=e.toJSON();for(let n=0,r=s.length;n<r;++n)s[n].id==t&&(i=e.dataBlocks[n]);return this.CIFParse(i)}CIFParse(e){this.icn3d.icn3dui;let t=e.getCategory("_volume_data_3d_info");if(!t)return void conole.log("_volume_data_3d_info category is missing.");if(!e.getCategory("_volume_data_3d"))return void conole.log("_volume_data_3d category is missing.");function i(e){let i=[0,0,0];for(let s=0;s<3;s++)i[s]=t.getColumn(e+"["+s+"]").getFloat(0);return i}function s(e){return t.getColumn(e).getFloat(0)}let n={name:t.getColumn("name").getString(0),axisOrder:i("axis_order"),origin:i("origin"),dimensions:i("dimensions"),sampleCount:i("sample_count"),spacegroupNumber:0|s("spacegroup_number"),cellSize:i("spacegroup_cell_size"),cellAngles:i("spacegroup_cell_angles"),mean:s("mean_sampled"),sigma:s("sigma_sampled")},r=[0,0,0];function a(e){return[e[r[0]],e[r[1]],e[r[2]]]}r[n.axisOrder[0]]=0,r[n.axisOrder[1]]=1,r[n.axisOrder[2]]=2;let o=a(n.sampleCount),l=function(e,t,i,s){let n=new Float32Array(t[0]*t[1]*t[2]),r=[0,0,0],a=s[0],o=s[1],l=s[2],d=i[0],c=i[1],h=i[2];t[0],t[0],t[1];let p=t[2],u=t[1]*t[2],m=0,f=e.getFloat(0),g=f;for(let t=0;t<h;t++){r[2]=t;for(let t=0;t<c;t++){r[1]=t;for(let t=0;t<d;t++){r[0]=t;let i=e.getFloat(m);m+=1,n[r[l]+r[o]*p+r[a]*u]=i,i<f?f=i:i>g&&(g=i)}}}return{data:n,min:f,max:g}}(e.getCategory("_volume_data_3d").getColumn("values"),o,n.sampleCount,r);return{name:n.name,spacegroup:function(e,t,i){let s=Math.PI/180*i[0],n=Math.PI/180*i[1],r=Math.PI/180*i[2],a=t[0],o=t[1],l=t[2],d=Math.cos(n),c=(Math.cos(s)-Math.cos(n)*Math.cos(r))/Math.sin(r),h=Math.sqrt(1-d*d-c*c);return{number:e,size:t,angles:i,basis:{x:[a,0,0],y:[Math.cos(r)*o,Math.sin(r)*o,0],z:[d*l,c*l,h*l]}}}(n.spacegroupNumber,n.cellSize,n.cellAngles),box:{origin:a(n.origin),dimensions:a(n.dimensions),sampleCount:o},data:l.data,valuesInfo:{min:l.min,max:l.max,mean:n.mean,sigma:n.sigma}}}BinaryParse(e){this.icn3d.icn3dui;let t=new Uint8Array(e),i=this.MessagePackParse({buffer:t,offset:0,dataView:new DataView(t.buffer)}),s=function(){function e(e){this.additionalData={},this.header=e.header,this.categoryList=e.categories.map((function(e){return new n(e)})),this.categoryMap=new Map;for(let e=0,t=this.categoryList;e<t.length;e++){let i=t[e];this.categoryMap.set(i.name,i)}}return Object.defineProperty(e.prototype,"categories",{get:function(){return this.categoryList},enumerable:!0,configurable:!0}),e.prototype.getCategory=function(e){return this.categoryMap.get(e)},e.prototype.toJSON=function(){return{id:this.header,categories:this.categoryList.map((function(e){return e.toJSON()})),additionalData:this.additionalData}},e}(),n=function(){function e(e){this.name=e.name,this.columnCount=e.columns.length,this.rowCount=e.rowCount,this.columnNameList=[],this.encodedColumns=new Map;for(let t=0,i=e.columns;t<i.length;t++){let e=i[t];this.encodedColumns.set(e.name,e),this.columnNameList.push(e.name)}}Object.defineProperty(e.prototype,"columnNames",{get:function(){return this.columnNameList},enumerable:!0,configurable:!0});let t=function(){function e(){this.isDefined=!1}return e.prototype.getString=function(e){return null},e.prototype.getInteger=function(e){return 0},e.prototype.getFloat=function(e){return 0},e.prototype.getValuePresence=function(e){return 1},e.prototype.areValuesEqual=function(e,t){return!0},e.prototype.stringEquals=function(e,t){return null===t},e}();return e.prototype.getColumn=function(e){let i=this.encodedColumns.get(e);return i?p(i):t},e.prototype.toJSON=function(){let e=this,t=[],i=this.columnNameList.map((function(t){return{name:t,column:e.getColumn(t)}}));for(let e=0;e<this.rowCount;e++){let s={};for(let t=0,n=i;t<n.length;t++){let i=n[t],r=i.column.getValuePresence(e);s[i.name]=0===r?i.column.getString(e):1===r?".":"?"}t[e]=s}return{name:this.name,columns:this.columnNames,rows:t}},e}();function r(e,t){switch(e){case 1:return new Int8Array(t);case 2:return new Int16Array(t);case 3:return new Int32Array(t);case 4:return new Uint8Array(t);case 5:return new Uint16Array(t);case 6:return new Uint32Array(t);default:throw new Error("Unsupported integer data type.")}}function a(e,t){switch(e){case 32:return new Float32Array(t);case 33:return new Float64Array(t);default:throw new Error("Unsupported floating data type.")}}let o=function(){let e=new ArrayBuffer(2),t=new Uint8Array(e),i=new Uint16Array(e);return t[0]=170,t[1]=187,48042===i[0]}();function l(e,t,i){return new i(o?e.buffer:function(e,t){let i=new ArrayBuffer(e.length),s=new Uint8Array(i);for(let i=0,n=e.length;i<n;i+=t)for(let n=0;n<t;n++)s[i+t-n-1]=e[i+n];return i}(e,t))}function d(e,t){return t.isUnsigned?function(e,t){let i=1===t.byteCount?255:65535,s=e.length,n=new Int32Array(t.srcSize),r=0,a=0;for(;r<s;){let t=0,s=e[r];for(;s===i;)t+=s,r++,s=e[r];t+=s,n[a]=t,r++,a++}return n}(e,t):function(e,t){let i=1===t.byteCount?127:32767,s=-i-1,n=e.length,r=new Int32Array(t.srcSize),a=0,o=0;for(;a<n;){let t=0,n=e[a];for(;n===i||n===s;)t+=n,a++,n=e[a];t+=n,r[o]=t,a++,o++}return r}(e,t)}function c(e,t){switch(t.kind){case"ByteArray":switch(t.type){case 4:return e;case 1:return function(e){return new Int8Array(e.buffer,e.byteOffset)}(e);case 2:return function(e){return l(e,2,Int16Array)}(e);case 5:return function(e){return l(e,2,Uint16Array)}(e);case 3:return function(e){return l(e,4,Int32Array)}(e);case 6:return function(e){return l(e,4,Uint32Array)}(e);case 32:return function(e){return l(e,4,Float32Array)}(e);case 33:return function(e){return l(e,8,Float64Array)}(e);default:throw new Error("Unsupported ByteArray type.")}case"FixedPoint":return function(e,t){let i=e.length,s=a(t.srcType,i),n=1/t.factor;for(let t=0;t<i;t++)s[t]=n*e[t];return s}(e,t);case"IntervalQuantization":return function(e,t){let i=e.length,s=a(t.srcType,i),n=(t.max-t.min)/(t.numSteps-1),r=t.min;for(let t=0;t<i;t++)s[t]=r+n*e[t];return s}(e,t);case"RunLength":return function(e,t){let i=r(t.srcType,t.srcSize),s=0;for(let t=0,n=e.length;t<n;t+=2){let n=e[t],r=e[t+1];for(let e=0;e<r;++e)i[s++]=n}return i}(e,t);case"Delta":return function(e,t){let i=e.length,s=r(t.srcType,i);if(!i)return s;s[0]=e[0]+(0|t.origin);for(let t=1;t<i;++t)s[t]=e[t]+s[t-1];return s}(e,t);case"IntegerPacking":return d(e,t);case"StringArray":return function(e,t){let i=t.stringData,s=h({encoding:t.offsetEncoding,data:t.offsets}),n=h({encoding:t.dataEncoding,data:e}),r=Object.create(null),a=new Array(n.length),o=0;for(let e=0,t=n;e<t.length;e++){let n=t[e];if(n<0){a[o++]=null;continue}let l=r[n];void 0===l&&(l=i.substring(s[n],s[n+1]),r[n]=l),a[o++]=l}return a}(e,t)}}function h(e){let t=e.data;for(let i=e.encoding.length-1;i>=0;i--)t=c(t,e.encoding[i]);return t}function p(e){if(!e.data.data)return _UndefinedColumn;let t,i=h(e.data);return e.mask&&(t=h(e.mask)),i.buffer&&i.byteLength&&i.BYTES_PER_ELEMENT?t?new g(i,t):new f(i):t?new C(i,t):new b(i)}function u(e,t,i){let s=0,n=1;for(45===e.charCodeAt(t)&&(n=-1,t++);t<i;t++){let i=e.charCodeAt(t)-48;if(i>9||i<0)return n*s|0;s=10*s+i|0}return n*s}function m(e,t,i){let s=1,n=0,r=0,a=1;for(45===e.charCodeAt(t)&&(s=-1,++t);t<i;){let o=e.charCodeAt(t)-48;if(!(o>=0&&o<10)){if(-2===o){for(++t;t<i;){if(o=e.charCodeAt(t)-48,!(o>=0&&o<10))return 53===o||21===o?parseScientific(s*(n+r/a),e,t+1,i):s*(n+r/a);r=10*r+o,a*=10,++t}return s*(n+r/a)}if(53===o||21===o)return parseScientific(s*n,e,t+1,i);break}n=10*n+o,++t}return s*n}let f=function(){function e(e){this.data=e,this.isDefined=!0}return e.prototype.getString=function(e){return""+this.data[e]},e.prototype.getInteger=function(e){return 0|this.data[e]},e.prototype.getFloat=function(e){return 1*this.data[e]},e.prototype.stringEquals=function(e,t){return this.data[e]===m(t,0,t.length)},e.prototype.areValuesEqual=function(e,t){return this.data[e]===this.data[t]},e.prototype.getValuePresence=function(e){return 0},e}(),g=function(){function e(e,t){this.data=e,this.mask=t,this.isDefined=!0}return e.prototype.getString=function(e){return 0===this.mask[e]?""+this.data[e]:null},e.prototype.getInteger=function(e){return 0===this.mask[e]?this.data[e]:0},e.prototype.getFloat=function(e){return 0===this.mask[e]?this.data[e]:0},e.prototype.stringEquals=function(e,t){return 0===this.mask[e]?this.data[e]===m(t,0,t.length):null==t},e.prototype.areValuesEqual=function(e,t){return this.data[e]===this.data[t]},e.prototype.getValuePresence=function(e){return this.mask[e]},e}(),b=function(){function e(e){this.data=e,this.isDefined=!0}return e.prototype.getString=function(e){return this.data[e]},e.prototype.getInteger=function(e){let t=this.data[e];return u(t,0,t.length)},e.prototype.getFloat=function(e){let t=this.data[e];return m(t,0,t.length)},e.prototype.stringEquals=function(e,t){return this.data[e]===t},e.prototype.areValuesEqual=function(e,t){return this.data[e]===this.data[t]},e.prototype.getValuePresence=function(e){return 0},e}(),C=function(){function e(e,t){this.data=e,this.mask=t,this.isDefined=!0}return e.prototype.getString=function(e){return 0===this.mask[e]?this.data[e]:null},e.prototype.getInteger=function(e){if(0!==this.mask[e])return 0;let t=this.data[e];return u(t||"",0,(t||"").length)},e.prototype.getFloat=function(e){if(0!==this.mask[e])return 0;let t=this.data[e];return m(t||"",0,(t||"").length)},e.prototype.stringEquals=function(e,t){return this.data[e]===t},e.prototype.areValuesEqual=function(e,t){return this.data[e]===this.data[t]},e.prototype.getValuePresence=function(e){return this.mask[e]},e}(),v=function(){function e(e){this.dataBlocks=e.dataBlocks.map((function(e){return new s(e)}))}return e.prototype.toJSON=function(){return this.dataBlocks.map((function(e){return e.toJSON()}))},e}();return new v(i)}MessagePackParse(e){this.icn3d.icn3dui;let t=this;function i(e,i){let s={};for(let n=0;n<i;n++){s[t.MessagePackParse(e)]=t.MessagePackParse(e)}return s}function s(e,t){let i=new Uint8Array(t),s=e.offset;for(let n=0;n<t;n++)i[n]=e.buffer[n+s];return e.offset+=t,i}function n(e,i){let s=new Array(i);for(let n=0;n<i;n++)s[n]=t.MessagePackParse(e);return s}function r(e,t){let i=function(e,t,i){let s,n=a,r=[],o=512,l=0;for(let a=t,d=t+i;a<d;a++){let t=e[a];128&t?192==(224&t)?r[l++]=n[(15&t)<<6|63&e[++a]]:224==(240&t)?r[l++]=String.fromCharCode((15&t)<<12|(63&e[++a])<<6|63&e[++a]):240==(248&t)?r[l++]=String.fromCharCode((7&t)<<18|(63&e[++a])<<12|(63&e[++a])<<6|63&e[++a]):throwError("Invalid byte "+t.toString(16)):r[l++]=n[t],l===o&&(s=s||[],s[s.length]=r.join(""),l=0)}if(!s)return r.slice(0,l).join("");l>0&&(s[s.length]=r.slice(0,l).join(""));return s.join("")}(e.buffer,e.offset,t);return e.offset+=t,i}let a=function(){let e=[];for(let t=0;t<1024;t++)e[t]=String.fromCharCode(t);return e}();let o,l,d=e.buffer[e.offset];if(!(128&d))return e.offset++,d;if(128==(240&d))return l=15&d,e.offset++,i(e,l);if(144==(240&d))return l=15&d,e.offset++,n(e,l);if(160==(224&d))return l=31&d,e.offset++,r(e,l);if(!(224&~d))return o=e.dataView.getInt8(e.offset),e.offset++,o;switch(d){case 192:return e.offset++,null;case 194:return e.offset++,!1;case 195:return e.offset++,!0;case 196:return l=e.dataView.getUint8(e.offset+1),e.offset+=2,s(e,l);case 197:return l=e.dataView.getUint16(e.offset+1),e.offset+=3,s(e,l);case 198:return l=e.dataView.getUint32(e.offset+1),e.offset+=5,s(e,l);case 202:return o=e.dataView.getFloat32(e.offset+1),e.offset+=5,o;case 203:return o=e.dataView.getFloat64(e.offset+1),e.offset+=9,o;case 204:return o=e.buffer[e.offset+1],e.offset+=2,o;case 205:return o=e.dataView.getUint16(e.offset+1),e.offset+=3,o;case 206:return o=e.dataView.getUint32(e.offset+1),e.offset+=5,o;case 208:return o=e.dataView.getInt8(e.offset+1),e.offset+=2,o;case 209:return o=e.dataView.getInt16(e.offset+1),e.offset+=3,o;case 210:return o=e.dataView.getInt32(e.offset+1),e.offset+=5,o;case 217:return l=e.dataView.getUint8(e.offset+1),e.offset+=2,r(e,l);case 218:return l=e.dataView.getUint16(e.offset+1),e.offset+=3,r(e,l);case 219:return l=e.dataView.getUint32(e.offset+1),e.offset+=5,r(e,l);case 220:return l=e.dataView.getUint16(e.offset+1),e.offset+=3,n(e,l);case 221:return l=e.dataView.getUint32(e.offset+1),e.offset+=5,n(e,l);case 222:return l=e.dataView.getUint16(e.offset+1),e.offset+=3,i(e,l);case 223:return l=e.dataView.getUint32(e.offset+1),e.offset+=5,i(e,l)}}}class qh{constructor(e){this.icn3d=e}alignCoords(e,t,i,s,n,r,a,o){let l,d=this.icn3d,c=d.icn3dui,h=e.length<t.length?e.length:t.length,p={};if(h<4&&alert("Please select at least four residues in each structure..."),h>=4&&(d.bAfMem?d.rmsd_suprTmp=c.rmsdSuprCls.getRmsdSuprCls(t,e,h):d.rmsd_suprTmp=c.rmsdSuprCls.getRmsdSuprCls(e,t,h),void 0!==d.rmsd_suprTmp.rot)){let e=d.rmsd_suprTmp.rot;null===e[0]&&alert("Please select more residues in each structure...");let t=d.rmsd_suprTmp.trans1,s=d.rmsd_suprTmp.trans2;if(l=d.rmsd_suprTmp.rmsd,l){c.htmlCls.clickMenuCls.setLogCmd("realignment RMSD: "+l.toPrecision(4),!1);let e="<br><b>Realignment RMSD</b>: "+l.toPrecision(4)+" &#8491;<br><br>";d.bAfMem&&!c.cfg.chainalign&&(e+=c.utilsCls.getMemDesc()),$("#"+d.pre+"dl_rmsd_html").html(e),c.cfg.bSidebyside||c.htmlCls.dialogCls.openDlg("dl_rmsd","Realignment RMSD")}let a={};for(let n=0,r=d.structures[i].length;n<r;++n){let r=d.structures[i][n];if(!a.hasOwnProperty(r)){for(let i in d.chains[r]){let n=d.atoms[i];n.coord=d.surfaceCls.transformMemPro(n.coord,e,t,s)}a[r]=1}}d.bRealign=!0,o||(d.opts.color="identity",d.setColorCls.setColorByOptions(d.opts,d.hAtoms)),d.qt_start_end||(d.qt_start_end=[]);let h=this.getQtStartEndFromRealignResid(n,r);d.qt_start_end.push(h),p=d.hAtoms}return{hAtoms:p,rmsd:l}}getQtStartEndFromRealignResid(e,t){let i=this.icn3d;i.icn3dui,e.substr(0,e.indexOf("_")),t.substr(0,t.indexOf("_"));let s=[],n={};for(let t=0,s=i.chainsSeq[e].length;t<s;++t){n[i.chainsSeq[e][t].resi]=t+1}let r={};for(let e=0,s=i.chainsSeq[t].length;e<s;++e){r[i.chainsSeq[t][e].resi]=e+1}for(let a=0,o=i.realignResid[e].length;a<o&&a<i.realignResid[t].length;++a){let o=i.realignResid[e][a].resid;if(!o)continue;let l=o.lastIndexOf("_"),d=parseInt(o.substr(l+1)),c=i.realignResid[t][a].resid;if(!c)continue;let h=c.lastIndexOf("_"),p=parseInt(c.substr(h+1)),u=n[d],m=r[p];s.push({q_start:m,q_end:m,t_start:u,t_end:u})}return s}getMissingResidues(e,t,i){let s=this.icn3d,n=s.icn3dui;s.chainsSeq[i]=[];let r=0;if("mmdbid"===t||"align"===t)for(let t=0,i=e.length;t<i;++t)if(0!=e[t][0]){r=e[t][0]-(t+1);break}let a=r;for(let r=0,o=e.length;r<o;++r){let o,l;"mmdbid"===t?(o=e[r][1],l=0):"mmcifid"===t?(o=e[r][1],o=n.utilsCls.residueName2Abbr(o),l=0):"align"===t&&(o=e[r][1],l=0),""===o&&(o="x");let d={};s.bUsePdbNum?d.resi="0"==e[r][l]?parseInt(a)+1:e[r][l]:d.resi=r+1,d.name="align"===t?o.toLowerCase():o,s.chainsSeq[i].push(d),a=d.resi}}async set2DDiagramsForAlign(e,t){let i=this.icn3d,s=i.icn3dui;s.htmlCls.dialogCls.openDlg("dl_2ddgm","Interactions");let n=s.htmlCls.baseUrl+"mmdb/mmdb_strview.cgi?v=2&program=icn3d&uid="+e+"&intrac=1",r=s.htmlCls.baseUrl+"mmdb/mmdb_strview.cgi?v=2&program=icn3d&uid="+t+"&intrac=1";void 0!==s.cfg.inpara&&(n+=s.cfg.inpara,r+=s.cfg.inpara);let a=s.getAjaxPromise(n,"jsonp"),o=s.getAjaxPromise(r,"jsonp"),l=Promise.allSettled([a,o]),d=await l;i.interactionData1=d[0].value,i.html2ddgm="",i.diagram2dCls.draw2Ddgm(i.interactionData1,e,0),s.cfg.show2d&&s.htmlCls.dialogCls.openDlg("dl_2ddgm","Interactions"),i.interactionData2=d[1].value,i.diagram2dCls.draw2Ddgm(i.interactionData2,t,1),i.html2ddgm+="<br>"+i.diagram2dCls.set2DdgmNote(!0),$("#"+i.pre+"dl_2ddgm_html").html(i.html2ddgm),i.b2DShown=!0}async set2DDiagramsForChainalign(e){let t=this.icn3d.icn3dui,i=this;t.htmlCls.dialogCls.openDlg("dl_2ddgm","Interactions");let s=[];for(let i=0,n=e.length;i<n;++i){let n=e[i].indexOf("_"),r=e[i].substr(0,n).toUpperCase(),a=t.htmlCls.baseUrl+"mmdb/mmdb_strview.cgi?v=2&program=icn3d&uid="+r+"&intrac=1";void 0!==t.cfg.inpara&&(a+=t.cfg.inpara);let o=t.getAjaxPromise(a,"jsonp");s.push(o)}let n=Promise.allSettled(s);try{let t=await n;i.parse2DDiagramsData(t,e)}catch(e){}}parse2DDiagramsData(e,t){let i=this.icn3d,s=i.icn3dui;i.html2ddgm="";for(let s=0,n=t.length;s<n;++s){let n=e[s].value,r=t[s].substr(0,t[s].indexOf("_"));i.diagram2dCls.draw2Ddgm(n,r,0)}i.html2ddgm+="<br>"+i.diagram2dCls.set2DdgmNote(!0),i.b2DShown=!0,$("#"+i.pre+"dl_2ddgm_html").html(i.html2ddgm),s.cfg.show2d&&s.htmlCls.dialogCls.openDlg("dl_2ddgm","Interactions")}download2Ddgm(e,t){this.set2DDiagrams(e)}set2DDiagrams(e){let t=this.icn3d;t.icn3dui.htmlCls.dialogCls.openDlg("dl_2ddgm","Interactions"),void 0!==t.b2DShown&&t.b2DShown||(t.html2ddgm="",t.diagram2dCls.draw2Ddgm(t.interactionData,e),t.html2ddgm+="<br>"+t.diagram2dCls.set2DdgmNote(),$("#"+t.pre+"dl_2ddgm_html").html(t.html2ddgm)),t.b2DShown=!0}showLoading(){let e=this.icn3d;e.icn3dui,$("#"+e.pre+"wait")&&$("#"+e.pre+"wait").show(),$("#"+e.pre+"canvas")&&$("#"+e.pre+"canvas").hide(),$("#"+e.pre+"cmdlog")&&$("#"+e.pre+"cmdlog").hide()}hideLoading(){let e=this.icn3d;e.icn3dui,$("#"+e.pre+"wait")&&$("#"+e.pre+"wait").hide(),$("#"+e.pre+"canvas")&&$("#"+e.pre+"canvas").show(),$("#"+e.pre+"cmdlog")&&$("#"+e.pre+"cmdlog").show()}setYourNote(e){let t=this.icn3d,i=t.icn3dui;t.yournote=e,$("#"+t.pre+"yournote").val(t.yournote),i.cfg.shownote&&(document.title=t.yournote)}transformToOpmOri(e){let t=this.icn3d;if(t.icn3dui,void 0!==t.rmsd_supr&&void 0!==t.rmsd_supr.rot){let i=t.rmsd_supr.rot,s=t.rmsd_supr.trans1,n=t.rmsd_supr.trans2;t.rmsd_supr.rmsd;let r=0;for(let e in t.atoms){let a=t.atoms[e];a.coord=t.surfaceCls.transformMemPro(a.coord,i,s,n);let o=a.coord.x*a.coord.x+a.coord.y*a.coord.y;Math.abs(a.coord.z)<=25&&o>r&&(r=o)}this.addMemAtoms(t.halfBilayerSize,e,Math.sqrt(r)),t.bStopRotate=!0,t.bOpm=!0,$("#"+t.pre+"togglememli").show(),$("#"+t.pre+"adjustmemli").show(),$("#"+t.pre+"selectplaneli").show()}else t.bOpm=!1}transformToOpmOriForAlign(e,t,i){let s=this.icn3d,n=s.icn3dui;if(void 0!==t){let r=s.loadPDBCls.getChainCalpha(s.chains,s.atoms,i,e),a=1==Object.keys(r.chainresiCalphaHash).length||1==Object.keys(t.chainresiCalphaHash).length,o=[],l=[];for(let e in r.chainresiCalphaHash)if(t.chainresiCalphaHash.hasOwnProperty(e)){let i=r.chainresiCalphaHash[e],s=t.chainresiCalphaHash[e];if((i.length==s.length||a)&&(o=o.concat(i),l=l.concat(s)),o.length>500)break}let d=o.length<l.length?o.length:l.length;if(d>=4)if(s.rmsd_supr=n.rmsdSuprCls.getRmsdSuprCls(o,l,d),void 0!==s.rmsd_supr.rot&&s.rmsd_supr.rmsd<1){let i=s.rmsd_supr.rot,r=s.rmsd_supr.trans1,a=s.rmsd_supr.trans2,o=s.rmsd_supr.rmsd;n.htmlCls.clickMenuCls.setLogCmd("RMSD of alignment to OPM: "+o.toPrecision(4),!1);let l=0;for(let e in s.atoms){let t=s.atoms[e];t.coord=s.surfaceCls.transformMemPro(t.coord,i,r,a);let n=t.coord.x*t.coord.x+t.coord.y*t.coord.y;Math.abs(t.coord.z)<=25&&n>l&&(l=n)}s.center=t.center,s.oriCenter=s.center.clone(),this.addMemAtoms(s.halfBilayerSize,e,Math.sqrt(l)),s.bStopRotate=!0,s.bOpm=!0,$("#"+s.pre+"togglememli").show(),$("#"+s.pre+"adjustmemli").show(),$("#"+s.pre+"selectplaneli").show()}else s.bOpm=!1;else s.bOpm=!1}}addOneDumAtom(e,t,i,s,n,r){let a=this.icn3d,o=a.icn3dui,l={het:!0,serial:++r,name:t,alt:void 0,resn:"DUM",structure:e,chain:"MEM",resi:1,coord:new mt(i,s,n),b:void 0,elem:t,bonds:[],ss:"",ssbegin:!1,ssend:!1,color:o.parasCls.atomColors[t]};return a.atoms[r]=l,a.chains[e+"_MEM"][r]=1,a.residues[e+"_MEM_1"][r]=1,a.chemicals[r]=1,a.dAtoms[r]=1,a.hAtoms[r]=1,r}addMemAtoms(e,t,i){let s=this.icn3d;if(s.icn3dui,!t)return;t=t?t.toUpperCase():s.defaultPdbId,s.structures[t].push(t+"_MEM"),s.chains[t+"_MEM"]={},s.residues[t+"_MEM_1"]={},s.chainsSeq[t+"_MEM"]=[{name:"DUM",resi:1}];let n=Object.keys(s.atoms).length;for(let e=0;e<1e3;++e)if(!s.atoms.hasOwnProperty(n+e)){n=n+e-1;break}for(let s=0;s<81;++s)for(let r=0;r<81;++r){let a=2*s-80,o=2*r-80;if(Math.sqrt(a*a+o*o)<i){let i=-e-.4;n=this.addOneDumAtom(t,"N",a,o,i,n),i=e+.4,n=this.addOneDumAtom(t,"O",a,o,i,n)}}}setMaxD(){let e=this.icn3d;e.icn3dui;let t=new mt(9999,9999,9999),i=new mt(-9999,-9999,-9999),s=new mt,n=0;for(let r in e.atoms){let a=e.atoms[r],o=a.coord;s.add(o),t.min(o),i.max(o),++n,a.het&&(0==a.bonds.length?e.ions[a.serial]=1:e.chemicals[a.serial]=1)}e.pmin=t,e.pmax=i,e.cnt=n,e.center=this.getGeoCenter(e.pmin,e.pmax),e.maxD=this.getStructureSize(e.atoms,e.pmin,e.pmax,e.center),e.maxD<5&&(e.maxD=5),e.oriMaxD=e.maxD,e.oriCenter=e.center.clone()}async renderStructure(){let e=this.icn3d,t=e.icn3dui;if(e.bInitial){if(e.bOpm&&(void 0!==t.cfg.align||void 0!==t.cfg.chainalign)){let i=e.selectedPdbid+"_MEM_1";for(let s in e.residues[i]){let i=e.atoms[s];i.style="stick",i.color=t.parasCls.atomColors[i.name],e.atomPrevColors[s]=i.color,e.dAtoms[s]=1}}if(void 0!==t.cfg.command&&""!==t.cfg.command?(e.bRender=!1,e.drawCls.draw()):(e.selectionCls.oneStructurePerWindow(),e.drawCls.draw()),e.bOpm){let t=new mt(1,0,0),i=-.5*Math.PI;e.transformCls.setRotation(t,i)}$("#"+e.pre+"alternate").show()}else e.selectionCls.saveSelectionIfSelected(),e.drawCls.draw();e.bInitial&&t.cfg.showsets&&e.definedSetsCls.showSets(),!e.bCommandLoad&&e.bInitial&&void 0!==t.cfg.command&&""!==t.cfg.command&&this.processCommand(),Object.keys(e.structures).length>=2?$("#"+e.pre+"mn2_alternateWrap").show():$("#"+e.pre+"mn2_alternateWrap").hide(),setTimeout((async function(){if(e.bInitial){if(void 0!==t.cfg.align||void 0!==t.cfg.chainalign){let i=e.pre+"selection";if($("#"+i).show(),$("#"+i+"_expand").hide(),$("#"+i+"_shrink").show(),void 0!==t.cfg.align&&2!=t.cfg.atype){let i=!1,s=t.htmlCls.alignSeqCls.getAlignSequencesAnnotations(Object.keys(e.alnChains),void 0,void 0,i);$("#"+e.pre+"dl_sequence2").html(s.sequencesHtml),$("#"+e.pre+"dl_sequence2").width(t.htmlCls.RESIDUE_WIDTH*s.maxSeqCnt+200)}}if(t.cfg.showanno){let i="view annotations";t.htmlCls.clickMenuCls.setLogCmd(i,!0),await e.showAnnoCls.showAnnotations()}(t.cfg.closepopup||t.cfg.imageonly)&&e.resizeCanvasCls.closeDialogs(),t.cfg.showlogo||$("#ncbi_logo").hide()}else e.hlUpdateCls.updateHlAll();$("#"+e.pre+"atomsCustom").length>0&&$("#"+e.pre+"atomsCustom")[0].blur(),e.bInitial=!1,t.cfg.imageonly&&e.saveFileCls.saveFile(void 0,"png",void 0,!0)}),0)}processCommand(){let e=this.icn3d,t=e.icn3dui;if(1==Object.keys(e.structures).length){let i=Object.keys(e.structures)[0];t.cfg.command=t.cfg.command.replace(new RegExp("!","g"),i+"_")}}getMassCenter(e,t){return this.icn3d.icn3dui,e.multiplyScalar(1/t)}getGeoCenter(e,t){return this.icn3d.icn3dui,e.clone().add(t).multiplyScalar(.5)}getStructureSize(e,t,i,s){let n=this.icn3d;n.icn3dui;let r=0;for(let a in e){let e=n.atoms[a].coord;if(Math.round(t.x)==Math.round(e.x)||Math.round(t.y)==Math.round(e.y)||Math.round(t.z)==Math.round(e.z)||Math.round(i.x)==Math.round(e.x)||Math.round(i.y)==Math.round(e.y)||Math.round(i.z)==Math.round(e.z)){let t=2*e.distanceTo(s);t>r&&(r=t)}}return r}async checkMemProteinAndRotate(){let e=this.icn3d,t=e.icn3dui;if(!e.bCheckMemProtein){e.bCheckMemProtein=!0;let i=t.cfg.afid?t.cfg.afid:t.cfg.mmdbafid;if(await e.ParserUtilsCls.checkMemProtein(i),t.cfg.url&&-1!=t.cfg.url.indexOf("membranome")){let t=new mt(1,0,0),i=-.5*Math.PI;e.transformCls.setRotation(t,i)}}}async checkMemProtein(e){let t=this.icn3d,i=t.icn3dui;try{let s=i.htmlCls.baseUrl+"vastdyn/vastdyn.cgi?afid2mem="+e,n=await i.getAjaxPromise(s,"jsonp");if(n&&n.pdbid){let e='This is a single-spanning (bitopic) transmembrane protein according to the Membranome database. Do you want to align the protein with the model from Membranome? If you click "OK", you can press the letter "a" to alternate the structures.';if(i.bNode)return;if("off"==i.cfg.afmem);else if("on"==i.cfg.afmem||confirm(e))try{let e="https://storage.googleapis.com/membranome-assets/pdb_files/proteins/"+n.pdbid+".pdb",s=await i.getAjaxPromise(e,"text");t.bAfMem=!0,i.bNode||$("#"+i.pre+"togglememli").show();let r=n.pdbid.substr(0,n.pdbid.indexOf("_")),a=!0,o=!0;await t.pdbParserCls.loadPdbData(s,r,a,o),o&&(t.bSetChainsAdvancedMenu&&t.definedSetsCls.showSets(),t.bAnnoShown&&(await t.showAnnoCls.showAnnotations(),t.annotationCls.resetAnnoTabAll()));let l=n.segment.replace(/ /gi,"").split("(")[0];t.afmem_start_end=l.split("-"),t.hAtoms={},t.dAtoms={};for(let e in t.atoms)t.atoms[e].structure!=r&&(t.hAtoms[e]=1),t.dAtoms[e]=1;for(let e=parseInt(t.afmem_start_end[0]);e<=parseInt(t.afmem_start_end[1]);++e)t.hAtoms=i.hashUtilsCls.unionHash(t.hAtoms,t.residues[r+"_A_"+e]);await t.realignParserCls.realignOnSeqAlign(r)}catch(e){return void console.log("Error in retrieving matched PDB from Membranome...")}}}catch(e){return void console.log("Error in finding matched PDB in Membranome...")}}getResi(e,t){let i=this.icn3d;i.icn3dui;let s=i.ncbi2resid[e+"_"+(t+1).toString()];return s?s.substr(s.lastIndexOf("_")+1):""}getResiNCBI(e,t){let i=this.icn3d;i.icn3dui;let s=i.resid2ncbi[e+"_"+t];return s?parseInt(s.substr(s.lastIndexOf("_")+1)):0}}class jh{constructor(e){this.icn3d=e}loadAtomDataIn(e,t,i,s,n,r,a,o,l){let d=this.icn3d,c=d.icn3dui;d.pmin=new mt(9999,9999,9999),d.pmax=new mt(-9999,-9999,-9999),d.psum=new mt;let h=e.atoms,p=d.atoms?Object.keys(d.atoms).length:0,u={},m={};d.pmid=e.pubmedId,void 0===d.chainid2title&&(d.chainid2title={}),void 0===d.chainid2sid&&(d.chainid2sid={});let f={},g={};if("align"===i){d.pmid="",d.molTitle="",c.cfg.inpara&&-1!==c.cfg.inpara.indexOf("atype=1")?d.molTitle="Invariant Core Structure Alignment (VAST) of ":c.cfg.inpara&&-1!==c.cfg.inpara.indexOf("atype=2")?d.molTitle="Structure Alignment (TM-align) of ":d.molTitle="Structure Alignment (VAST) of ";let t=!1;for(let i=0,s=e.alignedStructures[0].length;i<s;++i){let s=e.alignedStructures[0][i];1===i&&(d.secondId=s.pdbId);let n=s.pdbId,r=s.mmdbId;for(let e=s.serialInterval[0],t=s.serialInterval[1];e<=t;++e)u[e]=n.toString(),m[r]=n;for(let e=0,t=s.molecules.length;e<t;++e){let t=s.molecules[e].chain;t=t.replace(/_/g,"");let i=s.molecules[e].kind,r=s.molecules[e].name,a=s.molecules[e].sid,o=n+"_"+t;f[o]=i,d.chainid2title[o]=r,void 0!==a&&(d.chainid2sid[o]=a)}d.molTitle+='<a href="'+c.htmlCls.baseUrl+"mmdb/mmdbsrv.cgi?uid="+s.pdbId.toUpperCase()+'" target="_blank">'+s.pdbId.toUpperCase()+"</a>",void 0!==s.descr&&(d.pmid+=s.descr.pubmedid),0===i&&(d.molTitle+=" and ",void 0!==s.descr&&(d.pmid+="_")),t=!0}d.molTitle+=" from VAST+",t||(d.molTitle="")}else if(void 0!==e.descr&&(d.molTitle=e.descr.name),"mmdbid"===i){let i=isNaN(t)?t:e.pdbId,s={};void 0===d.alignmolid2color&&(d.alignmolid2color=[]);let n=1;for(let t in e.moleculeInfor){if(0===Object.keys(e.moleculeInfor[t]).length)continue;let r=e.moleculeInfor[t].chain.trim();r=r.replace(/_/g,"");let a=i+"_"+r;s.hasOwnProperty(r)?(++s[r],a+=s[r]):s[r]=1,void 0!==d.mmdbid_q&&(d.mmdbid_q,d.mmdbid_t);let o=e.moleculeInfor[t].kind,l=e.moleculeInfor[t].color,c=e.moleculeInfor[t].sid;if(f[a]=o,g[a]=l,"protein"==o&&(d.organism=e.moleculeInfor[t].taxonomyName.toLowerCase()),void 0!==c&&(d.chainid2sid[a]=c),void 0===d.pdbid_chain2title&&(d.pdbid_chain2title={}),d.pdbid_chain2title[a]=e.moleculeInfor[t].name,r==a.substr(a.lastIndexOf("_"))){let e={};e[t]=n.toString(),d.alignmolid2color.push(e)}++n}}"mmdbid"===i&&(d.molTitleHash||(d.molTitleHash={}),d.molTitleHash[t]=d.molTitle);let b,C,v,_,y,S={},w="",x="",A="",M="",T="",E="",R=0,k=0,O="",I=!0,P=!1,D="",L=c.utilsCls.isCalphaPhosOnly(h),F=0,N={};for(let e in h){++p,S[e]=p;let s,n=h[e];n.serial=p,"mmdbid"===i||"mmcifid"===i?s=t:"align"===i&&(s=u[p]);let r=!1;if(void 0!==n.chain||"mmdbid"!==i&&"align"!==i)n.chain=""===n.chain?"Misc":n.chain;else if("mmdbid"===i)if(b=n.ids.m,void 0!==d.molid2chain[b]){let e=d.molid2chain[b].indexOf("_");n.chain=d.molid2chain[b].substr(e+1)}else{let e="Misc";("protein"===f[T]&&"nucleotide"===f[T]&&n.resi!=k||"protein"!==f[T]&&"nucleotide"!==f[T]&&(n.resn.substr(0,3)!=O.substr(0,3)||n.resi!=k||"solvent"===f[T]||"HOH"===n.resn))&&++F,n.resi_ori=n.resi,n.resi=F,r=!0,n.chain=e}else if("align"===i)if(b=n.ids.m,void 0!==d.pdbid_molid2chain[s+"_"+b])n.chain=d.pdbid_molid2chain[s+"_"+b];else{let e="Misc";("protein"===f[T]&&"nucleotide"===f[T]&&n.resi!=k||"protein"!==f[T]&&"nucleotide"!==f[T]&&(n.resn.substr(0,3)!=O.substr(0,3)||n.resi!=k||"solvent"===f[T]||"HOH"===n.resn))&&(++F,n.resi_ori=n.resi,n.resi=F,r=!0),n.chain=e}if(n.chain=n.chain.trim(),n.chain=n.chain.replace(/_/g,""),"mmdbid"!==i&&"align"!==i||(n.structure=s,"mmdbid"===i&&void 0!==d.mmdbid_q&&(d.mmdbid_q,d.mmdbid_t)),M=n.structure,T=M+"_"+n.chain,"mmdbid"===i||"align"===i){r||(n.resi_ori=n.resi,d.bUsePdbNum?n.resi=n.resi_ori:n.resi=n.ids.r);let e=n.resn.indexOf(" ");-1!==e&&0!=e&&(n.resn=n.resn.substr(0,e))}T!==x&&(R=0),n.resi!==R&&(T!==x?(v=void 0,y=void 0):(v=C,y=_)),n.coord="mmdbid"===i?new mt(n.coord[0],n.coord[1],n.coord[2]):new mt(n.coord.x,n.coord.y,n.coord.z);let a=c.utilsCls.residueName2Abbr(n.resn.substr(0,3));"mmdbid"!==i&&"align"!==i||!d.bFullUi||(void 0===d.mmdbMolidResid2mmdbChainResi&&(d.mmdbMolidResid2mmdbChainResi={}),d.mmdbMolidResid2mmdbChainResi[s+"_"+n.ids.m+"_"+n.ids.r]=s+"_"+n.chain+"_"+n.resi),d.pmin.min(n.coord),d.pmax.max(n.coord),d.psum.add(n.coord);let o="protein"===f[T],l="nucleotide"===f[T],m="solvent"===f[T],U="ligand"===f[T]||void 0!==f[T]&&-1!==f[T].indexOf("other")||void 0===f[T];if("Misc"!==n.chain&&"other"!==f[T]||"protein"===N[T]||"nucleotide"===N[T]||("CA"===n.name&&"C"===n.elem?N[T]="protein":"P"===n.name&&"P"===n.elem?N[T]="nucleotide":N[T]="chemical"),o||l?(o?(d.proteins[p]=1,"CA"===n.name&&(d.calphas[p]=1),"N"!==n.name&&"H"!==n.name&&"CA"!==n.name&&"HA"!==n.name&&"C"!==n.name&&"O"!==n.name&&(d.sidec[p]=1)):l&&(d.nucleotides[p]=1,("O3'"==n.name||"O3*"==n.name||L&&"P"==n.name)&&(d.nucleotidesO3[p]=1),-1===c.parasCls.nuclMainArray.indexOf(n.name)&&(d.ntbase[p]=1)),n.het=!1):m?(d.water[p]=1,n.het=!0):U&&("HOH"===n.resn||"O"===n.resn?d.water[p]=1:n.elem===n.resn?d.ions[p]=1:d.chemicals[p]=1,n.het=!0),"mmdbid"===i?n.het?n.color=c.parasCls.atomColors[n.elem]||c.parasCls.defaultAtomColor:n.color=void 0!==g[T]?c.parasCls.thr(g[T]):c.parasCls.chargeColors[n.resn]:void 0!==n.color&&(n.color=c.parasCls.thr(n.color))," "!==n.resn.charAt(0)&&" "===n.resn.charAt(1)&&(n.resn=n.resn.charAt(0)),n.het||"C"!==n.name||(C=p),n.het||"O"!==n.name||(_=p),!n.het&&"N"===n.name&&void 0!==v&&void 0!==y){let e=d.atoms[v].coord.distanceTo(d.atoms[y].coord),t=n.coord.x+(d.atoms[v].coord.x-d.atoms[y].coord.x)/e,i=n.coord.y+(d.atoms[v].coord.y-d.atoms[y].coord.y)/e,s=n.coord.z+(d.atoms[v].coord.z-d.atoms[y].coord.z)/e;n.hcoord=new mt(t,i,s)}"HOH"==n.resn&&(d.water[p]=1),d.atoms[p]=n,d.dAtoms[p]=1,d.hAtoms[p]=1;let H=n.structure+"_"+n.chain;void 0===d.chains[H]&&(d.chains[H]={}),d.chains[H][p]=1;let B=H+"_"+n.resi;void 0===d.residues[B]&&(d.residues[B]={}),d.residues[B][p]=1,E=T+"_"+n.resi,E!==A&&T!==x&&(I=!0,""!==w&&(void 0===d.structures[w]&&(d.structures[w]=[]),d.structures[w].push(x))),d.residueId2Name[B]=a;let z="-";if("helix"===n.ss?z="H":"sheet"===n.ss?z="E":n.het||l?z="o":(!n.het&&c.parasCls.residueColors.hasOwnProperty(n.resn.toUpperCase())||"coil"===n.ss)&&(z="c"),d.secondaries[n.structure+"_"+n.chain+"_"+n.resi]=z,(n.resi!=R||b!=D)&&d.bFullUi&&(void 0===d.chainsSeq[H]&&(d.chainsSeq[H]=[],I=!1),!isNaN(n.resi)&&null!==n.resi))if(I&&!P&&void 0!==d.chainsSeq[H][n.resi-1])d.chainsSeq[H][n.resi-1].name=a;else if(!I||!d.chainsSeq[H].hasOwnProperty(n.resi-1)){let e={};e.resi=n.resi,e.name=a,n.resi%10==0&&n.resi.toString(),d.chainsSeq[H].push(e),P=!0}R=n.resi,k=n.resi_ori,O=n.resn,w=M,x=T,A=E,D=b}for(let e in d.chemicals){let t=d.atoms[e];if("P"==t.elem&&t.bonds.length>=4)for(let e=t.bonds.length-1;e>=0;--e){"P"==d.atoms[t.bonds[e]].elem&&t.bonds.splice(e,1)}}for(let e in N)if(!(Object.keys(d.chains[e]).length<10)&&"chemical"!==N[e])for(let t in d.chains[e]){let i=d.atoms[t];delete d.chemicals[t],i.het=!1,"protein"===N[e]?(d.proteins[t]=1,"CA"===i.name&&(d.calphas[t]=1),"N"!==i.name&&"H"!==i.name&&"CA"!==i.name&&"HA"!==i.name&&"C"!==i.name&&"O"!==i.name&&(d.sidec[t]=1)):"nucleotide"===N[e]&&(d.nucleotides[t]=1,("O3'"==i.name||"O3*"==i.name||L&&"P"==i.name)&&(d.nucleotidesO3[t]=1),-1===c.parasCls.nuclMainArray.indexOf(i.name)&&(d.ntbase[t]=1))}if(void 0===d.structures[M]&&(d.structures[M]=[]),d.structures[M].push(T),d.bFullUi)if("mmdbid"===i||"mmcifid"===i)for(let s in e.sequences){let n=e.sequences[s],r=t+"_"+s;void 0!==d.mmdbid_q&&(d.mmdbid_q,d.mmdbid_t),d.ParserUtilsCls.getMissingResidues(n,i,r)}else if("align"===i)for(let e in d.chainid2seq){let t=d.chainid2seq[e];d.ParserUtilsCls.getMissingResidues(t,i,e)}if(d.loadPDBCls.setResidMapping(),"mmcifid"!==i)for(let e in h){let t=S[e],i=void 0===d.atoms[t].bonds?0:d.atoms[t].bonds.length;for(let e=0;e<i;++e)d.atoms[t].bonds[e]=S[d.atoms[t].bonds[e]]}if(e.atoms={},d.cnt=p,(d.cnt>d.maxatomcnt||void 0!==d.biomtMatrices&&d.biomtMatrices.length*d.cnt>10*d.maxatomcnt)&&(d.opts.proteins="c alpha trace",d.opts.nucleotides="o3 trace"),d.center=d.ParserUtilsCls.getGeoCenter(d.pmin,d.pmax),d.maxD=d.ParserUtilsCls.getStructureSize(d.atoms,d.pmin,d.pmax,d.center),d.maxD<5&&(d.maxD=5),d.oriMaxD=d.maxD,("align"===i||o)&&(d.ssbondpnts={},d.loadPDBCls.setSsbond()),"mmdbid"===i&&1==Object.keys(d.structures).length){let t=e.disulfides;if(void 0!==t)for(let e=0,i=t.length;e<i;++e){let i=t[e][0].ca,s=t[e][1].ca,n=d.atoms[i],r=d.atoms[s],a=n.chain,o=r.chain,l=n.structure+"_"+a+"_"+n.resi,c=r.structure+"_"+o+"_"+r.resi;void 0===d.ssbondpnts[n.structure]&&(d.ssbondpnts[n.structure]=[]),d.ssbondpnts[n.structure].push(l),d.ssbondpnts[n.structure].push(c)}}else if("mmcifid"===i&&1==Object.keys(d.structures).length){let i=e.disulfides;if(void 0!==i){void 0===d.ssbondpnts[t]&&(d.ssbondpnts[t]=[]);for(let e=0,s=i.length;e<s;++e){let s=i[e][0],n=i[e][1];d.ssbondpnts[t].push(s),d.ssbondpnts[t].push(n)}let e=Object.keys(d.structures);for(let i=0,s=e.length;i<s;++i){let s=e[i];if(s!=t){void 0===d.ssbondpnts[s]&&(d.ssbondpnts[s]=[]);for(let e=0,i=d.ssbondpnts[t].length;e<i;++e){let i=d.ssbondpnts[t][e],n=i.indexOf("_"),r=s+i.substr(n);d.ssbondpnts[s].push(r)}}}}}("mmcifid"===i||"mmdbid"===i&&void 0===n)&&d.ParserUtilsCls.transformToOpmOri(t);let U={};if("align"===i&&void 0!==s&&d.bFullUi)d.setSeqAlignCls.setSeqAlign(s,e.alignedStructures);else if("mmdbid"!==i||"query"!==n||!d.bFullUi||void 0===d.q_rotation||c.cfg.resnum||c.cfg.resdef||l)U=d.hAtoms;else if(a){d.setSeqAlignCls.setSeqAlignChain(r,a);let e=!1,t=c.htmlCls.alignSeqCls.getAlignSequencesAnnotations(Object.keys(d.alnChains),void 0,void 0,!1,void 0,e),i=$("#"+d.pre+"dl_sequence2").html();U=d.hAtoms,$("#"+d.pre+"dl_sequence2").html(i+t.sequencesHtml),$("#"+d.pre+"dl_sequence2").width(c.htmlCls.RESIDUE_WIDTH*t.maxSeqCnt+200)}else U=d.hAtoms;if(!c.cfg.mmdbafid&&"mmdbid"===i&&("target"===n||"query"===n)&&void 0===d.q_rotation){if("target"===n||"query"===n)for(let e in h){let t=h[e];t.coord.x-=d.center.x,t.coord.y-=d.center.y,t.coord.z-=d.center.z}"target"===n?(d.oriMaxD=d.maxD,d.center1=d.center):"query"===n&&(d.oriMaxD<d.maxD&&(d.oriMaxD=d.maxD),d.center2=d.center,d.center=new mt(0,0,0))}return d.oriCenter=d.center.clone(),d.saveFileCls.showTitle(),e={},U}}class Gh{constructor(e){this.icn3d=e}setSeqAlign(e,t){let i,s,n=this.icn3d,r=n.icn3dui,a=t[0][0].pdbId,o=t[0][1].pdbId;n.conservedName1=a+"_cons",n.nonConservedName1=a+"_ncons",n.notAlignedName1=a+"_nalign",n.conservedName2=o+"_cons",n.nonConservedName2=o+"_ncons",n.notAlignedName2=o+"_nalign",n.consHash1={},n.nconsHash1={},n.nalignHash1={},n.consHash2={},n.nconsHash2={},n.nalignHash2={};for(let t=0,l=e.length;t<l;++t){let l=e[t][0],d=l.moleculeId,c=n.pdbid_molid2chain[a+"_"+d];i=a+"_"+c;let h={},p=l.sequence.length,u=-1,m=!1;for(let e=0,t=l.sequence.length;e<t;++e){let t=n.bUsePdbNum?n.ParserUtilsCls.getResi(i,l.sequence[e][0]-1):l.sequence[e][0],s="~"===l.sequence[e][2]?"-":l.sequence[e][2];s=" "===s||""===s?"X":s;let r=l.sequence[e][3]?1:0;1==r&&(e<p&&!m&&(p=e,m=!0),e>u&&(u=e)),h[e]={resi:t,resn:s,aligned:r}}l=e[t][1];let f=l.moleculeId,g=n.pdbid_molid2chain[o+"_"+f];s=o+"_"+g,void 0===n.alnChainsAnTtl[i]&&(n.alnChainsAnTtl[i]=[]),void 0===n.alnChainsAnTtl[i][0]&&(n.alnChainsAnTtl[i][0]=[]),void 0===n.alnChainsAnTtl[i][1]&&(n.alnChainsAnTtl[i][1]=[]),void 0===n.alnChainsAnTtl[i][2]&&(n.alnChainsAnTtl[i][2]=[]),void 0===n.alnChainsAnTtl[i][3]&&(n.alnChainsAnTtl[i][3]=[]),void 0===n.alnChainsAnTtl[i][4]&&(n.alnChainsAnTtl[i][4]=[]),void 0===n.alnChainsAnTtl[i][5]&&(n.alnChainsAnTtl[i][5]=[]),void 0===n.alnChainsAnTtl[i][6]&&(n.alnChainsAnTtl[i][6]=[]),n.alnChainsAnTtl[i][0].push(s),n.alnChainsAnTtl[i][1].push(i),n.alnChainsAnTtl[i][2].push(""),n.alnChainsAnTtl[i][3].push(""),n.alnChainsAnTtl[i][4].push(s),n.alnChainsAnTtl[i][5].push(i),n.alnChainsAnTtl[i][6].push("");let b=1;n.chainsMapping[i]||(n.chainsMapping[i]={}),n.chainsMapping[s]||(n.chainsMapping[s]={});for(let e=p;e<=u;++e){let t,d,u,m=n.bUsePdbNum?n.ParserUtilsCls.getResi(s,l.sequence[e][0]-1):l.sequence[e][0],f="~"===l.sequence[e][2]?"-":l.sequence[e][2],C=l.sequence[e][3]?1:0,v=h[e].aligned+C;2===v?(h[e].resn===f?(t="#FF0000",u="icn3d-cons",n.consHash1[i+"_"+h[e].resi]=1,n.consHash2[s+"_"+m]=1):(t="#0000FF",u="icn3d-ncons",n.nconsHash1[i+"_"+h[e].resi]=1,n.nconsHash2[s+"_"+m]=1),n.chainsMapping[i][i+"_"+h[e].resi]=h[e].resn+h[e].resi,n.chainsMapping[s][s+"_"+m]=h[e].resn+h[e].resi,d="#"+n.showAnnoCls.getColorhexFromBlosum62(h[e].resn,f)):(t=r.htmlCls.GREY8,u="icn3d-nalign",n.nalignHash1[i+"_"+h[e].resi]=1,n.nalignHash2[s+"_"+m]=1),void 0===n.alnChainsSeq[i]&&(n.alnChainsSeq[i]=[]);let _={};_.mmdbid=a,_.chain=c,_.resi=h[e].resi,_.resn=""===_.resi||"icn3d-nalign"===u?h[e].resn.toLowerCase():h[e].resn,_.aligned=v,_.color=""===_.resi?r.htmlCls.GREYC:t,_.color2=""===_.resi?r.htmlCls.GREYC:d,_.class=u,n.alnChainsSeq[i].push(_),""!==h[e].resi&&(void 0===n.alnChains[i]&&(n.alnChains[i]={}),$.extend(n.alnChains[i],n.residues[i+"_"+h[e].resi])),void 0===n.alnChainsSeq[s]&&(n.alnChainsSeq[s]=[]),_={},_.mmdbid=o,_.chain=g,_.resi=m,_.resn=""===_.resi||"icn3d-nalign"===u?f.toLowerCase():f,_.aligned=v,_.color=""===_.resi?r.htmlCls.GREYC:t,_.color2=""===_.resi?r.htmlCls.GREYC:d,_.class=u,n.alnChainsSeq[s].push(_),""!==_.resi&&(void 0===n.alnChains[s]&&(n.alnChains[s]={}),$.extend(n.alnChains[s],n.residues[s+"_"+m])),void 0===n.alnChainsAnno[i]&&(n.alnChainsAnno[i]=[]),void 0===n.alnChainsAnno[i][0]&&(n.alnChainsAnno[i][0]=[]),void 0===n.alnChainsAnno[i][1]&&(n.alnChainsAnno[i][1]=[]),void 0===n.alnChainsAnno[i][2]&&(n.alnChainsAnno[i][2]=[]),void 0===n.alnChainsAnno[i][3]&&(n.alnChainsAnno[i][3]=[]),e===p&&(void 0===n.alnChainsAnno[i][4]&&(n.alnChainsAnno[i][4]=[]),void 0===n.alnChainsAnno[i][5]&&(n.alnChainsAnno[i][5]=[]),void 0===n.alnChainsAnno[i][6]&&(n.alnChainsAnno[i][6]=[]),n.alnChainsAnno[i][4].push(n.pdbid_chain2title[s]),n.alnChainsAnno[i][5].push(n.pdbid_chain2title[i]),n.alnChainsAnno[i][6].push(""));let y=i+"_"+h[e].resi,S=s+"_"+m,w=n.secondaries[y],x=n.secondaries[S];x?n.alnChainsAnno[i][0].push(x):n.alnChainsAnno[i][0].push("-"),w?n.alnChainsAnno[i][1].push(w):n.alnChainsAnno[i][1].push("-");let A=".";b%5==0&&(A="*"),b%10==0&&(A="|"),n.alnChainsAnno[i][2].push(A);let M="";b%10==0&&(M=b.toString()),n.alnChainsAnno[i][3].push(M),++b}this.setMsaFormat([i,s])}e={}}getPosFromResi(e,t){let i=this.icn3d;i.icn3dui;let s,n=i.resid2ncbi[e+"_"+t];if(n){s=n.substr(n.lastIndexOf("_")+1)-1}return s}getResnFromResi(e,t){let i=this.icn3d;i.icn3dui;let s=e+"_"+t,n=i.residueId2Name[s];return n||(n="?"),n}getResiAferAlign(e,t,i){let s,n=this.icn3d,r=n.icn3dui;return t&&"tmalign"==r.cfg.aligntool?s=i:(i>n.chainsSeq[e].length-1&&(console.log("Error: the position "+i+" exceeds the max index "+(n.chainsSeq[e].length-1)),i=n.chainsSeq[e].length-1),s=n.chainsSeq[e][i].resi),s}setSeqAlignChain(e,t,i){let s,n,r,a,o,l,d,c,h,p,u,m=this.icn3d,f=m.icn3dui,g={},b=!!i;if(b){if(o=i[1],l=i[0],t=i[2],d=o.indexOf("_"),c=l.indexOf("_"),s=o.substr(0,d).toUpperCase(),n=l.substr(0,c).toUpperCase(),r=o.substr(d+1),a=l.substr(d+1),s==n&&r==a){let e=m.chainsSeq[n+"_"+a].length;m.qt_start_end[t]={q_start:1,q_end:e,t_start:1,t_end:e}}}else{let d=i[0].indexOf("_"),c=e.indexOf("_");if(s=m.mmdbid_t,n=e.substr(0,c).toUpperCase(),r=i[0].substr(d+1),a=e.substr(c+1),s==n&&r==a){let e=m.chainsSeq[m.mmdbid_q+"_"+m.chain_q].length;m.qt_start_end[t]={q_start:1,q_end:e,t_start:1,t_end:e}}o=s+"_"+r,l=n+"_"+a,void 0!==n&&m.mmdbid_t}m.conservedName1=o+"_cons",m.nonConservedName1=o+"_ncons",m.notAlignedName1=o+"_nalign",m.conservedName2=l+"_cons",m.nonConservedName2=l+"_ncons",m.notAlignedName2=l+"_nalign",m.consHash1={},m.nconsHash1={},m.nalignHash1={},m.consHash2={},m.nconsHash2={},m.nalignHash2={},m.alnChains={},m.alnChainsSeq[o]=[],m.alnChains[o]={},m.alnChainsSeq[l]=[],m.alnChains[l]={},m.alnChainsAnno[o]=[],m.alnChainsAnTtl[o]=[],void 0===m.alnChainsAnTtl[o]&&(m.alnChainsAnTtl[o]=[]);for(let e=0;e<7;++e)void 0===m.alnChainsAnTtl[o][e]&&(m.alnChainsAnTtl[o][e]=[]);m.alnChainsAnTtl[o][0].push(l),m.alnChainsAnTtl[o][1].push(o),m.alnChainsAnTtl[o][2].push(""),m.alnChainsAnTtl[o][3].push(""),m.alnChainsAnTtl[o][4].push(l),m.alnChainsAnTtl[o][5].push(o),m.alnChainsAnTtl[o][6].push("");let C=0,v=0;if(void 0===m.qt_start_end[t])return;let _=1;m.chainsMapping[o]||(m.chainsMapping[o]={}),m.chainsMapping[l]||(m.chainsMapping[l]={});for(let e=0,i=m.qt_start_end[t].length;e<i;++e)b&&"tmalign"==f.cfg.aligntool?(parseInt(m.qt_start_end[t][e].t_start),parseInt(m.qt_start_end[t][e].q_start),parseInt(m.qt_start_end[t][e].t_end),parseInt(m.qt_start_end[t][e].q_end)):(parseInt(m.qt_start_end[t][e].t_start-1),parseInt(m.qt_start_end[t][e].q_start-1),parseInt(m.qt_start_end[t][e].t_end-1),parseInt(m.qt_start_end[t][e].q_end-1));for(let e=0,i=m.qt_start_end[t].length;e<i;++e){let i,s,n,r;if(b&&"tmalign"==f.cfg.aligntool?(i=parseInt(m.qt_start_end[t][e].t_start),s=parseInt(m.qt_start_end[t][e].q_start),n=parseInt(m.qt_start_end[t][e].t_end),r=parseInt(m.qt_start_end[t][e].q_end)):(i=parseInt(m.qt_start_end[t][e].t_start-1),s=parseInt(m.qt_start_end[t][e].q_start-1),n=parseInt(m.qt_start_end[t][e].t_end-1),r=parseInt(m.qt_start_end[t][e].q_end-1)),e>0){let e=_;for(let t=C+1,s=i;t<s;++t){let i=this.getResiAferAlign(o,b,t),s=this.getResnFromResi(o,i).toLowerCase();"?"!=s&&(h=f.htmlCls.GREY8,u="icn3d-nalign",m.nalignHash1[o+"_"+i]=1,this.setSeqPerResi(o,o,l,i,s,!1,h,void 0,u,!0,!1,e),++e)}let t=_;for(let e=v+1,i=s;e<i;++e){let i=this.getResiAferAlign(l,b,e),s=this.getResnFromResi(l,i).toLowerCase();"?"!=s&&(h=f.htmlCls.GREY8,u="icn3d-nalign",m.nalignHash2[l+"_"+i]=1,this.setSeqPerResi(l,o,l,i,s,!1,h,void 0,u,!1,!1,t),++t)}if(e<t){_=t;for(let i=0;i<t-e;++i){let t="",s="-";h=f.htmlCls.GREY8,u="icn3d-nalign",this.setSeqPerResi(o,o,l,t,s,!1,h,void 0,u,!0,!1,e+i)}}else{_=e;for(let i=0;i<e-t;++i){let e="",s="-";h=f.htmlCls.GREY8,u="icn3d-nalign",this.setSeqPerResi(l,o,l,e,s,!1,h,void 0,u,!1,!1,t+i)}}}for(let r=0;r<=n-i;++r){let n,a,d,c;if(b&&"tmalign"==f.cfg.aligntool){if(n=m.qt_start_end[t][e].t_start,a=m.qt_start_end[t][e].q_start,d=this.getResnFromResi(o,n).toUpperCase(),c=this.getResnFromResi(l,a).toUpperCase(),"?"==d||"?"==c)continue}else n=this.getResiAferAlign(o,b,r+i),a=this.getResiAferAlign(l,b,r+s),d=this.getResnFromResi(o,n).toUpperCase(),c=this.getResnFromResi(l,a).toUpperCase();d===c?(h="#FF0000",u="icn3d-cons",m.consHash1[o+"_"+n]=1,m.consHash2[l+"_"+a]=1):(h="#0000FF",u="icn3d-ncons",m.nconsHash1[o+"_"+n]=1,m.nconsHash2[l+"_"+a]=1),g=f.hashUtilsCls.unionHash(g,m.residues[o+"_"+n]),g=f.hashUtilsCls.unionHash(g,m.residues[l+"_"+a]),m.chainsMapping[o][o+"_"+n]=d+n,m.chainsMapping[l][l+"_"+a]=d+n,p="#"+m.showAnnoCls.getColorhexFromBlosum62(d,c);let C=0===e&&0===r;this.setSeqPerResi(o,o,l,n,d,!0,h,p,u,!0,C,_),this.setSeqPerResi(l,o,l,a,c,!0,h,p,u,!1,C,_),++_}C=n,v=r}return this.setMsaFormat([o,l]),g}setSeqAlignChainForAll(e,t,i){let s=this.icn3d,n=s.icn3dui,r={},a=e[0];s.alnChainsAnno[a]=[],s.alnChainsAnTtl[a]=[];let o=e.length;void 0===s.alnChainsAnTtl[a]&&(s.alnChainsAnTtl[a]=[]);for(let e=0;e<3+2*o;++e)void 0===s.alnChainsAnTtl[a][e]&&(s.alnChainsAnTtl[a][e]=[]);for(let t=0;t<o;++t)s.alnChainsAnTtl[a][t].push(e[o-1-t]);s.alnChainsAnTtl[a][o].push(""),s.alnChainsAnTtl[a][o+1].push("");for(let t=o+2;t<2*o+2;++t)s.alnChainsAnTtl[a][t].push(e[2*o+1-t]);s.alnChainsAnTtl[a][2*o+2].push(""),s.alnChainsSeq[a]=[],s.alnChains={},s.alnChains[a]={};let l={},d=9999,c=-1,h=s.chainsSeq[a][0].resi-1;for(let t=1,i=e.length;t<i;++t){let i=t-1;if(e[t],s.qt_start_end[i])for(let t=0,r=s.qt_start_end[i].length;t<r;++t){let r,a;r=parseInt(s.qt_start_end[i][t].t_start)-1,a=parseInt(s.qt_start_end[i][t].t_end)-1;for(let t=r;t<=a;++t){let i,r,a;a="tmalign"==n.cfg.aligntool?t-h:t,i=s.ParserUtilsCls.getResi(e[0],a),r=e[0]+"_"+i,l[r]=1,t<d&&(d=t),t>c&&(c=t)}}}"tmalign"==n.cfg.aligntool&&(i=!0);let p=Object.keys(l);p.sort((function(e,t){return parseInt(e.split("_")[2])-parseInt(t.split("_")[2])}));let u=-999,m=0,f=0,g=[],b=0;for(let e=0,t=p.length;e<t;++e){let t=p[e],i=t.split("_")[2];if(0==e)m=i;else if(e>0&&s.resid2ncbi[i]!=s.resid2ncbi[u]+1&&s.resid2ncbi[i]!=s.resid2ncbi[u]){f=u;for(let e=0,t=g.length;e<t;++e)l[g[e]]={resiStart:m,resiEnd:f,prevResiEnd:b};g=[],m=i,b=f}g.push(t),u=i}f=u;for(let e=0,t=g.length;e<t;++e)l[g[e]]={resiStart:m,resiEnd:f,prevResiEnd:b};for(let t=0,i=e.length;t<i;++t){let i=e[t];s.alnChainsSeq[i]=[],s.alnChains[i]={},s.alnChainsAnno[i]=[]}for(let e=0,t=s.chainsSeq[a].length;e<t;++e){let t=s.chainsSeq[a][e].resi,i=a+"_"+t,o="tmalign"!=n.cfg.aligntool?e:e+h;if(o<d||o>c)continue;let p={},u=a.indexOf("_");p.mmdbid=a.substr(0,u),p.chain=a.substr(u+1),p.resi=t,p.resn=l[i]?s.chainsSeq[a][e].name.toUpperCase():s.chainsSeq[a][e].name.toLowerCase(),p.aligned=!!l[i],p.color=l[i]?"#FF0000":n.htmlCls.GREYC,p.color2=l[i]?"#FF0000":n.htmlCls.GREYC,p.class=l[i]?"icn3d-cons":"icn3d-nalign",s.alnChainsSeq[a].push(p),l[i]&&($.extend(s.alnChains[a],s.residues[a+"_"+p.resi]),r=n.hashUtilsCls.unionHash(r,s.residues[a+"_"+p.resi]))}let C=[0];for(let s=0,a=t.length;s<a;++s){let a=t[s].index;C.push(a);let o=this.mergeTwoSeqForAll(e,a,C,l,d,c,i);r=n.hashUtilsCls.unionHash(r,o)}this.setMsaFormat(e);for(let e=0;e<3+2*o;++e)void 0===s.alnChainsAnno[a][e]&&(s.alnChainsAnno[a][e]=[]);for(let t=0;t<o;++t){let i=e[t];for(let e=0,n=s.alnChainsSeq[i].length;e<n;++e){if("-"==s.alnChainsSeq[i][e].resn)s.alnChainsAnno[a][o-1-t].push("-");else{let n=i+"_"+s.alnChainsSeq[i][e].resi,r=s.secondaries[n];void 0!==r?s.alnChainsAnno[a][o-1-t].push(r):s.alnChainsAnno[a][o-1-t].push("-")}}}for(let e=0,t=s.alnChainsSeq[a].length;e<t;++e){let t=".";e%5==0&&(t="*"),e%10==0&&(t="|"),s.alnChainsAnno[a][o].push(t);let i="";e%10==0&&(i=e.toString()),s.alnChainsAnno[a][o+1].push(i)}for(let t=o+2;t<2*o+2;++t){let i=s.pdbid_chain2title&&s.pdbid_chain2title.hasOwnProperty(e[2*o+1-t])?s.pdbid_chain2title[e[2*o+1-t]]:"";s.alnChainsAnno[a][t].push(i)}return s.alnChainsAnno[a][2*o+2].push(""),r}getResObject(e,t,i,s,n,r){let a=this.icn3d,o=a.icn3dui,l={},d=e.indexOf("_");return l.mmdbid=e.substr(0,d),l.chain=e.substr(d+1),l.resi=t?"":s,l.resn=n?t?"-":i?n.toUpperCase():n.toLowerCase():"-",l.aligned=!t&&i,l.color=t||!i?o.htmlCls.GREYC:n==r?"#FF0000":"#0000FF",l.color2=t||!i?o.htmlCls.GREYC:"#"+a.showAnnoCls.getColorhexFromBlosum62(n,r),l.class=t||!i?"icn3d-nalign":n==r?"icn3d-cons":"icn3d-ncons",l}getResn(e,t){let i,s=this.icn3d;return s.icn3dui,i=s.chainsSeq[e]&&s.chainsSeq[e][t]?s.chainsSeq[e][t].name:"",i}getResiPosInTemplate(e,t){let i=this.icn3d;i.icn3dui;let s,n=0;if(i.alnChainsSeq[e])for(let r=0,a=i.alnChainsSeq[e].length;r<a;++r){if(parseInt(i.alnChainsSeq[e][r].resi)==parseInt(t)){s=r;break}"-"==i.alnChainsSeq[e][r].resn?++n:n=0}return{pos:s,ngap:n}}addGapAllAlnChains(e,t,i,s,n){let r=this.icn3d;r.icn3dui;let a=this.getResiPosInTemplate(i,s);a.ngap;let o=a.pos;for(let i=0,s=t.length-1;i<s;++i){let s=e[t[i]],a=this.getResObject(s,!0);for(let e=0,t=n;e<t;++e)r.alnChainsSeq[s].splice(o,0,a)}}insertNotAlignRes(e,t,i,s){let n=this.icn3d;n.icn3dui;for(let s=0,r=i;s<r;++s){let i=n.ParserUtilsCls.getResi(e,t+s),r=this.getResn(e,t+s),a="-",o=!1,l=this.getResObject(e,!1,o,i,r,a);n.alnChainsSeq[e].push(l)}}getTemplatePosFromOriPos(e,t,i,s){let n=this.icn3d;n.icn3dui;let r=n.ParserUtilsCls.getResi(e,t),a=n.ParserUtilsCls.getResi(e,i),o=this.getResiPosInTemplate(e,r),l=this.getResiPosInTemplate(e,a);return{pos1:o.pos,pos2:l.pos}}mergeTwoSeqForAll(e,t,i,s,n,r,a){let o,l,d,c,h,p,u,m,f,g,b=this.icn3d,C=b.icn3dui,v={},_=e[t],y=t-1;if(u=e[0].indexOf("_"),m=_.indexOf("_"),o=e[0].substr(0,u),l=_.substr(0,m),d=e[0].substr(u+1),c=_.substr(m+1),o==l&&d==c){let e=b.chainsSeq[b.mmdbid_q+"_"+b.chain_q].length;b.qt_start_end[y]={q_start:1,q_end:e,t_start:1,t_end:e}}if(h=o+"_"+d,p=l+"_"+c,void 0!==l&&b.mmdbid_t,b.alnChains[p]={},b.conservedName2=p+"_cons",b.nonConservedName2=p+"_ncons",b.notAlignedName2=p+"_nalign",b.consHash2={},b.nconsHash2={},b.nalignHash2={},void 0===b.qt_start_end[y])return;this.getResObject(h,!0);let S,w=this.getResObject(p,!0);b.chainsMapping[h]||(b.chainsMapping[h]={}),b.chainsMapping[p]||(b.chainsMapping[p]={});for(let t=0,s=b.qt_start_end[y].length;t<s;++t){let s,r,o,l,d,c,_;if(a&&"tmalign"==C.cfg.aligntool?(s=parseInt(b.qt_start_end[y][t].t_start),r=parseInt(b.qt_start_end[y][t].q_start),o=parseInt(b.qt_start_end[y][t].t_end),l=parseInt(b.qt_start_end[y][t].q_end),d=s,c=this.getPosFromResi(h,b.qt_start_end[y][t].t_start),_=this.getPosFromResi(h,b.qt_start_end[y][t].t_end)):(s=parseInt(b.qt_start_end[y][t].t_start-1),r=parseInt(b.qt_start_end[y][t].q_start-1),o=parseInt(b.qt_start_end[y][t].t_end-1),l=parseInt(b.qt_start_end[y][t].q_end-1),d=b.ParserUtilsCls.getResi(h,s),c=s,_=o),0==t){if(S=this.getTemplatePosFromOriPos(h,n,c,a),u=S.pos1,m=S.pos2,c>n)for(let e=0,t=m-u;e<t;++e)b.alnChainsSeq[p].push(w)}else{S=this.getTemplatePosFromOriPos(h,f,s,a),u=S.pos1,m=S.pos2;let t=m-(u+1),n=r-(g+1);if(this.insertNotAlignRes(p,g+1,n,a),t>=n)for(let e=0,i=t-n;e<i;++e)b.alnChainsSeq[p].push(w);else this.addGapAllAlnChains(e,i,h,d,n-t)}S=this.getTemplatePosFromOriPos(h,c,_,a),u=S.pos1,m=S.pos2;let x=0;b.chainsMapping[h]||(b.chainsMapping[h]={}),b.chainsMapping[p]||(b.chainsMapping[p]={});for(let e=u;e<=m;++e)if("-"==b.alnChainsSeq[h][e].resn)b.alnChainsSeq[p].push(w);else{let t=a?s+x:b.ParserUtilsCls.getResi(h,s+x),i=a?r+x:b.ParserUtilsCls.getResi(p,r+x),n=this.getResnFromResi(h,t),o=this.getResnFromResi(p,i),l=!0,d=this.getResObject(p,!1,l,i,o,n);b.alnChainsSeq[p].push(d),b.alnChainsSeq[h][e].color=d.color,b.chainsMapping[h][h+"_"+t]=n+t,b.chainsMapping[p][p+"_"+i]=n+t,$.extend(b.alnChains[p],b.residues[p+"_"+i]),v=C.hashUtilsCls.unionHash(v,b.residues[p+"_"+i]),++x}f=o,g=l}S=this.getTemplatePosFromOriPos(h,f,r,a),u=S.pos1,m=S.pos2;for(let e=u;e<m;++e)b.alnChainsSeq[p].push(w);return v}mergeTwoSeqForAllSimple(e,t,i,s,n,r,a){let o=this.icn3d;o.icn3dui;let l,d,c,h,p=e,u=t[i];for(let e=0,r=o.qt_start_end[i].length;e<r;++e){let r,m,f,g,b,C,v;if(r=o.qt_start_end[i][e].t_start,m=o.qt_start_end[i][e].q_start,f=o.qt_start_end[i][e].t_end,g=o.qt_start_end[i][e].q_end,b=r,C=r,v=f,0==e){if(l=n,d=C,C>n)for(let e=0,t=d-l;e<t;++e)o.msaSeq[u]+="-"}else{l=c,d=r;let e=d-(l+1),n=m-(h+1);for(let e=0,t=n;e<t;++e){let t=a[i][h+1+e];o.msaSeq[u]+=t}if(e>=n)for(let t=0,i=e-n;t<i;++t)o.msaSeq[u]+="-";else{let i=b;for(let r=0,a=s.length-1;r<a;++r){let a=0==r?p:t[s[r]];for(let t=0,s=n-e;t<s;++t)o.msaSeq[a]=o.msaSeq[a].substr(0,i)+"-"+o.msaSeq[a].substr(i)}}}l=C,d=v;let _=0;for(let e=l;e<=d;++e)if("-"==o.msaSeq[p][e])o.msaSeq[u]+="-";else{let e=a[i][m+_];o.msaSeq[u]+=e,++_}c=f,h=g}l=c,d=r;for(let e=l;e<d;++e)o.msaSeq[u]+="-"}setSeqAlignForRealign(e,t,i){let s=this.icn3d,n=s.icn3dui;s.conservedName1=e+"_cons",s.conservedName2=t+"_cons",s.consHash1={},s.consHash2={},s.alnChainsAnTtl={},s.alnChainsAnno={},void 0===s.alnChainsSeq&&(s.alnChainsSeq={}),s.alnChains={},s.alnChainsSeq[e]=[],s.alnChains[e]={},s.alnChainsAnno[e]=[],s.alnChainsAnTtl[e]=[],s.alnChainsSeq[t]=[],s.alnChains[t]={};let r={};s.chainsMapping[e]||(s.chainsMapping[e]={}),s.chainsMapping[t]||(s.chainsMapping[t]={});for(let i=0,a=s.realignResid[e].length;i<a;++i){let a=s.realignResid[e][i],o=a.resid.lastIndexOf("_"),l=a.resid.substr(0,o),d=a.resid.substr(o+1);a.resi=d,a.aligned=!0;let c,h=s.realignResid[t][i],p=h.resid.lastIndexOf("_"),u=h.resid.substr(0,p),m=h.resid.substr(p+1);h.resi=m,h.aligned=!0,r[a.resid]=1,r[h.resid]=1,c=a.resn.toUpperCase()==h.resn.toUpperCase()?"#FF0000":"#0000FF",s.chainsMapping[e][e+"_"+a.resi]=a.resn+a.resi,s.chainsMapping[t][t+"_"+h.resi]=a.resn+a.resi;let f="#"+s.showAnnoCls.getColorhexFromBlosum62(a.resn,h.resn);a.color=c,h.color=c,a.color2=f,h.color2=f;for(let e in s.residues[a.resid])s.atoms[e].color=n.parasCls.thr(c);for(let e in s.residues[h.resid])s.atoms[e].color=n.parasCls.thr(c);void 0===s.alnChainsAnTtl[l]&&(s.alnChainsAnTtl[l]=[]);for(let e=0;e<3;++e)void 0===s.alnChainsAnTtl[l][e]&&(s.alnChainsAnTtl[l][e]=[]);for(let e=0;e<3;++e)s.alnChainsAnTtl[l][e].push("");void 0===s.alnChainsSeq[l]&&(s.alnChainsSeq[l]=[]),void 0===s.alnChainsSeq[u]&&(s.alnChainsSeq[u]=[]),s.alnChainsSeq[l].push(a),s.alnChainsSeq[u].push(h),void 0===s.alnChains[l]&&(s.alnChains[l]={}),void 0===s.alnChains[u]&&(s.alnChains[u]={}),$.extend(s.alnChains[l],s.residues[l+"_"+a.resi]),$.extend(s.alnChains[u],s.residues[u+"_"+h.resi]),s.consHash1[l+"_"+a.resi]=1,s.consHash2[u+"_"+h.resi]=1,void 0===s.alnChainsAnno[l]&&(s.alnChainsAnno[l]=[]);for(let e=0;e<3;++e)void 0===s.alnChainsAnno[l][e]&&(s.alnChainsAnno[l][e]=[]);let g=".";i%5==0&&(g="*"),i%10==0&&(g="|"),s.alnChainsAnno[l][0].push(g);let b="";i%10==0&&(b=i.toString()),s.alnChainsAnno[l][1].push(b)}let a="select "+s.resid2specCls.residueids2spec(Object.keys(r));s.selectionCls.addCustomSelection(Object.keys(r),"protein_aligned","protein aligned",a,!0)}setSeqPerResi(e,t,i,s,n,r,a,o,l,d,c,h){let p=this.icn3d,u=p.icn3dui;void 0===p.alnChainsSeq[e]&&(p.alnChainsSeq[e]=[]);let m={},f=e.indexOf("_");if(m.mmdbid=e.substr(0,f),m.chain=e.substr(f+1),m.resi=s,m.resn=""===m.resi||"icn3d-nalign"===l?n.toLowerCase():n,m.aligned=r,m.color=""===m.resi?u.htmlCls.GREYC:a,m.color2=""===m.resi?u.htmlCls.GREYC:o,m.class=l,p.alnChainsSeq[e].push(m),""!==m.resi&&(void 0===p.alnChains[e]&&(p.alnChains[e]={}),$.extend(p.alnChains[e],p.residues[e+"_"+m.resi])),d){if(void 0===p.alnChainsAnno[e]&&(p.alnChainsAnno[e]=[]),void 0===p.alnChainsAnno[e][0]&&(p.alnChainsAnno[e][0]=[]),void 0===p.alnChainsAnno[e][1]&&(p.alnChainsAnno[e][1]=[]),void 0===p.alnChainsAnno[e][2]&&(p.alnChainsAnno[e][2]=[]),void 0===p.alnChainsAnno[e][3]&&(p.alnChainsAnno[e][3]=[]),c){void 0===p.alnChainsAnno[e][4]&&(p.alnChainsAnno[e][4]=[]),void 0===p.alnChainsAnno[e][5]&&(p.alnChainsAnno[e][5]=[]),void 0===p.alnChainsAnno[e][6]&&(p.alnChainsAnno[e][6]=[]);let t=p.pdbid_chain2title&&p.pdbid_chain2title.hasOwnProperty(i)?p.pdbid_chain2title[i]:"",s=p.pdbid_chain2title&&p.pdbid_chain2title.hasOwnProperty(e)?p.pdbid_chain2title[e]:"";p.alnChainsAnno[e][4].push(t),p.alnChainsAnno[e][5].push(s),p.alnChainsAnno[e][6].push("")}let t=".";h%5==0&&(t="*"),h%10==0&&(t="|"),p.alnChainsAnno[e][2].push(t);let n="";h%10==0&&(n=h.toString()),p.alnChainsAnno[e][3].push(n);let r=e+"_"+s,a=p.secondaries[r];void 0!==a?p.alnChainsAnno[e][1].push(a):p.alnChainsAnno[e][1].push("-")}else{let i=e+"_"+s,n=p.secondaries[i];p.alnChainsAnno.hasOwnProperty(t)&&p.alnChainsAnno[t].length>0?void 0!==n?p.alnChainsAnno[t][0].push(n):p.alnChainsAnno[t][0].push("-"):console.log("Error: ic.alnChainsAnno[chainid1] is undefined")}}setMsaFormat(e){let t=this.icn3d;t.icn3dui;let i="",s="CLUSTALWW\n\n",n="",r=[],a=[],o=[],l=e[0];for(let s=0,d=e.length;s<d;++s){let c=e[s];i+=">"+c+"\n";let h=[],p=c.padEnd(20," "),u="".padEnd(20," "),m=[],f=[],g=0;for(let e=0,n=t.alnChainsSeq[c].length;e<n;++e){let n=t.alnChainsSeq[c][e].resn;if(i+=n,p+=n,s==d-1){let i=t.alnChainsSeq[c][e].class;u+="icn3d-cons"==i?"*":"icn3d-ncons"==i?".":" "}0==s?o.push(t.alnChainsSeq[c][e].resi):t.alnChainsSeq[c][e].aligned&&t.alnChainsSeq[l][e]&&t.alnChainsSeq[c][e]&&(m.push(t.alnChainsSeq[l][e].resi),f.push(t.alnChainsSeq[c][e].resi)),++g,g%60==0&&(i+="\n",p+=" "+String(60*parseInt(g/60)),h.push(p),p=c.padEnd(20," "),s==d-1&&(a.push(u),u="".padEnd(20," ")))}g%60!=0&&(h.push(p),s==d-1&&a.push(u)),i+="\n",r.push(h),s==d-1&&r.push(a);let b=t.resid2specCls.resi2range(m,!0),C=t.resid2specCls.resi2range(f,!0);s>0&&(n+=b+" | "+C+"\n")}for(let e=0,t=r[0].length;e<t;++e){for(let t=0,i=r.length;t<i;++t)s+=r[t][e]+"\n";s+="\n"}t.msa||(t.msa={}),t.msa.fasta||(t.msa.fasta=[]),t.msa.clustalw||(t.msa.clustalw=[]),t.msa.resbyres||(t.msa.resbyres=[]),t.msa.fasta.push(i),t.msa.clustalw.push(s),t.msa.resbyres.push(n)}}class $h{constructor(e){this.icn3d=e}getStructureId(e,t,i,s){let n=this.icn3d;n.icn3dui;let r=e=s&&n.idNMR?n.idNMR:e;return(e==n.defaultPdbId||i||n.structures.hasOwnProperty(e))&&(r=1===t?e:e+t.toString()),r}loadPDB(e,t,i,s,n,r,a,o){let l,d,c=this.icn3d,h=c.icn3dui,p={},u=!1,m=e.split("\n"),f={},g={};c.atoms||(r=!1),c.statefileArray&&(c.struct_statefile=[]),n||r?(c.oriNStru=c.structures?Object.keys(c.structures).length:0,d=c.oriNStru+1,l=c.atoms?Object.keys(c.atoms).length:0):(c.init(),d=1,l=0);let b,C,v,_,y,S,w,x,A,M=[],T=[],E=[],R=[],k=[],O=[],I="",P="",D="",L={},F=t||c.defaultPdbId,N=F,U=F,H="",B=!1,z=!0;for(let e in m){let a=m[e],q=a.substr(0,6);if("HEADER"!==q||B||t)if("TITLE "===q){let e=a.substr(10).replace(/ALPHAFOLD MONOMER V2.0 PREDICTION FOR /gi,"");c.molTitle+=e.trim()+" ",o&&c.esmTitle&&(c.molTitle=c.esmTitle),c.molTitleHash||(c.molTitleHash={}),c.molTitleHash[U]=c.molTitle}else if("HELIX "===q){c.bSecondaryStructure=!0;let e=""==a.substr(18,2).trim()?"A":a.substr(18,2).trim(),t=parseInt(a.substr(21,4)),i=parseInt(a.substr(33,4));for(let s=t;s<=i;++s){let n=U+"_"+e+"_"+s;R.push(n),s===t&&k.push(n),s===i&&O.push(n)}}else if("SHEET "===q){void 0!==i&&i||(c.bSecondaryStructure=!0);let e=""==a.substr(20,2).trim()?"A":a.substr(20,2).trim(),t=parseInt(a.substr(22,4)),s=parseInt(a.substr(33,4));for(let i=t;i<=s;++i){let n=U+"_"+e+"_"+i;M.push(n),i===t&&T.push(n),i===s&&E.push(n)}}else if("HBOND "===q)void 0!==i&&i||(c.bSecondaryStructure=!0);else if("SSBOND"===q){c.bSsbondProvided=!0;let e=U+"_"+(" "==a.substr(15,1)?"A":a.substr(15,1))+"_"+a.substr(17,4).trim(),t=U+"_"+(" "==a.substr(29,1)?"A":a.substr(29,1))+"_"+a.substr(31,4).trim();void 0===c.ssbondpnts[U]&&(c.ssbondpnts[U]=[]),c.ssbondpnts[U].push(e),c.ssbondpnts[U].push(t)}else if("REMARK"===q){let e=parseInt(a.substr(7,3));if(-1!==a.indexOf("1/2 of bilayer thickness:"))c.halfBilayerSize=parseFloat(a.substr(a.indexOf(":")+1).trim());else if(210==e)"EXPERIMENT TYPE"==a.substr(11,32).trim()&&"NMR"==a.substr(45).trim()&&(u=!0,c.idNMR=N);else if(350==e&&"BIOMT"==a.substr(13,5)){let e=parseInt(a[18])-1,t=parseInt(a.substr(21,2))-1;null==c.biomtMatrices[t]&&(c.biomtMatrices[t]=(new gi).identity()),c.biomtMatrices[t].elements[e]=parseFloat(a.substr(24,9)),c.biomtMatrices[t].elements[e+4]=parseFloat(a.substr(34,9)),c.biomtMatrices[t].elements[e+8]=parseFloat(a.substr(44,9)),c.biomtMatrices[t].elements[e+12]=parseFloat(a.substr(54,14))}else if(465==e&&" "==a.substr(18,1)&&" "==a.substr(20,1)&&"S"!=a.substr(21,1)){let e=a.substr(15,3),t=a.substr(18,2).trim(),i=a.substr(21,5).trim(),s=F+"_"+t;void 0===c.chainMissingResidueArray[s]&&(c.chainMissingResidueArray[s]=[]);let n={};n.resi=i,n.name=h.utilsCls.residueName2Abbr(e).toLowerCase(),""!=H&&t==H&&t!=H||(c.chainMissingResidueArray[s].push(n),H=t)}else 900==e&&void 0===c.emd&&"RELATED DB: EMDB"==a.substr(34).trim()&&(c.emd=a.substr(23,11).trim())}else if("SOURCE"===q&&void 0===c.organism&&"ORGANISM_COMMON"==a.substr(11,15).trim())c.organism=a.substr(28).toLowerCase().trim(),c.organism=c.organism.substr(0,c.organism.length-1);else if("ENDMDL"===q)c.statefileArray&&c.struct_statefile.push({structure:U,statefile:c.statefileArray[d-1]}),++d,F=c.defaultPdbId,U=this.getStructureId(F,d,n,u),u||(M=[],T=[],E=[],R=[],k=[],O=[]),B=!1;else if("JRNL  "===q)"PMID"===a.substr(12,4)&&(c.pmid=a.substr(19).trim());else if("ATOM  "===q||"HETATM"===q){x=a.substr(72,4).trim(),z?(U=this.getStructureId(F,d,n,u),z=!1):x!=A&&(++d,F=c.defaultPdbId,U=this.getStructureId(F,d,n,u),u||(M=[],T=[],E=[],R=[],k=[],O=[]),B=!1),A=x;let e=a.substr(16,1);++l,L[parseInt(a.substr(6,5))]=l;let t=a.substr(76,2).trim();""===t&&(t=a.substr(12,2).trim());let r=a.substr(12,4).trim(),m=a.substr(17,3),N=a.substr(20,2).trim();""===N&&(N="A");let H=a.substr(22,5).trim(),j=H;if(i&&"DUM"===m&&(t=r,N="MEM",j=1,H=1),s&&"DUM"===m)break;b=U+"_"+N,v=b+"_"+H,C=b+"_"+j;let G=parseFloat(a.substr(30,8)),$=parseFloat(a.substr(38,8)),V=parseFloat(a.substr(46,8)),W=new mt(G,$,V),X=parseFloat(a.substr(60,8));o&&(X*=100);let Y={het:"H"===q[0],serial:l,name:r,alt:e,resn:m,structure:U,chain:N,resi:j,coord:W,b:X,elem:t,bonds:[],ss:"coil",ssbegin:!1,ssend:!1};if(Y.het||"C"!==Y.name||(_=l),Y.het||"O"!==Y.name||(S=l),!Y.het&&"N"===Y.name&&void 0!==y&&void 0!==w){let e=c.atoms[y].coord.distanceTo(c.atoms[w].coord),t=Y.coord.x+(c.atoms[y].coord.x-c.atoms[w].coord.x)/e,i=Y.coord.y+(c.atoms[y].coord.y-c.atoms[w].coord.y)/e,s=Y.coord.z+(c.atoms[y].coord.z-c.atoms[w].coord.z)/e;Y.hcoord=new mt(t,i,s)}c.atoms[l]=Y,c.dAtoms[l]=1,c.hAtoms[l]=1,p[l]=1,this.isSecondary(C,M,u)?(c.atoms[l].ss="sheet",this.isSecondary(C,T,u)&&(c.atoms[l].ssbegin=!0),this.isSecondary(C,E,u)&&(c.atoms[l].ssend=!0)):this.isSecondary(C,R,u)&&(c.atoms[l].ss="helix",this.isSecondary(C,k,u)&&(c.atoms[l].ssbegin=!0),this.isSecondary(C,O,u)&&(c.atoms[l].ssend=!0));let K="-";if(K="helix"===c.atoms[l].ss?"H":"sheet"===c.atoms[l].ss?"E":!c.atoms[l].het&&h.parasCls.residueColors.hasOwnProperty(c.atoms[l].resn.toUpperCase())?"c":"o",c.secondaries[C]=K,v!==D){let e=h.utilsCls.residueName2Abbr(m);if(c.residueId2Name[C]=e,1!==l&&""!==P&&(c.residues[P]=g),C!==P&&(g={}),b!==I){y=void 0,w=void 0,1!==l&&""!==I&&(void 0===c.chains[I]&&(c.chains[I]={}),c.chains[I]=h.hashUtilsCls.unionHash(c.chains[I],f)),f={},void 0===c.structures[U.toString()]&&(c.structures[U.toString()]=[]),c.structures[U.toString()].includes(b)||c.structures[U.toString()].push(b),void 0===c.chainsSeq[b]&&(c.chainsSeq[b]=[]);let t={};t.resi=j,t.name=e,c.chainsSeq[b].push(t)}else{y=_,w=S;let t={};t.resi=j,t.name=e,c.chainsSeq[b].push(t)}}f[l]=1,g[l]=1,I=b,P=C,D=v}else if("CONECT"===q){let e=parseInt(a.substr(6,5));for(let t=0;t<4;++t){let i=parseInt(a.substr([11,16,21,26][t],5));isNaN(i)||void 0!==c.atoms[L[e]]&&c.atoms[L[e]].bonds.push(L[i])}}else q.substr(0,3);else F=a.substr(62).trim(),F=F.replace(/_/g,"-"),N=F,""==F&&(F=r?c.defaultPdbId:c.inputid&&-1==c.inputid.indexOf("/")?c.inputid.substr(0,10):c.defaultPdbId),U=this.getStructureId(F,d,n,u),c.molTitle="",void 0===c.allData&&(c.molTitleHash={}),B=!0}c.residues[C]=g,void 0===c.chains[b]&&(c.chains[b]={}),c.chains[b]=h.hashUtilsCls.unionHash2Atoms(c.chains[b],f,c.atoms),c.statefileArray&&c.struct_statefile.push({structure:U,statefile:c.statefileArray[d-1]}),this.adjustSeq(c.chainMissingResidueArray);let q=Object.keys(c.structures);for(let e=0,t=q.length;e<t;++e){let t=q[e];if(t!=F&&(void 0===c.ssbondpnts[t]&&(c.ssbondpnts[t]=[]),void 0!==c.ssbondpnts[F]))for(let e=0,i=c.ssbondpnts[F].length;e<i;++e){let i=c.ssbondpnts[F][e],s=i.indexOf("_"),n=t+i.substr(s);c.ssbondpnts[t].push(n)}}c.bSsbondProvided||this.setSsbond(),m=null;let j,G,V=[],W=new mt(9999,9999,9999),X=new mt(-9999,-9999,-9999),Y=new mt,K=0,Z={},J=[];for(let e in c.hAtoms){let t=c.atoms[e],i=t.coord;Y.add(i),W.min(i),X.max(i),++K,1==K&&(j=t.chain,G=t.resi,J.push(t)),t.het?t.het&&("HOH"===t.resn||"WAT"===t.resn||"SOL"===t.resn?c.water[t.serial]=1:-1!==$.inArray(t.resn,h.parasCls.ionsArray)||t.elem.trim()===t.resn.trim()?c.ions[t.serial]=1:c.chemicals[t.serial]=1,t.color=h.parasCls.atomColors[t.elem]):-1!==$.inArray(t.resn,h.parasCls.nucleotidesArray)?(c.nucleotides[t.serial]=1,"O3'"!==t.name&&"O3*"!==t.name||(c.nucleotidesO3[t.serial]=1,c.secondaries[t.structure+"_"+t.chain+"_"+t.resi]="o"),-1===h.parasCls.nuclMainArray.indexOf(t.name)&&(c.ntbase[t.serial]=1)):("P"===t.elem&&(Z[t.structure+"_"+t.chain+"_"+t.resi]=1),c.proteins[t.serial]=1,"CA"===t.name&&(c.calphas[t.serial]=1),"N"!==t.name&&"H"!==t.name&&"CA"!==t.name&&"HA"!==t.name&&"C"!==t.name&&"O"!==t.name&&(c.sidec[t.serial]=1)),j===t.chain&&G===t.resi||(this.refreshBonds(V,J[0]),J.splice(0,1),j=t.chain,G=t.resi,V.length=0),V.push(t),"C"!==t.name&&"O3'"!==t.name||J.push(t)}this.refreshBonds(V,J[0]);for(let e in Z){let t=c.residues[e];for(l in t){let t=c.atoms[l];t.het=!0,c.chemicals[t.serial]=1,c.secondaries[e]="o",delete c.proteins[t.serial],"CA"===t.name&&delete c.calphas[t.serial],"N"!==t.name&&"H"!==t.name&&"CA"!==t.name&&"HA"!==t.name&&"C"!==t.name&&"O"!==t.name&&delete c.sidec[t.serial]}}return c.pmin=W,c.pmax=X,c.cnt=K,c.center=c.ParserUtilsCls.getGeoCenter(c.pmin,c.pmax),c.maxD=c.ParserUtilsCls.getStructureSize(c.atoms,c.pmin,c.pmax,c.center),c.maxD<5&&(c.maxD=5),c.oriMaxD=c.maxD,c.oriCenter=c.center.clone(),"target"===a?(c.oriMaxD=c.maxD,c.center1=c.center):"query"===a&&(c.oriMaxD<c.maxD&&(c.oriMaxD=c.maxD),c.center2=c.center,c.center=new mt(0,0,0)),s?this.getChainCalpha(c.chains,c.atoms):p}refreshBonds(e,t){let i=this.icn3d.icn3dui,s=e.length;for(let n=0;n<s;++n){let r=e[n];for(let t=n+1;t<s;++t){let s=e[t];r.alt===s.alt&&i.utilsCls.hasCovalentBond(r,s)&&(r.bonds.push(s.serial),s.bonds.push(r.serial))}!t||"C"!==t.name&&"O3'"!==t.name||"N"!==r.name&&"P"!==r.name||!i.utilsCls.hasCovalentBond(r,t)||(r.bonds.push(t.serial),t.bonds.push(r.serial))}}adjustSeq(e){let t=this.icn3d;t.icn3dui;for(let i in t.chainsSeq)void 0!==e[i]&&(t.chainsSeq[i]=this.mergeTwoSequences(e[i],t.chainsSeq[i]));this.setResidMapping()}mergeTwoSequences(e,t){let i=e.length,s=t.length,n=parseInt(e[i-1].resi),r=parseInt(t[s-1].resi),a=n>=r?n:r,o=new Array(i+s),l=0,d=0,c=0,h=!1;for(;l<i&&d<s;){let i=parseInt(e[l].resi),s=parseInt(t[d].resi);i>a&&s>a&&(h=!0),i<=a&&s>a?i>s||h?(o[c]=t[d],d++):(o[c]=e[l],l++):i>a&&s<=a?i<=s||h?(o[c]=e[l],l++):(o[c]=t[d],d++):i<=s?(o[c]=e[l],l++):(o[c]=t[d],d++),c++}if(l<i)for(let t=l;t<i;t++)o[c]=e[t],c++;else for(let e=d;e<s;e++)o[c]=t[e],c++;return o}setResidMapping(){let e=this.icn3d;e.icn3dui;for(let t in e.chainsSeq)for(let i=0,s=e.chainsSeq[t].length;i<s;++i){let s=t+"_"+(i+1).toString(),n=t+"_"+e.chainsSeq[t][i].resi;e.ncbi2resid[s]=n,e.resid2ncbi[n]=s}}setSsbond(e){let t=this.icn3d;t.icn3dui;let i={};for(let s in t.chainsSeq){if(e&&!e.hasOwnProperty(s))continue;let n=t.chainsSeq[s],r=s.substr(0,s.indexOf("_"));for(let e=0,t=n.length;e<t;++e)"C"==n[e].name&&(null==i[r]&&(i[r]=[]),i[r].push(s+"_"+n[e].resi))}for(let e in i){let s=i[e];for(let i=0,n=s.length;i<n;++i)for(let n=i+1,r=s.length;n<r;++n){let r,a,o=s[i],l=s[n];for(let e in t.residues[o])if("S"==t.atoms[e].elem){r=t.atoms[e].coord;break}for(let e in t.residues[l])if("S"==t.atoms[e].elem){a=t.atoms[e].coord;break}void 0!==r&&void 0!==a&&(Math.abs(r.x-a.x)>4||Math.abs(r.y-a.y)>4||Math.abs(r.z-a.z)>4||(r.x-a.x)*(r.x-a.x)+(r.y-a.y)*(r.y-a.y)+(r.z-a.z)*(r.z-a.z)<16&&(void 0===t.ssbondpnts[e]&&(t.ssbondpnts[e]=[]),t.ssbondpnts[e].push(o),t.ssbondpnts[e].push(l)))}}}getChainCalpha(e,t,i,s){let n=this.icn3d,r=n.icn3dui,a={};for(let o in e){if(void 0!==s){if(o.split("_")[0]!==s)continue}let l=Object.keys(e[o]),d=[],c=0,h=0;for(let e=0,s=l.length;e<s;++e){let s=t[l[e]];if(n.proteins.hasOwnProperty(l[e])&&"CA"==s.name||n.nucleotides.hasOwnProperty(l[e])&&("O3'"==s.name||"O3*"==s.name)){if(s.resi==h)continue;let e=s.resn.trim().length>3?s.resn.trim().substr(0,3):s.resn.trim();if(!r.parasCls.chargeColors.hasOwnProperty(e))continue;i?s.resi_ori:s.resi,d.push(s.coord.clone()),++c,h=s.resi}}if(c>0){a[t[l[0]].chain]=d}}return{chainresiCalphaHash:a,center:n.center.clone()}}isSecondary(e,t,i,s){if(this.icn3d.icn3dui,s)return!1;if(i){let i=e.substr(e.indexOf("_")+1),s=!1;for(let e=0,n=t.length;e<n;++e)if(i==t[e].substr(t[e].indexOf("_")+1)){s=!0;break}return s}return-1!=$.inArray(e,t)}}class Vh{constructor(e){this.icn3d=e}loadCIF(e,t,i,s){let n,r,a=this.icn3d,o=a.icn3dui,l={},d=!1,c={},h={};a.atoms||(s=!1),s?(a.oriNStru=a.structures?Object.keys(a.structures).length:0,r=a.oriNStru,n=a.atoms?Object.keys(a.atoms).length:0):(a.init(),r=0,n=0);let p,u,m,f,g,b,C,v=[],_=[],y=[],S=[],w=[],x=[],A="",M="",T="",E=t||a.defaultPdbId,R=E,k=i?e.split("ENDMDL\n"):[e];for(let e=0,t=k.length;e<t;++e){++r,E=a.defaultPdbId,R=a.loadPDBCls.getStructureId(E,r),v=[],_=[],y=[],S=[],w=[],x=[];let t=i?CIFTools.Text.parse(k[e]):CIFTools.Binary.parse(k[e]);if(t.isError)return void alert("The Binary CIF data can NOT be parsed: "+t.toString());let O=t.result.dataBlocks[0];if(O.getCategory("_entry")&&(E=O.getCategory("_entry").getColumn("id").getString(0),E=E.replace(/_/g,"-"),""==E&&(E=s?a.defaultPdbId:a.inputid&&-1==a.inputid.indexOf("/")?a.inputid.substr(0,10):a.defaultPdbId),R=a.loadPDBCls.getStructureId(E,r),a.molTitle="",a.molTitleHash={}),O.getCategory("_struct")){let e=O.getCategory("_struct").getColumn("title").getString(0);e=e.replace(/"/,"'");let t=e.replace(/ALPHAFOLD MONOMER V2.0 PREDICTION FOR /gi,"");a.molTitle+=t.trim()+" ",a.molTitleHash||(a.molTitleHash={}),a.molTitleHash[R]=a.molTitle}if(O.getCategory("_entity_src_gen")&&(a.organism=O.getCategory("_entity_src_gen").getColumn("gene_src_common_name").getString(0)),O.getCategory("_database_2")){let e=O.getCategory("_database_2"),t=e.rowCount;for(let i=0;i<t;++i){let t=e.getColumn("database_id").getString(0),i=e.getColumn("database_code").getString(0);if("EMDB"==t){a.emd=i;break}}}if(O.getCategory("_struct_conf")){a.bSecondaryStructure=!0;let e=O.getCategory("_struct_conf"),t=e.getColumn("conf_type_id"),i=e.getColumn("beg_auth_asym_id"),s=e.getColumn("beg_auth_seq_id");e.getColumn("end_auth_asym_id");let n=e.getColumn("end_auth_seq_id"),r=e.rowCount;for(let e=0;e<r;++e){let r=t.getString(e),a=i.getString(e),o=parseInt(s.getString(e)),l=parseInt(n.getString(e));if("HELX"==r.substr(0,4))for(let e=parseInt(o);e<=parseInt(l);++e){let t=R+"_"+a+"_"+e;S.push(t),e==o&&w.push(t),e==l&&x.push(t)}else if("STRN"==r.substr(0,4))for(let e=o;e<=l;++e){let t=R+"_"+a+"_"+e;v.push(t),e==o&&_.push(t),e==l&&y.push(t)}}t=i=s=n=[]}if(O.getCategory("_struct_sheet_range")){let e=O.getCategory("_struct_sheet_range"),t=e.getColumn("beg_auth_asym_id"),i=e.getColumn("beg_auth_seq_id");e.getColumn("end_auth_asym_id");let s=e.getColumn("end_auth_seq_id"),n=e.rowCount;for(let e=0;e<n;++e){let n=t.getString(e),r=parseInt(i.getString(e)),a=parseInt(s.getString(e));for(let e=r;e<=a;++e){let t=R+"_"+n+"_"+e;v.push(t),e==r&&_.push(t),e==a&&y.push(t)}}t=i=s=[]}if(O.getCategory("_struct_conn")){a.bSsbondProvided=!0;let e=O.getCategory("_struct_conn"),t=e.getColumn("conn_type_id"),i=e.getColumn("ptnr1_auth_asym_id"),s=e.getColumn("ptnr1_label_atom_id"),n=e.getColumn("ptnr1_label_seq_id"),r=e.getColumn("ptnr2_auth_asym_id"),o=e.getColumn("ptnr2_label_atom_id"),l=e.getColumn("ptnr2_label_seq_id"),d=e.rowCount;for(let e=0;e<d;++e){let d=t.getString(e),c=i.getString(e);s.getString(e);let h=R+"_"+c+"_"+n.getString(e),p=r.getString(e);o.getString(e);let u=R+"_"+p+"_"+l.getString(e);"disulf"==d&&(void 0===a.ssbondpnts[R]&&(a.ssbondpnts[R]=[]),a.ssbondpnts[R].push(h),a.ssbondpnts[R].push(u))}t=i=s=n=r=o=l=[]}if(O.getCategory("_exptl")){-1!=O.getCategory("_exptl").getColumn("method").getString(0).indexOf("NMR")&&(d=!0)}if(O.getCategory("_pdbx_struct_oper_list")){let e=O.getCategory("_pdbx_struct_oper_list"),t=e.getColumn("id"),i=e.getColumn("matrix[1][1]"),s=e.getColumn("matrix[1][2]"),n=e.getColumn("matrix[1][3]"),r=e.getColumn("vector[1]"),o=e.getColumn("matrix[2][1]"),l=e.getColumn("matrix[2][2]"),d=e.getColumn("matrix[2][3]"),c=e.getColumn("vector[2]"),h=e.getColumn("matrix[3][1]"),p=e.getColumn("matrix[3][2]"),u=e.getColumn("matrix[3][3]"),m=e.getColumn("vector[3]"),f=e.rowCount;for(let e=0;e<f;++e){"X0"!=t.getString(e)&&(null==a.biomtMatrices[e]&&(a.biomtMatrices[e]=(new gi).identity()),a.biomtMatrices[e].set(i.getString(e),s.getString(e),n.getString(e),r.getString(e),o.getString(e),l.getString(e),d.getString(e),c.getString(e),h.getString(e),p.getString(e),u.getString(e),m.getString(e),0,0,0,1))}t=i=s=n=r=o=l=d=c=h=p=u=m=[]}O.getCategory("_citation")&&(a.pmid=O.getCategory("_citation").getColumn("pdbx_database_id_PubMed").getString(0));let I=O.getCategory("_atom_site"),P=I.rowCount,D=!(P>a.maxatomcnt);D||(a.opts.proteins="c alpha trace",a.opts.nucleotides="o3 trace");let L,F=I.getColumn("group_PDB"),N=I.getColumn("label_comp_id"),U=I.getColumn("type_symbol"),H=I.getColumn("label_atom_id"),B=I.getColumn("auth_asym_id"),z=I.getColumn("label_seq_id"),q=I.getColumn("auth_seq_id"),j=I.getColumn("label_alt_id"),G=I.getColumn("B_iso_or_equiv"),$=I.getColumn("Cartn_x"),V=I.getColumn("Cartn_y"),W=I.getColumn("Cartn_z"),X=I.getColumn("label_asym_id"),Y=I.getColumn("pdbx_PDB_model_num"),K={},Z="",J={},Q="";for(let e=0;e<P;++e){let t=Y.getString(e);e>0&&t!=Q&&(++r,R="1"==t?E:E+t),Q=t;let i,s=F.getString(e),k=N.getString(e),O=U.getString(e),I=H.getString(e),P=B.getString(e),ee=z.getString(e),te=q.getString(e),ie=j.getString(e),se=G.getString(e),ne=X.getString(e);if(ee=te,"ATOM"==s?i=3==k.length?"protein":"nucleotide":"WAT"==k||"HOH"==k?(i="solvent",P="Misc"):(i="ligand",P=k),""===P&&(P="A"),!D&&("protein"==i&&("C"!=O||"CA"!=I)||"nucleotide"==i&&"P"!=I))continue;if("B"==ie)continue;if(J[P]=1,++n,"?"!=ee&&"."!=ee&&"0"!=ee||(ee=te),"solvent"==i||"ligand"==i){let e={};K.hasOwnProperty(P)||(K[P]=[]),3!=k.length||"HOH"==k||"WAT"==k?3==k.length&&("O"!=O||"HOH"!=k&&"WAT"!=k)||(e.resi=ee,e.name=o.utilsCls.residueName2Abbr(k),K[P].push(e)):P+"_"+k==L&&Z==ne||(e.resi=ee,e.name=o.utilsCls.residueName2Abbr(k),K[P].push(e))}p=R+"_"+P,m=p+"_"+te,u=p+"_"+ee;let re=$.getFloat(e),ae=V.getFloat(e),oe=W.getFloat(e),le={het:"HETATM"==s,serial:n,name:I,alt:ie,resn:k,structure:R,chain:P,resi:ee,coord:new mt(re,ae,oe),b:se,elem:O,bonds:[],ss:"coil",ssbegin:!1,ssend:!1};if(le.het||"C"!==le.name||(f=n),le.het||"O"!==le.name||(b=n),!le.het&&"N"===le.name&&void 0!==g&&void 0!==C){let e=a.atoms[g].coord.distanceTo(a.atoms[C].coord),t=le.coord.x+(a.atoms[g].coord.x-a.atoms[C].coord.x)/e,i=le.coord.y+(a.atoms[g].coord.y-a.atoms[C].coord.y)/e,s=le.coord.z+(a.atoms[g].coord.z-a.atoms[C].coord.z)/e;le.hcoord=new mt(t,i,s)}a.atoms[n]=le,a.dAtoms[n]=1,a.hAtoms[n]=1,l[n]=1,a.loadPDBCls.isSecondary(u,v,d,!D)?(a.atoms[n].ss="sheet",a.loadPDBCls.isSecondary(u,_,d,!D)&&(a.atoms[n].ssbegin=!0),a.loadPDBCls.isSecondary(u,y,d,!D)&&(a.atoms[n].ssend=!0)):a.loadPDBCls.isSecondary(u,S,d,!D)&&(a.atoms[n].ss="helix",a.loadPDBCls.isSecondary(u,w,d,!D)&&(a.atoms[n].ssbegin=!0),a.loadPDBCls.isSecondary(u,x,d,!D)&&(a.atoms[n].ssend=!0));let de="-";if(de="helix"===a.atoms[n].ss?"H":"sheet"===a.atoms[n].ss?"E":!a.atoms[n].het&&o.parasCls.residueColors.hasOwnProperty(a.atoms[n].resn.toUpperCase())?"c":"o",a.secondaries[u]=de,m!==T||P+"_"+k!=L||Z!=ne){let e=o.utilsCls.residueName2Abbr(k);if(a.residueId2Name[u]=e,1!==n&&""!==M&&(a.residues[M]=h),u!==M&&(h={}),p!==A){g=void 0,C=void 0,1!==n&&""!==A&&(void 0===a.chains[A]&&(a.chains[A]={}),a.chains[A]=o.hashUtilsCls.unionHash(a.chains[A],c)),c={},void 0===a.structures[R.toString()]&&(a.structures[R.toString()]=[]),a.structures[R.toString()].includes(p)||a.structures[R.toString()].push(p),void 0===a.chainsSeq[p]&&(a.chainsSeq[p]=[]);let t={};t.resi=ee,t.name=e,a.chainsSeq[p].push(t)}else{g=f,C=b;let t={};t.resi=ee,t.name=e,a.chainsSeq[p].push(t)}}c[n]=1,h[n]=1,A=p,M=u,T=m,L=P+"_"+k,Z=ne}a.residues[u]=h,void 0===a.chains[p]&&(a.chains[p]={}),a.chains[p]=o.hashUtilsCls.unionHash2Atoms(a.chains[p],c,a.atoms),F=N=U=H=B=z=q=j=G=$=V=W=X=[];let ee={};if(O.getCategory("_pdbx_poly_seq_scheme")){let e=O.getCategory("_pdbx_poly_seq_scheme"),t=e.getColumn("seq_id"),i=e.getColumn("pdb_seq_num"),s=e.getColumn("mon_id"),n=e.getColumn("pdb_strand_id"),r=e.rowCount,a="",l=[];for(let e=0;e<r;++e){t.getString(e);let r=i.getString(e),d=s.getString(e),c=n.getString(e);c!=a&&e>0&&(ee[a]=l,l=[]),l.push({resi:r,name:o.utilsCls.residueName2Abbr(d)}),a=c}ee[a]=l,t=i=s=n=[]}this.setSeq(R,J,ee,K)}let O=Object.keys(a.structures);for(let e=0,t=O.length;e<t;++e){let t=O[e];if(t!=E&&(void 0===a.ssbondpnts[t]&&(a.ssbondpnts[t]=[]),void 0!==a.ssbondpnts[E]))for(let e=0,i=a.ssbondpnts[E].length;e<i;++e){let i=a.ssbondpnts[E][e],s=i.indexOf("_"),n=t+i.substr(s);a.ssbondpnts[t].push(n)}}a.bSsbondProvided||a.loadPDBCls.setSsbond();let I,P,D=[],L=new mt(9999,9999,9999),F=new mt(-9999,-9999,-9999),N=new mt,U=0,H={},B=[];for(let e in a.hAtoms){let t=a.atoms[e],i=t.coord;N.add(i),L.min(i),F.max(i),++U,1==U&&(I=t.chain,P=t.resi,B.push(t)),t.het?t.het&&("HOH"===t.resn||"WAT"===t.resn||"SOL"===t.resn?a.water[t.serial]=1:-1!==$.inArray(t.resn,o.parasCls.ionsArray)||t.elem.trim()===t.resn.trim()?a.ions[t.serial]=1:a.chemicals[t.serial]=1,t.color=o.parasCls.atomColors[t.elem]):-1!==$.inArray(t.resn,o.parasCls.nucleotidesArray)?(a.nucleotides[t.serial]=1,"O3'"!==t.name&&"O3*"!==t.name||(a.nucleotidesO3[t.serial]=1,a.secondaries[t.structure+"_"+t.chain+"_"+t.resi]="o"),-1===o.parasCls.nuclMainArray.indexOf(t.name)&&(a.ntbase[t.serial]=1)):("P"===t.elem&&(H[t.structure+"_"+t.chain+"_"+t.resi]=1),a.proteins[t.serial]=1,"CA"===t.name&&(a.calphas[t.serial]=1),"N"!==t.name&&"H"!==t.name&&"CA"!==t.name&&"HA"!==t.name&&"C"!==t.name&&"O"!==t.name&&(a.sidec[t.serial]=1)),I===t.chain&&P===t.resi||(a.loadPDBCls.refreshBonds(D,B[0]),B.splice(0,1),I=t.chain,P=t.resi,D.length=0),D.push(t),"C"!==t.name&&"O3'"!==t.name||B.push(t)}a.loadPDBCls.refreshBonds(D,B[0]);for(let e in H){let t=a.residues[e];for(n in t){let t=a.atoms[n];t.het=!0,a.chemicals[t.serial]=1,a.secondaries[e]="o",delete a.proteins[t.serial],"CA"===t.name&&delete a.calphas[t.serial],"N"!==t.name&&"H"!==t.name&&"CA"!==t.name&&"HA"!==t.name&&"C"!==t.name&&"O"!==t.name&&delete a.sidec[t.serial]}}return a.pmin=L,a.pmax=F,a.cnt=U,a.center=a.ParserUtilsCls.getGeoCenter(a.pmin,a.pmax),a.maxD=a.ParserUtilsCls.getStructureSize(a.atoms,a.pmin,a.pmax,a.center),a.maxD<5&&(a.maxD=5),a.oriMaxD=a.maxD,a.oriCenter=a.center.clone(),l}setSeq(e,t,i,s){let n=this.icn3d;n.icn3dui;for(let r in t){let t=e+"_"+r;s.hasOwnProperty(r)?n.chainsSeq[t]=s[r]:n.chainsSeq[t]=i[r]}n.loadPDBCls.setResidMapping()}}class Wh{constructor(e){this.icn3d=e}async vastplusAlign(e,t,i){let s=this.icn3d;s.icn3dui;let n=this,r=[],a=[];if(2!=e.length)return void console.log("VAST+ needs two input structures...");let o=e[0],l=e[1],d=[],c=[];for(let e=0,t=s.structures[o].length;e<t;++e){let t=s.structures[o][e];s.proteins.hasOwnProperty(s.firstAtomObjCls.getFirstAtomObj(s.chains[t]).serial)&&d.push(t)}for(let e=0,t=s.structures[l].length;e<t;++e){let t=s.structures[l][e];s.proteins.hasOwnProperty(s.firstAtomObjCls.getFirstAtomObj(s.chains[t]).serial)&&c.push(t)}let h={},p=0;for(let e=0,t=d.length;e<t;++e){let t=d[e];for(let s=0,n=c.length;s<n;++s){let n=c[s];if(e==s){let d=this.setAlignment(o,l,t,n,i);r.push(d),a.push(t+","+n),h[p]=[e,s],++p}}}for(let e=0,t=d.length;e<t;++e){let t=d[e];for(let s=0,n=c.length;s<n;++s){let n=c[s];if(e!=s){let d=this.setAlignment(o,l,t,n,i);r.push(d),a.push(t+","+n),h[p]=[e,s],++p}}}let u=Promise.allSettled(r);try{let e=await u;n.clusterAlignment(e,a,h,t),s.ParserUtilsCls.hideLoading(),await s.pdbParserCls.loadPdbDataRender(!0)}catch(e){alert("There are some problems in aligning the chains...")}}setAlignment(e,t,i,s,n){let r=this.icn3d,a=r.icn3dui,o=a.htmlCls.baseUrl+"tmalign/tmalign.cgi",l=n?a.hashUtilsCls.intHash(r.hAtoms,r.chains[i]):r.chains[i],d=n?a.hashUtilsCls.intHash(r.hAtoms,r.chains[s]):r.chains[s],c=r.saveFileCls.getAtomPDB(l,void 0,void 0,void 0,void 0,e),h={pdb_query:r.saveFileCls.getAtomPDB(d,void 0,void 0,void 0,void 0,t),pdb_target:c};return a.getAjaxPostPromise(o,h)}async realignOnVastplus(){let e=this.icn3d,t=e.icn3dui,i=[];for(let s in e.structures){let n=e.structures[s];for(let s=0,r=n.length;s<r;++s){let r=n[s],a=t.hashUtilsCls.intHash(e.hAtoms,e.chains[r]),o=e.firstAtomObjCls.getFirstAtomObj(a);o&&(i[o.structure]=1)}}t.cfg.aligntool="tmalign",await e.vastplusCls.vastplusAlign(Object.keys(i),2,!0)}getResisFromSegs(e){this.icn3d.icn3dui;let t=[],i=[];for(let s=0,n=e.length;s<n;++s){let n=e[s];t.push(n.t_start+"-"+n.t_end),i.push(n.q_start+"-"+n.q_end)}return{resiArray_t:t,resiArray_q:i}}clusterAlignment(e,t,i,s){let n=this.icn3d,r=n.icn3dui,a=[];for(let i=0,s=t.length;i<s;++i){let t=e[i].value;a.push(t)}let o=[],l=0,d=!1;for(let e=0,i=t.length;e<i;++e){let i=[];a[e].length>0&&(d=!0);for(let n=0,r=t.length;n<r;++n){let t=this.RotMatrixTransDist(a[e][0],a[n][0],1,s),r=e==n?0:0==a[e].length||0==a[n].length?1:t;r>l&&(l=r),i.push(r)}o.push(i)}if(!d)return void(n.bRender&&alert("These structures can not be aligned..."));l<1e-6&&(l=1);for(let e=0,i=t.length;e<i;++e)for(let i=0,s=t.length;i<s;++i)o[e][i]=o[e][i]/l;let c=this.clusterLinkage(1,o,!1),h=this.GetChainMappings(c,t),p={};for(let e=0,t=h.length;e<t;++e){let t=h[e].nodeArray,s=t.join(","),n=i[parseInt(t[0])],r=o[n[0]][n[1]];p[s]?r<p[s]&&(p[s]=r):p[s]=r}let u=Object.keys(p).sort(((e,t)=>p[e]<p[t]||parseInt(1e4*p[e])==parseInt(1e4*p[t])&&e<t?-1:1)),m=parseInt($("#"+r.pre+"maxrmsd").val());m||(m=30),d=!1;for(let e=0,i=u.length;e<i;++e){let i=u[e].split(",");n.opts.color="grey",n.setColorCls.setColorByOptions(n.opts,n.atoms);let s,o,l=[],c=[],h={};$("#"+n.pre+"dl_sequence2").html("");for(let e=0,d=i.length;e<d;++e){let d=parseInt(i[e]),p=a[d][0].segs,u=t[d].split(",");s=u[0],o=u[1];let m=this.getResisFromSegs(p),f=m.resiArray_t,g=m.resiArray_q,b=n.realignParserCls.getSeqCoorResid(f,s);l=l.concat(b.coor);let C=n.realignParserCls.getSeqCoorResid(g,o);c=c.concat(C.coor),n.qt_start_end=[],n.qt_start_end.push(p);let v=!0,_=!0,y=n.chainalignParserCls.setMsa(u,v,_);h=r.hashUtilsCls.unionHash(h,y)}n.hAtoms=r.hashUtilsCls.cloneHash(h);let p=c.length<l.length?c.length:l.length;if(!(p<4)&&(p>=4&&(n.rmsd_suprTmp=r.rmsdSuprCls.getRmsdSuprCls(c,l,p),void 0!==n.rmsd_suprTmp.rot))){let e=n.rmsd_suprTmp.rot;if(null===e[0])continue;let s=n.rmsd_suprTmp.trans1,a=n.rmsd_suprTmp.trans2,l=n.rmsd_suprTmp.rmsd;if(l<m){d=!0,r.htmlCls.clickMenuCls.setLogCmd("realignment RMSD: "+l.toPrecision(4),!1),$("#"+n.pre+"dl_rmsd_html").html("<br><b>Realignment RMSD</b>: "+l.toPrecision(4)+" &#8491;<br><br>"),r.cfg.bSidebyside||r.htmlCls.dialogCls.openDlg("dl_rmsd","Realignment RMSD"),n.q_rotation=[],n.q_trans_sub=[],n.t_trans_add=[],n.q_rotation.push({x1:e[0],y1:e[1],z1:e[2],x2:e[3],y2:e[4],z2:e[5],x3:e[6],y3:e[7],z3:e[8]}),n.q_trans_sub.push(s),n.t_trans_add.push({x:-a.x,y:-a.y,z:-a.z}),r.cfg.aligntool="vast";//!= 'tmalign';
let c=0,h="query",p=o.substr(0,o.indexOf("_")),u=!0;n.chainalignParserCls.transformStructure(p,c,h,u);let m="";for(let e=0,s=i.length;e<s;++e)m+=t[parseInt(i[e])]+"; ";r.bNode||console.log("Selected the alignment: "+m);break}{let e="";for(let s=0,n=i.length;s<n;++s)e+=t[parseInt(i[s])]+"; ";r.bNode||console.log("skipped the alignment: "+e)}}}d||n.bRender&&alert("These structures can not be aligned...")}RotMatrixTransDist(e,t,i,s){this.icn3d.icn3dui;if(!e||!t)return i;let n=this.GetRotMatrix(e,1,s),r=this.GetRotMatrix(t,1,s),a=[],o=[],l=[],d=[];a[0]=n[9],a[1]=n[10],a[2]=n[11],o[0]=n[12],o[1]=n[13],o[2]=n[14],l[0]=r[9],l[1]=r[10],l[2]=r[11],d[0]=r[12],d[1]=r[13],d[2]=r[14];let c=[],h=[];c[0]=o[0]-d[0],c[1]=o[1]-d[1],c[2]=o[2]-d[2],h[0]=a[0]-l[0],h[1]=a[1]-l[1],h[2]=a[2]-l[2];let p,u,m=0;if(m+=Math.pow(c[0],2),m+=Math.pow(c[1],2),m+=Math.pow(c[2],2),p=Math.sqrt(m),m=0,m+=Math.pow(h[0],2),m+=Math.pow(h[1],2),m+=Math.pow(h[2],2),u=Math.sqrt(m),2!=s){if(p<1e-10||u<1e-10)return i}else if(u<1e-10)return i;if(Math.abs(p-u)>8)return i;let f=[];f[0]=n[0]*a[0]+n[1]*a[1]+n[2]*a[2],f[1]=n[3]*a[0]+n[4]*a[1]+n[5]*a[2],f[2]=n[6]*a[0]+n[7]*a[1]+n[8]*a[2],f[0]-=n[0]*l[0]+n[1]*l[1]+n[2]*l[2],f[1]-=n[3]*l[0]+n[4]*l[1]+n[5]*l[2],f[2]-=n[6]*l[0]+n[7]*l[1]+n[8]*l[2];let g=0;return g=c[0]*f[0],g+=c[1]*f[1],g+=c[2]*f[2],g/=p*u,g<.866?i:(f[0]=r[0]*a[0]+r[1]*a[1]+r[2]*a[2],f[1]=r[3]*a[0]+r[4]*a[1]+r[5]*a[2],f[2]=r[6]*a[0]+r[7]*a[1]+r[8]*a[2],f[0]-=r[0]*l[0]+r[1]*l[1]+r[2]*l[2],f[1]-=r[3]*l[0]+r[4]*l[1]+r[5]*l[2],f[2]-=r[6]*l[0]+r[7]*l[1]+r[8]*l[2],g=c[0]*f[0],g+=c[1]*f[1],g+=c[2]*f[2],g/=p*u,g<.866?i:(m=0,m+=Math.pow(e.q_rotation.x1-t.q_rotation.x1,2),m+=Math.pow(e.q_rotation.y1-t.q_rotation.y1,2),m+=Math.pow(e.q_rotation.z1-t.q_rotation.z1,2),m+=Math.pow(e.q_rotation.x2-t.q_rotation.x2,2),m+=Math.pow(e.q_rotation.y2-t.q_rotation.y2,2),m+=Math.pow(e.q_rotation.z2-t.q_rotation.z2,2),m+=Math.pow(e.q_rotation.x3-t.q_rotation.x3,2),m+=Math.pow(e.q_rotation.y3-t.q_rotation.y3,2),m+=Math.pow(e.q_rotation.z3-t.q_rotation.z3,2),Math.sqrt(m)))}GetRotMatrix(e,t,i){this.icn3d.icn3dui;let s=[];return s&&(s[0]=e.q_rotation.x1/t,s[1]=e.q_rotation.y1/t,s[2]=e.q_rotation.z1/t,s[3]=e.q_rotation.x2/t,s[4]=e.q_rotation.y2/t,s[5]=e.q_rotation.z2/t,s[6]=e.q_rotation.x3/t,s[7]=e.q_rotation.y3/t,s[8]=e.q_rotation.z3/t,2!=i?(s[9]=e.t_trans_add.x/t,s[10]=e.t_trans_add.y/t,s[11]=e.t_trans_add.z/t,s[12]=-e.q_trans_sub.x/t,s[13]=-e.q_trans_sub.y/t,s[14]=-e.q_trans_sub.z/t):(s[9]=-e.q_trans_add.x/t,s[10]=-e.q_trans_add.y/t,s[11]=-e.q_trans_add.z/t,s[12]=0,s[13]=0,s[14]=0)),s}cbu_dist(e,t,i){return e<t?i[e][t]:i[t][e]}compareFloat(e,t,i){let s=e[t].dist,n=e[i].dist;return parseInt(1e4*s)==parseInt(1e4*n)?0:parseInt(1e4*s)<parseInt(1e4*n)?-1:1}clusterLinkage(e,t,i){let s,n,r,a,o,l,d,c,h=this.icn3d,p=h.icn3dui,u=[],m=t.length;for(s=0;s<2*m-1;++s)u[s]={},u[s].leaves=[];let f=[];for(s=0;s<2*m-1;++s)for(f[s]=[],n=0;n<2*m-1;++n)f[s][n]=2;for(s=0;s<m;++s)for(n=s;n<m;++n)f[s][n]=t[s][n];let g={},b={},C={};for(a=m,o=m,s=0;s<m;++s){for(d=2,n=0;n<m;++n){let e=i?parseInt(1e4*this.cbu_dist(s,n,f))<=parseInt(1e4*d):parseInt(1e4*this.cbu_dist(s,n,f))<parseInt(1e4*d);n!=s&&e&&(d=this.cbu_dist(s,n,f),a=s,o=n)}g[a]=o,C[a]=d}let v=[];for(l=0;l<m;++l)u[l].child1=-2,u[l].child2=-2,u[l].parent=l,u[l].dist=0,u[l].leaves.push([l]),v[l]=0;let _=Object.keys(h.structures),y=h.structures[_[0]].length,S=h.structures[_[1]].length,w=y<S?y:S;for(l=m;l<2*m-1;++l){for(r in d=2,g)c=C[r],c<d&&(d=c,a=r,o=g[r]);let e=d;for(u[l].child1=a<m?a:-a,u[l].child2=o<m?o:-o,u[l].parent=-1*l,u[a].dist=e-v[a],u[o].dist=e-v[o],v[l]=e,n=0;n<2*m-1;++n){let e=this.cbu_dist(a,n,f),t=this.cbu_dist(o,n,f);l<n?f[l][n]=e<t?e:t:f[n][l]=e<t?e:t}for(n=0;n<2*m-1;++n)a<n?f[a][n]=2:f[n][a]=2,o<n?f[o][n]=2:f[n][o]=2;let t=4;if(u[a].leaves.length<t*w&&u[o].leaves.length<t*w){u[l].leaves=[];for(let e=0,t=u[a].leaves.length;e<t;++e)for(let t=0,i=u[o].leaves.length;t<i;++t)u[l].leaves.push(u[a].leaves[e].concat(u[o].leaves[t])),u[l].leaves.push(u[o].leaves[t].concat(u[a].leaves[e]));u[a].leaves=[],u[o].leaves=[]}for(r in delete g[a],delete g[o],delete C[a],delete C[o],b=p.hashUtilsCls.cloneHash(g),b)b[r]!=a&&b[r]!=o||(delete g[r],g[r]=l);let i=2*m;for(d=2,n=0;n<2*m-1;++n)n!=l&&this.cbu_dist(l,n,f)<d&&(d=this.cbu_dist(l,n,f),i=n);g[l]=i,C[l]=d}return l==2*m-1&&(u[l-1].parent=-1,u[l-1].dist=0),u}GetChainMappings(e,t){this.icn3d.icn3dui;let i,s,n=[];t.length;let r=this.getClusters(e,!0).clusters,a=r.length;for(let e=0;e<a;++e){let a=r[e];for(let e=0,r=a.length;e<r;++e){let r={nodeArray:[]},o={},l={};for(let n=0,d=a[e].length;n<d;++n){let d=a[e][n],c=t[d].split(",");i=c[0],s=c[1],o.hasOwnProperty(i)||l.hasOwnProperty(s)||(r.nodeArray.push(d.toString().padStart(5,"0")),o[i]=1,l[s]=1)}n.push(r)}}return n}getClusters(e,t){this.icn3d.icn3dui;let i=[],s=[],n=0,r=e.length,a=t?0:1;for(;n<r;++n)e[n].leaves.length>a&&(i.push(e[n].leaves),s.push(e[n].dist));return{clusters:i,scores:s}}}class Xh{constructor(e){this.icn3d=e}async applyCommand(e){let t=this.icn3d,i=t.icn3dui;t.bAddCommands=!1;let s=e.split("|||")[0].split("%7C%7C%7C")[0].replace(/\s+/g," ").trim(),n=s.toLowerCase();if("share link"==n)await t.shareLinkCls.shareLink();else if("export state file"==n);else if(0==n.indexOf("export canvas"))setTimeout((async function(){let e=n.substr(13).trim();t.scaleFactor=""===e?1:parseInt(e);let i=""!==e;await t.shareLinkCls.shareLink(!0,i)}),500);else if("export interactions"==n)t.viewInterPairsCls.exportInteractions();else if("export stl file"==n)setTimeout((function(){t.export3DCls.exportStlFile("")}),500);else if("export vrml file"==n)setTimeout((function(){t.export3DCls.exportVrmlFile("")}),500);else if("export stl stabilizer file"==n)setTimeout((function(){t.threeDPrintCls.hideStabilizer(),t.threeDPrintCls.resetAfter3Dprint(),t.threeDPrintCls.addStabilizer(),t.export3DCls.exportStlFile("_stab")}),500);else if("export vrml stabilizer file"==n)setTimeout((function(){t.threeDPrintCls.hideStabilizer(),t.threeDPrintCls.resetAfter3Dprint(),t.threeDPrintCls.addStabilizer(),t.export3DCls.exportVrmlFile("_stab")}),500);else if("export pdb"==n)i.htmlCls.setHtmlCls.exportPdb();else if("export pdb missing atoms"==n)await t.scapCls.exportPdbProfix(!1);else if("export pdb hydrogen"==n)await t.scapCls.exportPdbProfix(!0);else if(-1!=n.indexOf("export refnum ")){let e=n.substr(14);t.refnumCls.exportRefnum(e)}else if("export secondary structure"==n)i.htmlCls.setHtmlCls.exportSecondary();else if("select all"==n)t.selectionCls.selectAll();else if("show all"==n)t.selectionCls.showAll();else if("select complement"==n)t.resid2specCls.selectComplement();else if("set pk atom"==n)t.pk=1,t.opts.pk="atom";else if("set pk off"==n)t.pk=0,t.opts.pk="no",t.drawCls.draw(),t.hlObjectsCls.removeHlObjects();else if("set pk residue"==n)t.pk=2,t.opts.pk="residue";else if("set pk strand"==n)t.pk=3,t.opts.pk="strand";else if("set pk domain"==n)t.pk=4,t.opts.pk="domain";else if("set pk chain"==n)t.pk=5,t.opts.pk="chain";else if("set surface wireframe on"==n)t.opts.wireframe="yes",t.applyMapCls.applySurfaceOptions();else if("set surface wireframe off"==n)t.opts.wireframe="no",t.applyMapCls.applySurfaceOptions();else if("set map wireframe on"==n)t.opts.mapwireframe="yes",t.applyMapCls.applyMapOptions();else if("set map wireframe off"==n)t.opts.mapwireframe="no",t.applyMapCls.applyMapOptions();else if("set emmap wireframe on"==n)t.opts.emmapwireframe="yes",t.applyMapCls.applyEmmapOptions();else if("set emmap wireframe off"==n)t.opts.emmapwireframe="no",t.applyMapCls.applyEmmapOptions();else if("set surface neighbors on"==n)t.bConsiderNeighbors=!0,t.applyMapCls.applySurfaceOptions();else if("set surface neighbors off"==n)t.bConsiderNeighbors=!1,t.applyMapCls.applySurfaceOptions();else if("set axis on"==n)t.opts.axis="yes";else if("set pc1 axis"==n)t.pc1=!0,t.axesCls.setPc1Axes();else if("set axis off"==n)t.opts.axis="no",t.pc1=!1;else if("set fog on"==n)t.opts.fog="yes",t.fogCls.setFog(!0);else if("set fog off"==n)t.opts.fog="no",t.fogCls.setFog(!0);else if("set slab on"==n)t.opts.slab="yes";else if("set slab off"==n)t.opts.slab="no";else if("stereo on"==n)t.opts.effect="stereo";else if("stereo off"==n)t.opts.effect="none";else if("set assembly on"==n)t.bAssembly=!0;else if("set assembly off"==n)t.bAssembly=!1;else if("set chemicalbinding show"==n)t.setOptionCls.setOption("chemicalbinding","show");else if("set chemicalbinding hide"==n)t.setOptionCls.setOption("chemicalbinding","hide");else if("set hbonds off"==n)t.hBondCls.hideHbonds(),t.showInterCls.hideExtraBonds(),t.drawCls.draw();else if("set salt bridge off"==n)t.saltbridgeCls.hideSaltbridge(),t.showInterCls.hideExtraBonds(),t.drawCls.draw();else if("set contact off"==n)t.contactCls.hideContact(),t.showInterCls.hideExtraBonds(),t.drawCls.draw();else if("set halogen pi off"==n)t.piHalogenCls.hideHalogenPi(),t.showInterCls.hideExtraBonds(),t.drawCls.draw();else if("hydrogens"==n)t.showInterCls.showHydrogens(),t.drawCls.draw();else if("set hydrogens off"==n)t.showInterCls.hideHydrogens(),t.drawCls.draw();else if("close popup"==n)t.resizeCanvasCls.closeDialogs();else if("set stabilizer off"==n)t.threeDPrintCls.hideStabilizer(),t.drawCls.draw();else if("set disulfide bonds off"==n)t.opts.ssbonds="no",t.drawCls.draw();else if("set cross linkage off"==n)t.opts.clbonds="no",t.drawCls.draw();else if("set lines off"==n)t.labels.distance=[],t.lines.distance=[],t.drawCls.draw();else if("set labels off"==n){for(let e in t.labels)t.labels[e]=[];t.drawCls.draw()}else if("set mode all"==n)t.definedSetsCls.setModeAndDisplay("all");else if("set mode selection"==n)t.definedSetsCls.setModeAndDisplay("selection");else if("set view detailed view"==n)t.annotationCls.setAnnoViewAndDisplay("detailed view");else if("set view overview"==n)t.annotationCls.setAnnoViewAndDisplay("overview");else if("set annotation custom"==n)t.annotationCls.setAnnoTabCustom();else if("set annotation interaction"==n)t.annotationCls.setAnnoTabInteraction();else if("set annotation ptm"==n)await t.annotationCls.setAnnoTabPTM();else if("set annotation cdd"==n)t.annotationCls.setAnnoTabCdd();else if("set annotation site"==n)t.annotationCls.setAnnoTabSite();else if("set annotation ssbond"==n)t.annotationCls.setAnnoTabSsbond();else if("set annotation crosslink"==n)t.annotationCls.setAnnoTabCrosslink();else if("set annotation transmembrane"==n)await t.annotationCls.setAnnoTabTransmem();else if("set annotation ig"==n)t.bRunRefnumAgain=!0,await t.annotationCls.setAnnoTabIg(),t.bRunRefnumAgain=!1;else if("ig refnum on"==n)t.bRunRefnumAgain=!0,t.bAnnoShown||await t.showAnnoCls.showAnnotations(),await t.annotationCls.setAnnoTabIg(!0),t.bRunRefnumAgain=!1;else if("highlight level up"==n)t.resid2specCls.switchHighlightLevelUp();else if("highlight level down"==n)t.resid2specCls.switchHighlightLevelDown();else if(0==n.indexOf("hide annotation")){let e=n.lastIndexOf(" "),i=n.substr(e+1);"all"==i?t.annotationCls.hideAnnoTabAll():"custom"==i?t.annotationCls.hideAnnoTabCustom():"clinvar"==i?t.annotationCls.hideAnnoTabClinvar():"snp"==i?t.annotationCls.hideAnnoTabSnp():"cdd"==i?t.annotationCls.hideAnnoTabCdd():"3ddomain"==i?t.annotationCls.hideAnnoTab3ddomain():"site"==i?t.annotationCls.hideAnnoTabSite():"ptm"==i?t.annotationCls.hideAnnoTabPTM():"interaction"==i?t.annotationCls.hideAnnoTabInteraction():"ssbond"==i?t.annotationCls.hideAnnoTabSsbond():"crosslink"==i?t.annotationCls.hideAnnoTabCrosslink():"transmembrane"==i&&t.annotationCls.hideAnnoTabTransmem()}else if("add residue labels"==n)t.residueLabelsCls.addResidueLabels(t.hAtoms),t.drawCls.draw();else if("add residue number labels"==n)t.residueLabelsCls.addResidueLabels(t.hAtoms,void 0,void 0,!0),t.drawCls.draw();else if("add reference number labels"==n)t.residueLabelsCls.addResidueLabels(t.hAtoms,void 0,void 0,void 0,!0),t.drawCls.draw();else if("add ig labels"==n)t.residueLabelsCls.addIgLabels(t.hAtoms),t.drawCls.draw();else if("add atom labels"==n)t.residueLabelsCls.addAtomLabels(t.hAtoms),t.drawCls.draw();else if("add element labels"==n)t.residueLabelsCls.addAtomLabels(t.hAtoms,!0),t.drawCls.draw();else if("add chain labels"==n)t.analysisCls.addChainLabels(t.hAtoms),t.drawCls.draw();else if("add terminal labels"==n)t.analysisCls.addTerminiLabels(t.hAtoms),t.drawCls.draw();else if("rotate left"==n)t.bStopRotate=!1,t.ROT_DIR="left",t.transformCls.rotateCountMax=6e3,t.resizeCanvasCls.rotStruc("left");else if("rotate right"==n)t.bStopRotate=!1,t.ROT_DIR="right",t.transformCls.rotateCountMax=6e3,t.resizeCanvasCls.rotStruc("right");else if("rotate up"==n)t.bStopRotate=!1,t.ROT_DIR="up",t.transformCls.rotateCountMax=6e3,t.resizeCanvasCls.rotStruc("up");else if("rotate down"==n)t.bStopRotate=!1,t.ROT_DIR="down",t.transformCls.rotateCountMax=6e3,t.resizeCanvasCls.rotStruc("down");else if("rotate x"==n){let e=new mt(1,0,0),i=.5*Math.PI;t.transformCls.setRotation(e,i)}else if("rotate y"==n){let e=new mt(0,1,0),i=.5*Math.PI;t.transformCls.setRotation(e,i)}else if("rotate z"==n){let e=new mt(0,0,1),i=.5*Math.PI;t.transformCls.setRotation(e,i)}else if("reset"===n)t.selectionCls.resetAll();else if("reset orientation"===n)t.transformCls.resetOrientation(),t.drawCls.draw();else if("reset thickness"==n)t.threeDPrintCls.resetAfter3Dprint(),t.drawCls.draw();else if("clear selection"==n)t.hlObjectsCls.removeHlObjects(),t.hlUpdateCls.removeHl2D(),t.bSelectResidue=!1;else if("zoom selection"==n)t.transformCls.zoominSelection(),t.drawCls.draw();else if("center selection"==n)t.applyCenterCls.centerSelection(),t.drawCls.draw();else if("show selection"==n)t.selectionCls.showSelection();else if("hide selection"==n)t.selectionCls.hideSelection();else if("output selection"==n)t.threeDPrintCls.outputSelection();else if("toggle selection"==n)t.selectionCls.toggleSelection();else if("toggle highlight"==n)t.hlUpdateCls.toggleHighlight();else if("stabilizer"==n)t.threeDPrintCls.addStabilizer(),t.threeDPrintCls.prepareFor3Dprint();else if("disulfide bonds"==n)t.showInterCls.showSsbonds();else if("cross linkage"==n)t.showInterCls.showClbonds();else if("back"==n)await t.resizeCanvasCls.back();else if("forward"==n)await t.resizeCanvasCls.forward();else if("clear all"==n)t.selectionCls.selectAll();else if("defined sets"==n)t.definedSetsCls.showSets(),t.bDefinedSets=!0;else if("delete selected sets"==n)t.definedSetsCls.deleteSelectedSets();else if("view interactions"==n)void 0===i.cfg.mmdbid&&void 0===i.cfg.gi||t.ParserUtilsCls.set2DDiagrams(t.inputid);else if("show annotations all chains"==n)t.annotationCls.showAnnoAllChains();else if("save color"==n)t.setOptionCls.saveColor();else if("apply saved color"==n)t.setOptionCls.applySavedColor();else if("save style"==n)t.setOptionCls.saveStyle();else if("apply saved style"==n)t.setOptionCls.applySavedStyle();else if("select main chains"==n)t.selectionCls.selectMainChains();else if("select side chains"==n)t.selectionCls.selectSideChains();else if("select main side chains"==n)t.selectionCls.selectMainSideChains();else if("realign"==n)t.realignParserCls.realign();else if(-1!=n.indexOf("realign predefined ")){let e="realign predefined ",n=s.substr(e.length),r=n.indexOf(" "),a=n.substr(0,r).split(",");i.cfg.resdef=n.substr(r+1).replace(/:/gi,";"),await t.realignParserCls.realignChainOnSeqAlign(void 0,a,!0,!0)}else if("area"==n)t.analysisCls.calculateArea();else if("table inter count only"==n)$(".icn3d-border").hide();else if("table inter details"==n)$(".icn3d-border").show();else if("setoption map nothing"==n)t.setOptionCls.setOption("map","nothing");else if("setoption emmap nothing"==n)t.setOptionCls.setOption("emmap","nothing");else if("setoption phimap nothing"==n)t.setOptionCls.setOption("phimap","nothing");else if("setoption phisurface nothing"==n)t.setOptionCls.setOption("phisurface","nothing");else if("clear symd symmetry"==n)t.symdArray=[];else if("show axis"==n)t.bAxisOnly=!0;else if(0==s.indexOf("define helix sets")){let e=s.split(" | ")[1].split(" ")[1];t.addTrackCls.defineSecondary(e,"helix")}else if(0==s.indexOf("define sheet sets")){let e=s.split(" | ")[1].split(" ")[1];t.addTrackCls.defineSecondary(e,"sheet")}else if(0==s.indexOf("define coil sets")){let e=s.split(" | ")[1].split(" ")[1];t.addTrackCls.defineSecondary(e,"coil")}else if(0==s.indexOf("define iganchor sets")){let e=s.split(" | ")[1].split(" ")[1];t.addTrackCls.defineIgstrand(e,"iganchor")}else if(0==s.indexOf("define igstrand sets")){let e=s.split(" | ")[1].split(" ")[1];t.addTrackCls.defineIgstrand(e,"igstrand")}else if(0==s.indexOf("define igloop sets")){let e=s.split(" | ")[1].split(" ")[1];t.addTrackCls.defineIgstrand(e,"igloop")}else if(0==s.indexOf("select interaction")){let e=s.substr(s.lastIndexOf(" ")+1).split(",");if(null!==e){let i=e[0].split("_")[0];t.b2DShown||t.ParserUtilsCls.download2Ddgm(i.toUpperCase()),t.diagram2dCls.selectInteraction(e[0],e[1])}}else if(0==s.indexOf("select saved atoms")||0==s.indexOf("select sets")){s=s.replace(/aligned_protein/g,"protein_aligned"),t.bDefinedSets||(t.definedSetsCls.setPredefinedInMenu(),t.bDefinedSets=!0);let e=s.split(" | "),i=e[0].replace(/,/g," or "),n=19;0==s.indexOf("select sets")&&(n=12);let r=i.substr(n),a=r;2==e.length&&(a=e[1].substr(5)),t.definedSetsCls.selectCombinedSets(r,a)}else if(-1!==s.indexOf("select chain")){let e=s.substr(s.lastIndexOf(" ")+1).split(",");for(let i=0,s=e.length;i<s;++i)t.selectionCls.selectAChain(e[i],e[i],!1)}else if(-1!==s.indexOf("select alignChain")){let e=s.substr(s.lastIndexOf(" ")+1).split(",");for(let i=0,s=e.length;i<s;++i)t.selectionCls.selectAChain(e[i],"align_"+e[i],!0)}else if(0==s.indexOf("select zone cutoff")){let e=this.getThresholdNameArrays(s);t.showInterCls.pickCustomSphere(e.threshold,e.nameArray2,e.nameArray,e.bHbondCalc),t.bSphereCalc=!0}else if(0==n.indexOf("set surface opacity")){t.transparentRenderOrder=!1;let e=n.substr(n.lastIndexOf(" ")+1);t.opts.opacity=parseFloat(e),t.applyMapCls.applySurfaceOptions(),parseInt(100*e)<100&&(t.bTransparentSurface=!0)}else if(0==n.indexOf("set surface2 opacity")){t.transparentRenderOrder=!0;let e=n.substr(n.lastIndexOf(" ")+1);t.opts.opacity=parseFloat(e),t.applyMapCls.applySurfaceOptions(),parseInt(100*e)<100&&(t.bTransparentSurface=!0)}else if(0==n.indexOf("set label scale")){let e=n.substr(n.lastIndexOf(" ")+1);t.labelScale=parseFloat(e)}else if(0==n.indexOf("set surface")){let e=n.substr(12);t.opts.surface=e,t.applyMapCls.applySurfaceOptions()}else if(0==n.indexOf("set camera")){let e=n.substr(n.lastIndexOf(" ")+1);t.opts.camera=e}else if(0==n.indexOf("set background")){let e=n.substr(n.lastIndexOf(" ")+1);t.opts.background=e,"black"==e?($("#"+t.pre+"title").css("color",i.htmlCls.GREYD),$("#"+t.pre+"titlelink").css("color",i.htmlCls.GREYD)):($("#"+t.pre+"title").css("color","black"),$("#"+t.pre+"titlelink").css("color","black"))}else if(0==n.indexOf("set label color"))t.labelcolor=n.substr(n.lastIndexOf(" ")+1);else if(0==s.indexOf("set thickness")){let e=n.split(" | ");t.bSetThickness=!0;for(let i=1,s=e.length;i<s;++i){let s=e[i].split(" "),n=s[0],r=parseFloat(s[1]);"linerad"!=n||isNaN(r)||(t.lineRadius=r),"coilrad"!=n||isNaN(r)||(t.coilWidth=r),"stickrad"!=n||isNaN(r)||(t.cylinderRadius=r),"crosslinkrad"!=n||isNaN(r)||(t.crosslinkRadius=r),"tracerad"!=n||isNaN(r)||(t.traceRadius=r),"ballscale"!=n||isNaN(r)||(t.dotSphereScale=r),"ribbonthick"!=n||isNaN(r)||(t.ribbonthickness=r),"proteinwidth"!=n||isNaN(r)||(t.helixSheetWidth=r),"nucleotidewidth"!=n||isNaN(r)||(t.nucleicAcidWidth=r)}t.drawCls.draw()}else if(0==s.indexOf("set light")){let e=n.split(" | ");for(let i=1,s=e.length;i<s;++i){let s=e[i].split(" "),n=s[0],r=parseFloat(s[1]);"light1"==n&&(t.light1=r),"light2"==n&&(t.light2=r),"light3"==n&&(t.light3=r)}t.drawCls.draw()}else if(0==s.indexOf("set shininess")){let e=n.lastIndexOf(" ");t.shininess=parseFloat(n.substr(e+1)),t.drawCls.draw()}else if(0==s.indexOf("set glycan")){let e=n.lastIndexOf(" ");t.bGlycansCartoon=parseInt(n.substr(e+1)),t.drawCls.draw()}else if(0==s.indexOf("set membrane")){let e=n.lastIndexOf(" ");t.bMembrane=parseInt(n.substr(e+1)),t.drawCls.draw()}else if(0==s.indexOf("set cmdwindow")){let e=n.lastIndexOf(" "),t=parseInt(n.substr(e+1));i.htmlCls.setMenuCls.setLogWindow(!0,t)}else if(0==n.indexOf("set highlight color")){let e=n.substr(20);"yellow"===e?(t.hColor=i.parasCls.thr(16776960),t.matShader=t.setColorCls.setOutlineColor("yellow")):"green"===e?(t.hColor=i.parasCls.thr(65280),t.matShader=t.setColorCls.setOutlineColor("green")):"red"===e&&(t.hColor=i.parasCls.thr(16711680),t.matShader=t.setColorCls.setOutlineColor("red")),t.drawCls.draw()}else if(0==n.indexOf("set highlight style")){let e=n.substr(20);"outline"===e?t.bHighlight=1:"3d"===e&&(t.bHighlight=2),t.drawCls.draw()}else if(0==n.indexOf("add line")){let e=n.split(" | "),i=e[1].split(" "),s=e[2].split(" "),r=e[3].substr(e[3].lastIndexOf(" ")+1),a="true"===e[4].substr(e[4].lastIndexOf(" ")+1),o=e[5].substr(e[5].lastIndexOf(" ")+1),l=e.length>6?e[6].substr(e[6].lastIndexOf(" ")+1):0,d=e.length>7?e[7].substr(e[7].lastIndexOf(" ")+1):1;t.analysisCls.addLine(parseFloat(i[1]),parseFloat(i[3]),parseFloat(i[5]),parseFloat(s[1]),parseFloat(s[3]),parseFloat(s[5]),r,a,o,parseFloat(l),parseFloat(d)),t.drawCls.draw()}else if(0==n.indexOf("add sphere"))this.addShape(s,"sphere"),t.shapeCmdHash[s]=1;else if(0==n.indexOf("add cube"))this.addShape(s,"cube"),t.shapeCmdHash[s]=1;else if(0==n.indexOf("clear shape"))t.shapeCmdHash={};else if(0==n.indexOf("clear line between sets"))t.lines.cylinder=[];else if(0==s.indexOf("add label")){let e,n,r,a,o,l,d,c=s.split(" | "),h=c[0].substr(10),p=!1;for(let t=1,i=c.length;t<i;++t){let i=c[t].split(" ");"x"==i[0]?(p=!0,e=parseFloat(i[1]),n=parseFloat(i[3]),r=parseFloat(i[5])):"size"==i[0]?a=c[t].substr(c[t].lastIndexOf(" ")+1):"color"==i[0]?o=c[t].substr(c[t].lastIndexOf(" ")+1):"background"==i[0]?l=c[t].substr(c[t].lastIndexOf(" ")+1):"type"==i[0]&&(d=c[t].substr(c[t].lastIndexOf(" ")+1))}if(!p){let s=t.applyCenterCls.centerAtoms(i.hashUtilsCls.hash2Atoms(t.hAtoms,t.atoms));e=parseFloat(s.center.x),n=parseFloat(s.center.y),r=parseFloat(s.center.z)}t.analysisCls.addLabel(h,e,n,r,a,o,l,d),t.drawCls.draw()}else if(0==s.indexOf("msa")){let e=s.split(" | ")[1].split(" ");t.targetGapHash={};for(let i=0,s=e.length;i<s;++i){let s=e[i].split("_");t.targetGapHash[parseInt(s[0])]={from:parseInt(s[1]),to:parseInt(s[2])}}await t.annotationCls.resetAnnoAll()}else if(0==s.indexOf("add track")){let e,i,n,r=s.split(" | "),a=r[1].substr(8),o=r[2].substr(6),l=r[3].substr(5);r.length>=5&&(e=r[4].substr(5)),r.length>=6&&(i=r[5].substr(6)),r.length>=7&&(n=r[6].substr(4)),$("#"+t.pre+"anno_custom")[0]&&($("#"+t.pre+"anno_custom")[0].checked=!0),$("[id^="+t.pre+"custom]").show(),"0"==i&&(i=void 0),t.addTrackCls.checkGiSeq(a,o,l,e,i,n,0)}else if(0==n.indexOf("remove one stabilizer")){let e=n.split(" | ")[1].split(" "),i=[];i.push(parseInt(e[0])),i.push(parseInt(e[1])),t.threeDPrintCls.removeOneStabilizer(i),t.drawCls.draw()}else if(0==n.indexOf("add one stabilizer")){let e=n.split(" | ")[1].split(" ");void 0===t.pairArray&&(t.pairArray=[]),t.pairArray.push(parseInt(e[0])),t.pairArray.push(parseInt(e[1])),t.drawCls.draw()}else if(0==n.indexOf("select planes z-axis")){let e=n.split(" ");if(5==e.length){let i=parseFloat(e[3]),s=parseFloat(e[4]);t.selectionCls.selectBtwPlanes(i,s)}}else if(0==n.indexOf("adjust membrane z-axis")){let e=n.split(" ");if(5==e.length){let i=parseFloat(e[3]),s=parseFloat(e[4]);t.selectionCls.adjustMembrane(i,s)}}else if(0==n.indexOf("toggle membrane"))t.selectionCls.toggleMembrane();else if(0==s.indexOf("calc buried surface")){let e=s.split(" | ");if(2==e.length){let i=e[1].split(" ");if(2==i.length){let e=i[0].split(","),s=i[1].split(",");t.analysisCls.calcBuriedSurface(e,s)}}}else if(0==s.indexOf("dist ")){let e=s.split(" | ");if(2==e.length){let i=e[1].split(" ");if(2==i.length){let e=i[0].split(","),s=i[1].split(",");t.analysisCls.measureDistTwoSets(e,s)}}}else if(0==s.indexOf("disttable")){let e=s.split(" | ");if(2==e.length){let s=e[1].split(" ");if(2==s.length){let e=s[0].split(","),n=s[1].split(",");t.analysisCls.measureDistManySets(e,n),i.htmlCls.dialogCls.openDlg("dl_disttable","Distances among the sets")}}}else if(0==s.indexOf("angletable")){let e=s.split(" | ");if(2==e.length){let s=e[1].split(" ");if(2==s.length){let e=s[0].split(","),n=s[1].split(",");t.analysisCls.measureAngleManySets(e,n),i.htmlCls.dialogCls.openDlg("dl_angletable","Angles among the sets")}}}else if(0==s.indexOf("display interaction 3d")||0==s.indexOf("view interaction pairs")||0==s.indexOf("save1 interaction pairs")||0==s.indexOf("save2 interaction pairs")||0==s.indexOf("line graph interaction pairs")||0==s.indexOf("scatterplot interaction pairs")||0==s.indexOf("ligplot interaction pairs")){let e=s.split(" | ");if(e.length>=3){let i=e[1].split(" ");if(2==i.length){let n,r,a=i[0].split(","),o=i[1].split(","),l=-1!==e[2].indexOf("hbonds"),d=-1!==e[2].indexOf("salt bridge"),c=-1!==e[2].indexOf("interactions"),h=-1!==e[2].indexOf("halogen"),p=-1!==e[2].indexOf("pi-cation"),u=-1!==e[2].indexOf("pi-stacking");if(e.length>=4&&(n="true"==e[3]),e.length>=5){let i=e[4].split(" ");i.length>=4&&($("#"+t.pre+"hbondthreshold").val(i[1]),$("#"+t.pre+"saltbridgethreshold").val(i[2]),$("#"+t.pre+"contactthreshold").val(i[3]),7==i.length&&($("#"+t.pre+"halogenthreshold").val(i[4]),$("#"+t.pre+"picationthreshold").val(i[5]),$("#"+t.pre+"pistackingthreshold").val(i[6])))}0==s.indexOf("display interaction 3d")?r="3d":0==s.indexOf("view interaction pairs")?r="view":0==s.indexOf("save1 interaction pairs")?r="save1":0==s.indexOf("save2 interaction pairs")?r="save2":0==s.indexOf("line graph interaction pairs")?r="linegraph":0==s.indexOf("scatterplot interaction pairs")?r="scatterplot":0==s.indexOf("ligplot interaction pairs")&&(r="ligplot"),await t.viewInterPairsCls.viewInteractionPairs(a,o,n,r,l,d,c,h,p,u)}}}else if(0==s.indexOf("export pairs")){let e=s.split(" | ");if(3==e.length){let s=e[1].split(" ");if(2==s.length){let n=s[0].split(","),r=s[1].split(","),a=e[2].split(" ")[1];t.showInterCls.pickCustomSphere(a,n,r,t.bSphereCalc),t.bSphereCalc=!0;let o=t.viewInterPairsCls.exportSpherePairs(),l=Object.keys(i.utilsCls.getHlStructures()).join(",");t.saveFileCls.saveFile(l+"_sphere_pairs.html","html",o)}}}else if(0==n.indexOf("graph label")){let e=n.lastIndexOf(" "),t=n.substr(e+1);$("#"+i.svgid+"_label").val(t),$("#"+i.svgid+" text").removeClass(),$("#"+i.svgid+" text").addClass(t)}else if(0==n.indexOf("cartoon label")){let e=n.lastIndexOf(" "),t=n.substr(e+1);$("#"+i.svgid_ct+"_label").val(t),$("#"+i.svgid_ct+" text").removeClass(),$("#"+i.svgid_ct+" text").addClass(t)}else if(0==n.indexOf("line graph scale")){let e=n.lastIndexOf(" "),s=n.substr(e+1);$("#"+i.linegraphid+"_scale").val(s),$("#"+i.linegraphid).attr("width",(t.linegraphWidth*parseFloat(s)).toString()+"px")}else if(0==n.indexOf("scatterplot scale")){let e=n.lastIndexOf(" "),s=n.substr(e+1);$("#"+i.scatterplotid+"_scale").val(s),$("#"+i.scatterplotid).attr("width",(t.scatterplotWidth*parseFloat(s)).toString()+"px")}else if(0==n.indexOf("ligplot scale")){let e=n.lastIndexOf(" "),s=n.substr(e+1);$("#"+i.ligplotid+"_scale").val(s),t.ligplotScale=parseFloat(s),$("#"+i.ligplotid).attr("width",(t.ligplotWidth*parseFloat(s)).toString()+"px")}else if(0==n.indexOf("contactmap scale")){let e=n.lastIndexOf(" "),s=n.substr(e+1);$("#"+i.contactmapid+"_scale").val(s),$("#"+i.contactmapid).attr("width",(t.contactmapWidth*parseFloat(s)).toString()+"px")}else if(0==n.indexOf("alignerrormap scale")){let e=n.lastIndexOf(" "),s=n.substr(e+1);$("#"+i.alignerrormapid+"_scale").val(s),$("#"+i.alignerrormapid).attr("width",(t.alignerrormapWidth*parseFloat(s)).toString()+"px")}else if(0==n.indexOf("graph force")){let e=n.lastIndexOf(" ");i.htmlCls.force=parseInt(n.substr(e+1)),$("#"+i.svgid+"_force").val(i.htmlCls.force),t.getGraphCls.handleForce()}else if(0==n.indexOf("hide edges")){let e=n.lastIndexOf(" ");i.htmlCls.hideedges=parseInt(n.substr(e+1)),$("#"+i.svgid+"_hideedges").val(i.htmlCls.hideedges),i.htmlCls.hideedges?(i.htmlCls.contactInsideColor="FFF",i.htmlCls.hbondInsideColor="FFF",i.htmlCls.ionicInsideColor="FFF"):(i.htmlCls.contactInsideColor="DDD",i.htmlCls.hbondInsideColor="AFA",i.htmlCls.ionicInsideColor="8FF"),void 0!==t.graphStr&&t.bRender&&i.htmlCls.force&&t.drawGraphCls.drawGraph(t.graphStr,t.pre+"dl_graph")}else if(0==n.indexOf("reset interaction pairs"))t.viewInterPairsCls.resetInteractionPairs();else if(0==n.indexOf("side by side")){let e=n.split(" | ")[1],t="_blank";window.open(e,t)}else if(0==s.indexOf("your note")){let e=s.split(" | ");t.yournote=e[1],$("#"+t.pre+"yournote").val(t.yournote),i.cfg.shownote&&(document.title=t.yournote)}else if(0==n.indexOf("cross structure interaction"))t.crossstrucinter=parseInt(n.substr(n.lastIndexOf(" ")+1)),$("#"+t.pre+"crossstrucinter").val(t.crossstrucinter);else if("replay on"==n)await t.resizeCanvasCls.replayon();else if("replay off"==n)await t.resizeCanvasCls.replayoff();else if(0==n.indexOf("contact map")){let e=n.split(" | ");if(3===e.length){let i=parseFloat(e[1].split(" ")[1]),s=e[2].split(" ")[1];await t.contactMapCls.contactMap(i,s)}}else if(0==n.indexOf("pickatom")){let e=parseInt(n.substr(n.lastIndexOf(" ")+1));t.pAtom=t.atoms[e],t.pickingCls.showPicking(t.pAtom)}else if(0==s.indexOf("set color spectrum")){let e=s.split(" | ");if(2==e.length){let i=e[1].split(","),s=!0;t.setColorCls.setColorAcrossSets(i,s)}}else if(0==s.indexOf("set residues color spectrum")){let e=s.split(" | ");if(2==e.length){let i=e[1].split(","),s=!0;t.setColorCls.setColorBySets(i,s)}}else if(0==s.indexOf("set color rainbow")){let e=s.split(" | ");if(2==e.length){let i=e[1].split(","),s=!1;t.setColorCls.setColorAcrossSets(i,s)}}else if(0==s.indexOf("set residues color rainbow")){let e=s.split(" | ");if(2==e.length){let i=e[1].split(","),s=!1;t.setColorCls.setColorBySets(i,s)}}else if(0==s.indexOf("color")){let e=s.split(" | "),n=e[0].substr(e[0].indexOf(" ")+1);if(t.opts.color=n,"residue custom"==n&&2==e.length){t.customResidueColors=JSON.parse(e[1]);for(let e in t.customResidueColors)t.customResidueColors[e.toUpperCase()]=i.parasCls.thr("#"+t.customResidueColors[e])}else if("align custom"==n&&3==e.length){let i=e[1],s=e[2].split(", ");t.queryresi2score={},t.queryresi2score[i]={};for(let e=0,n=s.length;e<n;++e){let n=s[e].split(" ");t.queryresi2score[i][n[0]]=n[1]}}else"align custom"==n&&e.length>=4?this.setQueryresi2score(e):"area"==n&&2==e.length&&(t.midpercent=e[1],$("#"+t.pre+"midpercent").val(t.midpercent));t.setColorCls.setColorByOptions(t.opts,t.hAtoms),t.hlUpdateCls.updateHlAll()}else if(0==s.indexOf("remove legend"))$("#"+i.pre+"legend").hide();else if(0==s.indexOf("custom tube")){let e=s.split(" | ");this.setQueryresi2score(e),t.setOptionCls.setStyle("proteins","custom tube")}else if(0==n.indexOf("style")){let e=n.substr(n.indexOf(" ")+1),i=e.substr(0,e.indexOf(" ")),s=e.substr(e.indexOf(" ")+1);t.setOptionCls.setStyle(i,s)}else if(0==n.indexOf("window")){let e=n.substr(n.indexOf(" ")+1);setTimeout((function(){"aligned sequences"==e?i.htmlCls.dialogCls.openDlg("dl_alignment","Select residues in aligned sequences"):"interaction table"==e?i.htmlCls.dialogCls.openDlg("dl_allinteraction","Show interactions"):"interaction graph"==e?i.htmlCls.dialogCls.openDlg("dl_linegraph","Show interactions between two lines of residue nodes"):"interaction scatterplot"==e?i.htmlCls.dialogCls.openDlg("dl_scatterplot","Show interactions as scatterplot"):"force-directed graph"==e&&i.htmlCls.dialogCls.openDlg("dl_graph","Force-directed graph")}),1e3)}else if(0==n.indexOf("set theme")){let e=n.substr(n.lastIndexOf(" ")+1);i.htmlCls.setMenuCls.setTheme(e)}else if(0==n.indexOf("set double color")){let e=n.substr(n.lastIndexOf(" ")+1);"on"==e?(t.bDoublecolor=!0,t.setOptionCls.setStyle("proteins","ribbon")):"off"==e&&(t.bDoublecolor=!1)}else if(0==n.indexOf("adjust dialog")){let e=n.substr(n.lastIndexOf(" ")+1);t.scapCls.adjust2DWidth(e)}else if(0==n.indexOf("glycans cartoon")){let e=n.substr(n.lastIndexOf(" ")+1);t.bGlycansCartoon="yes"==e}else if(0==n.indexOf("clashed residues")){"show"==n.substr(n.lastIndexOf(" ")+1)?(t.bHideClashed=!1,t.annoDomainCls.showHideClashedResidues()):(t.bHideClashed=!0,i.htmlCls.clickMenuCls.setClashedResidues(),t.annoDomainCls.showHideClashedResidues())}else if(0==n.indexOf("save html")){let e=n.substr(n.lastIndexOf(" ")+1);i.htmlCls.eventsCls.saveHtml(e)}else if(0==n.indexOf("resdef"))i.cfg.resdef=n.substr(n.indexOf(" ")+1);else if(0==n.indexOf("vast_search_chainid")){t.chainidArray=s.substr(s.indexOf(" ")+1).split(",");let e=!0,i=!0;await t.realignParserCls.realignChainOnSeqAlign(void 0,t.chainidArray,e,i)}else if(0==n.indexOf("ig refnum off"))await t.refnumCls.hideIgRefNum();else if(0==n.indexOf("custom refnum")){let e=s.split(" | ")[1].replace(/\\n/g,"\n");await t.refnumCls.parseCustomRefFile(e)}else if(0==n.indexOf("show ref number"))t.bShownRefnum=!0;else if(0==n.indexOf("hide ref number"))t.bShownRefnum=!1;else if(0==n.indexOf("translate pdb")){let e=n.substr(14).split(" ");t.transformCls.translateCoord(t.hAtoms,parseFloat(e[0]),parseFloat(e[1]),parseFloat(e[2])),t.drawCls.draw()}else if(0==n.indexOf("rotate pdb")){let e=n.substr(11).split(","),i=[];for(let t=0,s=e.length;t<s;++t)i.push(parseFloat(e[t]));t.transformCls.rotateCoord(t.hAtoms,i),t.drawCls.draw()}else if(0==n.indexOf("set dssp sse"))await t.pdbParserCls.applyCommandDssp(),t.bResetAnno=!0,t.bAnnoShown&&(await t.showAnnoCls.showAnnotations(),t.annotationCls.resetAnnoTabAll());else if(-1!==n.indexOf("select displayed set"))t.hAtoms=i.hashUtilsCls.cloneHash(t.viewSelectionAtoms),t.hlUpdateCls.updateHlAll();else if(-1!==n.indexOf("select prop")){let e,i,n=s.split(" | "),r=n[0].substr(12);if(2==n.length){let t=n[1].split("_");e=t[0],i=t[1]}t.resid2specCls.selectProperty(r,e,i)}else if(-1!==n.indexOf("select each residue"))t.selectionCls.saveEachResiInSel();else if(0==n.indexOf("select")&&-1!==n.indexOf("name")){let e=s.split(" | "),i="",n="",r="";for(let t=0,s=e.length;t<s;++t){let s=e[t];-1!==s.indexOf("select")?i=s.substr(s.indexOf(" ")+1):-1!==s.indexOf("name")&&(n=s.substr(s.indexOf(" ")+1))}r=n,await t.selByCommCls.selectByCommand(i,n,r)}else if(-1!==n.indexOf("select $")||-1!==n.indexOf("select .")||-1!==n.indexOf("select :")||-1!==n.indexOf("select %")||-1!==n.indexOf("select @")){let e=s.split(" | "),i=e[0].substr(e[0].indexOf(" ")+1),n="",r="";e.length>1&&(n=e[1].substr(e[1].indexOf(" ")+1)),e.length>2&&(r=e[2].substr(e[2].indexOf(" ")+1)),-1!==i.indexOf(" or ")?await t.selByCommCls.selectByCommand(i,n,r):await t.selByCommCls.selectBySpec(i,n,r)}i.htmlCls.clickMenuCls.setLogCmd(s,!1),t.bAddCommands=!0}setStrengthPara(e){let t=this.icn3d;if(t.icn3dui,e.length>=5){let i=e[4].split(" ");i.length>=4&&($("#"+t.pre+"hbondthreshold").val(i[1]),$("#"+t.pre+"saltbridgethreshold").val(i[2]),$("#"+t.pre+"contactthreshold").val(i[3]),i.length>=7&&($("#"+t.pre+"halogenthreshold").val(i[4]),$("#"+t.pre+"picationthreshold").val(i[5]),$("#"+t.pre+"pistackingthreshold").val(i[6])))}if(6==e.length){let i=e[5].split(" ");i.length>=6&&($("#"+t.pre+"dist_ss").val(i[0]),$("#"+t.pre+"dist_coil").val(i[1]),$("#"+t.pre+"dist_hbond").val(i[2]),$("#"+t.pre+"dist_inter").val(i[3]),$("#"+t.pre+"dist_ssbond").val(i[4]),$("#"+t.pre+"dist_ionic").val(i[5]),9==i.length&&($("#"+t.pre+"dist_halogen").val(i[6]),$("#"+t.pre+"dist_pication").val(i[7]),$("#"+t.pre+"dist_pistacking").val(i[8])))}}getThresholdNameArrays(e){this.icn3d.icn3dui.htmlCls.clickMenuCls.SetChainsAdvancedMenu();let t,i=e.split(" | "),s=parseFloat(i[0].substr(i[0].lastIndexOf(" ")+1)),n=[],r=[];if(i.length>=2&&i[1].length>4){let e=i[1].split(" ");e.length>1&&(r=e[1].split(",")),e.length>2&&(n=e[2].split(","))}else r=["selected"],n=["non-selected"];return 3==i.length&&(t="true"==i[2]),{threshold:s,nameArray2:r,nameArray:n,bHbondCalc:t}}setQueryresi2score(e){let t=this.icn3d,i=t.icn3dui,s=e[1],n=e[2].split(" ")[1].split("_"),r=e[3];void 0===t.queryresi2score&&(t.queryresi2score={}),t.queryresi2score[s]={};let a=100/9;for(let e=parseInt(n[0]),i=0;e<=parseInt(n[1]);++e,++i)"_"!=r[i]&&(t.queryresi2score[s][e]=parseInt(r[i])*a);if(e.length>4){let s=e[4].split(" ");t.startColor=s[1],t.midColor=s[2],t.endColor=s[3];let n=i.htmlCls.clickMenuCls.setLegendHtml();$("#"+i.pre+"dl_legend_html").html(n),i.htmlCls.dialogCls.openDlg("dl_legend","Color Range")}}addShape(e,t){let i=this.icn3d,s=i.icn3dui,n=e.split(" | "),r=n[1].split(" "),a=n[2].substr(n[2].lastIndexOf(" ")+1),o=n[3].substr(n[3].lastIndexOf(" ")+1),l=n[4].substr(n[4].lastIndexOf(" ")+1);a="#"+a.replace(/\#/g,"");let d,c=s.parasCls.thr(a);if("x1"==r[0])d=new mt(parseFloat(r[1]),parseFloat(r[3]),parseFloat(r[5]));else{let e=n[1].split(","),t=i.definedSetsCls.getAtomsFromNameArray(e),s=i.contactCls.getExtent(t);d=new mt(s[2][0],s[2][1],s[2][2])}"sphere"==t?i.sphereCls.createSphereBase(d,c,parseFloat(l),void 0,void 0,void 0,parseFloat(o)):i.boxCls.createBox_base(d,parseFloat(l),c,void 0,void 0,void 0,parseFloat(o))}getMenuFromCmd(e){this.icn3d.icn3dui;let t="Windows > View Sequences & Annotations",i="Analysis > Interactions",s=i+" > 2D Graph(Force-Directed)",n="View > Rotate > Auto Rotation > Rotate ",r="View > Rotate > Rotate 90 deg > ",a="Select > Select on 3D > ",o="Analysis > Label > ",l="File > 3D Printing > ";return 0==(e=e.trim()).indexOf("load")?"File > Retrieve by ID, Align":0==e.indexOf("set map")&&-1==e.indexOf("set map wireframe")?"Style > Electron Density":0==e.indexOf("set emmap")&&-1==e.indexOf("set emmap wireframe")?"Style > EM Density Map":0==e.indexOf("set phi")?"Analysis > Load Potential > URL(CORS) Phi/Cube":0==e.indexOf("set delphi")?"Analysis > DelPhi Potential":0==e.indexOf("setoption map")?"Style > Remove Map":0==e.indexOf("setoption emmap")?"Style > Remove EM Map":0==e.indexOf("view annotations")?t:0==e.indexOf("set annotation all")?t+': "All" checkbox':0==e.indexOf("set annotation clinvar")?t+': "ClinVar" checkbox':0==e.indexOf("set annotation snp")?t+': "SNP" checkbox':0==e.indexOf("set annotation 3ddomain")?t+': "3D Domains" checkbox':0==e.indexOf("view interactions")?"Windows > View 2D Diagram":0==e.indexOf("symmetry")?"Analysis > Symmetry":0==e.indexOf("realign on seq align")?"File > Realign Selection > on Sequence Alignment":0==e.indexOf("realign")?"File > Realign Selection > Residue by Residue":0==e.indexOf("graph interaction pairs")?i+" > 2D Graph(Force-Directed)":0==e.indexOf("export canvas")?"File > Save File > iCn3D PNG Image":"export stl file"==e?l+"STL":"export vrml file"==e?l+"VRML(Color)":"export stl stabilizer file"==e?l+"STL W/ Stabilizers":"export vrml stabilizer file"==e?l+"VRML(Color, W/ Stabilizers)":"select all"==e?'Select > All; or Toggle to "All"(next to "Help")':"show all"==e?"View > View Full Structure":"select complement"==e?"Select > Inverse":"set pk atom"==e?a+"Atom":"set pk residue"==e?a+"Residue":"set pk strand"==e?a+"Strand/Helix":"set pk domain"==e?a+"3D Domain":"set pk chain"==e?a+"Chain":"set surface wireframe on"==e?"Style > Surface Wireframe > Yes":"set surface wireframe off"==e?"Style > Surface Wireframe > No":"set map wireframe on"==e?"Style > Map Wireframe > Yes":"set map wireframe off"==e?"Style > Map Wireframe > No":"set emmap wireframe on"==e?"Style > EM Map Wireframe > Yes":"set emmap wireframe off"==e?"Style > EM Map Wireframe > No":"set surface neighbors on"==e?"Style > Surface Type > ... with Context":"set axis on"==e?"View > XYZ-axes > Show":"set axis off"==e?"View > XYZ-axes > Hide":"set fog on"==e?"View > Fog for Selection > On":"set fog off"==e?"View > Fog for Selection > Off":"set slab on"==e?"View > Slab for Selection > On":"set slab off"==e?"View > Slab for Selection > Off":"set assembly on"==e?"Analysis > Assembly > Biological Assembly":"set assembly off"==e?"Analysis > Assembly > Asymmetric Unit":"set chemicalbinding show"==e?"Analysis > Chem. Binding > Show":"set chemicalbinding hide"==e?"Analysis > Chem. Binding > Hide":"set hbonds off"==e||"set salt bridge off"==e||"set contact off"==e||"set halogen pi off"==e?i+" > Reset":"hydrogens"==e?"Style > Hydrogens > Show":"set hydrogens off"==e?"Style > Hydrogens > Hide":"set stabilizer off"==e?"File > 3D Printing > Remove All Stabilizers":"set disulfide bonds off"==e?"Analysis > Disulfide Bonds > Hide":"set cross linkage off"==e?"Analysis > Cross-Linkages > Hide":"set lines off"==e?"Analysis > Distance > Hide":"set labels off"==e?"Analysis > Label > Remove":"set mode all"==e?'Toggle to "All"(next to "Help")':"set mode selection"==e?'Toggle to "Selection"(next to "Help")':"set view detailed view"==e?t+': "Details" tab':"set view overview"==e?t+': "Summary" tab':"set annotation custom"==e?t+': "Custom" checkbox':"set annotation interaction"==e?t+': "Interactions" checkbox':"set annotation ptm"==e?t+': "PTM" checkbox':"set annotation cdd"==e?t+': "Conserved Domains" checkbox':"set annotation site"==e?t+': "Functional Sites" checkbox':"set annotation ssbond"==e?t+': "Disulfide Bonds" checkbox':"set annotation crosslink"==e?t+': "Cross-Linkages" checkbox':"set annotation transmembrane"==e?t+': "Transmembrane" checkbox':"set annotation ig"==e?t+': "Ig Domains" checkbox':"highlight level up"==e?"Keyboard Arrow Up":"highlight level down"==e?"Keyboard Arrow Down":0==e.indexOf("hide annotation")?t+": checkboxes off":"add residue labels"==e?o+"per Residue":"add residue number labels"==e?o+"per Residue & Number":"add Ig domain labels"==e?o+"per Ig Domain":"add atom labels"==e?o+"per Atom":"add chain labels"==e?o+"per Chain":"add terminal labels"==e?o+"N- & C- Termini":"rotate left"==e?n+"Left; or Key l":"rotate right"==e?n+"Right; or Key j":"rotate up"==e?n+"Up; or Key i":"rotate down"==e?n+"Down; or Key m":"rotate x"==e?r+"X-axis":"rotate y"==e?r+"Y-axis":"rotate z"==e?r+"Z-axis":"reset"==e?"View > Reset > All":"reset orientation"==e?"View > Reset > Orientation":"clear selection"==e?"Select > Clear Selection":"zoom selection"==e?"Select > Zoom in Selection":"center selection"==e?"Select > Center Selection":"show selection"==e?"Select > View Only Selection":"hide selection"==e?"Select > Hide Selection":"output selection"==e?"Select > Clear Selection":"toggle highlight"==e?"Select > Toggle Highlight":"stabilizer"==e?"File > 3D Printing > Add all Stabilizers":"disulfide bonds"==e?"Analysis > Disulfide Bonds > Show":"cross linkage"==e?"Analysis > Cross-Linkages > Show":"back"==e?"View > Undo":"forward"==e?"View > Redo":"clear all"==e?"Select > Clear Selection":"defined sets"==e?"Windows > Defined Sets":"delete selected sets"==e?'Windows > Defined Sets: "Delete Selected Sets" button':"view interactions"==e?"Windows > View Interactions":"show annotations all chains"==e?t+': "Show All Chains" button':"save color"==e?"Color > Save Color":"apply saved color"==e?"Color > Apply Saved Color":"save style"==e?"Style > Save Style":"apply saved style"==e?"Style > Apply Saved Style":"select main chains"==e?"Select > Main Chains":"select side chains"==e?"Select > Side Chains":"select main side chains"==e?"Select > Main & Side Chains":"area"==e?"View > Surface Area":"table inter count only"==e?i+': "Set 1" button: "Show Count Only" button':"table inter details"==e?i+': "Set 1" button: "Show Details" button':0==e.indexOf("define helix sets")?t+': "Helix Sets" button':0==e.indexOf("define sheet sets")?t+': "Sheet Sets" button':0==e.indexOf("define coil sets")?t+': "Coil Sets" button':0==e.indexOf("select interaction")?"Windows > View 2D Diagram: click on edges":0==e.indexOf("select saved atoms")||0==e.indexOf("select sets")?"Windows > Defined Sets: select in menu":-1!==e.indexOf("select chain")?t+": click on chain names":-1!==e.indexOf("select alignChain")?"Windows > View Aligned Sequences: click on chain names":0==e.indexOf("select zone cutoff")?"Select > by Distance":0==e.indexOf("set surface opacity")?"Style > Surface Opacity":0==e.indexOf("set label scale")?"View > Label Scale":0==e.indexOf("set surface")?"Style > Surface Type":0==e.indexOf("set camera")?"View > Camera":0==e.indexOf("set background")?"Style > Background":0==e.indexOf("set thickness")?"File > 3D Printing > Set Thickness":0==e.indexOf("set highlight color")?"Select > Highlight Color":0==e.indexOf("set highlight style")?"Select > Highlight Style":0==e.indexOf("add line")||0==e.indexOf("add label")?"Analysis > Distance > between Two Atoms":0==e.indexOf("dist")?"Analysis > Distance > between Two Sets":0==e.indexOf("msa")?t+': "Add Track" button: "FASTA Alignment" button':0==e.indexOf("add track")?t+': "Add Track" button':0==e.indexOf("remove one stabilizer")?"File > 3D Printing > Remove One Stablizer":0==e.indexOf("add one stabilizer")?"File > 3D Printing > Add One Stablizer":0==e.indexOf("select planes z-axis")?"View > Select between Two X-Y Planes":0==e.indexOf("adjust membrane z-axis")?"View > Adjust Membrane":0==e.indexOf("toggle membrane")?"View > Toggle Membrane":0==e.indexOf("calc buried surface")?i+': "Buried Surface Area" button':0==e.indexOf("display interaction 3d")?i+': "3D Display Interactions" button':0==e.indexOf("view interaction pairs")?i+': "Highlight Interactions in Table" button':0==e.indexOf("save1 interaction pairs")?i+': "Set 1" button':0==e.indexOf("save2 interaction pairs")?i+': "Set 2" button':0==e.indexOf("line graph interaction pairs")?i+': "2D Interaction Network" button':0==e.indexOf("scatterplot interaction pairs")?i+': "2D Interaction Map" button':0==e.indexOf("ligplot interaction pairs")?i+': "2D Interaction for One Ligand/Residue" button':0==e.indexOf("graph label")?s+': "Label Size" menu':0==e.indexOf("graph force")?s+': "Force on Nodes" menu':0==e.indexOf("hide edges")?s+': "Internal Edges" menu':0==e.indexOf("reset interaction pairs")?i+" > Reset":0==e.indexOf("side by side")?"View > Side by Side":0==e.indexOf("your note")?"Windows > Your Notes / Window Title":0==e.indexOf("pickatom")?"Hold Alt key and click on 3D structure":0==e.indexOf("color")?"Color menu":0==e.indexOf("custom tube")?t+': "Custom Color/Tube" button: "Custom Tube" button':0==e.indexOf("style")?"Style menu":-1!==e.indexOf("select displayed set")?"Select > Displayed Set":-1!==e.indexOf("select prop")?"Select > by Property":0==e.indexOf("select")&&-1!==e.indexOf("name")?t+": drag on residues to select":-1!==e.indexOf("select $")||-1!==e.indexOf("select .")||-1!==e.indexOf("select :")||-1!==e.indexOf("select @")?"Select > Advanced; or other selection":-1!==e.indexOf("replay on")?"File > Replay Each Step > On":-1!==e.indexOf("replay off")?"File > Replay Each Step > Off":-1!==e.indexOf("set theme")?"Style > Theme Color":-1!==e.indexOf("set double color")?"Style > Two-color Helix":""}}class Yh{constructor(e){this.icn3d=e}setProtNuclLigInMenu(){let e=this.icn3d;if(e.icn3dui,e.proteins&&Object.keys(e.proteins).length>0&&(e.defNames2Residues.proteins=Object.keys(e.firstAtomObjCls.getResiduesFromAtoms(e.proteins)),e.defNames2Descr.proteins="proteins",e.defNames2Command.proteins="select :proteins"),e.nucleotides&&Object.keys(e.nucleotides).length>0&&(e.defNames2Residues.nucleotides=Object.keys(e.firstAtomObjCls.getResiduesFromAtoms(e.nucleotides)),e.defNames2Descr.nucleotides="nucleotides",e.defNames2Command.nucleotides="select :nucleotides"),e.chemicals&&Object.keys(e.chemicals).length>0)if(e.bOpm){let t={},i={};for(let s in e.chemicals){let n=e.atoms[s],r=n.structure+"_"+n.chain+"_"+n.resi;"DUM"===n.resn?i[r]=1:t[r]=1}Object.keys(t).length>0&&(e.defNames2Residues.chemicals=Object.keys(t),e.defNames2Descr.chemicals="chemicals",e.defNames2Command.chemicals="select :chemicals"),Object.keys(i).length>0&&(e.defNames2Residues.membrane=Object.keys(i),e.defNames2Descr.membrane="membrane",e.defNames2Command.membrane="select :membrane")}else e.defNames2Residues.chemicals=Object.keys(e.firstAtomObjCls.getResiduesFromAtoms(e.chemicals)),e.defNames2Descr.chemicals="chemicals",e.defNames2Command.chemicals="select :chemicals";e.ions&&Object.keys(e.ions).length>0&&(e.defNames2Residues.ions=Object.keys(e.firstAtomObjCls.getResiduesFromAtoms(e.ions)),e.defNames2Descr.ions="ions",e.defNames2Command.ions="select :ions"),e.water&&Object.keys(e.water).length>0&&(e.defNames2Residues.water=Object.keys(e.firstAtomObjCls.getResiduesFromAtoms(e.water)),e.defNames2Descr.water="water",e.defNames2Command.water="select :water"),this.setTransmemInMenu(e.halfBilayerSize,-e.halfBilayerSize)}setPredefinedInMenu(){let e=this.icn3d,t=e.icn3dui;if(this.setProtNuclLigInMenu(),this.setChainsInMenu(),void 0!==t.cfg.mmdbid||void 0!==t.cfg.gi||void 0!==t.cfg.chainalign||void 0!==t.cfg.mmdbafid)for(let t in e.tddomains)e.selectionCls.selectResidueList(e.tddomains[t],t,t,!1,!1);if((void 0!==t.cfg.align||void 0!==t.cfg.chainalign&&2==e.chainidArray.length)&&e.bFullUi){e.selectionCls.selectResidueList(e.consHash1,e.conservedName1,e.conservedName1,!1,!1),e.selectionCls.selectResidueList(e.consHash2,e.conservedName2,e.conservedName2,!1,!1),e.selectionCls.selectResidueList(e.nconsHash1,e.nonConservedName1,e.nonConservedName1,!1,!1),e.selectionCls.selectResidueList(e.nconsHash2,e.nonConservedName2,e.nonConservedName2,!1,!1),e.selectionCls.selectResidueList(e.nalignHash1,e.notAlignedName1,e.notAlignedName1,!1,!1),e.selectionCls.selectResidueList(e.nalignHash2,e.notAlignedName2,e.notAlignedName2,!1,!1);let i={};for(let s in e.alnChains)i=t.hashUtilsCls.unionHash(i,e.alnChains[s]);let s=e.firstAtomObjCls.getResiduesFromAtoms(i),n="protein_aligned",r="aligned protein and nucleotides",a="select "+e.resid2specCls.residueids2spec(Object.keys(s));e.selectionCls.addCustomSelection(Object.keys(s),n,r,a,!0)}}setAtomMenu(e){let t=this.icn3d;t.icn3dui;let i="",s=void 0!==t.defNames2Residues?Object.keys(t.defNames2Residues):[],n=void 0!==t.defNames2Atoms?Object.keys(t.defNames2Atoms):[],r=s.concat(n).sort(),a=[];r.forEach((e=>{-1===$.inArray(e,a)&&a.push(e)}));for(let s=0,n=a.length;s<n;++s){let n,r,o=a[s];if(void 0!==t.defNames2Atoms&&t.defNames2Atoms.hasOwnProperty(o)){let e=t.defNames2Atoms[o];e.length>0&&(n=t.atoms[e[0]])}else if(void 0!==t.defNames2Residues&&t.defNames2Residues.hasOwnProperty(o)){let e=t.defNames2Residues[o];e.length>0&&(r=t.residues[e[0]],r&&(n=t.atoms[Object.keys(r)[0]]))}let l=void 0===n||void 0===n.color||"FFFFFF"===n.color.getHexString().toUpperCase()?"DDDDDD":n.color.getHexString(),d=void 0!==n&&void 0!==n.color?l:"000000";-1!=e.indexOf(o)?i+="<option value='"+o+"' style='color:#"+d+"' selected='selected'>"+o+"</option>":i+="<option value='"+o+"' style='color:#"+d+"'>"+o+"</option>"}return i}setChainsInMenu(){let e=this.icn3d,t=e.icn3dui,i={};for(let s in e.chains){let n=e.firstAtomObjCls.getFirstAtomObj(e.chains[s]);if(e.proteins.hasOwnProperty(n.serial)||e.nucleotides.hasOwnProperty(n.serial)){e.defNames2Residues[s]=Object.keys(e.firstAtomObjCls.getResiduesFromAtoms(e.chains[s])),e.defNames2Descr[s]=s;let t=s.indexOf("_"),i=s.substr(0,t),n=s.substr(t+1);e.defNames2Command[s]="select $"+i+"."+n}else{let s=n.structure+"_"+n.chain+"_"+n.resi,r=n.resn.substr(0,3);i[r]?i[r]=t.hashUtilsCls.unionHash(i[n.resn],e.residues[s]):i[r]=e.residues[s]}}for(let t in i)e.defNames2Residues[t]=Object.keys(e.firstAtomObjCls.getResiduesFromAtoms(i[t])),e.defNames2Descr[t]=t,e.defNames2Command[t]="select :3"+t;if(e.structures&&1==Object.keys(e.structures)){let t=Object.keys(e.structures)[0];e.defNames2Residues[t]=Object.keys(e.residues),e.defNames2Descr[t]=t,e.defNames2Command[t]="select $"+t}else if(e.residues){let t=Object.keys(e.residues),i={};for(let e=0,s=t.length;e<s;++e){let s=t[e],n=s.indexOf("_"),r=s.substr(0,n);void 0===i[r]&&(i[r]=[]),i[r].push(s)}for(let t in i)e.defNames2Residues[t]=i[t],e.defNames2Descr[t]=t,e.defNames2Command[t]="select $"+t}}setTransmemInMenu(e,t,i){let s=this.icn3d;if(s.icn3dui,s.bOpm){let n={},r={},a={};for(let i in s.atoms){let o=s.atoms[i];if("DUM"===o.resn)continue;let l=o.structure+"_"+o.chain+"_"+o.resi;o.coord.z>e?r[l]=1:o.coord.z<t?a[l]=1:n[l]=1}let o=i?"2":"";Object.keys(n).length>0&&(s.defNames2Residues["transmembrane"+o]=Object.keys(n),s.defNames2Descr["transmembrane"+o]="transmembrane"+o,s.defNames2Command["transmembrane"+o]="select :transmembrane"+o),Object.keys(r).length>0&&(s.defNames2Residues["extracellular"+o]=Object.keys(r),s.defNames2Descr["extracellular"+o]="extracellular"+o,s.defNames2Command["extracellular"+o]="select :extracellular"+o),Object.keys(a).length>0&&(s.defNames2Residues["intracellular"+o]=Object.keys(a),s.defNames2Descr["intracellular"+o]="intracellular"+o,s.defNames2Command["intracellular"+o]="select :intracellular"+o)}}showSets(){let e=this.icn3d,t=e.icn3dui;t.bNode||(t.htmlCls.dialogCls.openDlg("dl_definedsets","Select sets"),$("#"+e.pre+"dl_setsmenu").show(),$("#"+e.pre+"dl_setoperations").show(),$("#"+e.pre+"dl_command").hide(),$("#"+e.pre+"atomsCustom").resizable());let i=t.hashUtilsCls.cloneHash(e.hAtoms),s=t.hashUtilsCls.cloneHash(e.dAtoms);void 0!==e.bSetChainsAdvancedMenu&&e.bSetChainsAdvancedMenu&&!e.bResetSets||(this.setPredefinedInMenu(),e.bSetChainsAdvancedMenu=!0),e.hAtoms=t.hashUtilsCls.cloneHash(i),e.dAtoms=t.hashUtilsCls.cloneHash(s),e.hlUpdateCls.updateHlMenus()}clickCustomAtoms(){let e=this.icn3d,t=e.icn3dui,i=this;$("#"+e.pre+"atomsCustom").change((function(e){let s=i.icn3d,n=$(this).val();if(s.nameArray=n,null!==n){let e=!1;i.changeCustomAtoms(n,e),t.htmlCls.clickMenuCls.setLogCmd("select sets "+n.join(" "+s.setOperation+" "),!0),s.bSelectResidue=!1}})),t.myEventCls.onIds("#"+e.pre+"atomsCustom","focus",(function(e){let s=i.icn3d;t.utilsCls.isMobile()&&$("#"+s.pre+"atomsCustom").val("")}))}deleteSelectedSets(){let e=this.icn3d;e.icn3dui;let t=$("#"+e.pre+"atomsCustom").val();for(let i=0;i<t.length;++i){let s=t[i];(void 0!==e.defNames2Atoms&&e.defNames2Atoms.hasOwnProperty(s)||void 0!==e.defNames2Residues&&e.defNames2Residues.hasOwnProperty(s))&&(void 0!==e.defNames2Atoms&&e.defNames2Atoms.hasOwnProperty(s)&&delete e.defNames2Atoms[s],void 0!==e.defNames2Residues&&e.defNames2Residues.hasOwnProperty(s)&&delete e.defNames2Residues[s])}e.hlUpdateCls.updateHlMenus()}changeCustomAtoms(e,t){let i=this.icn3d,s=i.icn3dui;i.hAtoms={};for(let t=0;t<e.length;++t){let n=e[t];if(void 0!==i.defNames2Atoms&&i.defNames2Atoms.hasOwnProperty(n)||void 0!==i.defNames2Residues&&i.defNames2Residues.hasOwnProperty(n)){if(void 0!==i.defNames2Atoms&&i.defNames2Atoms.hasOwnProperty(n)){let e=i.defNames2Atoms[n];for(let t=0,s=e.length;t<s;++t)i.hAtoms[e[t]]=1}if(void 0!==i.defNames2Residues&&i.defNames2Residues.hasOwnProperty(n)){let e=i.defNames2Residues[n],t={};for(let n=0,r=e.length;n<r;++n)t=s.hashUtilsCls.unionHash(t,i.residues[e[n]]);i.hAtoms=s.hashUtilsCls.unionHash(i.hAtoms,t)}}}i.hlUpdateCls.updateHlAll(e,t),i.annotationCls.showAnnoSelectedChains(),$("#"+i.pre+"command").val(""),$("#"+i.pre+"command_name").val("");for(let t=0,s=e.length;t<s;++t)if(i.defNames2Atoms[e[t]],i.defNames2Residues[e[t]],i.defNames2Descr[e[t]],0===t)$("#"+i.pre+"command").val("saved atoms "+e[t]),$("#"+i.pre+"command_name").val(e[t]);else{let s=$("#"+i.pre+"command").val();$("#"+i.pre+"command").val(s+" "+i.setOperation+" "+e[t]),s=$("#"+i.pre+"command_name").val(),$("#"+i.pre+"command_name").val(s+" "+i.setOperation+" "+e[t])}}setHAtomsFromSets(e,t){let i=this.icn3d;i.icn3dui;for(let s=0;s<e.length;++s){let n=e[s];if(this.setHAtomsFromSets_base(n,t),0==Object.keys(i.hAtoms).length&&("sphere"==n.split(".")[0]||"interactions"==n.split(".")[0])){let e=n.lastIndexOf("-");n=n.split(".")[0]+n.substr(e),this.setHAtomsFromSets_base(n,t)}}}setHAtomsFromSets_base(e,t){let i=this.icn3d,s=i.icn3dui;if(void 0!==i.defNames2Atoms&&i.defNames2Atoms.hasOwnProperty(e)){let n=i.defNames2Atoms[e];if("or"===t)for(let e=0,t=n.length;e<t;++e)i.hAtoms[n[e]]=1;else if("and"===t){let e={};for(let t=0,i=n.length;t<i;++t)e[n[t]]=1;i.hAtoms=s.hashUtilsCls.intHash(i.hAtoms,e)}else if("not"===t){let e={};for(let t=0,i=n.length;t<i;++t)e[n[t]]=1;i.hAtoms=s.hashUtilsCls.exclHash(i.hAtoms,e)}}if(void 0!==i.defNames2Residues&&i.defNames2Residues.hasOwnProperty(e)){let n=i.defNames2Residues[e],r={};for(let e=0,t=n.length;e<t;++e)r=s.hashUtilsCls.unionHash(r,i.residues[n[e]]);"or"===t?i.hAtoms=s.hashUtilsCls.unionHash(i.hAtoms,r):"and"===t?i.hAtoms=s.hashUtilsCls.intHash(i.hAtoms,r):"not"===t&&(i.hAtoms=s.hashUtilsCls.exclHash(i.hAtoms,r))}}updateAdvancedCommands(e,t){let i=this.icn3d;i.icn3dui;let s=" "+t+" ";for(let n=0,r=e.length;n<r;++n)if(0===n&&"or"==t)$("#"+i.pre+"command").val("saved atoms "+e[n]),$("#"+i.pre+"command_name").val(e[n]);else{let t=$("#"+i.pre+"command").val();$("#"+i.pre+"command").val(t+s+e[n]),t=$("#"+i.pre+"command_name").val(),$("#"+i.pre+"command_name").val(t+s+e[n])}}combineSets(e,t,i,s){let n=this.icn3d,r=n.icn3dui;if(n.hAtoms={},this.setHAtomsFromSets(e,"or"),0==Object.keys(n.hAtoms).length&&(n.hAtoms=r.hashUtilsCls.cloneHash(n.dAtoms)),this.setHAtomsFromSets(t,"and"),this.setHAtomsFromSets(i,"not"),n.bInitial||n.hlUpdateCls.updateHlAll(),n.annotationCls.showAnnoSelectedChains(),$("#"+n.pre+"command").val(""),$("#"+n.pre+"command_name").val(""),this.updateAdvancedCommands(e,"or"),this.updateAdvancedCommands(t,"and"),this.updateAdvancedCommands(i,"not"),void 0!==s){let e="select "+$("#"+n.pre+"command").val();$("#"+n.pre+"command_name").val(s),n.selectionCls.addCustomSelection(Object.keys(n.hAtoms),s,s,e,!1)}}async commandSelect(e){let t=this.icn3d,i=t.icn3dui,s=$("#"+t.pre+"command"+e).val(),n=$("#"+t.pre+"command_name"+e).val().replace(/;/g,"_").replace(/\s+/g,"_");s&&(await t.selByCommCls.selectByCommand(s,n,n),i.htmlCls.clickMenuCls.setLogCmd("select "+s+" | name "+n,!0))}clickCommand_apply(){let e=this.icn3d,t=e.icn3dui,i=this;t.myEventCls.onIds("#"+e.pre+"command_apply","click",(async function(e){i.icn3d,e.preventDefault(),await i.commandSelect("")})),t.myEventCls.onIds("#"+e.pre+"command_apply2","click",(async function(e){i.icn3d,e.preventDefault(),await i.commandSelect("2")}))}selectCombinedSets(e,t){this.icn3d.icn3dui;let i=e.split(" "),s=[],n=[],r=[],a="or";for(let e=0,t=i.length;e<t;++e){let t=i[e].split("_");if(3!=t.length||isNaN(t[2])||(i[e]=t[0]+"_"+t[1]+t[2]),"or"!==i[e]&&"and"!==i[e]&&"not"!==i[e]){let t=["hbonds_","saltbridge_","halogen_","pi-cation_","pi-stacking_"];for(let s=0,n=t.length;s<n;++s){const n=new RegExp("^"+t[s]+"\\d+$");i[e].match(n)&&(i[e]=t[s]+"auto")}"or"===a?s.push(i[e]):"and"===a?n.push(i[e]):"not"===a&&r.push(i[e])}else a=i[e]}null!==i&&this.combineSets(s,n,r,t)}clickModeswitch(){let e=this.icn3d,t=e.icn3dui,i=this;t.myEventCls.onIds("#"+e.pre+"modeswitch","click",(function(t){void 0!==$("#"+e.pre+"modeswitch")[0]&&$("#"+e.pre+"modeswitch")[0].checked?i.setModeAndDisplay("selection"):i.setModeAndDisplay("all")}))}setModeAndDisplay(e){let t=this.icn3d,i=t.icn3dui;"all"===e?(this.setMode("all"),t.prevHighlightAtoms=i.hashUtilsCls.cloneHash(t.hAtoms),i.htmlCls.clickMenuCls.setLogCmd("set mode all",!0),t.selectionCls.selectAll(),t.drawCls.draw()):(this.setMode("selection"),void 0!==t.prevHighlightAtoms?t.hAtoms=i.hashUtilsCls.cloneHash(t.prevHighlightAtoms):t.selectionCls.selectAll(),i.htmlCls.clickMenuCls.setLogCmd("set mode selection",!0),t.hlUpdateCls.updateHlAll())}setMode(e){let t=this.icn3d;t.icn3dui,"all"===e?($("#"+t.pre+"modeall").show(),$("#"+t.pre+"modeselection").hide(),void 0!==$("#"+t.pre+"modeswitch")[0]&&($("#"+t.pre+"modeswitch")[0].checked=!1),$("#"+t.pre+"style").hasClass("icn3d-modeselection")&&$("#"+t.pre+"style").removeClass("icn3d-modeselection"),$("#"+t.pre+"color").hasClass("icn3d-modeselection")&&$("#"+t.pre+"color").removeClass("icn3d-modeselection")):($("#"+t.pre+"modeall").hide(),$("#"+t.pre+"modeselection").show(),void 0!==$("#"+t.pre+"modeswitch")[0]&&($("#"+t.pre+"modeswitch")[0].checked=!0),$("#"+t.pre+"style").hasClass("icn3d-modeselection")||$("#"+t.pre+"style").addClass("icn3d-modeselection"),$("#"+t.pre+"color").hasClass("icn3d-modeselection")||$("#"+t.pre+"color").addClass("icn3d-modeselection"))}getAtomsFromOneSet(e){let t=this.icn3d,i=t.icn3dui,s={};if(void 0===t.defNames2Residues.proteins&&this.showSets(),-1!==Object.keys(t.chains).indexOf(e))s=i.hashUtilsCls.unionHash(s,t.chains[e]);else{if(void 0!==t.defNames2Residues[e]&&t.defNames2Residues[e].length>0)for(let n=0,r=t.defNames2Residues[e].length;n<r;++n){let r=t.defNames2Residues[e][n];s=i.hashUtilsCls.unionHash(s,t.residues[r])}if(void 0!==t.defNames2Atoms[e]&&t.defNames2Atoms[e].length>0)for(let i=0,n=t.defNames2Atoms[e].length;i<n;++i){s[t.defNames2Atoms[e][i]]=1}}return s}getAtomsFromNameArray(e){let t=this.icn3d,i=t.icn3dui,s={};for(let n=0,r=e.length;n<r;++n)if("non-selected"===e[n]){let e={};for(let i in t.atoms)!t.hAtoms.hasOwnProperty(i)&&t.dAtoms.hasOwnProperty(i)&&(e[i]=t.atoms[i]);s=i.hashUtilsCls.unionHash(s,e)}else s="selected"===e[n]?i.hashUtilsCls.unionHash(s,i.hashUtilsCls.hash2Atoms(t.hAtoms,t.atoms)):i.hashUtilsCls.unionHash(s,i.hashUtilsCls.hash2Atoms(this.getAtomsFromOneSet(e[n]),t.atoms));return 0==e.length&&(s=t.atoms),s}}class Kh{constructor(e){this.icn3d=e}setAtomMenu(e){let t=this.icn3d;t.icn3dui;let i="";return Object.entries(e).forEach((([e,s],n)=>{let r,[a,o,l,d,c]=s;if(void 0!==t.defNames2Atoms&&t.defNames2Atoms.hasOwnProperty(e)){let i=t.defNames2Atoms[e];i.length>0&&t.atoms[i[0]]}else if(void 0!==t.defNames2Residues&&t.defNames2Residues.hasOwnProperty(e)){let i=t.defNames2Residues[e];i.length>0&&(r=t.residues[i[0]],r&&t.atoms[Object.keys(r)[0]])}i+=0===n?"<option value='"+e+"' selected='selected' data-description='"+l+"'>"+o+"</option>":"<option value='"+e+"' data-description='"+l+"'>"+o+"</option>"})),i}reset(){let e=this.icn3d;e.atoms={},e.proteins={},e.nucleotides={},e.chemicals={},e.ions={},e.water={},e.structures={},e.chains={},e.chainsSeq={},e.residues={},e.defNames2Atoms={},e.defNames2Residues={},e.ssbondpnts={},e.bShowHighlight=void 0,e.bResetSets=!0}dictionaryDifference(e,t){const i={};for(let s in t)s in e||(i[s]=t[s]);return i}clickStructure(e){let t=this.icn3d,i=t.icn3dui,s=this;$("#"+t.pre+"collections_menu").on("change",(async function(t){let n=s.icn3d,r=$(this).val(),a=$(this).find("option:selected").text(),o=Array.from(this.selectedOptions).map((e=>e.index));if(r.reduce(((e,t,i)=>(e[t]=o[i],e)),{}),n.nameArray=r,null!==r){let l=!0;s.reset();for(const d of r)if(!(d in n.allData)){async function c(e){if(await n.resetConfig(),e){let e=!0;0==Object.keys(n.structures).length&&(e=!1),await n.pdbParserCls.loadPdbData(n.pdbCollection[d].join("\n"),void 0,void 0,e)}else await n.chainalignParserCls.downloadMmdbAf(d,void 0,void 0,l)}n.allData.prev=JSON.parse(JSON.stringify(n.allData.all)),n.atoms=n.allData.all.atoms,n.proteins=n.allData.all.proteins,n.nucleotides=n.allData.all.nucleotides,n.chemicals=n.allData.all.chemicals,n.ions=n.allData.all.ions,n.water=n.allData.all.water,n.structures=n.allData.all.structures,n.ssbondpnts=n.allData.all.ssbondpnts,n.residues=n.allData.all.residues,n.chains=n.allData.all.chains,n.chainsSeq=n.allData.all.chainsSeq,n.defalls2Atoms=n.allData.all.defalls2Atoms,n.defalls2Residues=n.allData.all.defalls2Residues,await c(e[d][4]).then((()=>{n.allData.all={atoms:n.atoms,proteins:n.proteins,nucleotides:n.nucleotides,chemicals:n.chemicals,ions:n.ions,water:n.water,structures:n.structures,ssbondpnts:n.ssbondpnts,residues:n.residues,chains:n.chains,chainsSeq:n.chainsSeq,defNames2Atoms:n.defNames2Atoms,defNames2Residues:n.defNames2Residues},n.allData[d]={title:n.molTitle,atoms:s.dictionaryDifference(n.allData.prev.atoms,n.atoms),proteins:s.dictionaryDifference(n.allData.prev.proteins,n.proteins),nucleotides:s.dictionaryDifference(n.allData.prev.nucleotides,n.nucleotides),chemicals:s.dictionaryDifference(n.allData.prev.chemicals,n.chemicals),ions:s.dictionaryDifference(n.allData.prev.ions,n.ions),water:s.dictionaryDifference(n.allData.prev.water,n.water),structures:s.dictionaryDifference(n.allData.prev.structures,n.structures),ssbondpnts:s.dictionaryDifference(n.allData.prev.ssbondpnts,n.ssbondpnts),residues:s.dictionaryDifference(n.allData.prev.residues,n.residues),chains:s.dictionaryDifference(n.allData.prev.chains,n.chains),chainsSeq:s.dictionaryDifference(n.allData.prev.chainsSeq,n.chainsSeq),defNames2Atoms:s.dictionaryDifference(n.allData.prev.defNames2Atoms,n.defNames2Atoms),defNames2Residues:s.dictionaryDifference(n.allData.prev.defNames2Residues,n.defNames2Residues)},s.reset()}))}for(const h of r){if(n.atoms=Object.assign(n.atoms,n.allData[h].atoms),n.proteins=Object.assign(n.proteins,n.allData[h].proteins),n.nucleotides=Object.assign(n.nucleotides,n.allData[h].nucleotides),n.chemicals=Object.assign(n.chemicals,n.allData[h].chemicals),n.ions=Object.assign(n.ions,n.allData[h].ions),n.water=Object.assign(n.water,n.allData[h].water),n.structures=Object.assign(n.structures,n.allData[h].structures),n.ssbondpnts=Object.assign(n.ssbondpnts,n.allData[h].ssbondpnts),n.residues=Object.assign(n.residues,n.allData[h].residues),n.chains=Object.assign(n.chains,n.allData[h].chains),n.chainsSeq=Object.assign(n.chainsSeq,n.allData[h].chainsSeq),n.defNames2Atoms=Object.assign(n.defNames2Atoms,n.allData[h].defNames2Atoms),n.defNames2Residues=Object.assign(n.defNames2Residues,n.allData[h].defNames2Residues),n.dAtoms=i.hashUtilsCls.cloneHash(n.atoms),n.hAtoms=i.hashUtilsCls.cloneHash(n.atoms),n.molTitle=n.allData[h].title,void 0!==e[h][3]&&e[h][3].length>0&&null==n.allData[h].commands){let p=e[h][3];n.allData[h].commands=p}if(void 0!==n.allData[h].commands)for(const u of n.allData[h].commands)i.htmlCls.clickMenuCls.setLogCmd(u,!0),await n.applyCommandCls.applyCommand(u)}n.opts.color=1==Object.keys(n.structures).length?"chain":"structure",n.setColorCls.setColorByOptions(n.opts,n.atoms),n.transformCls.zoominSelection(),n.definedSetsCls.showSets(),n.bResetAnno=!0,n.bAnnoShown&&(await n.showAnnoCls.showAnnotations(),n.hlUpdateCls.updateHlAll(r),n.annotationCls.showAnnoSelectedChains()),await n.drawCls.draw(),n.saveFileCls.showTitle(),i.htmlCls.clickMenuCls.setLogCmd("select structure ["+a+"]",!1),i.htmlCls.clickMenuCls.setLogCmd("load mmdbaf1 "+r,!0)}})),i.myEventCls.onIds("#"+t.pre+"collections_menu","focus",(function(e){let t=s.icn3d;i.utilsCls.isMobile()&&$("#"+t.pre+"collections_menu").val("")}))}}class Zh{constructor(e){this.icn3d=e}async loadScript(e,t,i){let s=this.icn3d;if(s.icn3dui,!e)return;s.bCommandLoad=!0,s.bRender=!1,s.bStopRotate=!0,e=t?e.replace(/\+/g," "):e.replace(/\+/g," ").replace(/;/g,"\n");let n=[];!i&&s.commands.length>0&&(n[0]=s.commands[0]);let r=e.trim().split("\n");s.commands=r;let a=r[0].indexOf("command=");if(t&&-1!=a){let e=r[0].substr(0,a-1);s.commands.splice(0,1,e)}s.STATENUMBER=s.commands.length,s.commands=n.concat(s.commands),s.STATENUMBER=s.commands.length,s.CURRENTNUMBER=0,s.bReplay?await this.replayFirstStep(s.CURRENTNUMBER):await this.execCommands(s.CURRENTNUMBER,s.STATENUMBER-1,s.STATENUMBER,i)}async execCommands(e,t,i,s){let n=this.icn3d;n.icn3dui,n.bRender=!1,s||n.reinitAfterLoad(),await this.execCommandsBase(e,t,i)}getNameArray(e){let t=this.icn3d;t.icn3dui;let i=e.split(" | "),s=[];return 2==i.length&&(s=i[1].split(","),t.hAtoms=t.definedSetsCls.getAtomsFromNameArray(s)),s}updateTransformation(e){let t=this.icn3d;t.icn3dui;let i=t.commands[e-1]?t.commands[e-1].split("|||"):[];if(2==i.length){let e=JSON.parse(i[1]);t._zoomFactor=e.factor,t.mouseChange.x=e.mouseChange.x,t.mouseChange.y=e.mouseChange.y,t.quaternion._x=e.quaternion._x,t.quaternion._y=e.quaternion._y,t.quaternion._z=e.quaternion._z,t.quaternion._w=e.quaternion._w}t.drawCls.draw()}async execCommandsBase(e,t,i,s){let n,r=this.icn3d,a=r.icn3dui,o=this;for(n=e;n<=t;++n){let s=n===i-1;if(!r.commands[n]||!r.commands[n].trim())continue;if(0==(r.atoms?Object.keys(r.atoms).length:0)&&-1==r.commands[n].indexOf("load"))continue;let l=r.commands[n].split("|||"),d=l[0].trim();if(-1!==d.indexOf("load")){if(0===t&&e===t)return void(r.bNotLoadStructure?(r.hAtoms=a.hashUtilsCls.cloneHash(r.atoms),1===r.commands.length&&(r.bAddCommands=!0),s&&this.renderFinalStep(i)):(await o.applyCommandLoad(r.commands[n]),1===r.commands.length&&(r.bAddCommands=!0),s&&o.renderFinalStep(i)));r.bNotLoadStructure?(r.hAtoms=a.hashUtilsCls.cloneHash(r.atoms),r.backForward&&this.renderFinalStep(1)):(await o.applyCommandLoad(r.commands[n]),r.backForward&&o.renderFinalStep(1))}else if(0==d.indexOf("set map")&&-1==d.indexOf("set map wireframe"))await o.applyCommandMap(l[0].trim());else if(0==d.indexOf("set emmap")&&-1==d.indexOf("set emmap wireframe")){let e=l[0].trim().substr(10).split(" ");2==e.length&&"percentage"==e[0]&&(e[1],await o.applyCommandEmmap(l[0].trim()))}else if(0==d.indexOf("set phi"))await r.delphiCls.applyCommandPhi(l[0].trim());else if(0==d.indexOf("set delphi"))await r.delphiCls.applyCommandDelphi(l[0].trim());else if(0==d.indexOf("view annotations"))Object.keys(r.proteins).length>0&&await o.applyCommandAnnotationsAndCddSite(l[0].trim());else if(0==d.indexOf("set annotation clinvar"))Object.keys(r.proteins).length>0&&await o.applyCommandClinvar(l[0].trim());else if(0==d.indexOf("set annotation snp"))Object.keys(r.proteins).length>0&&await o.applyCommandSnp(l[0].trim());else if(0==d.indexOf("set annotation ptm"))Object.keys(r.proteins).length>0&&await o.applyCommandPTM(l[0].trim());else if(0==d.indexOf("ig template")){let e=d.substr(d.lastIndexOf(" ")+1);await a.htmlCls.clickMenuCls.setIgTemplate(e)}else if(0==d.indexOf("set annotation 3ddomain"))Object.keys(r.proteins).length>0&&o.applyCommand3ddomain(l[0].trim());else if(0==d.indexOf("set annotation all"))Object.keys(r.proteins).length>0&&(await o.applyCommandClinvar(l[0].trim()),await o.applyCommandSnp(l[0].trim()),o.applyCommand3ddomain(l[0].trim())),await r.annotationCls.setAnnoTabAll();else if(0==d.indexOf("view interactions")&&void 0!==a.cfg.align)await o.applyCommandViewinteraction(l[0].trim());else if(0==d.indexOf("view 2d depiction"))await r.ligplotCls.drawLigplot(r.atoms,!0);else if(0==d.indexOf("symmetry")){r.bAxisOnly=!1;let e=d.substr(d.indexOf(" ")+1);r.symmetrytitle="none"===e?void 0:e,"none"!==e&&await r.symdCls.retrieveSymmetry(Object.keys(r.structures)[0]),r.drawCls.draw()}else if(0==d.indexOf("symd symmetry"))r.bAxisOnly=!1,await r.symdCls.applyCommandSymd(d),r.drawCls.draw();else if(0==d.indexOf("scap"))await r.scapCls.applyCommandScap(d);else if(0==d.indexOf("realign on seq align"))this.getNameArray(d),await o.applyCommandRealign(d);else if(0==d.indexOf("realign on structure align msa")){let e=this.getNameArray(d);a.cfg.aligntool="vast",await r.realignParserCls.realignOnStructAlignMsa(e)}else if(0==d.indexOf("realign on structure align"))this.getNameArray(d),a.cfg.aligntool="vast",await r.realignParserCls.realignOnStructAlign();else if(0==d.indexOf("realign on tmalign msa")){let e=this.getNameArray(d);a.cfg.aligntool="tmalign",await r.realignParserCls.realignOnStructAlignMsa(e)}else if(0==d.indexOf("realign on tmalign"))this.getNameArray(d),a.cfg.aligntool="tmalign",await r.realignParserCls.realignOnStructAlign();else if(0==d.indexOf("realign on vastplus"))o.getHAtoms(r.commands[n]),await r.vastplusCls.realignOnVastplus();else if(0==d.indexOf("graph interaction pairs"))await o.applyCommandGraphinteraction(d);else if(0==d.indexOf("cartoon 2d domain"))r.bRender=!0,o.updateTransformation(i),await o.applyCommandCartoon2d(d),r.bRender=!1;else if(0==d.indexOf("set half pae map"))await o.applyCommandAfmap(d);else if(0==d.indexOf("set full pae map"))await o.applyCommandAfmap(d,!0);else if(0==d.indexOf("export pqr"))await a.htmlCls.setHtmlCls.exportPqr();else if(0==d.indexOf("cartoon 2d chain")||0==d.indexOf("cartoon 2d secondary")){let e=d.lastIndexOf(" "),t=d.substr(e+1);r.bRender=!0,o.updateTransformation(i),await r.cartoon2dCls.draw2Dcartoon(t),r.bRender=!1}else if(0==d.indexOf("add msa track")){let e=d.split(" | "),t=e[1].substr(8),i=e[2].substr(9),s=e[3].substr(5),n=e[4].substr(10);$("#"+r.pre+"anno_custom")[0]&&($("#"+r.pre+"anno_custom")[0].checked=!0),$("[id^="+r.pre+"custom]").show(),await r.addTrackCls.addMsaTracks(t,i,s,n)}else if(0==d.indexOf("add exon track")){let e=d.split(" | "),t=e[1].substr(8),i=e[2].substr(7),s=parseInt(e[3].substr(9)),n=e[4].substr(5);$("#"+r.pre+"anno_custom")[0]&&($("#"+r.pre+"anno_custom")[0].checked=!0),$("[id^="+r.pre+"custom]").show(),await r.addTrackCls.addExonTracks(t,i,s,n)}else await r.applyCommandCls.applyCommand(r.commands[n])}(n===i||s)&&this.renderFinalStep(n)}pressCommandtext(){let e=this.icn3d,t=e.icn3dui,i=this;$("#"+e.pre+"logtext").keypress((async function(e){let s=i.icn3d;if(s.bAddLogs=!1,13==(e.keyCode?e.keyCode:e.which)){e.preventDefault();let n=$(this).val();s.bRender=!0;let r=n.split("\n"),a=s.logs.length;for(let e=a,n=r.length;e<n;++e){let n=e==a?r[e].substr(2).trim():r[e].trim();if(""===n)continue;s.logs.push(n);let o={};if(o.factor=s._zoomFactor,o.mouseChange=s.mouseChange,o.quaternion=s.quaternion,s.commands.push(n+"|||"+s.transformCls.getTransformationStr(o)),s.optsHistory.push(t.hashUtilsCls.cloneHash(s.opts)),s.optsHistory[s.optsHistory.length-1].hlatomcount=Object.keys(s.hAtoms).length,t.utilsCls.isSessionStorageSupported()&&s.setStyleCls.saveCommandsToSession(),s.STATENUMBER=s.commands.length,-1!==n.indexOf("load"))await i.applyCommandLoad(n);else if(-1!==n.indexOf("set map")&&-1===n.indexOf("set map wireframe"))await i.applyCommandMap(n);else if(-1!==n.indexOf("set emmap")&&-1===n.indexOf("set emmap wireframe"))await i.applyCommandEmmap(n);else if(-1!==n.indexOf("set phi"))await s.delphiCls.applyCommandPhi(n);else if(-1!==n.indexOf("set delphi"))await s.delphiCls.applyCommandDelphi(n);else if(0==n.indexOf("view annotations"))await i.applyCommandAnnotationsAndCddSite(n);else if(0==n.indexOf("set annotation clinvar"))await i.applyCommandClinvar(n);else if(0==n.indexOf("set annotation snp"))await i.applyCommandSnp(n);else if(0==n.indexOf("set annotation ptm"))await i.applyCommandPTM(n);else if(0==n.indexOf("ig refnum on"))s.bRunRefnumAgain=!0,s.bAnnoShown||await s.showAnnoCls.showAnnotations(),await s.annotationCls.setAnnoTabIg(!0),s.bRunRefnumAgain=!1;else if(0==n.indexOf("set annotation 3ddomain"))i.applyCommand3ddomain(n);else if(0==n.indexOf("set annotation all"))await i.applyCommandClinvar(n),await i.applyCommandSnp(n),i.applyCommand3ddomain(n),await s.annotationCls.setAnnoTabAll();else if(0==n.indexOf("view interactions")&&void 0!==t.cfg.align)await i.applyCommandViewinteraction(n);else if(0==n.indexOf("view 2d depiction"))await s.ligplotCls.drawLigplot(s.atoms,!0);else if(0==n.indexOf("symmetry")){let e=n.substr(n.indexOf(" ")+1);s.symmetrytitle="none"===e?void 0:e,"none"!==e&&void 0===s.symmetryHash&&await s.symdCls.retrieveSymmetry(Object.keys(s.structures)[0])}else if(0==n.indexOf("symd symmetry"))await s.symdCls.applyCommandSymd(n);else if(0==n.indexOf("scap "))await s.scapCls.applyCommandScap(n);else if(0==n.indexOf("realign on seq align")){let e=n.split(" | ");if(2==e.length){let t=e[1].split(",");s.hAtoms=s.definedSetsCls.getAtomsFromNameArray(t)}await i.applyCommandRealign(n)}else if(0==n.indexOf("realign on structure align")){let e=n.split(" | ");if(2==e.length){let t=e[1].split(",");s.hAtoms=s.definedSetsCls.getAtomsFromNameArray(t)}t.cfg.aligntool="vast",await i.applyCommandRealignByStruct(n)}else if(0==n.indexOf("realign on tmalign")){let e=n.split(" | ");if(2==e.length){let t=e[1].split(",");s.hAtoms=s.definedSetsCls.getAtomsFromNameArray(t)}t.cfg.aligntool="tmalign",await i.applyCommandRealignByStruct(n)}else if(0==n.indexOf("realign on vastplus")){let e=n.split(" | ");if(2==e.length){let t=e[1].split(",");s.hAtoms=s.definedSetsCls.getAtomsFromNameArray(t)}await s.vastplusCls.realignOnVastplus()}else 0==n.indexOf("graph interaction pairs")?await i.applyCommandGraphinteraction(n):await s.applyCommandCls.applyCommand(n+"|||"+s.transformCls.getTransformationStr(o))}s.selectionCls.saveSelectionIfSelected(),s.drawCls.draw(),$("#"+s.pre+"logtext").val("> "+s.logs.join("\n> ")+"\n> ").scrollTop($("#"+s.pre+"logtext")[0].scrollHeight)}s.bAddLogs=!0}))}async applyCommandLoad(e){let t=this.icn3d,i=t.icn3dui;t.bAddCommands=!1;let s=e.split("|||")[0].replace(/\s\s/g," ").trim();if(-1!==s.indexOf("load")){let e=s.split(" | "),n=e[0];if(e.length>1&&!i.cfg.inpara){let t=e[e.length-1].indexOf(" ");i.cfg.inpara=e[e.length-1].substr(t+1),"undefined"===i.cfg.inpara&&(i.cfg.inpara="")}let r=n.substr(n.lastIndexOf(" ")+1);4==r.length&&(r=r.toUpperCase());let a=r.split(","),o="";for(let e=0,i=a.length;e<i;++e)t.structures&&(t.structures.hasOwnProperty(a[e])||t.structures.hasOwnProperty(a[e].toLowerCase())||t.structures.hasOwnProperty(a[e].toUpperCase()))||(o&&(o+=","),o+=a[e]);if(r=o,t.bInputPNGWithData||!r)return;if(t.inputid=r,-1!==s.indexOf("load mmtf"))i.cfg.mmtfid=r,await t.bcifParserCls.downloadBcif(r);else if(-1!==s.indexOf("load bcif"))i.cfg.bcifid=r,await t.bcifParserCls.downloadBcif(r);else if(-1!==s.indexOf("load pdb"))i.cfg.pdbid=r,await t.pdbParserCls.downloadPdb(r);else if(-1!==s.indexOf("load af"))i.cfg.afid=r,await t.pdbParserCls.downloadPdb(r,!0);else if(-1!==s.indexOf("load opm"))i.cfg.opmid=r,await t.opmParserCls.downloadOpm(r);else if(-1!==s.indexOf("load mmcif"))i.cfg.mmcifid=r,await t.mmcifParserCls.downloadMmcif(r);else if(-1!==s.indexOf("load mmdb ")||-1!==s.indexOf("load mmdb1 "))i.cfg.mmdbid=r,i.cfg.bu=1,await t.mmdbParserCls.downloadMmdb(r);else if(-1!==s.indexOf("load mmdb0"))i.cfg.mmdbid=r,i.cfg.bu=0,await t.mmdbParserCls.downloadMmdb(r);else if(-1!==s.indexOf("load mmdbaf1"))i.cfg.mmdbafid=r,i.cfg.bu=1,await t.chainalignParserCls.downloadMmdbAf(r);else if(-1!==s.indexOf("load mmdbaf0"))i.cfg.mmdbafid=r,i.cfg.bu=0,await t.chainalignParserCls.downloadMmdbAf(r);else if(-1!==s.indexOf("load gi"))i.cfg.gi=r,await t.mmdbParserCls.downloadGi(r);else if(-1!==s.indexOf("load refseq"))i.cfg.refseqid=r,await t.mmdbParserCls.downloadRefseq(r);else if(-1!==s.indexOf("load protein"))i.cfg.protein=r,await t.mmdbParserCls.downloadProteinname(r);else if(-1!==s.indexOf("load seq_struct_ids "))t.bSmithwm=!1,t.bLocalSmithwm=!1,await t.mmdbParserCls.downloadBlast_rep_id(r);else if(-1!==s.indexOf("load seq_struct_ids_smithwm "))t.bSmithwm=!0,await t.mmdbParserCls.downloadBlast_rep_id(r);else if(-1!==s.indexOf("load seq_struct_ids_local_smithwm "))t.bLocalSmithwm=!0,await t.mmdbParserCls.downloadBlast_rep_id(r);else if(-1!==s.indexOf("load cid"))i.cfg.cid=r,await t.sdfParserCls.downloadCid(r);else if(-1!==s.indexOf("load smiles"))i.cfg.smiles=r,await t.sdfParserCls.downloadSmiles(r);else if(-1!==s.indexOf("load alignment"))if(i.cfg.align=r,i.cfg.inpara||-1==i.cfg.inpara.indexOf("atype=2"))await t.alignParserCls.downloadAlignment(i.cfg.align);else{let e=2;await t.chainalignParserCls.downloadMmdbAf(i.cfg.align,void 0,e)}else if(-1!==s.indexOf("load chainalignment")){let e=s.split(" | ");e.length>1&&-1!=e[1].indexOf("resnum")&&(i.cfg.resnum=e[1].substr(e[1].indexOf("resnum")+7)),e.length>2&&-1!=e[2].indexOf("resdef")&&(i.cfg.resdef=e[2].substr(e[2].indexOf("resdef")+7)),e.length>3&&-1!=e[3].indexOf("aligntool")&&(i.cfg.aligntool=e[3].substr(e[3].indexOf("aligntool")+10)),e.length>5&&-1!=e[5].indexOf("resrange")&&(i.cfg.resrange=e[5].substr(e[5].indexOf("resrange")+9)),i.cfg.chainalign=r,await t.chainalignParserCls.downloadChainalignment(r)}else if(-1!==s.indexOf("load url")){let s=e[1],n=void 0!==s?s.indexOf("type "):-1,a="pdb";-1!==n&&(a=s.substr(n+5)),i.cfg.url=r,await t.pdbParserCls.downloadUrl(r,a)}}t.bAddCommands=!0}async applyCommandMap(e){let t=this.icn3d;t.icn3dui;let i=e.split(" | "),s=i[0].substr(8).split(" ");if("sigma"==s[1]){let e=s[2],n=s[0],r="dsn6";if(5==s.length&&(r=s[4]),2==i.length){let s=!0;"dsn6"==r?await t.densityCifParserCls.densityCifParserBase(i[1],n,e,"url",s):"ccp4"==r?await t.ccp4ParserCls.ccp4ParserBase(i[1],n,e,"url",s):"mtz"==r?await t.mtzParserCls.mtzParserBase(i[1],n,e,"url",s):"rcsbmtz"==r&&await t.mtzParserCls.mtzParserBase(i[1],n,e,"url",s,!0)}else await t.densityCifParserCls.densityCifParser(t.inputid,n,e)}}async applyCommandEmmap(e){let t=this.icn3d;t.icn3dui;let i=e.substr(10).split(" ");if(2==i.length&&"percentage"==i[0]){let e=i[1],s="em";await t.densityCifParserCls.densityCifParser(t.inputid,s,e,t.emd)}}async applyCommandRealign(e){let t=this.icn3d;t.icn3dui,await t.realignParserCls.realignOnSeqAlign()}async applyCommandRealignByStruct(e){let t=this.icn3d;t.icn3dui,t.drawCls.draw(),await t.realignParserCls.realignOnStructAlign()}async applyCommandAfmap(e,t){let i=this.icn3d;i.icn3dui;let s=e.substr(e.lastIndexOf(" ")+1);await i.contactMapCls.afErrorMap(s,t)}async applyCommandGraphinteraction(e){let t=this.icn3d;t.icn3dui;let i=e.split(" | ");if(i.length>=3){let e,s=i[1].split(" "),n=s[0].split(","),r=s[1].split(","),a=-1!==i[2].indexOf("hbonds"),o=-1!==i[2].indexOf("salt bridge"),l=-1!==i[2].indexOf("interactions"),d=-1!==i[2].indexOf("halogen"),c=-1!==i[2].indexOf("pi-cation"),h=-1!==i[2].indexOf("pi-stacking");i.length>=4&&(e="true"==i[3]),t.applyCommandCls.setStrengthPara(i),await t.viewInterPairsCls.viewInteractionPairs(n,r,e,"graph",a,o,l,d,c,h)}}async applyCommandCartoon2d(e){let t=this.icn3d;t.icn3dui;let i=e.substr(e.lastIndexOf(" ")+1);await t.cartoon2dCls.draw2Dcartoon(i)}async applyCommandAnnotationsAndCddSite(e){let t=this.icn3d;t.icn3dui,"view annotations"==e&&await t.showAnnoCls.showAnnotations()}async applyCommandClinvar(e){let t=this.icn3d;t.icn3dui;let i=e.lastIndexOf(" ");e.substr(i+1),await t.annotationCls.setAnnoTabClinvar()}async applyCommandSnp(e){let t=this.icn3d;t.icn3dui;let i=e.lastIndexOf(" ");e.substr(i+1),await t.annotationCls.setAnnoTabSnp()}async applyCommandPTM(e){let t=this.icn3d;t.icn3dui;let i=e.lastIndexOf(" ");e.substr(i+1),await t.annotationCls.setAnnoTabPTM()}applyCommand3ddomain(e){let t=this.icn3d;t.icn3dui;let i=e.lastIndexOf(" "),s=e.substr(i+1);"3ddomain"!=s&&"all"!=s||t.annotationCls.setAnnoTab3ddomain()}async applyCommandViewinteraction(e){let t=this.icn3d,i=t.icn3dui;if(void 0!==i.cfg.align||void 0!==i.cfg.chainalign){let e=Object.keys(t.structures);await t.ParserUtilsCls.set2DDiagramsForAlign(e[0].toUpperCase(),e[1].toUpperCase())}}async renderFinalStep(e){let t=this.icn3d,i=t.icn3dui;t.bCommandLoad=!1,t.ParserUtilsCls.hideLoading(),e+1===t.commands.length&&(t.bAddCommands=!0),t.bRender=!0;let s=t.commands[e-1]?t.commands[e-1].split("|||"):[];if(2==s.length){let e=JSON.parse(s[1]);t._zoomFactor=e.factor,t.mouseChange.x=e.mouseChange.x,t.mouseChange.y=e.mouseChange.y,t.quaternion._x=e.quaternion._x,t.quaternion._y=e.quaternion._y,t.quaternion._z=e.quaternion._z,t.quaternion._w=e.quaternion._w}if(t.selectionCls.oneStructurePerWindow(),1===e||t.hAtoms&&t.atoms&&Object.keys(t.hAtoms).length===Object.keys(t.atoms).length||void 0!==t.optsHistory[e-1]&&t.optsHistory[e-1].hasOwnProperty("hlatomcount")&&t.optsHistory[e-1].hlatomcount===Object.keys(t.atoms).length)if(t.optsHistory.length>=e){let i=t.optsHistory[e-1].pk;"no"===i?t.pk=0:"atom"===i?t.pk=1:"residue"===i?t.pk=2:"strand"===i&&(t.pk=3),t.hlUpdateCls.updateHlAll(),t.drawCls.draw()}else t.hlUpdateCls.updateHlAll(),t.drawCls.draw();else t.hlUpdateCls.updateHlAll(),t.drawCls.draw();(i.cfg.closepopup||i.cfg.imageonly)&&(setTimeout((function(){t.resizeCanvasCls.closeDialogs()}),100),t.resizeCanvasCls.resizeCanvas(i.htmlCls.WIDTH,i.htmlCls.HEIGHT,!0)),i.cfg.showlogo||$("#ncbi_logo").hide(),t.bTransparentSurface&&t.bRender&&t.drawCls.render(),i.cfg.imageonly&&t.saveFileCls.saveFile(void 0,"png",void 0,!0)}async replayFirstStep(e){let t=this.icn3d,i=t.icn3dui;t.reinitAfterLoad(),await this.execCommandsBase(e,e,t.STATENUMBER);let s=t.commands[e],n=t.commands[e].indexOf("|");-1!=n&&(s=t.commands[e].substr(0,n));let r=s.length>20?s.substr(0,20)+"...":s,a=t.applyCommandCls.getMenuFromCmd(s);$("#"+t.pre+"replay_cmd").html("Cmd: "+r),$("#"+t.pre+"replay_menu").html("Menu: "+a),i.htmlCls.clickMenuCls.setLogCmd(s,!0),t.bCommandLoad=!1,t.ParserUtilsCls.hideLoading(),t.bRender=!0,t.drawCls.draw()}getHAtoms(e){let t=this.icn3d;t.icn3dui;let i=e.split("|||")[0].trim().split(" | ");if(2==i.length){let e=i[1].split(",");t.hAtoms=t.definedSetsCls.getAtomsFromNameArray(e)}}}class Jh{constructor(e){this.icn3d=e}async selectByCommand(e,t,i){let s=this.icn3d,n=s.icn3dui;if(0===e.indexOf("saved atoms")){let i=12,n=e.substr(i);s.definedSetsCls.selectCombinedSets(n,t)}else{let r=e.replace(/ AND /g," and ").replace(/ OR /g," or ").replace(/ or and /g," and ").replace(/ and /g," or and ").replace(/ or not /g," not ").replace(/ not /g," or not "),a=("select"===r.trim().substr(0,6)?r.trim().substr(7):r.trim()).split(" or "),o={};for(let e=0,t=a.length;e<t;++e){let t=a[e].trim().replace(/\s+/g," "),i=t.indexOf(" ");s.hAtoms={},"and"===t.substr(0,i).toLowerCase()?(await s.applyCommandCls.applyCommand("select "+t.substr(i+1)),o=n.hashUtilsCls.intHash(o,s.hAtoms)):"not"===t.substr(0,i).toLowerCase()?(await s.applyCommandCls.applyCommand("select "+t.substr(i+1)),o=n.hashUtilsCls.exclHash(o,s.hAtoms)):(await s.applyCommandCls.applyCommand("select "+t),o=n.hashUtilsCls.unionHash(o,s.hAtoms))}s.hAtoms=n.hashUtilsCls.cloneHash(o);let l=Object.keys(s.hAtoms);if(""!==t){s.selectionCls.addCustomSelection(l,t,i,e,!1);let n=[t];s.definedSetsCls.changeCustomAtoms(n)}}}selectBySpec(e,t,i,s,n){let r=this.icn3d,a=r.icn3dui;e="select"===e.trim().substr(0,6)?e.trim().substr(7):e.trim(),r.hAtoms={};let o,l=e.replace(/\s+/g," ").replace(/ AND /g," and ").split(" and "),d={},c={},h=!0;for(let e=0,t=l.length;e<t;++e){let t,i,s,n,o,p=l[e].indexOf("$"),u=l[e].indexOf("."),m=l[e].indexOf(":"),f=l[e].indexOf(":ref_"),g=l[e].indexOf("@"),b=l[e];if(-1===g?o=["*"]:(o=b.substr(g+1).split(","),b=b.substr(0,g)),-1===m&&-1===f)s="*";else if(-1!=f){if(n=b.substr(f+5),b=b.substr(0,f),!n)continue}else if(-1!=m&&(s=b.substr(m+1),b=b.substr(0,m),!s))continue;-1===u?i="*":(i=b.substr(u+1),i=i.replace(/_/g,""),b=b.substr(0,u)),-1===p?t="*":(t=b.substr(p+1),b=b.substr(0,p)),(o.length>1||1==o.length&&"*"!==o[0])&&(h=!1);let C,v,_,y,S=[],w=[];if(S="*"===t?Object.keys(r.structures):t.split(","),"*"===i){let e=Object.keys(r.chains);for(let t=0,i=e.length;t<i;++t){v=e[t],C=v.substr(0,v.indexOf("_")),-1!==S.map((function(e){return e.toLowerCase()})).indexOf(C.toLowerCase())&&w.push(v)}}else for(let e=0,t=S.length;e<t;++e){C=S[e];let t=i.split(",");for(let e in t)w.push(C+"_"+t[e])}let x=!!n,A=x?n.split(","):s.split(",");for(let t=0,i=A.length;t<i;++t){let i,s,n=!1,l=A[t].lastIndexOf("-"),h=!1,p=!1,u=!1;if(-1!==l)_=A[t].substr(0,l),y=A[t].substr(l+1),n=!0;else if(!x&&A[t].length>1&&"3"===A[t][0]&&isNaN(A[t][1])&&"-"!==A[t][0]){s=A[t].toUpperCase().substr(1),u=!0}else if(""===A[t]||isNaN(parseInt(A[t]))){if("*"===A[t])h=!0;else if("proteins"!==A[t]&&"nucleotides"!==A[t]&&"chemicals"!==A[t]&&"ions"!==A[t]&&"water"!==A[t]&&"anchors"!==A[t]&&"strands"!==A[t]&&"loops"!==A[t]){i=A[t].toUpperCase(),p=!0}}else _=A[t],y=_,n=!0;for(let l=0,m=w.length;l<m;++l)if(v=w[l],n){_=isNaN(_)?_:parseInt(_),y=isNaN(y)?y:parseInt(y);for(let t=_;t<=y;++t){let i=[];if(x){let e=r.refnum2residArray[t.toString()]?r.refnum2residArray[t.toString()]:[];for(let t=0,s=e.length;t<s;++t){let s=e[t];s.substr(0,s.lastIndexOf("_"))==v&&i.push(s)}}else{i=[v+"_"+t]}for(let t=0,s=i.length;t<s;++t){let s=i[t];0===e?d[s]=1:d.hasOwnProperty(s)||delete d[s];for(let t in r.residues[s])for(let i=0,s=o.length;i<s;++i){let s=o[i];c=this.processAtomStr(s,c,e,t)}}}}else if(v in r.chains){let n=r.chains[v];for(let i in n){r.atoms[i].resn.substr(0,3).toUpperCase();let s,n,a,l=v+"_"+r.atoms[i].resi;if(x&&(s=r.resid2refnum[l],s&&(n=r.refnumCls.rmStrandFromRefnumlabel(s),a=parseInt(n))),h||"proteins"===A[t]&&i in r.proteins||"nucleotides"===A[t]&&i in r.nucleotides||"chemicals"===A[t]&&i in r.chemicals||"ions"===A[t]&&i in r.ions||"water"===A[t]&&i in r.water||x&&s&&"anchors"===A[t]&&a%100==50||x&&s&&"strands"===A[t]&&!r.residIgLoop.hasOwnProperty(l)||x&&s&&"loops"===A[t]&&r.residIgLoop.hasOwnProperty(l)){0===e?d[l]=1:d.hasOwnProperty(l)||delete d[l];for(let t=0,s=o.length;t<s;++t){let s=o[t];c=this.processAtomStr(s,c,e,i)}}}if(p||u){let t=p?1:3,n=p?i:s,l="",h=[];for(let e=0,t=r.chainsSeq[v].length;e<t;++e){if(p)l+=1==r.chainsSeq[v][e].name.length?r.chainsSeq[v][e].name:" ";else if(u){let t=a.utilsCls.residueAbbr2Name(r.chainsSeq[v][e].name);l+=3==t.length?t:t.padEnd(3,"_")}h.push(r.chainsSeq[v][e].resi)}l=l.toUpperCase();let m=n.replace(/x/gi,"."),f=[],g=new RegExp(m,"i"),b=l,C=b.search(g),_=C/t;for(;-1!==C;)f.push(_),b=b.substr(C+t),C=b.search(g),_+=C/t+1;for(let i=0,s=f.length;i<s;++i){let s=f[i];for(let i=0,a=n.length/t;i<a;i+=t){let n=v+"_"+h[i/t+s];0===e?d[n]=1:d.hasOwnProperty(n)||delete d[n];for(let t in r.residues[n])for(let i=0,s=o.length;i<s;++i){let s=o[i];c=this.processAtomStr(s,c,e,t)}}}}}}}if(r.hAtoms=a.hashUtilsCls.cloneHash(c),0==Object.keys(r.hAtoms).length&&console.log("No residues were selected. Please try another search."),(void 0===s||s)&&r.hlUpdateCls.updateHlAll(),o=h?Object.keys(d):Object.keys(c),""!=t){r.selectionCls.addCustomSelection(o,t,i,e,h);let s=[t];n||r.definedSetsCls.changeCustomAtoms(s)}}processAtomStr(e,t,i,s){let n=this.icn3d;n.icn3dui;let r=e.length;return"*"==e.substr(r-1,1)&&r>1?e.substr(0,r-1)===n.atoms[s].name.substr(0,r-1)&&(0===i?t[s]=1:t.hasOwnProperty(s)||delete t[s]):"*"!==e&&e!==n.atoms[s].name||(0===i?t[s]=1:t.hasOwnProperty(s)||delete t[s]),t}}class Qh{constructor(e){this.icn3d=e}selectAll(){let e=this.icn3d;e.icn3dui,this.selectAll_base(),e.hlObjectsCls.removeHlObjects(),e.hlUpdateCls.removeHl2D(),e.hlUpdateCls.removeHlMenus(),e.bSelectResidue=!1,e.bSelectAlignResidue=!1,e.hlUpdateCls.removeSeqResidueBkgd(),e.hlUpdateCls.update2DdgmContent(),$("#"+e.pre+"dl_annotations > .icn3d-annotation").show(),e.definedSetsCls.setMode("all"),e.saveFileCls.showTitle()}selectAll_base(){let e=this.icn3d,t=e.icn3dui;e.hAtoms={},e.dAtoms={};for(let i in e.structures){let s=e.structures[i];for(let i=0,n=s.length;i<n;++i)e.hAtoms=t.hashUtilsCls.unionHash(e.hAtoms,e.chains[s[i]])}e.dAtoms=t.hashUtilsCls.cloneHash(e.hAtoms),e.viewSelectionAtoms=t.hashUtilsCls.cloneHash(e.hAtoms),e.ALTERNATE_STRUCTURE=-1}selectAChain(e,t,i,s){let n=this.icn3d,r=n.icn3dui;t=t.replace(/\s/g,"");let a=void 0!==i||i?"select alignChain "+e:"select chain "+e;void 0!==s&&s?(n.hAtoms=r.hashUtilsCls.unionHash(n.hAtoms,n.chains[e]),void 0===n.nameArray&&(n.nameArray=[])):(n.hAtoms={},n.nameArray=[]),n.nameArray.push(e);let o,l=i?n.alnChainsSeq[e]:n.chainsSeq[e];o=void 0===l?0:l.length;let d={};for(let t=0,i=o;t<i;++t){let i=l[t],s=e+"_"+i.resi,r=i.name;if(""!==r&&"-"!==r){d[s]=1;for(let e in n.residues[s])n.hAtoms[e]=1}}void 0!==n.defNames2Atoms&&n.defNames2Atoms.hasOwnProperty(t)||void 0!==n.defNames2Residues&&n.defNames2Residues.hasOwnProperty(t)||this.addCustomSelection(Object.keys(d),t,t,a,!0);let c=!0;i?n.hlUpdateCls.updateHlAll(void 0,void 0,s,c):n.hlUpdateCls.updateHlAll(n.nameArray,void 0,s,c)}selectResidueList(e,t,i,s,n,r){let a=this.icn3d;if(a.icn3dui,void 0!==e&&Object.keys(e).length>0){if(void 0!==s&&s?void 0===a.nameArray&&(a.nameArray=[]):(a.hAtoms={},a.nameArray=[]),r)for(let t in e)a.hAtoms[t]=1;else for(let t in e)for(let e in a.residues[t])a.hAtoms[e]=1;let o,l;t=t.replace(/\s/g,""),a.nameArray.push(t),r?(o="select "+a.resid2specCls.atoms2spec(a.hAtoms),l=!1):(o="select "+a.resid2specCls.residueids2spec(Object.keys(e)),l=!0);let d=Object.keys(e);this.addCustomSelection(d,t,i,o,l),(void 0===n||n)&&a.hlUpdateCls.updateHlAll(a.nameArray,void 0,s)}}selectMainChains(){let e=this.icn3d,t=e.icn3dui.hashUtilsCls.cloneHash(e.hAtoms);e.hAtoms=e.applyDisplayCls.selectMainChainSubset(t),e.hlUpdateCls.showHighlight()}selectSideChains(){let e=this.icn3d,t=e.icn3dui.hashUtilsCls.cloneHash(e.hAtoms);e.hAtoms=this.getSideAtoms(t),e.hlUpdateCls.showHighlight()}getSideAtoms(e){let t=this.icn3d,i=t.icn3dui,s={};for(let n in e)(t.proteins.hasOwnProperty(n)&&"N"!==t.atoms[n].name&&"H"!==t.atoms[n].name&&"C"!==t.atoms[n].name&&"O"!==t.atoms[n].name&&("CA"!==t.atoms[n].name||"C"!==t.atoms[n].elem)&&"HA"!==t.atoms[n].name||t.nucleotides.hasOwnProperty(n)&&-1===i.parasCls.nuclMainArray.indexOf(t.atoms[n].name))&&(s[n]=1);return s}selectMainSideChains(){let e=this.icn3d,t=e.icn3dui,i=e.firstAtomObjCls.getResiduesFromAtoms(e.hAtoms);e.hAtoms={};for(let s in i)e.hAtoms=t.hashUtilsCls.unionHash(e.hAtoms,e.residues[s]),e.dAtoms=t.hashUtilsCls.unionHash(e.dAtoms,e.residues[s]);e.drawCls.draw(),e.hlUpdateCls.showHighlight()}clickShow_selected(){let e=this.icn3d,t=e.icn3dui,i=this;t.myEventCls.onIds(["#"+e.pre+"show_selected","#"+e.pre+"mn2_show_selected"],"click",(function(e){i.icn3d,i.showSelection(),t.htmlCls.clickMenuCls.setLogCmd("show selection",!0)}))}clickHide_selected(){let e=this.icn3d,t=e.icn3dui,i=this;t.myEventCls.onIds("#"+e.pre+"mn2_hide_selected","click",(function(e){i.icn3d,i.hideSelection(),t.htmlCls.clickMenuCls.setLogCmd("hide selection",!0)}))}getGraphDataForDisplayed(){let e=this.icn3d;e.icn3dui;let t=JSON.parse(e.graphStr),i=e.firstAtomObjCls.getResiduesFromAtoms(e.dAtoms),s=[],n=[],r={};for(let e=0,n=t.nodes.length;e<n;++e){let n=t.nodes[e],a=n.r.substr(4);i.hasOwnProperty(a)&&(s.push(n),r[n.id]=1)}for(let e=0,i=t.links.length;e<i;++e){let i=t.links[e];r.hasOwnProperty(i.source)&&r.hasOwnProperty(i.target)&&n.push(i)}return t.nodes=s,t.links=n,e.graphStr=JSON.stringify(t),e.graphStr}updateSelectionNameDesc(){let e=this.icn3d;e.icn3dui;let t=Object.keys(e.defNames2Residues).length+Object.keys(e.defNames2Atoms).length;$("#"+e.pre+"seq_command_name").val("seq_"+t),$("#"+e.pre+"seq_command_name2").val("seq_"+t),$("#"+e.pre+"alignseq_command_name").val("alseq_"+t)}addCustomSelection(e,t,i,s,n){let r=this.icn3d;r.icn3dui,n?r.defNames2Residues[t]=e:r.defNames2Atoms[t]=e,r.defNames2Command[t]=s,r.defNames2Descr[t]=i,r.hlUpdateCls.updateHlMenus([t])}showSelection(){let e=this.icn3d,t=e.icn3dui;0==Object.keys(e.hAtoms).length&&(e.hAtoms=t.hashUtilsCls.cloneHash(e.dAtoms)),e.dAtoms=t.hashUtilsCls.cloneHash(e.hAtoms),e.viewSelectionAtoms=t.hashUtilsCls.cloneHash(e.hAtoms),e.ALTERNATE_STRUCTURE=-1;let i=e.applyCenterCls.centerAtoms(t.hashUtilsCls.hash2Atoms(e.dAtoms,e.atoms));e.maxD=i.maxD,e.maxD<5&&(e.maxD=5),e.opts.rotationcenter="display center",this.saveSelectionIfSelected(),e.drawCls.draw(),e.hlUpdateCls.update2DdgmContent(),e.hlUpdateCls.updateHl2D(),e.annotationCls.showAnnoSelectedChains(),void 0!==e.graphStr&&(e.graphStr=this.getGraphDataForDisplayed()),e.saveFileCls.showTitle()}hideSelection(){let e=this.icn3d,t=e.icn3dui;e.hAtoms=t.hashUtilsCls.exclHash(e.dAtoms,e.hAtoms),0==Object.keys(e.hAtoms).length&&(e.hAtoms=t.hashUtilsCls.cloneHash(e.dAtoms)),e.dAtoms=t.hashUtilsCls.cloneHash(e.hAtoms);let i=e.applyCenterCls.centerAtoms(t.hashUtilsCls.hash2Atoms(e.dAtoms,e.atoms));e.maxD=i.maxD,e.maxD<5&&(e.maxD=5),e.opts.rotationcenter="display center",this.saveSelectionIfSelected(),e.drawCls.draw(),e.hlUpdateCls.update2DdgmContent(),e.hlUpdateCls.updateHl2D(),e.annotationCls.showAnnoSelectedChains()}saveSelection(e,t,i){let s=this.icn3d,n=s.icn3dui;if(i||(s.selectedResidues={},s.selectedResidues=s.firstAtomObjCls.getResiduesFromCalphaAtoms(s.hAtoms)),!e){t=e="seq_"+(Object.keys(s.defNames2Atoms).length+Object.keys(s.defNames2Residues).length+1)}if(Object.keys(s.selectedResidues).length>0)if(1==s.pk){let r=!0;this.selectResidueList(s.hAtoms,e,t,void 0,void 0,r),this.updateSelectionNameDesc(),i?n.htmlCls.clickMenuCls.setLogCmd("select "+s.resid2specCls.atoms2spec(s.hAtoms),!0):n.htmlCls.clickMenuCls.setLogCmd("select "+s.resid2specCls.atoms2spec(s.hAtoms)+" | name "+e,!0)}else this.selectResidueList(s.selectedResidues,e,t,void 0,void 0,void 0),this.updateSelectionNameDesc(),i?n.htmlCls.clickMenuCls.setLogCmd("select "+s.resid2specCls.residueids2spec(Object.keys(s.selectedResidues)),!0):n.htmlCls.clickMenuCls.setLogCmd("select "+s.resid2specCls.residueids2spec(Object.keys(s.selectedResidues))+" | name "+e,!0)}saveSelInCommand(){let e=this.icn3d,t=e.icn3dui;e.selectedResidues=e.firstAtomObjCls.getResiduesFromCalphaAtoms(e.hAtoms),t.htmlCls.clickMenuCls.setLogCmd("select "+e.resid2specCls.residueids2spec(Object.keys(e.selectedResidues)),!0)}saveEachResiInSel(){let e=this.icn3d;e.icn3dui,e.selectionCls.saveSelectionPrep(),e.selectedResidues={},e.selectedResidues=e.firstAtomObjCls.getResiduesFromCalphaAtoms(e.hAtoms);for(let t in e.selectedResidues){let i={};i[t]=1;let s=t+"_"+e.selectedResidues[t];this.selectResidueList(i,s,s)}}removeSelection(){let e=this.icn3d;e.icn3dui,e.bAnnotations||e.hlUpdateCls.removeSeqChainBkgd(),e.bCtrl||e.bShift||(e.hlUpdateCls.removeSeqResidueBkgd(),e.hlUpdateCls.removeSeqChainBkgd()),e.selectedResidues={},e.bSelectResidue=!1,e.hAtoms={},e.hlObjectsCls.removeHlObjects(),e.hlUpdateCls.removeHl2D()}resetAll(){let e=this.icn3d,t=e.icn3dui;e.maxD=e.oriMaxD,e.center=e.oriCenter.clone(),e.opts=t.hashUtilsCls.cloneHash(e.optsOri),e.setOptionCls.setStyle("sidec","nothing"),e.reinitAfterLoad(),e.definedSetsCls.setMode("all"),e.selectionCls.selectAll(),t.htmlCls.clickMenuCls.setLogCmd("reset",!0),e.hlUpdateCls.removeSeqChainBkgd(),e.hlUpdateCls.removeSeqResidueBkgd(),e.hlUpdateCls.removeHl2D(),e.hlUpdateCls.removeHlMenus(),e.loadScriptCls.renderFinalStep(1)}async loadSelection(e){let t=this.icn3d,i=t.icn3dui,s=e.trim().split("\n");for(let e=0,n=s.length;e<n;++e){let n=s[e].replace(/\t/g," "),r=n.indexOf(" "),a=n.substr(0,r),o=n.substr(r+1),l=o.indexOf(" ");await t.selByCommCls.selectByCommand(o.substr(l+1),a,a),i.htmlCls.clickMenuCls.setLogCmd("select "+o.substr(l+1)+" | name "+a,!0)}}oneStructurePerWindow(){let e=this.icn3d,t=e.icn3dui,i=e.structures?Object.keys(e.structures):[];if(t.cfg.bSidebyside&&2==i.length){let s=i[Object.keys(window.icn3duiHash).indexOf(e.divid)],n=e.structures[s],r={};if(n){for(let i=0,s=n.length;i<s;++i)r=t.hashUtilsCls.unionHash(r,e.chains[n[i]]);e.dAtoms=t.hashUtilsCls.intHash(r,e.dAtoms),e.hAtoms=t.hashUtilsCls.cloneHash(e.dAtoms)}}}showAll(){var e=this.icn3d,t=e.icn3dui;e.dAtoms=t.hashUtilsCls.cloneHash(e.atoms),e.maxD=e.oriMaxD,e.drawCls.draw()}saveSelectionIfSelected(e,t){var i=this.icn3d;if(i.icn3dui,i.bSelectResidue||i.bSelectAlignResidue){let e=$("#"+i.pre+"seq_command_name2").val().replace(/\s+/g,"_");""===e&&(e=$("#"+i.pre+"alignseq_command_name").val().replace(/\s+/g,"_")),""!==e&&this.saveSelection(e,e),i.bSelectResidue=!1,i.bSelectAlignResidue=!1}}saveSelectionPrep(e){var t=this.icn3d,i=t.icn3dui;i.cfg.notebook?($("#"+t.pre+"dl_definedsets").show(),$("#"+t.pre+"atomsCustom").resizable()):$("#"+t.pre+"dl_definedsets").hasClass("ui-dialog-content")&&$("#"+t.pre+"dl_definedsets").dialog("isOpen")||(i.htmlCls.dialogCls.openDlg("dl_definedsets","Select sets"),$("#"+t.pre+"atomsCustom").resizable()),e||(t.bSelectResidue=!1,t.bSelectAlignResidue=!1)}selectOneResid(e,t){var i=this.icn3d;i.icn3dui;let s=e.split(" "),n=(e=s[1]).indexOf("$"),r=e.indexOf("."),a=e.indexOf(":"),o=e.indexOf("@");-1==o&&(o=e.length);let l=e.substr(n+1,r-n-1),d=e.substr(r+1,a-r-1),c=e.substr(a+1,o-a-1),h=l+"_"+d+"_"+c;for(let e in i.residues[h])t?delete i.hAtoms[e]:i.hAtoms[e]=1;return t?delete i.selectedResidues[h]:i.selectedResidues[h]=1,"$"+l+"."+d+":"+c}toggleSelection(){var e=this.icn3d,t=e.icn3dui;if(e.bHideSelection){for(let t in e.dAtoms)e.hAtoms.hasOwnProperty(t)&&delete e.dAtoms[t];e.bHideSelection=!1}else e.dAtoms=t.hashUtilsCls.unionHash(e.dAtoms,e.hAtoms),e.bHideSelection=!0;e.drawCls.draw()}toggleMembrane(e){var t=this.icn3d,i=t.icn3dui;let s=t.structures?Object.keys(t.structures):[];for(let n=0,r=s.length;n<r;++n){let r=s[n],a=t.residues[r+"_MEM_1"],o=t.firstAtomObjCls.getFirstAtomObj(a);if(void 0===o)continue;let l=o.style;t.dAtoms.hasOwnProperty(o.serial)||(t.dAtoms=i.hashUtilsCls.unionHash(t.dAtoms,a),l="nothing");for(let i in a){let s=t.atoms[i];s.style="nothing"!==l?"nothing":"stick",void 0!==e&&(s.style=e?"stick":"nothing")}}void 0===e&&t.drawCls.draw()}adjustMembrane(e,t){var i=this.icn3d;i.icn3dui;for(let s in i.chains[i.inputid.toUpperCase()+"_MEM"]){let n=i.atoms[s];"O"==n.name?n.coord.z=e:"N"==n.name&&(n.coord.z=t)}i.definedSetsCls.setTransmemInMenu(e,t,!0),i.hlUpdateCls.updateHlMenus(),i.drawCls.draw()}selectBtwPlanes(e,t){var i=this.icn3d;if(i.icn3dui,e<t){let i=t;t=e,e=i}let s={};for(let n in i.atoms){let r=i.atoms[n];if("DUM"!=r.resn&&(r.coord.z>=t&&r.coord.z<=e)){s[r.structure+"_"+r.chain+"_"+r.resi]=1}}let n="z_planes_"+e+"_"+t,r=n;this.selectResidueList(s,n,r,!1)}}class ep{constructor(e){this.icn3d=e}residueids2spec(e){var t=this.icn3d;t.icn3dui;let i="";if(void 0!==e){let s,n,r,a,o,l,d,c=e.sort((function(e,t){if(""!==e&&!isNaN(e))return parseInt(e)-parseInt(t);{let i=e.lastIndexOf("_"),s=t.lastIndexOf("_");if(e.substr(0,i)<t.substr(0,s))return-1;if(e.substr(0,i)>t.substr(0,s))return 1;if(e.substr(0,i)==t.substr(0,s)){if(parseInt(e.substr(i+1))<parseInt(t.substr(s+1)))return-1;if(parseInt(e.substr(i+1))>parseInt(t.substr(s+1)))return 1;if(parseInt(e.substr(i+1))==parseInt(t.substr(s+1)))return 0}}})),h="",p=0,u=1!=Object.keys(t.structures).length;for(let e=0,m=c.length;e<m;++e){let m=c[e];if(r=m.lastIndexOf("_"),s=m.substr(0,r),n=m.substr(r+1),a=h.indexOf("_"),o=h.substr(0,a),l=h.substr(a+1),isNaN(n))i+=u?"$"+o+"."+l+":"+n+" or ":"."+l+":"+n+" or ";else{if(h!==s)e>0&&(i+=p===d?u?"$"+o+"."+l+":"+d+" or ":"."+l+":"+d+" or ":u?"$"+o+"."+l+":"+d+"-"+p+" or ":"."+l+":"+d+"-"+p+" or "),d=n;else if(h===s){let e=t.ParserUtilsCls.getResiNCBI(h,p);t.ParserUtilsCls.getResiNCBI(s,n)!=e+1&&(i+=p===d?u?"$"+o+"."+l+":"+d+" or ":"."+l+":"+d+" or ":u?"$"+o+"."+l+":"+d+"-"+p+" or ":"."+l+":"+d+"-"+p+" or ",d=n)}h=s,p=n}}a=h.indexOf("_"),o=h.substr(0,a),l=h.substr(a+1),i+=p===d?u?"$"+o+"."+l+":"+d:"."+l+":"+d:u?"$"+o+"."+l+":"+d+"-"+p:"."+l+":"+d+"-"+p}return i}resi2range(e,t){this.icn3d.icn3dui;let i,s,n=[],r="",a=e,o=a[0];for(let e=0,t=a.length;e<t;++e)s=a[e],0!=e&&parseInt(s)!=parseInt(i)+1&&(n.push(o),n.push(i),r&&(r+=","),r+=o==i?o:o+"-"+i,o=s),i=s;return n.push(o),n.push(i),r&&(r+=","),r+=o==i?o:o+"-"+i,t?r:n}atoms2spec(e){var t=this.icn3d;t.icn3dui;let i,s="",n=0,r={},a={},o={};for(let l in e)i=t.atoms[l],n>0&&(s+=" or "),s+="$"+i.structure+"."+i.chain+":"+i.resi+"@"+i.name,r[i.structure]=1,a[i.structure+"_"+i.chain]=1,o[i.structure+"_"+i.chain+"_"+i.resi]=1,++n;if(1==Object.keys(o).length){let e="\\$"+i.structure+"\\."+i.chain+":"+i.resi;s=s.replace(new RegExp(e,"g"),"")}else if(1==Object.keys(a).length){let e="\\$"+i.structure+"\\."+i.chain;s=s.replace(new RegExp(e,"g"),"")}else if(1==Object.keys(r).length){let e="\\$"+i.structure;s=s.replace(new RegExp(e,"g"),"")}return s}atoms2residues(e){var t=this.icn3d;t.icn3dui;let i={};for(let t=0,s=e.length;t<s;++t)i[e[t]]=1;let s=t.firstAtomObjCls.getResiduesFromAtoms(i);return Object.keys(s)}atoms2structureArray(e){var t=this.icn3d;t.icn3dui;let i={};for(let s in e){i[t.atoms[s].structure]=1}return Object.keys(i)}selectProperty(e,t,i){var s=this.icn3d,n=s.icn3dui;let r=n.hashUtilsCls.cloneHash(s.hAtoms);if("positive"==e){let e=":r,k,h";s.hAtoms={},s.selByCommCls.selectBySpec(e,e,e)}else if("negative"==e){let e=":d,e";s.hAtoms={},s.selByCommCls.selectBySpec(e,e,e),s.hAtoms=n.hashUtilsCls.unionHash(s.hAtoms,s.nucleotides)}else if("hydrophobic"==e){let e=":w,f,y,l,i,c,m";s.hAtoms={},s.selByCommCls.selectBySpec(e,e,e),s.hAtoms=n.hashUtilsCls.intHash(s.hAtoms,s.proteins)}else if("polar"==e){let e=":g,v,s,t,a,n,p,q";s.hAtoms={},s.selByCommCls.selectBySpec(e,e,e),s.hAtoms=n.hashUtilsCls.intHash(s.hAtoms,s.proteins)}else if("b factor"==e){let e=n.hashUtilsCls.cloneHash(s.calphas);e=n.hashUtilsCls.unionHash(e,s.nucleotidesO3),e=n.hashUtilsCls.unionHash(e,s.chemicals),e=n.hashUtilsCls.unionHash(e,s.ions),e=n.hashUtilsCls.unionHash(e,s.water),s.hAtoms={};for(let r in e){let e=s.atoms[r];e.b>=parseInt(t)&&e.b<=parseInt(i)&&(s.hAtoms=n.hashUtilsCls.unionHash(s.hAtoms,s.residues[e.structure+"_"+e.chain+"_"+e.resi]))}}else if("percent out"==e){s.bCalcArea=!0,s.opts.surface="solvent accessible surface",s.applyMapCls.applySurfaceOptions(),s.bCalcArea=!1,s.hAtoms={};for(let e in s.resid2area){let r=e.lastIndexOf("_"),a=e.substr(r+1);if(n.parasCls.residueArea.hasOwnProperty(a)){let o=parseInt(s.resid2area[e]/n.parasCls.residueArea[a]*100);if(o>=t&&o<=i){let t=e.substr(0,r);s.hAtoms=n.hashUtilsCls.unionHash(s.hAtoms,s.residues[t])}}}}s.hAtoms=n.hashUtilsCls.intHash(s.hAtoms,r),s.drawCls.draw(),s.hlUpdateCls.updateHlAll()}selectComplement(){let e=this.icn3d,t=e.icn3dui,i={};for(let t in e.atoms)e.hAtoms.hasOwnProperty(t)||(i[t]=1);e.hAtoms=t.hashUtilsCls.cloneHash(i),e.hlUpdateCls.updateHlAll()}switchHighlightLevel(){var e=this.icn3d.icn3dui;if(e.bNode)return;let t=this;document.addEventListener("keydown",(function(i){let s=t.icn3d;38===i.keyCode?(i.preventDefault(),0!=Object.keys(s.pickedAtomList).length&&s.hAtoms.hasOwnProperty(s.firstAtomObjCls.getFirstAtomObj(s.pickedAtomList).serial)||(s.pickedAtomList=e.hashUtilsCls.cloneHash(s.hAtoms)),t.switchHighlightLevelUp(),e.htmlCls.clickMenuCls.setLogCmd("highlight level up",!0)):40===i.keyCode&&(i.preventDefault(),0!=Object.keys(s.pickedAtomList).length&&s.hAtoms.hasOwnProperty(s.firstAtomObjCls.getFirstAtomObj(s.pickedAtomList).serial)||(s.pickedAtomList=e.hashUtilsCls.cloneHash(s.hAtoms)),t.switchHighlightLevelDown(),e.htmlCls.clickMenuCls.setLogCmd("highlight level down",!0))}))}switchHighlightLevelUp(){var e=this.icn3d,t=e.icn3dui;if(!t.bNode){if(e.bShift||e.bCtrl||e.hlObjectsCls.removeHlObjects(),void 0!==e.pickedAtomList&&0!==Object.keys(e.pickedAtomList).length||(e.pickedAtomList=t.hashUtilsCls.cloneHash(e.hAtoms)),0===Object.keys(e.pickedAtomList).length&&(e.pickedAtomList=e.dAtoms),1===e.highlightlevel){e.highlightlevel=2;let i=e.firstAtomObjCls.getFirstAtomObj(e.pickedAtomList);e.bShift||e.bCtrl?e.hAtoms=t.hashUtilsCls.unionHash(e.hAtoms,e.residues[i.structure+"_"+i.chain+"_"+i.resi]):e.hAtoms=t.hashUtilsCls.cloneHash(e.residues[i.structure+"_"+i.chain+"_"+i.resi])}else if(2===e.highlightlevel){e.highlightlevel=3;let i=e.firstAtomObjCls.getFirstAtomObj(e.pickedAtomList);e.bShift||e.bCtrl?e.hAtoms=t.hashUtilsCls.unionHash(e.hAtoms,e.pickingCls.selectStrandHelixFromAtom(i)):e.hAtoms=t.hashUtilsCls.cloneHash(e.pickingCls.selectStrandHelixFromAtom(i))}else if(3===e.highlightlevel){let i;if(void 0!==t.cfg.mmdbid||void 0!==t.cfg.gi){e.highlightlevel=4;let s=e.firstAtomObjCls.getFirstAtomObj(e.pickedAtomList);i=e.pickingCls.select3ddomainFromAtom(s),e.bShift||e.bCtrl?e.hAtoms=t.hashUtilsCls.unionHash(e.hAtoms,i):e.hAtoms=t.hashUtilsCls.cloneHash(i)}if(void 0===t.cfg.mmdbid&&void 0===t.cfg.gi||0==Object.keys(i).length){e.highlightlevel=5;let i=e.firstAtomObjCls.getFirstAtomObj(e.pickedAtomList);e.bShift||e.bCtrl?e.hAtoms=t.hashUtilsCls.unionHash(e.hAtoms,e.chains[i.structure+"_"+i.chain]):e.hAtoms=t.hashUtilsCls.cloneHash(e.chains[i.structure+"_"+i.chain])}}else if(4===e.highlightlevel){e.highlightlevel=5;let i=e.firstAtomObjCls.getFirstAtomObj(e.pickedAtomList);e.bShift||e.bCtrl?e.hAtoms=t.hashUtilsCls.unionHash(e.hAtoms,e.chains[i.structure+"_"+i.chain]):e.hAtoms=t.hashUtilsCls.cloneHash(e.chains[i.structure+"_"+i.chain])}else if(5===e.highlightlevel||6===e.highlightlevel){e.highlightlevel=6;let i=e.firstAtomObjCls.getFirstAtomObj(e.pickedAtomList);e.bShift||e.bCtrl||(e.hAtoms={});let s=e.structures[i.structure];for(let i=0,n=s.length;i<n;++i)e.hAtoms=t.hashUtilsCls.unionHash(e.hAtoms,e.chains[s[i]])}e.hlObjectsCls.addHlObjects(),e.hlUpdateCls.updateHlAll()}}switchHighlightLevelDown(){var e=this.icn3d,t=e.icn3dui;if(!t.bNode){if(e.hlObjectsCls.removeHlObjects(),void 0!==e.pickedAtomList&&0!==Object.keys(e.pickedAtomList).length||(e.pickedAtomList=t.hashUtilsCls.cloneHash(e.hAtoms)),2!==e.highlightlevel&&1!==e.highlightlevel||1!==Object.keys(e.pickedAtomList).length){if(3===e.highlightlevel){let i={};for(let t in e.pickedAtomList)residueid=e.atoms[t].structure+"_"+e.atoms[t].chain+"_"+e.atoms[t].resi,i[residueid]=1;if(1===Object.keys(i).length){e.highlightlevel=2;let i=e.firstAtomObjCls.getFirstAtomObj(e.pickedAtomList);e.bShift||e.bCtrl?e.hAtoms=t.hashUtilsCls.unionHash(e.hAtoms,e.residues[i.structure+"_"+i.chain+"_"+i.resi]):e.hAtoms=t.hashUtilsCls.cloneHash(e.residues[i.structure+"_"+i.chain+"_"+i.resi])}}else if(4===e.highlightlevel){e.highlightlevel=3;let i=e.firstAtomObjCls.getFirstAtomObj(e.pickedAtomList);e.bShift||e.bCtrl?e.hAtoms=t.hashUtilsCls.unionHash(e.hAtoms,e.pickingCls.selectStrandHelixFromAtom(i)):e.hAtoms=t.hashUtilsCls.cloneHash(e.pickingCls.selectStrandHelixFromAtom(i))}else if(5===e.highlightlevel){let i;if(void 0!==t.cfg.mmdbid||void 0!==t.cfg.gi){e.highlightlevel=4;let s=e.firstAtomObjCls.getFirstAtomObj(e.pickedAtomList);i=e.pickingCls.select3ddomainFromAtom(s),e.bShift||e.bCtrl?e.hAtoms=t.hashUtilsCls.unionHash(e.hAtoms,i):e.hAtoms=t.hashUtilsCls.cloneHash(i)}if(void 0===t.cfg.mmdbid&&void 0===t.cfg.gi||0==Object.keys(i).length){e.highlightlevel=3;let i=e.firstAtomObjCls.getFirstAtomObj(e.pickedAtomList);e.bShift||e.bCtrl?e.hAtoms=t.hashUtilsCls.unionHash(e.hAtoms,e.pickingCls.selectStrandHelixFromAtom(i)):e.hAtoms=t.hashUtilsCls.cloneHash(e.pickingCls.selectStrandHelixFromAtom(i))}}else if(6===e.highlightlevel){e.highlightlevel=5;let i=e.firstAtomObjCls.getFirstAtomObj(e.pickedAtomList);e.bShift||e.bCtrl?e.hAtoms=t.hashUtilsCls.unionHash(e.hAtoms,e.chains[i.structure+"_"+i.chain]):e.hAtoms=t.hashUtilsCls.cloneHash(e.chains[i.structure+"_"+i.chain])}}else e.highlightlevel=1,e.hAtoms=t.hashUtilsCls.cloneHash(e.pickedAtomList),e.bShift||e.bCtrl?e.hAtoms=t.hashUtilsCls.unionHash(e.hAtoms,e.pickedAtomList):e.hAtoms=t.hashUtilsCls.cloneHash(e.pickedAtomList);e.hlObjectsCls.addHlObjects(),e.hlUpdateCls.updateHlAll()}}}class tp{constructor(e){this.icn3d=e}async CalcPhiUrl(e,t,i,s,n){let r=this.icn3d.icn3dui,a=await r.getXMLHttpRqstPromise(n,"GET","text","PQR");await this.CalcPhi(e,t,i,s,a)}getPdbStr(e){let t=this.icn3d,i=t.icn3dui,s={},n={},r=i.hashUtilsCls.intHash(t.dAtoms,t.hAtoms);for(let e in r)t.atoms[e],t.ions.hasOwnProperty(e)?s[e]=1:n[e]=1;let a=Object.keys(n).length;if(i.utilsCls.isCalphaPhosOnly(i.hashUtilsCls.hash2Atoms(n,t.atoms)))return void(e?console.log("The potential will not be shown because the side chains are missing in the structure..."):alert("The potential will not be shown because the side chains are missing in the structure..."));if(a>3e4)return void(e?console.log("The maximum number of allowed atoms is 30,000. Please try it again with selected chains..."):alert("The maximum number of allowed atoms is 30,000. Please try it again with selected chains..."));let o="",l=!0,d=!0;return o+=i.cfg.cid?t.saveFileCls.getAtomPDB(n,!0,void 0,void 0,void 0,void 0,l,d):t.saveFileCls.getAtomPDB(n,void 0,void 0,void 0,void 0,void 0,l,d),o+=t.saveFileCls.getAtomPDB(s,!0,void 0,!0,void 0,void 0,l,d),o}async CalcPhi(e,t,i,s,n){let r=this.icn3d;r.icn3dui;let a=await this.CalcPhiPrms(e,t,i,s,n);this.loadPhiData(a,i,s),r.bAjaxPhi=!0,s?r.setOptionCls.setOption("phisurface","phi"):r.setOptionCls.setOption("phimap","phi")}CalcPhiPrms(e,t,i,s,n){let r=this.icn3d,a=r.icn3dui;r.loadPhiFrom="delphi";let o=a.htmlCls.baseUrl+"delphi/delphi.cgi",l=a.cfg.cid?a.cfg.cid:Object.keys(r.structures).toString(),d={};if(n)d={pqr2phi:n,gsize:e,salt:t,pdbid:l};else{let i=this.getPdbStr();d={pdb2phi:i,gsize:e,salt:t,pdbid:l}}return new Promise((function(e,t){$.ajax({url:o,type:"POST",data:d,dataType:"binary",responseType:"arraybuffer",cache:!0,beforeSend:function(){r.ParserUtilsCls.showLoading()},complete:function(){r.ParserUtilsCls.hideLoading()},success:function(t){e(t)},error:function(e,t,i){}})}))}async PhiParser(e,t,i,s){let n,r=this.icn3d,a=r.icn3dui,o=this;n="phiurl"==t||"phiurl2"==t?"arraybuffer":"text";let l=await a.getXMLHttpRqstPromise(e,"GET",n,"potential");"phiurl"==t||"phiurl2"==t?o.loadPhiData(l,i,s):o.loadCubeData(l,i,s),r.bAjaxPhi=!0,s?r.setOptionCls.setOption("phisurface","phi"):r.setOptionCls.setOption("phimap","phi")}loadPhiData(e,t,i){let s=this.icn3d;s.icn3dui;let n={filetype:"phi"},r=e.buffer&&e.buffer instanceof ArrayBuffer?e.buffer:e,a=new Float32Array(r.slice(r.byteLength-24,r.byteLength-8));n.scale=a[0];let o=a[1],l=a[2],d=a[3];n.n=new Int32Array(r.slice(r.byteLength-8,r.byteLength-4)),n.xExtent=n.yExtent=n.zExtent=n.n;let c=1/n.scale*((n.n-1)/2);n.ori=new mt(o-c,l-c,d-c);let h=new Float32Array(r.slice(110,r.byteLength-56));n.bSurface=i,s.mapData.headerPhi=n,s.mapData.dataPhi=h,s.mapData.contourPhi=t;let p=new gi;p.identity(),p.multiply((new gi).makeTranslation(n.ori.x,n.ori.y,n.ori.z)),s.mapData.matrixPhi=p}loadCubeData(e,t,i){let s=this.icn3d;s.icn3dui;let n={filetype:"cube"},r=e.split("\n"),a=[];a.push(parseFloat(r[0].substr(0,10))),a.push(parseFloat(r[0].substr(10,6))),a.push(parseFloat(r[0].substr(16,10))),a.push(parseFloat(r[0].substr(26,10))),a.push(parseFloat(r[0].substr(36,10))),n.scale=a[0];let o=a[2],l=a[3],d=a[4];n.n=a[1],n.xExtent=n.yExtent=n.zExtent=n.n;let c=1/n.scale*((n.n-1)/2);n.ori=new mt(o-c,l-c,d-c);let h=[];for(let e=7,t=r.length;e<t;++e){let t=r[e].split(/\s+/);for(let e=0,i=t.length;e<i;++e){let i=parseFloat(t[e]);isNaN(i)||h.push(i)}}h.length!=n.n*n.n*n.n&&console.log("the data array size "+h.length+" didn't match the grid size "+n.n*n.n*n.n+"..."),n.bSurface=i,s.mapData.headerPhi=n,s.mapData.dataPhi=h,s.mapData.contourPhi=t;let p=new gi;p.identity(),p.multiply((new gi).makeTranslation(n.ori.x,n.ori.y,n.ori.z)),s.mapData.matrixPhi=p}async applyCommandPhi(e){let t=this.icn3d;t.icn3dui;let i=this,s=e.split(" | "),n=s[0].split(" "),r=s[1].split(" "),a=s[2].split(" "),o=s[3].split(" "),l=s[4].split(" "),d=n[2],c=parseFloat(r[1]),h=a[1],p=o[1],u=l[1];if(8==s.length){let e=s[5].split(" "),i=s[6].split(" "),n=s[7].split(" ");t.phisurftype=e[1],t.phisurfop=parseFloat(i[1]),t.phisurfwf=n[1],$("#"+t.pre+"delphisurftype").val(t.phisurftype),$("#"+t.pre+"delphisurfop").val(t.phisurfop),$("#"+t.pre+"delphisurfwf").val(t.phisurfwf)}let m="pqrurl2"==d||"phiurl2"==d||"cubeurl2"==d;"pqrurl"==d||"pqrurl2"==d?await i.CalcPhiUrl(p,u,c,m,h):await i.PhiParser(h,d,c,m)}async applyCommandDelphi(e){let t=this.icn3d;t.icn3dui;let i=e.split(" | "),s=i[0].split(" "),n=i[1].split(" "),r=i[2].split(" "),a=i[3].split(" "),o=s[2],l=n[1],d=r[1],c=a[1];if($("#"+t.pre+"delphi1gsize").val(d),$("#"+t.pre+"delphi1salt").val(c),$("#"+t.pre+"delphi2gsize").val(d),$("#"+t.pre+"delphi2salt").val(c),7==i.length){let e=i[4].split(" "),s=i[5].split(" "),n=i[6].split(" ");t.phisurftype=e[1],t.phisurfop=s[1],t.phisurfwf=n[1],$("#"+t.pre+"delphisurftype").val(t.phisurftype),$("#"+t.pre+"delphisurfop").val(t.phisurfop),$("#"+t.pre+"delphisurfwf").val(t.phisurfwf)}let h="surface"==o;await this.CalcPhi(d,c,l,h)}async loadDelphiFile(e){let t=this.icn3d,i=t.icn3dui,s="delphi2"==e?$("#"+t.pre+"delphi2gsize").val():$("#"+t.pre+"delphi1gsize").val(),n="delphi2"==e?$("#"+t.pre+"delphi2salt").val():$("#"+t.pre+"delphi1gsize").val(),r="delphi2"==e?$("#"+t.pre+"delphicontour2").val():$("#"+t.pre+"delphicontour").val(),a="delphi2"==e;await this.CalcPhi(s,n,r,a);let o="delphi2"==e?"surface":"map";a?i.htmlCls.clickMenuCls.setLogCmd("set delphi "+o+" | contour "+r+" | gsize "+s+" | salt "+n+" | surface "+t.phisurftype+" | opacity "+t.phisurfop+" | wireframe "+t.phisurfwf,!0):i.htmlCls.clickMenuCls.setLogCmd("set delphi "+o+" | contour "+r+" | gsize "+s+" | salt "+n,!0)}loadPhiFile(e){let t,i=this.icn3d,s=i.icn3dui,n=this;"pqr"==e||"phi"==e||"cube"==e?t=$("#"+i.pre+e+"file")[0].files[0]:"pqr2"==e?t=$("#"+i.pre+"pqrfile2")[0].files[0]:"phi2"==e?t=$("#"+i.pre+"phifile2")[0].files[0]:"cube2"==e&&(t=$("#"+i.pre+"cubefile2")[0].files[0]);let r="pqr"==e||"phi"==e||"cube"==e?$("#"+i.pre+"phicontour").val():$("#"+i.pre+"phicontour2").val();if(t){s.utilsCls.checkFileAPI();let i=new FileReader;i.onload=async function(t){let i=n.icn3d,a=t.target.result,o=0,l=0;if("pqr"==e||"pqr2"==e){let t="pqr2"==e;o=$("#"+i.pre+e+"gsize").val(),l=$("#"+i.pre+e+"salt").val(),await n.CalcPhi(o,l,r,t,a)}else if("phi"==e||"phi2"==e){let t="phi2"==e;n.loadPhiData(a,r,t)}else if("cube"==e||"cube2"==e){let t="cube2"==e;n.loadCubeData(a,r,t)}i.bAjaxPhi=!0,bSurface?i.setOptionCls.setOption("phisurface","phi"):i.setOptionCls.setOption("phimap","phi"),bSurface?s.htmlCls.clickMenuCls.setLogCmd("load phi "+e+" | contour "+r+" | file "+$("#"+i.pre+e+"file").val()+" | gsize "+o+" | salt "+l+" | surface "+i.phisurftype+" | opacity "+i.phisurfop+" | wireframe "+i.phisurfwf,!1):s.htmlCls.clickMenuCls.setLogCmd("load phi "+e+" | contour "+r+" | file "+$("#"+i.pre+e+"file").val()+" | gsize "+o+" | salt "+l,!1)},"phi"==e||"phi2"==e?i.readAsArrayBuffer(t):i.readAsText(t)}else alert("Please select a file before clicking 'Load'")}async loadPhiFileUrl(e){let t,i=this.icn3d,s=i.icn3dui;"pqrurl"==e||"phiurl"==e||"cubeurl"==e?t=$("#"+i.pre+e+"file").val():"pqrurl2"==e?t=$("#"+i.pre+"pqrurlfile2").val():"phiurl2"==e?t=$("#"+i.pre+"phiurlfile2").val():"cubeurl2"==e&&(t=$("#"+i.pre+"cubeurlfile2").val());let n="pqrurl"==e||"phiurl"==e||"cubeurl"==e?$("#"+i.pre+"phiurlcontour").val():$("#"+i.pre+"phiurlcontour2").val();if(t){let r="pqrurl2"==e||"phiurl2"==e||"cubeurl2"==e,a=0,o=0;"pqrurl"==e||"pqrurl2"==e?(a=$("#"+i.pre+e+"gsize").val(),o=$("#"+i.pre+e+"salt").val(),await this.CalcPhiUrl(a,o,n,r,t)):await this.PhiParser(t,e,n,r),r?s.htmlCls.clickMenuCls.setLogCmd("set phi "+e+" | contour "+n+" | url "+encodeURIComponent(t)+" | gsize "+a+" | salt "+o+" | surface "+i.phisurftype+" | opacity "+i.phisurfop+" | wireframe "+i.phisurfwf,!0):s.htmlCls.clickMenuCls.setLogCmd("set phi "+e+" | contour "+n+" | url "+encodeURIComponent(t)+" | gsize "+a+" | salt "+o,!0)}else alert("Please input the file URL before clicking 'Load'")}}class ip{constructor(e){this.icn3d=e}async applyDssp(e,t){let i=this.icn3d,s=i.icn3dui,n=this,r=e?"1":"0",a=Object.keys(i.structures),o=[],l=window&&window.location&&-1!=window.location.hostname.indexOf("ncbi.nlm.nih.gov")?"/Structure/mmcifparser/mmcifparser.cgi":s.htmlCls.baseUrl+"mmcifparser/mmcifparser.cgi";for(let e=0,t=a.length;e<t;++e){let t="",n={},d=i.structures[a[e]];for(let e=0,t=d.length;e<t;++e)n=s.hashUtilsCls.unionHash(n,i.chains[d[e]]);t+=i.saveFileCls.getAtomPDB(n,void 0,!0);let c={dssp:"t",calphaonly:r,pdbfile:t},h=s.getAjaxPostPromise(l,c);o.push(h)}let d=Promise.allSettled(o);try{let e=await d;await n.parseDsspData(e,a,t),s.bNode||await i.ParserUtilsCls.checkMemProteinAndRotate()}catch(e){console.log("DSSP calculation had a problem with this structure "+a[0]+"..."),await i.pdbParserCls.loadPdbDataRender(t)}}async parseDsspData(e,t,i){let s=this.icn3d;s.icn3dui;for(let i=0,n=e.length;i<n;++i){let n=e[i].value;if(void 0!==n&&-1===JSON.stringify(n).indexOf("Oops there was a problem"))for(let e in s.chainsSeq){let r=e.indexOf("_");if(e.substr(0,r)!=t[i])continue;let a,o=e.substr(r+1),l=s.chainsSeq[e],d="coil";for(let t=0,i=l.length;t<i;++t){let i,r=l[t].resi,c=o+"_"+r,h="c";n.hasOwnProperty(c)?h=n[c]:n.hasOwnProperty(" _"+r)?h=n[" _"+r]:n.hasOwnProperty("_"+r)&&(h=n["_"+r]),i="H"===h?"helix":"E"===h?"sheet":"coil";let p=e+"_"+r;s.secondaries[p]=h;let u,m,f=0;if(i!==d?"coil"===d?(u=!0,m=!1):"coil"===i?(f=2,u=!1,m=!1):("sheet"===d&&"helix"===i||"helix"===d&&"sheet"===i)&&(f=2,u=!0,m=!1):(u=!1,m=!1),1==f){let t=e+"_"+a;for(let e in s.residues[t])s.atoms[e].ssbegin=!0,s.atoms[e].ssend=!1}else if(2==f){let t=e+"_"+a;for(let e in s.residues[t])s.atoms[e].ssbegin=!1,s.atoms[e].ssend=!0}for(let e in s.residues[p])s.atoms[e].ss=i,s.atoms[e].ssbegin=u,s.atoms[e].ssend=m;d=i,a=r}}else console.log("DSSP calculation had a problem with this structure "+t[i]+"...")}await s.pdbParserCls.loadPdbDataRender(i)}}class sp{constructor(e){this.icn3d=e,this.TMThresholdIgType=.85,this.TMThresholdTemplate=.4,this.topClusters=5}async hideIgRefNum(){let e=this.icn3d;e.icn3dui,e.bShowRefnum=!1,e.resid2refnum={},e.annotationCls.hideAnnoTabIg(),e.selectionCls.selectAll_base(),e.opts.color="chain",e.setColorCls.setColorByOptions(e.opts,e.atoms),e.hlUpdateCls.updateHlAll(),e.drawCls.draw(),e.bResetAnno=!0,e.bAnnoShown&&await e.annotationCls.resetAnnoTabAll()}setRefPdbs(){let e=this.icn3d;e.icn3dui,e.refpdbArray=["1InsulinR_8guyE_human_FN3-n1","1Endo-1,4-BetaXylanase10A_1i8aA_bacteria_n4","1CoAtomerGamma1_1r4xA_human","1C3_2qkiD_human_n1","1CuZnSuperoxideDismutase_1hl5C_human","1ASF1A_2iijA_human","1FAB-LIGHT_5esv_C1-n2","1CD2_1hnfA_human_C2-n2","1NaCaExchanger_2fwuA_dog_n2","1NaKATPaseTransporterBeta_2zxeB_spurdogshark","1FAB-HEAVY_5esv_V-n1","1PDL1_4z18B_human_V-n1","1BTLA_2aw2A_human_Iset","1LaminAC_1ifrA_human","1CD3g_6jxrg_human_C2","1CD28_1yjdC_human_V","1CD19_6al5A_human-n1"],e.refpdbHash={},e.refpdbHash["1InsulinR_8guyE_human_FN3-n1"]=["InsulinR_8guyE_human_FN3-n1","IL6Rb_1bquB_human_FN3-n3","Sidekick2_1wf5A_human_FN3-n7","InsulinR_8guyE_human_FN3-n2","Contactin1_2ee2A_human_FN3-n9","IL6Rb_1bquB_human_FN3-n2"],e.refpdbHash["1Endo-1,4-BetaXylanase10A_1i8aA_bacteria_n4"]=["Endo-1,4-BetaXylanase10A_1i8aA_bacteria_n4","ICOS_6x4gA_human_V"],e.refpdbHash["1CoAtomerGamma1_1r4xA_human"]=["CoAtomerGamma1_1r4xA_human","TP34_2o6cA_bacteria"],e.refpdbHash["1C3_2qkiD_human_n1"]=["C3_2qkiD_human_n1","BArrestin1_4jqiA_rat_n1","RBPJ_6py8C_human_Unk-n1"],e.refpdbHash["1CuZnSuperoxideDismutase_1hl5C_human"]=["CuZnSuperoxideDismutase_1hl5C_human","TEAD1_3kysC_human"],e.refpdbHash["1ASF1A_2iijA_human"]=["ASF1A_2iijA_human","RBPJ_6py8C_human_Unk-n2","TP47_1o75A_bacteria"],e.refpdbHash["1FAB-LIGHT_5esv_C1-n2"]=["FAB-LIGHT_5esv_C1-n2","GHR_1axiB_human_C1-n1","VTCN1_Q7Z7D3_human_C1-n2","B2Microglobulin_7phrL_human_C1","FAB-HEAVY_5esv_C1-n2","MHCIa_7phrH_human_C1"],e.refpdbHash["1CD2_1hnfA_human_C2-n2"]=["CD2_1hnfA_human_C2-n2","Siglec3_5j0bB_human_C1-n2"],e.refpdbHash["1NaCaExchanger_2fwuA_dog_n2"]=["NaCaExchanger_2fwuA_dog_n2","ORF7a_1xakA_virus","ECadherin_4zt1A_human_n2"],e.refpdbHash["1NaKATPaseTransporterBeta_2zxeB_spurdogshark"]=["NaKATPaseTransporterBeta_2zxeB_spurdogshark"],e.refpdbHash["1FAB-HEAVY_5esv_V-n1"]=["FAB-HEAVY_5esv_V-n1","FAB-LIGHT_5esv_V-n1","VNAR_1t6vN_shark_V","TCRa_6jxrm_human_V-n1","VISTA_6oilA_human_V","CD8a_1cd8A_human_V","PD1_4zqkB_human_V"],e.refpdbHash["1PDL1_4z18B_human_V-n1"]=["PDL1_4z18B_human_V-n1","CD2_1hnfA_human_V-n1","LAG3_7tzgD_human_V-n1"],e.refpdbHash["1BTLA_2aw2A_human_Iset"]=["BTLA_2aw2A_human_Iset","Palladin_2dm3A_human_Iset-n1","Titin_4uowM_human_Iset-n152","LAG3_7tzgD_human_C1-n2","JAM1_1nbqA_human_Iset-n2","Contactin1_3s97C_human_Iset-n2"],e.refpdbHash["1LaminAC_1ifrA_human"]=["LaminAC_1ifrA_human","CD3d_6jxrd_human_C1"],e.refpdbHash["1CD3g_6jxrg_human_C2"]=["CD3g_6jxrg_human_C2","TCRa_6jxrm_human_C1-n2","IsdA_2iteA_bacteria"],e.refpdbHash["1CD28_1yjdC_human_V"]=["CD28_1yjdC_human_V","MPT63_1lmiA_bacteria","CD3e_6jxrf_human_C1"],e.refpdbHash["1CD19_6al5A_human-n1"]=["CD19_6al5A_human-n1"],e.refpdbHash.all_templates=["ASF1A_2iijA_human","B2Microglobulin_7phrL_human_C1","BArrestin1_4jqiA_rat_n1","BTLA_2aw2A_human_Iset","C3_2qkiD_human_n1","CD19_6al5A_human-n1","CD28_1yjdC_human_V","CD2_1hnfA_human_C2-n2","CD2_1hnfA_human_V-n1","CD3d_6jxrd_human_C1","CD3e_6jxrf_human_C1","CD3g_6jxrg_human_C2","CD8a_1cd8A_human_V","CoAtomerGamma1_1r4xA_human","Contactin1_2ee2A_human_FN3-n9","Contactin1_3s97C_human_Iset-n2","CuZnSuperoxideDismutase_1hl5C_human","ECadherin_4zt1A_human_n2","Endo-1,4-BetaXylanase10A_1i8aA_bacteria_n4","FAB-HEAVY_5esv_C1-n2","FAB-HEAVY_5esv_V-n1","FAB-LIGHT_5esv_C1-n2","FAB-LIGHT_5esv_V-n1","GHR_1axiB_human_C1-n1","ICOS_6x4gA_human_V","IL6Rb_1bquB_human_FN3-n2","IL6Rb_1bquB_human_FN3-n3","InsulinR_8guyE_human_FN3-n1","InsulinR_8guyE_human_FN3-n2","IsdA_2iteA_bacteria","JAM1_1nbqA_human_Iset-n2","LAG3_7tzgD_human_C1-n2","LAG3_7tzgD_human_V-n1","LaminAC_1ifrA_human","MHCIa_7phrH_human_C1","MPT63_1lmiA_bacteria","NaCaExchanger_2fwuA_dog_n2","NaKATPaseTransporterBeta_2zxeB_spurdogshark","ORF7a_1xakA_virus","PD1_4zqkB_human_V","PDL1_4z18B_human_V-n1","Palladin_2dm3A_human_Iset-n1","RBPJ_6py8C_human_Unk-n1","RBPJ_6py8C_human_Unk-n2","Sidekick2_1wf5A_human_FN3-n7","Siglec3_5j0bB_human_C1-n2","TCRa_6jxrm_human_C1-n2","TCRa_6jxrm_human_V-n1","TEAD1_3kysC_human","TP34_2o6cA_bacteria","TP47_1o75A_bacteria","Titin_4uowM_human_Iset-n152","VISTA_6oilA_human_V","VNAR_1t6vN_shark_V","VTCN1_Q7Z7D3_human_C1-n2"],e.refpdbHash["5ESV_C"]=["FAB-HEAVY_5esv_V-n1","FAB-HEAVY_5esv_C1-n2"],e.refpdbHash["5ESV_D"]=["FAB-LIGHT_5esv_V-n1","FAB-LIGHT_5esv_C1-n2"],e.refpdbHash["8GUY_E"]=["InsulinR_8guyE_human_FN3-n1","InsulinR_8guyE_human_FN3-n2"],e.refpdbHash["6JXR_m"]=["TCRa_6jxrm_human_V-n1","TCRa_6jxrm_human_C1-n2"],e.refpdbHash["1HNF_A"]=["CD2_1hnfA_human_V-n1","CD2_1hnfA_human_C2-n2"],e.refpdbHash["7TZG_D"]=["LAG3_7tzgD_human_V-n1","LAG3_7tzgD_human_C1-n2"],e.refpdbHash["6PY8_C"]=["RBPJ_6py8C_human_Unk-n1","RBPJ_6py8C_human_Unk-n2"],e.refpdbHash["1BQU_B"]=["IL6Rb_1bquB_human_FN3-n2","IL6Rb_1bquB_human_FN3-n3"],e.refpdbHash["1R4X_A"]=["CoAtomerGamma1_1r4xA_human"],e.refpdbHash["6OIL_A"]=["VISTA_6oilA_human_V"],e.refpdbHash["2ZXE_B"]=["NaKATPaseTransporterBeta_2zxeB_spurdogshark"],e.refpdbHash["1I8A_A"]=["Endo-1,4-BetaXylanase10A_1i8aA_bacteria_n4"],e.refpdbHash["2FWU_A"]=["NaCaExchanger_2fwuA_dog_n2"],e.refpdbHash["4JQI_A"]=["BArrestin1_4jqiA_rat_n1"],e.refpdbHash["1NBQ_A"]=["JAM1_1nbqA_human_Iset-n2"],e.refpdbHash["1O75_A"]=["TP47_1o75A_bacteria"],e.refpdbHash["7PHR_H"]=["MHCIa_7phrH_human_C1"],e.refpdbHash["2IIJ_A"]=["ASF1A_2iijA_human"],e.refpdbHash["4Z18_B"]=["PDL1_4z18B_human_V-n1"],e.refpdbHash["1T6V_N"]=["VNAR_1t6vN_shark_V"],e.refpdbHash["2O6C_A"]=["TP34_2o6cA_bacteria"],e.refpdbHash["3KYS_C"]=["TEAD1_3kysC_human"],e.refpdbHash["7PHR_L"]=["B2Microglobulin_7phrL_human_C1"],e.refpdbHash["2AW2_A"]=["BTLA_2aw2A_human_Iset"],e.refpdbHash["1HL5_C"]=["CuZnSuperoxideDismutase_1hl5C_human"],e.refpdbHash["1WF5_A"]=["Sidekick2_1wf5A_human_FN3-n7"],e.refpdbHash["5J0B_B"]=["Siglec3_5j0bB_human_C1-n2"],e.refpdbHash["1IFR_A"]=["LaminAC_1ifrA_human"],e.refpdbHash.Q7Z7D3_A=["VTCN1_Q7Z7D3_human_C1-n2"],e.refpdbHash["4ZQK_B"]=["PD1_4zqkB_human_V"],e.refpdbHash["2DM3_A"]=["Palladin_2dm3A_human_Iset-n1"],e.refpdbHash["2ITE_A"]=["IsdA_2iteA_bacteria"],e.refpdbHash["1XAK_A"]=["ORF7a_1xakA_virus"],e.refpdbHash["4ZT1_A"]=["ECadherin_4zt1A_human_n2"],e.refpdbHash["1LMI_A"]=["MPT63_1lmiA_bacteria"],e.refpdbHash["1CD8_A"]=["CD8a_1cd8A_human_V"],e.refpdbHash["3S97_C"]=["Contactin1_3s97C_human_Iset-n2"],e.refpdbHash["1AXI_B"]=["GHR_1axiB_human_C1-n1"],e.refpdbHash["6X4G_A"]=["ICOS_6x4gA_human_V"],e.refpdbHash["2EE2_A"]=["Contactin1_2ee2A_human_FN3-n9"],e.refpdbHash["4UOW_M"]=["Titin_4uowM_human_Iset-n152"],e.refpdbHash["6A15_A"]=["CD19_6al5A_human-n1"],e.refpdbHash["2QKI_D"]=["C3_2qkiD_human_n1"],e.refpdbHash["1YJD_C"]=["CD28_1yjdC_human_V"],e.refpdbHash["6JXR_d"]=["CD3d_6jxrd_human_C1"],e.refpdbHash["6JXR_f"]=["CD3e_6jxrf_human_C1"],e.refpdbHash["6JXR_g"]=["CD3g_6jxrg_human_C2"],e.ref2igtype={},e.ref2igtype.ASF1A_2iijA_human="IgFN3-like",e.ref2igtype.B2Microglobulin_7phrL_human_C1="IgC1",e.ref2igtype.BArrestin1_4jqiA_rat_n1="IgFN3-like",e.ref2igtype.BTLA_2aw2A_human_Iset="IgI",e.ref2igtype.C3_2qkiD_human_n1="IgFN3-like",e.ref2igtype["CD19_6al5A_human-n1"]="CD19",e.ref2igtype.CD28_1yjdC_human_V="IgV",e.ref2igtype["CD2_1hnfA_human_C2-n2"]="IgC2",e.ref2igtype["CD2_1hnfA_human_V-n1"]="IgV",e.ref2igtype.CD3d_6jxrd_human_C1="IgC1",e.ref2igtype.CD3e_6jxrf_human_C1="IgC1",e.ref2igtype.CD3g_6jxrg_human_C2="IgC2",e.ref2igtype.CD8a_1cd8A_human_V="IgV",e.ref2igtype.CoAtomerGamma1_1r4xA_human="IgE",e.ref2igtype["Contactin1_2ee2A_human_FN3-n9"]="IgFN3",e.ref2igtype["Contactin1_3s97C_human_Iset-n2"]="IgI",e.ref2igtype.CuZnSuperoxideDismutase_1hl5C_human="SOD",e.ref2igtype.ECadherin_4zt1A_human_n2="Cadherin",e.ref2igtype["Endo-1,4-BetaXylanase10A_1i8aA_bacteria_n4"]="IgE",e.ref2igtype["FAB-HEAVY_5esv_C1-n2"]="IgC1",e.ref2igtype["FAB-HEAVY_5esv_V-n1"]="IgV",e.ref2igtype["FAB-LIGHT_5esv_C1-n2"]="IgC1",e.ref2igtype["FAB-LIGHT_5esv_V-n1"]="IgV",e.ref2igtype["GHR_1axiB_human_C1-n1"]="IgC1",e.ref2igtype.ICOS_6x4gA_human_V="IgV",e.ref2igtype["IL6Rb_1bquB_human_FN3-n2"]="IgFN3",e.ref2igtype["IL6Rb_1bquB_human_FN3-n3"]="IgFN3",e.ref2igtype["InsulinR_8guyE_human_FN3-n1"]="IgFN3",e.ref2igtype["InsulinR_8guyE_human_FN3-n2"]="IgFN3",e.ref2igtype.IsdA_2iteA_bacteria="IgE",e.ref2igtype["JAM1_1nbqA_human_Iset-n2"]="IgI",e.ref2igtype["LAG3_7tzgD_human_C1-n2"]="IgC1",e.ref2igtype["LAG3_7tzgD_human_V-n1"]="IgV",e.ref2igtype.LaminAC_1ifrA_human="Lamin",e.ref2igtype.MHCIa_7phrH_human_C1="IgC1",e.ref2igtype.MPT63_1lmiA_bacteria="IgFN3-like",e.ref2igtype.NaCaExchanger_2fwuA_dog_n2="IgFN3-like",e.ref2igtype.NaKATPaseTransporterBeta_2zxeB_spurdogshark="IgE",e.ref2igtype.ORF7a_1xakA_virus="ORF",e.ref2igtype.PD1_4zqkB_human_V="IgV",e.ref2igtype["PDL1_4z18B_human_V-n1"]="IgV",e.ref2igtype["Palladin_2dm3A_human_Iset-n1"]="IgI",e.ref2igtype["RBPJ_6py8C_human_Unk-n1"]="IgFN3-like",e.ref2igtype["Sidekick2_1wf5A_human_FN3-n7"]="IgFN3",e.ref2igtype["Siglec3_5j0bB_human_C1-n2"]="IgC1",e.ref2igtype["TCRa_6jxrm_human_C1-n2"]="IgC1",e.ref2igtype["TCRa_6jxrm_human_V-n1"]="IgV",e.ref2igtype.TEAD1_3kysC_human="IgFN3-like",e.ref2igtype.TP34_2o6cA_bacteria="IgE",e.ref2igtype.TP47_1o75A_bacteria="IgE",e.ref2igtype["Titin_4uowM_human_Iset-n152"]="IgI",e.ref2igtype.VISTA_6oilA_human_V="IgV",e.ref2igtype.VNAR_1t6vN_shark_V="IgV",e.ref2igtype["VTCN1_Q7Z7D3_human_C1-n2"]="IgC1"}getPdbAjaxArray(){let e=this.icn3d,t=e.icn3dui,i=[];for(let s=0,n=e.refpdbArray.length;s<n;++s){let n=t.htmlCls.baseUrl+"mmcifparser/mmcifparser.cgi?refpdbid="+e.refpdbArray[s],r=t.getAjaxPromise(n,"text");i.push(r)}return i}async showIgRefNum(e){let t=this.icn3d;t.icn3dui;let i=this;this.setRefPdbs();let s=this.getPdbAjaxArray();if(e)await i.parseRefPdbData(void 0,e,void 0,numRound);else{t.pdbDataArray=await this.promiseWithFixedJobs(s);let n=0,r=await i.parseRefPdbData(t.pdbDataArray,e,void 0,n);for(++n;!r&&n<15;){let s=!0;r=await i.parseRefPdbData(t.pdbDataArray,e,s,n),++n}}t.chainid2igtrack||(t.chainid2igtrack={});for(let e in t.chains){let i=t.firstAtomObjCls.getFirstAtomObj(t.chains[e]);if(t.proteins.hasOwnProperty(i.serial)){let i=t.showSeqCls.getSeq(e);t.chainid2igtrack[e]=this.ajdustRefnum(i,e)}}}async parseRefPdbData(e,t,i,s){let n=this.icn3d,r=n.icn3dui,a=this,o=Object.keys(n.structures),l=[],d=[],c=r.htmlCls.tmalignUrl;n.resid2domainid||(n.resid2domainid={}),n.domainid2pdb={};let h=!0,p=!1;for(let s=0,a=o.length;s<a;++s){let a=o[s],u=n.structures[a];for(let s=0,o=u.length;s<o;++s){let o=u[s],m=this.getDomainAtomsArray(o,i);if(n.domainid2refpdbname||(n.domainid2refpdbname={}),n.domainid2score||(n.domainid2score={}),0!=m.length){p=!0;for(let i=0,s=m.length;i<s;++i){h=!1;let s=n.saveFileCls.getAtomPDB(m[i],void 0,void 0,void 0,void 0,a),p=n.firstAtomObjCls.getFirstAtomObj(m[i]),u=n.firstAtomObjCls.getLastAtomObj(m[i]),f=o+","+i+"_"+(p.resi+":"+u.resi+":"+Object.keys(m[i]).length);if(delete n.domainid2score[f],n.domainid2pdb[f]=s,t)n.domainid2refpdbname[f]=[t],d.push(f+"|1"+t);else for(let t=0,i=e.length;t<i;++t){let i=n.defaultPdbId+t,a=e[t].value;a="HEADER                                                        "+i+"\n"+a;let o={pdb_query:a,pdb_target:s,queryid:n.refpdbArray[t]},h=r.getAjaxPostPromise(c,o);l.push(h),d.push(f+"|"+n.refpdbArray[t])}}}}}if(!p)return h;if(t){r.bNode||console.log("Start alignment with the reference culsters "+JSON.stringify(n.domainid2refpdbname));let e=[],i=[],o=r.htmlCls.tmalignUrl,l=r.htmlCls.baseUrl+"mmcifparser/mmcifparser.cgi?refpdbid="+t,d=r.getAjaxPromise(l,"text"),c=[];c.push(d);let p=await this.promiseWithFixedJobs(c);for(let s in n.domainid2refpdbname){let a=n.domainid2pdb[s];for(let l=0,d=p.length;l<d;++l){let d=n.defaultPdbId+l,c=p[l].value;c="HEADER                                                        "+d+"\n"+c;let h={pdb_query:c,pdb_target:a,queryid:t},u=r.getAjaxPostPromise(o,h);e.push(u),i.push(s+"|"+t)}}let u=[];u=await this.promiseWithFixedJobs(e),h=await a.parseAlignData(u,i,void 0,s)}else{let e=[];e=await this.promiseWithFixedJobs(l);let t=!0;h=await a.parseAlignData(e,d,t,s)}return h}getDomainAtomsArray(e,t){let i=this.icn3d,s=i.icn3dui,n=[];if(i.chainid2atomsLeft||(i.chainid2atomsLeft={}),!i.proteins.hasOwnProperty(i.firstAtomObjCls.getFirstAtomObj(i.chains[e]).serial)&&!i.proteins.hasOwnProperty(i.firstAtomObjCls.getMiddleAtomObj(i.chains[e]).serial))return n;if(i.chainsSeq[e].length<20)return n;let r=s.hashUtilsCls.intHash(i.chains[e],i.hAtoms);if(0==Object.keys(r).length)return n;if(t){let t={};for(let e in i.resid2domainid)i.resid2domainid[e]&&(t=s.hashUtilsCls.unionHash(t,i.residues[e]));if(r=s.hashUtilsCls.exclHash(r,t),i.chainid2atomsLeft[e]==Object.keys(r).length)return n;if(i.chainid2atomsLeft[e]=Object.keys(r).length,Object.keys(r).length<200)return n}let a=i.domain3dCls.c2b_NewSplitChain(r,void 0).subdomains;if(a.length>=1)for(let t=0,r=a.length;t<r;++t){let r={},o=a[t],l=0;for(let t=0,n=o.length;t<n;t+=2){let n=parseInt(o[t]),a=parseInt(o[t+1]);for(let t=n;t<=a;++t){let n=i.ncbi2resid[e+"_"+t];++l,r=s.hashUtilsCls.unionHash(r,i.residues[n]),delete i.residIgLoop[n],delete i.resid2domainid[n]}}l<20||n.push(r)}return n}getTemplateList(e){let t=this.icn3d;t.icn3dui;let i="",s="",n="",r="";if(i=t.domainid2refpdbname[e][0],t.domainid2score[e]){let i=t.domainid2score[e].split("_");s=i[0],n=i[1],r=i[2]}return{refpdbname:i,score:s,seqid:n,nresAlign:r}}parseAlignData_part1(e,t,i){let s=this.icn3d,n=s.icn3dui,r={},a={};s.chainid2refpdbname||(s.chainid2refpdbname={}),s.domainid2refpdbname||(s.domainid2refpdbname={}),s.domainid2score||(s.domainid2score={}),s.domainid2ig2kabat||(s.domainid2ig2kabat={}),s.domainid2ig2imgt||(s.domainid2ig2imgt={});for(let o=0,l=t.length;o<l;++o){let l=e[o]?e[o].value:void 0;if(!l||0==l.length){n.bNode||console.log("The alignment data for "+t[o]+" is unavailable...");continue}if(void 0===l[0].score)continue;let d=parseFloat(l[0].score),c=t[o].substr(0,t[o].indexOf("|")),h=t[o].substr(t[o].indexOf("|")+1);if(i){if(l[0].score<this.TMThresholdTemplate||l[0].num_res<10)continue}else if(l[0].score<this.TMThresholdTemplate||l[0].num_res<20){n.bNode||console.log("bRound1: "+i+": domainid "+c+" and refpdbname "+h+" were skipped due to a TM-score less than "+this.TMThresholdTemplate);continue}if(i?(n.bNode||console.log("domainid: "+c+" refpdbname "+h+" TM-score: "+l[0].score),a[c]||(a[c]={}),a[c][h]=d):n.bNode||console.log("refpdbname "+h+" TM-score: "+l[0].score),!i&&l[0].segs){let e=!1,t=!1,i=!1,r=!1,a=!0,o=!0,d=!0,p=!0,u=c.split(",")[0];for(let n=0,c=l[0].segs.length;n<c;++n){let c=l[0].segs[n],h=u+"_"+c.t_start,m=parseInt(c.q_start);if(m>2540&&m<2560?e=!0:m>3540&&m<3560?t=!0:m>7540&&m<7560?i=!0:m>8540&&m<8560&&(r=!0),2550==m){"helix"==s.firstAtomObjCls.getFirstAtomObj(s.residues[h]).ss&&(a=!1)}else if(3550==m){"helix"==s.firstAtomObjCls.getFirstAtomObj(s.residues[h]).ss&&(o=!1)}else if(7550==m){"helix"==s.firstAtomObjCls.getFirstAtomObj(s.residues[h]).ss&&(d=!1)}else if(8550==m){"helix"==s.firstAtomObjCls.getFirstAtomObj(s.residues[h]).ss&&(p=!1)}if(e&&t&&i&&r)break}if(!(e&&t&&i&&r&&a&&o&&d&&p)){n.bNode||e&&t&&i&&r||console.log("Some of the Ig strands B, C, E, F are missing in the domain "+c+"..."),n.bNode||a&&o&&d&&p||console.log("Some of the Ig strands B, C, E, F are not beta sheets..."),s.domainid2refpdbname[c][0]==h&&(delete s.domainid2refpdbname[c],delete s.domainid2score[c]);continue}}i||n.bNode||console.log("domainid: "+c),(!r.hasOwnProperty(c)||d>=parseFloat(s.domainid2score[c].split("_")[0]))&&(s.domainid2score[c]=l[0].score+"_"+l[0].frac_identical+"_"+l[0].num_res,s.domainid2refpdbname[c]=i?d>=this.TMThresholdIgType?[h]:["all_templates"]:[h],r[c]=l[0].segs,s.domainid2ig2kabat[c]=l[0].ig2kabat,s.domainid2ig2imgt[c]=l[0].ig2imgt)}if(i)for(let e in a)if(!n.bNode&&"all_templates"==s.domainid2refpdbname[e][0]){let t=a[e],i=Object.keys(t);i.sort((function(e,i){return t[i]-t[e]})),s.domainid2refpdbname[e]=i.slice(0,this.topClusters)}return r}async parseAlignData(e,t,i,s){let n=this.icn3d,r=n.icn3dui,a=!1,o=this.parseAlignData_part1(e,t,i);if(0==Object.keys(o).length)return a=!0,a;if(i){r.bNode||console.log("Start round 2 alignment with the reference culsters "+JSON.stringify(n.domainid2refpdbname));let e=[],t=[],i=r.htmlCls.tmalignUrl;for(let a in n.domainid2refpdbname){let o=[],l=n.domainid2refpdbname[a],d=a.substr(0,a.indexOf(","));n.refpdbHash.hasOwnProperty(d)&&0==s&&(l=[d],r.bNode||console.log("Adjusted refpdbname for domainid "+a+": "+d));let c=[];for(let e=0,t=l.length;e<t;++e){let t=l[e];n.refpdbHash[t]&&(c=c.concat(n.refpdbHash[t]))}if(0==c.length)continue;for(let e=0,t=c.length;e<t;++e){let t=r.htmlCls.baseUrl+"mmcifparser/mmcifparser.cgi?refpdbid="+c[e],i=r.getAjaxPromise(t,"text");o.push(i)}let h=await this.promiseWithFixedJobs(o),p=n.domainid2pdb[a];for(let s=0,o=h.length;s<o;++s){let o=n.defaultPdbId+s,l=h[s].value;l="HEADER                                                        "+o+"\n"+l;let d={pdb_query:l,pdb_target:p,queryid:c[s]},u=r.getAjaxPostPromise(i,d);e.push(u),t.push(a+"|"+c[s])}}let o=[];return o=await this.promiseWithFixedJobs(e),a=await this.parseAlignData(o,t,!1,s),a}return this.parseAlignData_part3(o),a}parseAlignData_part3(e){let t=this.icn3d,i=t.icn3dui,s={};for(let e in t.domainid2refpdbname){if("1"==t.domainid2refpdbname[e][0].substr(0,1)){delete t.domainid2refpdbname[e],delete t.domainid2score[e];continue}let i=e.split(",")[0];s.hasOwnProperty(i)||(t.chainid2refpdbname[i]=[]),s[i]=1,t.chainid2refpdbname.hasOwnProperty(i)||(t.chainid2refpdbname[i]=[]),t.chainid2refpdbname[i].push(t.domainid2refpdbname[e][0]+"|"+e)}t.resid2refnum||(t.resid2refnum={}),t.refnum2residArray||(t.refnum2residArray={}),t.chainsMapping||(t.chainsMapping={}),t.domainid2info||(t.domainid2info={});for(let s in e){let n=e[s],r=s.split(",")[0],a=this.getTemplateList(s),o=a.refpdbname,l=a.score,d=a.seqid,c=a.nresAlign;if(o){let e="The reference PDB for domain "+s+" is "+o+". The TM-score is "+l+". The sequence identity is "+d+". The number of aligned residues is "+c+".";i.bNode||(console.log(e),i.htmlCls.clickMenuCls.setLogCmd(e,!1,!0)),t.domainid2info[s]={refpdbname:o,score:l,seqid:d,nresAlign:c}}let h,p,u,m,f,g,b=!1,C=!1,v=!1,_=!1,y=!1,S=[],w=[],x=[],A=[];for(let e=0,s=n.length;e<s;++e){let s=n[e];if(!s)continue;let a=r+"_"+s.t_start;if(-1!=s.q_start.indexOf("3550")?(b=!0,h=t.firstAtomObjCls.getFirstCalphaAtomObj(t.residues[a]),f=0):-1!=s.q_start.indexOf("4550")?(C=!0,p=t.firstAtomObjCls.getFirstCalphaAtomObj(t.residues[a]),++f):-1!=s.q_start.indexOf("6550")?(_=!0,u=t.firstAtomObjCls.getFirstCalphaAtomObj(t.residues[a]),++f):-1!=s.q_start.indexOf("7550")&&(y=!0,m=t.firstAtomObjCls.getFirstCalphaAtomObj(t.residues[a])),s.q_start>=3545&&s.q_start<=3555){let e=t.firstAtomObjCls.getFirstCalphaAtomObj(t.residues[a]);e&&S.push(e)}else if(s.q_start>=7545&&s.q_start<=7555){let e=t.firstAtomObjCls.getFirstCalphaAtomObj(t.residues[a]);e&&w.push(e)}if(-1!=s.q_start.indexOf("8550")&&1==f&&h&&m&&(p||u)){let e=999,t=999;for(let t=0,i=S.length;t<i;++t){let i=C?p.coord.distanceTo(S[t].coord):u.coord.distanceTo(S[t].coord);i<e&&(e=i)}for(let e=0,i=w.length;e<i;++e){let i=C?p.coord.distanceTo(w[e].coord):u.coord.distanceTo(w[e].coord);i<t&&(t=i)}e=parseInt(e),t=parseInt(t);let s=C?parseInt(p.resi)-parseInt(h.resi):parseInt(u.resi)-parseInt(h.resi),n=C?parseInt(m.resi)-parseInt(p.resi):parseInt(m.resi)-parseInt(u.resi),r=1;C?(e>t+r||e==t+r&&s>n+r)&&(x.push(p.resi),i.bNode||console.log("Rename strand C' to D: distToC "+e+" distToE "+t+" resiDistToC "+s+" resiDistToE "+n)):_&&(e+r<t||e+r==t&&s+r<n)&&(A.push(u.resi),i.bNode||console.log("Rename strand D to C': distToC "+e+" distToE "+t+" resiDistToC "+s+" resiDistToE "+n))}if(b&&C&&v&&_&&y)break}for(let e=0,i=n.length;e<i;++e){let i=n[e];if(!i)continue;i.q_start;let a=parseInt(i.q_start),o="";isNaN(i.q_start)&&(o=i.q_start.substr(i.q_start.length-1,1));let l=r+"_"+i.t_start,d=a,c=this.getLabelFromRefnum(d,o);g=c?c.replace(new RegExp(d,"g"),""):void 0;let h=g;if("C'"==g&&x.length>0){for(let e=0,t=x.length;e<t;++e)if(parseInt(i.t_start)<parseInt(x[e])+10&&parseInt(i.t_start)>parseInt(x[e])-10){h="D";break}}else if("D"==g&&A.length>0)for(let e=0,t=A.length;e<t;++e)if(parseInt(i.t_start)<parseInt(A[e])+10&&parseInt(i.t_start)>parseInt(A[e])-10){h="C'";break}g!=h&&(c=this.getLabelFromRefnum(d,o,h)),"helix"!=t.firstAtomObjCls.getFirstAtomObj(t.residues[l]).ss&&(t.resid2refnum[l]=c,t.resid2domainid[l]=s)}}Object.keys(t.resid2refnum).length>0?t.bShowRefnum=!0:i.bNode||t.bNoIg||(console.log("No Ig reference numbers are assigned based on the reference structures in iCn3D..."),t.bNoIg=!0)}getStrandFromRefnum(e,t){this.icn3d.icn3dui;let i,s=parseInt(e);return i=s<1e3?void 0:s>=1200&&s<1320?"A---":s>=1320&&s<1420?"A--":s>=1420&&s<1520?"A-":s>=1520&&s<1620?"A":s>=1620&&s<1720?"A+":s>=1720&&s<1820?"A++":s>=1820&&s<2e3?"A'":s>=2e3&&s<3e3?"B":s>=3e3&&s<3420?"C--":s>=3420&&s<3520?"C-":s>=3520&&s<4e3?"C":s>=4e3&&s<5e3?"C'":s>=5e3&&s<6e3?"C''":s>=6e3&&s<7e3?"D":s>=7e3&&s<7620?"E":s>=7620&&s<8e3?"E+":s>=8e3&&s<9e3?"F":s>=9e3&&s<9620?"G":s>=9620&&s<9720?"G+":s>=9720&&s<9820?"G++":s>=9820&&s<9900?"G+++":s>9900?void 0:" ",t&&(i=t),i}getLabelFromRefnum(e,t,i){this.icn3d.icn3dui;let s=this.getStrandFromRefnum(e,i),n=e.toString();return"C'"==i&&"6"==n.substr(0,1)?n="4"+n.substr(1):"D"==i&&"4"==n.substr(0,1)&&(n="6"+n.substr(1)),s?s+n+t:void 0}async parseCustomRefFile(e){let t=this.icn3d;t.icn3dui,t.bShowCustomRefnum=!0;let i=e.split("\n");t.resid2refnum||(t.resid2refnum={}),t.refnum2residArray||(t.refnum2residArray={}),t.chainsMapping||(t.chainsMapping={});let s=[];for(let e=0,t=i.length;e<t;++e){let t=i[e].split(",");s.push(t)}for(let e=1,i=s[0].length;e<i;++e){if(!s[0][e])continue;let i=s[0][e].trim();if(i)for(let n=1,r=s.length;n<r;++n){if(!s[n][e])continue;let r=s[n][0].trim()+"_"+s[n][e].trim();t.refnum2residArray[i]?t.refnum2residArray[i].push(r):t.refnum2residArray[i]=[r]}}for(let e=1,i=s.length;e<i;++e){let i=s[e][0].trim();for(let n=1,r=s[e].length;n<r;++n){if(!s[e][n]||!s[0][n])continue;let r=s[e][n].trim(),a=s[0][n].trim();t.chainsMapping.hasOwnProperty(i)||(t.chainsMapping[i]={});let o=i+"_"+r;r&&a?(t.resid2refnum[o]=a,t.chainsMapping[i][o]=a):t.chainsMapping[i][o]=r}}await t.showAnnoCls.showAnnotations(),t.annotationCls.setAnnoViewAndDisplay("detailed view")}rmStrandFromRefnumlabel(e){return this.icn3d.icn3dui,e&&isNaN(e.substr(0,1))&&e?e.replace(/'/g,"").replace(/\*/g,"").replace(/\^/g,"").replace(/\+/g,"").replace(/\-/g,"").substr(1):e}exportRefnum(e,t){let i=this.icn3d,s=i.icn3dui,n="";if("igstrand"==e||"IgStrand"==e){if(i.bShowRefnum)for(let e in i.chains){let t=i.firstAtomObjCls.getFirstAtomObj(i.chains[e]);if(i.proteins.hasOwnProperty(t.serial)){let t=[];for(let s=0;s<i.chainsSeq[e].length;++s)t.push(i.chainsSeq[e][s].name);i.annoIgCls.showRefNum(t,e)}}let e={};for(let t in i.resid2refnum){let n=i.firstAtomObjCls.getFirstAtomObj(i.residues[t]);if(!n)continue;let r=s.utilsCls.residueName2Abbr(n.resn.substr(0,3)),a=i.resid2domainid[t],o=i.resid2refnum[t];if(o){let e=i.refnumCls.rmStrandFromRefnumlabel(o);i.domainid2ig2kabat[a]&&i.domainid2ig2kabat[a][e]}i.resid2refnum[t]&&(i.residIgLoop.hasOwnProperty(t)?e[t+"_"+r]=i.resid2refnum[t]+"_loop":e[t+"_"+r]=i.resid2refnum[t])}for(let t in i.structures){let s=0,r="";for(let n=0,a=i.structures[t].length;i.bShowRefnum&&n<a;++n){let a=i.structures[t][n],o=i.chain2igArray[a];if(o&&o.length>0){r+='{"'+a+'": {\n';for(let t=0,n=o.length;t<n;++t){let n=o[t].startPosArray,l=o[t].endPosArray,d=o[t].domainid,c=i.domainid2info[d];if(c){r+='"'+d+'": {\n',r+='"refpdbname":"'+c.refpdbname+'", "score":'+c.score+', "seqid":'+c.seqid+', "nresAlign":'+c.nresAlign+', "data": [';for(let t=0,s=n.length;t<s;++t){let s=n[t],o=l[t];for(let t=s;t<=o;++t){const s=a+"_"+i.chainsSeq[a][t].resi+"_"+i.chainsSeq[a][t].name;r+='{"'+s+'": "'+e[s]+'"},\n'}}r+="],\n",r+="},\n",s=1}}r+="}},\n"}}n+='{"'+t+'": {"Ig domain" : '+s+', "igs": [\n',s&&(n+=r),n+="]}},\n"}}else if("kabat"==e||"Kabat"==e){let e={};for(let t in i.resid2refnum){let n,r=i.resid2domainid[t],a=i.resid2refnum[t],o=i.firstAtomObjCls.getFirstAtomObj(i.residues[t]);if(!o)continue;let l=s.utilsCls.residueName2Abbr(o.resn.substr(0,3));if(a){let e=i.refnumCls.rmStrandFromRefnumlabel(a);n=i.domainid2ig2kabat[r]?i.domainid2ig2kabat[r][e]:void 0}e[t+"_"+l]=n}n+='{"Kabat": ',n+=JSON.stringify(e),n+=",\n"}else if("imgt"==e||"IMGT"==e){let e={};for(let t in i.resid2refnum){let n,r=i.resid2domainid[t],a=i.resid2refnum[t],o=i.firstAtomObjCls.getFirstAtomObj(i.residues[t]);if(!o)continue;let l=s.utilsCls.residueName2Abbr(o.resn.substr(0,3));if(a){let e=i.refnumCls.rmStrandFromRefnumlabel(a);n=i.domainid2ig2imgt[r]?i.domainid2ig2imgt[r][e]:void 0}e[t+"_"+l]=n}n+='{"Kabat": ',n+=JSON.stringify(e),n+=",\n"}if(t||(n="["+n+"]"),s.bNode)return n;{let t=Object.keys(s.utilsCls.getHlStructures()).join(",");i.saveFileCls.saveFile(t+"_refnum_"+e+".txt","text",[n])}}async promiseWithFixedJobs(e){let t=this.icn3d,i=t.icn3dui;i.bNode||i.icn3d.ParserUtilsCls.showLoading();let s=[],n=i.cfg.maxajax?i.cfg.maxajax:6*t.refpdbArray.length;for(let t=0,i=parseInt((e.length-1)/n+1);t<i;++t){let r=[];r=t==i-1?e.slice(t*n,e.length):e.slice(t*n,(t+1)*n);let a=Promise.allSettled(r),o=await a;s=s.concat(o)}return i.bNode||i.icn3d.ParserUtilsCls.hideLoading(),s}ajdustRefnum(e,t){let i=this.icn3d,s=i.icn3dui;if(!i.chainid2refpdbname[t])return!1;let n,r,a,o,l,d,c,h,p="",u="",m="",f=!1,g=!1,b=1,C=!1;if(!s.bNode){let e=s.hashUtilsCls.intHash(i.chains[t],i.hAtoms);i.firstAtomObjCls.getResiduesFromAtoms(e)}let v=[],_={},y=0,S=0,w=0,x=0,A=!1;for(let s=0,M=e.length;s<M;++s,++S,++w,++x){let e,M=i.ParserUtilsCls.getResi(t,s),T=t+"_"+M;n=i.resid2refnum[T];let E=n?n.substr(0,1):"";if(C||!n||"A"!=E&&"B"!=E||(C=!0,S=1,A=!1),"G"!=u.substr(0,1)||n||(C=!1),n){e=i.resid2domainid[T],r=i.refnumCls.rmStrandFromRefnumlabel(n),p=n.replace(new RegExp(r,"g"),""),r.substr(0,1),a=r,d=parseInt(a),c=(d-1e3*parseInt(d/1e3)).toString(),h=(d-100*parseInt(d/100)).toString(),g="9"==c.substr(0,1)||"9"==h.substr(0,1)||"0"==h.substr(0,1)||"1"==h.substr(0,1),g&&(i.residIgLoop[T]=1),l=a.replace(d.toString(),""),o=l+"_"+b;let t=parseInt(d.toString().substr(0,2));if(f="5"!=c.substr(0,1)&&"18"!=t,p&&" "!=p){if(!g||f&&!g){let t=parseInt(d.toString().substr(d.toString().length-2,2));if(p!=u&&p!=m){if(A=!1,_[p+o]&&(++b,o=a.replace(d.toString(),"")+"_"+b),_[p+o]=1,v[y]={},v[y].startResi=M,v[y].startRefnum=d,w=0,v[y].domainid=e,v[y].endResi=M,v[y].endRefnum=d,50==t&&(v[y].anchorRefnum=d,v[y].resCntBfAnchor=w,x=0,A=!0),!A&&t>=46&&t<=54){let e=t-50;v[y].anchorRefnum=d-e,v[y].resCntBfAnchor=w-e,x=e,A=!0}f&&(v[y].anchorRefnum=0),v[y].strandPostfix=l,v[y].strand=p,v[y].postfix=o,v[y].loopResCnt=S-1,++y,S=0}else if(_[p+o]){if(50==t&&(v[y-1].anchorRefnum=d,v[y-1].resCntBfAnchor=w,v[y-1].startRefnum=v[y-1].anchorRefnum-v[y-1].resCntBfAnchor,x=0,A=!0),!A&&(51==t||52==t||53==t||54==t)){let e=t-50;v[y-1].anchorRefnum=d-e,v[y-1].resCntBfAnchor=w-e,v[y-1].startRefnum=v[y-1].anchorRefnum-v[y-1].resCntBfAnchor,x=e,A=!0}f&&(v[y-1].anchorRefnum=0),v[y-1].domainid=e,v[y-1].endResi=M,v[y-1].endRefnum=d,v[y-1].resCntAtAnchor=x,v[y-1].anchorRefnum&&(v[y-1].endRefnum=v[y-1].anchorRefnum+v[y-1].resCntAtAnchor),S=0}}m=p}}u=p}for(let e=0,s=v.length;e<s;++e){let n=i.firstAtomObjCls.getFirstAtomObj(i.residues[t+"_"+v[e].startResi]),r=i.firstAtomObjCls.getFirstAtomObj(i.residues[t+"_"+v[e].endResi]),a=i.setSeqAlignCls.getPosFromResi(t,v[e].startResi),o=i.setSeqAlignCls.getPosFromResi(t,v[e].endResi);if("sheet"==n.ss&&!n.ssbegin)for(let s=1;s<=8;++s){let n=a-s,r=i.ParserUtilsCls.getResi(t,n);if(e>0&&parseInt(r)<=parseInt(v[e-1].endResi))break;let o=t+"_"+r,l=i.firstAtomObjCls.getFirstAtomObj(i.residues[o]),d=i.resid2domainid[o];if(l.ssbegin){let o=v[e].startRefnum;v[e].startResi=r,v[e].startRefnum-=s,v[e].loopResCnt-=s,v[e].loopResCnt<0&&(v[e].loopResCnt=0),v[e].resCntBfAnchor+=s;for(let l=1;l<=s;++l){n=a-l,r=i.ParserUtilsCls.getResi(t,n);let s=t+"_"+r;delete i.residIgLoop[s],i.resid2refnum[s]=v[e].strand+(o-l).toString(),i.resid2domainid[s]=d}break}}if("sheet"==r.ss&&!r.ssend)for(let n=1;n<=8;++n){let r=o+n,a=i.ParserUtilsCls.getResi(t,r);if(e<s-1&&parseInt(a)>=parseInt(v[e+1].startResi))break;let l=t+"_"+a,d=i.firstAtomObjCls.getFirstAtomObj(i.residues[l]),c=i.resid2domainid[l];if(d.ssend){let l=v[e].endRefnum;v[e].endResi=a,v[e].endRefnum+=n,e<s-1&&(v[e+1].loopResCnt-=n,v[e+1].loopResCnt<0&&(v[e+1].loopResCnt=0)),v[e].resCntAtAnchor+=n;for(let s=1;s<=n;++s){r=o+s,a=i.ParserUtilsCls.getResi(t,r);let n=t+"_"+a;delete i.residIgLoop[n],i.resid2refnum[n]=v[e].strand+(l+s).toString(),i.resid2domainid[n]=c}break}}}let M={};for(let e=v.length-1;e>=0;--e){"G"!=v[e].strand&&v[e].endRefnum-v[e].startRefnum+1<3&&(v[e+1]&&(v[e+1].loopResCnt+=v[e].loopResCnt+parseInt(v[e].endResi)-parseInt(v[e].startResi)+1),v[e].startResi,v.splice(e,1))}y=0;let T,E,R=0,k=!0,O=!0,I=0;C=!1;let P=0;if(v.length>0)for(let s=0,r=e.length;s<r;++s,++R,++P){let e,r=i.ParserUtilsCls.getResi(t,s),o=t+"_"+r;if(n=i.resid2refnum[o],p=v[y].strand,n){e=i.resid2domainid[o],a=i.refnumCls.rmStrandFromRefnumlabel(n),E=parseInt(a),T=p+E,p=n.replace(new RegExp(a,"g"),"");let t=n.substr(0,1);C||"A"!=t&&"B"!=t||(C=!0,k=!0,R=0)}let l=i.firstAtomObjCls.getFirstAtomObj(i.residues[o]);if(l&&i.proteins.hasOwnProperty(l.serial)){let t=!1,s=!1,a=!1;if(t=parseInt(r)==parseInt(v[y].startResi)&&r!=v[y].startResi?r<v[y].startResi:parseInt(r)<parseInt(v[y].startResi),a=parseInt(r)==parseInt(v[y].endResi)&&r!=v[y].endResi?r>v[y].endResi:parseInt(r)>parseInt(v[y].endResi),s=!t&&!a,t)if(i.residIgLoop[o]=1,k)C?(E=v[y].startRefnum-v[y].loopResCnt+R,T=v[y].strand+E,n=T+v[y].strandPostfix,e=v[y].domainid):(T=void 0,n=void 0);else if(I>=0&&("G"==v[I].strand.substr(0,1)||"F"==v[I].strand.substr(0,1)&&"G"!=v[y].strand.substr(0,1)))O?C&&i.resid2refnum[o]?(O=!0,E=v[I].endRefnum+R,T=v[I].strand+E,n=T+v[I].strandPostfix,e=v[I].domainid):(C=!1,k=!0,O=!1,T=void 0,n=void 0):(T=void 0,n=void 0);else{O=!0;let t=v[y].loopResCnt;R<=parseInt(t/2+.5)?v[I]&&(E=v[I].endRefnum+R,T=v[I].strand+E,n=T+v[I].strandPostfix,e=v[I].domainid):(E=v[y].startRefnum-t+R-1,T=v[y].strand+E,n=T+v[y].strandPostfix,e=v[y].domainid)}else s?(k=!1,v[y].anchorRefnum&&(r==v[y].startResi?(P=v[y].anchorRefnum-v[y].resCntBfAnchor,v[y].startRefnum=P):r==v[y].endResi&&(v[y].endRefnum=P),T=v[y].strand+P,n=T+v[y].strandPostfix,e=v[y].domainid),r==v[y].endResi&&(++y,R=0,v[y]||--y)):a&&(i.residIgLoop[o]=1,O?i.resid2refnum[o]?(O=!0,E=v[y].endRefnum+R,T=v[y].strand+E,n=T+v[y].strandPostfix,e=v[y].domainid):(O=!1,T=void 0,n=void 0):(T=void 0,n=void 0))}else n=void 0;u=p,I=y-1,M.hasOwnProperty(e)?(delete i.resid2refnum[o],delete i.residIgLoop[o],delete i.resid2domainid[o]):(i.resid2refnum[o]=n,i.resid2domainid[o]=e,a=i.refnumCls.rmStrandFromRefnumlabel(n),i.refnum2residArray.hasOwnProperty(a)?i.refnum2residArray[a].push(o):i.refnum2residArray[a]=[o],i.chainsMapping.hasOwnProperty(t)||(i.chainsMapping[t]={}),i.chainsMapping[t][o]=T||r)}return!0}}class np{constructor(e){this.icn3d=e}async applyCommandScap(e){this.icn3d.icn3dui;let t=e.substr(e.lastIndexOf(" ")+1);0==e.indexOf("scap 3d")?await this.retrieveScap(t):0==e.indexOf("scap interaction")?await this.retrieveScap(t,!0):0==e.indexOf("scap pdb")&&await this.retrieveScap(t,void 0,!0)}adjust2DWidth(e){let t,i,s,n=this.icn3d;if(n.icn3dui,e=n.pre+e,$("#"+n.pre+"dl_selectannotations").hasClass("ui-dialog-content")){t=$("#"+n.pre+"dl_selectannotations").dialog("option","width"),i=.5*$("#"+n.pre+"dl_selectannotations").dialog("option","height"),s=i,$("#"+n.pre+"dl_selectannotations").dialog("option","height",i),$("#"+e).dialog("option","width",t),$("#"+e).dialog("option","height",i);let r={my:"left top",at:"right top+"+s,of:"#"+n.pre+"viewer",collision:"none"};$("#"+e).dialog("option","position",r)}}async retrieveScap(e,t,i){let s=this.icn3d,n=s.icn3dui,r=this;s.bScap=!0;let a="",o=e.split(","),l={},d=[],c={};for(let e=0,t=o.length;e<t;++e){let i=o[e].split("_"),r=i[0]+"_"+i[1]+"_"+i[2];l=n.hashUtilsCls.unionHash(l,s.residues[r]),d.push(r),c[i[1]+"_"+i[2]]="",a+=i[1]+"_"+i[2]+"_"+i[3],e!=t-1&&(a+=",")}let h=s.resid2specCls.residueids2spec(d),p="select "+h,u=s.showInterCls.pickCustomSphere_base(10,l,s.atoms,!1,!1,void 0,p,!1),m=Object.keys(u.residues);s.hAtoms={};for(let e=0,t=m.length;e<t;++e){let t=m[e];for(let e in s.residues[t])s.hAtoms[e]=1}s.hAtoms=n.hashUtilsCls.unionHash(s.hAtoms,l),s.hAtoms=n.hashUtilsCls.exclHash(s.hAtoms,s.chemicals);let f,g=s.saveFileCls.getAtomPDB(s.hAtoms),b=n.htmlCls.baseUrl+"scap/scap.cgi",C=Object.keys(s.structures)[0],v={pdb:g,snp:a,pdbid:C,v:"2"};f=await n.getAjaxPostPromise(b,v,!0,void 0,void 0,void 0,"text");let _=f.indexOf("\n"),y=f.substr(0,_),S=f.substr(_+1);console.log("free energy: "+y+" kcal/mol");let w=n.hashUtilsCls.cloneHash(s.hAtoms);for(let e in w){let t=s.atoms[e],i=t.structure+"_"+t.chain,r=i+"_"+t.resi;s.chainsMapping.hasOwnProperty(i)||(s.chainsMapping[i]={}),s.chainsMapping[i][r]=n.utilsCls.residueName2Abbr(t.resn)+t.resi}let x=S.split("\n"),A={};for(let e in x){let t=x[e],i=t.substr(0,6);if("ATOM  "===i||"HETATM"===i){let e=t.substr(20,2).trim();""===e&&(e="A");let i=e+"_"+t.substr(22,5).trim();c.hasOwnProperty(i)&&(c[i]+=t+"\n"),A[i]=1}}let M=s.saveFileCls.getAtomPDB(s.atoms,!1,!1,!1,c);s.hAtoms={};s.loadPDBCls.loadPDB(M,C,!1,!1,!0,!0);for(let e in s.residues){if(e.substr(0,e.indexOf("_"))==C+"2"){let t=C+e.substr(e.indexOf("_")),i=s.firstAtomObjCls.getFirstAtomObj(s.residues[t]);if(i)for(let t in s.residues[e])s.atoms[t].ss=i.ss,s.atoms[t].ssbegin=i.ssbegin,s.atoms[t].ssend=i.ssend}}for(let e in s.secondaries){if(e.substr(0,e.indexOf("_"))==C+"2"){let t=C+e.substr(e.indexOf("_"));s.secondaries[e]=s.secondaries[t]}}s.setStyleCls.setAtomStyleByOptions(s.opts),s.setColorCls.setColorByOptions(s.opts,s.hAtoms);let T={};for(let e in s.hAtoms){let t=s.atoms[e],i=t.chain+"_"+t.resi;A.hasOwnProperty(i)&&(T[e]=1)}s.hAtoms=n.hashUtilsCls.unionHash(w,T),s.dAtoms=n.hashUtilsCls.cloneHash(s.hAtoms),s.transformCls.zoominSelection(),s.setOptionCls.setStyle("proteins","stick");for(let e in T){let t=s.atoms[e];if(!t.het){let i=t.structure.substr(0,t.structure.length-1)+"_"+t.chain+"_"+t.resi,n=s.firstAtomObjCls.getFirstAtomObj(s.residues[i]);n&&(s.atoms[e].color=n.color,s.atomPrevColors[e]=n.color)}let i=t.structure+"_"+t.chain,r=i+"_"+t.resi,a=t.structure.substr(0,t.structure.length-1)+"_"+t.chain+"_"+t.resi;if(s.chainsMapping.hasOwnProperty(i)||(s.chainsMapping[i]={}),s.chainsMapping[i][r]=n.utilsCls.residueName2Abbr(t.resn)+t.resi,-1!=d.indexOf(a)){let e=s.firstAtomObjCls.getFirstAtomObj(s.residues[a]);s.chainsMapping[i][r]=n.utilsCls.residueName2Abbr(e.resn)+e.resi}}if(i)await r.exportPdbProfix(!1,M,a),s.drawCls.draw();else{let e=h,i="snp_"+a;if(await s.selByCommCls.selectByCommand(e,i,i),s.opts.color="atom",s.setColorCls.setColorByOptions(s.opts,s.hAtoms),s.viewInterPairsCls.clearInteractions(),t){let e="linegraph";await s.viewInterPairsCls.viewInteractionPairs(["selected"],["non-selected"],!1,e,!0,!0,!0,!0,!0,!0),r.adjust2DWidth("dl_linegraph")}s.hAtoms=s.dAtoms,s.drawCls.draw(),n.alertAlt||(n.alertAlt=!0,alert('Please press the letter "a" to alternate between wild type and mutant.'))}$("#"+s.pre+"mn2_alternateWrap").show();let E=s.pre+"selection";$("#"+E).show()}async exportPdbProfix(e,t,i){let s,n=this.icn3d,r=n.icn3dui;if(t)s=t;else{let e=r.hashUtilsCls.intHash(n.dAtoms,n.hAtoms),t=!0;s=n.saveFileCls.getAtomPDB(e,void 0,void 0,void 0,void 0,void 0,t)}let a,o=r.htmlCls.baseUrl+"scap/scap.cgi",l={pdb:s,profix:"1",hydrogen:e?"1":"0"};try{a=await r.getAjaxPostPromise(o,l,void 0,void 0,void 0,void 0,"text")}catch(e){return void alert("There are some problems in adding missing atoms or hydrogens...")}if(r.bNode)return a;{let t=Object.keys(r.utilsCls.getHlStructures()).join(","),s=e?"add_hydrogen":"add_missing_atoms";i&&(s=i),n.saveFileCls.saveFile(t+"_icn3d_"+s+".pdb","text",[a])}}}class rp{constructor(e){this.icn3d=e}async applyCommandSymd(e){this.icn3d.icn3dui,await this.retrieveSymd()}async retrieveSymd(){let e=this.icn3d,t=e.icn3dui,i=this,s=t.htmlCls.baseUrl+"symd/symd.cgi",n=t.hashUtilsCls.intHash(e.dAtoms,e.hAtoms);n=t.hashUtilsCls.intHash(n,e.proteins);let r=Object.keys(n).length,a={};for(let t in n){let i=e.atoms[t];a[i.structure+"_"+i.chain+"_"+i.resi]=1}if(r>1e4)return void alert("The maximum number of allowed atoms is 10,000. Please try it again with smaller sets...");let o="";o+=e.saveFileCls.getAtomPDB(n);let l,d={pdb:o,pdbid:Object.keys(e.structures).toString()};try{l=await t.getAjaxPostPromise(s,d,!0);let n,r,o,c=l.rcsb_struct_symmetry,h="none";if(void 0!==c){let s;void 0!==e.rmsd_supr&&void 0!==e.rmsd_supr.rot&&(n=e.rmsd_supr.rot,r=e.rmsd_supr.trans1,o=e.rmsd_supr.trans2),void 0===e.symdArray&&(e.symdArray=[]);for(let t=0,n=c.length;t<n;++t){if("C1"==c[t].symbol)continue;h=c[t].symbol+" ","Pseudo Symmetry"==c[t].kind?h=c[t].symbol+" (pseudo)":"Global Symmetry"==c[t].kind?h=c[t].symbol+" (global)":"Local Symmetry"==c[t].kind&&(h=c[t].symbol+" (local)");let n=c[t].rotation_axes,r=[];for(let e=0,a=n.length;e<a;++e){let a=[],o=new mt(n[e].start[0],n[e].start[1],n[e].start[2]),l=new mt(n[e].end[0],n[e].end[1],n[e].end[2]);s=n[e].order,a.push(o),a.push(l);let d=i.getAxisColor(c[t].symbol,n[e].order),h=i.getPolygonColor(c[t].symbol);a.push(d),a.push(h),a.push(n[e].order),a.push("selection"),r.push(a)}let a={};a[h]=r,e.symdArray.push(a)}if(0==e.symdArray.length)$("#"+e.pre+"dl_symd").html("<br>The selected residues have no detected symmetry with a Z score of "+l.zscore+" from the program <a href='https://symd.nci.nih.gov/' target='_blank'>SymD</a>."),t.htmlCls.dialogCls.openDlg("dl_symd","Dynamically Calculated Symmetry Using SymD");else{let n=l.seqalign.replace(/ /g,"").split(","),r=l.nres,o=l.shift,d=l.rmsd,h=Object.keys(a),p={},u={},m=[],f=[],g=0,b=0,C={};for(let e=0,i=n[0].length;e<i;++e){let i=n[0][e],s=n[1][e];if("-"!=i){if(i==i.toUpperCase()){p[h[g]]=1;let e=t.utilsCls.getIdArray(h[g]);m.push(i+" $"+e[0]+"."+e[1]+":"+e[2]);let s=e[0]+"_"+e[1];C.hasOwnProperty(s)||(C[s]=[]),C[s].push(m.length-1)}++g}if("-"!=s){if(s==s.toUpperCase()){let e=(b+o+r)%r;u[h[e]]=1;let i=t.utilsCls.getIdArray(h[e]);f.push(s+" $"+i[0]+"."+i[1]+":"+i[2])}++b}}let v={},_={},y=[],S=[],w=!1;if(1==Object.keys(C).length){w=!0;let e=parseInt(m.length/s+.5),t=Object.keys(p),i=Object.keys(u);for(let s=0;s<e;++s)v.hasOwnProperty(i[s])||(y.push(m[s]),S.push(f[s]),v[t[s]]=1,_[i[s]]=1)}else{let e,t=0;for(let i in C)C[i].length>t&&(t=C[i].length,e=i);let i=Object.keys(p),s=Object.keys(u);for(let t=0,n=C[e].length;t<n;++t){let n=C[e][t];v.hasOwnProperty(s[n])||(y.push(m[n]),S.push(f[n]),v[i[n]]=1,_[s[n]]=1)}}let x="<br>";x+="The symmetry "+c[0].symbol+" was calculated dynamically using the program <a href='https://symd.nci.nih.gov/' target='_blank'>SymD</a>. The Z score "+l.zscore+" is greater than the threshold Z score 8. The RMSD is "+d+' angstrom. <br><br>The following sequence alignment shows the residue mapping of the best aligned sets: "symOri" and "symPerm", which are also available in the menu "Analysis > Defined Sets".<br>',$("#"+e.pre+"symd_info").html(x),i.setSeqAlignForSymmetry(y,S,w);let A=!1,M=t.htmlCls.alignSeqCls.getAlignSequencesAnnotations(Object.keys(e.alnChains),void 0,void 0,A,w);x=$("#"+e.pre+"dl_sequence2").html()+M.sequencesHtml,$("#"+e.pre+"dl_sequence2").html(x),$("#"+e.pre+"dl_sequence2").width(t.htmlCls.RESIDUE_WIDTH*M.maxSeqCnt+200),t.htmlCls.dialogCls.openDlg("dl_alignment","Select residues in aligned sequences from SymD");let T=Object.keys(e.defNames2Residues).length+Object.keys(e.defNames2Atoms).length,E="symOri"+T;e.selectionCls.selectResidueList(v,E,E),e.selectionCls.updateSelectionNameDesc(),t.htmlCls.clickMenuCls.setLogCmd("select "+e.resid2specCls.residueids2spec(Object.keys(v))+" | name "+E,!1),E="symPerm"+T,e.selectionCls.selectResidueList(_,E,E),e.selectionCls.updateSelectionNameDesc(),t.htmlCls.clickMenuCls.setLogCmd("select "+e.resid2specCls.residueids2spec(Object.keys(_))+" | name "+E,!1),E="symBoth"+T,v=t.hashUtilsCls.unionHash(v,_),e.selectionCls.selectResidueList(v,E,E),e.selectionCls.updateSelectionNameDesc(),t.htmlCls.clickMenuCls.setLogCmd("select "+e.resid2specCls.residueids2spec(Object.keys(v))+" | name "+E,!1)}}else $("#"+e.pre+"dl_symd").html("<br>The selected residues have no detected symmetry with a Z score of "+l.zscore+" from the program <a href='https://symd.nci.nih.gov/' target='_blank'>SymD</a>."),t.htmlCls.dialogCls.openDlg("dl_symd","Dynamically Calculated Symmetry Using SymD");e.symdtitle="none"===h?void 0:h,e.drawCls.draw()}catch(i){return $("#"+e.pre+"dl_symd").html("<br>The web service can not determine the symmetry of the input set."),t.htmlCls.dialogCls.openDlg("dl_symd","Dynamically Calculated Symmetry Using SymD"),void e.ParserUtilsCls.hideLoading()}}getResObj(e){this.icn3d.icn3dui;let t=e.substr(0,e.indexOf(" ")),i=e.indexOf("$"),s=e.indexOf("."),n=e.indexOf(":"),r=e.substr(i+1,s-i-1),a=e.substr(s+1,n-s-1),o=e.substr(n+1);return{resn:t,resid:r+"_"+a+"_"+o,resi:o,aligned:!0}}setSeqAlignForSymmetry(e,t,i){let s=this.icn3d,n=s.icn3dui;s.conservedName1="symOri_cons",s.conservedName2="symPerm_cons",s.consHash1={},s.consHash2={},s.alnChainsAnTtl={},s.alnChainsAnno={},s.alnChainsSeq={},s.alnChains={},s.alnChainsSeq={};let r={};for(let a=0,o=e.length;a<o;++a){let o,l=this.getResObj(e[a]),d=this.getResObj(t[a]),c=l.resid.substr(0,l.resid.lastIndexOf("_")),h=d.resid.substr(0,d.resid.lastIndexOf("_")),p=h;if(i){p=h.substr(0,h.indexOf("_"))+"2"+h.substr(h.indexOf("_"))}r[l.resid]=1,r[d.resid]=1,o=l.resn==d.resn?"#FF0000":"#0000FF";let u="#"+s.showAnnoCls.getColorhexFromBlosum62(l.resn,d.resn);l.color=o,d.color=o,l.color2=u,d.color2=u;for(let e in s.residues[l.resid])s.atoms[e].color=n.parasCls.thr(o),s.atomPrevColors[e]=n.parasCls.thr(o);for(let e in s.residues[d.resid])s.atoms[e].color=n.parasCls.thr(o),s.atomPrevColors[e]=n.parasCls.thr(o);void 0===s.alnChainsAnTtl[c]&&(s.alnChainsAnTtl[c]=[]);for(let e=0;e<3;++e)void 0===s.alnChainsAnTtl[c][e]&&(s.alnChainsAnTtl[c][e]=[]);for(let e=0;e<3;++e)s.alnChainsAnTtl[c][e].push("");void 0===s.alnChainsSeq[c]&&(s.alnChainsSeq[c]=[]),void 0===s.alnChainsSeq[p]&&(s.alnChainsSeq[p]=[]),s.alnChainsSeq[c].push(l),s.alnChainsSeq[p].push(d),void 0===s.alnChains[c]&&(s.alnChains[c]={}),void 0===s.alnChains[p]&&(s.alnChains[p]={}),$.extend(s.alnChains[c],s.residues[c+"_"+l.resi]),$.extend(s.alnChains[p],s.residues[p+"_"+d.resi]),s.consHash1[c+"_"+l.resi]=1,s.consHash2[p+"_"+d.resi]=1,void 0===s.alnChainsAnno[c]&&(s.alnChainsAnno[c]=[]);for(let e=0;e<3;++e)void 0===s.alnChainsAnno[c][e]&&(s.alnChainsAnno[c][e]=[]);let m=".";a%5==0&&(m="*"),a%10==0&&(m="|"),s.alnChainsAnno[c][0].push(m);let f="";a%10==0&&(f=a.toString()),s.alnChainsAnno[c][1].push(f)}}async retrieveSymmetry(e){let t,i=this.icn3d,s=i.icn3dui,n=this,r="https://data.rcsb.org/rest/v1/core/assembly/"+e+"/1";try{t=await s.getAjaxPromise(r,"json",!1)}catch(e){return $("#"+i.pre+"dl_symmetry").html("<br>This structure has no symmetry."),void s.htmlCls.dialogCls.openDlg("dl_symmetry","Symmetry")}let a,o,l,d=t.rcsb_struct_symmetry;if(void 0!==d){void 0!==i.rmsd_supr&&void 0!==i.rmsd_supr.rot&&(a=i.rmsd_supr.rot,o=i.rmsd_supr.trans1,l=i.rmsd_supr.trans2),i.symmetryHash={};for(let e=0,t=d.length;e<t;++e){if("C1"==d[e].symbol)continue;let t="no title";"Pseudo Symmetry"==d[e].kind?t=d[e].symbol+" (pseudo)":"Global Symmetry"==d[e].kind?t=d[e].symbol+" (global)":"Local Symmetry"==d[e].kind&&(t=d[e].symbol+" (local)");let s=d[e].rotation_axes,r=[];for(let t=0,c=s.length;t<c;++t){let c=[],h=new mt(s[t].start[0],s[t].start[1],s[t].start[2]),p=new mt(s[t].end[0],s[t].end[1],s[t].end[2]);void 0!==i.rmsd_supr&&void 0!==i.rmsd_supr.rot&&(h=i.surfaceCls.transformMemPro(h,a,o,l),p=i.surfaceCls.transformMemPro(p,a,o,l)),c.push(h),c.push(p);let u=n.getAxisColor(d[e].symbol,s[t].order),m=n.getPolygonColor(d[e].symbol);c.push(u),c.push(m),c.push(s[t].order),c.push(d[e].clusters[0].members[0].asym_id),r.push(c)}i.symmetryHash[t]=r}if(0==Object.keys(i.symmetryHash).length)$("#"+i.pre+"dl_symmetry").html("<br>This structure has no symmetry.");else{let e="<option value='none'>None</option>",t=0;for(let s in i.symmetryHash){e+="<option value='"+s+"' "+(0==t?"selected":"")+">"+s+"</option>",++t}$("#"+i.pre+"selectSymmetry").html(e)}}else $("#"+i.pre+"dl_symmetry").html("<br>This structure has no symmetry.");s.htmlCls.dialogCls.openDlg("dl_symmetry","Symmetry")}getPolygonColor(e){let t=this.icn3d.icn3dui,i=e.substr(0,1);return"C"==i?t.parasCls.thr(16747520):"D"==i?t.parasCls.thr(65535):"T"==i?t.parasCls.thr(15631086):"O"==i?t.parasCls.thr(16753920):"I"==i?t.parasCls.thr(65280):t.parasCls.thr(11119017)}getAxisColor(e,t){let i=this.icn3d.icn3dui,s=e.substr(0,1);return"C"==s?i.parasCls.thr(16711680):"D"==s?2==t?i.parasCls.thr(65535):i.parasCls.thr(16711680):"T"==s?2==t?i.parasCls.thr(65535):i.parasCls.thr(65280):"O"==s||"I"==s?2==t?i.parasCls.thr(65535):3==t?i.parasCls.thr(65280):i.parasCls.thr(16711680):i.parasCls.thr(16711680)}}class ap{constructor(e){this.icn3d=e}alignSW(e,t,i,s,n,r,a){this.icn3d.icn3dui;let o=this.bsa_align(a,e,t,[i,s],[n,r]),l="score: "+o[0]+"\n";l+="start: "+o[1]+"\n",l+="cigar: "+this.bsa_cigar2str(o[2])+"\n\n",l+="alignment:\n\n";let d=this.bsa_cigar2gaps(e,t,o[1],o[2]),c={};return c.score=o[0],c.start=o[1],c.cigar=this.bsa_cigar2str(o[2]),c.target=d[0],c.query=d[1],c}bsg_enc_seq(e,t){if(this.icn3d.icn3dui,null==t)return null;let i=[];i.length=e.length;for(let s=0;s<e.length;++s)i[s]=t[e.charCodeAt(s)];return i}bsa_gen_score_matrix(e,t,i){this.icn3d.icn3dui;let s,n,r=[];for(i>0&&(i=-i),s=0;s<e-1;++s){for(r[s]=[],n=0;n<e-1;++n)r[s][n]=s==n?t:i;r[s][n]=0}r[e-1]=[];for(let t=0;t<e;++t)r[e-1][t]=0;return r}bsa_gen_query_profile(e,t,i){this.icn3d.icn3dui;let s,n="string"==typeof e?this.bsg_enc_seq(e,i):e,r=[];if(t.length>=2&&"number"==typeof t[0]&&"number"==typeof t[1]){if(null==i)return null;let e="number"==typeof i?i:i[i.length-1]+1;s=this.bsa_gen_score_matrix(e,t[0],t[1])}else s=t;for(let e=0;e<s.length;++e){let t,i=s[e];t=r[e]=[];for(let e=0;e<n.length;++e)t[e]=i[n[e]]}return r}bsa_align(e,t,i,s,n,r,a){this.icn3d.icn3dui;null==a&&(a=[4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,0,4,1,4,4,4,2,4,4,4,4,4,4,4,4,4,4,4,4,3,4,4,4,4,4,4,4,4,4,4,4,4,0,4,1,4,4,4,2,4,4,4,4,4,4,4,4,4,4,4,4,3,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4]);let o=this.bsg_enc_seq(t,a),l=this.bsa_gen_query_profile(i,s,a),d=l[0].length,c=d>o.length?d:o.length;r=null==r||r<0?c:r;let h,p,u=o.target>d?o.target-d:d-o.target;r=r>u?r:u,"number"==typeof n?(h=0,p=n>0?n:-n):(h=n[0]>0?n[0]:-n[0],p=n[1]>0?n[1]:-n[1]);let m,f=h+p,g=-1073741824,b=[],C=[],v=[],_=0,y=-1,S=-1;if(e)for(let e=0;e<=d;++e)b[e]=C[e]=0;else{b[0]=0,C[0]=-f-f;for(let e=1;e<=d;++e)e>=r?b[e]=C[e]=g:(b[e]=-(f+p*(e-1)),C[e]=-(f+f+p*e))}for(let t=0;t<o.length;++t){let i,s=0,n=0,a=0,c=-1,h=l[o[t]];i=v[t]=[];let u=t>r?t-r:0,m=t+r+1<d?t+r+1:d;e||(s=u>0?g:-(f+p*t),n=u>0?g:-(f+f+p*t));for(let t=u;t<m;++t){let r,o=C[t],l=b[t];b[t]=s,l+=h[t],r=l>=o?0:1,l=l>=o?l:o,r=l>=n?r:2,l=l>=n?l:n,r=!e||l>0?r:64,s=l,c=a>l?c:t,a=a>l?a:l,l-=f,l=!e||l>0?l:0,o-=p,r|=o>l?4:0,o=o>l?o:l,C[t]=o,n-=p,r|=n>l?32:0,n=n>l?n:l,i[t]=r}b[m]=s,C[m]=e?0:g,a>_&&(_=a,y=t,S=c)}if(e&&0==_)return null;m=e?_:b[d];let w,x,A,M=[],T=0,E=0;for(e?(x=y,A=S,S!=d-1&&this.push_cigar(M,4,d-1-S)):(x=o.length-1,A=(x+r+1<d?x+r+1:d)-1);x>=0&&A>=0&&(w=v[x][A-(x>r?x-r:0)],T=w>>(T<<1)&3,!(0==T&&w>>6));)0==T&&(T=3&w),0==T?(this.push_cigar(M,0,1),--x,--A):1==T?(this.push_cigar(M,2,1),--x):(this.push_cigar(M,1,1),--A);e?(A>=0&&this.push_cigar(M,4,A+1),E=x+1):(x>=0&&this.push_cigar(M,2,x+1),A>=0&&this.push_cigar(M,1,A+1));for(let e=0;e<M.length>>1;++e)w=M[e],M[e]=M[M.length-1-e],M[M.length-1-e]=w;return[m,E,M]}push_cigar(e,t,i){this.icn3d.icn3dui,0==e.length||t!=(15&e[e.length-1])?e.push(i<<4|t):e[e.length-1]+=i<<4}bsa_cigar2gaps(e,t,i,s){this.icn3d.icn3dui;let n="",r="",a="",o=0,l=i;for(let i=0;i<s.length;++i){let a=15&s[i],d=s[i]>>4;0==a?(n+=t.substr(o,d),r+=e.substr(l,d),o+=d,l+=d):1==a?(n+=t.substr(o,d),r+=Array(d+1).join("-"),o+=d):2==a?(n+=Array(d+1).join("-"),r+=e.substr(l,d),l+=d):4==a&&(o+=d)}let d=r.toUpperCase(),c=n.toUpperCase();for(let e=0;e<d.length;++e)a+=d.charAt(e)==c.charAt(e)?"|":" ";return[r,n,a]}bsa_cigar2str(e){this.icn3d.icn3dui;let t=[];for(let i=0;i<e.length;++i)t.push((e[i]>>4).toString()+"MIDNSHP=XB".charAt(15&e[i]));return t.join("")}}class op{constructor(e){this.icn3d=e}calculateArea(){var e=this.icn3d,t=e.icn3dui;e.bCalcArea=!0,e.opts.surface="solvent accessible surface",e.applyMapCls.applySurfaceOptions(),$("#"+e.pre+"areavalue").val(e.areavalue),$("#"+e.pre+"areatable").html(e.areahtml),t.htmlCls.dialogCls.openDlg("dl_area","Surface area calculation"),e.bCalcArea=!1}calcBuriedSurface(e,t){var i=this.icn3d,s=i.icn3dui;if(0==e.length)alert("Please select the first set");else{let n=s.hashUtilsCls.cloneHash(i.hAtoms),r=i.definedSetsCls.getAtomsFromNameArray(e),a=i.definedSetsCls.getAtomsFromNameArray(t);i.bCalcArea=!0,i.opts.surface="solvent accessible surface",i.hAtoms=s.hashUtilsCls.cloneHash(r),i.applyMapCls.applySurfaceOptions();let o=i.areavalue,l=s.hashUtilsCls.cloneHash(i.resid2area);i.hAtoms=s.hashUtilsCls.cloneHash(a),i.applyMapCls.applySurfaceOptions();let d=i.areavalue,c=s.hashUtilsCls.cloneHash(i.resid2area);i.hAtoms=s.hashUtilsCls.unionHash(i.hAtoms,r),i.applyMapCls.applySurfaceOptions();let h=i.areavalue,p=s.hashUtilsCls.cloneHash(i.resid2area),u=0,m=0,f=0,g=0;for(let e in l)p.hasOwnProperty(e)&&(g+=parseFloat(p[e]));m=(o-g).toFixed(2);for(let e in c)p.hasOwnProperty(e)&&(f+=parseFloat(p[e]));u=(d-f).toFixed(2),i.bCalcArea=!1,i.hAtoms=s.hashUtilsCls.cloneHash(n);let b=(parseFloat(d)+parseFloat(o)-parseFloat(h)).toFixed(2),C="<br>Calculate solvent accessible surface area in the interface:<br><br>";C+="Set 1: "+e+", Surface: "+o+" &#8491;<sup>2</sup><br>",C+="Set 2: "+t+", Surface: "+d+" &#8491;<sup>2</sup><br>",C+="Total Surface: "+h+" &#8491;<sup>2</sup><br>",C+="<b>Buried Surface for Set 1</b>: "+m+" &#8491;<sup>2</sup><br>",C+="<b>Buried Surface for Set 2</b>: "+u+" &#8491;<sup>2</sup><br><br>",$("#"+i.pre+"dl_buriedarea_html").html(C),s.htmlCls.dialogCls.openDlg("dl_buriedarea","Buried solvent accessible surface area in the interface"),s.htmlCls.clickMenuCls.setLogCmd("buried surface "+b,!1)}}measureDistTwoSets(e,t){var i=this.icn3d,s=i.icn3dui;if(0==e.length||0==t.length)alert("Please select two sets");else{let n=s.hashUtilsCls.cloneHash(i.hAtoms),r=i.definedSetsCls.getAtomsFromNameArray(e),a=i.definedSetsCls.getAtomsFromNameArray(t),o=i.contactCls.getExtent(r),l=i.contactCls.getExtent(a),d=new mt(o[2][0],o[2][1],o[2][2]),c=new mt(l[2][0],l[2][1],l[2][2]);i.hAtoms=s.hashUtilsCls.cloneHash(n),void 0===i.distPnts&&(i.distPnts=[]),i.distPnts.push(d),i.distPnts.push(c);let h=$("#"+i.pre+"distancecolor2").val();this.addLine(d.x,d.y,d.z,c.x,c.y,c.z,h,!0,"distance");let p=0,u=0,m=d.clone().add(c).multiplyScalar(.5),f=(parseInt(10*d.distanceTo(c))/10).toString()+" A";this.addLabel(f,m.x,m.y,m.z,p,h,u,"distance"),i.drawCls.draw()}}measureDistManySets(e,t){var i=this.icn3d,s=i.icn3dui;if(0==e.length||0==t.length)alert("Please select sets for distance calculation...");else{let n=s.hashUtilsCls.cloneHash(i.hAtoms),r={};for(let s=0,n=e.length;s<n;++s){let n=e[s],a=[n];r[n]={};for(let e=0,s=t.length;e<s;++e){let s=t[e],o=[s];if(n==s)continue;let l=i.definedSetsCls.getAtomsFromNameArray(a),d=i.definedSetsCls.getAtomsFromNameArray(o),c=i.contactCls.getExtent(l),h=i.contactCls.getExtent(d),p=new mt(c[2][0],c[2][1],c[2][2]),u=new mt(h[2][0],h[2][1],h[2][2]),m=p.distanceTo(u);r[n][s]=m.toFixed(2)}}i.hAtoms=s.hashUtilsCls.cloneHash(n);let a="Note: Click on the distance to show a dashed line in 3D view.<br><br>";a+="<table align=center border=1 cellpadding=10 cellspacing=0><tr><th></th>";for(let e=0,i=t.length;e<i;++e){a+="<th><b>"+t[e]+"</b> (&#8491;)</th>"}a+="</tr>";for(let i=0,s=e.length;i<s;++i){let s=e[i];a+="<tr><th><b>"+s+"</b> (&#8491;)</th>";for(let e=0,i=t.length;e<i;++e){let i=t[e];r[s]&&r[s][i]?a+='<td><span class="icn3d-distance" sets="'+s+"|"+i+'">'+r[s][i]+"</span></td>":a+="<td>0</td>"}a+="</tr>"}a+="</table><br><br>",$("#"+s.pre+"dl_disttable_html").html(a)}}measureAngleManySets(e,t){var i=this.icn3d,s=i.icn3dui;if(0==e.length||0==t.length)alert("Please select sets for angleance calculation...");else{let n={};for(let s=0,r=e.length;s<r;++s){let r=e[s],a=[r];n[r]={},i.hAtoms=i.definedSetsCls.getAtomsFromNameArray(a);let o=i.axesCls.setPc1Axes(!0);for(let e=0,s=t.length;e<s;++e){let s=t[e],a=[s];if(r==s)continue;i.hAtoms=i.definedSetsCls.getAtomsFromNameArray(a);let l=i.axesCls.setPc1Axes(!0),d=new mt(parseFloat(o.x),parseFloat(o.y),parseFloat(o.z)).angleTo(new mt(parseFloat(l.x),parseFloat(l.y),parseFloat(l.z)))/3.1416*180;d=Math.abs(d).toFixed(0),d>180&&(d-=180),d>90&&(d=180-d),n[r][s]=d}}let r="<table align=center border=1 cellpadding=10 cellspacing=0><tr><th></th>";for(let e=0,i=t.length;e<i;++e){r+="<th><b>"+t[e]+"</b> (&deg;)</th>"}r+="</tr>";for(let i=0,s=e.length;i<s;++i){let s=e[i];r+="<tr><th><b>"+s+"</b> (&deg;)</th>";for(let e=0,i=t.length;e<i;++e){let i=t[e];n[s]&&n[s][i]?r+="<td><span>"+n[s][i]+"</span></td>":r+="<td>0</td>"}r+="</tr>"}r+="</table><br><br>",$("#"+s.pre+"dl_angletable_html").html(r)}}addLine(e,t,i,s,n,r,a,o,l,d,c){var h=this.icn3d;h.icn3dui;let p={};p.position1=new mt(e,t,i),p.position2=new mt(s,n,r),p.color=a,p.dashed=o,p.radius=d,p.opacity=c,void 0===h.lines[l]&&(h.lines[l]=[]),void 0!==l?h.lines[l].push(p):(void 0===h.lines.custom&&(h.lines.custom=[]),h.lines.custom.push(p)),h.hlObjectsCls.removeHlObjects()}addLineFromPicking(e){var t=this.icn3d,i=t.icn3dui;let s=$("#"+t.pre+e+"color").val();t.pAtom.coord.x,t.pAtom2.coord.x,t.pAtom.coord.y,t.pAtom2.coord.y,t.pAtom.coord.z,t.pAtom2.coord.z;let n="stabilizer"!=e;i.htmlCls.clickMenuCls.setLogCmd("add line | x1 "+t.pAtom.coord.x.toPrecision(4)+" y1 "+t.pAtom.coord.y.toPrecision(4)+" z1 "+t.pAtom.coord.z.toPrecision(4)+" | x2 "+t.pAtom2.coord.x.toPrecision(4)+" y2 "+t.pAtom2.coord.y.toPrecision(4)+" z2 "+t.pAtom2.coord.z.toPrecision(4)+" | color "+s+" | dashed "+n+" | type "+e,!0),this.addLine(t.pAtom.coord.x,t.pAtom.coord.y,t.pAtom.coord.z,t.pAtom2.coord.x,t.pAtom2.coord.y,t.pAtom2.coord.z,s,n,e),t.pickpair=!1}addLabel(e,t,i,s,n,r,a,o){var l=this.icn3d;l.icn3dui;let d={};"0"!==n&&""!==n&&"undefined"!==n||(n=void 0),"0"!==r&&""!==r&&"undefined"!==r||(r=void 0),"0"!==a&&""!==a&&"undefined"!==a||(a=void 0);let c=new mt;c.x=t,c.y=i,c.z=s,d.position=c,d.text=e,d.size=n,d.color=r,d.background=a,void 0===l.labels[o]&&(l.labels[o]=[]),void 0!==o?l.labels[o].push(d):(void 0===l.labels.custom&&(l.labels.custom=[]),l.labels.custom.push(d)),l.hlObjectsCls.removeHlObjects()}addChainLabels(e){var t=this.icn3d;let i=t.icn3dui.hashUtilsCls.intHash(t.hAtoms,e);void 0===t.labels.chain&&(t.labels.chain=[]);let s=t.firstAtomObjCls.getChainsFromAtoms(i);for(let e in s){let i={};i.position=t.applyCenterCls.centerAtoms(t.chains[e]).center;let s=e.indexOf("_"),n=e.substr(s+1),r=t.showSeqCls.getProteinName(e);r.length>20&&(r=r.substr(0,20)+"..."),i.text="Chain "+n+": "+r,i.size=18,t.firstAtomObjCls.getFirstCalphaAtomObj(t.chains[e]).color.getHexString().toUpperCase(),i.color="black"!=t.opts.background?t.colorWhitebkgd:t.colorBlackbkgd,i.background="#FFFFFF",t.labels.chain.push(i)}t.hlObjectsCls.removeHlObjects()}addTerminiLabels(e){var t=this.icn3d,i=t.icn3dui;let s,n="#FFFFFF";s=i.hashUtilsCls.unionHash(s,t.proteins),s=i.hashUtilsCls.unionHash(s,t.nucleotides);let r=i.hashUtilsCls.intHash(t.dAtoms,s),a=i.hashUtilsCls.intHash(r,e);void 0===t.labels.chain&&(t.labels.chain=[]);let o=t.firstAtomObjCls.getChainsFromAtoms(a);for(let e in o){let s=i.hashUtilsCls.intHash(r,t.chains[e]),a=Object.keys(s),o=t.atoms[a[0]],l=t.atoms[a[a.length-1]],d={},c={};d.position=o.coord,c.position=l.coord,d.text="N-",c.text="C-",t.nucleotides.hasOwnProperty(o.serial)&&(d.text="5'",c.text="3'"),d.size=18,c.size=18,o.color.getHexString().toUpperCase(),l.color.getHexString().toUpperCase(),d.color="black"!=t.opts.background?t.colorWhitebkgd:t.colorBlackbkgd,c.color="black"!=t.opts.background?t.colorWhitebkgd:t.colorBlackbkgd,d.background=n,c.background=n,t.labels.chain.push(d),t.labels.chain.push(c)}t.hlObjectsCls.removeHlObjects()}}class lp{constructor(e){this.icn3d=e}draw2Ddgm(e,t,i,s){let n=this.icn3d,r=n.icn3dui,a=.667,o={},l={},d={},c={},h={};if(void 0===e)return"";for(let i in e.moleculeInfor){let s="#"+("000000"+e.moleculeInfor[i].color.toString(16)).slice(-6),r=e.moleculeInfor[i].chain.trim();void 0===h[r]?h[r]=1:++h[r];let a=t+"_"+(1===h[r]?r:r+h[r].toString());void 0!==n.mmdbid_q&&(n.mmdbid_q,n.mmdbid_t),o[i]=a,l[i]=s,d[i]=e.moleculeInfor[i].name,c[a]=i}if(void 0===s||!s)for(let i=0,s=e.intracResidues.length;i<s;++i){let s,r,a=e.intracResidues[i],l=0;for(let e in a){let t;t=o[e],0===l?s=t:r=t,++l}if(void 0!==s&&void 0!==r){l=0;for(let e in a){let i,o,d=a[e];0===l?(i=s,o=r):(i=r,o=s),void 0===n.chainids2resids[i]&&(n.chainids2resids[i]={}),void 0===n.chainids2resids[i][o]&&(n.chainids2resids[i][o]=[]);for(let s=0,r=d.length;s<r;++s){let r=d[s],a=n.mmdbMolidResid2mmdbChainResi[t.toUpperCase()+"_"+e+"_"+r];n.chainids2resids[i][o].push(a)}if(void 0===n.chainname2residues&&(n.chainname2residues={}),r=o,!n.chains.hasOwnProperty(r))continue;let c,h=n.firstAtomObjCls.getFirstCalphaAtomObj(n.chains[r]);n.chemicals.hasOwnProperty(h.serial)?c="chemical":n.nucleotides.hasOwnProperty(h.serial)?c="nucleotide":n.ions.hasOwnProperty(h.serial)?c="ion":n.proteins.hasOwnProperty(h.serial)?c="protein":n.water.hasOwnProperty(h.serial)&&(c="water");let p=r.substr(r.indexOf("_")+1)+"("+c+")";void 0===n.chainname2residues[i]&&(n.chainname2residues[i]={}),n.chainname2residues[i][p]=n.chainids2resids[i][o],++l}}}let p="<div id='#"+n.pre+t+"'>";p+="<b>"+t.toUpperCase()+"</b><br/>",p+="<svg viewBox='0,0,"+r.htmlCls.width2d+","+r.htmlCls.width2d+"'>";let u="#000000",m={},f=[],g="",b="",C={};if(s)for(let e in n.dAtoms){let t=n.atoms[e];C[c[t.structure+"_"+t.chain]]=1}let v=Object.keys(e.moleculeInfor),_=Object.keys(e.intrac),y=[];for(let e=0,t=v.length;e<t;++e)-1===_.indexOf(v[e])&&y.push(v[e]);let S={};if(y.length>0)for(let t in e.intrac){let i=e.intrac[t];for(let e=0,s=i.intrac.length;e<s;++e){let s=i.intrac[e].toString();-1!==y.indexOf(s)&&(void 0===S[s]&&(S[s]=[]),S[s].push(t),f.push([s,t]))}if("rect"===i.shape){let e=i.coords[0]*a,s=i.coords[1]*a,n=i.coords[2]*a-e,r=i.coords[3]*a-s;m[t]=[e+n/2,s+r/2]}else if("circle"===i.shape){let e=i.coords[0]*a,s=i.coords[1]*a;i.coords[2],m[t]=[e,s]}else if("poly"===i.shape){let e=i.coords[0]*a;i.coords[1],i.coords[2];let s=i.coords[3]*a;i.coords[4],i.coords[5],i.coords[6],i.coords[7],m[t]=[e,s]}}let w=0;for(let t=0,r=v.length;t<r;++t){let r=v[t],c=o[r];if(s&&!C.hasOwnProperty(r))continue;let h=e.intrac[r],p="#FFFFFF",u=l[r];if(void 0!==c&&void 0!==n.chains[c]){let e=Object.keys(n.chains[c]);e.length>0&&(u="#"+n.atoms[e[0]].color.getHexString().toUpperCase())}let _="";n.bInitial&&void 0!==i&&(void 0!==n.alignmolid2color&&n.alignmolid2color[i].hasOwnProperty(r)?(_=n.alignmolid2color[i][r],u="#FF0000"):u="#FFFFFF");let x=d[r],A=" ",M=" ";if(void 0!==c){let e=c.indexOf("_");M=c.substr(e+1),A=M.length>1?M.substr(0,1)+"..":M}else c="Misc";void 0===u&&(u="#FFFFFF");let T=1;if(n.bInitial&&void 0!==n.alnChains[c]){let e=0;for(let t in n.alnChains[c]){let i=n.atoms[t].color.getHexString().toUpperCase();"FF0000"!==i&&"00FF00"!==i||++e}T=1*e/Object.keys(n.chains[c]).length}if(T<.2&&(T=.2),-1===y.indexOf(r)){for(let e=0,t=h.intrac.length;e<t;++e)parseInt(r)<parseInt(h.intrac[e])&&f.push([r,h.intrac[e]]);if("rect"===h.shape){let e=h.coords[0]*a,t=h.coords[1]*a,i=h.coords[2]*a-e,s=h.coords[3]*a-t;g+=this.draw2DNucleotide(e+.5*i,t+.5*s,c,M,A,x,_,p,u,a,T),m[r]=[e+i/2,t+s/2]}else if("circle"===h.shape){let e=h.coords[0]*a,t=h.coords[1]*a;g+=this.draw2DProtein(e,t,c,M,A,x,_,p,u,a,T),m[r]=[e,t]}else if("poly"===h.shape){let e=h.coords[0]*a;h.coords[1],h.coords[2];let t=h.coords[3]*a;h.coords[4],h.coords[5],h.coords[6],h.coords[7];let i=e,s=t;n.firstAtomObjCls.getFirstAtomObj(n.chains[c]),b+=this.draw2DChemical(i,s,c,M,A,x,_,p,u,a,T),m[r]=[e,t]}}else{let e,t,i=300,s=50;if(void 0!==S[r]&&S[r].length>1){let i=0,s=0;for(let e=0,t=S[r].length;e<t;++e){let t=S[r][e];if(m.hasOwnProperty(t)){let e=m[t];i+=e[0],s+=e[1]}}e=i/S[r].length,t=s/S[r].length}else{let n=i/s;w<n-1?(e=(w+1)*s*a,t=.1*i*a):w-(n-1)<n-1?(e=.1*i*a,t=(w-(n-1)+1)*s*a):(e=.25*i*a,t=e),++w}let o=e,l=t;n.firstAtomObjCls.getFirstAtomObj(n.chains[c]);let d=!0;b+=this.draw2DChemical(o,l,c,M,A,x,_,p,u,a,T,d),m[r]=[o,l]}}for(let e=0,t=f.length;e<t;++e){let t=f[e];if(s&&(!C.hasOwnProperty(t[0])||!C.hasOwnProperty(t[1])))continue;let i,n,r=m[parseInt(t[0])],a=m[parseInt(t[1])];if(void 0===r||void 0===a)continue;i=o[t[0]],n=o[t[1]];let l=i.indexOf("_"),d=n.indexOf("_"),c=i.substr(l+1),h=n.substr(d+1),g=r[0],b=r[1],v=a[0],_=a[1],y=.5*(g+v),S=.5*(b+_);p+="<g class='icn3d-interaction' chainid1='"+i+"' chainid2='"+n+"' >",p+="<title>Interaction of chain "+c+" with chain "+h+"</title>",p+="<line x1='"+g+"' y1='"+b+"' x2='"+y+"' y2='"+S+"' stroke='"+u+"' stroke-width='2' /></g>",p+="<g class='icn3d-interaction' chainid1='"+n+"' chainid2='"+i+"' >",p+="<title>Interaction of chain "+h+" with chain "+c+"</title>",p+="<line x1='"+y+"' y1='"+S+"' x2='"+v+"' y2='"+_+"' stroke='"+u+"' stroke-width='2' /></g>"}return p+=b+g,p+="</svg>",p+="</div>",n.html2ddgm+=p,$("#"+n.pre+"dl_2ddgm_html").html(n.html2ddgm),p}set2DdgmNote(e){let t="<div style='width:150px'><b>Nodes</b>:<br>";return this.icn3d.icn3dui.utilsCls.isMac()?(t+="<span style='margin-right:18px;'>&#9711;</span>Protein<br>",t+="<span style='margin-right:18px;'>&#9634;</span>Nucleotide<br>",t+="<span style='margin-right:18px;'>&#9826;</span>Chemical<br>",t+="<span style='margin-right:18px;display: inline-block;transform: skew(-25deg);'>&#9634;</span>Biopolymer<br>"):(t+="<span style='margin-right:18px;'>O</span>Protein<br>",t+="<span style='margin-right:18px;'>&#9634;</span>Nucleotide<br>",t+="<span style='margin-right:18px;'>&#9671;</span>Chemical<br>",t+="<span style='margin-right:18px;display: inline-block;transform: skew(-25deg);'>&#9634;</span>Biopolymer<br>"),t+="<br><b>Lines</b>:<br> Interactions at 4 &#197;<br>",e&&(t+="<b>Numbers in red</b>:<br> Aligned chains"),t+="</div><br/>",t}highlightNode(e,t,i,s){let n=this.icn3d.icn3dui;s<.2&&(s=.2);if("rect"===e){$(t).attr("stroke",n.htmlCls.ORANGE),$(t).attr("stroke-width",3);let e=Number($(i).attr("x")),r=Number($(i).attr("y")),a=Number($(i).attr("width")),o=Number($(i).attr("height"));$(t).attr("x",e+a/2*(1-s)),$(t).attr("y",r+o/2*(1-s)),$(t).attr("width",a*s),$(t).attr("height",o*s)}else if("circle"===e)$(t).attr("stroke",n.htmlCls.ORANGE),$(t).attr("stroke-width",3),$(t).attr("r",Number($(i).attr("r"))*s);else if("polygon"===e){$(t).attr("stroke",n.htmlCls.ORANGE),$(t).attr("stroke-width",3);let e=Number($(i).attr("x")),r=Number($(i).attr("y")),a=Number($(i).attr("x0d")),o=Number($(i).attr("y0d")),l=Number($(i).attr("x1d")),d=Number($(i).attr("y1d")),c=Number($(i).attr("x2d")),h=Number($(i).attr("y2d")),p=Number($(i).attr("x3d")),u=Number($(i).attr("y3d"));$(t).attr("points",(e+a*s).toString()+", "+(r+o*s).toString()+", "+(e+l*s).toString()+", "+(r+d*s).toString()+", "+(e+c*s).toString()+", "+(r+h*s).toString()+", "+(e+p*s).toString()+", "+(r+u*s).toString())}}removeLineGraphSelection(){let e=this.icn3d;e.icn3dui,$("#"+e.pre+"dl_linegraph circle").attr("stroke","#000000"),$("#"+e.pre+"dl_linegraph circle").attr("stroke-width",1),$("#"+e.pre+"dl_linegraph svg line.icn3d-hlline").attr("stroke","#FFF")}removeScatterplotSelection(){let e=this.icn3d;e.icn3dui,$("#"+e.pre+"dl_scatterplot circle").attr("stroke","#000000"),$("#"+e.pre+"dl_scatterplot circle").attr("stroke-width",1),$("#"+e.pre+"dl_scatterplot rect").attr("stroke","#000000"),$("#"+e.pre+"dl_scatterplot rect").attr("stroke-width",1)}click2Ddgm(){let e=this.icn3d,t=e.icn3dui,i=this;$(document).on("click","#"+e.pre+"dl_2ddgm .icn3d-node",(function(e){let s=i.icn3d;e.stopImmediatePropagation(),Object.keys(s.hAtoms).length<Object.keys(s.atoms).length&&s.definedSetsCls.setMode("selection");let n=$(this).attr("chainid");s.bCtrl||s.bShift||(s.selectionCls.removeSelection(),s.lineArray2d=[]);let r=1;void 0!==s.alnChains[n]&&(r=1*Object.keys(s.alnChains[n]).length/Object.keys(s.chains[n]).length);let a=$(this).find("rect[class='icn3d-hlnode']"),o=$(this).find("rect[class='icn3d-basenode']");i.highlightNode("rect",a,o,r),a=$(this).find("circle[class='icn3d-hlnode']"),o=$(this).find("circle[class='icn3d-basenode']"),i.highlightNode("circle",a,o,r),a=$(this).find("polygon[class='icn3d-hlnode']"),o=$(this).find("polygon[class='icn3d-basenode']"),i.highlightNode("polygon",a,o,r),s.bCtrl||s.bShift?s.hAtoms=t.hashUtilsCls.unionHash(s.hAtoms,s.chains[n]):s.hAtoms=t.hashUtilsCls.cloneHash(s.chains[n]),s.bCtrl||s.bShift?(void 0===s.chainArray2d&&(s.chainArray2d=[]),s.chainArray2d.push(n)):s.chainArray2d=[n],s.hlUpdateCls.updateHlAll(s.chainArray2d),s.annotationCls.showAnnoSelectedChains();let l="select chain "+n;t.htmlCls.clickMenuCls.setLogCmd(l,!0),s.bSelectResidue=!1})),$(document).on("click","#"+e.pre+"dl_2ddgm .icn3d-interaction",(function(e){let s=i.icn3d;e.stopImmediatePropagation(),Object.keys(s.hAtoms).length<Object.keys(s.atoms).length&&s.definedSetsCls.setMode("selection"),s.bClickInteraction=!0;let n=$(this).attr("chainid1"),r=$(this).attr("chainid2");$(this).find("line").attr("stroke",t.htmlCls.ORANGE),i.selectInteraction(n,r),s.annotationCls.showAnnoSelectedChains();let a="select interaction "+n+","+r;t.htmlCls.clickMenuCls.setLogCmd(a,!0),s.bClickInteraction=!1})),$(document).on("click","#"+e.pre+"dl_linegraph .icn3d-node",(function(e){let s=i.icn3d;e.stopImmediatePropagation(),Object.keys(s.hAtoms).length<Object.keys(s.atoms).length&&s.definedSetsCls.setMode("selection");let n=$(this).attr("resid");s.bCtrl||s.bShift||(s.hAtoms={},i.removeLineGraphSelection());$(this).find("circle").attr("stroke",t.htmlCls.ORANGE),$(this).find("circle").attr("stroke-width",2),s.hAtoms=t.hashUtilsCls.unionHash(s.hAtoms,s.residues[n]);let r="select "+s.resid2specCls.residueids2spec([n]);s.hlUpdateCls.updateHlAll(),t.htmlCls.clickMenuCls.setLogCmd(r,!0),s.bSelectResidue=!1})),$(document).on("click","#"+e.pre+"dl_scatterplot .icn3d-node",(function(e){i.icn3d,e.stopImmediatePropagation(),i.clickNode(this)})),$(document).on("click","#"+e.pre+"dl_ligplot .icn3d-node",(function(e){i.icn3d,e.stopImmediatePropagation(),i.clickNode(this)})),$(document).on("click","#"+e.pre+"dl_linegraph .icn3d-interaction",(function(e){let s=i.icn3d;e.stopImmediatePropagation(),Object.keys(s.hAtoms).length<Object.keys(s.atoms).length&&s.definedSetsCls.setMode("selection");let n=$(this).attr("resid1"),r=$(this).attr("resid2");s.bCtrl||s.bShift||(s.hAtoms={},i.removeLineGraphSelection()),$(this).find("line.icn3d-hlline").attr("stroke",t.htmlCls.ORANGE);$("[resid="+n+"]").find("circle").attr("stroke",t.htmlCls.ORANGE),$("[resid="+n+"]").find("circle").attr("stroke-width",2),$("[resid="+r+"]").find("circle").attr("stroke",t.htmlCls.ORANGE),$("[resid="+r+"]").find("circle").attr("stroke-width",2),s.hAtoms=t.hashUtilsCls.unionHash(s.hAtoms,s.residues[n]),s.hAtoms=t.hashUtilsCls.unionHash(s.hAtoms,s.residues[r]);let a="select "+s.resid2specCls.residueids2spec([n,r]);s.hlUpdateCls.updateHlAll(),s.transformCls.zoominSelection(),t.htmlCls.clickMenuCls.setLogCmd(a,!0)})),$(document).on("click","#"+e.pre+"dl_scatterplot .icn3d-interaction",(function(e){let t=i.icn3d;e.stopImmediatePropagation(),i.clickInteraction(this),t.transformCls.zoominSelection()})),$(document).on("click","#"+e.pre+"dl_contactmap .icn3d-interaction",(function(e){i.icn3d,e.stopImmediatePropagation(),i.clickInteraction(this)})),$(document).on("click","#"+e.pre+"dl_contactmap .icn3d-node",(function(e){i.icn3d,e.stopImmediatePropagation(),i.clickNode(this)})),$(document).on("click","#"+e.pre+"dl_alignerrormap .icn3d-interaction",(function(e){i.icn3d,e.stopImmediatePropagation(),i.clickInteraction(this)})),$(document).on("click","#"+e.pre+"dl_ligplot .icn3d-interaction",(function(e){i.icn3d,e.stopImmediatePropagation(),i.clickInteraction(this)})),$(document).on("click","#"+e.pre+"dl_alignerrormap .icn3d-node",(function(e){i.icn3d,e.stopImmediatePropagation(),i.clickNode(this)}))}clickNode(e){let t=this.icn3d,i=t.icn3dui;Object.keys(t.hAtoms).length<Object.keys(t.atoms).length&&t.definedSetsCls.setMode("selection");let s=$(e).attr("resid");t.bCtrl||t.bShift||(t.hAtoms={},this.removeScatterplotSelection());$(e).find("circle").attr("stroke",i.htmlCls.ORANGE),$(e).find("circle").attr("stroke-width",2),$(e).find("rect").attr("stroke",i.htmlCls.ORANGE),$(e).find("rect").attr("stroke-width",2),t.hAtoms=i.hashUtilsCls.unionHash(t.hAtoms,t.residues[s]);let n="select "+t.resid2specCls.residueids2spec([s]);t.hlUpdateCls.updateHlAll(),i.htmlCls.clickMenuCls.setLogCmd(n,!0),t.bSelectResidue=!1}clickInteraction(e){let t=this.icn3d,i=t.icn3dui;Object.keys(t.hAtoms).length<Object.keys(t.atoms).length&&t.definedSetsCls.setMode("selection");let s=$(e).attr("resid1"),n=$(e).attr("resid2");t.bCtrl||t.bShift||(t.hAtoms={},this.removeScatterplotSelection());$(e).find("rect").attr("stroke",i.htmlCls.ORANGE),$(e).find("rect").attr("stroke-width",2),t.hAtoms=i.hashUtilsCls.unionHash(t.hAtoms,t.residues[s]),t.hAtoms=i.hashUtilsCls.unionHash(t.hAtoms,t.residues[n]);let r="select "+t.resid2specCls.residueids2spec([s,n]);t.hlUpdateCls.updateHlAll(),i.htmlCls.clickMenuCls.setLogCmd(r,!0)}selectInteraction(e,t){let i=this.icn3d;i.icn3dui,i.hlUpdateCls.removeHl2D(),i.hlObjectsCls.removeHlObjects(),i.bCtrl||i.bShift?(void 0===i.lineArray2d&&(i.lineArray2d=[]),i.lineArray2d.push(e),i.lineArray2d.push(t)):i.lineArray2d=[e,t],this.selectInteractionAtoms(e,t),i.hlObjectsCls.addHlObjects(),i.hlUpdateCls.updateHlAll()}selectInteractionAtoms(e,t){let i,s,n=this.icn3d,r=n.icn3dui,a=n.chainids2resids[e][t];n.bCtrl||n.bShift||(n.hAtoms={});for(let e=0,t=a.length;e<t;++e)n.hAtoms=r.hashUtilsCls.unionHash(n.hAtoms,n.residues[a[e]]);if(Object.keys(n.structures).length>1)i="inter_"+e+"_"+t;else{let s=e.indexOf("_"),n=t.indexOf("_");i="inter_"+e.substr(s+1)+"_"+t.substr(n+1)}s="select the atoms in chain "+e+" interacting with chain "+t+" in a distance of 4 angstrom";let o="select interaction "+e+","+t;n.selectionCls.addCustomSelection(a,i,s,o,!0)}draw2DProtein(e,t,i,s,n,r,a,o,l,d,c){this.icn3d.icn3dui;let h="#000000",p=20*d,u="<g class='icn3d-node' chainid='"+i+"' >";return u+="<title>Chain "+s+": "+r+"</title>",u+="<circle class='icn3d-basenode' cx='"+e+"' cy='"+t+"' r='"+p+"' fill='"+o+"' stroke-width='1' stroke='"+h+"' class='icn3d-node' chainid='"+i+"' />",u+="<circle class='icn3d-hlnode' cx='"+e+"' cy='"+t+"' r='"+(p*c).toString()+"' fill='"+l+"' stroke-width='1' stroke='"+h+"' />",u+="<text x='"+(e-0).toString()+"' y='"+(t+4).toString()+"' style='fill:#000000; font-size:10; text-anchor:middle' >"+n+"</text>",""!==a&&(u+="<text x='"+(e-0).toString()+"' y='"+(t+p+4+6).toString()+"' style='fill:"+l+"; font-size:8; font-weight:bold; text-anchor:middle' >"+a+"</text>"),u+="</g>",u}draw2DNucleotide(e,t,i,s,n,r,a,o,l,d,c){this.icn3d.icn3dui;let h="#000000",p=30*d,u=30*d,m="<g class='icn3d-node' chainid='"+i+"' >";return m+="<title>Chain "+s+": "+r+"</title>",m+="<rect class='icn3d-basenode' x='"+(e-=.5*p)+"' y='"+(t-=.5*u)+"' width='"+p+"' height='"+u+"' fill='"+o+"' stroke-width='1' stroke='"+h+"' />",m+="<rect class='icn3d-hlnode' x='"+(e+p/2*(1-c)).toString()+"' y='"+(t+u/2*(1-c)).toString()+"' width='"+(p*c).toString()+"' height='"+(u*c).toString()+"' fill='"+l+"' stroke-width='1' stroke='"+h+"' />",m+="<text x='"+(e+p/2-0).toString()+"' y='"+(t+u/2+4).toString()+"' style='fill:#000000; font-size:10; text-anchor:middle' >"+n+"</text>",""!==a&&(m+="<text x='"+(e+p/2-0).toString()+"' y='"+(t+u+4+6).toString()+"' style='fill:"+l+"; font-size:8; font-weight:bold; text-anchor:middle' >"+a+"</text>"),m+="</g>",m}draw2DChemical(e,t,i,s,n,r,a,o,l,d,c,h){this.icn3d.icn3dui;let p,u,m,f,g,b,C,v,_="#000000",y=30*d;if(h){let i=.5*y/Math.sqrt(3),s=.5*y;p=e-i,u=t-s,m=e+3*i,f=t-s,g=e+i,b=t+s,C=e-3*i,v=t+s}else{let i=.5*y,s=.5*y;p=e-i,u=t,m=e,f=t+s,g=e+i,b=t,C=e,v=t-s}let S=p-e,w=u-t,x=m-e,A=f-t,M=g-e,T=b-t,E=C-e,R=v-t,k="<g class='icn3d-node' chainid='"+i+"' >";return k+="<title>Chain "+s+": "+r+"</title>",k+="<polygon class='icn3d-basenode' points='"+p+", "+u+","+m+", "+f+","+g+", "+b+","+C+", "+v+"' x='"+e+"' y='"+t+"' x0d='"+S+"' y0d='"+w+"' x1d='"+x+"' y1d='"+A+"' x2d='"+M+"' y2d='"+T+"' x3d='"+E+"' y3d='"+R+"' fill='"+o+"' stroke-width='1' stroke='"+_+"' />",k+="<polygon class='icn3d-hlnode' points='"+(e+S*c).toString()+", "+(t+w*c).toString()+","+(e+x*c).toString()+", "+(t+A*c).toString()+","+(e+M*c).toString()+", "+(t+T*c).toString()+","+(e+E*c).toString()+", "+(t+R*c).toString()+"' fill='"+l+"' stroke-width='1' stroke='"+_+"' />",k+="<text x='"+(e+1).toString()+"' y='"+(t+2).toString()+"' style='fill:#000000; font-size:8; text-anchor:middle' >"+n+"</text>",""!==a&&(k+="<text x='"+(e+1).toString()+"' y='"+(t+2+6).toString()+"' style='fill:"+l+"; font-size:8; font-weight:bold; text-anchor:middle' >"+a+"</text>"),k+="</g>",k}}class dp{constructor(e){this.icn3d=e}async draw2Dcartoon(e,t){let i=this.icn3d,s=i.icn3dui,n=this;if(s.htmlCls.clickMenuCls.setLogCmd("cartoon 2d "+e,!0),i.cartoon2dType=e,t){let t=n.getCartoonSvg(e,i.graphStr);$("#"+s.svgid_ct).html(t)}else{await this.getNodesLinksForSetCartoon(e),i.graphStr=n.getCartoonData(e,i.node_link);let t=n.getCartoonSvg(e,i.graphStr);$("#"+s.svgid_ct).html(t),n.setEventsForCartoon2d(),s.htmlCls.dialogCls.openDlg("dl_2dctn","2D Cartoon")}}getCartoonSvg(e,t){let i=this.icn3d,s=i.icn3dui,n="",r="",a=JSON.parse(t);i.ctnNodeHash={};for(let t=0,s=a.nodes.length;t<s;++t){let s=a.nodes[t];i.ctnNodeHash[s.id]=s,r+="secondary"==e?this.drawHelix(e,s.id,s.ss,s.x,s.y,s.x1,s.y1,s.x2,s.y2,s.len,s.ang,s.c):this.drawOval(e,s.id,s.x,s.y,s.rx,s.ry,s.ang,s.c,s.from,s.to)}i.nodeid2lineid={};for(let t=0,r=a.links.length;t<r;++t){let r=a.links[t].source,o=a.links[t].target,l=i.ctnNodeHash[r].x,d=s.htmlCls.width2d-i.ctnNodeHash[r].y,c=i.ctnNodeHash[o].x,h=s.htmlCls.width2d-i.ctnNodeHash[o].y;"chain"==e?n+="<g class='icn3d-ctinteraction' chainid1='"+i.ctnNodeHash[r].id+"' chainid2='"+i.ctnNodeHash[o].id+"' >":"domain"==e?n+="<g class='icn3d-ctinteraction' from1='"+i.ctnNodeHash[r].from+"' to1='"+i.ctnNodeHash[r].to+"' from2='"+i.ctnNodeHash[o].from+"' to2='"+i.ctnNodeHash[o].to+"' >":"secondary"==e&&(l=i.ctnNodeHash[r].x2,d=s.htmlCls.width2d-i.ctnNodeHash[r].y2,c=i.ctnNodeHash[o].x1,h=s.htmlCls.width2d-i.ctnNodeHash[o].y1,n+="<g class='icn3d-ctinteraction' range1='"+i.ctnNodeHash[r].range+"' range2='"+i.ctnNodeHash[o].range+"' >");let p=r+"--"+o;n+="<title>Interaction of "+e+" "+this.getLabelFromId(r,e)+" with "+e+" "+this.getLabelFromId(o,e)+"</title>",n+="<line class='icn3d-edge' id='"+p+"' x1='"+l+"' y1='"+d+"' x2='"+c+"' y2='"+h+"' stroke='#bbbbbb' stroke-width='1' /></g>",i.nodeid2lineid.hasOwnProperty(r)||(i.nodeid2lineid[r]=[]),i.nodeid2lineid.hasOwnProperty(o)||(i.nodeid2lineid[o]=[]),i.nodeid2lineid[r].push(p),i.nodeid2lineid[o].push(p)}return n+=r,n}setEventsForCartoon2d(){let e=this.icn3d,t=e.icn3dui;$("#"+t.svgid_ct+" .icn3d-ctnode").draggable({start:function(e,t){let i=parseFloat(e.target.getAttribute("cx")),s=parseFloat(e.target.getAttribute("cy"));e.target.setAttribute("cx",i),e.target.setAttribute("cy",s);let n=e.target.getAttribute("ang");if(n)e.target.setAttribute("transform","rotate("+n+","+i+","+s+")");else{let t=parseFloat(e.target.getAttribute("x1")),i=parseFloat(e.target.getAttribute("y1")),s=parseFloat(e.target.getAttribute("x2")),n=parseFloat(e.target.getAttribute("y2"));e.target.setAttribute("x1",t),e.target.setAttribute("y1",i),e.target.setAttribute("x2",s),e.target.setAttribute("y2",n)}},drag:function(i,s){let n=$("#"+t.svgid_ct).offset().left,r=$("#"+t.svgid_ct).offset().top,a=i.target.getAttribute("id"),o=i.target.getAttribute("ang"),l=i.clientX-n,d=i.clientY-r,c=parseFloat(i.target.getAttribute("cx")),h=parseFloat(i.target.getAttribute("cy")),p=(l-c)/e.resizeRatioX,u=(d-h)/e.resizeRatioY,m=parseFloat($("#"+a+"_text").attr("x")),f=parseFloat($("#"+a+"_text").attr("y"));if($("#"+a+"_text").attr("x",m+p),$("#"+a+"_text").attr("y",f+u),i.target.setAttribute("cx",l),i.target.setAttribute("cy",d),o)i.target.setAttribute("transform","rotate("+o+","+l+","+d+")");else{let e=parseFloat(i.target.getAttribute("x1")),t=parseFloat(i.target.getAttribute("y1")),s=parseFloat(i.target.getAttribute("x2")),n=parseFloat(i.target.getAttribute("y2"));if(i.target.setAttribute("x1",e+p),i.target.setAttribute("y1",t+u),i.target.setAttribute("x2",s+p),i.target.setAttribute("y2",n+u),"S"==a.substr(0,1)){let e=parseFloat($("#"+a+"_box").attr("x1")),t=parseFloat($("#"+a+"_box").attr("y1")),i=parseFloat($("#"+a+"_box").attr("x2")),s=parseFloat($("#"+a+"_box").attr("y2"));$("#"+a+"_box").attr("x1",e+p),$("#"+a+"_box").attr("y1",t+u),$("#"+a+"_box").attr("x2",i+p),$("#"+a+"_box").attr("y2",s+u)}}if(e.nodeid2lineid[a])for(let t=0,i=e.nodeid2lineid[a].length;t<i;++t){g(e.nodeid2lineid[a][t],a,o)}function g(e,t,i){if(e&&-1!=e.indexOf(t)){let t=e.split("--");if(2==t.length){let s,n;s=t[1],n=t[0];let r=i?"cx":"x1",a=i?"cy":"y1",o=$("#"+s).attr(r),l=$("#"+s).attr(a);$("#"+e).attr("x1",o),$("#"+e).attr("y1",l);let d=i?"cx":"x2",c=i?"cy":"y2",h=$("#"+n).attr(d),p=$("#"+n).attr(c);$("#"+e).attr("x2",h),$("#"+e).attr("y2",p)}}}}})}getLabelFromId(e,t){let i=e,s=i.indexOf("__");return-1!==s&&(i=i.substr(0,s)),"secondary"==t&&(i=i.substr(0,i.indexOf("-"))),i}drawHelix(e,t,i,s,n,r,a,o,l,d,c,h){let p=this.icn3d.icn3dui,u=this.getLabelFromId(t,e);n=p.htmlCls.width2d-n,a=p.htmlCls.width2d-a,l=p.htmlCls.width2d-l;let m="<g range='"+u.substr(1)+"' >";return m+="<title>"+e+" "+u+"</title>","H"==t.substr(0,1)?m+="<line id='"+t+"' class='icn3d-ctnode' x1='"+r+"' y1='"+a+"' x2='"+o+"' y2='"+l+"' cx='"+.5*(r+o).toFixed(1)+"' cy='"+.5*(a+l).toFixed(1)+"' stroke='#"+h+"' stroke-width='3' stroke-linecap='round' />":(m+="<line id='"+t+"_box' x1='"+r+"' y1='"+a+"' x2='"+o+"' y2='"+l+"' stroke='#"+h+"' stroke-width='3' stroke-linecap='square' />",m+="<line id='"+t+"' class='icn3d-ctnode' x1='"+r+"' y1='"+a+"' x2='"+o+"' y2='"+l+"' cx='"+.5*(r+o).toFixed(1)+"' cy='"+.5*(a+l).toFixed(1)+"' stroke='#FFF' stroke-width='1' stroke-linecap='square' />"),m+="<text id='"+t+"_text' x='"+(s-0).toString()+"' y='"+(n+4).toString()+"' style='fill:#000000; text-anchor:middle' class='icn3d-node-text8' >"+u+"</text>",m+="</g>",m}drawOval(e,t,i,s,n,r,a,o,l,d){let c=this.icn3d.icn3dui,h=this.getLabelFromId(t,e);s=c.htmlCls.width2d-s,a=180-a;let p="chain"==e?"<g chainid='"+t+"' >":"<g from='"+l+"' to='"+d+"' >";return p+="<title>"+e+" "+h+"</title>",p+="<defs>",p+="<linearGradient id='"+t+"_g_obj' x1='0%' y1='0%' x2='100%' y2='0%'>",p+="  <stop offset='0%' style='stop-color:rgb(255,255,255);stop-opacity:1' />",p+="  <stop offset='100%' style='stop-color:#"+o+";stop-opacity:1' />",p+="</linearGradient>",p+="</defs>",p+="<ellipse id='"+t+"' class='icn3d-ctnode' cx='"+i.toFixed(0)+"' cy='"+s.toFixed(0)+"' rx='"+n.toFixed(0)+"' ry='"+r.toFixed(0)+"' fill='url(#"+t+"_g_obj)' stroke-width='1' stroke='none' ",p+=" ang='"+a+"' transform='rotate("+a+","+i.toFixed(0)+","+s.toFixed(0)+")'",p+="chain"==e?" chainid='"+t+"' />":" from='"+l+"' to='"+d+"' />",p+="<text id='"+t+"_text' x='"+(i-0).toString()+"' y='"+(s+4).toString()+"' style='fill:#000000; text-anchor:middle' class='icn3d-node-text12' >"+h+"</text>",p+="</g>",p}getCartoonData(e,t){let i=this.icn3d;i.icn3dui;let s,n,r=[],a=[];r=t.node;let o=[],l={},d=0;for(let e=0,t=r.length;e<t;++e){let t=r[e],i=JSON.parse(t);l.hasOwnProperty(i.id)||(o.push(i),l[i.id]=d,++d)}let c=[];for(let e=0,t=o.length;e<t;++e){let t=o[e];c.push(JSON.stringify(t))}s=c.join(", "),a=t.link,n=a.join(", "),i.hAtoms;let h='{"nodes": ['+s+'], "links": [';return h+=n+"",h+='], "level": "'+(t.level?t.level:"")+'"}',h}projectTo2d(e){let t=this.icn3d,i=t.icn3dui,s=e.project(t.cam);var n=new mt;return n.x=Math.round((s.x+1)*i.htmlCls.width2d*.5),n.y=Math.round(-s.y*i.htmlCls.width2d*.5),n.z=0,n.y>0?n.y=i.htmlCls.width2d-n.y:n.y=-n.y,n}async getNodesLinksForSetCartoon(e){let t,i,s,n,r,a=this.icn3d,o=a.icn3dui,l=this,d=[],c=[],h=0,p=o.htmlCls.defaultValue,u="",m="",f="",g=!1,b=!0;if("chain"==e){let e={};for(let t in a.hAtoms){let i=a.atoms[t];if("DUM"==i.chain)continue;let s=i.structure+"_"+i.chain;(a.proteins.hasOwnProperty(t)||a.nucleotides.hasOwnProperty(t))&&(e.hasOwnProperty(s)||(e[s]={}),e[s][i.serial]=i)}let t=a.contactCls.getExtent(a.atoms),i=9999,s=9999,n=-9999,l=-9999,h=-9999,p=[];for(let d in e){a.hAtom={},a.hAtoms=o.hashUtilsCls.cloneHash(a.chains[d]);let e=a.axesCls.setPc1Axes(),c=e[0],u=e[1].distanceTo(e[0]),m=e[2].distanceTo(e[0]),f=180*new pt(e[1].x-e[0].x,e[1].y-e[0].y).angle()/Math.PI;f>180&&(f-=180);let g=Object.keys(a.hAtoms)[0],b=a.atoms[g];r=d,c=this.projectTo2d(c);let C=c.x,v=c.y;C<i&&(i=C),C>n&&(n=C),v<s&&(s=v),v>l&&(l=v);let _=.5;u=_*o.htmlCls.width2d*u/(t[1][0]-t[0][0]),m=_*o.htmlCls.width2d*m/(t[1][1]-t[0][1]),u>h&&(h=u),m>h&&(h=m),p.push({id:d,r:r,x:C,y:v,rx:u,ry:m,ang:f,c:b.color.getHexString()})}let u=h+2,m=n-i,f=l-s;for(let e=0,t=p.length;e<t;++e){let t=p[e],n=m<1?.5*o.htmlCls.width2d:(t.x-i)/m*(o.htmlCls.width2d-2*u)+u,r=f<1?.5*o.htmlCls.width2d:(t.y-s)/f*(o.htmlCls.width2d-2*u)+u;d.push('{"id": "'+t.id+'", "r": "'+t.r+'", "x": '+n.toFixed(0)+', "y": '+r.toFixed(0)+', "rx": '+t.rx.toFixed(0)+', "ry": '+t.ry.toFixed(0)+', "ang": '+t.ang.toFixed(0)+', "c": "'+t.c.toUpperCase()+'"}')}a.hAtoms=o.hashUtilsCls.cloneHash(a.dAtoms),a.node_link={node:d,link:c,level:"chain"}}else if("domain"==e)a.chainid2pssmid||await a.loadScriptCls.applyCommandAnnotationsAndCddSite("view annotations"),l.getNodesLinksForDomains(a.chainid2pssmid);else if("secondary"==e){a.resi2resirange={};let e,l=[];a.contactCls.getExtent(a.atoms);let C="",v=9999,_=9999,y=-9999,S=-9999,w=2,x=[];for(let d in a.hAtoms){let w=a.atoms[d];if("DUM"!=w.chain&&((w.ssbegin||w.ssend)&&"CA"==w.name&&"C"==w.elem)){let d=w.structure+"_"+w.chain+"_"+w.resi;if(b&&w.ssbegin&&(g=!0,b=!1,t=w,C="helix"==w.ss?"H":"S",n=C+w.resi,r="1_1_"+d,f=w.chain),g&&(e=o.utilsCls.residueName2Abbr(w.resn)+w.resi,e+="__"+w.chain,Object.keys(a.structures).length>1&&(e+="__"+w.structure),l.push(e)),f==w.chain&&g&&w.ssend){let o=this.projectTo2d(t.coord.clone()),d=o.x,f=o.y,A=this.projectTo2d(w.coord.clone()),M=A.x,T=A.y;i=.5*(d+M),s=.5*(f+T),d=.5*(i+d),f=.5*(s+f),M=.5*(i+M),T=.5*(s+T),d<v&&(v=d),d>y&&(y=d),f<_&&(_=f),f>S&&(S=f),M<v&&(v=M),M>y&&(y=M),T<_&&(_=T),T>S&&(S=T),g=!1,b=!0,n+="-"+w.resi,r+="-"+w.resi,n+="__"+w.chain,Object.keys(a.structures).length>1&&(n+="__"+w.structure);for(let t=0,i=l.length;t<i;++t)e=l[t],a.resi2resirange[e]=n;l=[],h>0&&u==w.chain&&c.push('{"source": "'+m+'", "target": "'+n+'", "v": '+p+', "c": "'+t.color.getHexString().toUpperCase()+'"}'),x.push({id:n,r:r,ss:C,x:i,y:s,x1:d,y1:f,x2:M,y2:T,c:w.color.getHexString()}),u=w.chain,m=n,++h}}}let A=w+2,M=y-v,T=S-_;for(let e=0,t=x.length;e<t;++e){let t=x[e],i=M<1?.5*o.htmlCls.width2d:(t.x-v)/M*(o.htmlCls.width2d-2*A)+A,s=T<1?.5*o.htmlCls.width2d:(t.y-_)/T*(o.htmlCls.width2d-2*A)+A,n=M<1?.5*o.htmlCls.width2d:(t.x1-v)/M*(o.htmlCls.width2d-2*A)+A,r=T<1?.5*o.htmlCls.width2d:(t.y1-_)/T*(o.htmlCls.width2d-2*A)+A,a=M<1?.5*o.htmlCls.width2d:(t.x2-v)/M*(o.htmlCls.width2d-2*A)+A,l=T<1?.5*o.htmlCls.width2d:(t.y2-_)/T*(o.htmlCls.width2d-2*A)+A;d.push('{"id": "'+t.id+'", "r": "'+t.r+'", "x": '+i.toFixed(0)+', "y": '+s.toFixed(0)+', "x1": '+n.toFixed(0)+', "y1": '+r.toFixed(0)+', "x2": '+a.toFixed(0)+', "y2": '+l.toFixed(0)+', "c": "'+t.c.toUpperCase()+'"}')}a.node_link={node:d,link:c,level:"secondary"}}}getNodesLinksForDomains(e){let t=this.icn3d,i=t.icn3dui,s=[],n=[],r=i.htmlCls.defaultValue;t.resi2resirange={};let a={};for(let e in t.hAtoms){let i=t.atoms[e];"DUM"!=i.chain&&(a[i.structure+"_"+i.chain]=1)}let o=t.contactCls.getExtent(t.atoms),l=9999,d=9999,c=-9999,h=-9999,p=-9999,u=[];for(let s in a){if(!e.hasOwnProperty(s))continue;let a=e[s].pssmid2name,f=e[s].pssmid2fromArray,g=e[s].pssmid2toArray,b={};for(let e in a){let t=f[e];b[e]=t[0]}var m=Object.keys(b);let C,v;m.sort((function(e,t){return b[e]-b[t]}));for(let e=0,b=m.length;e<b;++e){let b=m[e],_=a[b];_+="__"+s.substr(s.indexOf("_")+1),Object.keys(t.structures).length>1&&(_+="__"+s.substr(0,s.indexOf("_")));let y=f[b],S=g[b];t.hAtoms={};for(let e=0,n=y.length;e<n;++e){let n=parseInt(y[e])+1,r=parseInt(S[e])+1;for(let e=n;e<=r;++e)t.hAtoms=i.hashUtilsCls.unionHash(t.hAtoms,t.residues[s+"_"+e])}if(0==Object.keys(t.hAtoms).length)continue;let w=t.axesCls.setPc1Axes(),x=w[0],A=w[1].distanceTo(w[0]),M=w[2].distanceTo(w[0]),T=180*new pt(w[1].x-w[0].x,w[1].y-w[0].y).angle()/Math.PI;T>180&&(T-=180);let E=Object.keys(t.hAtoms)[0],R=t.atoms[E];x=this.projectTo2d(x);let k=x.x,O=x.y;k<l&&(l=k),k>c&&(c=k),O<d&&(d=O),O>h&&(h=O);let I=.5;A=I*i.htmlCls.width2d*A/(o[1][0]-o[0][0]),M=I*i.htmlCls.width2d*M/(o[1][1]-o[0][1]),A>p&&(p=A),M>p&&(p=M),void 0!==C&&n.push('{"source": "'+C+'", "target": "'+_+'", "v": '+r+', "c": "'+v.color.getHexString().toUpperCase()+'"}'),u.push({id:_,from:y+"",to:S+"",x:k,y:O,rx:A,ry:M,ang:T,c:R.color.getHexString()}),C=_,v=R}}let f=p+2,g=c-l,b=h-d;for(let e=0,t=u.length;e<t;++e){let t=u[e],n=g<1?.5*i.htmlCls.width2d:(t.x-l)/g*(i.htmlCls.width2d-2*f)+f,r=b<1?.5*i.htmlCls.width2d:(t.y-d)/b*(i.htmlCls.width2d-2*f)+f;s.push('{"id": "'+t.id+'", "from": "'+t.from+'", "to": "'+t.to+'", "x": '+n.toFixed(0)+', "y": '+r.toFixed(0)+', "rx": '+t.rx.toFixed(0)+', "ry": '+t.ry.toFixed(0)+', "ang": '+t.ang.toFixed(0)+', "c": "'+t.c.toUpperCase()+'"}')}t.hAtoms=i.hashUtilsCls.cloneHash(t.dAtoms),t.node_link={node:s,link:n,level:"domain"}}getSelection(e,t,i){let s=this.icn3d,n=s.icn3dui,r={},a=[],o=t.toString().split(","),l=i.toString().split(","),d=3==e.length?e[2]:Object.keys(s.structures)[0],c=e.length>=2?d+"_"+e[1]:Object.keys(s.chains)[0];for(let e=0,t=o.length;e<t;++e){let t=parseInt(o[e])+1,i=parseInt(l[e])+1;for(let e=t;e<=i;++e){let t=c+"_"+e;r=n.hashUtilsCls.unionHash(r,s.residues[t]),a.push(t)}}return{atomSet:r,residArray:a}}click2Dcartoon(){let e=this.icn3d,t=e.icn3dui,i=this;t.myEventCls.onIds("#"+t.pre+"2dctn_chain","click",(async function(e){let s=t.icn3d;e.preventDefault(),i.initCartoonSvg(),await s.cartoon2dCls.draw2Dcartoon("chain")})),t.myEventCls.onIds("#"+t.pre+"2dctn_domain","click",(async function(e){let s=t.icn3d;e.preventDefault(),i.initCartoonSvg(),await s.cartoon2dCls.draw2Dcartoon("domain")})),t.myEventCls.onIds("#"+t.pre+"2dctn_secondary","click",(async function(e){let s=t.icn3d;e.preventDefault(),i.initCartoonSvg(),await s.cartoon2dCls.draw2Dcartoon("secondary")})),$(document).on("click","#"+e.pre+"dl_2dctn .icn3d-ctnode",(function(e){let s=i.icn3d;e.stopImmediatePropagation(),Object.keys(s.hAtoms).length<Object.keys(s.atoms).length&&s.definedSetsCls.setMode("selection");let n,r={},a=[],o=$(this).attr("id"),l=$(this).attr("chainid"),d=$(this).attr("from"),c=$(this).attr("to"),h=$(this).attr("x1");if(void 0!==l)n="chain",r=s.chains[l];else if(void 0!==d){n="domain";let e=o.split("__"),t=i.getSelection(e,d,c);r=t.atomSet,a=t.residArray}else if(void 0!==h){n="secondary";let e=o.split("__"),t=e[0].substr(1).split("-"),s=parseInt(t[0])-1,l=parseInt(t[1])-1,d=i.getSelection(e,s,l);r=d.atomSet,a=d.residArray}s.bCtrl||s.bShift||(s.selectionCls.removeSelection(),s.lineArray2d=[]),void 0!==s.alnChains[l]&&(Object.keys(s.alnChains[l]).length,Object.keys(s.chains[l]).length),s.bCtrl||s.bShift?s.hAtoms=t.hashUtilsCls.unionHash(s.hAtoms,r):s.hAtoms=t.hashUtilsCls.cloneHash(r),"chain"==n?(s.bCtrl||s.bShift?(void 0===s.chainArray2d&&(s.chainArray2d=[]),s.chainArray2d.push(l)):s.chainArray2d=[l],s.hlUpdateCls.updateHlAll(s.chainArray2d)):s.hlUpdateCls.updateHlAll(),s.annotationCls.showAnnoSelectedChains();let p="chain"==n?"select chain "+l:"select "+s.resid2specCls.residueids2spec(a);t.htmlCls.clickMenuCls.setLogCmd(p,!0),s.bSelectResidue=!1}))}initCartoonSvg(){let e=this.icn3d,t=e.icn3dui;e.resizeRatioX=1,e.resizeRatioY=1,$("#"+t.svgid_ct).empty()}}class cp{constructor(e){this.icn3d=e}async drawLigplot(e,t){let i=this.icn3d,s=i.icn3dui;t?s.htmlCls.dialogCls.openDlg("dl_ligplot","2D Depiction"):s.htmlCls.dialogCls.openDlg("dl_ligplot","Show ligand interactions with atom details");let n,r,a=100,o=100;i.len4ang=80;let l=i.saveFileCls.getAtomPDB(e);l=l.trim(),l=l.replace(/\n\n/g,"\n");let d={pdb2svg:l},c=s.htmlCls.baseUrl+"openbabel/openbabel.cgi",h=(await s.getAjaxPostPromise(c,d,void 0,void 0,void 0,void 0,"text")).split("\n"),p="",u="",m={},f=0,g=0,b=0;i.svgGridSize=i.len4ang,i.gridXY2used={};for(let e=0,t=h.length;e<t;++e){let t=h[e];if(0==t.indexOf("<svg width")){let e=t.indexOf('viewBox="')+9,s=t.substr(e),l=s.substr(0,s.indexOf('"')).split(" ");n=parseFloat(l[2]),r=parseFloat(l[3]),a=n+2*i.len4ang,o=r+2*i.len4ang}else if(0==t.indexOf("<line"))p+=t+"\n";else if(0==t.indexOf("<text"))if(-1!=t.indexOf('font-size="12"')){let e=t.indexOf(">")+1,s=t.substr(e),n=parseInt(s.substr(0,s.indexOf("<")));e=t.indexOf('x="')+3;let r=t.substr(e),a=parseFloat(r.substr(0,r.indexOf('"')));e=t.indexOf('y="')+3;let o=t.substr(e),l=parseFloat(o.substr(0,o.indexOf('"')));m[n]={x:a,y:l};let d=parseInt(a/i.svgGridSize),c=parseInt(l/i.svgGridSize);i.gridXY2used[d+"_"+c]=1,f+=a,g+=l,++b}else u+=t+"\n";else if(0==t.indexOf("</svg>"))break}let C=f/b,v=g/b,_=s.ligplotid;i.ligplotWidth=a;let y=i.ligplotWidth,S=o+30,w=-i.len4ang,x="<svg id='"+_+"' viewBox='"+w+","+w+","+a+","+S+"' width='"+y+"px' font-family='sans-serif' stroke='rgb(0,0,0)' stroke-width='2' stroke-linecap='round'>";if(t)x+=p+u;else{let e=parseInt(n/i.svgGridSize),t=parseInt(r/i.svgGridSize),s=i.viewInterPairsCls.getAllInteractionTable("save1",m,e,t,C,v);x+=p+s.svgHtmlLine,x+=u+s.svgHtmlNode}x+="</svg>",t?$("#"+i.pre+"ligplotDiv").html(x):($("#"+i.pre+"ligplotDiv").html(x),this.setEventsForLigplot())}getSvgPerPair(e,t,i,s,n,r,a,o,l,d,c,h,p){let u=this.icn3d,m=u.icn3dui,f="hbond"==s||"contact"==s||"halogen"==s?u.len4ang:1.5*u.len4ang,g=u.len4ang/2,b="contact"==s?1:2,C=u.getGraphCls.convertLabel2Resid(t),v=u.firstAtomObjCls.getFirstAtomObj(u.residues[C]),_=u.getGraphCls.convertLabel2Resid(i),y=u.firstAtomObjCls.getFirstAtomObj(u.residues[_]),S=0,w=0,x=0,A=v.serial;for(let t=0,i=e.length;t<i;++t){let i=e[t]-A+1;S+=n[i].x,w+=n[i].y,++x}let M,T,E,R=S/x-1,k=w/x- -1;if(u.resid2cnt.hasOwnProperty(t)?++u.resid2cnt[t]:u.resid2cnt[t]=0,!c&&!u.resid2ToXy.hasOwnProperty(_)){let e=parseInt(R/u.svgGridSize),i=parseInt(k/u.svgGridSize),s=[];for(let t=1;t>=-1;--t)for(let n=1;n>=-1;--n)0==t&&0==n||e+t>=0&&e+t<=r&&i+n>=0&&i+n<=a&&s.push(e+t+"_"+(i+n));for(let t=2;t>=-2;--t)for(let n=2;n>=-2;--n)t>=-1&&t<=1&&n>=-1&&n<=1||e+t>=0&&e+t<=r&&i+n>=0&&i+n<=a&&s.push(e+t+"_"+(i+n));let n,d=!1;for(let e=0,t=s.length;e<t;++e)if(!u.gridXY2used[s[e]]){n=s[e].split("_"),M=(parseInt(n[0])+.5)*u.svgGridSize,T=(parseInt(n[1])+.5)*u.svgGridSize;let t=Math.sqrt((R-M)*(R-M)+(k-T)*(k-T));M=f/t*(M-R)+R,T=f/t*(T-k)+k,u.gridXY2used[s[e]]=1,d=!0;break}if(!d){let e=R-o,i=k-l,s=0;s=Math.abs(e)>Math.abs(i)?e>0?0:180:i>0?90:270,E=s-10+30*u.resid2cnt[t],M=R+f*Math.cos(E*Math.PI/180),T=k+f*Math.sin(E*Math.PI/180)}}let O,I=m.utilsCls.residueName2Abbr(y.resn.substr(0,3))+y.resi,P=y.color?y.color.getHexString():"000",D=u.lineGraphCls.getStrokecolor(void 0,s),L="",F="",N=_+"--"+e.join("-")+s;"hbond"==s?O="H-Bonds":"ionic"==s?O="Salt Bridge/Ionic":"halogen"==s?O="Halogen Bonds":"pi-cation"==s?O="&pi;-Cation":"pi-stacking"==s?O="&pi;-Stacking":"contact"==s&&(O="Contacts");let U=_;if(c||u.resid2ToXy.hasOwnProperty(U)){M=u.resid2ToXy.hasOwnProperty(U)?u.resid2ToXy[U].x2:h,T=u.resid2ToXy.hasOwnProperty(U)?u.resid2ToXy[U].y2:p;let e=R,t=k,i=0;if("contact"==s){let s=Math.sqrt((R-M)*(R-M)+(k-T)*(k-T));g<s&&(e=g/s*(R-M)+M,t=g/s*(k-T)+T,i=1)}F+="<g><title>Interaction type: "+O+"; Distance: "+parseFloat(d).toFixed(1)+" &#197;</title>",F+='<line class="icn3d-interaction" id="'+N+'" resid1="'+C+'" resid2="'+_+'" x1="'+e.toFixed(2)+'" y1="'+t.toFixed(2)+'" x2="'+M.toFixed(2)+'" y2="'+T.toFixed(2)+'" x0="'+R.toFixed(2)+'" y0="'+k.toFixed(2)+'" short="'+i+'" opacity="1.0" stroke="'+D+'"  stroke-width="'+b+'" stroke-dasharray="5,5"/>\n',F+="</g>\n"}else{L+="<g><title>"+I+"</title>";let e=28,t=14;L+='<rect id="'+U+'_node" x="'+(M-.5*e).toFixed(2)+'" y="'+(T-.5*t).toFixed(2)+'" width="'+e+'" height="'+t+'" rx="2" ry="2" fill="#'+P+'" stroke-width="1" stroke="'+P+'" resid="'+_+'"/>',L+='<text class="icn3d-ctnode" resid="'+U+'" id="'+U+'" x="'+M.toFixed(2)+'" y="'+T.toFixed(2)+'" fill="#000" stroke="none" text-anchor="middle" alignment-baseline="central" style="font-size:10px">'+I+"</text>",L+="</g>\n",F+="<g><title>Interaction type: "+O+"; Distance: "+parseFloat(d).toFixed(1)+" &#197;</title>",F+='<line class="icn3d-interaction" id="'+N+'" resid1="'+C+'" resid2="'+_+'" x1="'+R.toFixed(2)+'" y1="'+k.toFixed(2)+'" x2="'+M.toFixed(2)+'" y2="'+T.toFixed(2)+'" opacity="1.0" stroke="'+D+'"  stroke-width="'+b+'" stroke-dasharray="5,5"/>',F+="</g>\n","contact"!=s&&(u.resid2ToXy.hasOwnProperty(_)||(u.resid2ToXy[_]={x2:M,y2:T}))}return u.nodeid2lineid.hasOwnProperty(U)||(u.nodeid2lineid[U]=[]),u.nodeid2lineid[U].push(N),{node:L,line:F,x2:M,y2:T}}setEventsForLigplot(){let e=this.icn3d,t=e.icn3dui;$("#"+t.ligplotid+" .icn3d-ctnode").draggable({start:function(e,t){let i=parseFloat(e.target.getAttribute("x")),s=parseFloat(e.target.getAttribute("y"));e.target.setAttribute("x",i),e.target.setAttribute("y",s)},drag:function(i,s){let n=e.ligplotScale?e.ligplotScale:1,r=$("#"+t.ligplotid).offset().left+e.len4ang*n,a=$("#"+t.ligplotid).offset().top+e.len4ang*n,o=i.target.getAttribute("resid"),l=(i.clientX-r)/n,d=(i.clientY-a)/n,c=parseFloat(i.target.getAttribute("x")),h=parseFloat(i.target.getAttribute("y")),p=l-c,u=d-h;if(c=parseFloat($("#"+o+"_node").attr("x")),h=parseFloat($("#"+o+"_node").attr("y")),$("#"+o+"_node").attr("x",c+p),$("#"+o+"_node").attr("y",h+u),i.target.setAttribute("x",l),i.target.setAttribute("y",d),e.nodeid2lineid[o])for(let t=0,i=e.nodeid2lineid[o].length;t<i;++t){m(e.nodeid2lineid[o][t],o)}function m(t,i){if(t&&-1!=t.indexOf(i)){let i=t.split("--");if(2==i.length){let s;i[1],s=i[0];let n=parseFloat($("#"+s).attr("x")),r=parseFloat($("#"+s).attr("y"));$("#"+t).attr("x2",n),$("#"+t).attr("y2",r);let a=$("#"+t).attr("x1"),o=$("#"+t).attr("y1"),l=a,d=o;if(parseInt($("#"+t).attr("short"))){a=$("#"+t).attr("x0"),o=$("#"+t).attr("y0");let i=Math.sqrt((a-n)*(a-n)+(o-r)*(o-r)),s=e.len4ang/2;s<i&&(l=s/i*(a-n)+n,d=s/i*(o-r)+r)}$("#"+t).attr("x1",l),$("#"+t).attr("y1",d)}}}}})}clickLigplot(){let e=this.icn3d;e.icn3dui;let t=this;$(document).on("click","#"+e.pre+"dl_ligplot .icn3d-ctnode",(function(e){let i=t.icn3d;e.stopImmediatePropagation(),i.diagram2dCls.clickNode(this)}))}}class hp{constructor(e){this.icn3d=e}resizeCanvas(e,t,i,s){var n=this.icn3d,r=n.icn3dui;if(i||r.cfg.resize){let i=t;$("#"+n.pre+"canvas").width(e).height(i),$("#"+n.pre+"viewer").width(e).height(t),$("#"+n.divid+" div:has(#"+n.pre+"canvas)").width(e).height(i),n.applyCenterCls.setWidthHeight(e,i),n.structures&&Object.keys(n.structures).length>0&&(void 0===s||s)&&n.drawCls.draw()}}windowResize(){let e=this.icn3d.icn3dui,t=this;e.cfg.resize&&!e.utilsCls.isMobile()&&$(window).resize((function(){let i=t.icn3d;e.utilsCls.setViewerWidthHeight(i.icn3dui);let s=e.htmlCls.WIDTH,n=e.htmlCls.HEIGHT;void 0===i||i.bFullscreen||t.resizeCanvas(s,n)}))}openFullscreen(e){this.icn3d.icn3dui.bNode||document.fullscreenElement||document.mozFullScreenElement||document.webkitFullscreenElement||document.msFullscreenElement||(e.requestFullscreen?e.requestFullscreen():e.mozRequestFullScreen?e.mozRequestFullScreen():e.webkitRequestFullscreen?e.webkitRequestFullscreen():e.msRequestFullscreen&&e.msRequestFullscreen())}rotStruc(e,t){var i=this.icn3d;i.icn3dui;let s=this;if(i.bStopRotate)return!1;if(i.transformCls.rotateCount>i.transformCls.rotateCountMax)return i.transformCls.resetOrientation(),!1;if(++i.transformCls.rotateCount,t)if("left"===e)i.ROT_DIR="left";else if("right"===e)i.ROT_DIR="right";else if("up"===e)i.ROT_DIR="up";else{if("down"!==e)return!1;i.ROT_DIR="down"}if("left"===e&&"left"===i.ROT_DIR)i.transformCls.rotateLeft(1);else if("right"===e&&"right"===i.ROT_DIR)i.transformCls.rotateRight(1);else if("up"===e&&"up"===i.ROT_DIR)i.transformCls.rotateUp(1);else{if("down"!==e||"down"!==i.ROT_DIR)return!1;i.transformCls.rotateDown(1)}setTimeout((function(){s.rotStruc(e)}),100)}async back(){var e=this.icn3d;e.icn3dui,e.backForward=!0,e.STATENUMBER--,e.bAddCommands=!1,e.bAddLogs=!1,e.bNotLoadStructure=!0,e.STATENUMBER<1?e.STATENUMBER=1:await e.loadScriptCls.execCommands(0,e.STATENUMBER-1,e.STATENUMBER,!0),e.setStyleCls.adjustIcon(),e.bAddCommands=!0,e.bAddLogs=!0}async forward(){var e=this.icn3d;e.icn3dui,e.backForward=!0,e.STATENUMBER++,e.bAddCommands=!1,e.bAddLogs=!1,e.bNotLoadStructure=!0,e.STATENUMBER>e.commands.length?e.STATENUMBER=e.commands.length:await e.loadScriptCls.execCommands(0,e.STATENUMBER-1,e.STATENUMBER,!0),e.setStyleCls.adjustIcon(),e.bAddCommands=!0,e.bAddLogs=!0}async replayon(){var e=this.icn3d;e.icn3dui,e.CURRENTNUMBER=0,e.bReplay=1,$("#"+e.pre+"replay").show(),e.commands.length>0&&await e.loadScriptCls.replayFirstStep(e.CURRENTNUMBER)}async replayoff(){var e=this.icn3d;e.icn3dui,e.bReplay=0,$("#"+e.pre+"replay").hide(),++e.CURRENTNUMBER,await e.loadScriptCls.execCommands(e.CURRENTNUMBER,e.STATENUMBER-1,e.STATENUMBER)}closeDialogs(){var e=this.icn3d,t=e.icn3dui;let i=["dl_2ddgm","dl_2dctn","dl_alignment","dl_sequence2","dl_definedsets","dl_setsmenu","dl_command","dl_setoperations","dl_vast","dl_foldseek","dl_mmtfid","dl_pdbid","dl_afid","dl_opmid","dl_pdbfile","dl_pdbfile_app","dl_rescolorfile","dl_customcolor","dl_align","dl_alignaf","dl_chainalign","dl_chainalign2","dl_chainalign3","dl_mutation","dl_mol2file","dl_sdffile","dl_xyzfile","dl_clustalwfile","dl_fastafile","dl_afmapfile","dl_urlfile","dl_mmciffile","dl_mmcifid","dl_mmdbid","dl_mmdbafid","dl_blast_rep_id","dl_yournote","dl_proteinname","dl_refseqid","dl_cid","dl_pngimage","dl_state","dl_fixedversion","dl_selection","dl_dsn6","dl_dsn6url","dl_clr","dl_symmetry","dl_symd","dl_contact","dl_hbonds","dl_realign","dl_realignbystruct","dl_allinteracton","dl_interactionsorted","dl_linegraph","dl_linegraphcolor","dl_scatterplot","dl_scatterploitcolor","dl_contactmap","dl_alignerrormap","dl_elecmap2fofc","dl_elecmapfofc","dl_emmap","dl_aroundsphere","dl_adjustmem","dl_selectplane","dl_addlabel","dl_addlabelselection","dl_labelColor","dl_distance","dl_stabilizer","dl_disttwosets","dl_distmanysets","dl_stabilizer_rm","dl_thickness","dl_thickness2","dl_addtrack","dl_addtrack_tabs","dl_saveselection","dl_copyurl","dl_selectannotations","dl_annotations_tabs","dl_anno_view_tabs","dl_annotations","dl_graph","dl_svgcolor","dl_area","dl_colorbyarea","dl_rmsd","dl_buriedarea","dl_propbypercentout","dl_propbybfactor","dl_legend","dl_disttable","dl_translate"];for(let s in i){let n=i[s];t.cfg.notebook?$("#"+e.pre+n).hide():$("#"+e.pre+n).hasClass("ui-dialog-content")&&$("#"+e.pre+n).dialog("isOpen")&&$("#"+e.pre+n).dialog("close").remove()}t.cfg.notebook||this.resizeCanvas(t.htmlCls.WIDTH,t.htmlCls.HEIGHT,!0)}}class pp{constructor(e){this.icn3d=e}resetOrientation(){let e=this.icn3d;e.icn3dui;let t=!1;if(e.commands.length>0){let i=e.commands[0].split("|||");if(2==i.length){let s=JSON.parse(i[1]);e._zoomFactor=s.factor,e.mouseChange.x=s.mouseChange.x,e.mouseChange.y=s.mouseChange.y,e.quaternion._x=s.quaternion._x,e.quaternion._y=s.quaternion._y,e.quaternion._z=s.quaternion._z,e.quaternion._w=s.quaternion._w,t=!0}}t||(e._zoomFactor=1,e.mouseChange=new pt(0,0),e.quaternion=new ut(0,0,0,1)),e.maxD=e.oriMaxD,e.center=e.oriCenter.clone(),"show"==e.ori_chemicalbinding?e.bSkipChemicalbinding=!1:"hide"==e.ori_chemicalbinding&&(e.bSkipChemicalbinding=!0)}rotateLeft(e){let t=this.icn3d,i=t.icn3dui,s=new mt(0,1,0),n=-e/180*Math.PI;t.bControlGl&&!i.bNode?s.applyQuaternion(window.cam.quaternion).normalize():s.applyQuaternion(t.cam.quaternion).normalize();let r=new ut;r.setFromAxisAngle(s,-n);let a={};a.quaternion=r,a.update=!0,t.bControlGl&&!i.bNode?window.controls.update(a):t.controls.update(a),t.bRender&&t.drawCls.render()}rotateRight(e){let t=this.icn3d,i=t.icn3dui,s=new mt(0,1,0),n=e/180*Math.PI;t.bControlGl&&!i.bNode?s.applyQuaternion(window.cam.quaternion).normalize():s.applyQuaternion(t.cam.quaternion).normalize();let r=new ut;r.setFromAxisAngle(s,-n);let a={};a.quaternion=r,a.update=!0,t.bControlGl&&!i.bNode?window.controls.update(a):t.controls.update(a),t.bRender&&t.drawCls.render()}rotateUp(e){this.icn3d.icn3dui,this.rotate_base(-e)}rotateDown(e){this.icn3d.icn3dui,this.rotate_base(e)}rotate_base(e){let t=this.icn3d,i=t.icn3dui,s=new mt(1,0,0),n=e/180*Math.PI;t.bControlGl&&!i.bNode?s.applyQuaternion(window.cam.quaternion).normalize():s.applyQuaternion(t.cam.quaternion).normalize();let r=new ut;r.setFromAxisAngle(s,-n);let a={};a.quaternion=r,a.update=!0,t.bControlGl&&!i.bNode?window.controls.update(a):t.controls.update(a),t.bRender&&t.drawCls.render()}setRotation(e,t){let i=this.icn3d,s=i.icn3dui;if(!e)return;i.bControlGl&&!s.bNode&&window.cam?e.applyQuaternion(window.cam.quaternion).normalize():i.cam&&e.applyQuaternion(i.cam.quaternion).normalize();let n=new ut;n.setFromAxisAngle(e,-t);let r={};r.quaternion=n,r.update=!0,i.bControlGl&&!s.bNode&&window.controls?window.controls.update(r):i.controls&&i.controls.update(r),i.bRender&&i.drawCls.render()}translateLeft(e){this.icn3d.icn3dui,this.translate_base(-e,0)}translateRight(e){this.icn3d.icn3dui,this.translate_base(e,0)}translateUp(e){this.icn3d.icn3dui,this.translate_base(0,-e)}translateDown(e){this.icn3d.icn3dui,this.translate_base(0,e)}translate_base(e,t){let i=this.icn3d,s=i.icn3dui,n=new pt(0,0);n.x+=e/100,n.y+=t/100;let r={};r.mouseChange=n,r.update=!0,i.bControlGl&&!s.bNode?window.controls.update(r):i.controls.update(r),i.bRender&&i.drawCls.render()}translateCoord(e,t,i,s){let n=this.icn3d;n.icn3dui;for(let r in e){let e=n.atoms[r];e.coord.x+=t,e.coord.y+=i,e.coord.z+=s}}rotateCoord(e,t){let i=this.icn3d;i.icn3dui;const s=new gi;s.elements=t;for(let t in e){let e=i.atoms[t];e.coord=e.coord.applyMatrix4(s)}}zoominSelection(e){let t=this.icn3d,i=t.icn3dui,s={};if(s._zoomFactor=1/t._zoomFactor,s.update=!0,t.bControlGl&&!i.bNode?window.controls&&window.controls.update(s):t.controls&&t.controls.update(s),void 0===e&&(e=i.hashUtilsCls.hash2Atoms(t.hAtoms,t.atoms)),Object.keys(e).length>1){let i=t.applyCenterCls.centerAtoms(e);t.maxD=i.maxD,t.maxD<5&&(t.maxD=5),t.center=i.center,t.applyCenterCls.setCenter(t.center),t.cameraCls.setCamera()}}getTransformationStr(e){this.icn3d.icn3dui;let t={factor:1,mouseChange:{x:0,y:0},quaternion:{_x:0,_y:0,_z:0,_w:1}};return t.factor=parseFloat(e.factor).toPrecision(4),t.mouseChange.x=parseFloat(e.mouseChange.x).toPrecision(4),t.mouseChange.y=parseFloat(e.mouseChange.y).toPrecision(4),t.quaternion._x=parseFloat(e.quaternion._x).toPrecision(4),t.quaternion._y=parseFloat(e.quaternion._y).toPrecision(4),t.quaternion._z=parseFloat(e.quaternion._z).toPrecision(4),t.quaternion._w=parseFloat(e.quaternion._w).toPrecision(4),"1.0000"==t.factor&&(t.factor=1),"0.0000"==t.mouseChange.x&&(t.mouseChange.x=0),"0.0000"==t.mouseChange.y&&(t.mouseChange.y=0),"0.0000"==t.quaternion._x&&(t.quaternion._x=0),"0.0000"==t.quaternion._y&&(t.quaternion._y=0),"0.0000"==t.quaternion._z&&(t.quaternion._z=0),"1.0000"==t.quaternion._w&&(t.quaternion._w=1),JSON.stringify(t)}}class up{constructor(e){this.icn3d=e}async saveFile(e,t,i,s,n){let r,a=this.icn3d,o=a.icn3dui,l=this;if("command"===t){let e=a.loadCmd?a.loadCmd+"\n":"";for(let t=0,i=a.commands.length;t<i;++t){let s=a.commands[t].trim();if(t==i-1){let e=s.split("|||"),t={};t.factor=a._zoomFactor,t.mouseChange=a.mouseChange,t.quaternion=a.quaternion,s=e[0]+"|||"+a.transformCls.getTransformationStr(t)}e+=s+"\n"}let t=decodeURIComponent(e);r=new Blob([t],{type:"text;charset=utf-8;"})}else if("png"===t){let t=$("#"+a.pre+"canvas").width(),i=$("#"+a.pre+"canvas").height();a.applyCenterCls.setWidthHeight(t,i),a.bRender&&a.drawCls.render();let d=!0;if(window.File&&window.FileReader&&window.FileList&&window.Blob||(d=!1),r=o.utilsCls.isIE()?a.renderer.domElement.msToBlob():await this.getBlobFromNonIE(),n)return r;if(!d)return l.saveBlob(r,e,s,t,i),r;{let n=new FileReader;n.onload=function(n){let d=n.target.result,c=a.shareLinkCls.getPngText();return r=o.convertTypeCls.getBlobFromBufferAndText(d,c),l.saveBlob(r,e,s,t,i),r},n.readAsArrayBuffer(r)}a.scaleFactor=1,a.applyCenterCls.setWidthHeight(t,i),a.bRender&&a.drawCls.render()}else if("html"===t){let e=decodeURIComponent(i);r=new Blob([e],{type:"text/html;charset=utf-8;"})}else if("text"===t){r=new Blob(i,{type:"text;charset=utf-8;"})}else if("binary"===t){r=new Blob(i,{type:"application/octet-stream"})}return"png"!==t&&(n||saveAs(r,e)),r}getBlobFromNonIE(){let e=this.icn3d;return e.icn3dui,new Promise((function(t,i){e.renderer.domElement.toBlob((function(e){t(e)}))}))}saveBlob(e,t,i,s,n){let r=this.icn3d;if(r.icn3dui,i){let t=(window.URL||window.webkitURL).createObjectURL(e),i=r.shareLinkCls.shareLinkUrl();i=i.replace(/imageonly=1/g,""),i.length>4e3||0!==i.indexOf("http")||r.bInputfile&&!r.bInputUrlfile?$("#"+r.pre+"viewer").html("<img src='"+t+"'/>"):$("#"+r.pre+"viewer").html("<a href='"+i+"' target='_blank'><img src='"+t+"'/></a>"),$("#"+r.pre+"viewer").width(s),$("#"+r.pre+"viewer").height(n),$("#"+r.pre+"cmdlog").hide(),$("#"+r.pre+"title").hide(),$("#"+r.pre+"mnlist").hide(),$("#"+r.pre+"fullscreen").length>0&&$("#"+r.pre+"fullscreen").hide(),r={}}else saveAs(e,t)}saveSvg(e,t,i,s){let n=this.icn3d;if(n.icn3dui.bNode)return"";let r=$("#"+e).width(),a=$("#"+e).height();i&&(a=r),s&&(r+=n.len4ang,a+=n.len4ang);let o=this.getSvgXml(e,r,a,i,s),l=new Blob([o],{type:"image/svg+xml"});saveAs(l,t)}getSvgXml(e,t,i,s,n){if(this.icn3d.icn3dui.bNode)return"";return(t&&i?'<svg viewBox="'+(n?-30:0)+" "+(n?-30:0)+" "+t+" "+i+'"':"<svg")+' title="graph" xmlns:xl="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" xmlns:dc="http://purl.org/dc/elements/1.1/">'+"<style>text {font-family: sans-serif; font-weight: bold; font-size: 18px;}</style>"+document.getElementById(e).innerHTML+"</svg>"}savePng(e,t,i,s){let n=this.icn3d,r=n.icn3dui;if(r.bNode)return"";let a=$("#"+e).width(),o=$("#"+e).height();i&&(o=a);let l=document.getElementById(e),d=l.getBBox(),c=l.cloneNode(!0);s||n.lineGraphCls.copyStylesInline(c,l);let h=document.createElement("CANVAS");h.width=a,h.height=o;let p=h.getContext("2d");p.clearRect(0,0,d.width,d.height);let u=this.getSvgXml(e,a,o,i),m=window.URL||window.webkitURL||window,f=new Blob([u],{type:"image/svg+xml;charset=utf-8"}),g=new Image;g.src=m.createObjectURL(f),g.onload=function(){if(p.drawImage(g,0,0),m.revokeObjectURL(this.src),r.utilsCls.isIE()){let e=h.msToBlob();e&&(saveAs(e,t),h.remove())}else h.toBlob((function(e){e&&(saveAs(e,t),h.remove())}))}}exportCustomAtoms(e){var t=this.icn3d;t.icn3dui;let i="",s=void 0!==t.defNames2Residues?Object.keys(t.defNames2Residues).sort():[];for(let n=0,r=s.length;n<r;++n){let r=s[n],a=t.defNames2Residues[r];t.defNames2Descr[r];let o=t.defNames2Command[r];o=o.replace(/,/g,", "),i+=this.exportResidues(r,a,e)}s=void 0!==t.defNames2Atoms?Object.keys(t.defNames2Atoms).sort():[];for(let n=0,r=s.length;n<r;++n){let r=s[n],a=t.defNames2Atoms[r];t.defNames2Descr[r];let o=t.defNames2Command[r];o=o.replace(/,/g,", ");let l=t.resid2specCls.atoms2residues(a);i+=this.exportResidues(r,l,e)}return i}exportResidues(e,t,i){var s=this.icn3d,n=s.icn3dui;let r="";if(t.length>0)if(i){let i={};for(let e=0,r=t.length;e<r;++e){let r=t[e],a=s.firstAtomObjCls.getFirstAtomObj(s.residues[r]);if(!a)continue;let o=a.structure+"_"+a.chain,l=n.utilsCls.residueName2Abbr(a.resn)+a.resi;i.hasOwnProperty(o)||(i[o]=[]),i[o].push(l)}r+=e+":\n";for(let e in i){let t=1==i[e].length?"residue":"residues";r+=e+" ("+i[e].length+" "+t+"): ",r+=i[e].join(", "),r+="\n"}r+="\n"}else r+=e+"\tselect ",r+=s.resid2specCls.residueids2spec(t),r+="\n";return r}printPrevSecondary(e,t,i,s){this.icn3d.icn3dui;let n="";if(i)if(e){let e=1;n+=i.resn.padStart(5," ")+i.chain.replace(/_/gi,"").substr(0,2).padStart(2," ")+i.resi.toString().padStart(5," ")+"  "+e+s.toString().padStart(36," ")+"\n"}else if(t){let e=0;n+=i.resn.padStart(5," ")+i.chain.replace(/_/gi,"").substr(0,2).padStart(2," ")+i.resi.toString().padStart(4," ")+"  "+e+"\n"}return n}getAtomPDB(e,t,i,s,n,r,a,o){let l=this.icn3d,d=l.icn3dui,c="",h={},p={};for(let e in l.chemicals){let t=l.atoms[e];if("P"==t.elem){h[e]=1;for(let e=0,i=t.bonds.length;e<i;++e){let i=t.bonds[e];i&&"O"==l.atoms[i].elem&&(p[i]=1)}}}let u,m,f=d.hashUtilsCls.intHash(e,l.calphas),g={};for(let e in l.structures)g[e]="";let b=[];for(let e in f){let t=l.atoms[e];m=t.structure,t.structure,t.chain;let i={};if(i.chain=t.chain,i.resn=t.resn,i.resi=t.resi,parseInt(t.resi)>parseInt(u)+1||t.ssbegin){let e=d.hashUtilsCls.cloneHash(i);e.ss=" ",b.push(e)}"helix"==t.ss?(i.ss="H",b.push(i)):"sheet"==t.ss&&(i.ss="S",b.push(i)),u=t.resi}let C,v,_=0,y=!1,S=!1;for(let e=0,t=b.length;e<t;++e){let t=b[e];t.ss!=C&&(" "!==C&&(g[m]+=this.printPrevSecondary(y,S,v,_)),_=0,y=!1,S=!1,v=void 0," "!==t.ss&&("H"==t.ss?(y=!0,v=t,g[m]+="HELIX".padEnd(15," ")+t.resn.padStart(3," ")+t.chain.replace(/_/gi,"").substr(0,2).padStart(2," ")+t.resi.toString().padStart(5," ")):"S"==t.ss&&(S=!0,v=t,g[m]+="SHEET".padEnd(17," ")+t.resn.padStart(3," ")+t.chain.replace(/_/gi,"").substr(0,2).padStart(2," ")+t.resi.toString().padStart(4," "))))," "!==t.ss&&(++_,v=t),C=t.ss}if(g[m]+=this.printPrevSecondary(y,S,v,_),g[m]+="\n",l.biomtMatrices&&Object.keys(e).length==Object.keys(l.atoms).length){let e=Object.keys(l.structures)[0];for(let t=0,i=l.biomtMatrices.length;t<i;++t){let i=t+1;for(let s=0;s<3;++s){let n=s+1;g[e]+="REMARK 350   BIOMT"+n.toString()+"  "+i.toString().padStart(2," ")+" "+l.biomtMatrices[t].elements[s+0].toFixed(6).toString().padStart(9," ")+" "+l.biomtMatrices[t].elements[s+4].toFixed(6).toString().padStart(9," ")+" "+l.biomtMatrices[t].elements[s+8].toFixed(6).toString().padStart(9," ")+" "+l.biomtMatrices[t].elements[s+12].toFixed(6).toString().padStart(14," ")+"\n"}}}for(let e in l.chainMissingResidueArray){let t=e.indexOf("_"),i=e.substr(t+1,2),s=e.substr(0,t);for(let t=0,n=l.chainMissingResidueArray[e].length;t<n;++t){let n=l.chainMissingResidueArray[e][t].resi,r=d.utilsCls.residueAbbr2Name(l.chainMissingResidueArray[e][t].name);g[s]+="REMARK 465     "+r.padStart(3," ")+i.padStart(2," ")+" "+n.toString().padStart(5," ")+"\n"}}let w="",x=Object.keys(l.structures).length>1,A=1,M="",T="",E=0,R="",k={};for(let r in e){let e=l.atoms[r];if(i&&e.het)continue;if(e.structure!=M){a&&x||(c+=w,w="",A>1&&(c+="\nENDMDL\n"),x&&(c+="MODEL        "+A+"\n"));let t=n?"Mutated chain_residue "+Object.keys(n)+"; ":"";s||a&&x||(c+=this.getPDBHeader(A-1,g,t,e.structure)),++A}e.chain!=T&&e.structure==M&&T&&(c+="TER\n");let u=e.chain+"_"+e.resi;if(n&&n.hasOwnProperty(u)){k.hasOwnProperty(u)||(c+=n[u],k[u]=1);continue}let m="";m+=e.het?"HETATM":"ATOM  ",m+=r.toString().padStart(5," "),m+=" ";let f=e.name.trim();isNaN(f.substr(0,1))||(f=f.substr(1)+f.substr(0,1)),4==f.length?m+=f:(m+=" ",f=f.replace(/\*/g,"'"),"O1P"==f?f="OP1":"O2P"==f?f="OP2":"C5M"==f&&(f="C7 "),m+=f.padEnd(3," ")),m+=" ";let b=e.resn;if(m+=b.length<=3?b.padStart(3," "):b.substr(0,3),a&&A>2&&(l.proteins.hasOwnProperty(e.serial)||l.nucleotides.hasOwnProperty(e.serial)))e.structure==M&&e.chain==T||(R=E<36?"abcdefghijklmnopqrstuvwxyz0123456789"[E]:"?",++E),m+=" "+R;else if(e.chain.length>=2){let t=e.chain.replace(/_/gi,"").substr(0,2);o&&(t=" "+t.substr(0,1)),m+=t}else 1==e.chain.length?m+=" "+e.chain.substr(0,1):0==e.chain.length&&(m+=" A");let C=e.resi;!isNaN(C)&&e.chain.length>3&&!isNaN(e.chain.substr(3))&&(C=C-1+parseInt(e.chain.substr(3)));let v=parseInt(C);m+=v.toString().length<=4?v.toString().padStart(4," "):v.toString().substr(0,4);let _=e.resi.toString().substr(e.resi.toString().length-1,1);if(isNaN(_)?m+=_:m+=" ",m+=" ".padStart(3," "),m+=e.coord.x.toFixed(3).toString().padStart(8," "),m+=e.coord.y.toFixed(3).toString().padStart(8," "),m+=e.coord.z.toFixed(3).toString().padStart(8," "),t&&e.het){let t=1.5,i=0;"C"==e.elem?t=1.908:"N"==e.elem?t=1.824:"O"==e.elem?t=1.6612:"H"==e.elem?t=1.25:"S"==e.elem?t=2:"P"==e.elem?t=2.1:d.parasCls.vdwRadii.hasOwnProperty(e.elem)&&(t=d.parasCls.vdwRadii[e.elem]),void 0!==d.cfg.cid&&void 0!==e.crg?i=e.crg:h.hasOwnProperty(r)?i=1.38:p.hasOwnProperty(r)?i=-.595:d.parasCls.ionCharges.hasOwnProperty(e.elem)&&(i=d.parasCls.ionCharges[e.elem]),m+=i.toFixed(4).toString().padStart(8," "),m+=t.toFixed(4).toString().padStart(7," ")}else{m+="1.00".padStart(6," ");let t=" ";m+=e.b?parseFloat(e.b).toFixed(2).toString().padStart(6," "):t.padStart(6," "),m+=" ".padStart(10," "),m+=e.elem.padStart(2," "),m+=" ".padStart(2," ")}if(e.het&&e.bonds.length>0){w+="CONECT"+r.toString().padStart(5," ");let t={};for(let i=0,s=e.bonds.length;i<s;++i)e.bonds[i]&&!t.hasOwnProperty(e.bonds[i])&&(w+=e.bonds[i].toString().padStart(5," "),t[e.bonds[i]]=1);w+="\n"}c+=m+"\n",M=e.structure,T=e.chain}return a&&x||(c+=w,x&&(c+="\nENDMDL\n")),c}getSecondary(e){let t=this.icn3d,i=t.icn3dui,s='{"data": [\n',n="",r="",a={};for(let s in e){let e=t.atoms[s],o=e.structure+"_"+e.chain,l=e.resi,d=i.utilsCls.residueName2Abbr(e.resn),c=this.secondary2Abbr(e.ss);e.ssbegin?c+=" begin":e.ssend&&(c+=" end"),o==n||a[o]||(a[o]={resi:[],resn:[],secondary:[]}),o==n&&l==r||(a[o].resi.push(l),a[o].resn.push(d),a[o].secondary.push(c)),n=o,r=l}let o=Object.keys(a),l=o.length;for(let e=0;e<l;++e){let t=o[e];s+='{"chain": "'+t+'",\n',s+='"resi": "'+a[t].resi.join(",")+'",\n',s+='"resn": "'+a[t].resn.join(",")+'",\n',s+='"secondary": "'+a[t].secondary.join(",")+'"',s+=e<l-1?"},\n":"}\n"}return s+="]}\n",s}secondary2Abbr(e){return this.icn3d.icn3dui,"helix"==e?"H":"sheet"==e?"E":"c"}getSelectedResiduePDB(){let e=this.icn3d,t="",i=e.icn3dui.hashUtilsCls.intHash(e.dAtoms,e.hAtoms);return t+=this.getAtomPDB(i),t}getPDBHeader(e,t,i,s){let n=this.icn3d;n.icn3dui,void 0===e&&(e=0);let r="",a=s||Object.keys(n.structures)[e],o=i?a+"2":a;if(r+="HEADER    PDB From iCn3D".padEnd(62," ")+o+"\n",0==e){let e=n.molTitle.length>50?n.molTitle.substr(0,47)+"...":n.molTitle;-1!=e.indexOf('"')&&(e=""),i&&(e=i+e),r+="TITLE     "+e+"\n"}return t&&t[a]&&(r+=t[a]),r}showTitle(){var e=this.icn3d,t=e.icn3dui;let i=e.molTitle?e.molTitle:"",s="black"==e.opts.background?t.htmlCls.GREYD:"black";if(void 0===e.inputid)i.length>40&&(i=i.substr(0,40)+"..."),$("#"+e.pre+"title").html(i);else if(void 0!==t.cfg.cid){let t=this.getLinkToStructureSummary();$("#"+e.pre+"title").html("PubChem CID <a id='"+e.pre+"titlelink' href='"+t+"' style='color:"+s+"' target='_blank'>"+e.inputid.toUpperCase()+"</a>: "+i)}else if(void 0!==t.cfg.smiles){let i=decodeURIComponent(t.cfg.smiles);i.length>60&&(i=i.substr(0,60)+"..."),$("#"+e.pre+"title").html("SMILES: "+i)}else if(void 0!==t.cfg.align)i="VAST+ alignment of "+Object.keys(e.structures),$("#"+e.pre+"title").html(i);else if(void 0!==t.cfg.chainalign){i="Dynamic Structure Alignment of Chains: "+t.cfg.chainalign.split(","),$("#"+e.pre+"title").html(i)}else{let n=Object.keys(t.utilsCls.getStructures(e.dAtoms));if(n.length>1){i="Multiple structures: ";for(let e=0,t=n.length;e<t;++e){i+='<a href="'+(isNaN(n[e])&&n[e].length>5?"https://alphafold.ebi.ac.uk/entry/"+n[e]:"https://www.ncbi.nlm.nih.gov/structure/?term="+n[e])+'" style="color:'+s+'" target="_blank">'+n[e]+"</a>",e<t-1&&(i+=", ")}$("#"+e.pre+"title").html(i)}else if(1==n.length){let e=isNaN(n[0])&&n[0].length>5?"https://alphafold.ebi.ac.uk/entry/"+n[0]:"https://www.ncbi.nlm.nih.gov/structure/?term="+n[0];this.setStructureTitle(e,i,s)}}}setStructureTitle(e,t,i){var s=this.icn3d,n=s.icn3dui;t.length>40&&(t=t.substr(0,40)+"...");let r,a,o=s.inputid;if(-1!=o.indexOf("http"))a="Data from",e=o,r=o;else{let e=n.utilsCls.getHlStructures(),i=!1,l=!1;for(let t in e)t.length>5?l=!0:i=!0;let d=Object.keys(e);if(o=d.join(","),r=n.cfg.refseqid||n.cfg.protein?s.inputid:o.toUpperCase(),i&&l?a="AlphaFold/PDB ID":i?a="PDB ID":l&&(a="AlphaFold ID"),d.length>1&&(a+="s"),s.molTitleHash){t="";for(let e=0,i=d.length;e<i;++e)t+=s.molTitleHash[d[e]],e<i-1&&(t+="; ")}}if(n.cfg.refseqid?a="NCBI Protein Acc.":n.cfg.protein&&(a="Protein/Gene Name"),o&&o.substr(0,4)!=s.defaultPdbId)if(n.cfg.blast_rep_id){let e=n.cfg.oriQuery_id?n.cfg.oriQuery_id:n.cfg.query_id,i=n.cfg.oriBlast_rep_id?n.cfg.oriBlast_rep_id:n.cfg.blast_rep_id;e.length>20&&(e=e.substr(0,17)+"..."),r="Query: "+e+"; target: "+i,$("#"+s.pre+"title").html(r+", "+t)}else $("#"+s.pre+"title").html(a+" <a id='"+s.pre+"titlelink' href='"+e+"' style='color:"+i+"' target='_blank'>"+r+"</a>: "+t);else $("#"+s.pre+"title").html(t)}getLinkToStructureSummary(e){var t=this.icn3d,i=t.icn3dui;let s="https://www.ncbi.nlm.nih.gov/structure/?term=";if(s=void 0!==i.cfg.cid?"https://www.ncbi.nlm.nih.gov/pccompound/?term=":void 0!==i.cfg.refseqid?"https://www.ncbi.nlm.nih.gov/protein/":void 0!==i.cfg.afid?"https://alphafold.ebi.ac.uk/search/text/":Object.keys(t.structures).length>1?"https://www.ncbi.nlm.nih.gov/structure/?term=":i.htmlCls.baseUrl+"pdb/",void 0===t.inputid)s="https://www.ncbi.nlm.nih.gov/pccompound/?term="+t.molTitle;else{let n=t.inputid.split("_");1===n.length?(s+=t.inputid,e&&i.htmlCls.clickMenuCls.setLogCmd("link to "+t.inputid+": "+s,!1)):2===n.length&&(i.cfg.afid?s+=n[0]+" "+n[1]:s+=n[0]+" OR "+n[1],e&&i.htmlCls.clickMenuCls.setLogCmd("link to structures "+n[0]+" and "+n[1]+": "+s,!1))}return s}setEntrezLinks(e){var t=this.icn3d,i=t.icn3dui;let s,n=Object.keys(t.structures);if(1===n.length){s="https://www.ncbi.nlm.nih.gov/"+e+"/?term="+n[0],i.htmlCls.clickMenuCls.setLogCmd("Entrez "+e+" about PDB "+n[0]+": "+s,!1);let r=t.structures&&Object.keys(t.structures).length>0?"_blank":"_self";window.open(s,r)}else if(2===n.length){s="https://www.ncbi.nlm.nih.gov/"+e+"/?term="+n[0]+" OR "+n[1],i.htmlCls.clickMenuCls.setLogCmd("Entrez "+e+" about PDB "+n[0]+" OR "+n[1]+": "+s,!1);let r=t.structures&&Object.keys(t.structures).length>0?"_blank":"_self";window.open(s,r)}}}class mp{constructor(e){this.icn3d=e}async shareLink(e,t){let i=this.icn3d,s=i.icn3dui,n=this.shareLinkUrl(),r=n.length>4e3||0!==n.indexOf("http"),a=Object.keys(i.structures).join("_");if(a==i.defaultPdbId&&(i.filename?a=i.filename:i.inputid&&(a=i.inputid)),e){if(t||i.bInputfile||r)return void i.saveFileCls.saveFile(a+"_icn3d_loadable.png","png")}else{if(i.bInputfile&&!i.bInputUrlfile)return void alert("Share Link does NOT work when the data are from custom files. Please save 'iCn3D PNG Image' in the File menu and open it in iCn3D.");if(r)return void alert("The url is more than 4000 characters and may not work. Please save 'iCn3D PNG Image' or 'State File' and open them in iCn3D.");s.htmlCls.clickMenuCls.setLogCmd("share link: "+n,!1)}let o="Problem in getting shortened URL";if(!s.cfg.notebook){let t=await this.getShareLinkPrms(n,e);if(void 0!==t.shortLink&&(o=t.shortLink,e)){let e=o.split("/"),t=e[e.length-1];i.saveFileCls.saveFile(a+"-"+t+".png","png");let s='<div style="float:left; border: solid 1px #0000ff; padding: 5px; margin: 10px; text-align:center;">';s+='<a href="https://www.ncbi.nlm.nih.gov/Structure/icn3d/share2.html?'+t+'" target="_blank">',s+='<img style="height:300px" src ="'+a+"-"+t+'.png"><br>\n',s+="\x3c!--Start of your comments==================--\x3e\n";let n=i.yournote?": "+i.yournote.replace(/\n/g,"<br>").replace(/; /g,", "):"";s+="PDB "+a.toUpperCase()+n+"\n",s+="\x3c!--End of your comments====================--\x3e\n",s+="</a>",s+="</div>\n\n",i.saveFileCls.saveFile(a+"-"+t+".html","html",s)}e&&void 0===t.shortLink&&i.saveFileCls.saveFile(a+"_icn3d_loadable.png","png"),o="https://www.ncbi.nlm.nih.gov/Structure/icn3d/share2.html?"+o,$("#"+i.pre+"short_url").val(o),$("#"+i.pre+"short_url_title").val(o+"&t="+i.yournote)}let l=this.shareLinkUrl(void 0,!0),d="view = icn3dpy.view(q='"+(s.cfg.url?"url="+s.cfg.url:s.cfg.idname+"="+s.cfg.idvalue)+"',command='"+l+"')\nview";(s.cfg.url||s.cfg.idname)&&$("#"+i.pre+"jn_commands").val(d),$("#"+i.pre+"ori_url").val(n),e||s.htmlCls.dialogCls.openDlg("dl_copyurl","Copy a Share Link URL or Jupyter Notebook Commands")}getShareLinkPrms(e,t){let i=this.icn3d,s=i.icn3dui,n="https://icn3d.link/?longurl="+encodeURIComponent(e);return new Promise((function(r,a){$.ajax({url:n,dataType:"json",cache:!0,success:function(e){r(e)},error:function(n,r,a){let o="Problem in getting shortened URL";$("#"+i.pre+"ori_url").val(e),$("#"+i.pre+"short_url").val(o),$("#"+i.pre+"short_url_title").val(o+"&t="+i.yournote),t||s.htmlCls.dialogCls.openDlg("dl_copyurl","Copy a Share Link URL")}})}))}shareLinkUrl(e,t,i){let s=this.icn3d,n=s.icn3dui,r=n.htmlCls.baseUrl+"icn3d/full_"+n.REVISION+".html?",a="";if(n.cfg.bSidebyside&&(r=n.htmlCls.baseUrl+"icn3d/full2.html?"),s.bInputUrlfile){r=window.location.href.split("?")[0]+"?"+s.inputurl+"&"}let o,l={};for(let e in s.cfg){let t=s.cfg[e];"inpara"!==e&&"command"!==e&&"usepdbnum"!==e&&"date"!==e&&"v"!==e&&void 0!==t&&("width"===e&&"100%"===t||"height"===e&&"100%"===t||"resize"===e&&!0===t||"showlogo"===e&&!0===t||"showmenu"===e&&!0===t||"showtitle"===e&&!0===t||"showcommand"===e&&!0===t||"mobilemenu"===e&&!1===t||"showanno"===e&&!1===t||"showseq"===e&&!1===t||"showalignseq"===e&&!1===t||"show2d"===e&&!1===t||"showsets"===e&&!1===t||"rotate"===e&&"right"===t||"command"!==e&&("options"===e?Object.keys(t).length>0&&(l[e]=JSON.stringify(t)):!0===t?l[e]=1:!1===t?l[e]=0:""!==t&&(l[e]=t)))}s.bAfMem?l.afmem="on":(n.cfg.afid||1==Object.keys(s.structures).length&&Object.keys(s.structures)[0].length>5)&&(l.afmem="off");let d=-1;void 0!==n.cfg.inpara&&(d=n.cfg.inpara.indexOf("&command=")),o=-1!==d?n.cfg.inpara.substr(0,d):n.cfg.inpara;let c=!1;if(!s.bInputUrlfile){let e=o&&o.substr(1)?o.substr(1).split("&"):[];for(let t=0,i=e.length;t<i;++t){let i=e[t].split("=");2==i.length&&(l[i[0]]=i[1])}n.cfg.idname&&!l[n.cfg.idname]&&(r+=n.cfg.idname+"="+n.cfg.idvalue+"&");for(let e in l)"v"!==e&&("date"===e&&(c=!0),r+=e+"="+l[e]+"&")}let h,p=n.utilsCls.getDateDigitStr();c||(r+="date="+p+"&"),r+="v="+n.REVISION+"&",r+="command=",h=t&&void 0!==o?1:0,(e||s.bInputUrlfile)&&(h=0);let u={};u.factor=s._zoomFactor,u.mouseChange=s.mouseChange,u.quaternion=s.quaternion;let m="",f="",g="toggle highlight",b=0;if(s.commands.length>h){f=s.commands[h].split("|||")[0].split("&command=")[0].trim(),-1!==f.indexOf(g)&&++b}let C,v=h+1,_="";for(let e=s.commands.length;v<e;++v){let e=s.commands[v].split("|||")[0].split("&command=")[0].trim();0==f.indexOf("select sets")&&0===e.indexOf("select sets")&&-1===f.indexOf(" name ")||-1!==f.indexOf("pickatom")&&-1!==e.indexOf("pickatom")||"show selection"==f&&-1!=s.commands.slice(v).toString().indexOf("show selection")||f==e||(-1!==f.indexOf(g)?++b:_+=v===h+1?f:_?"; "+f:f),-1==f.indexOf("load ")&&(m+=f+"\n"),f=e}return f&&(_&&(_+="; "),b>0&&b%2==0&&f!==g&&(_+=g+"; "),_+=f+"|||"+s.transformCls.getTransformationStr(u),m+=f+"|||"+s.transformCls.getTransformationStr(u)+"\n"),r+=_,a=_,m=m.replace(/!/g,Object.keys(s.structures)[0]+"_"),(s.bEsmfold||s.bInputfile&&!s.bInputUrlfile||s.bInputUrlfile&&s.bAppend||r.length>4e3)&&(r=m),void 0!==s.structures&&1==Object.keys(s.structures).length&&void 0!==s.inputid&&(C=Object.keys(s.structures)[0],r=r.replace(new RegExp(C+"_","g"),"!"),a=a.replace(new RegExp(C+"_","g"),"!")),void 0!==n.cfg.blast_rep_id&&(r=r.replace(new RegExp("blast_rep_id=!","g"),"blast_rep_id="+C+"_")),i?m:t?a:r}getPngText(){let e=this.icn3d;e.icn3dui;let t="";t+="\nStart of type file======\n",t+="pdb\n",t+="End of type file======\n",t+="Start of data file======\n",t+=e.saveFileCls.getAtomPDB(e.atoms),t+="End of data file======\n";return t+="Start of state file======\n",t+=this.shareLinkUrl(!0,void 0,!0)+"\n",t+="End of state file======\n",t=t.replace(/!/g,Object.keys(e.structures)[0]+"_"),t}}class fp{constructor(e){this.icn3d=e}setThichknessFor3Dprint(){let e=this.icn3d,t=e.icn3dui;e.lineRadius=1,e.coilWidth=1.2,e.cylinderRadius=.8,e.crosslinkRadius=.8,e.traceRadius=1,e.dotSphereScale=.6,e.sphereRadius=1.5,e.ribbonthickness=1,e.helixSheetWidth=2,e.nucleicAcidWidth=1.4,t.htmlCls.setHtmlCls.setCookieForThickness()}prepareFor3Dprint(){let e=this.icn3d,t=e.icn3dui;if(e.bShowHighlight=!1,e.hlObjectsCls.removeHlObjects(),e.bDashedLines=!1,e.bSetThickness||void 0!==t.cfg.cid||this.setThichknessFor3Dprint(),void 0!==e.lines.hbond)for(let t=0,i=e.lines.hbond.length;t<i;++t){e.lines.hbond[t].dashed=!1,e.bDashedLines=!0}if(void 0!==e.lines.distance)for(let t=0,i=e.lines.distance.length;t<i;++t){e.lines.distance[t].dashed=!1,e.bDashedLines=!0}e.drawCls.draw(),e.bShowHighlight=!0}resetAfter3Dprint(){let e=this.icn3d,t=e.icn3dui;if(void 0!==e.lines.hbond)for(let t=0,i=e.lines.hbond.length;t<i;++t){e.lines.hbond[t].dashed=!0}if(void 0!==e.lines.distance)for(let t=0,i=e.lines.distance.length;t<i;++t){e.lines.distance[t].dashed=!0}e.lineRadius=.1,e.coilWidth=.3,e.cylinderRadius=.4,e.crosslinkRadius=.4,e.traceRadius=.4,e.dotSphereScale=.3,e.sphereRadius=1.5,e.cylinderHelixRadius=1.6,e.ribbonthickness=.2,e.helixSheetWidth=1.3,e.nucleicAcidWidth=.8,t.htmlCls.setHtmlCls.setCookieForThickness()}removeOneStabilizer(e){let t,i=this.icn3d;i.icn3dui;for(let s=0,n=i.pairArray.length;s<n;s+=2){let n=this.getResidueRepAtom(i.pairArray[s]),r=this.getResidueRepAtom(i.pairArray[s+1]);if(null!=e)for(let i=0,a=e.length;i<a;i+=2){let a=this.getResidueRepAtom(e[i]),o=this.getResidueRepAtom(e[i+1]);if(n.serial==a.serial&&r.serial==o.serial||n.serial==o.serial&&r.serial==a.serial){t=s;break}}if(void 0!==t)break}void 0!==t&&i.pairArray.splice(t,2)}outputSelection(){let e=this.icn3d,t=e.icn3dui,i={};for(let t in e.hAtoms){i[e.atoms[t].structure+"_"+e.atoms[t].chain+"_"+e.atoms[t].resi]=1}let s=Object.keys(i).sort((function(e,t){if(""!==e&&!isNaN(e))return parseInt(e)-parseInt(t);{let i=e.lastIndexOf("_"),s=t.lastIndexOf("_");if(e.substr(0,i)<t.substr(0,i))return-1;if(e.substr(0,i)>t.substr(0,i))return 1;if(e.substr(0,i)==t.substr(0,i)){if(parseInt(e.substr(i+1))<parseInt(t.substr(s+1)))return-1;if(parseInt(e.substr(i+1))>parseInt(t.substr(s+1)))return 1;if(parseInt(e.substr(i+1))==parseInt(t.substr(s+1)))return 0}}})),n="<table><tr><th>Structure</th><th>Chain</th><th>Residue Number</th></tr>";for(let e=0,t=s.length;e<t;++e){let t=s[e].indexOf("_"),i=s[e].lastIndexOf("_");n+="<tr><td>"+s[e].substr(0,t)+"</td><td>"+s[e].substr(t+1,i-t-1)+"</td><td>"+s[e].substr(i+1)+"</td></tr>"}let r=Object.keys(t.utilsCls.getHlStructures()).join(",");e.saveFileCls.saveFile(r+"_residues.txt","html",n)}addStabilizer(){let e=this.icn3d,t=e.icn3dui,i=3.5;if(Object.keys(e.dAtoms).length>0){let s,n={},r=12.25,a=3.2*3.2;for(let t in e.dAtoms){let i=e.atoms[t];!e.nucleotides.hasOwnProperty(i.serial)||"N1"!==i.name&&"N2"!==i.name&&"N3"!==i.name&&"N4"!==i.name&&"N6"!==i.name&&"O2"!==i.name&&"O6"!==i.name||(s=i.structure+"_"+i.chain+"_"+i.resi+"_"+i.name,n[s]=i)}let o=Object.keys(n),l=o.length;void 0===e.pairArray&&(e.pairArray=[]);for(let t=0;t<l;++t)for(let s=t+1;s<l;++s){let l=o[t],d=o[s],c=Math.abs(n[l].coord.x-n[d].coord.x);if(c>i)continue;let h=Math.abs(n[l].coord.y-n[d].coord.y);if(h>i)continue;let p=Math.abs(n[l].coord.z-n[d].coord.z);if(p>i)continue;let u=c*c+h*h+p*p;u>r||u<a||(e.pairArray.push(n[l].serial),e.pairArray.push(n[d].serial))}let d=6,c={};for(let t in e.dAtoms){let i=e.atoms[t];c[i.structure+"_"+i.chain+"_"+i.resi]=1}let h={};for(let t in e.chemicals){let i=e.atoms[t],s=i.structure+"_"+i.chain+"_"+i.resi;c.hasOwnProperty(s)&&(h[s]=1)}for(let t in e.ions){let i=e.atoms[t],s=i.structure+"_"+i.chain+"_"+i.resi;c.hasOwnProperty(s)&&(h[s]=1)}let p=Object.keys(e.chains);for(let t=0,i=p.length;t<i;++t){let i,s=p[t],n=0,r=0;for(let t=0,a=e.chainsSeq[s].length;t<a;++t)i=s+"_"+e.chainsSeq[s][t].resi,"c"!=e.secondaries[i]&&"E"!=e.secondaries[i]&&"H"!=e.secondaries[i]||(n%3!=0&&e.resid2ncbi[e.chainsSeq[s][t].resi]==e.resid2ncbi[r]+1||c.hasOwnProperty(i)&&(h[i]=1),++n,r=e.chainsSeq[s][t].resi);"c"!=e.secondaries[i]&&"E"!=e.secondaries[i]&&"H"!=e.secondaries[i]||c.hasOwnProperty(i)&&(h[i]=1)}let u=Object.keys(h);void 0===e.pairArray&&(e.pairArray=[]);let m=t.hashUtilsCls.exclHash(e.dAtoms,e.water);for(let i=0,s=u.length;i<s;++i){let s=u[i],n=e.secondaries[s],r=e.contactCls.getNeighboringAtoms(m,t.hashUtilsCls.hash2Atoms(e.residues[s],e.atoms),d),a=Object.keys(r).sort(),o=Object.keys(e.residues[s]).sort(),l=!1;if(e.proteins.hasOwnProperty(o[0])){o=[o[0]],l=!0;let t=s.substr(0,s.lastIndexOf("_")),i=e.ParserUtilsCls.getResiNCBI(t,s.substr(s.lastIndexOf("_")+1)),d={};for(let s in r){if(e.chemicals.hasOwnProperty(s)||e.ions.hasOwnProperty(s))continue;let r=e.atoms[s];if(isNaN(r.resi))continue;let a=e.ParserUtilsCls.getResiNCBI(t,r.resi);("c"==n&&(a>i+1||a<i-1)||"E"==n&&(a>i+2||a<i-2)||"H"==n&&(a>i+4||a<i-4))&&(d[s]=1)}a=Object.keys(d).sort()}if(a.length>0&&o.length>0)if(l){let t=parseInt((a.length+.5)/2);e.pairArray.push(o[0]),e.pairArray.push(a[t])}else{let t=10,i=parseInt(a.length/(t+1));for(let s=0,n=o.length;s<n;++s)if(s%t==0){let n=parseInt(s/t)*i,r=n<a.length?n:a.length-1;e.pairArray.push(o[s]),e.pairArray.push(a[r]),o.length<t+1&&(e.pairArray.push(o[s]),e.pairArray.push(a[a.length-1]))}}}}}hideStabilizer(){let e=this.icn3d;e.icn3dui,e.pairArray=[],e.lines.stabilizer=[],e.stabilizerpnts=[];for(let t in e.water)e.atoms[t].style=e.opts.water}getResidueRepAtom(e){let t=this.icn3d;t.icn3dui;let i,s=t.atoms[e],n=s.structure+"_"+s.chain+"_"+s.resi;if(t.proteins.hasOwnProperty(e)||t.nucleotides.hasOwnProperty(e))for(let e in t.residues[n]){let s=t.atoms[e];if("CA"===s.name||"N3"===s.name){i=t.atoms[e];break}}else i=s;return void 0===i&&(i=s),i}}class gp{constructor(e){this.icn3d=e}exportStlFile(e){let t=this.icn3d,i=t.icn3dui;void 0!==t.biomtMatrices&&t.biomtMatrices.length>1&&t.bAssembly&&(t.threshbox=180/Math.pow(t.biomtMatrices.length,.33),t.applyMapCls.removeSurfaces(),t.applyMapCls.applySurfaceOptions(),t.applyMapCls.removeMaps(),t.applyMapCls.applyMapOptions(),t.applyMapCls.removeEmmaps(),t.applyMapCls.applyEmmapOptions());let s=this.saveStlFile(),n=Object.keys(i.utilsCls.getHlStructures()).join(",");if(t.saveFileCls.saveFile(n+e+".stl","binary",s),void 0!==t.biomtMatrices&&t.biomtMatrices.length>1&&t.bAssembly&&Object.keys(t.dAtoms).length*t.biomtMatrices.length>t.maxAtoms3DMultiFile){alert(t.biomtMatrices.length+" files will be generated for this assembly. Please merge these files using some software and 3D print the merged file.");let i=new gi;i.identity();let r=1;for(let a=0;a<t.biomtMatrices.length;a++){let o=t.biomtMatrices[a];if(void 0===o)continue;if(o.equals(i))continue;let l=100*(a+1);setTimeout(function(i,r){s=this.saveStlFile(i),t.saveFileCls.saveFile(n+e+r+".stl","binary",s),s=""}.bind(this,o,r),l),++r}t.threshbox=180}}exportVrmlFile(e){let t=this.icn3d,i=t.icn3dui;void 0!==t.biomtMatrices&&t.biomtMatrices.length>1&&t.bAssembly&&(t.threshbox=180/Math.pow(t.biomtMatrices.length,.33),t.applyMapCls.removeSurfaces(),t.applyMapCls.applySurfaceOptions(),t.applyMapCls.removeMaps(),t.applyMapCls.applyMapOptions(),t.applyMapCls.removeEmmaps(),t.applyMapCls.applyEmmapOptions());let s=this.saveVrmlFile(),n=Object.keys(i.utilsCls.getHlStructures()).join(",");if(t.saveFileCls.saveFile(n+e+".wrl","text",s),void 0!==t.biomtMatrices&&t.biomtMatrices.length>1&&t.bAssembly&&Object.keys(t.dAtoms).length*t.biomtMatrices.length>t.maxAtoms3DMultiFile){alert(t.biomtMatrices.length+" files will be generated for this assembly. Please merge these files using some software and 3D print the merged file.");let i=new gi;i.identity();let n=1;for(let r=0;r<t.biomtMatrices.length;r++){let a=t.biomtMatrices[r];if(void 0===a)continue;if(a.equals(i))continue;let o=100*(r+1);setTimeout(function(i,n){s=this.saveVrmlFile(i),t.saveFileCls.saveFile(t.inputid+e+n+".wrl","text",s),s=""}.bind(this,a,n),o),++n}t.threshbox=180}}getFaceCnt(e){this.icn3d.icn3dui;let t=0;for(let i=0,s=e.children.length;i<s;++i){let s=e.children[i];"Sprite"!==s.type&&(t+=s.geometry.getIndex().array.length/3)}return t}saveStlFile(e){let t=this.icn3d,i=t.icn3dui;if(Object.keys(t.dAtoms).length>7e4)return alert("Please display a subset of the structure to export 3D files. Then merge the files for 3D printing..."),[""];t.threeDPrintCls.prepareFor3Dprint();let s=0;s+=this.getFaceCnt(t.mdl),s+=this.getFaceCnt(t.mdl_ghost);let n=[],r=new Uint8Array(84),a="STL file for the structure(s) ",o=Object.keys(t.structures);for(let e=0,t=o.length;e<t;++e)a+=o[e],e<t-1&&(a+=", ");a.length>80&&(a=a.substr(0,80));for(let e=0;e<80;++e)e<a.length?r[e]=i.convertTypeCls.passInt8([a.charCodeAt(e)])[0]:r[e]=i.convertTypeCls.passInt8([" ".charCodeAt(0)])[0];if(r=void 0!==t.biomtMatrices&&t.biomtMatrices.length>1&&t.bAssembly&&Object.keys(t.dAtoms).length*t.biomtMatrices.length<=t.maxAtoms3DMultiFile?this.updateArray(r,i.convertTypeCls.passInt32([s*t.biomtMatrices.length]),80):this.updateArray(r,i.convertTypeCls.passInt32([s]),80),n.push(new Blob([r],{type:"application/octet-stream"})),n=this.processStlMeshGroup(t.mdl,n,e),n=this.processStlMeshGroup(t.mdl_ghost,n,e),void 0!==t.biomtMatrices&&t.biomtMatrices.length>1&&t.bAssembly&&Object.keys(t.dAtoms).length*t.biomtMatrices.length<=t.maxAtoms3DMultiFile){let e=new gi;e.identity();for(let i=0;i<t.biomtMatrices.length;i++){let s=t.biomtMatrices[i];void 0!==s&&(s.equals(e)||(n=this.processStlMeshGroup(t.mdl,n,s),n=this.processStlMeshGroup(t.mdl_ghost,n,s)))}}return t.threeDPrintCls.resetAfter3Dprint(),n}updateArray(e,t,i){this.icn3d.icn3dui;for(let s=0,n=t.length;s<n;++s)e[i+s]=t[s];return e}processStlMeshGroup(e,t,i){let s=this.icn3d.icn3dui;for(let n=0,r=e.children.length;n<r;++n){let r=e.children[n];if("Sprite"===r.type)continue;let a=r.geometry,o=a.getAttribute("position").array,l=a.getIndex().array,d=r.position,c=r.scale,h=r.matrix,p=new Uint8Array(l.length/3*50),u=0;for(let e=0,t=l.length;e<t;e+=3){let t,n,r,m=l[e],f=l[e+1],g=l[e+2],b=new mt(o[3*m],o[3*m+1],o[3*m+2]),C=new mt(o[3*f],o[3*f+1],o[3*f+2]),v=new mt(o[3*g],o[3*g+1],o[3*g+2]);"SphereGeometry"==a.type||"BoxGeometry"==a.type?(t=b.clone().multiply(c).add(d),n=C.clone().multiply(c).add(d),r=v.clone().multiply(c).add(d)):"CylinderGeometry"==a.type?(t=b.clone().applyMatrix4(h),n=C.clone().applyMatrix4(h),r=v.clone().applyMatrix4(h)):(t=b.clone(),n=C.clone(),r=v.clone()),p=this.updateArray(p,s.convertTypeCls.passFloat32([0,0,0]),u),u+=12,void 0!==i&&(t.applyMatrix4(i),n.applyMatrix4(i),r.applyMatrix4(i)),p=this.updateArray(p,s.convertTypeCls.passFloat32([t.x,t.y,t.z]),u),u+=12,p=this.updateArray(p,s.convertTypeCls.passFloat32([n.x,n.y,n.z]),u),u+=12,p=this.updateArray(p,s.convertTypeCls.passFloat32([r.x,r.y,r.z]),u),u+=12,t=n=r=void 0,p=this.updateArray(p,s.convertTypeCls.passInt16([0]),u),u+=2}t.push(new Blob([p],{type:"application/octet-stream"})),p=null}return t}saveVrmlFile(e){let t=this.icn3d;if(t.icn3dui,Object.keys(t.dAtoms).length>5e4)return alert("Please display a subset of the structure to export 3D files. Then merge the files for 3D printing..."),[""];t.threeDPrintCls.prepareFor3Dprint();let i=[];i.push("#VRML V2.0 utf8\n");let s=0,n=this.processVrmlMeshGroup(t.mdl,i,s,e);if(i=n.vrmlStrArray,s=n.vertexCnt,n=this.processVrmlMeshGroup(t.mdl_ghost,i,s,e),i=n.vrmlStrArray,s=n.vertexCnt,void 0!==t.biomtMatrices&&t.biomtMatrices.length>1&&t.bAssembly&&Object.keys(t.dAtoms).length*t.biomtMatrices.length<=t.maxAtoms3DMultiFile){let e=new gi;e.identity();for(let r=0;r<t.biomtMatrices.length;r++){let a=t.biomtMatrices[r];void 0!==a&&(a.equals(e)||(n=this.processVrmlMeshGroup(t.mdl,i,s,a),i=n.vrmlStrArray,s=n.vertexCnt,n=this.processVrmlMeshGroup(t.mdl_ghost,i,s,a),i=n.vrmlStrArray,s=n.vertexCnt))}}return i}processVrmlMeshGroup(e,t,i,s){let n=this.icn3d.icn3dui;for(let i=0,r=e.children.length;i<r;++i){let r=e.children[i];if("Sprite"===r.type)continue;let a=r.geometry;r.material.type,a.type;let o=a.getAttribute("position").array,l=a.getAttribute("color")?a.getAttribute("color").array:[],d=a.getIndex().array,c=r.position,h=r.scale,p=r.matrix,u=n.parasCls.thr(1,1,1);"SphereGeometry"!=a.type&&"BoxGeometry"!=a.type&&"CylinderGeometry"!=a.type||void 0!==r.material&&(u=r.material.color),t.push("Shape {\n"),t.push("geometry IndexedFaceSet {\n"),t.push("coord Coordinate { point [ ");let m=[];for(let e=0,i=o.length;e<i;e+=3){let r,l=new mt(o[e],o[e+1],o[e+2]);r="SphereGeometry"==a.type||"BoxGeometry"==a.type?l.clone().multiply(h).add(c):"CylinderGeometry"==a.type?l.clone().applyMatrix4(p):l.clone(),void 0!==s&&r.applyMatrix4(s),t.push(r.x.toPrecision(5)+" "+r.y.toPrecision(5)+" "+r.z.toPrecision(5)),r=void 0,e<i-3&&t.push(", "),m.push(n.parasCls.thr(1,1,1))}t.push(" ] }\n");let f="",g="";for(let e=0,t=d.length;e<t;e+=3){let i,s=d[e],n=d[e+1],r=d[e+2];i="SphereGeometry"==a.type||"BoxGeometry"==a.type||"CylinderGeometry"==a.type?u:new ls(l[3*s],l[3*s+1],l[3*s+2]),f+=s+" "+n+" "+r,e<t-3&&(f+=", -1, "),m[s]=i,m[n]=i,m[r]=i}for(let e=0,t=m.length;e<t;++e){let i=m[e];g+=i.r.toPrecision(3)+" "+i.g.toPrecision(3)+" "+i.b.toPrecision(3),e<t-1&&(g+=", ")}t.push("coordIndex [ "+f+" ]\n"),t.push("color Color { color [ "+g+" ] } colorPerVertex TRUE\n"),t.push("  }\n"),t.push("}\n")}return{vrmlStrArray:t,vertexCnt:i}}}class bp{constructor(e){this.icn3d=e}rayCaster(e,t){let i=this.icn3d;i.icn3dui,i.opts&&"none"!=i.opts.effect||this.rayCasterBase(e,t)}rayCasterBase(e,t){let i=this.icn3d;i.icn3dui;let s=e.pageX,n=e.pageY;e.originalEvent.targetTouches&&e.originalEvent.targetTouches[0]&&(s=e.originalEvent.targetTouches[0].pageX,n=e.originalEvent.targetTouches[0].pageY);let r=i.oriContainer.offset().left,a=i.oriContainer.offset().top,o=i.oriContainer.width(),l=i.oriContainer.height(),d=s-r,c=n-a;i.mouse.x=d/o*2-1,i.mouse.y=-c/l*2+1;let h=new mt;h.x=i.mouse.x,h.y=i.mouse.y,i.cam_z>0?h.z=-1:h.z=1,i.cam===i.perspectiveCamera?(i.cam_z>0?h.z=-1:h.z=1,h.unproject(i.cam),i.raycaster.set(i.cam.position,h.sub(i.cam.position).normalize())):i.cam===i.orthographicCamera&&(i.cam_z>0?h.z=1:h.z=-1,h.unproject(i.cam),i.raycaster.set(h,new mt(0,0,-1).transformDirection(i.cam.matrixWorld)));let p=this.isIntersect(i.objects,i.mdl,t,d,c);p||(p=this.isIntersect(i.objects_ghost,i.mdl_ghost,t,d,c))}isIntersect(e,t,i,s,n){let r=this.icn3d;r.icn3dui;let a=r.raycaster.intersectObjects(e),o=!1,l=t.position;if(a.length>0){a[0].point.sub(l);let e=r.rayThreshold,t=this.getAtomsFromPosition(a[0].point,e);for(;!t&&e<10;)e+=.5,t=this.getAtomsFromPosition(a[0].point,e);t?(o=!0,r.pickpair?i&&(r.pAtomNum%2==0?r.pAtom=t:r.pAtom2=t,++r.pAtomNum):r.pAtom=t,i?r.pickingCls.showPicking(t):r.pickingCls.showPicking(t,s,n)):console.log("No atoms were found in 10 andstrom range")}return o}getAtomsFromPosition(e,t,i){let s,n=this.icn3d,r=n.icn3dui;null==t&&(t=1);let a=i||n.dAtoms;for(s in a){let i=n.atoms[s];if(n.ions.hasOwnProperty(s)&&"sphere"===n.opts.ions){let s=r.parasCls.vdwRadii[i.elem.toUpperCase()];if(Math.abs(i.coord.x-e.x)-s>t)continue;if(Math.abs(i.coord.y-e.y)-s>t)continue;if(Math.abs(i.coord.z-e.z)-s>t)continue}else{if(i.coord.x<e.x-t||i.coord.x>e.x+t)continue;if(i.coord.y<e.y-t||i.coord.y>e.y+t)continue;if(i.coord.z<e.z-t||i.coord.z>e.z+t)continue}return i}return null}}class Cp{constructor(e){this.icn3d=e}setControl(){let e=this.icn3d,t=e.icn3dui;if(t.bNode)return;let i=this;e.WIDTH=e.container.width(),e.HEIGHT=e.container.height(),e.applyCenterCls.setWidthHeight(e.WIDTH,e.HEIGHT),e._zoomFactor=1,e.mouseChange=new pt(0,0),e.quaternion=new ut(0,0,0,1),e.container.bind("contextmenu",(function(e){e.preventDefault()})),e.typetext=!1,$(document).bind("keyup",(function(t){16===t.keyCode&&(e.bShift=!1),17!==t.keyCode&&224!==t.keyCode&&91!==t.keyCode||(e.bCtrl=!1)})),$("input[type=text], textarea").focus((function(){e.typetext=!0})),$("input[type=text], textarea").blur((function(){e.typetext=!1})),$(document).bind("keydown",(async function(i){if((i.shiftKey||16===i.keyCode)&&(e.bShift=!0),(i.ctrlKey||17===i.keyCode||224===i.keyCode||91===i.keyCode)&&(e.bCtrl=!0),!e.bControlGl&&!e.controls||e.bControlGl&&!window.controls)return;e.bStopRotate=!0;let s=e.bShift?90:5;if(!e.typetext)if(90===i.keyCode){let i={};e.bControlGl&&!t.bNode?window.cam===e.perspectiveCamera?i._zoomFactor=.9:window.cam===e.orthographicCamera&&(e._zoomFactor<.1?e._zoomFactor=.1:e._zoomFactor>1&&(e._zoomFactor=1),i._zoomFactor=.8*e._zoomFactor,i._zoomFactor<.1&&(i._zoomFactor=.1)):e.cam===e.perspectiveCamera?i._zoomFactor=.9:e.cam===e.orthographicCamera&&(e._zoomFactor<.1?e._zoomFactor=.1:e._zoomFactor>1&&(e._zoomFactor=1),i._zoomFactor=.8*e._zoomFactor,i._zoomFactor<.1&&(i._zoomFactor=.1)),i.update=!0,e.bControlGl&&!t.bNode?window.controls.update(i):e.controls.update(i),e.bRender&&e.drawCls.render()}else if(88===i.keyCode){let i={};e.bControlGl&&!t.bNode?window.cam===e.perspectiveCamera?i._zoomFactor=1.03:window.cam===e.orthographicCamera&&(e._zoomFactor>10?e._zoomFactor=10:e._zoomFactor<1&&(e._zoomFactor=1),i._zoomFactor=1.01*e._zoomFactor,i._zoomFactor>10&&(i._zoomFactor=10)):e.cam===e.perspectiveCamera?i._zoomFactor=1.03:e.cam===e.orthographicCamera&&(e._zoomFactor>10?e._zoomFactor=10:e._zoomFactor<1&&(e._zoomFactor=1),i._zoomFactor=1.01*e._zoomFactor,i._zoomFactor>10&&(i._zoomFactor=10)),i.update=!0,e.bControlGl&&!t.bNode?window.controls.update(i):e.controls.update(i),e.bRender&&e.drawCls.render()}else if(76===i.keyCode){let t=new mt(0,1,0),i=-s/180*Math.PI;e.transformCls.setRotation(t,i)}else if(74===i.keyCode){let t=new mt(0,1,0),i=s/180*Math.PI;e.transformCls.setRotation(t,i)}else if(73===i.keyCode){let t=new mt(1,0,0),i=-s/180*Math.PI;e.transformCls.setRotation(t,i)}else if(77===i.keyCode){let t=new mt(1,0,0),i=s/180*Math.PI;e.transformCls.setRotation(t,i)}else 65===i.keyCode&&Object.keys(e.structures).length>1&&await e.alternateCls.alternateWrapper()})),e.container.bind("mouseup",(function(t){e.isDragging=!1})),e.container.bind("touchend",(function(t){e.isDragging=!1})),e.container.bind("mousedown",(function(i){if(e.isDragging=!0,e.scene){if(e.bStopRotate=!0,e.pk&&(i.altKey||i.ctrlKey||i.shiftKey||18===i.keyCode||16===i.keyCode||17===i.keyCode||224===i.keyCode||91===i.keyCode)){e.highlightlevel=e.pk;let t=!0;e.rayCls.rayCaster(i,t)}e.bControlGl&&!t.bNode?(window.controls.handleResize(),window.controls.update()):(e.controls.handleResize(),e.controls.update()),e.bRender&&e.drawCls.render()}})),e.container.bind("touchstart",(function(i){if(i.preventDefault(),e.isDragging=!0,!e.scene)return;e.bStopRotate=!0,$("#"+e.pre+"popup").hide();e.rayCls.rayCaster(i,!0),e.bControlGl&&!t.bNode?(window.controls.handleResize(),window.controls.update()):(e.controls.handleResize(),e.controls.update()),e.bRender&&e.drawCls.render()})),e.container.bind("mousemove touchmove",(function(e){i.mouseMove(e)})),e.container.bind("mousewheel",(function(i){i.preventDefault(),e.scene&&(e.bStopRotate=!0,e.bControlGl&&!t.bNode?(window.controls.handleResize(),window.controls.update()):(e.controls.handleResize(),e.controls.update()),e.bRender&&e.drawCls.render())})),e.container.bind("DOMMouseScroll",(function(i){i.preventDefault(),e.scene&&(e.bStopRotate=!0,e.bControlGl&&!t.bNode?(window.controls.handleResize(),window.controls.update()):(e.controls.handleResize(),e.controls.update()),e.bRender&&e.drawCls.render())}))}mouseMove(e){let t=this.icn3d,i=t.icn3dui;if(i.bNode)return;if(e.preventDefault(),!t.scene)return;$("#"+t.pre+"popup").hide();if(t.rayCls.rayCaster(e,!1),t.bControlGl&&!i.bNode){window.controls.handleResize(),window.controls.update();for(let e in window.icn3duiHash){let t=window.icn3duiHash[e].icn3d;t.bRender&&t.drawCls.render()}}else t.controls.handleResize(),t.controls.update(),t.bRender&&t.drawCls.render()}}class vp{constructor(e){this.icn3d=e}showPicking(e,t,i){let s=this.icn3d,n=s.icn3dui;if(void 0!==n.cfg.cid&&0!=s.pk&&(s.pk=1),s.highlightlevel=s.pk,this.showPickingBase(e,t,i),0!=s.pk)if(void 0!==t&&void 0!==i){null!=n.cfg.showmenu&&1==n.cfg.showmenu&&(i+=n.htmlCls.MENU_HEIGHT);let r,a=1==s.pk?e.resn+e.resi+"@"+e.name:e.resn+e.resi,o=e.structure+"_"+e.chain;if(void 0!==s.structures&&Object.keys(s.structures).length>1?(a=o+" "+a,r=s.chainid2refpdbname&&s.chainid2refpdbname[o]?240:160,$("#"+s.pre+"popup").css("width",r+"px")):(r=s.chainid2refpdbname&&s.chainid2refpdbname[o]?160:80,$("#"+s.pre+"popup").css("width",r+"px")),s.chainid2refpdbname&&s.chainid2refpdbname[o]){let t=s.resid2refnum[o+"_"+e.resi];t&&(a+=", Ig: "+t)}$("#"+s.pre+"popup").html(a),$("#"+s.pre+"popup").css("top",i).css("left",t+20).show()}else{s.hlUpdateCls.updateHlAll();let t={};t.factor=s._zoomFactor,t.mouseChange=s.mouseChange,t.quaternion={},t.quaternion._x=parseFloat(s.quaternion._x).toPrecision(5),t.quaternion._y=parseFloat(s.quaternion._y).toPrecision(5),t.quaternion._z=parseFloat(s.quaternion._z).toPrecision(5),t.quaternion._w=parseFloat(s.quaternion._w).toPrecision(5),n.htmlCls.clickMenuCls.setLogCmd("pickatom "+e.serial,!0),s.selectionCls.saveSelInCommand(),s.bSphereCalc=!1,s.bHbondCalc=!1}}showPickingBase(e,t,i){this.icn3d.icn3dui,void 0===t&&void 0===i&&this.showPickingHilight(e)}getPickedAtomList(e,t){let i=this.icn3d;i.icn3dui;let s={};if(1===e)s[t.serial]=1;else if(2===e){let e=t.structure+"_"+t.chain+"_"+t.resi;s=i.residues[e]}else if(3===e)s=this.selectStrandHelixFromAtom(t);else if(4===e)s=this.select3ddomainFromAtom(t);else if(5===e){let e=t.structure+"_"+t.chain;s=i.chains[e]}return s}showPickingHilight(e){let t=this.icn3d,i=t.icn3dui;t.bShift||t.bCtrl||t.hlObjectsCls.removeHlObjects(),t.pickedAtomList=this.getPickedAtomList(t.pk,e),0===t.pk?t.bShowHighlight=!1:t.bShowHighlight=!0;let s=Object.keys(t.hAtoms).length==Object.keys(t.atoms).length?{}:i.hashUtilsCls.intHash(t.hAtoms,t.pickedAtomList),n=Object.keys(s).length;if(t.bShift||t.bCtrl)if(t.bShift){if(void 0===t.prevPickedAtomList)t.hAtoms=i.hashUtilsCls.unionHash(t.hAtoms,t.pickedAtomList);else{let e=t.firstAtomObjCls.getFirstAtomObj(t.prevPickedAtomList),s=t.firstAtomObjCls.getFirstAtomObj(t.pickedAtomList);if(e.structure+"_"+e.chain!=s.structure+"_"+s.chain)t.hAtoms=i.hashUtilsCls.unionHash(t.hAtoms,t.pickedAtomList);else{let e;e=i.hashUtilsCls.unionHash(e,t.prevPickedAtomList),e=i.hashUtilsCls.unionHash(e,t.pickedAtomList);let s=t.firstAtomObjCls.getFirstAtomObj(e),n=t.firstAtomObjCls.getLastAtomObj(e);for(let e=s.serial;e<=n.serial;++e)t.hAtoms[e]=1}}t.prevPickedAtomList=i.hashUtilsCls.cloneHash(t.pickedAtomList)}else t.bCtrl&&(t.hAtoms=n>0?i.hashUtilsCls.exclHash(t.hAtoms,t.pickedAtomList):i.hashUtilsCls.unionHash(t.hAtoms,t.pickedAtomList));else t.hAtoms=i.hashUtilsCls.cloneHash(t.pickedAtomList);t.hlObjectsCls.removeHlObjects(),t.hlObjectsCls.addHlObjects()}select3ddomainFromAtom(e){let t,i=this.icn3d,s=i.icn3dui,n=e.structure+"_"+e.chain,r=n+"_"+e.resi;for(let e in i.tddomains){let s=e.indexOf("_3d_domain");if(e.substr(0,s)==n&&-1!==Object.keys(i.tddomains[e]).indexOf(r)){t=e;break}}let a={};for(let e in i.tddomains[t])a=s.hashUtilsCls.unionHash(a,i.residues[e]);return a}selectStrandHelixFromAtom(e){let t=this.icn3d,i=t.icn3dui,s=e,n=e,r={},a=s.resi;if(!s.ssbegin&&!isNaN(s.resi)){for(let e=s.resi-1;e>0;--e){let i=s.structure+"_"+s.chain+"_"+e;if(!t.residues.hasOwnProperty(i))break;let n=t.firstAtomObjCls.getFirstCalphaAtomObj(t.residues[i]);if(a=n.resi,"coil"!==s.ss&&n.ss===s.ss&&n.ssbegin||"coil"===s.ss&&n.ss!==s.ss){"coil"===s.ss&&n.ss!==s.ss&&(a=parseInt(n.resi)+1);break}}for(let e=a;e<=s.resi;++e){let n=s.structure+"_"+s.chain+"_"+e;r=i.hashUtilsCls.unionHash(r,i.hashUtilsCls.hash2Atoms(t.residues[n],t.atoms))}}let o=n.resi,l=t.firstAtomObjCls.getLastAtomObj(t.chains[n.structure+"_"+n.chain]).resi;for(let e=parseInt(n.resi)+1;e<=parseInt(l);++e){let i=n.structure+"_"+n.chain+"_"+e;if(!t.residues.hasOwnProperty(i))break;let s=t.firstAtomObjCls.getFirstCalphaAtomObj(t.residues[i]);if(o=s.resi,"coil"!==n.ss&&s.ss===n.ss&&s.ssend||"coil"===n.ss&&s.ss!==n.ss){"coil"!==n.ss||s.ss===n.ss||isNaN(s.resi)||(o=s.resi-1);break}}for(let e=parseInt(n.resi)+1;e<=parseInt(o);++e){let s=n.structure+"_"+n.chain+"_"+e;r=i.hashUtilsCls.unionHash(r,i.hashUtilsCls.hash2Atoms(t.residues[s],t.atoms))}return r}}class _p{constructor(e){this.icn3d=e,this.xrSessionIsGranted=!1}createButton(e,t){let i=this.icn3d,s=i.icn3dui;t&&console.error('THREE.VRButton: The "options" parameter has been removed. Please set the reference space type via renderer.xr.setReferenceSpaceType() instead.');const n=document.createElement("button");function r(){n.style.display="",n.style.cursor="auto",n.style.left="calc(33% - 75px)",n.style.width="150px",n.onmouseenter=null,n.onmouseleave=null,n.onclick=null}let a=this;if("xr"in navigator)return n.id=s.pre+"VRButton",n.style.display="none",(o=n).style.position="absolute",o.style.bottom="20px",o.style.padding="12px 6px",o.style.border="1px solid #fff",o.style.borderRadius="4px",o.style.background="#000",o.style.color="#f8b84e",o.style.font="bold 13px sans-serif",o.style.textAlign="center",o.style.opacity="0.8",o.style.outline="none",o.style.zIndex="999",navigator.xr.isSessionSupported("immersive-vr").then((function(t){t?function(){let t=null;async function s(i){i.addEventListener("end",r),await e.xr.setSession(i),n.textContent="EXIT VR",t=i}function r(){i.transformCls.resetOrientation(),i.bVr=!1,i.drawCls.draw(),t.removeEventListener("end",r),n.textContent="ENTER VR",t=null}n.style.display="",n.style.cursor="pointer",n.style.left="calc(33% - 50px)",n.style.width="100px",n.textContent="ENTER VR",n.onmouseenter=function(){n.style.opacity="1.0"},n.onmouseleave=function(){n.style.opacity="0.8"},n.onclick=function(){if(i.bImpo=!1,i.bVr=!0,i.drawCls.draw(i.bVr),null===t){const e={optionalFeatures:["local-floor","bounded-floor","hand-tracking","layers"]};navigator.xr.requestSession("immersive-vr",e).then(s)}else t.end()}}():(r(),n.style.display="none"),t&&a.xrSessionIsGranted&&n.click()})).catch((function(e){r(),console.warn("Exception when trying to call xr.isSessionSupported",e),n.style.display="none"})),n;return document.createElement("span");var o}registerSessionGrantedListener(){"xr"in navigator&&navigator.xr.addEventListener("sessiongranted",(()=>{this.xrSessionIsGranted=!0}))}}class yp{constructor(e){this.icn3d=e,this.xrSessionIsGranted=!1}createButton(e,t={}){let i=this.icn3d,s=i.icn3dui;const n=document.createElement("button");function r(){n.style.display="",n.style.cursor="auto",n.style.left="calc(66% - 50px)",n.style.width="150px",n.onmouseenter=null,n.onmouseleave=null,n.onclick=null}function a(e){e.style.position="absolute",e.style.bottom="20px",e.style.padding="12px 6px",e.style.border="1px solid #fff",e.style.borderRadius="4px",e.style.background="#000",e.style.color="#f8b84e",e.style.font="bold 13px sans-serif",e.style.textAlign="center",e.style.opacity="0.8",e.style.outline="none",e.style.zIndex="999"}if(s.utilsCls.isAndroid()&&s.utilsCls.isChrome()){if("xr"in navigator)return n.id=s.pre+"ARButton",n.style.display="none",a(n),navigator.xr.isSessionSupported("immersive-ar").then((function(s){s?function(){if(void 0===t.domOverlay){const e=document.createElement("div");e.style.display="none",document.body.appendChild(e);const i=document.createElementNS("http://www.w3.org/2000/svg","svg");i.setAttribute("width",38),i.setAttribute("height",38),i.style.position="absolute",i.style.right="20px",i.style.top="20px",i.addEventListener("click",(function(){s.end()})),e.appendChild(i);const n=document.createElementNS("http://www.w3.org/2000/svg","path");n.setAttribute("d","M 12,12 L 28,28 M 28,12 12,28"),n.setAttribute("stroke","#fff"),n.setAttribute("stroke-width",2),i.appendChild(n),void 0===t.optionalFeatures&&(t.optionalFeatures=[]),t.optionalFeatures.push("dom-overlay"),t.domOverlay={root:e}}let s=null;async function r(i){i.addEventListener("end",a),e.xr.setReferenceSpaceType("local"),await e.xr.setSession(i),n.textContent="STOP AR",t.domOverlay.root.style.display="",s=i}function a(){i.transformCls.resetOrientation(),i.bAr=!1,i.drawCls.draw(),s.removeEventListener("end",a),n.textContent="START AR",t.domOverlay.root.style.display="none",s=null}n.style.display="",n.style.cursor="pointer",n.style.left="calc(66% - 50px)",n.style.width="100px",n.textContent="START AR",n.onmouseenter=function(){n.style.opacity="1.0"},n.onmouseleave=function(){n.style.opacity="0.8"},n.onclick=function(){i.bImpo=!1,i.opts.background="transparent",i.bAr=!0,i.drawCls.draw(i.bAr),null===s?navigator.xr.requestSession("immersive-ar",t).then(r):s.end()}}():(r(),n.style.display="none")})).catch((function(e){r(),console.warn("Exception when trying to call xr.isSessionSupported",e),n.style.display="none"})),n;return document.createElement("span")}return n.id=s.pre+"ARButton",n.style.display="none",a(n),r(),n.style.display="none",n}}function Sp(e){var t=this;t.separation=3,t._position=new mt,t._quaternion=new ut,t._scale=new mt,t._cameraL=new Zs,t._cameraR=new Zs,e.autoClear=!1,t.setSize=function(i,s){t._width=i/2,t._height=s,e.setSize(i,s)},t.render=function(i,s){i.updateMatrixWorld(),void 0===s.parent&&s.updateMatrixWorld(),s.matrixWorld.decompose(t._position,t._quaternion,t._scale),t._cameraL.copy(s),t._cameraL.aspect=.5*s.aspect,t._cameraL.updateProjectionMatrix(),t._cameraL.translateX(-t.separation),t._cameraR.copy(s),t._cameraR.aspect=.5*s.aspect,t._cameraR.updateProjectionMatrix(),t._cameraR.translateX(t.separation),e.setViewport(0,0,2*t._width,t._height),e.clear(),e.setViewport(0,0,t._width,t._height),e.render(i,t._cameraL),e.setViewport(t._width,0,t._width,t._height),e.render(i,t._cameraR)}}class wp{constructor(e){let t,i,s,n=e;if(this.icn3dui=e,this.id=this.icn3dui.pre+"canvas",this.pre=this.icn3dui.pre,this.container=$("#"+this.id),this.oriContainer=$("#"+this.id),this.bControlGl=!1,this.maxatomcnt=1e5,this.overdraw=0,this.bDrawn=!1,this.bOpm=!1,this.crossstrucinter=0,this.bSecondaryStructure=!1,this.bHighlight=1,this.renderOrderPicking=-1,this.bInitial=!0,this.bDoublecolor=!1,this.originSize=1,this.ALTERNATE_STRUCTURE=-1,this.bUsePdbNum=!0,!this.icn3dui.bNode){let e=document.createElement("canvas");if(t=!(!window.WebGLRenderingContext||!e.getContext("webgl")&&!e.getContext("experimental-webgl")),e.remove(),e=document.createElement("canvas"),i=!(!window.WebGLRenderingContext||!e.getContext("webgl2")),e.remove(),s="xr"in navigator,t){if(!i)return void alert("Please use a modern browser that supports WebGL2...");this.renderer=new Pl({canvas:this.oriContainer.get(0),antialias:!0,preserveDrawingBuffer:!0,sortObjects:!1,alpha:!0}),s&&(this.renderer.xr.enabled=!0),this.effects={stereo:new Sp(this.renderer),none:this.renderer},this.overdraw=0}else alert("Currently your web browser has a problem on WebGL. If you are using Chrome, open a new tab for the same URL and WebGL may work again.")}this.frac=new ls(.1,.1,.1),this.shininess=40,this.emissive=3355443,this.light1=2,this.light2=1,this.light3=1,this.lineRadius=.1,this.coilWidth=.3,this.cylinderRadius=.4,this.crosslinkRadius=.4,this.traceRadius=.4,this.dotSphereScale=.3,this.sphereRadius=1.5,this.cylinderHelixRadius=1.6,this.ribbonthickness=.2,this.helixSheetWidth=1.3,this.nucleicAcidWidth=.8,this.scaleFactor=1,this.labelScale=1,this.resizeRatioX=1,this.resizeRatioY=1,this.bImpo=!0,this.bInstanced=!0,this.chainMissingResidueArray={},this._zoomFactor=1,this.transparentRenderOrder=!1,this.AFUniprotVersion="v4",this.defaultPdbId="stru",this.icn3dui.bNode||(i&&s?(this.bExtFragDepth=!0,this.bImpo=!0,this.bInstanced=!0):(this.bExtFragDepth=this.renderer.extensions.get("EXT_frag_depth"),this.bExtFragDepth?console.log("EXT_frag_depth is supported. All spheres and cylinders are drawn using shaders."):(this.bImpo=!1,console.log("EXT_frag_depth is NOT supported. All spheres and cylinders are drawn using geometry.")),this.bInstanced=this.renderer.extensions.get("ANGLE_instanced_arrays"),this.bInstanced?console.log("ANGLE_instanced_arrays is supported. Assembly is drawn with one copy of the asymmetric unit using hardware instancing."):console.log("ANGLE_instanced_arrays is NOT supported. Assembly is drawn by making copies of the asymmetric unit."))),this.posArray=new Array,this.colorArray=new Array,this.pos2Array=new Array,this.color2Array=new Array,this.radiusArray=new Array,this.posArraySphere=new Array,this.colorArraySphere=new Array,this.radiusArraySphere=new Array,this.axis=!1,this.pk=1,this.highlightlevel=1,this.pickpair=!1,this.pAtomNum=0,this.pAtom=void 0,this.pAtom2=void 0,this.bCtrl=!1,this.bShift=!1,this.bStopRotate=!1,this.bCalphaOnly=!1,this.bConsiderNeighbors=!1,this.bShowCrossResidueBond=!0,this.bExtrude=!0,this.maxD=500,this.oriMaxD=this.maxD,this.cam_z=2*this.maxD,this.commands=[],this.optsHistory=[],this.logs=[],this.bRender=!0,this.hColor=new ls(16777011),this.sphereGeometry=new ur(1,32,32),this.boxGeometry=new zs(1,1,1),this.cylinderGeometry=new Kn(1,1,1,32,1),this.cylinderGeometryOutline=new Kn(1,1,1,32,1,!0),this.axisDIV=15,this.strandDIV=6,this.tubeDIV=8,this.nucleicAcidStrandDIV=6,this.linewidth=1,this.hlLineRadius=.1,this.threshbox=180,this.maxAtoms3DMultiFile=4e4,this.tsHbond=3.8,this.tsIonic=6,this.tsContact=4,this.tsHalogen=3.8,this.tsPication=6,this.tsPistacking=5.5,this.LABELSIZE=30,this.rayThreshold=.5,this.colorBlackbkgd="#ffff00",this.colorWhitebkgd="#000000",this.optsOri={},this.optsOri.camera="perspective",this.optsOri.effect="none",this.optsOri.background="black",this.optsOri.color="chain",this.optsOri.proteins="ribbon",this.optsOri.sidec="nothing",this.optsOri.nucleotides="nucleotide cartoon",this.optsOri.ntbase="nothing",this.optsOri.surface="nothing",this.optsOri.opacity="1.0",this.optsOri.wireframe="no",this.optsOri.map="nothing",this.optsOri.mapwireframe="yes",this.optsOri.emmap="nothing",this.optsOri.emmapwireframe="yes",this.optsOri.phimap="nothing",this.optsOri.phimapwireframe="yes",this.optsOri.phisurface="nothing",this.optsOri.phisurftype="nothing",this.optsOri.phisurfop="1.0",this.optsOri.phisurfwf="yes",this.optsOri.chemicals="stick",this.optsOri.water="nothing",this.optsOri.ions="sphere",this.optsOri.hbonds="no",this.optsOri.saltbridge="no",this.optsOri.contact="no",this.optsOri.halogen="no",this.optsOri["pi-cation"]="no",this.optsOri["pi-stacking"]="no",this.optsOri.ssbonds="yes",this.optsOri.clbonds="yes",this.optsOri.rotationcenter="molecule center",this.optsOri.axis="no",this.optsOri.fog="no",this.optsOri.slab="no",this.optsOri.pk="residue",this.optsOri.chemicalbinding="hide",this.opts=n.hashUtilsCls.cloneHash(this.optsOri),this.sheetcolor="green",this.bShowHighlight=!0,this.mapData={},this.bFullUi=!0,this.divid=this.icn3dui.cfg.divid,this.inputid="",this.setOperation="or",this.ROT_DIR="right",this.currSelectedSets=[],this.selectedResidues={},this.ncbi2resid={},this.resid2ncbi={},this.shapeCmdHash={},this.bHideSelection=!0,this.bSelectResidue=!1,this.bSelectAlignResidue=!1,this.bAnnoShown=!1,this.bSetChainsAdvancedMenu=!1,this.b2DShown=!1,this.bCrashed=!1,this.bAddCommands=!0,this.bAddLogs=!0,this.bNotLoadStructure=!1,this.InputfileData="",this.bVr=!1,this.bAr=!1,this.startColor="blue",this.midColor="white",this.endColor="red",this.startValue=0,this.midValue=50,this.endValue=100,this.crosslinkRadius=.4,this.sceneCls=new oc(this),this.cameraCls=new cc(this),this.fogCls=new hc(this),this.boxCls=new pc(this),this.brickCls=new uc(this),this.curveStripArrowCls=new mc(this),this.curveCls=new fc(this),this.cylinderCls=new gc(this),this.lineCls=new bc(this),this.reprSubCls=new Cc(this),this.sphereCls=new vc(this),this.stickCls=new _c(this),this.strandCls=new xc(this),this.stripCls=new Sc(this),this.tubeCls=new wc(this),this.cartoonNuclCls=new Ac(this),this.surfaceCls=new Pc(this),this.labelCls=new Tc(this),this.axesCls=new Ec(this),this.glycanCls=new Rc(this),this.applyCenterCls=new Dc(this),this.applyClbondsCls=new Lc(this),this.applyMissingResCls=new Fc(this),this.applyDisplayCls=new Nc(this),this.applyMapCls=new zc(this),this.applyOtherCls=new Uc(this),this.applySsbondsCls=new Hc(this),this.applySymdCls=new Bc(this),this.hlObjectsCls=new bh(this),this.residueLabelsCls=new qc(this),this.alternateCls=new $c(this),this.drawCls=new Vc(this),this.firstAtomObjCls=new yc(this),this.impostorCls=new jc(this),this.instancingCls=new Gc(this),this.contactCls=new Wc(this),this.hBondCls=new Xc(this),this.piHalogenCls=new Yc(this),this.saltbridgeCls=new Kc(this),this.loadPDBCls=new $h(this),this.loadCIFCls=new Vh(this),this.vastplusCls=new Wh(this),this.transformCls=new pp(this),this.setStyleCls=new Zc(this),this.setColorCls=new Jc(this),this.threeDPrintCls=new fp(this),this.export3DCls=new gp(this),this.annoCddSiteCls=new th(this),this.annoContactCls=new ih(this),this.annoPTMCls=new sh(this),this.annoIgCls=new nh(this),this.annoCrossLinkCls=new rh(this),this.annoDomainCls=new ah(this),this.annoSnpClinVarCls=new oh(this),this.annoSsbondCls=new lh(this),this.annoTransMemCls=new dh(this),this.domain3dCls=new ch(this),this.addTrackCls=new hh(this),this.annotationCls=new ph(this),this.showAnnoCls=new uh(this),this.showSeqCls=new mh(this),this.hlSeqCls=new fh(this),this.hlUpdateCls=new gh(this),this.lineGraphCls=new Ch(this),this.getGraphCls=new vh(this),this.showInterCls=new _h(this),this.viewInterPairsCls=new yh(this),this.drawGraphCls=new Sh(this),this.contactMapCls=new wh(this),this.alignParserCls=new xh(this),this.chainalignParserCls=new Ah(this),this.dsn6ParserCls=new Mh(this),this.ccp4ParserCls=new Th(this),this.mtzParserCls=new kh(this),this.mmcifParserCls=new Oh(this),this.mmdbParserCls=new Ih(this),this.bcifParserCls=new Ph(this),this.mol2ParserCls=new Dh(this),this.opmParserCls=new Lh(this),this.pdbParserCls=new Fh(this),this.sdfParserCls=new Nh(this),this.xyzParserCls=new Uh(this),this.msaParserCls=new Hh(this),this.realignParserCls=new Bh(this),this.densityCifParserCls=new zh(this),this.ParserUtilsCls=new qh(this),this.loadAtomDataCls=new jh(this),this.setSeqAlignCls=new Gh(this),this.applyCommandCls=new Xh(this),this.definedSetsCls=new Yh(this),this.selectCollectionsCls=new Kh(this),this.legendTableCls=new eh(this),this.loadScriptCls=new Zh(this),this.selByCommCls=new Jh(this),this.selectionCls=new Qh(this),this.resid2specCls=new ep(this),this.delphiCls=new tp(this),this.dsspCls=new ip(this),this.refnumCls=new sp(this),this.scapCls=new np(this),this.symdCls=new rp(this),this.alignSWCls=new ap(this),this.analysisCls=new op(this),this.resizeCanvasCls=new hp(this),this.saveFileCls=new up(this),this.setOptionCls=new Qc(this),this.shareLinkCls=new mp(this),this.diagram2dCls=new lp(this),this.cartoon2dCls=new dp(this),this.ligplotCls=new cp(this),this.rayCls=new bp(this),this.controlCls=new Cp(this),this.pickingCls=new vp(this),this.VRButtonCls=new _p(this),this.ARButtonCls=new yp(this),this.matShader=this.setColorCls.setOutlineColor("yellow")}}wp.prototype.init=function(e){this.init_base(),this.molTitle="",this.ssbondpnts={},this.clbondpnts={},this.biomtMatrices=[],this.bAssembly=!0,this.bDrawn=!1,this.bSecondaryStructure=!1,this.bHighlight=1,this.axes=[]},wp.prototype.init_base=function(e){this.resetConfig(),this.structures={},this.chains={},this.tddomains={},this.residues={},this.secondaries={},this.alnChains={},this.chainsSeq={},this.chainsColor={},this.chainsGene={},this.chainsAn={},this.chainsAnTitle={},this.chainsMapping={},this.resid2refnum={},this.residIgLoop={},this.refnum2residArray={},this.bShowRefnum=!1,this.alnChainsSeq={},this.alnChainsAnno={},this.alnChainsAnTtl={},this.pickedAtomList={},this.prevHighlightObjects=[],this.prevHighlightObjects_ghost=[],this.prevSurfaces=[],this.prevMaps=[],this.prevEmmaps=[],this.prevPhimaps=[],this.prevOtherMesh=[],this.defNames2Residues={},this.defNames2Atoms={},this.defNames2Descr={},this.defNames2Command={},this.residueId2Name={},this.atoms={},this.dAtoms={},this.hAtoms={},this.proteins={},this.sidec={},this.ntbase={},this.nucleotides={},this.nucleotidesO3={},this.chemicals={},this.ions={},this.water={},this.calphas={},this.hbondpnts=[],this.saltbridgepnts=[],this.contactpnts=[],this.stabilizerpnts=[],this.halogenpnts=[],this.picationpnts=[],this.pistackingpnts=[],this.distPnts=[],this.doublebonds={},this.triplebonds={},this.aromaticbonds={},this.atomPrevColors={},this.style2atoms={},this.labels={},this.lines={},this.resids2inter={},this.resids2interAll={},this.transformCls.rotateCount=0,this.transformCls.rotateCountMax=20,e&&(this.commands=[]),this.axes=[],this.bGlycansCartoon=0,this.bMembrane=1,this.bCmdWindow=0,this.chainMissingResidueArray={},this.nTotalGap=0},wp.prototype.reinitAfterLoad=function(){let e=this,t=e.icn3dui;e.resetConfig(),e.setStyleCls.setAtomStyleByOptions(),e.setColorCls.setColorByOptions(e.opts,e.atoms),e.dAtoms=t.hashUtilsCls.cloneHash(e.atoms),e.hAtoms=t.hashUtilsCls.cloneHash(e.atoms),e.prevHighlightObjects=[],e.prevHighlightObjects_ghost=[],e.prevSurfaces=[],e.prevMaps=[],e.prevEmmaps=[],e.prevPhimaps=[],e.prevOtherMesh=[],e.labels={},e.lines={},e.shapeCmdHash={},e.bAssembly=!0},wp.prototype.resetConfig=function(){let e=this,t=e.icn3dui;if(this.opts=t.hashUtilsCls.cloneHash(this.optsOri),void 0===t.cfg.align&&void 0===t.cfg.chainalign||(this.opts.color="identity",this.opts.proteins="c alpha trace",this.opts.nucleotides="o3 trace"),void 0===t.cfg.cid&&void 0===t.cfg.smiles||(this.opts.color="atom",this.opts.pk="atom",this.opts.chemicals="ball and stick"),(void 0!==t.cfg.afid||e.bEsmfold)&&(this.opts.color="confidence"),void 0!==t.cfg.blast_rep_id&&(this.opts.color="conservation"),void 0!==t.cfg.mmdbafid){let i=t.cfg.mmdbafid.split(",");if(i.length>1)e.opts.color="structure";else if(1==i.length){let t=i[0];isNaN(t)&&t.length>5?this.opts.color="confidence":e.opts.color="chain"}}void 0!==t.cfg.options&&$.extend(this.opts,t.cfg.options)};class xp{constructor(e){this.cfg=e,this.pre=this.cfg.divid+"_",this.REVISION="3.44.2",this.bNode=Object.keys(window).length<2,void 0===this.cfg.command&&(this.cfg.command=""),void 0===this.cfg.width&&(this.cfg.width="100%"),void 0===this.cfg.height&&(this.cfg.height="100%"),void 0===this.cfg.resize&&(this.cfg.resize=!0),void 0===this.cfg.showlogo&&(this.cfg.showlogo=!0),void 0===this.cfg.showmenu&&(this.cfg.showmenu=!0),void 0===this.cfg.showtitle&&(this.cfg.showtitle=!0),void 0===this.cfg.showcommand&&(this.cfg.showcommand=!0),void 0===this.cfg.mobilemenu&&(this.cfg.mobilemenu=!1),void 0===this.cfg.imageonly&&(this.cfg.imageonly=!1),void 0===this.cfg.closepopup&&(this.cfg.closepopup=!1),void 0===this.cfg.showanno&&(this.cfg.showanno=!1),void 0===this.cfg.showseq&&(this.cfg.showseq=!1),void 0===this.cfg.showalignseq&&(this.cfg.showalignseq=!1),void 0===this.cfg.show2d&&(this.cfg.show2d=!1),void 0===this.cfg.showsets&&(this.cfg.showsets=!1),void 0===this.cfg.rotate&&(this.cfg.rotate="right"),void 0===this.cfg.hidelicense&&(this.cfg.hidelicense=!1),this.hashUtilsCls=new Dl(this),this.utilsCls=new Ll(this),this.parasCls=new Fl(this),this.myEventCls=new Nl(this),this.rmsdSuprCls=new Ul(this),this.subdivideCls=new Hl(this),this.convertTypeCls=new Bl(this),this.htmlCls=new Xl(this)}allCustomEvents(){}}xp.prototype.show3DStructure=async function(e){let t=this;t.cfg.menuicon?(t.htmlCls.wifiStr='<i class="icn3d-wifi" title="requires internet">&nbsp;</i>',t.htmlCls.licenseStr='<i class="icn3d-license" title="requires license">&nbsp;</i>'):(t.htmlCls.wifiStr="",t.htmlCls.licenseStr=""),t.setIcn3d();let i=t.icn3d;t.utilsCls.isSessionStorageSupported()&&i.setStyleCls.getCommandsBeforeCrash();let s=t.htmlCls.WIDTH,n=t.htmlCls.HEIGHT;t.oriWidth=s,t.oriHeight=n,t.htmlCls.eventsCls.allEventFunctions(),this.allCustomEvents();let r=0;if((null==t.cfg.showmenu||t.cfg.showmenu)&&(r+=t.htmlCls.MENU_HEIGHT),(null==t.cfg.showcommand||t.cfg.showcommand)&&(r+=t.htmlCls.CMD_HEIGHT),null!=t.cfg.showmenu&&0==t.cfg.showmenu?t.htmlCls.setMenuCls.hideMenu():t.htmlCls.setMenuCls.showMenu(),null!=t.cfg.showtitle&&0==t.cfg.showtitle?$("#"+i.pre+"title").hide():$("#"+i.pre+"title").show(),$("#"+i.pre+"viewer").width(s).height(parseInt(n)+r),$("#"+i.pre+"canvas").width(s).height(parseInt(n)),$("#"+i.pre+"canvas").resizable({resize:function(e,s){t.htmlCls.WIDTH=s.size.width,t.htmlCls.HEIGHT=s.size.height,void 0===i||t.icn3d.bFullscreen||i.resizeCanvasCls.resizeCanvas(t.htmlCls.WIDTH,t.htmlCls.HEIGHT,!0)}}),void 0!==t.cfg.usepdbnum?t.icn3d.bUsePdbNum=t.cfg.usepdbnum:void 0!==t.cfg.date?t.icn3d.bUsePdbNum=parseInt(t.cfg.date)>=20201222:"1tup"==t.cfg.mmdbid&&1==t.cfg.showanno&&1==t.cfg.show2d&&1==t.cfg.showsets||"118496"==t.cfg.mmdbid&&0==t.cfg.showanno&&-1!=t.cfg.inpara.indexOf("bu=1")||"163605,1,91105,1,1,1"==t.cfg.align&&-1!=t.cfg.inpara.indexOf("atype=1")?t.icn3d.bUsePdbNum=!1:t.icn3d.bUsePdbNum=!0,t.cfg.replay?(i.bReplay=1,$("#"+i.pre+"replay").show()):(i.bReplay=0,$("#"+i.pre+"replay").hide()),t.utilsCls.isMobile()&&(i.threshbox=60),t.cfg.controlGl&&(i.bControlGl=!0,i.container=i.bControlGl&&!t.bNode?$(document):$("#"+i.id)),i.setStyleCls.handleContextLost(),i.applyCenterCls.setWidthHeight(s,n),i.ori_chemicalbinding=i.opts.chemicalbinding,i.opts=t.hashUtilsCls.cloneHash(i.opts),i.STATENUMBER=i.commands.length,t.utilsCls.isSessionStorageSupported()&&i.bCrashed){i.bCrashed=!1;let e=i.commandsBeforeCrash.split("|||")[0],s=e.substr(e.lastIndexOf(" ")+1);if(s===t.cfg.bcifid||s===t.cfg.mmtfid||s===t.cfg.pdbid||s===t.cfg.opmid||s===t.cfg.mmdbid||s===t.cfg.gi||s===t.cfg.blast_rep_id||s===t.cfg.cid||s===t.cfg.mmcifid||s===t.cfg.align||s===t.cfg.chainalign||s===t.cfg.mmdbafid)return void await i.loadScriptCls.loadScript(i.commandsBeforeCrash,!0)}if(i.molTitle="",i.loadCmd,t.htmlCls.clickMenuCls.getHiddenMenusFromCache(),t.htmlCls.clickMenuCls.applyShownMenus(),e){if(i.init(),i.bInputfile=!0,i.InputfileType="pdb",i.InputfileData=i.InputfileData?i.InputfileData+"\nENDMDL\n"+e:e,await i.pdbParserCls.loadPdbData(e),void 0!==t.cfg.resdef&&void 0!==t.cfg.chains){let e=Object.keys(i.structures),s=t.cfg.chains.split(" | "),n=[];if(e.length==s.length){for(let t=0,i=e.length;t<i;++t)n.push(e[t]+"_"+s[t]);n=i.chainalignParserCls.addPostfixForChainids(n);let t=!0,r=!0;await i.realignParserCls.realignChainOnSeqAlign(void 0,n,t,r)}}else if(void 0!==t.cfg.matchedchains){let e=Object.keys(i.structures)[0]+"_"+t.cfg.masterchain,s=t.cfg.matchedchains.split(","),n=[];for(let e=0,t=s.length;e<t;++e){let t=s[e].lastIndexOf("_"),i=s[e].substr(t+1);isNaN(i)?n.push(s[e]):n.push(s[e].substr(0,t))}let r="";for(let e=0,t=n.length;e<t;++e)e>0&&(r+=","),r+=n[e].substr(0,n[e].indexOf("_"));i.chainidArray=[e].concat(n),i.chainidArray=i.chainalignParserCls.addPostfixForChainids(i.chainidArray),i.loadCmd="vast_search_chainid "+i.chainidArray,t.htmlCls.clickMenuCls.setLogCmd(i.loadCmd,!0),i.bMmdbafid=!0;let a=!0;await i.chainalignParserCls.downloadMmdbAf(r,a)}}else if(void 0!==t.cfg.url){i.bInputUrlfile=!0;let e=t.cfg.url.split("|"),s=e[0],n=e[1];i.molTitle="",i.inputid=n,i.inputurl="type="+s+"&url="+encodeURIComponent(n),i.loadCmd="load url "+n+" | type "+s,t.htmlCls.clickMenuCls.setLogCmd(i.loadCmd,!0),await i.pdbParserCls.downloadUrl(n,s,t.cfg.command)}else if(void 0!==t.cfg.mmtfid)i.inputid=t.cfg.mmtfid,i.loadCmd="load mmtf "+t.cfg.mmtfid,t.htmlCls.clickMenuCls.setLogCmd(i.loadCmd,!0),await i.bcifParserCls.downloadBcif(t.cfg.mmtfid);else if(void 0!==t.cfg.bcifid)i.inputid=t.cfg.bcifid,i.loadCmd="load bcif "+t.cfg.bcifid,t.htmlCls.clickMenuCls.setLogCmd(i.loadCmd,!0),await i.bcifParserCls.downloadBcif(t.cfg.bcifid);else if(void 0!==t.cfg.pdbid)i.inputid=t.cfg.pdbid,i.loadCmd="load pdb "+t.cfg.pdbid,t.htmlCls.clickMenuCls.setLogCmd(i.loadCmd,!0),await i.pdbParserCls.downloadPdb(t.cfg.pdbid);else if(void 0!==t.cfg.afid){i.inputid=t.cfg.afid,i.loadCmd="load af "+t.cfg.afid,t.htmlCls.clickMenuCls.setLogCmd(i.loadCmd,!0);let e=!0;await i.pdbParserCls.downloadPdb(t.cfg.afid,e)}else if(void 0!==t.cfg.opmid)i.inputid=t.cfg.opmid,i.loadCmd="load opm "+t.cfg.opmid,t.htmlCls.clickMenuCls.setLogCmd(i.loadCmd,!0),await i.opmParserCls.downloadOpm(t.cfg.opmid);else if(void 0!==t.cfg.mmdbid)i.inputid=t.cfg.mmdbid,i.loadCmd="load mmdb "+t.cfg.mmdbid+" | parameters "+t.cfg.inpara,t.htmlCls.clickMenuCls.setLogCmd(i.loadCmd,!0),await i.mmdbParserCls.downloadMmdb(t.cfg.mmdbid);else if(void 0!==t.cfg.gi)i.loadCmd="load gi "+t.cfg.gi,t.htmlCls.clickMenuCls.setLogCmd(i.loadCmd,!0),await i.mmdbParserCls.downloadGi(t.cfg.gi);else if(void 0!==t.cfg.refseqid)i.inputid=t.cfg.refseqid,i.loadCmd="load refseq "+t.cfg.refseqid,t.htmlCls.clickMenuCls.setLogCmd(i.loadCmd,!0),await i.mmdbParserCls.downloadRefseq(t.cfg.refseqid);else if(void 0!==t.cfg.protein)i.inputid=t.cfg.protein,i.loadCmd="load protein "+t.cfg.protein,t.htmlCls.clickMenuCls.setLogCmd(i.loadCmd,!0),await i.mmdbParserCls.downloadProteinname(t.cfg.protein);else if(void 0!==t.cfg.blast_rep_id)if(i.inputid=t.cfg.query_id+","+t.cfg.blast_rep_id,t.cfg.oriQuery_id=t.cfg.query_id,t.cfg.oriBlast_rep_id=t.cfg.blast_rep_id,"Query"!==t.cfg.query_id.substr(0,5)&&void 0===t.cfg.rid)"icn3d"==t.cfg.from&&"1TSR_A"==t.cfg.blast_rep_id&&"NP_001108451.1"==t.cfg.query_id&&(t.cfg.command="view annotations; set annotation cdd; set annotation site; set view detailed view; select chain 1TSR_A; show selection"),"smithwm"==t.cfg.alg?(i.loadCmd="load seq_struct_ids_smithwm "+t.cfg.query_id+","+t.cfg.blast_rep_id,i.bSmithwm=!0):"local_smithwm"==t.cfg.alg?(i.loadCmd="load seq_struct_ids_local_smithwm "+t.cfg.query_id+","+t.cfg.blast_rep_id,i.bLocalSmithwm=!0):(i.loadCmd="load seq_struct_ids "+t.cfg.query_id+","+t.cfg.blast_rep_id,i.bSmithwm=!1,i.bLocalSmithwm=!1),t.htmlCls.clickMenuCls.setLogCmd(i.loadCmd,!0),await i.mmdbParserCls.downloadBlast_rep_id(t.cfg.query_id+","+t.cfg.blast_rep_id);else if(void 0!==t.cfg.rid){let e="https://blast.ncbi.nlm.nih.gov/Blast.cgi?RESULTS_FILE=on&FORMAT_TYPE=JSON2_S&FORMAT_OBJECT=Alignment&CMD=Get&RID="+t.cfg.rid,s=await t.getAjaxPromise(e,"json",!1,"The RID "+t.cfg.rid+" may have expired...");for(let e=0,n=s.BlastOutput2.length;e<n;++e){let n,r;if(s.BlastOutput2[e].report.results.iterations){let i=s.BlastOutput2[e].report.results.iterations.length;if(s.BlastOutput2[e].report.results.iterations[i-1].search.query_id!=t.cfg.query_id)continue;n=s.BlastOutput2[e].report.results.iterations[i-1].search.hits}else{if(s.BlastOutput2[e].report.results.search.query_id!=t.cfg.query_id)continue;n=s.BlastOutput2[e].report.results.search.hits}for(let e=0,i=n.length;e<i;++e){let i=n[e],s=!1;for(let e=0,n=i.description.length;e<n;++e){if(i.description[e].accession==t.cfg.blast_rep_id){s=!0;break}}if(s){r=i.hsps[0].qseq,r=r.replace(/-/g,"");break}}void 0!==r&&(t.cfg.query_id=r),i.inputid=t.cfg.query_id+"_"+t.cfg.blast_rep_id,i.loadCmd="load seq_struct_ids "+t.cfg.query_id+","+t.cfg.blast_rep_id,t.htmlCls.clickMenuCls.setLogCmd(i.loadCmd,!0),await i.mmdbParserCls.downloadBlast_rep_id(t.cfg.query_id+","+t.cfg.blast_rep_id);break}}else alert('BLAST "RID" is a required parameter...');else if(void 0!==t.cfg.cid){if(isNaN(t.cfg.cid)){let e=t.htmlCls.baseUrl+"vastdyn/vastdyn.cgi?compound2cid="+t.cfg.cid,i=await t.getAjaxPromise(e,"jsonp");if(!i.cid||!i.cid[0])return void alert("Please input an valid PubChem CID...");t.cfg.cid=i.cid[0]}i.inputid=t.cfg.cid;let e="https://pubchem.ncbi.nlm.nih.gov/rest/pug/compound/cid/"+i.inputid+"/description/jsonp",s=await t.getAjaxPromise(e,"jsonp",!1);void 0!==s.InformationList&&void 0!==s.InformationList.Information&&(i.molTitle=s.InformationList.Information[0].Title),i.loadCmd="load cid "+t.cfg.cid,t.htmlCls.clickMenuCls.setLogCmd(i.loadCmd,!0),await i.sdfParserCls.downloadCid(t.cfg.cid)}else if(void 0!==t.cfg.smiles)i.inputid=t.cfg.smiles,i.loadCmd="load smiles "+t.cfg.smiles,t.htmlCls.clickMenuCls.setLogCmd(i.loadCmd,!0),await i.sdfParserCls.downloadSmiles(t.cfg.smiles);else if(void 0!==t.cfg.mmcifid)i.inputid=t.cfg.mmcifid,i.loadCmd="load mmcif "+t.cfg.mmcifid,t.htmlCls.clickMenuCls.setLogCmd(i.loadCmd,!0),await i.mmcifParserCls.downloadMmcif(t.cfg.mmcifid);else if(void 0!==t.cfg.align){-1!=t.cfg.align.indexOf("185055,")&&(t.cfg.align=t.cfg.align.replace("185055,","199731,"));let e=t.cfg.align.split(",");if(6===e.length?i.inputid=e[0]+"_"+e[3]:2===e.length&&(i.inputid=e[0]+"_"+e[1]),i.loadCmd="load alignment "+t.cfg.align+" | parameters "+t.cfg.inpara,t.htmlCls.clickMenuCls.setLogCmd(i.loadCmd,!0),t.cfg.inpara&&-1==t.cfg.inpara.indexOf("atype=2"))await i.alignParserCls.downloadAlignment(t.cfg.align);else{let e=2;await i.chainalignParserCls.downloadMmdbAf(t.cfg.align,void 0,e)}}else if(void 0!==t.cfg.chainalign){i.bChainAlign=!0,i.inputid=t.cfg.chainalign;let e=t.cfg.resrange?" | resrange "+decodeURIComponent(t.cfg.resrange):"",s=t.cfg.resdef?t.cfg.resdef:"";i.loadCmd="load chainalignment "+t.cfg.chainalign+" | resnum "+t.cfg.resnum+" | resdef "+s+" | aligntool "+t.cfg.aligntool+" | parameters "+t.cfg.inpara+e,t.htmlCls.clickMenuCls.setLogCmd(i.loadCmd,!0),await i.chainalignParserCls.downloadChainalignment(t.cfg.chainalign)}else if(void 0!==t.cfg.mmdbafid)t.cfg.mmdbafid=t.cfg.mmdbafid.replace(/\s+/g,"").toUpperCase(),i.bMmdbafid=!0,i.inputid=t.cfg.mmdbafid,1==t.cfg.bu?i.loadCmd="load mmdbaf1 "+t.cfg.mmdbafid+" | parameters "+t.cfg.inpara:i.loadCmd="load mmdbaf0 "+t.cfg.mmdbafid+" | parameters "+t.cfg.inpara,t.htmlCls.clickMenuCls.setLogCmd(i.loadCmd,!0),await i.chainalignParserCls.downloadMmdbAf(t.cfg.mmdbafid);else{if(void 0===t.cfg.command||""===t.cfg.command)return void t.htmlCls.dialogCls.openDlg("dl_mmdbafid","Please input PDB/MMDB/AlphaFold UniProt IDs");-1!==t.cfg.command.indexOf("url=")&&(i.bInputUrlfile=!0)}await i.loadScriptCls.loadScript(t.cfg.command,void 0,!0)},xp.prototype.setIcn3d=function(){let e=this,t="<label class='icn3d-switch'><input id='"+e.pre+"modeswitch' type='checkbox'><div class='icn3d-slider icn3d-round' style='width:34px; height:18px; margin: 6px 0px 0px 3px;' title='Left(\"All atoms\"): Style and color menu options will be applied to all atoms in the structure&#13;Right(\"Selection\"): Style and color menu options will be applied only to selected atoms'></div></label>",i="<span id='"+e.pre+"modeall' title='Style and color menu options will be applied to all atoms in the structure'>All atoms&nbsp;&nbsp;</span><span id='"+e.pre+"modeselection' class='icn3d-modeselection' style='display:none;' title='Style and color menu options will be applied only to selected atoms'>Selection&nbsp;&nbsp;</span></div></div></td>";e.utilsCls.setViewerWidthHeight(e),e.utilsCls.isMobile()||e.cfg.mobilemenu?e.htmlCls.setMenuCls.setTopMenusHtmlMobile(e.cfg.divid,t,i):e.htmlCls.setMenuCls.setTopMenusHtml(e.cfg.divid,t,i),e.icn3d=new wp(e),e.icn3d.controlCls.setControl(),e.setDialogAjax()},xp.prototype.getMmtfPromise=function(e){return new Promise((function(t,i){MMTF.fetch(e,(async function(e){t(e)}),(function(e){i("error")}))}))},xp.prototype.getMmtfReducedPromise=function(e){return new Promise((function(t,i){MMTF.fetchReduced(e,(async function(e){t(e)}),(function(e){i("error")}))}))},xp.prototype.getXMLHttpRqstPromise=function(e,t,i,s){let n=this;return new Promise((function(r,a){let o=new XMLHttpRequest;o.open(t,e,!0),o.responseType=i,o.onreadystatechange=function(){if(4==this.readyState)if(200==this.status){let e=o.response;r(e)}else"2fofc"==s||"fofc"==s?alert("Density server at EBI has no corresponding electron density map for this structure."):"em"==s?alert("Density server at EBI has no corresponding EM density map for this structure."):"rcsbEdmaps"==s?alert("RCSB server has no corresponding electron density map for this structure."):alert("The "+s+" file is unavailable..."),a("error");else n.icn3d.ParserUtilsCls.showLoading()},o.send()}))},xp.prototype.getAjaxPromise=function(e,t,i,s,n,r,a){let o=this;return new Promise((function(a,l){$.ajax({url:e,dataType:t,cache:!0,beforeSend:function(){i&&o.icn3d.ParserUtilsCls.showLoading()},complete:function(){r&&o.icn3d.ParserUtilsCls.hideLoading()},success:function(e){a(e)},error:function(){s&&alert(s),n&&console.log(n),l("error")}})}))},xp.prototype.getAjaxPostPromise=async function(e,t,i,s,n,r,a,o){let l=this;return a=a||"json",new Promise((function(o,d){$.ajax({url:e,type:"POST",data:t,dataType:a,cache:!0,beforeSend:function(){i&&l.icn3d.ParserUtilsCls.showLoading()},complete:function(){r&&l.icn3d.ParserUtilsCls.hideLoading()},success:function(e){o(e)},error:function(){!l.bNode&&s&&console.log(s),!l.bNode&&n&&console.log(n),o("error")}})}))},xp.prototype.setDialogAjax=function(){this.bNode||$.ui.dialog.prototype._makeDraggableBase||($.ui.dialog.prototype._makeDraggableBase=$.ui.dialog.prototype._makeDraggable,$.ui.dialog.prototype._makeDraggable=function(){this._makeDraggableBase(),this.uiDialog.draggable("option","containment",!1)}),$.ajaxTransport("+binary",(function(e,t,i){if(window.FormData&&(e.dataType&&"binary"==e.dataType||e.data&&(window.ArrayBuffer&&e.data instanceof ArrayBuffer||window.Blob&&e.data instanceof Blob)))return{send:function(t,i){let s=new XMLHttpRequest,n=e.url,r=e.type,a=e.async||!0,o=e.responseType||"blob",l=e.data||null;s.addEventListener("load",(function(){let t={};t[e.dataType]=s.response,i(s.status,s.statusText,t,s.getAllResponseHeaders())})),s.open(r,n,a);for(let e in t)s.setRequestHeader(e,t[e]);s.responseType=o,s.send(l)},abort:function(){i.abort()}}}))};return e.ARButton=yp,e.AddTrack=hh,e.AlignParser=xh,e.AlignSW=ap,e.AlignSeq=Vl,e.Alternate=$c,e.Analysis=op,e.AnnoCddSite=th,e.AnnoContact=ih,e.AnnoCrossLink=rh,e.AnnoDomain=ah,e.AnnoSnpClinVar=oh,e.AnnoSsbond=lh,e.AnnoTransMem=dh,e.Annotation=ph,e.ApplyCenter=Dc,e.ApplyClbonds=Lc,e.ApplyCommand=Xh,e.ApplyDisplay=Nc,e.ApplyMap=zc,e.ApplyOther=Uc,e.ApplySsbonds=Hc,e.ApplySymd=Bc,e.Axes=Ec,e.Box=pc,e.Brick=uc,e.Camera=cc,e.CartoonNucl=Ac,e.ChainalignParser=Ah,e.ClickMenu=zl,e.Contact=Wc,e.Control=Cp,e.ConvertTypeCls=Bl,e.Curve=fc,e.CurveStripArrow=mc,e.Cylinder=gc,e.DefinedSets=Yh,e.Delphi=tp,e.DensityCifParser=zh,e.Diagram2d=lp,e.Dialog=jl,e.Domain3d=ch,e.Draw=Vc,e.DrawGraph=Sh,e.Dsn6Parser=Mh,e.Dssp=ip,e.ElectronMap=Ic,e.Events=$l,e.Export3D=gp,e.FirstAtomObj=yc,e.Fog=hc,e.GetGraph=vh,e.Glycan=Rc,e.HBond=Xc,e.HashUtilsCls=Dl,e.HlObjects=bh,e.HlSeq=fh,e.HlUpdate=gh,e.Html=Xl,e.Impostor=jc,e.Instancing=Gc,e.Label=Tc,e.Line=bc,e.LineGraph=Ch,e.LoadAtomData=jh,e.LoadCIF=Vh,e.LoadPDB=$h,e.LoadScript=Zh,e.MarchingCube=kc,e.MmcifParser=Oh,e.MmdbParser=Ih,e.Mol2Parser=Dh,e.MsaParser=Hh,e.MyEventCls=Nl,e.OpmParser=Lh,e.ParasCls=Fl,e.ParserUtils=qh,e.PdbParser=Fh,e.PiHalogen=Yc,e.Picking=vp,e.ProteinSurface=Oc,e.Ray=bp,e.RealignParser=Bh,e.Refnum=sp,e.ReprSub=Cc,e.Resid2spec=ep,e.ResidueLabels=qc,e.ResizeCanvas=hp,e.RmsdSuprCls=Ul,e.Saltbridge=Kc,e.SaveFile=up,e.Scap=np,e.Scene=oc,e.SdfParser=Nh,e.SelectByCommand=Jh,e.Selection=Qh,e.SetColor=Jc,e.SetDialog=Gl,e.SetHtml=Wl,e.SetMenu=ql,e.SetOption=Qc,e.SetSeqAlign=Gh,e.SetStyle=Zc,e.ShareLink=mp,e.ShowAnno=uh,e.ShowInter=_h,e.ShowSeq=mh,e.Sphere=vc,e.Stick=_c,e.Strand=xc,e.Strip=Sc,e.SubdivideCls=Hl,e.Surface=Pc,e.Symd=rp,e.ThreeDPrint=fp,e.Transform=pp,e.Tube=wc,e.UtilsCls=Ll,e.VRButton=_p,e.Vastplus=Wh,e.ViewInterPairs=yh,e.XyzParser=Uh,e.iCn3D=wp,e.iCn3DUI=xp,e.printMsg=class{constructor(){console.log("This is a message from the icn3d package")}},Object.defineProperty(e,"__esModule",{value:!0}),e}({});
